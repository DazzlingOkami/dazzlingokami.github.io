[{"title":"ARMåµŒå…¥å¼å¼€å‘ä¸­çš„æ ˆå›æº¯æœºåˆ¶","url":"/2022/11/12/ARM%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E6%A0%88%E5%9B%9E%E6%BA%AF%E6%9C%BA%E5%88%B6/","content":"ä¸¤ç§ABIè§„èŒƒæ ¹æ®ç¼–è¯‘å™¨çš„å®ç°ä¸åŒï¼Œå­˜åœ¨ä¸¤ç§ABIæœºåˆ¶ï¼Œåˆ†åˆ«ä¸ºAPCS(ARM Procedure Call Standard)å’ŒAAPCS(ARM Archtecture Procedure Call Standard)ã€‚ä¸¤ç§æœºåˆ¶å­˜åœ¨æ˜æ˜¾çš„åŒºåˆ«ï¼Œä¸”å•ç‹¬APCSå’ŒAAPCSåˆæœ‰å¾ˆå¤šå˜ç§ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†å±•å¼€å™è¿°å…¶æœ¬è´¨ã€‚æœ¬æ–‡ä¸»è¦è®¨è®ºåˆ†ææ ˆå¸§ç›¸å…³çš„å†…å®¹ï¼Œæ‰€ä»¥è¿™é‡Œä»…ä»…ä»‹ç»è¿™ä¸¤ç§ABIæœºåˆ¶ä¸‹æ ˆå¸§çš„åŒºåˆ«ã€‚\nAPCSè§„èŒƒä¸‹å‡½æ•°è°ƒç”¨å’Œæ ˆå¸§ç›¸å…³å¯„å­˜å™¨APCSä¸­è§„å®šäº†å‡ ä¸ªåˆ«åå¯„å­˜å™¨ï¼Œåˆ†åˆ«æ˜¯fpã€ipã€spã€lrã€pcå¯„å­˜å™¨ï¼Œå®ƒä»¬å®é™…å¯¹åº”çš„å¯„å­˜å™¨åŠå«æœ‰æœ‰ä¸‹è¡¨ï¼š\n\n\n\nAPCS\nReg\næ„ä¹‰\n\n\n\nfp\nr11\næ ˆå¸§æŒ‡é’ˆå¯„å­˜å™¨\n\n\nip\nr12\nä¸´æ—¶å˜é‡å¯„å­˜å™¨\n\n\nsp\nr13\næ ˆæŒ‡é’ˆå¯„å­˜å™¨\n\n\nlr\nr14\né“¾æ¥å¯„å­˜å™¨\n\n\npc\nr15\nç¨‹åºä½ç½®å¯„å­˜å™¨\n\n\nå‡½æ•°è°ƒç”¨æ—¶çš„æ ˆå¸§å‡½æ•°è°ƒç”¨å…¥å£å¤„å°†pcã€lrã€spã€fpå¯„å­˜å™¨ä¾æ¬¡å…¥æ ˆã€‚å…¥æ ˆå‰å…ˆå°†spä¿å­˜åˆ°ipï¼Œå…¥æ ˆåå†å°†ipçš„å€¼ç»™fpï¼Œè¿™æ ·fpçš„å€¼å°±æ˜¯å½“å‰æ ˆå¸§çš„èµ·å§‹ä½ç½®ã€‚åç»­å¦‚æœéœ€è¦ä½¿ç”¨å±€éƒ¨å˜é‡ï¼Œå°±å°†spå‡ä¸€ä¸ªå€¼å®ç°åœ¨æ ˆç©ºé—´ä¸Šå¼€è¾Ÿå±€éƒ¨å˜é‡çš„ç©ºé—´ã€‚å‡½æ•°é€€å‡ºå‰å°†spå¯„å­˜å™¨å¤„ç†åˆ°å †æ ˆå¹³è¡¡çŠ¶æ€ï¼Œå†é€šè¿‡fpå¯„å­˜å™¨æ‰¾åˆ°å½“å‰å‡½æ•°çš„æ ˆå¸§ä½ç½®ï¼Œé€šè¿‡æ ˆå¸§æ‰¾åˆ°è¿”å›å‡½æ•°çš„fpå¯„å­˜å™¨å’Œspå¯„å­˜å™¨ã€lrå¯„å­˜å™¨ã€‚ç®€è¦çš„ä»£ç å¦‚ä¸‹ï¼š\n&lt;func1&gt;:mov ip, sppush &#123;fp, ip, lr, pc&#125;sub fp, ip, #4sub sp, sp, #8      ;8 å­—èŠ‚å±€éƒ¨å˜é‡ç©ºé—´;...sub sp, fp, #12ldm sp, &#123;fp, sp, pc&#125;\n\né€šè¿‡åˆ†ææ ˆå¸§æ ¼å¼æˆ‘ä»¬èƒ½å¤ŸçŸ¥é“åœ¨å‡½æ•°ä»»æ„ä½ç½®ï¼Œéƒ½èƒ½å¤Ÿé€šè¿‡fpå¯„å­˜å™¨æ‰¾åˆ°å½“å‰æ ˆå¸§ä½ç½®ï¼Œè€Œä¸å¿…è€ƒè™‘å½“å‰ä½¿ç”¨äº†å¤šå°‘å±€éƒ¨å˜é‡ç©ºé—´ï¼Œæ ˆå¸§ä¸­èƒ½å¤Ÿå¾—åˆ°å½“å‰å‡½æ•°çš„è¿”å›åœ°å€(lr)ï¼Œå½“å‰è¿è¡Œåœ°å€(pc)ï¼Œæ ˆåœ°å€(sp)ï¼ŒåŒæ—¶æ ¹æ®æ ˆå¸§ä¸­ä¸Šä¸€ä¸ªå‡½æ•°çš„fpå¯„å­˜å™¨å†æ‰¾åˆ°ä¸Šä¸€å±‚å‡½æ•°çš„æ ˆå¸§æ•°æ®ï¼Œè¿™æ ·å±‚å±‚å›æº¯å°±å®ç°äº†æ ˆçš„å›æº¯ã€‚\nå¦‚ä½•ä½¿ç”¨APCSgccæ‰‹å†Œä¸Šå¯¹ä½¿ç”¨APCSæœ‰ç›¸å…³çš„æè¿°å’Œæ§åˆ¶é€‰é¡¹ï¼Œ-mapcs-frameé€‰é¡¹ç¼–è¯‘å‡ºæ¥çš„ä»£ç å°±æ˜¯ä½¿ç”¨APCSè§„èŒƒï¼Œé»˜è®¤æƒ…å†µæ˜¯-mno-apcs-frameï¼Œå…³äºè¿™ä¸ªé€‰é¡¹çš„æè¿°GCCæ‰‹å†ŒåŸæ–‡æ˜¯ï¼š\nGenerate a stack frame that is compliant with the ARM Procedure Call Standard for all functions, even if this is not strictly necessary for correct execution of the code. Specifying -fomit-frame-pointer with this option causes the stack frames not to be generated for leaf functions. The default is -mno-apcs-frame. This option is deprecated.\n\nè¿™é‡Œè¯´æ˜äº†ä½¿ç”¨ç›¸å…³é€‰é¡¹å¯ä»¥ä¿è¯APCSçš„æ ˆå¸§æ ¼å¼ï¼Œå¦‚æœä¸é€‚ç”¨è¿™ä¸ªé€‰é¡¹åˆ™ä¸ä¿è¯ã€‚APCSä¸º1993å¹´æ¨å‡ºçš„æ ‡å‡†ï¼Œåœ¨åç»­æ¨å‡ºAAPCSç›¸å…³ç‰ˆæœ¬åå®ƒå·²ç»æ˜¾å¾—å¤ªæ—§äº†ã€‚åœ¨gcc5.0ä¹‹åï¼Œè¯¥é€‰é¡¹å·²ç»è¢«é—å¼ƒï¼Œæ‰€ä»¥æ–°ç‰ˆæœ¬çš„ç¼–è¯‘å™¨å·²ç»ä¸èƒ½ä½¿ç”¨APCSè°ƒç”¨æ–¹å¼è¿›è¡Œæ ˆå›æº¯ã€‚\nAAPCSä¸‹å‡½æ•°çš„è°ƒç”¨ç›¸å…³å¯„å­˜å™¨AAPCSç›¸æ¯”äºAPCSå°‘äº†å‡ ä¸ªåˆ«åå¯„å­˜å™¨ã€‚å®ƒæœ‰spã€lrã€pcå¯„å­˜å™¨ï¼Œå¯¹åº”è¡¨å¦‚ä¸‹ï¼š\n\n\n\nAPCS\nReg\næ„ä¹‰\n\n\n\nsp\nr13(ARM)&#x2F;r7(THUMB)\næ ˆæŒ‡é’ˆå¯„å­˜å™¨\n\n\nlr\nr14\né“¾æ¥å¯„å­˜å™¨\n\n\npc\nr15\nç¨‹åºä½ç½®å¯„å­˜å™¨\n\n\nå‡½æ•°è°ƒç”¨æ—¶çš„æ ˆå¸§åœ¨è¿™ç§è°ƒç”¨è§„èŒƒä¸‹ï¼Œæ ˆçš„å›æº¯è¦æ¯”APCSä¸‹è¦å¤æ‚çš„å¤šï¼Œå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ä¸­ä¸ä¿å­˜æ ˆå¸§çš„æŒ‡é’ˆï¼Œè€Œä¸”æ ˆå¸§ä¸­ä¹Ÿæ²¡æœ‰å›ºå®šçš„æ ¼å¼ï¼Œæ‰€ä»¥ä¸èƒ½é€šè¿‡å½“å‰çš„æ ˆå¸§å±‚å±‚è¿”å›æ•°æ®ã€‚æ‰€ä»¥ä»…ä»…é€šè¿‡å †æ ˆæ•°æ®æ˜¯ä¸èƒ½è¿›è¡Œæ ˆå›æº¯çš„ã€‚é‚£ä¹ˆè¿™ç§æ¨¡å¼ä¸‹å¦‚ä½•ä¿è¯å †æ ˆå¹³è¡¡ï¼Œèƒ½ä¸èƒ½é€šè¿‡æ±‡ç¼–ä»£ç çš„å †æ ˆå¹³è¡¡å®ç°æ ˆå›æº¯å‘¢ï¼Ÿ\næˆ‘ä»¬çŸ¥é“APCSæ¨¡å¼ä¸‹å‡½æ•°è¿›å…¥åˆ°é€€å‡ºæ—¶çš„å †æ ˆå¹³è¡¡æ—¶é€šè¿‡ä¿å­˜spå¯„å­˜å™¨å’Œæ¢å¤spå¯„å­˜å™¨å®ç°çš„ã€‚è€ŒAAPCSæ¨¡å¼ä¸‹å †æ ˆå¹³è¡¡æ˜¯ç›´æ¥ä¾é popå’Œpushå¹³è¡¡å®ç°çš„ï¼Œå³ä¸ä¼šç›´æ¥ä¿®æ”¹spæ¥å®ç°å †æ ˆå¹³è¡¡ã€‚ä½†å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿå‡†ç¡®çŸ¥é“æ¯ä¸ªå‡½æ•°å…³äºæ ˆçš„æ“ä½œï¼Œè¿™æ ·ä¹Ÿèƒ½å¤Ÿå®ç°æ ˆçš„è·Ÿè¸ªã€‚\né€šè¿‡é€‚å½“çš„ç¼–è¯‘é€‰é¡¹ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå°†è¿™éƒ¨ä¿¡æ¯æ”¶é›†åˆ°ä¸€èµ·ï¼Œè¿™å°±æ˜¯arm exception handler indexï¼Œç®€ç§°ARM.exidxï¼Œè¿™æ®µæ•°æ®å°±èƒ½æŒ‡å¯¼æˆ‘ä»¬å®ç°æ ˆå›æº¯ï¼ŒæŠŠè¿™ç§æ ˆå›æº¯æ–¹å¼ç§°ä¸ºunwindã€‚\nARM.exidxä½ç½®å’Œç»“æ„ä¸åŒçš„ç¼–è¯‘å™¨å¦‚ä½•ç¼–è¯‘å‡ºexidxè¡¨å…·æœ‰ä¸åŒçš„æ–¹å¼ï¼Œä½†æ˜¯å¦‚æœå¯æ‰§è¡Œæ–‡ä»¶ä¸­åŒ…æ‹¬exidxè¡¨ï¼Œé‚£ä¹ˆä½¿ç”¨readelf -S file.elf èƒ½å¤Ÿçœ‹åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­å­˜åœ¨ä¸€ä¸ªåä¸º.ARM.exidxï¼Œç±»å‹ä¸ºARM_EXIDXçš„æ®µã€‚è¿™å°±è¡¨ç¤ºç¼–è¯‘å™¨å·²ç»ç”Ÿäº§çš„exidxæ®µã€‚\nå…³äºexidxçš„ç»“æ„åŠå…¶å«ä¹‰è¿™é‡Œåšä¸€ä¸ªç®€å•ä»‹ç»ï¼Œè¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒARMå®˜æ–¹ç½‘ç«™ã€‚exidxæ˜¯ä¸€ä¸ªç”±å¤šä¸ªç›¸åŒå•å…ƒç»„æˆçš„è¡¨ï¼Œæ¯ä¸ªå•å…ƒç”±ä¸¤ä¸ªuint32_tçš„æ•°æ®æ„æˆï¼Œç»“æ„ç±»ä¼¼äºï¼š\nstruct &#123;    uint32_t offset;    uint32_t world;&#125;\nå…¶ä¸­offsetè¡¨ç¤ºç›®æ ‡å‡½æ•°åˆ°å½“å‰ä½ç½®çš„åç§»ï¼Œå®ƒçš„æœ€é«˜ä½å›ºå®šä¸º0ã€‚è€Œworldä¸­å­˜æ”¾äº†ç¼–ç æ•°æ®ï¼Œå®ƒè¡¨ç¤ºäº†å¯¹æ ˆçš„ä¸åŒæ“ä½œï¼Œé€šè¿‡æ“ä½œå®ƒå°±èƒ½å¤ŸçŸ¥é“ç›®æ ‡å‡½æ•°ä¸Šå…³äºæ ˆçš„æ“ä½œã€‚\nLinuxä¸­çš„æ ˆå›æº¯Linuxä¸­å…³äºARMæ¶æ„çš„æ ˆå›æº¯å°±æ˜¯ä½¿ç”¨çš„exidxè¡¨å®ç°çš„ï¼Œè¿™é‡Œä»¥linux5.3ç‰ˆæœ¬å†…æ ¸ä¸­å…³äºunwind frameçš„ä»£ç è¿›è¡Œæ¼”ç¤ºã€‚æ¶‰åŠçš„ä¸»è¦ä»£ç æ–‡ä»¶æœ‰arch&#x2F;arm&#x2F;kernel&#x2F;unwind.c arch&#x2F;arm&#x2F;include&#x2F;asm&#x2F;unwind.h arch&#x2F;arm&#x2F;include&#x2F;asm&#x2F;ptrace.h stacktrace.hç­‰ã€‚ä¸»è¦å°†unwind.cç§»æ¤åˆ°æˆ‘ä»¬çš„åµŒå…¥å¼å¹³å°å°±èƒ½å¤Ÿä½¿ç”¨unwindæ ˆå›æº¯äº†ã€‚\nä»£ç ç§»æ¤ç”±äºlinuxä¸­å­˜åœ¨å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ï¼Œä¸¤ç§ç©ºé—´ä¸‹å­˜åœ¨å„ç§çš„exidxè¡¨ï¼Œè€Œé€šå¸¸æˆ‘ä»¬çš„ä»£ç æ²¡æœ‰æ‰€è°“çš„ä¸¤ä¸ªåœ°å€ç©ºé—´ã€‚æ‰€ä»¥éœ€è¦å°†æ¶‰åŠåˆ°åœ°å€ç©ºé—´åˆ¤æ–­çš„å…¨éƒ¨åˆ¤æ–­ä¸ºæ˜¯å¦ä¸ºä»£ç ç©ºé—´æ®µï¼Œlinuxå¯¹äºç”¨æˆ·ç©ºé—´æ®µçš„exidxè¡¨æ˜¯é€šè¿‡é“¾è¡¨ç”±ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ çš„ï¼Œå†…æ ¸æ®µçš„exidxè¡¨æ˜¯ç›´æ¥ç”±ç¼–è¯‘ç¬¦å·å®Œæˆçš„ã€‚å…¶ä»–çš„ä»£ç ä¿®æ”¹ä¸»è¦æ˜¯æ¶‰åŠåˆ°Linuxå¹³å°ç‰¹æ€§çš„ã€‚ä¸‹é¢ä»‹ç»çš„ç›¸å…³ä¿®æ”¹éƒ½æ˜¯åŸºäºgccç¼–è¯‘å™¨(ver&gt;5.0)å®ç°çš„ã€‚\n\n1.å®ç°ä¸¤ä¸ªå…³é”®çš„å‡½æ•°ï¼š #define core_kernel_text(addr)    ((addr) &gt; 0x08000000 &amp;&amp; (addr) &lt;= 0x08100000)#define kernel_text_address(addr) ((addr) &gt; 0x08000000 &amp;&amp; (addr) &lt;= 0x08100000)\n2.æ·»åŠ æ—¥å¿—è¾“å‡ºçš„ç›¸å…³æ¥å£ï¼Œä¸»è¦å°±æ˜¯ä¸¤ä¸ªï¼Œå…¶ä¸­pr_debugæ—¥å¿—å¯ä»¥é€‰æ‹©ä¸è¾“å‡ºã€‚ #define pr_debug(...) printf(__VA_ARGS__)#define pr_warn(...)  printf(__VA_ARGS__)\n3.å…³äºåˆ†æ”¯é¢„æµ‹çš„ä»£ç ï¼Œå¯èƒ½åœ¨æŸäº›armå¹³å°ä¸‹ä¸æ”¯æŒåˆ†æ”¯é¢„æµ‹ï¼Œæ‰€ä»¥è¿™é‡Œçš„ç§»æ¤å°±æŠŠè¿™ä¸ªç‰¹æ€§å…³é—­æ‰ã€‚ #define likely(c)   (c)#define unlikely(c) (c)\n4.å­—èŠ‚å¯¹é½å‡½æ•°ï¼Œç”¨äºæŠŠæŸä¸ªæ•°æ®æŒ‰å¤šå°‘å­—èŠ‚å¯¹é½ã€‚ #define ALIGN(x,a) (((x)+(a)-1)&amp;~(a-1))\n5.å†…å­˜æ“ä½œçš„ç›¸å…³æ¥å£ï¼Œè¿™é‡Œå…¶å®å¹¶ä¸ä¼šä½¿ç”¨åˆ°å†…å­˜ç›¸å…³ç”³è¯·ï¼Œå®ƒåªæ˜¯åœ¨æ·»åŠ ç”¨æˆ·ç©ºé—´exidxè¡¨æ—¶æ‰ä½¿ç”¨ï¼Œè€Œæˆ‘ä»¬çš„åµŒå…¥å¼å¹³å°ä¸Šæ˜¯æ˜¾ç„¶æ˜¯ç”¨ä¸åˆ°çš„ã€‚ #define kmalloc(size, flag)  malloc(size)#define kfree(ptr)           free(ptr)\n6.exidxè¡¨çš„ä½ç½®ï¼Œä¸åŒçš„ç¼–è¯‘å™¨åœ¨é“¾æ¥è„šæœ¬ä¸­å…³äºexidxè¡¨çš„èµ·å§‹ç»ˆæ­¢ä½ç½®çš„æè¿°å¯èƒ½ä¸ä¸€æ ·ï¼Œè¿™é‡Œéœ€è¦é‡æ–°å®šä¹‰ä¸€ä¸‹ã€‚ #define __start_unwind_idx __exidx_start#define __stop_unwind_idx  __exidx_end\n7.å®ç°è·å–å…³é”®å¯„å­˜å™¨çš„æ“ä½œï¼Œä¸»è¦æ˜¯è·å–spå¯„å­˜å™¨ï¼Œå¦‚æœä¸æ˜¯åœ¨gccç¼–è¯‘å™¨ä¸­ï¼Œè¿˜éœ€è¦å®ç°è·å–lrå¯„å­˜å™¨å’Œspå¯„å­˜å™¨ register char * stack_ptr asm(&quot;sp&quot;);#define current_stack_pointer ((unsigned long) stack_ptr)\n8.linuxä¸­é’ˆå¯¹éƒ¨åˆ†ä»£ç ä½¿ç”¨äº†spinlockè¿›è¡Œä¿æŠ¤ï¼Œåœ¨æˆ‘ä»¬çš„åµŒå…¥å¼å¹³å°ä¸Šé€šå¸¸æ˜¯ä¸éœ€è¦çš„ï¼Œå½“ç„¶å¦‚æœæœ‰å¿…è¦å¯ä»¥è¿›è¡Œé€‰æ‹©æ€§çš„å®ç°ç±»ä¼¼spinlockçš„æ“ä½œã€‚\n9.å…³äºä»£ç æ˜¯armæ¨¡å¼è¿˜æ˜¯thumbæ¨¡å¼ï¼Œå¦‚æœä»£ç æ˜¯thumbæ¨¡å¼ï¼Œè¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªå®ï¼Œä»–å°†å†³å®šfpå¯„å­˜å™¨æ˜¯r7è¿˜æ˜¯r11 #define CONFIG_THUMB2_KERNEL\n10.å¯¹äº.hæ–‡ä»¶ï¼Œä¸»è¦æ˜¯æ˜¯ä¿ç•™unwind.hæ–‡ä»¶ï¼Œåˆ é™¤å…¶ä¸­ä¸ç›¸å¹²çš„ä»£ç ï¼Œå…¶ä»–å¤´æ–‡ä»¶ä¸­å¯èƒ½åªæ˜¯ä¼šå¼•ç”¨éƒ¨åˆ†æ•°æ®å’Œæ•°æ®ç»“æ„å¯ä»¥ç›´æ¥æ‹·è´åˆ°unwind.hæ–‡ä»¶ä¸­ã€‚\n11.å¯ä»¥é€‰æ‹©æ˜¯å¦ä¿ç•™å…³äºæ·»åŠ unwind_tableçš„ç›¸å…³å‡½æ•°ï¼Œè¿™äº›å‡½æ•°é€šå¸¸ä¸ä¼šä½¿ç”¨ã€‚\n\né™¤äº†ä¸Šè¿°ä»£ç çš„ç§»æ¤å¤–ï¼Œç¼–è¯‘æ—¶éœ€è¦å¼€å¯-funwind-tablesé€‰é¡¹ï¼Œä½¿ç¼–è¯‘å™¨èƒ½å¤Ÿæ­£å¸¸ç”Ÿäº§exidxæ®µã€‚åœ¨è¿æ¥æ—¶è¦ä¿è¯é“¾æ¥è„šæœ¬ä¸­æœ‰å­˜æ”¾exidxæ®µçš„ä½ç½®ï¼Œä»¥åŠé¢„ç•™å‡ºç´¢å¼•exidxæ®µçš„èµ·æ­¢ç¬¦å·ï¼Œç±»ä¼¼è¿™æ ·çš„é“¾æ¥è„šæœ¬ï¼š\n.ARM.extab   : &#123; *(.ARM.extab* .gnu.linkonce.armextab.*) &#125; &gt;FLASH.ARM : &#123;  __exidx_start = .;  *(.ARM.exidx*)  __exidx_end = .;&#125; &gt;FLASH\n\nå°†ä»£ç ç§»æ¤åˆ°ARMCCç¼–è¯‘å™¨ä¸­keilä½œä¸ºä¸€ä¸ªåº”ç”¨åœ¨åµŒå…¥å¼å¼€å‘é¢†åŸŸçš„ä¸€ä¸ªé‡è¦è½¯ä»¶ï¼Œå¦‚æœèƒ½å¤Ÿå°†è¿™ä¸ªåŠŸèƒ½åº”ç”¨åˆ°ARMCCç¼–è¯‘å™¨ç¯å¢ƒä¸‹ï¼Œé‚£è¿™ä¸ªåŠŸèƒ½å°†æ˜¾å¾—æ›´åŠ å…·æœ‰ç°å®æ„ä¹‰ã€‚å‰é¢çš„ç§»æ¤ä¸»è¦æ˜¯åœ¨gccç¼–è¯‘å¹³å°ä¸‹å®Œæˆçš„ï¼Œä¸‹é¢ä»‹ç»å¦‚ä½•å°†è¿™æ®µä»£ç å’ŒåŠŸèƒ½ç§»æ¤åˆ°ARMCCç¼–è¯‘å¹³å°ä¸‹ã€‚\n\n1.ç¼–è¯‘ç¯å¢ƒç›¸å…³çš„è®¾ç½® è¦ä½¿ç¼–è¯‘å™¨èƒ½å¤Ÿæ­£å¸¸ç¼–è¯‘å‡ºä»£ç exidxæ•°æ®æ®µçš„ä»£ç éœ€è¦å¼€å¯ç‰¹åˆ«çš„é€‰é¡¹ â€“exceptions â€“exceptions-unwindï¼Œå®ƒçš„æ„ä¹‰æ˜¯å¼€å¯å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œå› ä¸ºæœ€åˆexidxæ®µè®¾è®¡æ¥å°±æ˜¯ç”¨äºå¤„ç†ç±»å‹c++ä¸­çš„å¼‚å¸¸æœºåˆ¶çš„ã€‚åœ¨å¼€å¯äº†è¿™äº›é€‰é¡¹åç¼–è¯‘å‡ºçš„ä»£ç å°±ä¼šåŒ…å«exidxæ®µï¼Œå¯ä»¥ä½¿ç”¨æŒ‡ä»¤è¿›è¡Œæ£€éªŒæŸ¥çœ‹ï¼Œå¦‚readelf -S main.oï¼Œå…¶ä¸­å°±èƒ½å¤Ÿçœ‹åˆ°ç›¸å…³çš„æ•°æ®æ®µã€‚å½“ç„¶ä¸åŒçš„æ–‡ä»¶ä¸­çš„exidxæ®µè¿˜æ²¡æœ‰é“¾æ¥åˆ°ä¸€èµ·ï¼Œè¦æŠŠå®ƒä»¬é“¾æ¥åˆ°ä¸€èµ·è¿˜æ¯”è¾ƒéº»çƒ¦ã€‚ å› ä¸ºARMCCçš„ä¼˜åŒ–ç­–ç•¥ï¼Œæœªä½¿ç”¨çš„æ•°æ®æ®µéƒ½ä¼šåœ¨é“¾æ¥é˜¶æ®µè¢«ä¼˜åŒ–æ‰ï¼Œè€Œæˆ‘ä»¬ç”±ä¸èƒ½ç›´æ¥ä½¿ç”¨åˆ°exidxä¸­çš„æ•°æ®(æ²¡æœ‰ç›¸å…³çš„ç¬¦å·æŒ‡å‘è¿™é‡Œ)ï¼Œæ‰€ä»¥æ­£å¸¸æƒ…å†µä¸‹ï¼Œå³ä½¿å¼€å¯çš„å‰é¢çš„ç¼–è¯‘é€‰é¡¹ï¼Œæœ€ç»ˆç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶ä¹Ÿæ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚åœ¨é“¾æ¥é˜¶æ®µæ·»åŠ é€‰é¡¹â€“keep *(.ARM.exidx)ï¼Œè¿™ä¸ªé€‰é¡¹çš„æ„æ€å°±æ˜¯åœ¨é“¾æ¥æ—¶ä¿ç•™exidxæ®µ(æ³¨æ„.ARM.exidxæ˜¯exidxæ®µçš„æ ‡å‡†åç§°ï¼Œå‰é¢æ²¡æœ‰æåˆ°ï¼Œä¸åŒçš„ç¼–è¯‘å™¨ç¼–è¯‘å‡ºæ¥éƒ½æ˜¯è¿™ä¸ªæ®µåï¼Œä¸”æ®µç±»å‹éƒ½æ˜¯æœªARM_EXIDX)ï¼Œè¿™æ ·é“¾æ¥å‡ºæ¥çš„æ–‡ä»¶å¯ä»¥å‘ç°ä¼šæ¯”æœªåŠ è¿™ä¸ªé€‰é¡¹çš„æ–‡ä»¶å¤§äº†äº›ï¼Œè¿™å°±æ–°å¢çš„exidxæ®µæ•°æ®å¯¼è‡´çš„ã€‚ ä½†æ˜¯è¿™æ—¶å€™è¿˜æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œç¼–è¯‘å‡ºçš„æ–‡ä»¶åŒ…å«äº†exidxæ®µçš„æ•°æ®ï¼Œä½†æ˜¯å´æ²¡åœ¨æˆ‘ä»¬æƒ³è¦çš„åœ°æ–¹ï¼Œæˆ–è€…è¯´æ²¡æ²¡åŠæ³•ç¡®å®šè¿™æ®µæ•°æ®åœ¨å“ªå„¿ã€‚readelf -Sèƒ½å¤Ÿçœ‹åˆ°æ®µçš„ç»“æ„æ²¡æœ‰å¢åŠ ï¼Œè€ŒER_IROM1æ®µçš„æ•°æ®å˜å¤šäº†ï¼Œè¿™å°±è¯´æ˜exidxæ®µçš„æ•°æ®ä¸ä»£ç æ•°æ®æ”¾å…¥äº†åŒä¸€ä¸ªæ®µï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚ ä¿®æ”¹åˆ†æ•£åŠ è½½æ–‡ä»¶ï¼Œåœ¨é“¾æ¥é€‰é¡¹ä¸­æŒ‡å®šä½¿ç”¨è‡ªå®šä¹‰åˆ†æ•£åŠ è½½æ–‡ä»¶ã€‚æˆ‘ä»¬èµ·å§‹å¯ä»¥çœ‹åˆ°åŸsctæ–‡ä»¶çš„ç»“æ„ä¸ºï¼š LR_IROM1 0x08000000 0x00120000  &#123;    ; load region size_region    ER_IROM1 0x08000000 0x00100000  &#123;  ; load address = execution address        *.o (RESET, +First)        *(InRoot$$Sections)        .ANY (+RO)        .ANY (+XO)    &#125;    RW_IRAM1 0x20000100 0x00030000  &#123;  ; RW data        .ANY (+RW +ZI)    &#125;&#125;\n\n æˆ‘ä»¬åœ¨è¿™é‡Œæ·»åŠ exidxæ®µçš„å£°æ˜åçš„ç»“æ„ä¸ºï¼š LR_IROM1 0x08000000 0x00120000  &#123;    ; load region size_region    ER_IROM1 0x08000000 0x00100000  &#123;  ; load address = execution address        *.o (RESET, +First)        *(InRoot$$Sections)        .ANY (+RO)        .ANY (+XO)    &#125;    ER_EXIDX +0 0x00020000 &#123;        .ANY (.ARM.exidx)    &#125;    RW_IRAM1 0x20000100 0x00030000  &#123;  ; RW data        .ANY (+RW +ZI)    &#125;&#125;\n\n ç»è¿‡å¯¹ç¼–è¯‘å™¨é“¾æ¥å™¨çš„è®¾ç½®ï¼Œæˆ‘ä»¬ç»ˆäºå°†exidxæ®µçš„æ•°æ®æ”¾åˆ°äº†æœŸæœ›çš„åœ°æ–¹ï¼Œåœ¨ç¼–è¯‘å™¨ä¸­ä½¿ç”¨ç¬¦å·Image$$ER_EXIDX$$Baseå’ŒImage$$ER_EXIDX$$Limitå°±èƒ½è®¿é—®åˆ°exidxæ®µçš„æ•°æ®(ç¼–è¯‘å™¨ç‰¹æ€§)ã€‚\n2.å¤„ç†å®Œæˆäº†ç¼–è¯‘å™¨çš„ç›¸å…³å†…å®¹ï¼Œè¿˜éœ€è¦ä¿®æ”¹æºä»£ç ä»¥é€‚åº”ARMCCç¼–è¯‘å™¨ï¼Œéœ€è¦ä¿®æ”¹çš„åœ°æ–¹ä¸»è¦ä½“ç°åœ¨ä½¿ç”¨åˆ°äº†gccå†…å»ºå‡½æ•°çš„åœ°æ–¹ï¼Œä»¥åŠgccæ”¯æŒçš„ä¸€äº›æ‹“å±•è¯­æ³•ä¸Šï¼Œå…·ä½“å¦‚ä½•ä¿®æ”¹è¿™é‡Œä¸åšè¯¦ç»†çš„ä»‹ç»äº†ã€‚ä»¥ä¸ŠåŒ…æ‹¬gccå’Œkeilå¹³å°ä¸‹çš„ç§»æ¤éƒ½ç»è¿‡æµ‹è¯•ï¼Œèƒ½å¤Ÿéå¸¸å‡†ç¡®çš„å›æº¯å‡½æ•°çš„è°ƒç”¨é“¾ï¼ŒåŒ…æ‹¬åœ¨ä½¿ç”¨å‡½æ•°æŒ‡é’ˆçš„åœ°æ–¹éƒ½èƒ½è¿›è¡Œå‡†ç¡®çš„å›æº¯ï¼Œå¯¹äºåˆ†æè½¯ä»¶bugå…·æœ‰ä¸€å®šçš„å¸®åŠ©ã€‚\n\næŠ€æœ¯å‚è€ƒæœ¬æ–‡ä¸­æ‰€è®¾è®¡åˆ°çš„å†…å®¹ä¸»è¦æ¥è‡ªäºARMå®˜æ–¹çš„æŠ€æœ¯æ–‡æ¡£åº“ï¼ŒGCCç¼–è¯‘æ‰‹å†Œï¼ŒLinuxå†…æ ¸æºç ç­‰ã€‚å¯è‡ªè¡Œæ£€ç´¢å‚è€ƒã€‚\n"},{"title":"Cè¯­è¨€å®çš„å›¾çµå®Œå¤‡","url":"/2024/09/19/C%E8%AF%AD%E8%A8%80%E5%AE%8F%E7%9A%84%E5%9B%BE%E7%81%B5%E5%AE%8C%E5%A4%87/","content":"\nè¿™é‡Œè®¨è®ºçš„Cè¯­è¨€å®ç³»ç»Ÿä»…å…³äº#defineï¼Œä¸åŒ…å«#include, #ifï¼Œ#ifdefï¼Œ#elifï¼Œ#elseï¼Œ#endifç­‰ã€‚\n\nCè¯­è¨€å®çš„å¯é€‰å‚æ•°å‰æ®µæ—¶é—´åœ¨æŸä¸ªåµŒå…¥å¼è½¯ä»¶é¡¹ç›®ä¸­æ¶‰åŠä¸€ä¸ªè¿™æ ·çš„åŠŸèƒ½ï¼Œéœ€è¦å°†ä¸€ä¸ªwavéŸ³é¢‘æ–‡ä»¶åµŒå…¥å¼åˆ°äºŒè¿›åˆ¶å›ºä»¶ä¸­ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿è·å–éŸ³é¢‘æ–‡ä»¶æ•°æ®ä¸”ä¸éœ€è¦æ–‡ä»¶ç³»ç»Ÿç­‰å¤æ‚çš„ç»„ä»¶ã€‚ä»¥å‰çš„åšæ³•æ˜¯å°†éŸ³é¢‘æ–‡ä»¶å†™å…¥åˆ°Flashä¸­å›ºå®šçš„åœ°å€ä¸‹ï¼Œç„¶ååœ¨è½¯ä»¶ä»£ç ä¸­ä»è¯¥åœ°å€è®¿é—®ç›¸å…³çš„æ•°æ®ã€‚ä½†æ˜¯è¿™æ ·çš„åšæ³•å­˜åœ¨ä¸€å®šçš„çµæ´»æ€§é—®é¢˜ï¼Œæ¯”å¦‚æ–‡ä»¶æ˜¯å¦å¯èƒ½å’Œå›ºä»¶é‡å ã€æ— æ³•ç»Ÿä¸€çƒ§å½•ç­‰é—®é¢˜ã€‚\nåé¢æˆ‘æƒ³åˆ°å¯ä»¥ä½¿ç”¨gccæ±‡ç¼–ä¸­çš„ä¸€æ¡å‘½ä»¤æ¥å®ç°åœ¨ä»£ç ä¸­åŒ…å«ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£å°±æ˜¯.incbinæŒ‡ä»¤ã€‚è¯¥æŒ‡ä»¤åœ¨æ‰‹å†Œçš„æè¿°å¦‚ä¸‹ï¼š\n.incbin &quot;file&quot;[,skip[,count]]The incbin directive includes file verbatim at the current location. You can control the search paths used with the â€˜-Iâ€™ command-line option (see Command-Line Options). Quotation marks are required around file.The skip argument skips a number of bytes from the start of the file. The count argument indicates the maximum number of bytes to read. Note that the data is not aligned in any way, so it is the userâ€™s responsibility to make sure that proper alignment is provided both before and after the incbin directive.\n\nå°†è¿™ä¸ªå‘½ä»¤ç®€å•çš„ä½¿ç”¨å®å°è£…ä¸€ä¸‹ï¼Œå°±å¯ä»¥åœ¨Cä»£ç æ–‡ä»¶ä¸­éå¸¸è½»æ¾çš„åµŒå…¥ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶äº†ã€‚\n#define INCFILE(name, file)                             \\    __asm(                                              \\        &quot;.global __&quot; INCF_STR(name) &quot;_start\\n&quot;          \\        &quot;.type __&quot; INCF_STR(name) &quot;_start, %object\\n&quot;   \\        &quot;.global __&quot; INCF_STR(name) &quot;_end\\n&quot;            \\        &quot;.type __&quot; INCF_STR(name) &quot;_end, %object\\n&quot;     \\        &quot;__&quot; INCF_STR(name) &quot;_start:\\n&quot;                 \\        &quot;.incbin \\&quot;&quot; file &quot;\\&quot;\\n&quot;                        \\        &quot;__&quot; INCF_STR(name) &quot;_end:\\n&quot;                   \\        &quot;.word 0\\n&quot;);                                   \\    extern int __##name##_start;                        \\    extern int __##name##_end;#define FILEPTR(name) ((void*)&amp;(__##name##_start))#define FILESIZE(name) ((char*)&amp;(__##name##_end) - (char*)&amp;(__##name##_start))\n\nå°è£…ä¹‹åï¼Œå°±å¯ä»¥åœ¨Cä»£ç ä¸­ç›´æ¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼æ¥åµŒå…¥éŸ³é¢‘æ–‡ä»¶ï¼š\nINCFILE(audio, &quot;audio.wav&quot;);int main()&#123;    printf(&quot;audio size: %d\\n&quot;, FILESIZE(audio));    printf(&quot;audio ptr: %p\\n&quot;, FILEPTR(audio));    return 0;&#125;\n\nåœ¨åæ¥çš„ä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°wavéŸ³é¢‘æ–‡ä»¶å‰çš„44å­—èŠ‚æ˜¯éŸ³é¢‘æ–‡ä»¶å¤´ï¼Œå¯ä»¥å¿½ç•¥ï¼Œåªéœ€è¦ä½¿ç”¨åé¢çš„PCMæ•°æ®å³å¯ã€‚è¿™æ ·éœ€è¦ä½¿ç”¨incbinæŒ‡ä»¤çš„skipé€‰é¡¹ï¼Œä½†æ˜¯ä¸Šé¢æ¶‰åŠçš„INCFILE()å®æ²¡æœ‰æä¾›è¿™ä¸ªåŠŸèƒ½ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°å†™ä¸€ä¸ªå®ã€‚\n#define INCFILE_PART(name, file, offset, count)         \\    __asm(                                              \\        &quot;.global __&quot; INCF_STR(name) &quot;_start\\n&quot;          \\        &quot;.type __&quot; INCF_STR(name) &quot;_start, %object\\n&quot;   \\        &quot;.global __&quot; INCF_STR(name) &quot;_end\\n&quot;            \\        &quot;.type __&quot; INCF_STR(name) &quot;_end, %object\\n&quot;     \\        &quot;__&quot; INCF_STR(name) &quot;_start:\\n&quot;                 \\        &quot;.incbin \\&quot;&quot; file &quot;\\&quot;,&quot; INCF_STR(offset)        \\        &quot;,&quot; INCF_STR(count) &quot;\\n&quot;                        \\        &quot;__&quot; INCF_STR(name) &quot;_end:\\n&quot;                   \\        &quot;.word 0\\n&quot;);                                   \\    extern int __##name##_start;                        \\    extern int __##name##_end;\n\nè¿™æ ·çš„å†™æ³•ä¼¼ä¹ä¹Ÿä¸å¤ªç¬¦åˆè¦æ±‚ï¼Œå› ä¸ºè¿™é‡Œä¸éœ€è¦countå‚æ•°ï¼Œè€Œæ˜¯éœ€è¦åŒ…å«æ–‡ä»¶çš„å…¨éƒ¨å†…å®¹ï¼Œæ‰€ä»¥éœ€è¦å†å°è£…ä¸€ä¸ªå®ï¼Ÿ\nç±»ä¼¼çš„æ“ä½œä¸ºä»€ä¹ˆéœ€è¦å†™å¤šä¸ªå®ï¼Ÿè¿™æ ·çš„æ“ä½œä¼¼ä¹å°±å¤ªä¸ä¼˜é›…äº†ã€‚\nèƒ½ä¸èƒ½å®ç°ä¸€ä¸ªè¿™æ ·çš„å®ï¼Œèƒ½å¤Ÿæä¾›å¤šä¸ªå¯é€‰å‚æ•°å‘¢ï¼Ÿæ ¹æ®å‚æ•°ä¸ªæ•°ç”Ÿæˆä¸åŒçš„ä»£ç ã€‚\nINCFILE(audio, &quot;audio.wav&quot;)INCFILE(audio, &quot;audio.wav&quot;, 44)INCFILE(audio, &quot;audio.wav&quot;, 44 1024)\n\nè¿™æ ·å°±å¼•å…¥äº†ä¸€ä¸ªéå¸¸å…³é”®çš„é—®é¢˜ï¼ŒCè¯­è¨€çš„å®å®šä¹‰å¦‚ä½•æ ¹æ®å‚æ•°ä¸ªæ•°æ¥åŠ¨æ€ç”Ÿæˆä»£ç å‘¢ï¼Ÿ\n#define INCFILE(...) \\    if (NUM(__VA_ARGS__) == 2) &#123; INCFILE(__VA_ARGS__)&#125; else &#123; INCFILE_PART(__VA_ARGS__) &#125;\n\nå¯ä»¥å¾ˆæ˜ç¡®çš„è¯´ï¼Œä¸Šé¢çš„ä»£ç æ˜¯é”™è¯¯çš„ï¼ŒCè¯­è¨€çš„å®å®šä¹‰æ— æ³•æ‰§è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œæ‰€ä»¥æ— æ³•å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚\nå®å®šä¹‰å¦‚ä½•å®ç°æ¡ä»¶åˆ†æ”¯æµç¨‹å‘¢ï¼Ÿæˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„éœ€æ±‚å¼€å§‹ï¼Œè¯·è®¾è®¡ä¸€ä¸ªå®ï¼Œåˆ¤æ–­å®å‚æ•°åˆ—è¡¨ä¸­çš„å‚æ•°ä¸ªæ•°æ˜¯0ä¸ªè¿˜æ˜¯1ä¸ªã€‚\n#define PARA_FOLLOW(...) 0, ##__VA_ARGS__, 1, 0\n\næˆ‘ä»¬æ¥çœ‹çœ‹è¿™æ®µå®å¡«å…¥ä¸€äº›å‚æ•°åå±•å¼€çš„æƒ…å†µï¼š\n/* PARA_FOLLOW(a) -&gt;    0, a, 1, 0PARA_FOLLOW() -&gt;    0, 1, 0 */\n\næ³¨æ„åŠ›æƒŠäººçš„äººå·²ç»æ³¨æ„åˆ°å±•å¼€åçš„ç»“æœä¸­ç¬¬ä¸‰ä¸ªæ•°æ®å°±æ˜¯è¯¥å®è¾“å…¥çš„å‚æ•°ä¸ªæ•°ã€‚è¿™ä¼¼ä¹å°±è§£å†³äº†å‚æ•°æ¡ä»¶åˆ¤æ–­çš„é—®é¢˜ï¼Œé‚£å¦‚ä½•è¿›è¡Œåˆ†æ”¯æµç¨‹å‘¢ï¼Ÿ\nå°†PARA_FOLLOW()å®ä¸­è·Ÿéšçš„0å’Œ1æ›¿æ¢ä¸ºåˆ†æ”¯è¯­å¥ï¼Œè¿™æ ·å°±å®Œæˆäº†å®Œæ•´çš„æ¡ä»¶åˆ†æ”¯ã€‚\n#define GET_P4(p1, p2, p3, p4, ...) p4#define SELECT_012_PARA(p0, p1, p2, ...) GET_P4(0, ##__VA_ARGS__, p2, p1, p0)/* SELECT_012_PARA( \\    printf(&quot;hello world\\n&quot;);, \\    printf(&quot;hello macro\\n&quot;);, \\    printf(&quot;hello hexo\\n&quot;);) -&gt;    printf(&quot;hello world\\n&quot;);SELECT_012_PARA( \\    printf(&quot;hello world\\n&quot;);, \\    printf(&quot;hello macro\\n&quot;);, \\    printf(&quot;hello hexo\\n&quot;);, 1) -&gt;    printf(&quot;hello macro\\n&quot;);SELECT_012_PARA( \\    printf(&quot;hello world\\n&quot;);, \\    printf(&quot;hello macro\\n&quot;);, \\    printf(&quot;hello hexo\\n&quot;);, a, b) -&gt;    printf(&quot;hello hexo\\n&quot;); */\n\nSELECT_012_PARA()å®å¯ä»¥æ ¹æ®å¯ä»¥å‚æ•°åˆ—è¡¨ä¸­å‚æ•°çš„æ•°é‡æ¥ç”Ÿæˆä¸åŒçš„ä»£ç ï¼Œè€Œä¸å…³å¿ƒå‚æ•°å…·ä½“çš„å€¼ã€‚\næ®æ­¤ï¼Œæˆ‘é‡æ–°è®¾è®¡äº†INCFILE()å®ï¼š\n#define INCFILE_OFFSET(file, offset)                    \\        &quot;.incbin \\&quot;&quot; file &quot;\\&quot;,&quot; INCF_STR(offset) &quot;\\n&quot;        #define INCFILE_COUNT(file, offset, count, ...)         \\        &quot;.incbin \\&quot;&quot; file &quot;\\&quot;,&quot; INCF_STR(offset)        \\        &quot;,&quot; INCF_STR(count) &quot;\\n&quot;#define INCFILE_PARA(name, file, offset, ...)           \\    __asm(                                              \\        &quot;.global __&quot; INCF_STR(name) &quot;_start\\n&quot;          \\        &quot;.type __&quot; INCF_STR(name) &quot;_start, %object\\n&quot;   \\        &quot;.global __&quot; INCF_STR(name) &quot;_end\\n&quot;            \\        &quot;.type __&quot; INCF_STR(name) &quot;_end, %object\\n&quot;     \\        &quot;__&quot; INCF_STR(name) &quot;_start:\\n&quot;                 \\        SELECT_012_PARA(                                \\            INCFILE_OFFSET(file, 0),                    \\            INCFILE_OFFSET(file, offset),               \\            INCFILE_COUNT (file, offset, ##__VA_ARGS__, 0), \\            ##__VA_ARGS__)                              \\        &quot;__&quot; INCF_STR(name) &quot;_end:\\n&quot;                   \\        &quot;.word 0\\n&quot;                                     \\    )#define INCFILE(name, file, ...)                        \\    INCFILE_PARA(name, file, ##__VA_ARGS__, 0);         \\    extern int __##name##_start;                        \\    extern int __##name##_end;\n\nINCFILE()å¯ä»¥ä½¿ç”¨ä¸åŒçš„å‚æ•°æ•°é‡ï¼Œæ¥é€‰æ‹©æ˜¯å¦éœ€è¦è·³è¿‡å¤´éƒ¨æ•°æ®ã€‚\n// hello.txt content is 12345678hellohello12345INCFILE(file1, &quot;hello.txt&quot;)INCFILE(file2, &quot;hello.txt&quot;, 8)INCFILE(file3, &quot;hello.txt&quot;, 8, 10)int main(void)&#123;     assert(memcmp(FILEPTR(file1), &quot;12345678hellohello12345&quot;,          FILESIZE(file1)) == 0);     assert(memcmp(FILEPTR(file2), &quot;hellohello12345&quot;, FILESIZE(file2)) == 0);     assert(memcmp(FILEPTR(file3), &quot;hellohello&quot;, FILESIZE(file3)) == 0);     return 0;&#125;\nä¸€ä¸ªå®å‡½æ•°å®ç°äº†å¤šç§åŠŸèƒ½ï¼Œçœ‹èµ·æ¥æœ‰ç‚¹å¤šæ€çš„æ€§è´¨ã€‚\nè‡³æ­¤ï¼Œä¸€ä¸ªåœ¨åµŒå…¥å¼è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ä¸€ä¸ªä¸èµ·çœ¼çš„é—®é¢˜å°±è¢«æˆåŠŸè§£å†³äº†ã€‚\nå®å®šä¹‰æ˜¯å¦å¯ä»¥å®ç°é€’å½’ï¼Ÿå®Œæˆæ¡ä»¶åˆ†æ”¯åŠŸèƒ½åï¼Œæˆ‘è¿›è¡Œäº†è¿›ä¸€æ­¥çš„æ€è€ƒï¼Œåœ¨å®å®šä¹‰ä¸­èƒ½å¦å®ç°é€’å½’å‘¢ï¼Ÿ\nè¯·è®¾è®¡ä¸€ä¸ªå®ï¼Œè¯¥å®å¯ä»¥ä¼ å…¥ä»»æ„ä¸ªæ•´æ•°ï¼Œè¿”å›ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¡¨ç¤ºå…¶æœ€å¤§å€¼ã€‚\nCè¯­è¨€çš„åˆå­¦è€…å¯èƒ½éƒ½å†™è¿‡è¿™æ ·çš„å®ï¼š\n#define MAX(a, b) ((a) &gt; (b) ? (a) : (b))/* MAX(1, 2) -&gt;    ((1) &gt; (2) ? (1) : (2)) */\nè¿™åªèƒ½æ¥å—2ä¸ªå‚æ•°ï¼Œå¦‚æœä¼ å…¥3ä¸ªå‚æ•°ï¼Œå°±ä¼šæŠ¥é”™ã€‚ä»»æ„ä¸ªå‚æ•°çš„é€’å½’ç‰ˆæœ¬ä¹Ÿè®¸æ˜¯è¿™æ ·çš„ï¼š\n#define MAX(a, ...) (a &gt; MAX(__VA_ARGS__) ? a : MAX(__VA_ARGS__))\n\nå®é™…å±•å¼€æƒ…å†µå‘¢ï¼Ÿ\n/* MAX(1, 2, 3) -&gt;    (1 &gt; MAX(2, 3) ? 1 : MAX(2, 3)) */\n\nå®å®šä¹‰çœ‹èµ·æ¥æ— æ³•æ­£å¸¸çš„é€’å½’å±•å¼€ã€‚è¿™æ—¶å€™å»æ£€ç´¢ç›¸å…³çš„èµ„æ–™å‘ç°ï¼ŒCè¯­è¨€çš„å®å®šä¹‰ç¡®å®æ— æ³•ç›´æ¥å®ç°é€’å½’ã€‚\nä½†æ˜¯åœ¨æŸ¥è¯¢èµ„æ–™çš„æ—¶å€™ï¼Œæˆ‘å‘ç°é€šè¿‡ä¸€ç§é€šè¿‡å»¶è¿Ÿæ±‚å€¼çš„æŠ€å·§ï¼Œå¯ä»¥åšåˆ°æœ‰é™çš„é€’å½’ã€‚\nè¯´åˆ°å»¶è¿Ÿæ±‚å€¼ï¼Œé‚£å°±æœ‰å¿…è¦å…ˆå›é¡¾ä¸€ä¸‹Cè¯­è¨€å®å®šä¹‰çš„æ±‚å€¼è§„åˆ™ã€‚\nå®å®šä¹‰çš„æ±‚å€¼è§„åˆ™å…ˆå±•å¼€å†…å±‚å®å‚ï¼Œå†å±•å¼€å¤–å±‚å®å‡½æ•°ã€‚å¦‚æœå½¢å‚å‰æœ‰#ã€#@æˆ–è€…å½¢å‚å‰åæœ‰##ï¼Œåˆ™å¯¹åº”å®å‚ä¸å±•å¼€ã€‚\nå®å‡½æ•°æ±‚å€¼è§„åˆ™ç‰¹åˆ«å¤æ‚ï¼Œç®€å•æ¥è¯´ï¼Œå…ˆè®¡ç®—å®å‚çš„å€¼ï¼Œæ›¿æ¢åˆ°å®å‡½æ•°ä¸­ï¼Œç„¶åé‡æ–°è¿›è¡Œè®¡ç®—ã€‚\næ¯å½“å®å±•å¼€ä¸ºéå®çš„æ ‡è¯†ç¬¦åï¼Œå°†è§¦å‘é‡æ–°æ‰«æï¼Œä»å¼€å§‹å¤„é‡æ–°è®¡ç®—ã€‚å½“å¯¹å®å‡½æ•°A()æ±‚å€¼æ—¶é‡åˆ°Aï¼Œä¼šå°†å…¶æ ‡è®°ä¸ºéå®æ ‡è¯†ç¬¦ä»¥é¿å…é€’å½’ï¼Œå³ä½¿ä»å¤–å±‚é‡æ–°å¯¹å…¶è¿›è¡Œæ‰«æä¹Ÿæ— æ³•å¯¹å…¶ç»§ç»­å±•å¼€ã€‚\nä¸€ä¸ªä¾‹å­è¿›è¡Œæ±‚å€¼è¯´æ˜ï¼š\n#define A(p1, p2, p3, p4, p5) p5#define B() 1, 2, 3#define C(a) A(a, 0, B())#define A_I(...) A(__VA_ARGS__)#define C_I(a) A_I(a, 0, B())C(1) -&gt;      // å…ˆè®¡ç®—å†…å±‚å‚æ•°å€¼ï¼Œ1æ— éœ€è®¡ç®—C(1) -&gt;      // å±•å¼€å¤–å±‚å®å‡½æ•°A(1, 0, B()) // Error, å±•å¼€ååªæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œæ— æ³•åŒ¹é…å®å®šä¹‰ï¼Œç›´æ¥æŠ¥é”™C_I(1) -&gt;    // å…ˆè®¡ç®—å†…å±‚å‚æ•°å€¼ï¼Œ1æ— éœ€è®¡ç®—C_I(1) -&gt;    // å±•å¼€å¤–å±‚å®å‡½æ•°A_I(1, 0, B()) -&gt;   // A_Iä¸ºä¸å®šå‚æ•°ä¸ªæ•°çš„å®ï¼Œå¯ä»¥å±•å¼€ï¼Œå…ˆè®¡ç®—å†…å±‚å‚æ•°å€¼ï¼Œéœ€è¦è®¡ç®—B()A_I(1, 0, 1, 2, 3) -&gt;  // å±•å¼€å¤–å±‚å®å‡½æ•°A(1, 0, 1, 2, 3)   -&gt;  // è®¡ç®—å†…å±‚å‚æ•°å€¼ï¼Œæ‰€æœ‰å‚æ•°éƒ½æ— éœ€è®¡ç®—ï¼Œç›´æ¥å±•å¼€å¤–å±‚å®å‡½æ•°3// çœ‹ä¸€ä¸ªç‰¹åˆ«çš„ä¾‹å­#define A_I2(...) A(##__VA_ARGS__)#define C_I2(a) A_I2(a, 0, B())C_I2(1) -&gt;   // å…ˆè®¡ç®—å†…å±‚å‚æ•°å€¼ï¼Œ1æ— éœ€è®¡ç®—C_I2(1) -&gt;   // å±•å¼€å¤–å±‚å®å‡½æ•°A_I2(1, 0, B()) -&gt;  // æ­¤æ—¶æœ¬åº”è¯¥å…ˆå±•å¼€å†…å±‚å‚æ•°ï¼Œä¹Ÿå°±æ˜¯B()ï¼Œä½†A_I2å‚æ•°ä¸­çš„##é˜»æ­¢                    // äº†1, 0, B()è¿™ä¸ªæ•´ä½“è¢«æ±‚å€¼ã€‚æ‰€ä»¥ç»§ç»­å±•å¼€å¤–å±‚å®å‡½æ•°A(1, 0, B()) // Error, å‚æ•°æ•°é‡ä¸åŒ¹é…ï¼ŒæŠ¥é”™// å¯ä»¥ä»”ç»†å¯¹æ¯”C_I()å’ŒC_I2()çš„å·®å¼‚ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯__VA_ARGS__å¤šäº†ä¸€ä¸ª##// æ­£å¸¸æƒ…å†µä¸‹__VA_ARGS__å‰çš„##è¡¨ç¤ºå¿½ç•¥å¯é€‰å‚æ•°å¸¦æ¥çš„é¢å¤–ç©ºæ ¼ã€‚// åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å½±å“ä¸å¤§ï¼Œä½†åœ¨é‡åˆ°å®åµŒå¥—å¤åˆæ±‚å€¼æ—¶ä¼šå¯¼è‡´å®å±•å¼€é¡ºåºä¸ä¸€è‡´çš„é—®é¢˜ã€‚\n\nå†çœ‹ä¸€ä¸ªè®¸å¤šç½‘å‹éƒ½æ²¡æœ‰æ­£ç¡®ç†è§£çš„ä¾‹å­ï¼š\n#define  cat(a,b)     a ## b#define  xcat(x, y)   cat(x, y)xcat ( xcat ( 1 , 2 ) , 3 ) -&gt; xcat ( cat ( 1 , 2 ) , 3 ) -&gt;xcat ( 12 , 3 ) -&gt;cat ( 12 , 3 ) -&gt;123// æœ‰éƒ¨åˆ†æ–‡ç« åœ¨ä½¿ç”¨è¿™ä¸ªä¾‹å­ä»‹ç»å®åµŒå¥—æ±‚å€¼é¡ºåºæ—¶å†™é”™äº†ã€‚å¤§å®¶ä¸è¦è¢«é”™è¯¯çš„ä¿¡æ¯è¯¯å¯¼ã€‚// å¦‚æœä½ å¯¹æ­¤è¡¨ç¤ºæ€€ç–‘ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨ppstepå·¥å…·å»æŸ¥çœ‹å®å±•å¼€è¿‡ç¨‹ä¸­çš„ç»†èŠ‚ã€‚\n\nåœ¨ç¼–å†™å®å‡½æ•°æ—¶éœ€è¦æŒæ¡ä¸€ä¸ªæŠ€å·§ï¼Œåœ¨æ¶‰åŠåˆ°å®åµŒå¥—å’Œéœ€è¦åœ¨ä»£ç ä¸­ç›´æ¥è®¿é—®çš„å®å‡½æ•°æ¥è¯´ï¼Œå…¶å‚æ•°ä¸èƒ½ç›´æ¥å«æœ‰#ã€#@ã€##ï¼Œéœ€è¦é€šè¿‡å¦ä¸€ä¸ªå®å‡½æ•°é—´æ¥è®¿é—®ã€‚åœ¨ç¼–å†™å®å‡½æ•°æ—¶æ³¨æ„è¿™ä¸€ç‚¹å¯ä»¥é¿å…å¾ˆå¤šæ„æ–™ä¹‹å¤–çš„æ±‚å€¼é¡ºåºé—®é¢˜ã€‚\n#define _STR2(x) #x#define _STR(x) _STR2(x)/* #define A 123_STR2(A) -&gt; A    // Error, ä¸ç¬¦åˆé¢„æœŸ_STR(A) -&gt; &quot;123&quot; // OK */\n\nä»¥ä¸Šè¿™æ ·çš„å®å®šä¹‰æ±‚å€¼éƒ½å¤ªç®€å•äº†ã€‚çœŸæ­£çš„å¤§æ‹›åœ¨åé¢~\nå¯¹å®å®šä¹‰é€’å½’çš„æ¢ç´¢åœ¨StackOverflowä¸Šï¼Œæœ‰äººæå‡ºæ˜¯å¦å¯ä»¥å®ç°è¿™æ ·çš„é€’å½’å®å®šä¹‰ï¼š\n#define pr(n) ((n==1)? 1 : pr(n-1))\n\næˆ‘ä»¬å¯ä»¥æ ¹æ®ä¹‹å‰å­¦ä¹ çš„è§„åˆ™æ¥å°è¯•å±•å¼€pr(5):\n/* pr(5) -&gt; ((5==1)? 1 : pr(5-1)) -&gt; ?æ­¤æ—¶è¿™ä¸ªç»“æœå°†æ— æ³•è¿›ä¸€æ­¥å±•å¼€ï¼Œä¸ºä»€ä¹ˆå‘¢?åœ¨ä¸€æ¬¡å®å‡½æ•°æ±‚å€¼è¿‡ç¨‹ä¸­ï¼Œæ— æ³•è®¿é—®å®å®šä¹‰æœ¬èº«ã€‚æ­¤æ—¶pr(5-1)å°†è¢«å®å¤„ç†å™¨è®°ä½ï¼Œå®ƒåœ¨åç»­æ°¸è¿œä¹Ÿä¸ä¼šå±•å¼€ã€‚ */\n\nä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œå¤§ä½¬ä»¬æå‡ºäº†ä¸€ç§å»¶æ—¶æ±‚å€¼çš„æŠ€å·§ã€‚\n#define EMPTY(...)#define DEFER(...) __VA_ARGS__ EMPTY()#define OBSTRUCT(...) __VA_ARGS__ DEFER(EMPTY)()#define EXPAND(...) __VA_ARGS__#define pr_id() pr#define pr(n) ((n==1)? 1 : DEFER(pr_id)()(n-1))\n\nå¯ä»¥å°è¯•å†ä¸€æ¬¡å±•å¼€pr(5):\n/* pr(5) -&gt; // å±•å¼€å¤–å±‚å®å‡½æ•°((5==1)? 1 : DEFER(pr_id)()(5 -1))     -&gt; // å±•å¼€å¤–å±‚å‡½æ•°æ—¶å­˜åœ¨DEFER()éœ€å±•å¼€ï¼Œæ³¨æ„pr_idåé¢æ²¡æœ‰æ‹¬å·ï¼Œæ‰€ä»¥pr_idä¸å±•å¼€((5==1)? 1 : pr_id()(5 -1))            // è¿™å°±æ˜¯æœ€ç»ˆçš„ç»“æœï¼Œå› ä¸ºæ­¤æ—¶å¤–å±‚æ²¡æœ‰å®å‡½æ•°åŒ…è£¹ï¼Œå®å¤„ç†å™¨ä¸ä¼šè¿›ä¸€æ­¥è¿›è¡Œæ±‚å€¼// å¦‚æœåœ¨å¤–é¢åŒ…è£¹ä¸€ä¸ªEXPANDï¼Œé‚£å°±èƒ½è¿›ä¸€æ­¥å±•å¼€EXPAND(pr(5)) -&gt;...     // çœç•¥ä¸€äº›è¿‡ç¨‹EXPAND(((5==1)? 1 : pr_id()(5 -1))) -&gt; // å¤–å±‚å­˜åœ¨ä¸€ä¸ªå®å‡½æ•°ï¼Œå†…å±‚éœ€è¦æ±‚å€¼ã€‚éœ€è¦è®¡ç®—pr_id()EXPAND(((5==1)? 1 : pr(5 -1)))      -&gt; // æ³¨æ„ï¼Œæ­¤æ—¶å†…å±‚å·²ç»å±•å¼€å®Œæˆäº†ã€‚å¼€å§‹å±•å¼€å¤–å±‚å®å‡½æ•°((5==1)? 1 : pr(5 -1))  -&gt; å±•å¼€å¤–å±‚å®å‡½æ•°åï¼Œé‡æ–°æ±‚å€¼å‘ç°å­˜åœ¨ä¸€ä¸ªpr()éœ€è¦è¿›ä¸€æ­¥å±•å¼€((5==1)? 1 : ((5 -1==1)? 1 : pr_id ()(5 -1 -1)))    // è¿™å°±æ˜¯æœ€ç»ˆçš„ç»“æœ */\n\nEXPAND()çš„ä½œç”¨å°±æ˜¯è¿›è¡Œä¸€æ¬¡å±•å¼€ã€‚æ˜¾ç„¶ä¸Šé¢çš„é€’å½’å®šä¹‰éœ€è¦å¤šæ¬¡å±•å¼€ã€‚æ‰€ä»¥å¯ä»¥å°†å¤šä¸ªEXPANDå åŠ åœ¨ä¸€èµ·ç»„åˆä¸ºä¸€ä¸ªæ–°çš„å®å‡½æ•°ã€‚\n#define EVAL(...)  EVAL1(EVAL1(EVAL1(__VA_ARGS__)))#define EVAL1(...) EVAL2(EVAL2(EVAL2(__VA_ARGS__)))#define EVAL2(...) EVAL3(EVAL3(EVAL3(__VA_ARGS__)))#define EVAL3(...) EVAL4(EVAL4(EVAL4(__VA_ARGS__)))#define EVAL4(...) EVAL5(EVAL5(EVAL5(__VA_ARGS__)))#define EVAL5(...) __VA_ARGS__\nè°ƒç”¨EVAL()å¯ä»¥è¿›è¡Œå¤šå°‘æ¬¡æ±‚å€¼å‘¢ï¼Ÿ243æ¬¡ã€‚\nè¿™é‡Œé€šè¿‡ä¸€æ¬¡DEFERæ“ä½œå®ç°äº†å¯¹prçš„å»¶æ—¶æ±‚å€¼ï¼Œä½¿å¾—åœ¨å¤–éƒ¨é€šè¿‡è°ƒç”¨EXPANDæ¥åœ¨å¤–éƒ¨å±•å¼€ï¼Œé¿å…äº†æ— æ³•ç›´æ¥é€’å½’çš„é—®é¢˜ã€‚ä½†æ˜¯å¾ˆæ˜¾ç„¶ï¼Œåœ¨å¤–éƒ¨æ‰‹åŠ¨è°ƒç”¨EXPANDçš„æ¬¡æ•°æ˜¯æœ‰é™çš„ï¼Œä¸èƒ½æ— é™é€’å½’ã€‚\nè‡³æ­¤ï¼Œåˆ°è¿™é‡Œä»…ä»…å®Œæˆäº†é€’å½’åµŒå¥—çš„å®šä¹‰ï¼Œå¯¹äºé€’å½’æ¥è¯´ï¼Œæœ€é‡è¦çš„æ˜¯é€’å½’ä¸­æ­¢æ¡ä»¶ï¼Œè¿™æ‰æ˜¯ç”¨å®å‡½æ•°å®ç°é€’å½’çš„ä¸€å¤§éš¾ç‚¹ã€‚åœ¨è¿›ä¸€æ­¥æ¢ç´¢é€’å½’å‰ï¼Œæˆ‘ä»¬å­¦ä¹ ä¸€ä¸‹å¤§ä½¬ä»¬å®ç°çš„ç”¨å®å‡½æ•°å®Œæˆçš„å¾ªç¯è¯­å¥ã€‚\nä½¿ç”¨å®å®šä¹‰å®ç°å¾ªç¯è¯­å¥å‚è€ƒå†…å®¹ï¼šIs the C99 preprocessor Turing complete?\næœ‰å¤§ä½¬å®ç°äº†ä¸€ä¸ªå¾ªç¯è¯­å¥ï¼Œé€šè¿‡å®å®šä¹‰å®ç°ã€‚è¿™é‡ŒæŠŠå…¶ä¸­çš„å…³é”®ä»£ç æ•´ç†å¦‚ä¸‹ï¼š\n#define EMPTY(...)#define DEFER(...) __VA_ARGS__ EMPTY()#define OBSTRUCT(...) __VA_ARGS__ DEFER(EMPTY)()#define EXPAND(...) __VA_ARGS__#define EVAL(...)  EVAL1(EVAL1(EVAL1(__VA_ARGS__)))#define EVAL1(...) EVAL2(EVAL2(EVAL2(__VA_ARGS__)))#define EVAL2(...) EVAL3(EVAL3(EVAL3(__VA_ARGS__)))#define EVAL3(...) EVAL4(EVAL4(EVAL4(__VA_ARGS__)))#define EVAL4(...) EVAL5(EVAL5(EVAL5(__VA_ARGS__)))#define EVAL5(...) __VA_ARGS__#define CAT(a, ...) PRIMITIVE_CAT(a, __VA_ARGS__)#define PRIMITIVE_CAT(a, ...) a ## __VA_ARGS__#define INC(x) PRIMITIVE_CAT(INC_, x)#define INC_0 1#define INC_1 2#define INC_2 3#define INC_3 4#define INC_4 5#define INC_5 6#define INC_6 7#define INC_7 8#define INC_8 9#define INC_9 9#define DEC(x) PRIMITIVE_CAT(DEC_, x)#define DEC_0 0#define DEC_1 0#define DEC_2 1#define DEC_3 2#define DEC_4 3#define DEC_5 4#define DEC_6 5#define DEC_7 6#define DEC_8 7#define DEC_9 8#define CHECK_N(x, n, ...) n#define CHECK(...) CHECK_N(__VA_ARGS__, 0,)#define NOT(x) CHECK(PRIMITIVE_CAT(NOT_, x))#define NOT_0 ~, 1,#define COMPL(b) PRIMITIVE_CAT(COMPL_, b)#define COMPL_0 1#define COMPL_1 0#define BOOL(x) COMPL(NOT(x))#define IIF(c) PRIMITIVE_CAT(IIF_, c)#define IIF_0(t, ...) __VA_ARGS__#define IIF_1(t, ...) t#define IF(c) IIF(BOOL(c))#define EAT(...)#define EXPAND(...) __VA_ARGS__#define WHEN(c) IF(c)(EXPAND, EAT)#define REPEAT(count, macro, ...) \\    WHEN(count) \\    ( \\        OBSTRUCT(REPEAT_INDIRECT) () \\        ( \\            DEC(count), macro, __VA_ARGS__ \\        ) \\        OBSTRUCT(macro) \\        ( \\            DEC(count), __VA_ARGS__ \\        ) \\    )#define REPEAT_INDIRECT() REPEAT\n\næ¥çœ‹çœ‹å…¶å¼ºå¤§ä¹‹å¤„ï¼š\n#define M(i, _) i,int nums[] = &#123;EVAL(REPEAT(8, M, ~))&#125;;// -&gt; int nums[] = &#123;0, 1, 2, 3, 4, 5, 6, 7,&#125;;#define OPR(i, _) i _int sum = EVAL(REPEAT(9, OPR, +)) 0;// -&gt; int sum = 0 + 1 + 2 + 3 + 4 + 5 + 6 + 7 + 8 + 0;int product = EVAL(REPEAT(9, OPR, *)) 1;// -&gt; int product = 0 * 1 * 2 * 3 * 4 * 5 * 6 * 7 * 8 * 1;\n\nè¿™ä¸ªå¾ªç¯çš„å†…åœ¨é€»è¾‘è¿™é‡Œå°±ä¸å¤šè§£é‡Šäº†ï¼Œå¤šçœ‹çœ‹å°±ä¼šäº†ï¼Œæœ‰å¾ˆå¤šçš„æŠ€å·§ã€‚\nå½“æˆ‘æŒæ¡äº†è¿™é‡Œé¢çš„ä¸€äº›æŠ€å·§åï¼Œæˆ‘å¼€å§‹è®¾è®¡ä¸€ä¸ªæ±‚å¤šä¸ªæ•°æœ€å¤§å€¼çš„å®å‡½æ•°ã€‚è¿™å¹¶ä¸å®¹æ˜“ï¼Œéœ€è¦ä½¿ç”¨é€’å½’å®ç°å¹¶å®Œæˆé€’å½’ä¸­æ­¢æ¡ä»¶çš„å¤„ç†ã€‚\nå®å‡½æ•°é€’å½’å®ç°æ±‚æœ€å¤§å€¼æ€è·¯å¦‚ä¸‹ï¼š\n\n1.é‡‡ç”¨å»¶æ—¶æ±‚å€¼è¡¨è¾¾å¼å®Œæˆæ­£å¸¸çš„é€’å½’è¡¨è¾¾ï¼›\n2.å®Œæˆé€’å½’ä¸­æ­¢æ¡ä»¶ï¼Œé€šè¿‡è®¡ç®—å‚æ•°ä¸ªæ•°æ¥åˆ¤æ–­é€’å½’æ˜¯å¦ç»“æŸï¼›\n3.å¤„ç†é€’å½’å†…éƒ¨åˆ†æ”¯æµç¨‹ï¼Œä¸­æ­¢æ¡ä»¶å®Œæˆåéœ€è¦è¿›è¡Œåˆ†æ”¯æµç¨‹ï¼Œä¸€ç§æ˜¯ç»§ç»­é€’å½’ï¼Œä¸€ç§æ˜¯å½“åªæœ‰ä¸€ä¸ªå‚æ•°æ—¶ç›´æ¥è¿”å›ã€‚\n\né¦–å…ˆæ˜¯é€’å½’è¡¨è¾¾å¼ï¼š\n#define MAX_NUM(a, ...) \\    ( \\        a &gt; DEFER(MAX_INDIRECT)(__VA_ARGS__)(__VA_ARGS__) ? \\        a : DEFER(MAX_INDIRECT)(__VA_ARGS__)(__VA_ARGS__) \\    )#define MAX_INDIRECT(...) MAX_NUM\nè¿™é‡Œåº”ç”¨äº†å»¶æ—¶æ±‚å€¼çš„æŠ€å·§ã€‚\næ¥ä¸‹æ¥æ˜¯é€’å½’ä¸­æ­¢æ¡ä»¶ï¼Œéœ€è¦åˆ¤æ–­å‚æ•°ä¸ªæ•°æ˜¯å¦ä¸º1ï¼Œå…ˆå®ç°ä¸€ä¸ªåˆ¤æ–­å®å‚æ•°æ˜¯å¦å­˜åœ¨çš„å®å‡½æ•°ï¼š\n#define GET_P64_I(\\    p1, p2, p3, p4, p5, p6, p7, p8, p9, p10,\\    p11, p12, p13, p14, p15, p16, p17, p18, p19, p20,\\    p21, p22, p23, p24, p25, p26, p27, p28, p29, p30,\\    p31, p32, p33, p34, p35, p36, p37, p38, p39, p40,\\    p41, p42, p43, p44, p45, p46, p47, p48, p49, p50,\\    p51, p52, p53, p54, p55, p56, p57, p58, p59, p60,\\    p61, p62, p63, p64, ... \\    ) p64// é¿å…å†…å±‚å‚æ•°æœªå±•å¼€å¯¼è‡´å‚æ•°æ•°é‡ä¸åŒ¹é…çš„é—®é¢˜#define GET_P64(...) GET_P64_I(__VA_ARGS__)#define ONE_X62 \\    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, \\    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, \\    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, \\    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, \\    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, \\    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, \\    1, 1// é¿å…ç›´æ¥ä½¿ç”¨å¸¦æœ‰##__VA_ARGS__çš„å®ï¼Œå½±å“æ±‚å€¼é¡ºåº#define CHECK_ARGS_I(...) \\    GET_P64(~, ##__VA_ARGS__, \\        ONE_X62, 0)#define CHECK_ARGS(...) CHECK_ARGS_I(__VA_ARGS__)/* CHECK_ARGS(1) -&gt; 1CHECK_ARGS() -&gt; 0CHECK_ARGS(1,2) -&gt; 1CHECK_ARGS(1,2,3) -&gt; 1 */\nCHECK_ARGS()å®å‡½æ•°å¯ä»¥åˆ¤æ–­å®å‚æ•°ä¸ªæ•°ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°åˆ™è¿”å›1ï¼Œå‚æ•°åˆ—è¡¨ä¸ºç©ºåˆ™è¿”å›0ã€‚\næ¥ä¸‹æ¥ä½¿ç”¨CHECK_ARGS()æ¥å®ç°ä¸€ä¸ªåˆ¤æ–­å‚æ•°æ˜¯å¦åªæœ‰ä¸€ä¸ªçš„å®(å¤„ç†é€’å½’ç»“æŸ)ï¼š\n#define EAT_FIRST(x, ...) __VA_ARGS__#define CHECK_ARGS1(...) CHECK_ARGS(EAT_FIRST(__VA_ARGS__))/* CHECK_ARGS1(1) -&gt; 0CHECK_ARGS1(1, 2) -&gt; 1CHECK_ARGS1() -&gt; Error, æ— æ³•æ±‚å€¼ */\n\næ¥ä¸‹æ¥é€šè¿‡CHECK_ARGS1()é…åˆCAT()å®ï¼Œæ‹¼æ¥å‡ºMAX_1å’ŒMAX_0ä¸¤ä¸ªåˆ†æ”¯ï¼š\n#define MAX_NUM(a, ...) \\    ( \\        a &gt; DEFER(MAX_INDIRECT)(__VA_ARGS__)(__VA_ARGS__) ? \\        a : DEFER(MAX_INDIRECT)(__VA_ARGS__)(__VA_ARGS__) \\    )#define MAX_INDIRECT(...) MAX_BRANCH(CHECK_ARGS1(__VA_ARGS__))#define MAX_BRANCH(n) PRIMITIVE_CAT(MAX_, n)#define FIRST(a, ...) a#define MAX_1 MAX_NUM#define MAX_0 FIRST\n\nè‡³æ­¤MAX_NUM()å°±èƒ½å¤Ÿå®Œæˆä¸»è¦çš„åŠŸèƒ½ï¼Œç”±äºå»¶è¿Ÿæ±‚å€¼çš„åŸå› ï¼Œéœ€è¦åœ¨å¤–å±‚å†å¥—ä¸€ä¸ªEVAL()ã€‚æ¯å¤šä¸€ä¸ªå‚æ•°å°±å¤šä¸€å±‚é€’å½’ï¼Œä¹Ÿå°±å¤šä¸€æ¬¡å»¶è¿Ÿæ±‚å€¼ã€‚å‰é¢å†™çš„EVAL()å¯ä»¥å¤„ç†243æ¬¡å»¶è¿Ÿæ±‚å€¼ã€‚\n#define MAX(...) EVAL(MAX_NUM(__VA_ARGS__))/* MAX(1, 2) -&gt;    ( 1 &gt; 2 ? 1 : 2 )MAX(1, 2, 3) -&gt;    ( 1 &gt; ( 2 &gt; 3 ? 2 : 3 ) ? 1 : ( 2 &gt; 3 ? 2 : 3 ) )MAX(1, 2, 3, 4) -&gt;    ( 1 &gt; ( 2 &gt; ( 3 &gt; 4 ? 3 : 4 ) ? 2 : ( 3 &gt; 4 ? 3 : 4 ) ) ? 1 :         ( 2 &gt; ( 3 &gt; 4 ? 3 : 4 ) ? 2 : ( 3 &gt; 4 ? 3 : 4 ) ) )MAX(a, b, c, d, e, f) -&gt;    ( a &gt; ( b &gt; ( c &gt; ( d &gt; ( e &gt; f ? e : f ) ? d : ( e &gt; f ? e :     f ) ) ? c : ( d &gt; ( e &gt; f ? e : f ) ? d : ( e &gt; f ? e : f ) )     ) ? b : ( c &gt; ( d &gt; ( e &gt; f ? e : f ) ? d : ( e &gt; f ? e : f )     ) ? c : ( d &gt; ( e &gt; f ? e : f ) ? d : ( e &gt; f ? e : f ) ) ) )     ? a : ( b &gt; ( c &gt; ( d &gt; ( e &gt; f ? e : f ) ? d : ( e &gt; f ? e :     f ) ) ? c : ( d &gt; ( e &gt; f ? e : f ) ? d : ( e &gt; f ? e : f ) )     ) ? b : ( c &gt; ( d &gt; ( e &gt; f ? e : f ) ? d : ( e &gt; f ? e : f )     ) ? c : ( d &gt; ( e &gt; f ? e : f ) ? d : ( e &gt; f ? e : f ) ) ) ) )int max3(v1, v3, v3)&#123;    return MAX(v1, v2, v3);&#125; -&gt;    int max3(v1, v3, v3)&#123;        return ( v1 &gt; ( v2 &gt; v3 ? v2 : v3 ) ? v1 : ( v2 &gt; v3 ? v2 : v3 ) );    &#125;----Error:MAX() -&gt; ( &gt; ? : )MAX(1) -&gt; ( 1 &gt; ? 1 : ) */\n\nå¯ä»¥çœ‹å‡ºï¼Œé€’å½’å±•å¼€åå‘ˆäºŒæ¬¡å¢é•¿ã€‚æ— è®ºç”Ÿæˆçš„è¡¨è¾¾å¼å¤šå¤æ‚ï¼Œç»“æœéƒ½æ˜¯æ­£ç¡®çš„ã€‚å—é™äºCHECK_ARGS()ï¼Œè¿™åªèƒ½å¤„ç†ä¸è¶…è¿‡63ä¸ªæ•°çš„æœ€å¤§å€¼è®¡ç®—ã€‚\nè¿™é‡Œè¿˜å­˜åœ¨ä¸€ç‚¹ç‚¹ç‘•ç–µï¼Œå‰é¢æ˜¯å…ˆé€’å½’å†åˆ†æ”¯åˆ¤æ–­ï¼Œæ‰€ä»¥ä¼ å…¥ä¸€ä¸ªæˆ–é›¶ä¸ªå‚æ•°æ—¶çš„ç»“æœä¸æ­£ç¡®ã€‚å¯ä»¥å…ˆç›´æ¥è°ƒç”¨MAX_INDIRECT()åšä¸€æ¬¡åˆ†æ”¯åˆ¤æ–­ï¼Œå½“åªæœ‰ä¸€ä¸ªå‚æ•°æ—¶å°±ç›´æ¥è¿”å›ã€‚\n#define MAX(...) EVAL(MAX_INDIRECT(__VA_ARGS__)(__VA_ARGS__))/* MAX(1) -&gt; 1MAX(1, 2) -&gt; ( 1 &gt; 2 ? 1 : 2 )----MAX() -&gt; è¿”å›ä¸ºç©ºMAX_INDIRECTä¸ºä»€ä¹ˆæœ‰ä¸¤ä¸ªå‚æ•°åˆ—è¡¨ï¼Ÿ    ç¬¬ä¸€ä¸ªå‚æ•°åˆ—è¡¨ç”¨äºå»åˆ¤æ–­å‚æ•°æ•°é‡åšåˆ†æ”¯å¤„ç†ï¼Œç¬¬äºŒä¸ªå‚æ•°åˆ—è¡¨æ˜¯å®é™…å¾…å¤„ç†æ•°æ®ã€‚ */\n\næ•°å€¼ç³»ç»ŸMAX()çœŸæ­£æ„ä¹‰ä¸Šæ¥è¯´æ²¡æœ‰å¾—åˆ°ä¸€ä¸ªæ•°åˆ—çš„æœ€å¤§å€¼ï¼ŒåŸå› æ˜¯Cè¯­è¨€çš„å®å®šä¹‰æ²¡æœ‰æ•°å€¼è®¡ç®—ç³»ç»Ÿã€‚æ‰€ä»¥è¿™é‡Œè¿”å›äº†ä¸€ä¸ªè¡¨ç¤ºæœ€å¤§å€¼è¡¨è¾¾å¼ã€‚\nè¿›ä¸€æ­¥æ€è€ƒä¸€ä¸‹ï¼Œå®å®šä¹‰èƒ½ä¸èƒ½å®ç°æ•°å€¼è®¡ç®—ï¼Ÿ\n#define ADD(a, b) (a+b)\n\nè¿™å¹¶ä¸æ˜¯æˆ‘æƒ³è¦çš„ï¼Œè¿™ä»…ä»…è¿”å›äº†ä¸€ä¸ªè¡¨è¾¾å¼ã€‚æˆ‘éœ€è¦çš„æ˜¯èƒ½å¤Ÿç›´æ¥è¿”å›è®¡ç®—ç»“æœã€‚\n/* ADD(1, 2) -&gt; (1+2) // ErrorADD(1, 2) -&gt; 3     // It&#x27;s OK. How to implement it? */\n\næ³¨æ„å‰æ–‡çš„ä¸¤ä¸ªå®å‡½æ•°INC()ã€DEC()ï¼Œå®ƒä»¬èƒ½å¤Ÿå®ç°ä¸€ä¸ªæ•°çš„åŠ 1æˆ–å‡1ï¼š\n/* INC(5) -&gt; 6INC(0) -&gt; 1DEC(1) -&gt; 0DEC(9) -&gt; 8INC(DEC(1)) -&gt; 1 */\n\né‚£ä¹ˆADD(a, b)å‡½æ•°å¯ä»¥è¡¨è¾¾ä¸ºéœ€è¦è°ƒç”¨aæ¬¡çš„INC(b)ã€‚æˆ–è€…è¯´a+b&#x3D;(a-1)+(b+1)ï¼ŒADD(a, b)&#x3D;ADD(DEC(a), INC(b))ã€‚è¿™çœ‹èµ·æ¥åˆæ˜¯ä¸€ç§é€’å½’çš„å½¢å¼äº†ï¼Œå½“aç­‰äº0æ—¶ç»“æŸé€’å½’ã€‚è¿™æ˜¯ä¸€ç§å°¾é€’å½’çš„å½¢å¼ï¼Œå¯ä»¥ä½¿ç”¨è¡¨è¾¾ä¸ºå¾ªç¯ã€‚æ¥çœ‹çœ‹Cè¯­è¨€çš„å½¢å¼ï¼š\nint add(int a, int b)&#123;    if(a)&#123;        return add(a - 1, b + 1);    &#125;else&#123;        return b;    &#125;&#125;\nè¿™æ ·çš„å½¢å¼å°±å¾ˆå®¹æ˜“ä½¿ç”¨å®å®šä¹‰è¡¨è¾¾ï¼š\n#define ADD_INDIRECT() ADD#define ADD(a, b) \\    WHEN(a) (OBSTRUCT(ADD_INDIRECT)() (DEC(a), INC(b))) \\    WHEN(NOT(a)) (b)/* è¿™é‡Œä½¿ç”¨OBSTRUCT()æ¥è¿›è¡Œå»¶æ—¶æ±‚å€¼ï¼Œæ‰€ä»¥æœ€ç»ˆçš„è¡¨è¾¾å¼éœ€è¦ä½¿ç”¨EVAL()è¿›è¡Œå±•å¼€æ±‚å€¼ã€‚EVAL(ADD(1,2)) -&gt; 3EVAL(ADD(2,2)) -&gt; 4EVAL(ADD(5,0)) -&gt; 5EVAL(ADD(0,5)) -&gt; 5EVAL(ADD(0,0)) -&gt; 0EVAL(ADD(2,EVAL(ADD(2,2)))) -&gt; 6 */\n\næ€è€ƒä¸€ä¸‹ï¼Œèƒ½ä¸èƒ½å®ç°ä¸€ä¸ªæ•°å€¼ç‰ˆæœ¬çš„MAX()å®å‡½æ•°ï¼Ÿå®ƒèƒ½çœŸæ­£è®¡ç®—å‡ºæ•°åˆ—çš„æœ€å¤§å€¼ã€‚\n/* MAX(1, 2)    -&gt; 2MAX(3, 2, 1) -&gt; 3 */\n\nè¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªæ–°çš„æŒ‘æˆ˜ï¼Œéœ€è¦å®Œæˆå®å®šä¹‰ä¸­æ²¡æœ‰çš„æ•°å€¼æ¯”è¾ƒåŠŸèƒ½ã€‚åé¢æœ‰æ—¶é—´å†ç ”ç©¶ã€‚ğŸ˜…\næ€»ç»“ä»…ç”¨#defineåŠŸèƒ½å°±å®Œæˆäº†æ¡ä»¶è¯­å¥ã€å¾ªç¯ã€é€’å½’çš„å®ç°ã€‚è¿™æ˜¯ä¸æ˜¯æ„å‘³ç€Cè¯­è¨€çš„å®æ˜¯å›¾çµå®Œå¤‡çš„å‘¢ï¼Ÿ\næˆ‘æŸ¥é˜…äº†å¾ˆå¤šç½‘å‹çš„è®¨è®ºï¼Œå¤§éƒ¨åˆ†äººçš„çœ‹æ³•æ˜¯æœ‰é™ä¸ªæ•°çš„å®æ ‡è¯†ç¬¦æ— æ³•å®Œæˆå°½å¯èƒ½å¤§çš„é€’å½’æ·±åº¦ã€‚é€šè¿‡Cè¯­è¨€å®å®ç°çš„counteræœºåˆ¶è¦æ±‚æ¯ä¸ªå€¼éƒ½éœ€è¦ä¸€ä¸ªå®æ ‡è¯†ç¬¦ï¼Œè¿™å°±é™åˆ¶äº†å®çš„å¤æ‚æ€§ã€‚å› ä¸ºCè¯­è¨€çš„è§„èŒƒä¸­é™å®šäº†å•æ¬¡å®å¤„ç†æ ‡è¯†ç¬¦çš„æœ€å¤§æ•°é‡ã€‚è¿™å’Œå…¶å®ƒå›¾çµæœºçš„æ— é™å†…å­˜æ˜¯æœ‰æœ¬è´¨åŒºåˆ«çš„ã€‚\næ­¤å¤–ï¼Œå‰é¢æ‰€å®ç°çš„å¾ªç¯å’Œé€’å½’éƒ½æ˜¯æœ‰é™æ·±åº¦çš„ã€‚æ— æ³•å®ç°æ— é™å¾ªç¯å’Œæ— ç©·é€’å½’å°±ä¸å…·å¤‡å®Œæ•´çš„å›¾çµå®Œå¤‡æ€§ã€‚ä½†å®ƒç¡®å®å®Œæˆäº†è¿­ä»£ã€æ¡ä»¶ç­‰ç±»ä¼¼çš„ç»“æ„ï¼Œè¿™æ˜¯ä¸æ˜¯æ„å‘³ç€å®ƒæ˜¯å­˜åœ¨æœ‰é™çš„å›¾çµå®Œå¤‡æ€§ã€‚\næœ¬æ–‡ä»…è®¨è®ºCè¯­è¨€å®çš„ä¸€äº›å†…åœ¨æ€§è´¨ï¼Œå¹¶ä¸æ¨èåœ¨å®é™…çš„å¼€å‘ä¸­ä½¿ç”¨å¦‚æ­¤å¤æ‚çš„ä»£ç ã€‚\nå‚è€ƒ1.theory - ä»€ä¹ˆæ˜¯å›¾çµå®Œå¤‡ï¼Ÿ2.C&#x2F;C++ å®çš„å›¾çµå®Œå¤‡æ€§3.Is the C99 preprocessor Turing complete?4.Dave Prosserâ€™s C Preprocessing Algorithm5.Best abuse of the C preprocessor\n"},{"title":"Exception Failure - Breaking the STM32F1 Read-Out Protection","url":"/2022/03/28/Exception%20Failure%20-%20Breaking%20the%20STM32F1%20Read-Out%20Protection/","content":"Marc Schink &amp; Johannes Obermaier Tuesday, 17 March 2020\n\nThe firmware of microcontrollers usually contains valuable data such as intellectual property and, in some cases, even cryptographic material. In order to protect the confidentiality of these assets, most microcontrollers feature some kind of firmware read-out protection. This security feature shall prevent adversaries with physical access to a device from reading out the internal flash memory. Nevertheless, security researchers as well as hobbyists showed repeatedly that these security features can be circumvented. In this research article, we examine the flash read-out protection (RDP) of the STM32F1 series from STMicroelectronics. We discuss a novelly discovered vulnerability whose exploitation would be the first non-invasive way to circumvent the feature. The issue results from an insufficient access restriction: flash data reads via the debug interface are blocked but the CPUâ€™s exception handling process is still able to read from flash memory via the ICode bus. We explain in detail why and how this vulnerability exposes major parts of the internal memory, thereby affecting device security.\n\n\n\n\n\nIntroductionFor the protection of intellectual property and other sensitive data such as cryptographic material, securing the internal flash memory of a microcontroller is of utmost importance. If an attacker gains access to the firmware, they can clone the product, alter its functionality or extract security credentials. Thus, the hardening of microcontroller plays a major role in todayâ€™s embedded system security â€” not only for high-security devices but also for commercial microcontrollers.\nThe deactivation of the debug interface is one usual way to prevent adversaries from gaining access to the flash memory, however, the implementation differs between microcontrollers. For example, the debug interface of the STM32F0 series can be entirely switched off. In contrast, the STM32F1 series does not directly support this, but relies on another approach. One of its main security features is the flash memory read-out protection (RDP). This security feature blocks all data accesses to the flash memory via the debug interface once a debug probe is attached to the microcontroller. This means that an attacker is able to attach a debug probe to the microcontroller but cannot read out the flash memory content.\nHowever, research has shown for some microcontrollers that this protection mechanism is flawed. For the STM32F0 series, for instance, Johannes Obermaier and Stefan Tatschner presented an attack in Shedding too much Light on a Microcontrollerâ€™s Firmware Protection that is able to extract protected data from flash memory. Some researchers assumed that this vulnerability might also affect other series such as the STM32F1. However, one of the authors contradicted that the STM32F1 microcontroller family exhibits the same vulnerability in the debug interface. Until now, the flash read-out protection mechanism of the STM32F1 series was considered as being secure and there was no evidence that it can be circumvented. In this article, we discuss a vulnerability (CVE-2020-8004) that leads to the first non-invasive attack against the flash protection mechanism of the STM32F1 family.\nDiscovering the VulnerabilityThe STM32F1 series does not provide a feature to permanently disable the debug interface. For that reason, an attacker with physical access to the debug interface is always able to gain debug access to the microcontroller. However, the integrated flash read-out protection prevents any data access to the flash memory once a debug probe is attached to the microcontroller.\nIn order to examine the flash read-out protection feature, we use an STM32 Nucleo-64 development board with an STM32F103RB microcontroller. The read-out protection of the microcontroller is enabled which means that the flash memory is not accessible via the debug interface. The microcontroller is attached via the SWD debug interface to an external SEGGER J-Link debug probe, as depicted in Figure 1.\n\n\n Figure 1: STM32 Nucleo-64 development board with attached SEGGER J-Link debug probe.\n\n\nWe begin our examination by establishing a debug connection to the target microcontroller. For that, we start OpenOCD with the following command:\nopenocd -f interface/jlink.cfg -c &quot;transport select swd&quot; -f target/stm32f1x.cfg\n\nAfter that, we open a Telnet session on OpenOCD such that we can control the microcontroller. Finally, we perform a device reset with the command and get the following output in our Telnet session:reset halt\ntarget halted due to debug-request, current mode: ThreadxPSR: 0x01000000 pc: 0x08000268 msp: 0x20005000\n\nAt a first glance, there is nothing special with this output. However, when you take a closer look at the second line, especially one value should pop into your eyes: the program counter (PC) value is a valid address located in flash memory. This is of major importance because a reset is a special kind of exception. Every time an exception is generated, the processor loads the corresponding exception entry address from the vector table into the PC. This procedure is sometimes referred to as vector fetch. After a device reset, the vector table is located in flash memory. Hence, this observation implies that the processor fetches the reset vector from flash memory even though the read-out protection is enabled.0x08000268\nBut why is the exception entry process able to read the reset vector from flash memory? The STM32F1 reference manual provides a hint:\n\nThe CortexÂ®-M3 CPU always fetches the reset vector on the ICode bus, which implies to have the boot space available only in the code area (typically, Flash memory).\n\nThe reset vector is fetched via the ICode bus and thus handled like instruction fetches which are allowed despite the activated read-out protection. The read-out protection seems to take care of data accesses via the data bus (DCode bus) only and hence the reset vector can still be fetched over the ICode bus. The Cortex-M3 Technical Reference Manual provides additional information regarding vector fetches in general:\n\nThe vector fetch is performed over either the System bus or the ICode bus depending on where the vector table is located [â€¦]\n\nIn summary, the flash read-out protection of the STM32F1 does not block memory accesses via the ICode bus. Once an exception takes place, the corresponding entry address stored in flash memory is fetched through the ICode bus and thereby exposes the memory content through the PC.\nExploitationOur observation shows that once an exception takes place, the vector fetch exposes protected flash memory content through the PC. In this section, we discuss how this behaviour can be exploited to bypass the read-out protection of the STM32F1.\nWe already mentioned the vector table: it contains the initialization value of the main stack pointer (MSP) followed by an entry address for every exception. The vector table for microcontrollers based on the ARMv7-M architecture is shown in Table 1. The table lists the exceptions with their memory offset relative to the beginning of the vector table. The first 16 exceptions of the vector table are mandatory and specified by the ARMv7-M architecture. All other exceptions are so called external interrupts, they are optional and device specific.\n\n\n\n\n\nException number\nException\nOffset\n\n\n\n-\nMain stack pointer (MSP) initialization value\n0x0\n\n\n1\nReset\n0x4\n\n\n2\nNMI\n0x8\n\n\n3\nHardFault\n0xc\n\n\n4\nMemManage\n0x10\n\n\n5\nBusFault\n0x14\n\n\n6\nUsageFault\n0x18\n\n\n7-10\nReserved\n0x1c\n\n\n11\nSVCall\n0x20\n\n\n12\nDebugMonitor\n0x24\n\n\n13\nReserved\n0x28\n\n\n14\nPendSV\n0x2c\n\n\n15\nSysTick\n0x30\n\n\n16\nExternal Interrupt 0\n0x34\n\n\nâ€¦\nâ€¦\nâ€¦\n\n\n\n\nTable 1: Vector table for microcontrollers implementing the ARMv7-M architecture.\n\n\nThe basic exploitation idea is to deliberately generate exceptions such that the corresponding vector table entry is fetched from flash memory and exposed through the PC. However, Table 1 shows that some entries are reserved and are not mapped to an exception, namely the entries 7 to 10 and 13. Also needless to say, the initialization value for the MSP is not mapped to an exception. For that reason, the corresponding table entries cannot be extracted via this approach. We ignore this for the moment and address these limitations in more detail later in this article.\nVector Table OffsetAt this point, the following question may arise: why should I care about the confidentiality of the vector table content?\nIndeed, the content of the vector table is usually not confidential as it only contains the exception entry addresses. But note that the ARMv7-M architecture specifies a Vector Table Offset Register (VTOR) that determines the location of the vector table inside the address space. This feature is usually used to relocate the vector table when there are multiple applications on the microcontroller, for example, a bootloader and a main application. With that, both applications can have their own vector table and exception handlers. The crucial point here is again, that we have debug access to the entire device except for the flash memory. With help of the VTOR, we are able to relocate the vector table within the flash memory region and extract large amount of its data.\nIn order to use the vector table relocation, we split the flash memory into equally sized blocks of 32 words, as depicted in Figure 2. The block size is related to the vector table size and, as required by the ARMv7-M specification, must be a power of 2. For example, the STM32F103 has 59 exceptions and therefore the actual vector table size is 64. However, this means that we do not have enough exceptions to access all its table entries. For that reason, we use the largest possible vector table that fits in 59 which is 32.\n\n\nFigure 2: Relocation of the vector table within the flash memory. Inaccessible table entries are highlighted.\n\n\nThe seven highlighted memory words in Figure 2 cannot be extracted. The first two words are the initialization value for the MSP and the reset vector. The other words correspond to the reserved entries of the vector table. The MSP initialization value and the reset vector are special and can only be extracted when the vector table is located at the beginning the of the flash memory, its default location. The reason is that a device reset is necessary to extract these value, however, this also resets the VTOR and relocates the vector table to the beginning of the flash memory region.\nThese limitations can be reduced by using exceptions that exceed the vector table size. In this case, exceptions with a number greater than 31. According to section 4.4.4 of the STM32F1 programming manual, the vector table location must be aligned to the actual vector table size, 64 in case of the STM32F103. But what happens when our vector table is unaligned and we generate exceptions with numbers greater than the vector table size? It turns out that these exceptions are mapped to the beginning of the vector table. Figure 3 illustrates this wrap-around behaviour for an unaligned vector table with 32 entries. On the left-hand side, the regular vector table with its inaccessible entries highlighted is depicted. On the right-hand side, the figure shows how the wrap-around behaviour makes the inaccessible parts of the vector table accessible. The highlighted vector table entries are now accessible by exceptions that exceed the vector table size.\n\n\nFigure 3: Wrap-around behaviour of an unaligned vector table. Inaccessible entries (red) become accessible (blue) when an exception exceeds the table size.\n\n\nNote that in Figure 3, the focus is on the inaccessible parts of the vector table. The other entries can also be extracted via the wrap-around behaviour, however, this is not necessary since they can be extracted regularly. With the help of the wrap-around, we are now able to extract vector table entries that were reserved or inaccessible before. Even the first two entries which were only extractable when the vector table is located at the beginning of the flash memory region. The only limitation that remains is that we can use this approach only for unaligned vector tables. Nevertheless, we reduced the number of inaccessible memory words by a factor of two. Note that this approach is one way to make use of the additional external interrupts. We use this way because it is very convenient to implement.\nNow, we have almost everything we need to extract nearly arbitrary parts of the flash memory. In the next section, we describe the last missing piece: how to generate exceptions on purpose.\nException GenerationTo generate each individual exception for firmware extraction, we continue as follows. We need three steps to trigger an exception:\n\nPerform a device reset such that the microcontroller is in a defined state and to recover it from possible faults and lockups.\nConfigure the microcontroller such that the indented exception is pending.\nPerform a single step to make the pending exception active.\n\nThe Non-Maskable Interrupt (NMI), PendSV and SysTick exception can easily made pending by setting the corresponding bits , and respectively. These bits can be found in the Interrupt Control and State Register (ICSR). The same holds for the DebugMonitor exception which can be made pending by setting the bit in the Debug Exception and Monitor Control Register (DEMCR).NMIPENDSETPENDSVSETPENDSTSETMON_PEND\nFor example, the following OpenOCD commands makes the PendSV exception pending:\nmww 0xe000ed04 0x10000000\n\nSince the processor is in debug mode and halted, we need to give it the chance to execute the exception. For that, we use the command to execute only a single instruction. In order to avoid side-effects by the executed instruction, we execute a single instruction placed in SRAM at address .stepnop0x20000000\nmwh 0x20000000 0xbf00reg pc 0x20000000\n\nNote that it is necessary to disable interrupt masking. This feature is enabled by default and can be deactivated with the following command:\ncortex_m maskisr off\n\nThis command changes the single-stepping behaviour and controls the bit in the Debug Halting Control and Status Register (DHCSR). This bit determines whether PendSV, SysTick and all external interrupts shall be masked. By default, is set to auto which means that a command first allows pending interrupt handlers to execute and then steps over the desired instruction.C_MASKINTSmaskisrstep\nNote\nThe command is not available for so called high-level adapters (HLA) in OpenOCD. For that reason, we do not use the integrated ST-LINK debug probe of the Nucleo-64 development board.maskisr\nOnce an exception is generated, you may experience that there is a mismatch between the exception entry address in the vector table and the PC value. The least-significant bit (LSB) may be incorrect. The reason is that the LSB of the exception entry address is not loaded into the PC but used as Thumb state of the processor. Since the Thumb state is encoded in the Execution Program State Register (EPSR), we are able to recover the entire exception entry address by combining the PC and the Thumb state bit.\nWe have all building blocks required to extract vector table entries. In the following, we elaborate how to generate the remaining exceptions. For simplicity, we omit the first and last step of the exception generation process throughout the remainder of this article.\nBusFaultA BusFault exception occurs, for example, when a memory instruction accesses an invalid memory region. Hence, we can generate a BusFault by executing a load instruction that performs a read access on an invalid memory region.\nFor that, we place an into the SRAM at address and configure the base register and the PC accordingly:ldr r0, [r1, #0]0x20000000r1\nmwh 0x20000000 0x0868reg r1 0xf0000000reg pc 0x20000000\n\nThe address stored in is part of the vendor-specific memory region. In case of the STM32F1, this address is not mapped in the memory space. Therefore, every memory operation on this address is illegal and thus suitable to generate a BusFault exception. All other addresses that are not mapped work as well.0xf0000000r1\nBefore we are able to generate a BusFault exception, we need to enable it by setting the bit in the System Handler Control and State Register (SHCSR):BUSFAULTENA\nmww 0xe000ed24 0x20000\n\nThis step is necessary because otherwise priority escalation would take place and the processor would generate a HardFault exception instead of a BusFault.\nMemManageThe MemManage exception is generated whenever a memory protection fault occurs. Among others, this happens when the processor attempts to execute code in a memory region that is marked as eXecute Never (XN).\nIn order to cause a memory protection violation, we configure the processor such that it attempts to execute code on a memory region marked as XN. In our case, we chose the first address of the system memory address space which is at the address .0xe0000000\nreg pc 0xe0000000\n\nAs for the BusFault exception, the MemManage exception needs to be enabled. We do this by setting the bit in the SHCSR:MEMFAULTENA\nmww 0xe000ed24 0x10000\n\nUsageFaultUsageFault exceptions can occur for a variety of reasons. One reason is, for example, when an unaligned memory load or store operation is performed.\nHowever, the straightforward way is to execute an undefined instruction such as . We place this instruction in SRAM at address and configure the PC accordingly:0xffff0x20000000\nmwh 0x20000000 0xffffreg pc 0x20000000\n\nAs for the other exceptions, the UsageFault exception needs to be enabled. This can be done by setting the bit in the SHCSR:USGFAULTENA\nmww 0xe000ed24 0x40000\n\nHardFaultA HardFault is a generic fault that is generated whenever a fault cannot be handled by any other exception.\nThere are different means to generate a HardFault exception manually. A straightforward way is to generate one of the previously mentioned exceptions without enabling it. As explained before, this causes a priority escalation and the HardFault exception gets generated.\nSVCallA Supervisor Call (SVCall) is used by software to call the operating system. This exception is generated whenever the processor executes an instruction.svc\nWe generate this exception by placing an instruction in SRAM and execute it with a single step.svc #0\nmwh 0x20000000 0xdf00reg pc 0x20000000\n\nSince we are only interested in generating an SVCall exception, the immediate value is not important and can be arbitrarily chosen. In contrast to the former two exceptions, a supervisor call is permanently enabled.#imm\nExternal InterruptsThe Nested Vectored Interrupt Controller (NVIC) handles all the external interrupts. It provides two set of registers: one to enable external interrupts and a second one to make them pending. In order to trigger an external interrupt, we set the corresponding bits in both registers to enable the interrupt and make it pending. Every bit corresponds to an external interrupt.\nFor example, in case of the STM32F1 series, the first external interrupt is the window watchdog (WWDG) interrupt. In order to trigger this interrupt, we set the first bit in both registers:\nmww 0xe000e100 0x1mww 0xe000e200 0x1\n\nAll other external interrupts can be generated accordingly.\nThe number of external interrupts varies a lot among the different devices of the STM32F1 family. Additionally, the documentation is sometimes not accurate. For example, according to the STM32F1 reference manual, the external interrupts 43 to 49 of connectivity line devices are reserved. However, we found out that they can be generated like all the other interrupts. The importance of the available external interrupts will be seen in the next section.\nPerformanceThe amount of extractable memory content and the extraction speed are key indicators whether the identified vulnerability undermines the security of the read-out protection in field applications.\nIn order to asses the severity of this vulnerability, we implemented a Python script that generates exceptions in an automated fashion to extract firmware from a read-out protected microcontroller. We evaluated the presented attack on three different devices of the STM32F1 series. In all cases, we aimed to extract 128 KiB of flash memory from the devices. The evaluation results are listed in Table 2.\n\n\n\n\n\nDevice\nExternal interrupts\nExtraction time\n\n\n\nSTM32F100\n55\n48.8 min\n\n\nSTM32F103\n43\n48.2 min\n\n\nSTM32F107\n68\n51.0 min\n\n\nTable 2: Extraction time and coverage for three devices of the STM32F1 series.\n\n\nThe results show that the amount of flash memory that can be extracted correlates with number of external interrupts. The most data can be extracted from the STM32107 microcontroller with its 68 external interrupts. The table also shows that the extraction time slightly increases with the increasing amount of extracted data.\nWe used a SEGGER J-Link debug probe with an adapter speed of 3500 kHz for the performance evaluation. Note that the adapter speed of your debug probe is an important factor for the extraction time and might also be influenced by further factors in your setup, for example, your computer system.\nIn a nutshell, these results show that the attack is indeed practically feasible as it can be executed in reasonable time: in less than one hour.\nConclusionIn this article, we discussed a vulnerability in the flash read-out protection mechanism of the STM32F1 microcontroller series. We showed that the exploitation is non-invasive and requires only access to the microcontrollerâ€™s debug interface. Hence, this attack is clearly within the typical attacker models of flash readout protection mechanisms.\nThe presented attack has certain limitations and does not allow an attacker to read out the entire flash memory. However, depending on the device, an attacker is able to read out up to 94.5 percent of the flash memory content in less than an hour. For that reason, we consider this read-out protection mechanism as broken and we do not recommand to rely on this feature anymore. Since the STM32F1 series has no other firmware protection mechanism, the only way known to the authors to avoid exploitation and thus keep the entire flash memory content confidential is to physically prevent an attacker from gaining access to the debug interface.\nAvailabilityIn order to encourage discussions and make our research results comprehensible and replicable, we publish the source code that was developed during our research. The source code is licensed under the GPLv3+ and can be found on https://gitlab.zapb.de/zapb/stm32f1-firmware-extractor.\nCoordinated DisclosureThe publication of our findings was preceded by a coordinated vulnerability disclosure process. We informed STMicroelectronics more than 100 days prior to the publication of this article.\n\n28 November 2019: Technical details about the vulnerability and the disclosure timeline provided to STMicroelectronics.\n08 December 2019: No response from STMicroelectronics so far. Reminder with technical details and disclosure timeline.\n23 December 2019: Still no response from STMicroelectronics. Reminder without technical details.\n06 January 2020: Reminder from CERT Bund and immediate response from STMicroelectronics.\n10 January 2020: Conference call with STMicroelectronics and CERT Bund as mediator.\n15 January to 07 February 2020: Further discussions between STMicroelectronics and CERT Bund.\n01 February 2020: Public announcement of the vulnerability without technical details.\n17 March 2020: Publication of this article and supplementary materials.\n\nAbout the AuthorsMarc Schink and Johannes Obermaier are two embedded system security researchers with a background in computer science and electrical engineering. They focus especially on microcontrollers that both encounter in their everyday live. With their research and publications they aim at improving security by an open discussion about the strength of security features and wish for improvements.\n\nExcept where otherwise noted, content on this site is licensed under a Creative Commons BY-NC-SA 4.0 license.\n"},{"title":"FreeRTOSä¸Šå®ç°swapæœºåˆ¶","url":"/2022/08/11/FreeRTOS%E4%B8%8A%E5%AE%9E%E7%8E%B0swap%E6%9C%BA%E5%88%B6/","content":"ä¸ºä»€ä¹ˆéœ€è¦å¼•å…¥SWAPæœºåˆ¶åœ¨å°å®¹é‡SRAMçš„å•ç‰‡æœºä¸Šä½¿ç”¨RTOSæ˜¯ä¸€ç§å¾ˆå°´å°¬çš„äº‹æƒ…ï¼Œå› ä¸ºæ¯ä¸ªä»»åŠ¡éƒ½éœ€è¦åˆ†é…ç‹¬ç«‹çš„çº¿ç¨‹æ ˆï¼Œæ ˆç©ºé—´å°‘åˆ™512å­—èŠ‚ï¼Œå¤æ‚ä»»åŠ¡çš„æ ˆç©ºé—´åˆ™è¾¾åˆ°äº†å‡ åƒå­—èŠ‚çš„å¤§å°ï¼Œè¿™å¯¹äºä»…æœ‰8kå­—èŠ‚SRAMçš„å•ç‰‡æœºæ¥è¯´æ˜¾å¾—å‹åŠ›å¤ªå¤§äº†ï¼Œä¸¤ä¸‰ä¸ªä»»åŠ¡å°±å¯¼è‡´å†…å­˜ä¸è¶³ã€‚\nä½¿ç”¨åç¨‹æ–¹æ¡ˆåœ¨åœ¨å°å®¹é‡å•ç‰‡æœºä¸Šæ˜¯ä¸€ä¸ªä¸é”™çš„æ–¹æ¡ˆï¼Œä½†æ˜¯åç¨‹ç›¸æ¯”äºå®æ—¶æ“ä½œç³»ç»Ÿå…·æœ‰å¾ˆå¤šçš„ç¼ºç‚¹ã€‚æ¯”å¦‚ä»»åŠ¡å®æ—¶æ€§ä¸è¶³ã€åœ¨ç”¨æ³•ä¸Šä¸çµæ´»ç­‰ã€‚\næ ¹æ®ç°ä»£æ“ä½œç³»ç»Ÿçš„SWAPæœºåˆ¶ï¼Œæˆ‘åœ¨FreeRTOSæ“ä½œç³»ç»Ÿä¸Šä¹Ÿå®ç°äº†ä»»åŠ¡æ ˆçš„swapæœºåˆ¶ï¼Œé€šè¿‡å¤–éƒ¨å­˜å‚¨è®¾å¤‡æ‰©å±•å•ç‰‡æœºå†…çš„å¯ç”¨æ ˆç©ºé—´å¤§å°ï¼Œå¯æ˜¾è‘—é™ä½ç‰‡å†…SRAMç©ºé—´çš„æ¶ˆè€—ã€‚åŒæ—¶è¯¥æ–¹æ¡ˆå¯¹ä»»åŠ¡æ¥è¯´æ˜¯æ— æ„Ÿçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå’Œæ™®é€šä»»åŠ¡ä¸€æ ·åœ¨ç”¨æ³•ä¸Šæ²¡æœ‰åŒºåˆ«ï¼Œå¯ä»¥æŒ‰ç…§ä¼ ç»Ÿçš„RTOSä»»åŠ¡è¿›è¡Œè®¾è®¡ï¼Œè¿™å¯¹äºä»»åŠ¡çš„ç§»æ¤æ¥è¯´èƒ½å¤Ÿé™ä½å¤æ‚æ€§ã€‚\næ–¹æ¡ˆä»‹ç»ä½¿ç”¨SWAPæœºåˆ¶ä¸€ä¸ªé‡è¦å‰ææ˜¯éœ€è¦ä¸€ä¸ªå¤§å®¹é‡çš„ç‰‡å¤–å­˜å‚¨è®¾å¤‡æ¥è¿›è¡Œå†…å­˜äº¤æ¢ã€‚æ¯”å¦‚è¯´ç‰‡å¤–çš„PSRAMï¼Œé€šè¿‡SPIæ€»çº¿è®¿é—®çš„é‚£ç§ã€‚ä¸€ä¸ªåŸºæœ¬çš„è®¾æƒ³æ˜¯å…ˆåˆ†é…ä¸€æ®µå®é™…çš„ç‰©ç†ç©ºé—´ï¼Œè¿™å°†ä½œä¸ºæ‰€æœ‰çº¿ç¨‹çš„æ ˆç©ºé—´ï¼Œçº¿ç¨‹Aåœ¨ä½¿ç”¨å®Œè¿™æ®µç©ºé—´åï¼Œåˆ‡æ¢åˆ°çº¿ç¨‹Bæ—¶ï¼Œå…ˆå°†çº¿ç¨‹Açš„æ ˆç©ºé—´æ•°æ®å­˜æ”¾åˆ°å¤–éƒ¨åˆ†é…çš„SWAPç©ºé—´ä¸Šï¼ŒåŒæ—¶å°†çº¿ç¨‹Bä¿å­˜åœ¨å¤–éƒ¨SWAPç©ºé—´ä¸Šçš„æ ˆæ•°æ®æ¢å¤åˆ°å…±äº«çš„æ ˆç©ºé—´ä¸Šã€‚é€šè¿‡é¢„ç•™åœ¨FreeRTOSå†…çš„HOOKæ¥å£å¾ˆå®¹æ˜“å°±èƒ½å®ç°è¿™äº›åŠŸèƒ½ï¼Œä¸”å¯¹FreeRTOSçš„åŸæœ‰ä»£ç æ²¡æœ‰æ˜æ˜¾çš„å…¥ä¾µã€‚\nå…·ä½“å®ç°çš„è¦ç‚¹\n1.ä»»åŠ¡åˆ›å»ºä¸ºäº†æŒ‡å®šä»»åŠ¡è¿è¡Œæ—¶å®é™…çš„æ ˆç©ºé—´åœ°å€ï¼Œä½¿å¾—æ ˆç©ºé—´æ•°æ®å¯æ§ï¼Œéœ€è¦ä½¿ç”¨xTaskCreateStatic()æ¥å£åˆ›å»ºä»»åŠ¡ã€‚æ­¤å¤–ï¼Œåˆ›å»ºä»»åŠ¡æ—¶ä¼šå¯¹æ ˆç©ºé—´æ•°æ®è¿›è¡Œå¿…è¦çš„åˆå§‹åŒ–æ“ä½œï¼Œæ‰€æœ‰åˆ›å»ºä»»åŠ¡æ—¶çš„ä¸Šä¸‹æ–‡æ ˆç©ºé—´ä¸èƒ½å¤„äºå…±äº«æ ˆç©ºé—´ä¸Šï¼Œå¦åˆ™ä¼šå‡ºç°æ•°æ®å†²çªã€‚ä»»åŠ¡çš„åˆ é™¤ä¹Ÿéœ€è¦ç‰¹åˆ«è®¾è®¡ï¼Œä»»åŠ¡åˆ é™¤ä»…ä»…éœ€è¦åˆ é™¤åˆ†é…çš„TCBå—ç©ºé—´ï¼Œæ ˆç©ºé—´ä¸ä¼šæ”¶ï¼Œä½†æ˜¯éœ€è¦é‡Šæ”¾å¤–éƒ¨åˆ†é…çš„SWAPç©ºé—´ã€‚\n\n2.ä»»åŠ¡åˆ‡æ¢æ—¶æ ˆç©ºé—´å­˜å‚¨å°†å½“å‰ä»»åŠ¡çš„æ ˆç©ºé—´å­˜å‚¨åˆ°SWAPç©ºé—´æ—¶ï¼Œæ²¡æœ‰å¿…è¦å°†æ•´ä¸ªæ ˆç©ºé—´éƒ½è¿›è¡Œå­˜å‚¨ï¼Œå› ä¸ºæ ˆçš„ä½¿ç”¨æ˜¯çº¿æ€§è¿ç»­çš„ï¼Œé€šå¸¸ä½¿ç”¨æ ˆåº•çš„éƒ¨åˆ†æ•°æ®ï¼Œæ‰€ä»¥ä»…éœ€ä¿å­˜éƒ¨åˆ†æ•°æ®åˆ°SWAPç©ºé—´å³å¯ï¼Œè¿™æ ·å¯ä»¥æå‡çº¿ç¨‹çš„åˆ‡æ¢é€Ÿåº¦ã€‚åœ¨ä»»åŠ¡åˆ‡æ¢æ—¶è¿˜éœ€è¦åšé€‚å½“çš„åˆ¤æ–­ï¼Œé¿å…æ— æ•ˆçš„æ ˆç©ºé—´äº¤æ¢ã€‚æˆ‘ä»¬ä»…ä»…éœ€è¦åœ¨ä»ä¸€ä¸ªå…±äº«æ ˆä»»åŠ¡åˆ‡æ¢åˆ°å¦ä¸€ä¸ªå…±äº«æ ˆä»»åŠ¡æ—¶éœ€è¦è§¦å‘SWAPæœºåˆ¶ï¼Œå…¶å®ƒæƒ…å†µéƒ½ä¸éœ€è¦è¿›è¡Œå†…å­˜äº¤æ¢ã€‚ä¾‹å¦‚ï¼ŒTiemrçº¿ç¨‹çš„æ ˆæ—¶ç‹¬ç«‹åˆ†é…çš„ï¼Œé‚£ä¹ˆä»timeråˆ‡æ¢åˆ°å…±äº«æ ˆä»»åŠ¡Aåœ¨åˆ‡æ¢åˆ°timerè¿‡ç¨‹ä¸­ï¼Œæ˜¾ç„¶éƒ½æ˜¯ä¸éœ€è¦è¿›è¡Œæ ˆäº¤æ¢çš„ã€‚å¯ä»¥ä½¿ç”¨traceTASK_SWITCHED_IN()ä½œä¸ºå†…å­˜äº¤æ¢ç‚¹ã€‚\n\n3.SWAPå­˜å‚¨ä½œä¸ºæ ˆçš„äº¤æ¢å­˜å‚¨ç©ºé—´ï¼Œè¯»å†™é€Ÿåº¦æ˜¯éå¸¸å…³é”®çš„ï¼Œå°†ä¸€æ¬¡æ ˆåˆ‡æ¢çš„æ—¶é—´æ§åˆ¶åœ¨1msä»¥å†…æ—¶éå¸¸æœ‰å¿…è¦çš„ã€‚æ‰€æœ‰å†…å­˜äº¤æ¢çš„æœºåˆ¶åº”å½“å°½é‡è®¾è®¡çš„ç®€å•å¯é ï¼Œé¿å…ä½¿ç”¨æ–‡ä»¶ç­‰å¤æ‚çš„å­˜å‚¨è¿‡ç¨‹ã€‚å­˜å‚¨ç©ºé—´çš„å¤§å°å’Œè®¿é—®æ–¹å¼ä¹Ÿå¾ˆå…³é”®ï¼Œæœ€å¥½æ˜¯å­—ç¬¦è®¾å¤‡ï¼Œå—è®¾å¤‡çš„è¯»å†™åœ¨è¿™é‡Œæ˜¯ä½æ•ˆçš„ã€‚å­˜å‚¨ç©ºé—´åº”å½“èƒ½å¤Ÿè¦†ç›–æ‰€æœ‰å…±äº«çš„å†…å­˜æ•°æ®ä»¥åŠç®¡ç†è¿™äº›æ•°æ®çš„é¢å¤–æ•°æ®å¼€é”€ã€‚\n\n\næ–¹æ¡ˆæµ‹è¯•æˆ‘é€‰æ‹©äº†STM32L051C8T6å•ç‰‡æœº(8kå­—èŠ‚SRAM)é…åˆAPS6404Lç‰‡å¤–çš„PSRAMè¿›è¡Œæµ‹è¯•ï¼ŒPSRAMä½¿ç”¨16Mhzçš„SPIæ€»çº¿è¿æ¥ã€‚åˆ›å»ºäº†Timerä»»åŠ¡ã€IDLEä»»åŠ¡å’Œä¸€ä¸ªæ™®é€šçš„ç”¨æˆ·ä»»åŠ¡ï¼Œè¿™ä¸‰ä¸ªä»»åŠ¡ä½¿ç”¨äº†ç‹¬ç«‹çš„æ ˆç©ºé—´åˆ†é…ï¼Œåˆ†åˆ«ä¸º512ã€512ã€1024å­—èŠ‚ã€‚æ­¤å¤–è¿˜åˆ†é…äº†3ä¸ªæ ˆç©ºé—´å…±äº«çš„ä»»åŠ¡ï¼Œæ ˆç©ºé—´å¤§å°å‡ä¸º1024å­—èŠ‚ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ä»»åŠ¡è¿è¡Œèµ·æ¥åFreeRTOSçš„heapå‰©ä½™ç©ºé—´ä»ç„¶è¶…è¿‡äº†1kã€‚é¢å¤–åˆ›å»ºä¸€ä¸ªæ ˆç©ºé—´å…±äº«çš„ä»»åŠ¡å¼€é”€çº¦100å­—èŠ‚å·¦å³ã€‚\nç¼ºé™·\næ— æ³•åœ¨æ ˆå…±äº«ä»»åŠ¡ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„æ ˆå…±äº«ä»»åŠ¡ï¼Œè¿™ä¸ªåœ¨å®ç°è¦ç‚¹1ä¸Šå·²ç»è§£é‡Šäº†ã€‚\nä»»åŠ¡æ ˆå†…çš„å±€éƒ¨å˜é‡æ•°æ®æ— æ³•ä¼ é€’åˆ°æ ˆå¤–ï¼Œè¿™æ˜¯ç‰¹åˆ«å…³é”®çš„ã€‚é€šå¸¸æ ˆå†…çš„æ•°æ®é€šè¿‡é‚®ç®±ç­‰ä¼ é€’åˆ°å…¶å®ƒçº¿ç¨‹åï¼Œé€šè¿‡é˜»å¡çš„æ–¹å¼ç­‰å¾…å“åº”ï¼Œæ‰€ä»¥è¯¥æ ˆå†…çš„å±€éƒ¨å˜é‡æ•°æ®ä¼ é€’åˆ°å…¶å®ƒçº¿ç¨‹åä¾ç„¶æœ‰æ•ˆã€‚ä½†æ˜¯å¯¹äºæ ˆå…±äº«çš„ä»»åŠ¡æ¥è¯´æ˜¯æ— æ³•å®ç°çš„ã€‚\næ ˆå…±äº«çš„ä»»åŠ¡å®æ—¶æ€§æ— æ³•å¾—åˆ°ä¿éšœï¼Œå› ä¸ºå®ƒåœ¨çº¿ç¨‹å”¤é†’æ—¶éœ€è¦è¿›è¡Œæ ˆç©ºé—´çš„æ¢å¤æ“ä½œï¼Œä»»åŠ¡å“åº”æ—¶é—´è‚¯å®šæ¯”æ ˆç‹¬ç«‹çš„ä»»åŠ¡è¦é•¿ã€‚æ‰€æœ‰å¯¹äºéœ€è¦å¿«é€Ÿå“åº”çš„ä»»åŠ¡ä»»ç„¶å¯ä»¥ä½¿ç”¨ä¸€èˆ¬çš„ä»»åŠ¡åˆ›å»ºæ–¹å¼åˆ›å»ºä»»åŠ¡ï¼Œå› ä¸ºä»æ ˆå…±äº«ä»»åŠ¡åˆ‡æ¢åˆ°ä¸€èˆ¬ä»»åŠ¡æ˜¯ä¸éœ€è¦è§¦å‘SWAPæœºåˆ¶çš„ã€‚\n\n"},{"title":"FreeRTOSä¸­åç¨‹æ”¯æŒä½åŠŸè€—å—","url":"/2022/09/06/FreeRTOS%E4%B8%AD%E5%8D%8F%E7%A8%8B%E6%94%AF%E6%8C%81%E4%BD%8E%E5%8A%9F%E8%80%97%E5%90%97/","content":"FreeRTOSåç¨‹FreeRTOSé™¤äº†æ”¯æŒå¤šçº¿ç¨‹å¤–ï¼Œè¿˜æ”¯æŒå¦å¤–ä¸€ç§å¤šä»»åŠ¡æœºåˆ¶-åç¨‹(coroutine)ã€‚å®ƒå’Œçº¿ç¨‹ä¸ä¸€æ ·ï¼Œæ¯ä¸ªåç¨‹ä¸éœ€è¦ç‹¬ç«‹çš„è¿è¡Œç©ºé—´ï¼Œå®ƒä¾é ç¼–ç¨‹è¯­æ³•æŠ€å·§åœ¨é€»è¾‘ä¸Šå®ç°äº†å¤šä»»åŠ¡çš„æœºåˆ¶ã€‚å®ƒé¿å…çš„ä¸€èˆ¬RTOSå¸¦æ¥çš„æ ˆåˆ‡æ¢å¼€é”€ï¼Œä»…ä»…ä¾é æå°çš„å¼€é”€å°±èƒ½ä¿å­˜ä»»åŠ¡çš„ä¸­é—´çŠ¶æ€å¹¶åœ¨é€‚å½“çš„æ—¶åˆ»å¿«é€Ÿæ¢å¤ä»»åŠ¡ã€‚ç®€å•æ¥è¯´å°±æ˜¯ä»»åŠ¡éœ€è¦åˆ‡æ¢æ—¶å…ˆè®°å½•å½“å‰æ‰§è¡Œçš„ä½ç½®å¹¶è¿”å›ï¼Œé‡æ–°è¿›å…¥è¯¥ä»»åŠ¡æ—¶æ ¹æ®ä¿å­˜çš„ä½ç½®æ¢å¤ä»»åŠ¡æ‰§è¡Œï¼Œæ‰€ä»¥å®ƒä¸æ”¯æŒä»»åŠ¡é—´æŠ¢å ï¼Œæ‰€ä»¥ä»»åŠ¡çš„å®æ—¶æ€§ä¹Ÿæ¯”è¾ƒæœ‰é™ï¼Œä½†æ˜¯å®ƒå¤šä»»åŠ¡æ—¶çš„ä½å¼€é”€ç‰¹æ€§åœ¨è®¸å¤šåœºæ™¯ä¸‹å…·æœ‰æ¯”è¾ƒæ˜æ˜¾çš„ä¼˜åŠ¿ã€‚\nFreeRTOSä½¿ç”¨Cè¯­è¨€æä¾›çš„switch-caseè¯­æ³•ä½œä¸ºå®ç°åç¨‹çš„å…³é”®ï¼Œswitch-caseèƒ½å¤Ÿè¿›è¡Œéå¸¸çµæ´»çš„è·³è½¬ï¼Œè¿™ä¸ªçœŸçš„è¶…ä¹ä¸€èˆ¬äººå¯¹switchç”¨æ³•çš„ç†è§£(ç‚¹åè¾¾å¤«è®¾å¤‡)ã€‚æ­¤å¤–ç”±äºå¤šä¸ªåç¨‹ä»»åŠ¡å…±äº«åŒä¸€ä¸ªæ ˆç©ºé—´ï¼Œæ‰€ä»¥åç¨‹ä¸­æ— æ³•ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒé•¿çš„å±€éƒ¨å˜é‡ï¼Œå³å®šä¹‰çš„å±€éƒ¨å˜é‡åœ¨ä½¿ç”¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…ä¸èƒ½è¿›è¡Œåç¨‹çš„ä»»åŠ¡è°ƒåº¦ï¼Œä¸€æ—¦å‘ç”Ÿä»»åŠ¡è°ƒåº¦ï¼Œåˆ™å±€éƒ¨å˜é‡çš„æ•°æ®å°±æœ‰å¯èƒ½ä¸¢å¤±ï¼Œæ‰€ä»¥åœ¨è®¾è®¡åç¨‹æ—¶é€šå¸¸ä½¿ç”¨å…¨å±€å˜é‡æ¥é¿å…ä½¿ç”¨æ ˆç©ºé—´å†…çš„å±€éƒ¨å˜é‡æ•°æ®ã€‚\nåœ¨è®¾è®¡åç¨‹ä»»åŠ¡æ—¶éœ€è¦æ ¹æ®ä¸€å®šçš„ä»£ç æ¨¡æ¿æ¥è®¾è®¡ï¼Œå› ä¸ºåç¨‹çš„æ ¸å¿ƒæ˜¯ç”±è¯­æ³•æ¥å®ç°çš„ï¼Œæ‰€ä»¥ä»£ç æ— æ³•è®¾è®¡çš„è¶³å¤Ÿçš„çµæ´»ï¼Œå­˜åœ¨è®¸å¤šçš„è®¾è®¡å’Œç”¨æ³•é™åˆ¶ã€‚\nä½åŠŸè€—ç‰¹æ€§åç¨‹æ„å‘³ç€ä»»åŠ¡è¿‡ç¨‹ç®€å•ï¼Œåœ¨ç°å®åº”ç”¨åœºæ™¯ä¸‹ï¼Œç®€å•ä»»åŠ¡å’Œä½åŠŸè€—ç‰¹æ€§é€šå¸¸ä¸€èµ·å‡ºç°ï¼Œé‚£ä½¿ç”¨FreeRTOSçš„åç¨‹æ”¯æŒä½åŠŸè€—å—ï¼Ÿæ ¹æ®FreeRTOSçš„å‚è€ƒæ–‡æ¡£æ¥çœ‹ï¼Œå®˜æ–¹å¹¶æ²¡æœ‰æåŠåç¨‹+ä½åŠŸè€—çš„ç”¨æ³•ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªç‰¹æ€§æ­£å¥½æ˜¯FreeRTOSéƒ½æ”¯æŒçš„ï¼Œè¿™ä¸¤ä¸ªç‰¹æ€§èƒ½å¤Ÿç‹¬ç«‹æ­£å¸¸å·¥ä½œã€‚é‚£åˆå¹¶åˆ°ä¸€èµ·å‘¢ï¼Ÿ\nå†²çªå®˜æ–¹æ¨èçš„åç¨‹è°ƒåº¦æ–¹æ¡ˆæ˜¯è¿™æ ·çš„ï¼š\nvoid vApplicationIdleHook( void )&#123;    for( ;; )    &#123;        vCoRoutineSchedule();    &#125;&#125;\nä½¿ç”¨IDLEä»»åŠ¡çš„hookæ¥è¿›è¡Œåç¨‹çš„è°ƒåº¦ã€‚é‚£è¿›ä¸€æ­¥çœ‹çœ‹è¯¥hookåœ¨Idleä»»åŠ¡ä¸­çš„æ‰§è¡Œä½ç½®ï¼š\n// ...#if ( configUSE_IDLE_HOOK == 1 )&#123;    extern void vApplicationIdleHook( void );    /* Call the user defined function from within the idle task.  This     * allows the application designer to add background functionality     * without the overhead of a separate task.     * NOTE: vApplicationIdleHook() MUST NOT, UNDER ANY CIRCUMSTANCES,     * CALL A FUNCTION THAT MIGHT BLOCK. */    vApplicationIdleHook();&#125;#endif /* configUSE_IDLE_HOOK *//* This conditional compilation should use inequality to 0, not equality * to 1.  This is to ensure portSUPPRESS_TICKS_AND_SLEEP() is called when * user defined low power mode  implementations require * configUSE_TICKLESS_IDLE to be set to a value other than 1. */#if ( configUSE_TICKLESS_IDLE != 0 )&#123;    TickType_t xExpectedIdleTime;    /* It is not desirable to suspend then resume the scheduler on     * each iteration of the idle task.  Therefore, a preliminary     * test of the expected idle time is performed without the     * scheduler suspended.  The result here is not necessarily     * valid. */    xExpectedIdleTime = prvGetExpectedIdleTime();    // ...&#125;#endif /* configUSE_TICKLESS_IDLE */\nåˆ°è¿™é‡Œåº”è¯¥å‘ç°é—®é¢˜äº†å§ã€‚vApplicationIdleHookæ¯”TICKLESSå¤„ç†è¦å…ˆæ‰§è¡Œï¼Œè€Œåç¨‹çš„è°ƒåº¦å®ç°æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œè¿™æ„å‘³ç€idleä»»åŠ¡æ²¡æœ‰æ—¶æœºæ¥è¿›è¡ŒTICKLESSå¤„ç†ï¼Œå¯¼è‡´ç³»ç»Ÿæ— æ³•è¿›å…¥ä½åŠŸè€—çŠ¶æ€ã€‚\nè¿™é‡Œè§£é‡Šä¸€ä¸‹vCoRoutineSchedule()ä¸ºä»€ä¹ˆéœ€è¦æ”¾åˆ°ä¸€ä¸ªæ— é™å¾ªç¯ä¸­ï¼Œè¿™æ˜¯è¯¥åç¨‹æ¡†æ¶å†³å®šçš„ï¼Œè¯¥è°ƒåº¦å‡½æ•°éœ€è¦ä¸€ç›´æ‰§è¡Œï¼Œè¯¥å‡½æ•°å¹¶ä¸è¿”å›ä¸€äº›è°ƒåº¦çŠ¶æ€ï¼Œå¯¼è‡´æˆ‘ä»¬æ— æ³•å†³å®šåç¨‹è°ƒåº¦çš„æ—¶æœºï¼Œä¸ºäº†åç¨‹çš„æ­£å¸¸è¿è¡Œï¼Œæ‰€ä»¥åç¨‹å°±å¿…é¡»è¦ä¸€ç›´è¿›è¡Œè°ƒåº¦ã€‚è€Œæœ€ç»ˆçš„ç»“æœå°±æ˜¯ä½¿ç”¨åç¨‹åï¼ŒFreeRTOSçš„ä½åŠŸè€—ç‰¹æ€§å°±å¤±æ•ˆäº†ã€‚\næ›™å…‰åˆ†æåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæˆ‘çªç„¶æœ‰ä¸€ä¸ªç–‘æƒ‘ï¼ŒFreeRTOSå·²ç»è®¾è®¡äº†éå¸¸å®Œå–„çš„é…ç½®æœºåˆ¶ï¼Œä¸ºä»€ä¹ˆå®ƒæ²¡æœ‰è€ƒè™‘åˆ°è¿™ä¸¤ä¸ªåŠŸèƒ½çš„ç”¨æ³•å†²çªï¼Œè¿›è€Œåœ¨é…ç½®ä¸Šè¿›è¡Œå¤„ç†å‘¢ã€‚æ¯”å¦‚è¯´å¼€å¯åç¨‹åå°±ç¦æ­¢ä½¿ç”¨ä½åŠŸè€—ç‰¹æ€§ã€‚è¿™æ˜¯ä¸æ˜¯æ„å‘³ç€æœ‰ä»€ä¹ˆæ–¹æ³•èƒ½å¤Ÿçªç ´è¿™ä¸ªé™åˆ¶ï¼Œæ‰€ä»¥å®˜æ–¹æ•…æ„åœ¨é…ç½®ä¸Šç•™ä¸‹äº†åŒæ—¶å¯ç”¨ä¸¤ç§åŠŸèƒ½çš„å¯èƒ½æ€§ã€‚\næˆ‘é‡æ–°å¼€å§‹æ¢³ç†äº†FreeRTOSçš„åç¨‹å’Œä½åŠŸè€—å®ç°æ–¹æ¡ˆï¼Œå‘ç°ç°æœ‰çš„è®¾è®¡æ˜¯æ— æ³•å®ç°çš„ã€‚å°†åç¨‹è°ƒåº¦æ”¾å…¥åˆ°å•ç‹¬çš„çº¿ç¨‹ä¸­æ˜¯æœ€æ¥è¿‘çš„ä¸€ä¸ªå®ç°æ–¹æ¡ˆï¼š\nvoid CoRoutineTask(void *p)&#123;    for(;;)&#123;        vCoRoutineSchedule();        // vTaskDelay(?);    &#125;&#125;\nè¯¥ä»»åŠ¡çš„ä¼˜å…ˆçº§å¦‚ä½•ç¡®å®šå‘¢ï¼Ÿåç¨‹ä¸­çš„å»¶æ—¶æ˜¯å¦éœ€è¦ï¼Ÿå»¶æ—¶å¤šé•¿ï¼Ÿåªè¦ä¼˜å…ˆçº§æ¯”idleä»»åŠ¡é«˜ä¸”å­˜åœ¨ä»»æ„æ—¶é—´çš„å»¶æ—¶ï¼Œä½åŠŸè€—çš„ticklesså°±å¯æ‰§è¡Œã€‚ä½†æ˜¯éš¾ç‚¹æ˜¯æ— æ³•ç¡®å®šå»¶æ—¶æ—¶é—´ã€‚\nåç¨‹æ²¡æœ‰å®ç°è®¡ç®—ä¸‹ä¸€æ¬¡åç¨‹è°ƒåº¦çš„æ—¶æœºå‡½æ•°ã€‚å¯¹äºä»»åŠ¡æ¥è¯´ï¼ŒprvGetExpectedIdleTime()å‡½æ•°èƒ½å¤Ÿè®¡ç®—å‡ºä¸‹ä¸€æ¬¡è¿›è¡Œä»»åŠ¡è°ƒåº¦çš„æœŸæœ›æ—¶é—´ã€‚æ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦ä¸€ä¸ªè¿™æ ·çš„å‡½æ•°ï¼Œè®¡ç®—ä¸‹ä¸€æ¬¡è¿›è¡Œåç¨‹è°ƒåº¦çš„æœŸæœ›æ—¶é—´ã€‚å®ç°äº†è¿™ä¸ªå‡½æ•°å°†æ˜¯åœ¨åç¨‹ä¸‹å®ç°ä½åŠŸè€—çš„å¸Œæœ›ã€‚\nä¸‹ä¸€æ¬¡åç¨‹è°ƒåº¦åˆ°åº•éœ€è¦å¤šé•¿æ—¶é—´æ£€ç´¢è¿™äº›æ•°æ®å°±èƒ½çŸ¥é“ç­”æ¡ˆï¼š\n\n1.ç­‰å¾…ä»»åŠ¡åˆ—è¡¨(pxDelayedCoRoutineList)\n2.å°±ç»ªä»»åŠ¡åˆ—è¡¨(pxReadyCoRoutineLists)\n3.å³å°†å°±ç»ªä»»åŠ¡åˆ—è¡¨(xPendingReadyCoRoutineList)\n\næœ€åä¸€ä¸ªæ˜¯å¾ˆå®¹æ˜“å¿½è§†çš„ï¼Œåœ¨è¿›è¡Œåç¨‹é—´é€šä¿¡æ—¶ï¼Œä»»åŠ¡å¹¶ä¸æ˜¯ç›´æ¥åˆ‡æ¢åˆ°å°±ç»ªä»»åŠ¡åˆ—è¡¨ä¸­ï¼Œè€Œæ˜¯æ·»åŠ åˆ°äº†å¾…å°±ç»ªä»»åŠ¡åˆ—è¡¨(è¿™æ˜¯ä¸ºäº†ä¿è¯å°±ç»ªä»»åŠ¡åˆ—è¡¨ä¸åœ¨ä¸­æ–­ä¸­è¿›è¡Œä¿®æ”¹)ã€‚æ‰€ä»¥åœ¨æ£€ç´¢ä»»åŠ¡æ—¶è¯¥åˆ—è¡¨ä¸­çš„ä»»åŠ¡å¯ä»¥çœ‹ä½œæ—¶ä»»åŠ¡å·²ç»å°±ç»ªäº†ã€‚\nå½“å°±ç»ªä»»åŠ¡åˆ—è¡¨éç©ºæˆ–è€…å³å°†å°±ç»ªä»»åŠ¡åˆ—è¡¨éç©ºæ„å‘³ç€åç¨‹éœ€è¦ç«‹å³è°ƒåº¦ã€‚å½“ç­‰å¾…ä»»åŠ¡åˆ—è¡¨ä¸­çš„ä»»åŠ¡å·²ç»è¶…æ—¶äº†ä¹Ÿè¦ç«‹å³è°ƒåº¦ã€‚å¦åˆ™å°±æ ¹æ®ç­‰å¾…ä»»åŠ¡åˆ—è¡¨ä¸­ç­‰å¾…æ—¶é—´æœ€å°‘çš„ä»»åŠ¡æ¥è®¡ç®—ä¸‹ä¸€æ¬¡åç¨‹è°ƒåº¦çš„æ—¶é—´ã€‚æ­¤å¤–ï¼Œè¿˜éœ€è¦æ³¨æ„æ‰€æœ‰åˆ—è¡¨ä¸ºç©ºçš„æƒ…å†µï¼Œè¿™å¯ä»¥è®¤ä¸ºä¸‹ä¸€æ¬¡è°ƒåº¦çš„æ—¶é—´ä¸ºæ— é™é•¿ã€‚\nTickType_t xGetExpectedIdleTime( void )&#123;    CRCB_t * pxCRCB;    UBaseType_t uxPriority;    TickType_t xIdleTime;    if( listLIST_IS_EMPTY( &amp;xPendingReadyCoRoutineList ) == pdFALSE )    &#123;        xIdleTime = 0u;    &#125;    else    &#123;        xIdleTime = portMAX_DELAY;        for( uxPriority = 0; uxPriority &lt; configMAX_CO_ROUTINE_PRIORITIES; uxPriority++ )        &#123;            if( listLIST_IS_EMPTY( &amp;( pxReadyCoRoutineLists[ uxPriority ] ) ) == pdFALSE )            &#123;                xIdleTime = 0u;                break;            &#125;        &#125;        if(xIdleTime &gt; 0u)        &#123;            if( listLIST_IS_EMPTY( pxDelayedCoRoutineList ) == pdFALSE )            &#123;                pxCRCB = ( CRCB_t * ) listGET_OWNER_OF_HEAD_ENTRY( pxDelayedCoRoutineList );                if(xCoRoutineTickCount &lt; listGET_LIST_ITEM_VALUE( &amp;( pxCRCB-&gt;xGenericListItem )))                &#123;                    xIdleTime = listGET_LIST_ITEM_VALUE( &amp;( pxCRCB-&gt;xGenericListItem )) - xCoRoutineTickCount;                &#125;                else                &#123;                    xIdleTime = 0u;                &#125;            &#125;            else            &#123;                mtCOVERAGE_TEST_MARKER();            &#125;        &#125;    &#125;    return xIdleTime;&#125;\n\nåœ¨ä»£ç é£æ ¼ä¸Šå‚è€ƒäº†FreeRTOSç›¸ç±»ä¼¼çš„ä»£ç é£æ ¼ã€‚è¿™é‡Œæ£€æŸ¥äº†æ‰€æœ‰ä¼˜å…ˆçº§çš„å°±ç»ªä»»åŠ¡åˆ—è¡¨(ä»é«˜ä¼˜å…ˆçº§åˆ°ä½ä¼˜å…ˆçº§åº”è¯¥ä¼šæ›´å¿«)ï¼Œå¯ä»¥è€ƒè™‘ä»…ä»…æ£€æŸ¥uxTopCoRoutineReadyPriorityä¼˜å…ˆçº§çš„åˆ—è¡¨ï¼Œè¿™æ ·åœ¨ä¼˜å…ˆçº§è¾ƒå¤šçš„æ—¶å€™å¯ä»¥æ‰§è¡Œçš„æ›´å¿«ã€‚\nåç¨‹è¿è¡Œåœ¨å¯ä¼‘çœ çš„çº¿ç¨‹ä¸­èƒ½å¤Ÿè®¡ç®—åç¨‹çš„è°ƒåº¦æ—¶æœºåï¼Œæˆ‘ä»¬å°±èƒ½å°†åç¨‹æ”¾å…¥åˆ°ä¸€ä¸ªå¯ä¼‘çœ çš„çº¿ç¨‹ä¸­ï¼Œè€Œä¸æ˜¯åœ¨é˜»å¡çš„æ— é™å¾ªç¯ä¸­æ‰§è¡Œã€‚\nvoid vCoScheduleTask( void )&#123;    // ...    for( ;; )    &#123;        vCoRoutineSchedule();        uint32_t idle_time = xGetExpectedIdleTime();        if(idle_time &gt; 0)        &#123;            vTaskDelay(idle_time);        &#125;    &#125;&#125;\nè¯¥çº¿ç¨‹çš„ä¼˜å…ˆçº§æ¯”Idleçº¿ç¨‹ç•¥é«˜ã€‚è¿™æ ·åœ¨ä¿è¯æ­£å¸¸çš„åç¨‹è°ƒåº¦çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¹Ÿèƒ½å¤Ÿæ­£å¸¸çš„è¿è¡Œidleçº¿ç¨‹ï¼Œä¿è¯ticklessä¸­çš„prvGetExpectedIdleTime()å‡½æ•°èƒ½å¤Ÿè®¡ç®—å‡ºåˆç†çš„ç³»ç»Ÿçº¿ç¨‹è°ƒåº¦ä¼‘çœ æ—¶é—´ï¼Œè¿›è€Œå®ç°äº†åç¨‹å’Œä½åŠŸè€—ç‰¹æ€§çš„å…±å­˜ã€‚\næœ€åxGetExpectedIdleTime()å‡½æ•°éœ€è¦ç›´æ¥å®ç°åœ¨croutine.cå’Œ.hæ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥ä¼šå¯¹FreeRTOSä»£ç æºæ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œä½†æ˜¯è¿™æ²¡æœ‰å¯¹ç°å­˜çš„ä»£ç è¿›è¡Œè¿›è¡Œé€»è¾‘ä¸Šçš„æ›´æ”¹ï¼Œæ‰€ä»¥è¿™æ ·çš„ä¿®æ”¹æ˜¯å¯æ§çš„ã€‚\nä¸Šé¢è¿˜æœ‰ä¸€ç‚¹æœªæåŠï¼Œå¦‚æœåœ¨ä¸­æ–­ä¸­åŒåç¨‹è¿›è¡Œé€šä¿¡ï¼Œåç¨‹è¿˜èƒ½å¤Ÿå“åº”å—ï¼Ÿéœ€è¦å¦‚ä½•ä¿®æ”¹æ‰èƒ½å®ç°åœ¨ä¸­æ–­ä¸­åŒåç¨‹é€šä¿¡ä¸”ä¸å½±å“ç°æœ‰çš„ä½åŠŸè€—ç‰¹æ€§ï¼Ÿå…¶å®åªéœ€è¦åšç®€å•çš„ä¿®æ”¹å³å¯ï¼Œæ¬¢è¿è®¨è®ºã€‚\n"},{"title":"FreeRTOSå†…æ ¸çª¥æ¢","url":"/2024/01/06/FreeRTOS%E5%86%85%E6%A0%B8%E7%AA%A5%E6%8E%A2/","content":"\nåœ¨å¤šä»»åŠ¡ç¯å¢ƒä¸‹è°ƒè¯•ä»£ç éœ€è¦ä¸€å®šçš„ä»£ç è°ƒè¯•ç»éªŒï¼Œå°¤å…¶æ˜¯æ¶‰åŠåˆ°å¼‚æ­¥çš„ä»»åŠ¡æµç¨‹æ—¶ï¼Œå•æ­¥æ‰§è¡Œå¯èƒ½æ— æ³•è·Ÿè¸ªåˆ°éœ€è¦çš„æ‰§è¡Œæµç¨‹ã€‚å¦‚æœä»£ç å…¨é€Ÿè¿è¡Œæ—¶è™½ç„¶å¯ä»¥é€šè¿‡æ—¥å¿—æ¥æ¢³ç†æ‰§è¡Œæµç¨‹ï¼Œä½†æ˜¯æ¶‰åŠåˆ°FreeRTOSå†…æ ¸ä¸­çš„å†…å®¹æ—¶ï¼Œä¸€èˆ¬çš„æ—¥å¿—æ˜¾å¾—æ¯”è¾ƒé¸¡è‚‹äº†ã€‚æ¯”å¦‚è¯´æˆ‘æƒ³æ£€æŸ¥æŸä¸ªæ—¶åˆ»æ‰€æœ‰ä»»åŠ¡çš„è¿è¡ŒçŠ¶æ€ï¼ŒåŒ…æ‹¬ä»»åŠ¡æ˜¯è¿è¡Œè¿˜æ˜¯é˜»å¡ã€é˜»å¡çš„å»¶æ—¶æœ‰å¤šä¹…ã€é˜»å¡åœ¨æŸä¸ªä¿¡å·é‡ä¸Šç­‰ç­‰ï¼Œæˆ–è€…æ›´è¿›ä¸€æ­¥æ£€æŸ¥ä»»åŠ¡çš„è°ƒç”¨æ ˆç­‰ç­‰ã€‚å¦‚æœèƒ½å¤Ÿå®ç°è¿™äº›åŠŸèƒ½æ¥çª¥è§†FreeRTOSçš„è¿è¡Œè¿‡ç¨‹ï¼Œè¿™æ˜¾ç„¶èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æ›´åŠ æ¸…æ™°çš„äº†è§£ä»£ç çš„è¿è¡Œè¿‡ç¨‹ï¼Œæ–¹ä¾¿è§£å†³ä¸€äº›æ£˜æ‰‹çš„é—®é¢˜ã€‚\n\nè·å–å½“å‰ç³»ç»Ÿæ‰€æœ‰ä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯FreeRTOSæä¾›äº†uxTaskGetSystemState()æ–¹æ³•ï¼Œå¯ä»¥è·å–æ‰€æœ‰ä»»åŠ¡çš„ä¸€äº›ç®€å•ä¿¡æ¯ï¼Œä¸»è¦åŒ…æ‹¬ä»»åŠ¡çš„TCBå¥æŸ„ã€ä»»åŠ¡åç§°ã€è¿è¡ŒçŠ¶æ€ã€ä¼˜å…ˆçº§ã€æ ˆèµ·å§‹åœ°å€å·²ç»æ ˆç©ºé—´çš„æœ€å¤§ä½¿ç”¨é‡ã€‚è¿™äº›ä¿¡æ¯æ˜¯FreeRTOSç›´æ¥æš´éœ²å‡ºæ¥çš„ä¿¡æ¯ï¼Œä½†æ˜¯è¿™äº›ä¿¡æ¯å¹¶ä¸èƒ½å¤Ÿæ–¹ä¾¿æˆ‘ä»¬äº†è§£ä»»åŠ¡çš„è¿è¡Œè¿‡ç¨‹ï¼Œå°¤å…¶æ˜¯ä»»åŠ¡çš„ç»†èŠ‚çŠ¶æ€ã€‚\næˆ‘ä»¬æƒ³è¦è·å–çš„å…³é”®è¯¦ç»†ä¿¡æ¯åŒ…æ‹¬ä»»åŠ¡å½“å‰çš„SPæŒ‡é’ˆï¼Œå³å®æ—¶çš„æ ˆåœ°å€ã€‚è¿˜éœ€è¦è·å–ä»»åŠ¡çš„é˜»å¡æ—¶é•¿ï¼Œä¸»è¦æ˜¯å¯¹äºå¤„äºé˜»å¡çŠ¶æ€çš„ä»»åŠ¡æ¥è¯´çš„ã€‚æœ€å…³é”®çš„æ˜¯éœ€è¦è·å–ä»»åŠ¡é˜»å¡çš„äº‹ä»¶æ˜¯ä»€ä¹ˆï¼Œä¸€èˆ¬åœ¨RTOSä¸­ä¼šä½¿ç”¨å¾ˆå¤šçš„ä¿¡å·é‡ã€é‚®ç®±ç­‰åŒæ­¥æœºåˆ¶ï¼Œå¦‚æœç³»ç»Ÿå‡æ­»åèƒ½å¤Ÿçœ‹åˆ°æ¯ä¸ªä»»åŠ¡çš„é˜»å¡æƒ…å†µï¼Œé‚£ä¹ˆå¯ä»¥æœ€å¤§ç¨‹åº¦çš„æ–¹ä¾¿æˆ‘ä»¬å®šä½æ•…éšœç‚¹ã€‚\néå¸¸é—æ†¾çš„æ˜¯ä»¥ä¸Šè¿™äº›ä¿¡æ¯éƒ½ä¸èƒ½æ˜¾å¼çš„ä»æŸä¸ªå†…æ ¸æ¥å£ä¸­è·å–ï¼ŒåŒæ—¶FreeRTOSæ‰§è¡Œéå¸¸ä¸¥æ ¼æ•°æ®éšè—ç­–ç•¥ï¼Œå¤–éƒ¨çš„åº”ç”¨ä»£ç æ˜¯æ— æ³•ç›´æ¥è®¿é—®FreeRTOSå†…æ ¸çš„æ•°æ®ä»¥åŠæ•°æ®ç»“æ„ã€‚ä½†æ˜¯FreeRTOSä¸ºå¼€å‘äººå‘˜é¢„ç•™äº†ä¸€ç»„è™šæ‹Ÿæ•°æ®ç»“æ„çš„å®šä¹‰ï¼Œè¯¥è™šæ‹Ÿæ•°æ®ç»“æ„çš„å½¢å¼åŒFreeRTOSä¸­å®é™…çš„æ•°æ®ç»“æ„æ˜¯ä¸€è‡´çš„ï¼ŒFreeRTOSçš„åˆè¡·æ˜¯é€šè¿‡è¿™äº›è™šæ‹Ÿç»“æ„æ¥è®¡ç®—å†…æ ¸æ•°æ®ç»“æ„çš„å¤§å°ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œé€šè¿‡è¿™äº›æ•°æ®ç»“æ„çš„ç´¢å¼•å°±èƒ½å¤Ÿçªç ´å†…æ ¸çš„æ•°æ®éšè—ç­–ç•¥æ¥é—´æ¥è®¿é—®å†…æ ¸æ•°æ®ã€‚\nè™šæ‹Ÿæ•°æ®ç»“æ„çš„å®šä¹‰éƒ½æ˜¯å½¢å¦‚â€œstruct xSTATIC_xxxâ€çš„å®šä¹‰ï¼Œéƒ½ä½äºFeeRTOS.hæ–‡ä»¶ä¸­ã€‚è·å–ä»»åŠ¡çš„SPæŒ‡é’ˆç°åœ¨å°±å¾ˆå®¹æ˜“äº†ï¼ŒSPæŒ‡é’ˆçš„å€¼ä½äºTCBæ•°æ®ç»“æ„çš„ç¬¬ä¸€é¡¹ï¼Œè™½ç„¶ä¸èƒ½ç›´æ¥ä½¿ç”¨TCBçš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯struct xSTATIC_TCBçš„ç»“æ„åŒå®ƒæ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è®¿é—®ä»»åŠ¡SPæŒ‡é’ˆçš„æ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š\nvoid * pvGetTaskMSP(TaskHandle_t xTask)&#123;    return ((StaticTask_t*)(xTask))-&gt;pxDummy1;&#125;\n\nä»»åŠ¡éœ€è¦é˜»å¡å¤šé•¿çš„æ—¶é—´ï¼Ÿè¿™ä¸ªé—®é¢˜ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œé¦–å…ˆè¿™ä¸ªé—®é¢˜ä»…ä»…é’ˆå¯¹å¤„äºé˜»å¡çŠ¶æ€çš„ä»»åŠ¡ï¼Œå°¤å…¶æ˜¯æœ‰é™æ—¶é•¿é˜»å¡çŠ¶æ€çš„ä»»åŠ¡ã€‚çœ‹çœ‹vTaskDelay()ä¸­çš„å®ç°ï¼Œå½“ä¸€ä¸ªä»»åŠ¡éœ€è¦é˜»å¡æ—¶ï¼Œå°±å°†å…¶æ”¾å…¥åˆ°ç­‰å¾…ä»»åŠ¡åˆ—è¡¨ä¸­ï¼Œé€šè¿‡å‡½æ•°prvAddCurrentTaskToDelayedList()å®ç°çš„ã€‚é¦–å…ˆå°†å½“å‰æ—¶åˆ»å’Œéœ€è¦å»¶æ—¶çš„æ—¶é•¿è¿›è¡Œè®¡ç®—å¾—åˆ°å”¤é†’çš„æ—¶åˆ»ï¼Œå°†è¯¥æ—¶é—´ç‚¹è®°å½•åˆ°ä»»åŠ¡çš„xStateListItemå˜é‡å†…éƒ¨ï¼ŒåŒæ—¶è¯¥å‡½æ•°å°†xStateListItemå˜é‡ä½œä¸ºä¸€ä¸ªåˆ—è¡¨é¡¹æ’å…¥åˆ°äº†pxDelayedTaskListé“¾è¡¨çš„ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰åºçš„æ’å…¥è¿‡ç¨‹ï¼Œå³æ ¹æ®ä»»åŠ¡å”¤é†’æ—¶é—´åœ¨é“¾è¡¨ä¸Šè¿›è¡Œæ’åºï¼Œåˆ°è¿™é‡Œéƒ½æ¯”è¾ƒå¥½ç†è§£ã€‚é€šè¿‡ä»»åŠ¡TCBçš„xStateListItemå°±èƒ½å¤Ÿå¾—åˆ°ä»»åŠ¡å»¶æ—¶çš„æ—¶é—´ã€‚ä½†æ˜¯è¿™é‡Œæœ€å…³é”®çš„ä¸€ç‚¹æ¥äº†ï¼Œå¦‚æœä»»åŠ¡æ—¶æ— é™æ—¶é•¿é˜»å¡å‘¢ï¼Ÿè¿™ç§æƒ…å†µæ˜¯å°†å˜å¾—æ¯”è¾ƒéº»çƒ¦ï¼Œå†…æ ¸çš„å®ç°æ˜¯å°†å…¶æ”¾å…¥åˆ°äº†æŒ‚èµ·ä»»åŠ¡åˆ—è¡¨(xSuspendedTaskList)ä¸­äº†ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è®¿é—®åˆ°xSuspendedTaskListï¼Œæ€ä¹ˆç¡®å®šä»»åŠ¡æ˜¯å¦å¤„äºæ— é™é˜»å¡çŠ¶æ€å‘¢ï¼Ÿ\nåˆ°è¿™é‡Œæˆ‘ç¡®å®æ²¡æœ‰æ¯”è¾ƒå¥½çš„åŠæ³•ï¼Œæˆ‘é€‰æ‹©ç›´æ¥ä¿®æ”¹å†…æ ¸ä»£ç ï¼Œå°†å¤„äºæŒ‚èµ·ä»»åŠ¡çš„xStateListItemå€¼è®¾ä¸ºæœ€å¤§å€¼ä»¥æ ‡è®°è¯¥ä»»åŠ¡æ²¡æœ‰æ˜ç¡®çš„å”¤é†’æ—¶é—´ï¼Œè¿™é‡Œéœ€è¦æ€è€ƒæœ‰æ²¡æœ‰æ›´ç®€å•çš„æ–¹æ³•ã€‚\nif( ( xTicksToWait == portMAX_DELAY ) &amp;&amp; ( xCanBlockIndefinitely != pdFALSE ) )&#123;    /* Add the task to the suspended task list instead of a delayed task     * list to ensure it is not woken by a timing event.  It will block     * indefinitely. */    listINSERT_END( &amp;xSuspendedTaskList, &amp;( pxCurrentTCB-&gt;xStateListItem ) );    listSET_LIST_ITEM_VALUE( &amp;( pxCurrentTCB-&gt;xStateListItem ), 0xffffffff );&#125;\n\nä»»åŠ¡ç­‰å¾…çš„äº‹ä»¶æ˜¯ä»€ä¹ˆï¼Ÿä¸æ˜¯æ‰€æœ‰åœ¨é˜»å¡çš„ä»»åŠ¡éƒ½åœ¨ç­‰å¾…äº‹ä»¶ï¼Œå¦‚æœä»»åŠ¡åªæ˜¯ä¸€èˆ¬çš„å»¶æ—¶ï¼Œè¿™å°±è¡¨æ˜ä»»åŠ¡æ²¡æœ‰ç­‰å¾…ä»»ä½•äº‹ä»¶ã€‚ä»»åŠ¡çš„äº‹ä»¶æœºåˆ¶æ˜¯ä¾é TCBä¸­xEventListItemæ¥å®ç°çš„ï¼Œæ¯”å¦‚è¯´ç­‰ä¸€ä¸ªä»»åŠ¡ç­‰å¾…ä¸€ä¸ªé˜Ÿåˆ—(queue)ï¼Œä»»åŠ¡å°±å°†è¯¥TCBä¸­çš„xEventListItemåŠ å…¥åˆ°è¯¥é˜Ÿåˆ—å†…éƒ¨ç›¸å…³çš„ä¸€ä¸ªé“¾è¡¨ä¸Šã€‚FreeRTOSä¸­çš„é˜Ÿåˆ—(queue)ç”¨æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—ã€é‚®ç®±ã€ä¿¡å·é‡ç­‰ï¼Œqueueå†…éƒ¨æœ‰ä¸¤ä¸ªé“¾è¡¨ï¼Œä¸€ä¸ªç­‰å¾…æ¥æ”¶é“¾è¡¨ã€ä¸€ä¸ªç­‰å¾…å‘é€é“¾è¡¨ï¼Œè¿™æ˜¯FreeRTOSå†…æ ¸å…è®¸å‘é€æ•°æ®é˜»å¡å¯¼è‡´çš„ï¼Œæ‰€ä»¥é˜Ÿåˆ—å†…éƒ¨éœ€è¦ä¸¤ä¸ªé“¾è¡¨æ¥ç»´æŠ¤ä»»åŠ¡çš„é˜»å¡å…³ç³»ï¼Œä½†å®é™…ä¸Šè¿™ä¸¤ä¸ªé˜Ÿåˆ—å¤§å¤šæ•°æƒ…å†µæ˜¯ä»…ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªã€‚\né€šè¿‡xEventListItemä¸­çš„pxContainerå¯ä»¥åå‘å®šä½åˆ°ä»»åŠ¡æ‰€å…³è”çš„é“¾è¡¨ï¼Œä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œqueueä¸Šæœ‰ä¸¤ä¸ªé“¾è¡¨ï¼Œæˆ‘ä»¬æ€ä¹ˆç¡®å®šä»»åŠ¡æ‰€å±çš„é“¾è¡¨åˆ°åº•æ˜¯å“ªä¸€ä¸ªå‘¢ï¼Ÿå› ä¸ºä¸èƒ½ç¡®å®šçš„è¯å°±ä¸èƒ½åå‘ç´¢å¼•åˆ°queueçš„æŒ‡é’ˆï¼Œå¦‚æœå‡è®¾ä»»åŠ¡æ‰€è¿°é“¾è¡¨æ˜¯queueå†…çš„ç¬¬ä¸€ä¸ªé“¾è¡¨ï¼Œé€šè¿‡containerofæ–¹æ³•å°±èƒ½å¤Ÿå®šä½åˆ°queueçš„åœ°å€ï¼Œä½†ä¸‡ä¸€æ˜¯å¦ä¸€ä¸ªé“¾è¡¨å‘¢ï¼Ÿ\né˜Ÿåˆ—ä¸­é¢„ç•™äº†ä¸€ä¸ªæœ‰æ„æ€çš„æˆå‘˜uxQueueNumberï¼Œå®ƒå¹¶æ²¡æœ‰å®é™…çš„åŠŸèƒ½ï¼Œä½†é€šè¿‡å®ƒæˆ‘ä»¬å°±èƒ½å¤Ÿå°†é˜Ÿåˆ—æ‰“ä¸Šç‰¹æ®Šæ ‡è®°ï¼Œè¿›è€Œæ£€ç´¢å‡ºé˜Ÿåˆ—çš„åœ°å€ï¼Œæ‰¾åˆ°äº†ä»»åŠ¡ç­‰å¾…çš„é˜Ÿåˆ—åœ°å€ï¼Œè¿™æ ·å°±ç¡®å®šäº†ä»»åŠ¡åˆ°è¾¾åœ¨ç­‰å¾…ä»€ä¹ˆäº‹ä»¶äº†ã€‚\n#define QUEUE_TRACK_FLAG (0xab123456)void vQueueFlagSet(void* queue)&#123;    vQueueSetQueueNumber((QueueHandle_t)queue, QUEUE_TRACK_FLAG);&#125;void *pvGetTaskEvent(TaskHandle_t xTask, int *type)&#123;    List_t * const pxList = ((StaticTask_t*)(xTask))-&gt;xDummy3[1].pvDummy3[3];    if(pxList == NULL)&#123;        *type = 0;  // no event        return NULL;    &#125;    StaticQueue_t *queue = containerof(pxList, StaticQueue_t, xDummy3[0]);    if(uxQueueGetQueueNumber((QueueHandle_t)queue) == QUEUE_TRACK_FLAG)&#123;        *type = 1;        return queue; // wait tx    &#125;    queue = containerof(pxList, StaticQueue_t, xDummy3[1]);    if(uxQueueGetQueueNumber((QueueHandle_t)queue) == QUEUE_TRACK_FLAG)&#123;        *type = 2;        return queue; // wait rx    &#125;    *type = 3; // unknow    return NULL;&#125;\nvQueueFlagSet()æ–¹æ³•éœ€è¦ä½¿ç”¨queueçš„åˆ›å»ºHOOKè¿›è¡Œè°ƒç”¨ï¼Œè¿™æ ·å†…æ ¸ä¸Šåˆ›å»ºçš„æ‰€æœ‰queueéƒ½å°†è¢«æ‰“ä¸Šç‰¹æ®Šæ ‡è®°ä»¥æ–¹ä¾¿æˆ‘ä»¬è·Ÿè¸ªã€‚\nåˆ†æé˜Ÿåˆ—äº‹ä»¶ä¸Šé¢å¾—åˆ°çš„ä»…ä»…æ˜¯é˜Ÿåˆ—çš„åœ°å€ï¼Œé˜Ÿåˆ—çš„è¯¦ç»†ä¿¡æ¯å…¶å®ä¹Ÿèƒ½å¤Ÿè·å–åˆ°ï¼ŒåŒ…æ‹¬è¯¥é˜Ÿåˆ—çš„ç±»å‹(ä¸€èˆ¬é˜Ÿåˆ—ã€äº’æ–¥é‡ã€è®¡æ•°ä¿¡å·é‡ã€äºŒè¿›åˆ¶ä¿¡å·é‡)ã€ç­‰å¾…è¯¥é˜Ÿåˆ—äº‹ä»¶çš„å…¶å®ƒæ‰€ä»¥ä»»åŠ¡åˆ—è¡¨ä»¥åŠè¯¥é˜Ÿåˆ—å†…éƒ¨æ•°æ®é‡ã€æ•°æ®å°ºå¯¸çš„ä¿¡æ¯ç­‰å¾…ã€‚æ–¹æ³•ä»»ç„¶æ˜¯é€šè¿‡å†…æ ¸ä¸Šçš„è™šæ‹Ÿæ•°æ®ç»“æ„æ¥é—´æ¥è®¿é—®ã€‚\nåˆ©ç”¨SPæŒ‡é’ˆå›æº¯è°ƒç”¨æ ˆæœ€å‰é¢æˆ‘ä»¬è·å–åˆ°äº†ä»»åŠ¡çš„SPåœ°å€ï¼Œè¿™æ˜¯ä»»åŠ¡åœ¨ä¸¢å¤±CPUæ‰§è¡Œæƒé™åç”±å†…æ ¸ä»»åŠ¡è°ƒåº¦å™¨æ›´æ–°çš„æœ€æ–°çš„SPåœ°å€ï¼Œæ‰€ä»¥å®ƒä¸æ˜¯ç®€å•çš„SPæŒ‡é’ˆï¼Œå› ä¸ºæ ˆå†…è¿˜æœ‰ä»»åŠ¡è°ƒåº¦æ—¶ä¿å­˜çš„æ•°æ®ã€‚\nåˆ†æè°ƒç”¨æ ˆé™¤äº†éœ€è¦å®é™…çš„spæŒ‡é’ˆå¤–ï¼Œè¿˜éœ€è¦æœ€è¿‘ä¸€æ¬¡çš„PCæŒ‡é’ˆã€LRæŒ‡é’ˆã€‚å†…æ ¸è°ƒåº¦å™¨åœ¨æœ€åæ—¶åˆ»å°†R4-R11å¯„å­˜å™¨ã€R14å¯„å­˜å™¨å­˜å…¥äº†æ ˆå†…ï¼Œå¦‚æœè¿˜æœ‰æµ®ç‚¹æ•°ï¼Œè¿™è¿˜ä¿å­˜äº†S16-S31è¿™16ä¸ªæµ®ç‚¹æ•°å¯„å­˜å™¨ã€‚\nç®€å•æ¥è¯´ï¼Œå¯ä»¥ç®€åŒ–ä¸ºä¸¤ä¸ªç»“æ„ä½“\ntypedef struct&#123;    uint32_t r4[8];    uint32_t r14;    uint32_t s16[16];    uint32_t r0[4];    uint32_t r12;    uint32_t lr;    uint32_t pc;    uint32_t xPSR;    uint32_t s0[16];    uint32_t fpscr;&#125; rtos_cm7_msp_fp_t;typedef struct&#123;    uint32_t r4[8];    uint32_t r14;    uint32_t r0[4];    uint32_t r12;    uint32_t lr;    uint32_t pc;    uint32_t xPSR;&#125; rtos_cm7_msp_t;\n\nå¦‚æœå­˜åœ¨æµ®ç‚¹æ•°åˆ™ä½¿ç”¨rtos_cm7_msp_fp_tï¼Œå¦‚æœä¸å­˜åœ¨æµ®ç‚¹æ•°åˆ™ä½¿ç”¨rtos_cm7_msp_tï¼Œæ˜¯å¦ä½¿ç”¨æµ®ç‚¹æ•°å¯ä»¥ä½¿ç”¨r14è¿›è¡Œåˆ¤æ–­ï¼Œè¿™é‡Œçš„r14å°±æ˜¯FreeRTOSè¿›è¡Œåˆ°ä»»åŠ¡è°ƒåº¦æ—¶çš„å¼‚å¸¸ä¸­æ–­ä¸­çš„LRå¯„å­˜å™¨ã€‚æœ‰äº†è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œå†é…åˆæ ˆåˆ†ææœºåˆ¶å°±èƒ½å¤Ÿéå¸¸æ–¹ä¾¿çš„å¾—åˆ°ä»»åŠ¡çš„è°ƒç”¨æ ˆäº†ã€‚\næ€»ç»“é€šè¿‡ä»¥ä¸Šçš„æ–¹æ³•ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿéå¸¸æ–¹ä¾¿çš„åˆ†æå‡ºFreeRTOSè¿è¡Œæ—¶çš„ç»†èŠ‚ä¿¡æ¯äº†ï¼Œé…åˆæ—¥å¿—ç³»ç»Ÿæˆ–è€…shellåŠŸèƒ½åœ¨é€‚å½“çš„æ—¶å€™æ£€ç´¢å‡ºè¿™äº›ä¿¡æ¯å¯¹åˆ†æå®æ—¶è¿è¡Œè¿‡ç¨‹æ¯”è¾ƒæ–¹ä¾¿ã€‚æ­¤å¤–ï¼ŒUCOSIIç­‰æ“ä½œç³»ç»Ÿä¹Ÿèƒ½å®ç°ç±»ä¼¼çš„æ“ä½œã€‚\n"},{"title":"Macro returning the number of arguments it is given in C?","url":"/2022/11/12/Macro%20returning%20the%20number%20of%20arguments%20it%20is%20given%20in%20C/","content":"ä¸€ä¸ªç®€å•çš„å®ç°èƒ½å¦ä½¿ç”¨ä¸€ä¸ªç®€å•çš„å®åœ¨Cè¯­è¨€ä¸­è®¡ç®—ä¸å®šå‚æ•°çš„æ•°é‡ï¼Œä¾‹å¦‚è¿™æ ·:\nfoo(1) -&gt; 1foo(cat, dog) -&gt; 2foo(red, green, blue) -&gt; 3\nä¸€ä¸ªæ¯”è¾ƒç®€å•çš„å®ç°æ˜¯è¿™æ ·çš„ï¼š\n#define PP_NARG(...) (sizeof((const void*[])&#123;__VA_ARGS__&#125;)/sizeof(void*))\nå½“å‚æ•°ä¸ºç©ºæ—¶å¯èƒ½åœ¨æŸäº›ç¼–è¯‘å™¨ä¸‹ä¸èƒ½æ­£å¸¸çš„å·¥ä½œï¼Œä½†æ˜¯ç¨å¾®ä¿®æ”¹ä¸€ä¸‹å°±è¡Œäº†ã€‚\n#define PP_NARG(...) (sizeof((int[])&#123;0, ##__VA_ARGS__&#125;)/sizeof(int) - 1)#pragma GCC diagnostic ignored &quot;-Wint-conversion&quot; /* Ignore warning */\n\nè¿™é‡Œä½¿ç”¨äº†sizeof()å…³é”®å­—ï¼Œå°±æ„å‘³ç€å®ƒä¸æ˜¯åœ¨é¢„å¤„ç†é˜¶æ®µè®¡ç®—ä¸å®šå‚æ•°çš„é•¿åº¦ã€‚åŒæ—¶è¦æ±‚å‚æ•°å¿…é¡»ä¸ºæœ‰æ„ä¹‰çš„ç¬¦å·ã€‚è¿™å°±é™åˆ¶äº†å®ƒçš„ä½¿ç”¨åœºæ™¯ï¼Œæ¯”å¦‚è¯´å°†ä¸å®šå‚æ•°çš„ä¸ªæ•°ä½œä¸ºæ•°ç»„å®šä¹‰æ—¶çš„é•¿åº¦ã€‚\nå¦å¤–ä¸€ç§æœ‰è¶£çš„å†™æ³•è¿™æ˜¯æˆ‘ä»ç½‘ä¸Šæ‰¾åˆ°çš„ä¸€ç§å†™æ³•ï¼Œå®ƒèƒ½å¤Ÿå¤„ç†1~64ä¸ªä¸å®šäº§ç”Ÿçš„æƒ…å†µï¼Œæ²¡æœ‰ä¾èµ–äºç¼–è¯‘å™¨çš„å…³é”®å­—ï¼Œä»…ä»…é é¢„å¤„ç†å°±å®Œæˆäº†å‚æ•°çš„è®¡æ•°ã€‚\n#ifndef JLSS_ID_NARG_H#define JLSS_ID_NARG_H/*** http://groups.google.com/group/comp.std.c/browse_thread/thread/77ee8c8f92e4a3fb/346fc464319b1ee5?pli=1****    Newsgroups: comp.std.c**    From: Laurent Deniau &lt;laurent.deniau@cern.ch&gt;**    Date: Mon, 16 Jan 2006 18:43:40 +0100**    Subject: __VA_NARG__****    A year ago, I was asking here for an equivalent of __VA_NARG__ which**    would return the number of arguments contained in __VA_ARGS__ before its**    expansion. In fact my problem at that time (detecting for a third**    argument) was solved by the solution of P. Mensonides. But I was still**    thinking that the standard should have provided such a facilities rather**    easy to compute for cpp.****    This morning I had to face again the same problem, that is knowing the**    number of arguments contained in __VA_ARGS__ before its expansion (after**    its expansion can always be achieved if you can do it before). I found a**    simple non-iterative solution which may be of interest here as an answer**    to who will ask in the future for a kind of __VA_NARG__ in the standard**    and I post it for archiving. May be some more elegant-efficient solution**    exists?****    Returns NARG, the number of arguments contained in __VA_ARGS__ before**    expansion as far as NARG is &gt;0 and &lt;64 (cpp limits):****    #define PP_NARG( ...) PP_NARG_(__VA_ARGS__,PP_RSEQ_N())**    #define PP_NARG_(...) PP_ARG_N(__VA_ARGS__)**    #define PP_ARG_N(_1,_2,_3,_4,_5,_6,_7,_8,_9,[..],_61,_62,_63,N,...) N**    #define PP_RSEQ_N() 63,62,61,60,[..],9,8,7,6,5,4,3,2,1,0****    [..] stands for the continuation of the sequence omitted here for**    lisibility.****    PP_NARG(A) -&gt; 1**    PP_NARG(A,B) -&gt; 2**    PP_NARG(A,B,C) -&gt; 3**    PP_NARG(A,B,C,D) -&gt; 4**    PP_NARG(A,B,C,D,E) -&gt; 5**    PP_NARG(A1,A2,[..],A62,A63) -&gt; 63**** ======****    Newsgroups: comp.std.c**    From: Roland Illig &lt;roland.il...@gmx.de&gt;**    Date: Fri, 20 Jan 2006 12:58:41 +0100**    Subject: Re: __VA_NARG__****    Laurent Deniau wrote:**    &gt; This morning I had to face again the same problem, that is knowing the**    &gt; number of arguments contained in __VA_ARGS__ before its expansion (after**    &gt; its expansion can always be achieved if you can do it before). I found a**    &gt; simple non-iterative solution which may be of interest here as an answer**    &gt; to who will ask in the future for a kind of __VA_NARG__ in the standard**    &gt; and I post it for archiving. May be some more elegant-efficient solution**    &gt; exists?****    Thanks for this idea. I really like it.****    For those that only want to copy and paste it, here is the expanded version:**** // Some test cases** PP_NARG(A) -&gt; 1** PP_NARG(A,B) -&gt; 2** PP_NARG(A,B,C) -&gt; 3** PP_NARG(A,B,C,D) -&gt; 4** PP_NARG(A,B,C,D,E) -&gt; 5** PP_NARG(1,2,3,4,5,6,7,8,9,0,    //  1..10**         1,2,3,4,5,6,7,8,9,0,    // 11..20**         1,2,3,4,5,6,7,8,9,0,    // 21..30**         1,2,3,4,5,6,7,8,9,0,    // 31..40**         1,2,3,4,5,6,7,8,9,0,    // 41..50**         1,2,3,4,5,6,7,8,9,0,    // 51..60**         1,2,3) -&gt; 63****Note: using PP_NARG() without arguments would violate 6.10.3p4 of ISO C99.*//* The PP_NARG macro returns the number of arguments that have been** passed to it.*/#define PP_NARG(...) \\    PP_NARG_(__VA_ARGS__,PP_RSEQ_N())#define PP_NARG_(...) \\    PP_ARG_N(__VA_ARGS__)#define PP_ARG_N( \\     _1, _2, _3, _4, _5, _6, _7, _8, _9,_10, \\    _11,_12,_13,_14,_15,_16,_17,_18,_19,_20, \\    _21,_22,_23,_24,_25,_26,_27,_28,_29,_30, \\    _31,_32,_33,_34,_35,_36,_37,_38,_39,_40, \\    _41,_42,_43,_44,_45,_46,_47,_48,_49,_50, \\    _51,_52,_53,_54,_55,_56,_57,_58,_59,_60, \\    _61,_62,_63,  N, ...) N#define PP_RSEQ_N() \\    63,62,61,60,                   \\    59,58,57,56,55,54,53,52,51,50, \\    49,48,47,46,45,44,43,42,41,40, \\    39,38,37,36,35,34,33,32,31,30, \\    29,28,27,26,25,24,23,22,21,20, \\    19,18,17,16,15,14,13,12,11,10, \\     9, 8, 7, 6, 5, 4, 3, 2, 1, 0#endif /* JLSS_ID_NARG_H */\næ³¨é‡Šä¸­ä¹Ÿæåˆ°ï¼Œå½“å‚æ•°ä¸ºç©ºæ—¶éœ€è¦ç¼–è¯‘å™¨çš„ç‰¹æ®Šæ”¯æŒã€‚ä½†æ˜¯æˆ‘å‘ç°åšé€‚å½“çš„ä¿®æ”¹å°±èƒ½å¤Ÿé¿å…è¿™ç§å°´å°¬çš„å±€é¢ã€‚\n#define PP_NARG(...)   (PP_NARG_(0, ##__VA_ARGS__, PP_RSEQ_N()) - 1)\nåªè¦å‚æ•°ä¸è¶…è¿‡64ä¸ªï¼Œå®ƒéƒ½èƒ½å¾ˆå¥½çš„å·¥ä½œï¼Œè€Œä¸”åœ¨é¢„å¤„ç†é˜¶æ®µå°±èƒ½è®¡ç®—å‡ºå‚æ•°çš„ä¸ªæ•°ã€‚\næ€»ç»“æˆ‘å‚è€ƒäº†å¤§é‡å…¶ä»–äººçš„å†™æ³•ï¼Œå…¶ä¸­çš„åŸºæœ¬åŸç†å¤§éƒ½æ˜¯åŸºäºè¿™ä¸¤ç§æ€æƒ³ã€‚åœ¨C++ä¸­æˆ‘è¿˜çœ‹åˆ°å…¶å®ƒçš„è§£æ³•ï¼Œä½†æ˜¯æˆ‘ç›®å‰è¿˜æ²¡æœ‰æƒ³åˆ°åœ¨C++ä¸­éœ€è¦ç»Ÿè®¡ä¸å®šå‚æ•°ä¸ªæ•°çš„åœ°æ–¹ã€‚\n#include &lt;tuple&gt;#define MACRO(...) \\    std::cout &lt;&lt;&quot;num args:&quot; \\    &lt;&lt; std::tuple_size&lt;decltype(std::make_tuple(__VA_ARGS__))&gt;::value \\    &lt;&lt; std::endl;/* Another way */#define VA_COUNT(...) detail::va_count(__VA_ARGS__)namespace detail&#123;    template&lt;typename ...Args&gt;    constexpr std::size_t va_count(Args&amp;&amp;...) &#123; return sizeof...(Args); &#125;&#125;\n\nåº”ç”¨èƒ½å¤Ÿè®¡ç®—ä¸å®šå‚æ•°ä¸ªæ•°å¯¹äºå®ç°å‡½æ•°é™æ€ä¼˜åŒ–æœ‰ä¸€å®šæ„ä¹‰ï¼Œåœ¨ä»£ç ä¸­åˆ¤æ–­å‚æ•°ä¸ªæ•°è°ƒç”¨ä¸åŒçš„å‡½æ•°å®ç°ï¼Œç›¸å½“äºå®ç°äº†å‡½æ•°å¤šæ€çš„ä¸€ç§ç‰¹æ€§ã€‚\n"},{"title":"Black Magic Debugä¸CMSIS-DAPåˆä½“","url":"/2024/10/15/Black%20Magic%20Debug%E4%B8%8ECMSIS-DAP%E5%90%88%E4%BD%93/","content":"ç§»æ¤Black Magic Probeå›ºä»¶è™½ç„¶BMPå®˜æ–¹å·²ç»æ”¯æŒäº†è®¸å¤šçš„èŠ¯ç‰‡ï¼Œä½†æ˜¯æˆ‘å†³å®šåšä¸€äº›ä¸ä¸€æ ·çš„å°è¯•ï¼Œæˆ‘æœ€å¼€å§‹å°†Black Magic Probeçš„ä»£ç ç§»æ¤åˆ°äº†STM32H750èŠ¯ç‰‡å¹³å°ä¸Šï¼Œå¸Œæœ›å®ƒè¾ƒé«˜çš„ä¸»é¢‘å¯ä»¥å®ç°æ›´å¿«çš„è°ƒè¯•é€Ÿåº¦ã€‚ä½†å®é™…æµ‹è¯•ä¸‹æ¥å‘ç°æˆ–è®¸æ˜¯å› ä¸ºç›¸åŒçš„USB2.0FSï¼Œæ€§èƒ½å¹¶ä¸æ¯”STM32F411å¹³å°æœ‰ç‰¹åˆ«æ˜æ˜¾çš„ä¼˜åŠ¿ã€‚åæ¥åˆå°†å…¶ç§»æ¤åˆ°CH32V307å¹³å°ä¸Šï¼Œè¯¥èŠ¯ç‰‡æ‹¥æœ‰USB2.0HSæ¥å£ï¼Œä¼ è¾“é€Ÿåº¦å°†ä¸æ˜¯å®ƒçš„æ€§èƒ½ç“¶é¢ˆï¼Œä½†æ˜¯è¯¥èŠ¯ç‰‡çš„ä¸»é¢‘ä¸F411ç±»ä¼¼ï¼Œç»¼åˆæƒè¡¡åï¼Œæˆ‘å†³å®šé‡‡ç”¨CH32V307èŠ¯ç‰‡é‡æ–°è®¾è®¡ä¸€ç‰ˆBlack Magic Probeã€‚ä½†æ˜¯æ­£å½“æˆ‘æŠŠç¡¬ä»¶åŸç†å›¾è®¾è®¡å®Œæˆåï¼Œæˆ‘çªç„¶æƒ³åˆ°ä¸€ä¸ªæ›´åˆé€‚çš„é€‰æ‹©ï¼Œé‚£å°±æ˜¯RP2040èŠ¯ç‰‡ã€‚\nä¸ºä»€ä¹ˆé€‰æ‹©RP2040èŠ¯ç‰‡é€‰æ‹©å®ƒçš„ä¸»è¦åŸå› æ˜¯å®ƒçš„PIOæ¨¡å—å¯ä»¥å®ç°è¾ƒé«˜æ•ˆç‡çš„SWDæ—¶åºï¼Œå¯ä»¥ä¸å¿…ä¾èµ–ä¸å¤„ç†å™¨å»æ¨¡æ‹ŸSWDæ—¶åºã€‚å¯¹äºSWDä¿¡å·çš„å‡†ç¡®æ€§å’Œç¨³å®šæ€§éƒ½æ˜¯éå¸¸å…³é”®çš„ï¼Œæ‰€ä»¥é€‰æ‹©RP2040å°±æ¯”è¾ƒåˆé€‚ã€‚æˆ‘æœ¬æ¥å·²ç»å®Œæˆäº†SWDæ—¶åºçš„PIOä»£ç ä»¥åŠå’ŒBlack Magic Probeçš„é€‚é…å·¥ä½œï¼Œä½†æ˜¯æˆ‘å‘ç°æ ‘è“æ´¾å®˜æ–¹æ¨å‡ºäº†åŸºäºrp2040èŠ¯ç‰‡çš„CMSIS-DAPè°ƒè¯•å™¨ï¼Œå…¶ä¸­ä½¿ç”¨PIOå®Œæˆçš„SWDæ—¶åºä¹Ÿæ¯”è¾ƒç¬¦åˆæˆ‘çš„é¢„æœŸã€‚æ‰€ä»¥æˆ‘å†³å®šå°†Black Magic Probeå›ºä»¶ä»£ç ç§»æ¤åˆ°rp2040èŠ¯ç‰‡ä¸Šï¼Œå¹¶ä¿ç•™CMSIS-DAPè°ƒè¯•å™¨çš„æ”¯æŒ,ä½¿å¾—ä¸€ä¸ªç¡¬ä»¶æ‹¥æœ‰ä¸¤ç§è°ƒè¯•èƒ½åŠ›ã€‚\nè®¾è®¡ç¡¬ä»¶æœ€å¼€å§‹æ‰“ç®—ä½¿ç”¨æ ‘è“æ´¾å®˜æ–¹çš„Debug Probeç¡¬ä»¶ï¼Œä½†æ˜¯60å¤šå…ƒçš„å”®ä»·å°†æˆ‘åŠé€€ã€‚è€Œä¸”ä¸ºäº†æ»¡è¶³Black Magic Probeçš„ä¸€äº›ç‰¹æ®ŠåŠŸèƒ½ï¼ŒDebug Probeç¡¬ä»¶å¹¶ä¸æ˜¯æœ€ç†æƒ³çš„ç¡¬ä»¶ã€‚æ‰€ä»¥æˆ‘å†³å®šè‡ªè¡Œè®¾è®¡ä¸€ä¸ªç¡¬ä»¶ã€‚ä¸»è¦æ˜¯å¢åŠ 3.3Vç”µæºè¾“å‡ºç®¡ç†å’Œç”µæºç›‘æµ‹åŠŸèƒ½ï¼Œéœ€è¦æ·»åŠ ADCç”µè·¯å’ŒåŠŸç‡å¼€å…³ç”µè·¯ã€‚\n\nä¸»è¦çš„å¤–å›´æ¥å£å’Œæˆ‘ä¸Šä¸€ä¸ªåˆ¶ä½œçš„Black Magic Probeä¿æŒç›¸åŒçš„æ¥å£å¸ƒå±€ã€‚åŸç†å›¾å¯å‚è€ƒæ ‘è“æ´¾çš„Debug Probeã€‚\nç¡¬ä»¶ä¸Šæ·»åŠ äº†ä¸€ä¸ªæ‹¨åŠ¨å¼€å…³ï¼Œå¯ä»¥ç”¨äºæ§åˆ¶3.3Vçš„ç”µæºçš„è¾“å‡ºï¼Œ3.3Vçš„ç”µæºè¾“å‡ºä¹Ÿå¯ä»¥ç”±BMPè½¯ä»¶æ§åˆ¶æ‰“å¼€ã€‚\nè®©æˆ‘æ„Ÿåˆ°éå¸¸æ„å¤–çš„æ˜¯RP2040çš„ADCæ€§èƒ½ä¸å¤ªç†æƒ³ï¼Œé‡‡æ ·æ—¶é—´å›ºå®šåˆ°äº†2usï¼Œæ²¡æœ‰è°ƒæ•´çš„ç©ºé—´ã€‚æ‰‹å†Œä¸Šè¯´ADCçš„è¾“å…¥é˜»æŠ—å¯è¾¾100kÎ©ï¼Œä½†å®é™…æˆ‘ä½¿ç”¨100kÎ©åŠ 47kÎ©çš„åˆ†å‹ç”µè·¯éƒ½å¯¼è‡´ADCæµ‹é‡ç»“æœä¸¥é‡åä½(åä½0.15v)ï¼Œæœ€ç»ˆæˆ‘å°†åˆ†å‹ç”µé˜»çš„å€¼ç¼©å°äº†10å€åADCçš„æµ‹é‡ç»“æœæ‰æœ‰æ‰€å¥½è½¬ã€‚å¦‚æœé‡‡æ ·æ—¶é—´å¯ä»¥ä¿®æ”¹æˆ–è®¸å¯ä»¥æé«˜é‡‡æ ·ç²¾åº¦ã€‚\né™¤PCBæˆæœ¬å¤–ï¼Œå…ƒå™¨ä»¶çš„æˆæœ¬çº¦20å…ƒã€‚\nä»£ç å®Œæ•´çš„ä»£ç å·²ç»æ”¾åˆ°githubã€‚\nä»£ç é‡‡ç”¨rp2040èŠ¯ç‰‡æœ€æ–°çš„2.0ç‰ˆSDKï¼Œæ„å»ºå·¥å…·ä¾èµ–çš„picotoolså·²ç»ç”Ÿæˆäº†ä¸€ä¸ªWindowsçš„æœ¬åœ°ç‰ˆæœ¬ã€‚å¦‚æœä½ åœ¨Windowsä¸‹è¿›è¡Œrp2040èŠ¯ç‰‡è½¯ä»¶å¼€å‘ï¼Œè¿™ä¸ªäºŒè¿›åˆ¶ç‰ˆæœ¬çš„picotoolså°†å¯¹ä½ æœ‰ä¸€å®šå¸®åŠ©ã€‚æ„å»ºè¿™ä¸ªWinç‰ˆæœ¬çš„picotoolsæœ‰è®¸å¤šæ›²æŠ˜çš„ç»å†ï¼Œä¸è¿‡æœ€åè¿˜æ˜¯å¼„å¥½äº†ï¼Œä¸ç„¶çš„è¯åªèƒ½è½¬å‘Linuxå¼€å‘äº†ã€‚\nä»£ç åœ¨æ ‘è“æ´¾debugprobeå›ºä»¶çš„åŸºç¡€ä¸Šç§»æ¤äº†æ¯”è¾ƒå®Œæ•´çš„Black Magic Probeå›ºä»¶(é™¤äº†BMP-bootloader)ã€‚JTAGè°ƒè¯•æ¥å£ç”±äºåŸç‰ˆæ ‘è“æ´¾æ²¡æœ‰æ”¯æŒï¼Œæ‰€ä»¥BMPä¸Šçš„JTAG adapterè¿˜æœªå®Œæˆã€‚\nè¯¥ç‰ˆæœ¬çš„BMPç›¸æ¯”äºå…¶å®ƒç‰ˆæœ¬æœ‰ä¸€äº›ä¼˜ç‚¹ï¼Œå‡†ç¡®ä¸”é«˜æ•ˆçš„SWDæ—¶åºæ¨¡æ‹Ÿï¼Œæ—¶é’Ÿé¢‘ç‡ç†è®ºå¯è¾¾30MHzï¼Œæ—¶åºç”±PIOé©±åŠ¨ï¼Œæ—¶é’Ÿç²¾åº¦æ¯”è¾ƒé«˜ã€‚ç›¸æ¯”äºé‡‡ç”¨å¤„ç†å™¨æ¨¡æ‹ŸSWDæ—¶åºï¼Œå®ƒçš„æ—¶é’Ÿç¨³å®šæ€§æ›´ä½³ã€‚ä½¿ç”¨é€»è¾‘åˆ†æä»ªæµ‹é‡æ³¢å½¢ï¼š\n\nä»å›¾ä¸­å¯ä»¥çœ‹åˆ°CLKæ—¶åºè¿˜ç®—æ¯”è¾ƒè§„æ•´ã€‚ç”±äºåœ¨åº•å±‚è®¾è®¡ä¸­PIOéœ€è¦å’Œå¤„ç†å™¨åšåŒæ­¥äº¤äº’ï¼Œä½¿å¾—åœ¨SWDæ—¶åºä¸­CMD-ACK-DATAä¹‹é—´å­˜åœ¨ä¸å¯é¿å…çš„æ—¶åºç©ºé—²æ—¶é—´ã€‚\nä¸‹é¢çœ‹çœ‹STM32F411ä½¿ç”¨æŒ‡ä»¤æ¨¡æ‹ŸSWDæ—¶åºçš„æ³¢å½¢ï¼š\n\nå¯ä»¥çœ‹å‡ºCLKçš„å ç©ºæ¯”ä¸ç¨³å®šï¼Œè¿™ç§ç°è±¡ç§°ä¸ºæ—¶é’ŸæŠ–åŠ¨(Jitter)ï¼Œå®ƒä¸»è¦å½±å“ä¿¡å·çš„é‡‡æ ·è¿‡ç¨‹ï¼Œè¿‡å¤§çš„æŠ–åŠ¨å¯èƒ½å¯¼è‡´ä¼ è¾“è¯¯ç ã€‚\nè¯¥ç‰ˆæœ¬ä»£ç è¿˜æœ‰ä¸€äº›å…¶å®ƒä¼˜åŒ–ï¼Œé‡æ„äº†cdc-uartçš„ä»£ç ï¼Œä¸²å£æ”¹ä¸ºDMAé©±åŠ¨ï¼Œé…åˆåº”ç”¨å±‚çš„FIFOï¼Œå®ç°äº†ä¸²å£é©±åŠ¨åˆ°USBåè®®æ ˆä¹‹é—´æ•°æ®çš„é›¶æ‹·è´ã€‚\næ­¤å¤–ï¼Œä¸ºäº†å®ç°debugprobeä»£ç å’ŒBMPçš„ä»£ç åŒæ—¶è¿è¡Œï¼Œdebugprobeä»£ç åœ¨ä¿è¯åŠŸèƒ½æ€§çš„å‰æä¸‹åšäº†ä¸€äº›ç»†èŠ‚éƒ¨åˆ†çš„è°ƒæ•´ï¼Œå…·ä½“å†…å®¹å¯ä»¥å‚è€ƒä»£ç æäº¤è®°å½•ã€‚\næˆ‘è¿˜å¯ç”¨äº†FreeRTOSçš„å¤šæ ¸ç‰¹æ€§ï¼Œä»¥å……åˆ†åˆ©ç”¨rp2040çš„2ä¸ªæ ¸å¿ƒã€‚è¿™éƒ¨åˆ†ä»£ç è¿˜æœªæäº¤ï¼Œæˆ‘è¿˜éœ€è¦è¿›ä¸€æ­¥æµ‹è¯•ã€‚\nPIOé©±åŠ¨SWDåŸç†å…ˆç»™å‡ºRaspberrypiçš„PIOä»£ç ï¼Œå¦‚æœå¯¹PIOè¿˜ä¸å¤Ÿæ·±å…¥äº†è§£å¯ä»¥çœ‹çœ‹æˆ‘ä¹‹å‰çš„æ–‡ç« ã€‚\n.program probe.side_set 1 optpublic write_cmd:public turnaround_cmd:                      ; Alias of write, used for probe_oen.pio    pullwrite_bitloop:    out pins, 1             [1]  side 0x0   ; Data is output by host on negedge    jmp x-- write_bitloop   [1]  side 0x1   ; ...and captured by target on posedge                                            ; Fall through to next command.wrap_targetpublic get_next_cmd:    pull                         side 0x0   ; SWCLK is initially low    out x, 8                                ; Get bit count    out pindirs, 1                          ; Set SWDIO direction    out pc, 5                               ; Go to command routineread_bitloop:    nop                                     ; Additional delay on taken loop branchpublic read_cmd:    in pins, 1              [1]  side 0x1   ; Data is captured by host on posedge    jmp x-- read_bitloop         side 0x0    push.wrap                                       ; Wrap to next command\n\nä»£ç éå¸¸ç®€çŸ­ï¼Œå…±11æ¡æŒ‡ä»¤ã€‚ä»£ç çš„å…¥å£åœ¨get_next_cmdï¼Œä»è¾“å…¥fifoä¸­å¾—åˆ°éœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œæ‰§è¡Œåˆ†ä¸º4ç§(è¯»ã€å†™ã€nextã€turnaround)ï¼Œè¯»å’Œå†™å°±æ˜¯æ„å»ºåŸºæœ¬çš„æ•°æ®ä¼ è¾“æ³¢å½¢ï¼Œnextç›¸å½“äºä¸€æ¡nopæŒ‡ä»¤ï¼Œä½†æ˜¯å¯ä»¥ç”¨äºç›´æ¥åˆ‡æ¢DIOçš„æ–¹å‘ï¼Œturnaroundå°†äº§ç”Ÿä¸€ä¸ªé¢å¤–çš„æ—¶é’Ÿå‘¨æœŸå¹¶åˆ‡æ¢DIOæ–¹å‘ã€‚\nå¤„ç†å™¨å°†æŒ‡ä»¤åç§»å‹å…¥fifoä¸­ï¼Œpioå°†fifoä¸­çš„æ•°æ®æ”¾å…¥åˆ°pcå¯„å­˜å™¨å®ç°æŒ‡ä»¤çš„è·³è½¬ã€‚\nPIOç»ƒä¹ åœ¨ä½¿ç”¨debugprobeçš„ä»£ç ä¹‹å‰ï¼Œæˆ‘è‡ªå·±ç»ƒä¹ å†™äº†ä¸€ä»½SWDçš„æ—¶åºä»£ç ï¼Œè¯¥ä»£ç çš„ä¼˜ç‚¹æ˜¯åœ¨æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­è‡ªåŠ¨è¿›è¡ŒDIOçš„æ–¹å‘åˆ‡æ¢ä¸éœ€è¦å•ç‹¬å ç”¨ä¸€ä¸ªfifoç©ºé—´ã€‚è¯¥ä»£ç éœ€è¦è¾ƒå¤šçš„æŒ‡ä»¤ç©ºé—´ï¼Œç”±äºç¯‡å¹…æœ‰é™ä¸”ä»£ç è´¨é‡ä¸€èˆ¬ï¼Œè¿™é‡Œä»…åˆ—å‡ºinæ—¶åºç›¸å…³å†…å®¹ã€‚\n.program swdptap_seq_in.side_set 1 opt.wrap_targetstart:    pull            ; è·å–å¾…å¤„ç†çš„æ•°æ®    out x, 1        ; æ£€æŸ¥æ˜¯å¦éœ€è¦Trnåˆ‡æ¢    jmp !x no_turnaround    set pindirs 0 side 1 [1] ; åˆ‡æ¢DIOåˆ°è¾“å…¥æ¨¡å¼no_turnaround:    out x, 5        ; è·å–è¾“å…¥æ•°æ®é•¿åº¦    out y, 1        ; æ˜¯å¦è·å–æ ¡éªŒä½    jmp loop2loop:    nop [3]loop2:    in pins, 1    side 0 [4]    jmp x-- loop  side 1    push                     ; å°†é‡‡é›†åˆ°çš„æ•°æ®å†™å…¥FIFO    jmp !y start             ; å¦‚æœy==0åˆ™ä¸æ ¡éªŒè¿”å›åˆ°èµ·å§‹ä½ç½®    nop [1]    in pins, 1    side 0 [4] ; è·å–æ ¡éªŒä¿¡æ¯    nop           side 1 [4] ; ä¸€ä¸ªTrnå‘¨æœŸ    set pindirs 1 side 0     ; åˆ‡æ¢DIOåˆ°è¾“å‡ºæ¨¡å¼    push                     ; å°†æ ¡éªŒbitå†™å…¥FIFO.wrap% c-sdk &#123;#include &quot;hardware/clocks.h&quot;#include &quot;hardware/gpio.h&quot;static inline void swdptap_seq_in_program_init(PIO pio, uint sm, uint offset, uint pin_swclk, uint pin_swdio, uint freq)&#123;    pio_gpio_init(pio, pin_swclk);    pio_gpio_init(pio, pin_swdio);    pio_sm_set_pindirs_with_mask(pio, sm, (1u &lt;&lt; pin_swclk), (1u &lt;&lt; pin_swclk));    pio_sm_set_pindirs_with_mask(pio, sm, 0, (1u &lt;&lt; pin_swdio));    pio_sm_config c = swdptap_seq_in_program_get_default_config(offset);    sm_config_set_in_pins(&amp;c, pin_swdio);    sm_config_set_sideset_pins(&amp;c, pin_swclk);    sm_config_set_set_pins(&amp;c, pin_swdio, 1);    sm_config_set_fifo_join(&amp;c, PIO_FIFO_JOIN_NONE);    float div = (float)clock_get_hz(clk_sys) / (freq * 2) / 5;    sm_config_set_clkdiv(&amp;c, div);    sm_config_set_out_shift(&amp;c, true, false, 8);    sm_config_set_in_shift(&amp;c, true, false, 32);    pio_sm_init(pio, sm, offset, &amp;c);    pio_sm_set_enabled(pio, sm, true);&#125;%&#125;\n\nuint32_t swdptap_seq_in(size_t clock_cycles)&#123;    if(clock_cycles == 0)&#123;        return 0;    &#125;    int ret;    ret = cros_sem_pend(swdptap_lock, 1000u);    if(ret)&#123;        return 0;    &#125;    uint32_t has_trn = 0;    if(dio_dir != SWDIO_STATUS_FLOAT)&#123;        dio_dir = SWDIO_STATUS_FLOAT;        has_trn = 1;    &#125;    if(seq_out_count &gt; 0)&#123;        pio_sm_get_blocking(SWD_PIO, SWD_OUT_SM);        seq_out_count--;    &#125;        pio_sm_put_blocking(SWD_PIO, SWD_IN_SM, has_trn | ((clock_cycles - 1) &lt;&lt; 1));    ret = pio_sm_get_blocking(SWD_PIO, SWD_IN_SM) &gt;&gt; (32U - clock_cycles);    cros_sem_post(swdptap_lock);    return ret;&#125;bool swdptap_seq_in_parity(uint32_t *ret, size_t clock_cycles)&#123;    if(clock_cycles == 0)&#123;        return false;    &#125;    if(cros_sem_pend(swdptap_lock, 1000u))&#123;        return false;    &#125;    uint32_t has_trn = 0;    if(dio_dir != SWDIO_STATUS_FLOAT)&#123;        dio_dir = SWDIO_STATUS_FLOAT;        has_trn = 1;    &#125;    if(seq_out_count &gt; 0)&#123;        pio_sm_get_blocking(SWD_PIO, SWD_OUT_SM);        seq_out_count--;    &#125;    pio_sm_put_blocking(SWD_PIO, SWD_IN_SM, has_trn | ((clock_cycles - 1) &lt;&lt; 1) | (1 &lt;&lt; 6));    uint32_t value = pio_sm_get_blocking(SWD_PIO, SWD_IN_SM) &gt;&gt; (32U - clock_cycles);    uint32_t parity = pio_sm_get_blocking(SWD_PIO, SWD_IN_SM) &gt;&gt; 31;    dio_dir = SWDIO_STATUS_DRIVE;    cros_sem_post(swdptap_lock);    *ret = value;    return __builtin_parity(value) == parity;&#125;\n\nè¯¥ä»£ç å®Œæˆçš„æ—¶åºæ•ˆæœå¦‚ä¸‹ï¼Œå¯ä»¥å¾—åˆ°æ›´ç´§å‡‘çš„CLKæ³¢å½¢ï¼ŒCLKç©ºé—²æ—¶é—´æ›´çŸ­ã€‚\n\nä¸€ä¸ªé¢å¤–çš„è½¯ä»¶å¾ˆå¤šäººå–œæ¬¢Jlinké™¤äº†å®ƒæ€§èƒ½å¼ºå¤§å¤–ï¼Œè¿˜å› ä¸ºå®ƒç”¨äºä¸°å¯Œçš„ä¸Šä½æœºè½¯ä»¶æ”¯æŒï¼Œæ¯”å¦‚J-Flashï¼Œå®ç°å›ºä»¶çƒ§å½•æ¯”è¾ƒæ–¹ä¾¿ã€‚å¯¹äºCMSIS-DAPæ¥è¯´ï¼Œä¸Šä½æœºè½¯ä»¶é€‰æ‹©ä¼¼ä¹ä¸å¤šï¼Œé™¤äº†IDEå†…éƒ¨é›†æˆå¤–ï¼Œåªæœ‰openocdè¿™ä¸ªé€‰æ‹©ã€‚ä½†æ˜¯openocdæ²¡æœ‰å®˜æ–¹æ”¯æŒçš„GUIç¨‹åºï¼Œä½¿ç”¨å‘½ä»¤è¡Œåœ¨ä¸€äº›æ•ˆç‡ä¸Šè¿˜æ˜¯ä¸åŠJ-Flashè¿™ç§å›¾å½¢ç•Œé¢æ¥çš„æ–¹ä¾¿ï¼Œæ¯•ç«Ÿopenocdçš„å‘½ä»¤å¤ªå¤šäº†ã€‚\næ‰€ä»¥æˆ‘å¼€å‘äº†ä¸€ä¸ªç”¨äºCMSIS-DAPçš„ä¸Šä½æœºå·¥å…·å«DFlashï¼Œæ”¯æŒå¤§éƒ¨åˆ†Cortexå•ç‰‡æœº(åº•å±‚é‡‡ç”¨openocdï¼Œæ‰€ä»¥å°±æ˜¯openocdæ”¯æŒçš„èŠ¯ç‰‡)ã€‚æ”¯æŒå›ºä»¶çš„ä¸Šä¼ å’Œä¸‹è½½ï¼Œæ”¯æŒelfã€hexã€binæ–‡ä»¶ï¼Œå¯ä»¥æ˜¾ç¤ºæ–‡ä»¶çš„äºŒè¿›åˆ¶æ•°æ®è§†å›¾ã€‚æ–‡ä»¶æ”¯æŒæ‹–æ‹½æ‰“å¼€ï¼Œå¤§éƒ¨åˆ†é€»è¾‘å’Œjflashç±»ä¼¼ã€‚æ‰“å¼€binæ–‡ä»¶æ—¶ä¼šå¼¹å‡ºå¯¹è¯æ¡†æç¤ºè¾“å…¥ä¸‹è½½åœ°å€ï¼Œhexå’Œelfæ–‡ä»¶å¯ä»¥è‡ªåŠ¨è¯†åˆ«ä¸‹è½½åœ°å€ã€‚\næ”¯æŒv1å’Œv2ç‰ˆæœ¬çš„CMSIS-DAPï¼Œå¯ä»¥æœç´¢æœ¬æœºè¿æ¥çš„å¤šä¸ªCMSIS-DAPï¼Œå¹¶é€‰æ‹©ä¸‹è½½å™¨ã€‚\n\nç›®å‰è½¯ä»¶çš„ä¸»è¦åŠŸèƒ½å·²ç»å®Œæˆï¼Œè¿˜éœ€è¦æ·»åŠ unlockç­‰chipæ“ä½œåŠŸèƒ½ã€‚æ­¤å¤–è¿˜éœ€è¦å®Œå–„ä¸‹è½½è¿›åº¦å’ŒUIä¸Šçš„ä¸€äº›è°ƒæ•´ã€‚\nåŠŸèƒ½å®Œå–„åä¼šå‘å¸ƒå¹¶å¼€æºè¯¥è½¯ä»¶ã€‚\n"},{"title":"PTåç¨‹çš„ä¸€ä¸ªå°æ‰©å±•","url":"/2023/08/28/PT%E5%8D%8F%E7%A8%8B%E7%9A%84%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%89%A9%E5%B1%95/","content":"åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ä»‹ç»äº†ä½¿ç”¨é“¾è¡¨æ¥æ›´åŠ ä¼˜é›…çš„ä½¿ç”¨PTåç¨‹ã€‚æˆ‘æœ€è¿‘å‘ç°äº†å½“åˆå®ç°çš„ä¸€ä¸ªé”™è¯¯ï¼Œç°åœ¨å·²ç»ä¿®å¤äº†ã€‚\nè¿™é‡Œä¸æ˜¯ä¸ºäº†è®¨è®ºä¹‹å‰çš„å®ç°ï¼Œè€Œæ˜¯ä»‹ç»ä¸€ä¸ªæ›´æœ‰æ„æ€çš„ä¸œè¥¿ã€‚æˆ‘åœ¨ä¹‹å‰çš„å®ç°åŸºç¡€ä¸Šï¼Œå®ç°äº†ä¸€ä¸ªæ›´åŠ ä¼˜é›…çš„å‡½æ•°æ¥åˆ©ç”¨åç¨‹ï¼Œè¿™åº”è¯¥æ˜¯ä¸€ç§å¼‚æ­¥ç¼–ç¨‹çš„æŠ€å·§ï¼Œæˆ–è€…è¯´è¿™æ˜¯Cè¯­è¨€çš„èŠ±æ´»ğŸ˜‚ã€‚\nShow code!\n/** * Declare a pt thread in a simple way. *  * Example usage: * @code&#123;c&#125; * PT_THREAD_DECL(thread1, &#123; *     while(1)&#123; *         printf(&quot;hello pt!\\r\\n&quot;); *         OS_TASK_DELAY(pt, 100); *     &#125; * &#125;); *  * // OS_TASK_RUN(thread1); * @endcode */#define PT_THREAD_DECL(name, body) \\    PT_THREAD(name(struct pt *pt))&#123;PT_BEGIN(pt);PT_YIELD(pt);body;PT_END(pt);&#125;/**  * Asynchronous execution. Only used in threads, similar to OS_TASK_DELAY() function. *  * Example usage: * @code&#123;c&#125; * PT_THREAD_DECL(invok_test, &#123; *     static int cnt; *  *     cnt = 0; *  *     PT_INVOK(&#123; *         static int i; *         for(i = 0; i &lt; 10; i++)&#123; *             printf(&quot;async invok %d\\r\\n&quot;, i); *             cnt += i; *             OS_TASK_DELAY(pt, 1000); *         &#125; *         // Automatically exit this asynchrony at end of PT_INVOK(); *     &#125;); *  *     PT_INVOK(&#123; *         while(1)&#123; *             printf(&quot;hello invok, cnt = %d\\r\\n&quot;, cnt); *             OS_TASK_DELAY(pt, 300); *         &#125; *     &#125;); * &#125;); *  * // OS_TASK_RUN(invok_test); * @endcode */#define PT_INVOK(body)                             \\    do                                             \\    &#123;                                              \\        static pt_item_t pt_invok;                 \\        static char pt_anchor;                     \\        pt_invok.task =                            \\            containerof(pt, pt_item_t, pt)-&gt;task;  \\        list_add_head(&amp;pt_pool, &amp;(pt_invok.list)); \\        pt_anchor = 0;                             \\        LC_SET(pt_invok.pt.lc);                    \\        if (pt_anchor)                             \\        &#123;                                          \\            body;                                  \\            PT_EXIT(pt);                           \\        &#125;                                          \\        pt_anchor = 1;                             \\    &#125; while (0)\n\nPT_INVOKå¯ä»¥åœ¨ä¸é˜»å¡å½“å‰å‡½æ•°æ‰§è¡Œæµç¨‹çš„æƒ…å†µä¸‹ï¼Œä»åŸåœ°å¼€è¾Ÿå‡ºä¸€ä¸ªå¹¶è¡Œçš„æ‰§è¡Œæµï¼Œæœ‰æ„æ€çš„ä¸€ç‚¹æ˜¯å¤šä¸ªINVOKæ‰§è¡Œæµä¹‹é—´æ˜¯å¯ä»¥å…±äº«ä¸Šå±‚å±€éƒ¨å˜é‡çš„ï¼Œè¿™å°±å®ç°äº†å¤šä¸ªæ‰§è¡Œæµä¹‹é—´çš„é€šä¿¡æˆ–åŒæ­¥ã€‚\nè¿™ä¸ªå®æ‰©å±•çœ‹èµ·æ¥ç›¸å½“çš„æœ‰ç”¨ï¼Œå®ƒè§£å†³äº†ç¼–ç¨‹ä¸­ä¸€ä¸ªå¸¸è§çš„é—®é¢˜ï¼Œå³åœ¨ä¸€ä¸ªä¸èƒ½è¢«é˜»å¡çš„æ‰§è¡Œæµç¨‹ä¸­æ‰§è¡Œä¸€ä¸ªè€—æ—¶çš„æ“ä½œã€‚\nPTåç¨‹çš„å®ç°æœ¬èº«å°±æ˜¯ä¸€ä¸ªå¾ˆèŠ±å“¨ä¸œè¥¿ï¼Œè¿™ä¸ªå®å®šä¹‰æˆåŠŸçš„æŠŠCè¯­è¨€çš„å®ç”¨æ³•ä¸Šå‡åˆ°äº†ä¸€ä¸ªæ–°çš„é«˜åº¦ã€‚æˆ‘æ€€ç–‘æŸäº›ç¼–è¯‘å™¨æ ¹æœ¬ä¸èƒ½å¤„ç†è¿™æ®µä»£ç ğŸ˜…ã€‚\nè¿™é‡Œéœ€è¦æ³¨æ„ï¼ŒPT_INVOKå†…çš„ä»£ç ä¸èƒ½é‡å…¥ï¼Œæˆ–è€…è¯´PT_INVOKå†…çš„ä»£ç è¿˜æœªæ‰§è¡Œå®Œæˆæ—¶ï¼Œä¸èƒ½å†æ¬¡åœ¨è¿™é‡Œæ‰§è¡ŒåŒä¸€æ®µPT_INVOKï¼Œè¿™æ˜¯ä»£ç çš„é™æ€æ€§å¯¼è‡´çš„ã€‚å¦‚æœæœ‰é‡å…¥çš„é£é™©ï¼Œå¯ä»¥åœ¨å¤–éƒ¨æ·»åŠ ä¸€äº›é‡å…¥ä¿æŠ¤çš„æœºåˆ¶ã€‚\n"},{"title":"Recommended C style and coding rules","url":"/2021/01/21/Recommended%20C%20style%20and%20coding%20rules/","content":"This document describes C code style used by Tilen MAJERLE in his projects and libraries.\nTable of Contents\nThe single most important rule\nRecommended C style and coding rules\nGeneral rules\nComments\nFunctions\nVariables\nStructures, enumerations, typedefs\nCompound statements\nSwitch statement\n\n\nMacros and preprocessor directives\nDocumentation\nHeader&#x2F;source files\nArtistic Style configuration\nEclipse formatter\n\nThe single most important ruleLetâ€™s start with the quote from GNOME developer site.\n\nThe single most important rule when writing code is this: check the surrounding code and try to imitate it.\nAs a maintainer it is dismaying to receive a patch that is obviously in a different coding style to the surrounding code. This is disrespectful, like someone tromping into a spotlessly-clean house with muddy shoes.\nSo, whatever this document recommends, if there is already written code and you are patching it, keep its current style consistent even if it is not your favorite style.\n\nGeneral rulesHere are listed most obvious and important general rules. Please check them carefully before you continue with other chapters.\n\nUse C99 standard\n\nDo not use tabs, use spaces instead\n\nUse 4 spaces per indent level\n\nUse 1 space between keyword and opening bracket\n\nDo not use space between function name and opening bracket\nint32_t a = sum(4, 3);              /* OK */int32_t a = sum (4, 3);             /* Wrong */\n\nNever use __ or _ prefix for variables&#x2F;functions&#x2F;macros&#x2F;types. This is reserved for C language itself\n\nPrefer prv_ name prefix for strictly module-private functions\n\n\nUse only lowercase characters for variables&#x2F;functions&#x2F;macros&#x2F;types with optional underscore _ char\n\nOpening curly bracket is always at the same line as keyword (for, while, do, switch, if, â€¦)\nsize_t i;for (i = 0; i &lt; 5; ++i) &#123;           /* OK */&#125;for (i = 0; i &lt; 5; ++i)&#123;            /* Wrong */&#125;for (i = 0; i &lt; 5; ++i)             /* Wrong */&#123;&#125;\n\nUse single space before and after comparison and assignment operators\nint32_t a;a = 3 + 4;              /* OK */for (a = 0; a &lt; 5; ++a) /* OK */a=3+4;                  /* Wrong */a = 3+4;                /* Wrong */for (a=0;a&lt;5;++a)       /* Wrong */\n\nUse single space after every comma\nfunc_name(5, 4);        /* OK */func_name(4,3);         /* Wrong */\n\nDo not initialize static and global variables to 0 (or NULL), let compiler do it for you\nstatic int32_t a;       /* OK */static int32_t b = 4;   /* OK */static int32_t a = 0;   /* Wrong */voidmy_func(void) &#123;    static int32_t* ptr;/* OK */    static char abc = 0;/* Wrong */&#125;\n\nDeclare all local variables of the same type in the same line\nvoidmy_func(void) &#123;    char a;             /* OK */    char a, b;          /* OK */    char b;             /* Wrong, variable with char type already exists */&#125;\n\nDeclare local variables in order\n\nCustom structures and enumerations\nInteger types, wider unsigned type first\nSingle&#x2F;Double floating pointintmy_func(void) &#123;    /* 1 */    my_struct_t my;     /* First custom structures */    my_struct_ptr_t* p; /* Pointers too */    /* 2 */    uint32_t a;    int32_t b;    uint16_t c;    int16_t g;    char h;    /* ... */    /* 3 */    double d;    float f;&#125;\n\n\nAlways declare local variables at the beginning of the block, before first executable statement\n\nDeclare counter variables in for loop\n/* OK */for (size_t i = 0; i &lt; 10; ++i)/* OK, if you need counter variable later */size_t i;for (i = 0; i &lt; 10; ++i) &#123;    if (...) &#123;        break;    &#125;&#125;if (i == 10) &#123;&#125;/* Wrong */size_t i;for (i = 0; i &lt; 10; ++i) ...\n\nAvoid variable assignment with function call in declaration, except for single variables\nvoida(void) &#123;    /* Avoid function calls when declaring variable */    int32_t a, b = sum(1, 2);    /* Use this */    int32_t a, b;    b = sum(1, 2);    /* This is ok */    uint8_t a = 3, b = 4;&#125;\n\nExcept char, float or double, always use types declared in stdint.h library, eg. uint8_t for unsigned 8-bit, etc.\n\nDo not use stdbool.h library. Use 1 or 0 for true or false respectively\n/* OK */uint8_t status;status = 0;/* Wrong */#include &lt;stdbool.h&gt;bool status = true;\n\nNever compare against true, eg. if (check_func() == 1), use if (check_func()) &#123; ... &#125;\n\nAlways compare pointers against NULL value\nvoid* ptr;/* ... *//* OK, compare against NULL */if (ptr == NULL || ptr != NULL) &#123;&#125;/* Wrong */if (ptr || !ptr) &#123;&#125;\n\nAlways use pre-increment (and decrement respectively) instead of post-increment (and decrement respectively)\nint32_t a = 0;...a++;            /* Wrong */++a;            /* OK */for (size_t j = 0; j &lt; 10; ++j) &#123;&#125;  /* OK */\n\nAlways use size_t for length or size variables\n\nAlways use const for pointer if function should not modify memory pointed to by pointer\n\nAlways use const for function parameter or variable, if it should not be modified\n/* When d could be modified, data pointed to by d could not be modified */voidmy_func(const void* d) &#123;&#125;/* When d and data pointed to by d both could not be modified */voidmy_func(const void* const d) &#123;&#125;/* Not required, it is advised */voidmy_func(const size_t len) &#123;&#125;/* When d should not be modified inside function, only data pointed to by d could be modified */voidmy_func(void* const d) &#123;&#125;\n\nWhen function may accept pointer of any type, always use void *, do not use uint8_t *\n\nFunction must take care of proper casting in implementation/* * To send data, function should not modify memory pointed to by `data` variable * thus `const` keyword is important * * To send generic data (or to write them to file) * any type may be passed for data, * thus use `void *` *//* OK example */voidsend_data(const void* data, size_t len) &#123; /* OK */    /* Do not cast `void *` or `const void *` */    const uint8_t* d = data;/* Function handles proper type for internal usage */&#125;voidsend_data(const void* data, int len) &#123;    /* Wrong, not not use int */&#125;\n\n\nAlways use brackets with sizeof operator\n\nNever use Variable Length Array (VLA). Use dynamic memory allocation instead with standard C malloc and free functions or if library&#x2F;project provides custom memory allocation, use its implementation\n\nTake a look at LwMEM, custom memory management library/* OK */#include &lt;stdlib.h&gt;voidmy_func(size_t size) &#123;    int32_t* arr;    arr = malloc(sizeof(*arr) * n); /* OK, Allocate memory */    arr = malloc(sizeof *arr * n);  /* Wrong, brackets for sizeof operator are missing */    if (arr == NULL) &#123;        /* FAIL, no memory */    &#125;    free(arr);  /* Free memory after usage */&#125;/* Wrong */voidmy_func(size_t size) &#123;    int32_t arr[size];  /* Wrong, do not use VLA */&#125;\n\n\nAlways compare variable against zero, except if it is treated as boolean type\n\nNever compare boolean-treated variables against zero or one. Use NOT (!) instead\nsize_t length = 5;  /* Counter variable */uint8_t is_ok = 0;  /* Boolean-treated variable */if (length)         /* Wrong, length is not treated as boolean */if (length &gt; 0)     /* OK, length is treated as counter variable containing multi values, not only 0 or 1 */if (length == 0)    /* OK, length is treated as counter variable containing multi values, not only 0 or 1 */if (is_ok)          /* OK, variable is treated as boolean */if (!is_ok)         /* OK, -||- */if (is_ok == 1)     /* Wrong, never compare boolean variable against 1! */if (is_ok == 0)     /* Wrong, use ! for negative check */\n\nAlways use /* comment */ for comments, even for single-line comment\n\nAlways include check for C++ with extern keyword in header file\n\nEvery function must include doxygen-enabled comment, even if function is static\n\nUse English names&#x2F;text for functions, variables, comments\n\nUse lowercase characters for variables\n\nUse underscore if variable contains multiple names, eg. force_redraw. Do not use forceRedraw\n\nNever cast function returning void *, eg. uint8_t* ptr = (uint8_t *)func_returning_void_ptr(); as void * is safely promoted to any other pointer type\n\nUse uint8_t* ptr = func_returning_void_ptr(); instead\n\n\nAlways use &lt; and &gt; for C Standard Library include files, eg. #include &lt;stdlib.h&gt;\n\nAlways use &quot;&quot; for custom libraries, eg. #include &quot;my_library.h&quot;\n\nWhen casting to pointer type, always align asterisk to type, eg. uint8_t* t = (uint8_t*)var_width_diff_type\n\nAlways respect code style already used in project or library\n\n\nComments\nComments starting with // are not allowed. Always use /* comment */, even for single-line comment\n//This is comment (wrong)/* This is comment (ok) */\n\nFor multi-line comments use space+asterisk for every line\n/* * This is multi-line comments, * written in 2 lines (ok) *//** * Wrong, use double-asterisk only for doxygen documentation *//** Single line comment without space before asterisk (wrong)*//* * Single line comment in multi-line configuration (wrong) *//* Single line comment (ok) */\n\nUse 12 indents (12 * 4 spaces) offset when commenting. If statement is larger than 12 indents, make comment 4-spaces aligned (examples below) to next available indent\nvoidmy_func(void) &#123;    char a, b;    a = call_func_returning_char_a(a);          /* This is comment with 12*4 spaces indent from beginning of line */    b = call_func_returning_char_a_but_func_name_is_very_long(a);   /* This is comment, aligned to 4-spaces indent */&#125;\n\nFunctions\nEvery function which may have access from outside its module, must include function prototype (or declaration)\n\nFunction name must be lowercase, optionally separated with underscore _ character\n/* OK */void my_func(void);void myfunc(void);/* Wrong */void MYFunc(void);void myFunc();\n\nWhen function returns pointer, align asterisk to return type\n/* OK */const char* my_func(void);my_struct_t* my_func(int32_t a, int32_t b);/* Wrong */const char *my_func(void);my_struct_t * my_func(void);\nAlign all function prototypes (with the same&#x2F;similar functionality) for better readability\n/* OK, function names aligned */void        set(int32_t a);my_type_t   get(void);my_ptr_t*   get_ptr(void);/* Wrong */void set(int32_t a);const char * get(void);\n\nFunction implementation must include return type and optional other keywords in separate line\n/* OK */int32_tfoo(void) &#123;    return 0;&#125;/* OK */static const char*get_string(void) &#123;    return &quot;Hello world!\\r\\n&quot;;&#125;/* Wrong */int32_t foo(void) &#123;    return 0;&#125;\n\nWhen function returns pointer, asterisk character must be aligned to return type (char*)\n/* OK */const char*foo(void) &#123;    return &quot;test&quot;;&#125;/* Wrong */const char*foo(void) &#123;    return &quot;test&quot;;&#125;\n\nVariables\nMake variable name all lowercase with optional underscore _ character\n/* OK */int32_t a;int32_t my_var;int32_t myvar;/* Wrong */int32_t A;int32_t myVar;int32_t MYVar;\n\nGroup local variables together by type\nvoidfoo(void) &#123;    int32_t a, b;   /* OK */    char a;    char b;         /* Wrong, char type already exists */&#125;\n\nDo not declare variable after first executable statement\nvoidfoo(void) &#123;    int32_t a;    a = bar();    int32_t b;      /* Wrong, there is already executable statement */&#125;\n\nYou may declare new variables inside next indent level\nint32_t a, b;a = foo();if (a) &#123;    int32_t c, d;   /* OK, c and d are in if-statement scope */    c = foo();    int32_t e;      /* Wrong, there was already executable statement inside block */&#125;\n\nDeclare pointer variables with asterisk aligned to type\n/* OK */char* a;/* Wrong */char *a;char * a;\n\nWhen declaring multiple pointer variables, you may declare them with asterisk aligned to variable name\n/* OK */char *p, *n;\n\nStructures, enumerations, typedefs\nStructure or enumeration name must be lowercase with optional underscore _ character between words\nStructure or enumeration may contain typedef keyword\nAll structure members must be lowercase\nAll enumeration members must be uppercase\nStructure&#x2F;enumeration must follow doxygen documentation syntax\n\nWhen structure is declared, it may use one of 3 different options:\n\nWhen structure is declared with name only, it must not contain _t suffix after its name.struct struct_name &#123;    char* a;    char b;&#125;;\nWhen structure is declared with typedef only, it has to contain _t suffix after its name.typedef struct &#123;    char* a;    char b;&#125; struct_name_t;\nWhen structure is declared with name and typedef, it must not contain _t for basic name and it has to contain _t suffix after its name for typedef part.typedef struct struct_name &#123;    char* a;    char b;    char c;&#125; struct_name_t;\n\nExamples of bad declarations and their suggested corrections\n/* a and b must be separated to 2 lines *//* Name of structure with typedef must include _t suffix */typedef struct &#123;    int32_t a, b;&#125; a;/* Corrected version */typedef struct &#123;    int32_t a;    int32_t b;&#125; a_t;/* Wrong name, it must not include _t suffix */struct name_t &#123;    int32_t a;    int32_t b;&#125;;/* Wrong parameters, must be all uppercase */typedef enum &#123;    MY_ENUM_TESTA,    my_enum_testb,&#125; my_enum_t;\n\n\nWhen initializing structure on declaration, use C99 initialization style\n/* OK */a_t a = &#123;    .a = 4,    .b = 5,&#125;;/* Wrong */a_t a = &#123;1, 2&#125;;\n\nWhen new typedef is introduced for function handles, use _fn suffix\n/* Function accepts 2 parameters and returns uint8_t *//* Name of typedef has `_fn` suffix */typedef uint8_t (*my_func_typedef_fn)(uint8_t p1, const char* p2);\n\nCompound statements\nEvery compound statement must include opening and closing curly bracket, even if it includes only 1 nested statement\n\nEvery compound statement must include single indent; when nesting statements, include 1 indent size for each nest\n/* OK */if (c) &#123;    do_a();&#125; else &#123;    do_b();&#125;/* Wrong */if (c)    do_a();else    do_b();/* Wrong */if (c) do_a();else do_b();\n\nIn case of if or if-else-if statement, else must be in the same line as closing bracket of first statement\n/* OK */if (a) &#123;&#125; else if (b) &#123;&#125; else &#123;&#125;/* Wrong */if (a) &#123;&#125;else &#123;&#125;/* Wrong */if (a) &#123;&#125;else&#123;&#125;\n\nIn case of do-while statement, while part must be in the same line as closing bracket of do part\n/* OK */do &#123;    int32_t a;    a = do_a();    do_b(a);&#125; while (check());/* Wrong */do&#123;/* ... */&#125; while (check());/* Wrong */do &#123;/* ... */&#125;while (check());\n\nIndentation is required for every opening bracket\nif (a) &#123;    do_a();&#125; else &#123;    do_b();    if (c) &#123;        do_c();    &#125;&#125;\n\nNever do compound statement without curly bracket, even in case of single statement. Examples below show bad practices\nif (a) do_b();else do_c();if (a) do_a(); else do_b();\n\nEmpty while, do-while or for loops must include brackets\n/* OK */while (is_register_bit_set()) &#123;&#125;/* Wrong */while (is_register_bit_set());while (is_register_bit_set()) &#123; &#125;while (is_register_bit_set()) &#123;&#125;\n\nIf while (or for, do-while, etc) is empty (it can be the case in embedded programming), use empty single-line brackets\n/* Wait for bit to be set in embedded hardware unituint32_t* addr = HW_PERIPH_REGISTER_ADDR;/* Wait bit 13 to be ready */while (*addr &amp; (1 &lt;&lt; 13)) &#123;&#125;        /* OK, empty loop contains no spaces inside curly brackets */while (*addr &amp; (1 &lt;&lt; 13)) &#123; &#125;       /* Wrong */while (*addr &amp; (1 &lt;&lt; 13)) &#123;         /* Wrong */&#125;while (*addr &amp; (1 &lt;&lt; 13));          /* Wrong, curly brackets are missing. Can lead to compiler warnings or unintentional bugs */\nAlways prefer using loops in this order: for, do-while, while\n\nAvoid incrementing variables inside loop block if possible, see examples\n\n\n/* Not recommended */int32_t a = 0;while (a &lt; 10) &#123;    .    ..    ...    ++a;&#125;/* Better */for (size_t a = 0; a &lt; 10; ++a) &#123;&#125;/* Better, if inc may not happen in every cycle */for (size_t a = 0; a &lt; 10; ) &#123;    if (...) &#123;        ++a;    &#125;&#125;\n\nSwitch statement\nAdd single indent for every case statement\n\nUse additional single indent for break statement in each case or default\n/* OK, every case has single indent *//* OK, every break has additional indent */switch (check()) &#123;    case 0:        do_a();        break;    case 1:        do_b();        break;    default:        break;&#125;/* Wrong, case indent missing */switch (check()) &#123;case 0:    do_a();    break;case 1:    do_b();    break;default:    break;&#125;/* Wrong */switch (check()) &#123;    case 0:        do_a();    break;      /* Wrong, break must have indent as it is under case */    case 1:    do_b();     /* Wrong, indent under case is missing */    break;    default:        break;&#125;\n\nAlways include default statement\n/* OK */switch (var) &#123;    case 0:        do_job();        break;    default: break;&#125;/* Wrong, default is missing */switch (var) &#123;    case 0:        do_job();        break;&#125;\n\nIf local variables are required, use curly brackets and put break statement inside.\n\nPut opening curly bracket in the same line as case statementswitch (a) &#123;    /* OK */    case 0: &#123;        int32_t a, b;        char c;        a = 5;        /* ... */        break;    &#125;    /* Wrong */    case 1:    &#123;        int32_t a;        break;    &#125;    /* Wrong, break shall be inside */    case 2: &#123;        int32_t a;    &#125;    break;&#125;\n\n\n\nMacros and preprocessor directives\nAlways use macros instead of literal constants, specially for numbers\n\nAll macros must be fully uppercase, with optional underscore _ character, except if they are clearly marked as function which may be in the future replaced with regular function syntax\n/* OK */#define MY_MACRO(x)         ((x) * (x))/* Wrong */#define square(x)           ((x) * (x))\n\nAlways protect input parameters with parentheses\n/* OK */#define MIN(x, y)           ((x) &lt; (y) ? (x) : (y))/* Wrong */#define MIN(x, y)           x &lt; y ? x : y\n\nAlways protect final macro evaluation with parenthesis\n/* Wrong */#define MIN(x, y)           (x) &lt; (y) ? (x) : (y)#define SUM(x, y)           (x) + (y)/* Imagine result of this equation using wrong SUM implementation */int32_t x = 5 * SUM(3, 4);  /* Expected result is 5 * 7 = 35 */int32_t x = 5 * (3) + (4);  /* It is evaluated to this, final result = 19 which is not what we expect *//* Correct implementation */#define MIN(x, y)           ((x) &lt; (y) ? (x) : (y))#define SUM(x, y)           ((x) + (y))\n\nWhen macro uses multiple statements, protect it using do-while (0) statement\ntypedef struct &#123;    int32_t px, py;&#125; point_t;point_t p;                  /* Define new point *//* Wrong implementation *//* Define macro to set point */#define SET_POINT(p, x, y)  (p)-&gt;px = (x); (p)-&gt;py = (y)    /* 2 statements. Last one should not implement semicolon */SET_POINT(&amp;p, 3, 4);        /* Set point to position 3, 4. This evaluates to... */(&amp;p)-&gt;px = (3); (&amp;p)-&gt;py = (4); /* ... to this. In this example this is not a problem. *//* Consider this ugly code, however it is valid by C standard (not recommended) */if (a)                      /* If a is true */    if (b)                  /* If b is true */        SET_POINT(&amp;p, 3, 4);/* Set point to x = 3, y = 4 */    else        SET_POINT(&amp;p, 5, 6);/* Set point to x = 5, y = 6 *//* Evaluates to code below. Do you see the problem? */if (a)    if (b)        (&amp;p)-&gt;px = (3); (&amp;p)-&gt;py = (4);    else        (&amp;p)-&gt;px = (5); (&amp;p)-&gt;py = (6);/* Or if we rewrite it a little */if (a)    if (b)        (&amp;p)-&gt;px = (3);        (&amp;p)-&gt;py = (4);    else        (&amp;p)-&gt;px = (5);        (&amp;p)-&gt;py = (6);/* * Ask yourself a question: To which `if` statement `else` keyword belongs? * * Based on first part of code, answer is straight-forward. To inner `if` statement when we check `b` condition * Actual answer: Compilation error as `else` belongs nowhere *//* Better and correct implementation of macro */#define SET_POINT(p, x, y)  do &#123; (p)-&gt;px = (x); (p)-&gt;py = (y); &#125; while (0)    /* 2 statements. No semicolon after while loop *//* Or even better */#define SET_POINT(p, x, y)  do &#123;    \\   /* Backslash indicates statement continues in new line */    (p)-&gt;px = (x);                  \\    (p)-&gt;py = (y);                  \\&#125; while (0)                             /* 2 statements. No semicolon after while loop *//* Now original code evaluates to */if (a)    if (b)        do &#123; (&amp;p)-&gt;px = (3); (&amp;p)-&gt;py = (4); &#125; while (0);    else        do &#123; (&amp;p)-&gt;px = (5); (&amp;p)-&gt;py = (6); &#125; while (0);/* Every part of `if` or `else` contains only `1` inner statement (do-while), hence this is valid evaluation *//* To make code perfect, use brackets for every if-ifelse-else statements */if (a) &#123;                    /* If a is true */    if (b) &#123;                /* If b is true */        SET_POINT(&amp;p, 3, 4);/* Set point to x = 3, y = 4 */    &#125; else &#123;        SET_POINT(&amp;p, 5, 6);/* Set point to x = 5, y = 6 */    &#125;&#125;\n\nAlways write macro documentation as regular function with additional hideinitializer doxygen keyword\n#define MY_MACRO(x)         ((x) * 2)\n\nAvoid using #ifdef or #ifndef. Use defined() or !defined() instead\n#ifdef XYZ/* do something */#endif /* XYZ */\n\nAlways document if/elif/else/endif statements\n/* OK */#if defined(XYZ)/* Do if XYZ defined */#else /* defined(XYZ) *//* Do if XYZ not defined */#endif /* !defined(XYZ) *//* Wrong */#if defined(XYZ)/* Do if XYZ defined */#else/* Do if XYZ not defined */#endif\n\nDo not indent sub statements inside #if statement\n/* OK */#if defined(XYZ)#if defined(ABC)/* do when ABC defined */#endif /* defined(ABC) */#else /* defined(XYZ) *//* Do when XYZ not defined */#endif /* !defined(XYZ) *//* Wrong */#if defined(XYZ)    #if defined(ABC)        /* do when ABC defined */    #endif /* defined(ABC) */#else /* defined(XYZ) */    /* Do when XYZ not defined */#endif /* !defined(XYZ) */\n\nDocumentationDocumented code allows doxygen to parse and general html&#x2F;pdf&#x2F;latex output, thus it is very important to do it properly.\n\nUse doxygen-enabled documentation style for variables, functions and structures/enumerations\n\nAlways use \\ for doxygen, do not use @\n\nAlways use 5x4 spaces (5 tabs) offset from beginning of line for text\n/** * \\brief           Holds pointer to first entry in linked list *                  Beginning of this text is 5 tabs (20 spaces) from beginning of line */statictype_t* list;\n\nEvery structure&#x2F;enumeration member must include documentation\n\nUse 12x4 spaces offset for beginning of comment\n/** * \\brief           This is point struct * \\note            This structure is used to calculate all point *                      related stuff */typedef struct &#123;    int32_t x;                                  /*!&lt; Point X coordinate */    int32_t y;                                  /*!&lt; Point Y coordinate */    int32_t size;                               /*!&lt; Point size.                                                    Since comment is very big,                                                    you may go to next line */&#125; point_t;/** * \\brief           Point color enumeration */typedef enum &#123;    COLOR_RED,                                  /*!&lt; Red color. This comment has 12x4                                                    spaces offset from beginning of line */    COLOR_GREEN,                                /*!&lt; Green color */    COLOR_BLUE,                                 /*!&lt; Blue color */&#125; point_color_t;\n\nDocumentation for functions must be written in function implementation (source file usually)\n\nFunction must include brief and all parameters documentation\n\nEvery parameter must be noted if it is in or out for input and output respectively\n\nFunction must include return parameter if it returns something. This does not apply for void functions\n\nFunction can include other doxygen keywords, such as note or warning\n\nUse colon : between parameter name and its description\n/** * \\brief           Sum `2` numbers * \\param[in]       a: First number * \\param[in]       b: Second number * \\return          Sum of input values */int32_tsum(int32_t a, int32_t b) &#123;    return a + b;&#125;/** * \\brief           Sum `2` numbers and write it to pointer * \\note            This function does not return value, it stores it to pointer instead * \\param[in]       a: First number * \\param[in]       b: Second number * \\param[out]      result: Output variable used to save result */voidvoid_sum(int32_t a, int32_t b, int32_t* result) &#123;    *result = a + b;&#125;\n\nIf function returns member of enumeration, use ref keyword to specify which one\n/** * \\brief           My enumeration */typedef enum &#123;    MY_ERR,                                     /*!&lt; Error value */    MY_OK                                       /*!&lt; OK value */&#125; my_enum_t;/** * \\brief           Check some value * \\return          \\ref MY_OK on success, member of \\ref my_enum_t otherwise */my_enum_tcheck_value(void) &#123;    return MY_OK;&#125;\n\nUse notation (`NULL` &#x3D;&gt; NULL) for constants or numbers\n/** * \\brief           Get data from input array * \\param[in]       in: Input data * \\return          Pointer to output data on success, `NULL` otherwise */const void *get_data(const void* in) &#123;    return in;&#125;\n\nDocumentation for macros must include hideinitializer doxygen command\n/** * \\brief           Get minimal value between `x` and `y` * \\param[in]       x: First value * \\param[in]       y: Second value * \\return          Minimal value between `x` and `y` * \\hideinitializer */#define MIN(x, y)       ((x) &lt; (y) ? (x) : (y))\n\nHeader&#x2F;source files\nLeave single empty line at the end of file\n\nEvery file must include doxygen annotation for file and brief description followed by empty line (when using doxygen)\n/** * \\file            template.h * \\brief           Template include file */                    /* Here is empty line */\n\nEvery file (header or source) must include license (opening comment includes single asterisk as this must be ignored by doxygen)\n\nUse the same license as already used by project&#x2F;library\n/** * \\file            template.h * \\brief           Template include file *//* * Copyright (c) year FirstName LASTNAME * * Permission is hereby granted, free of charge, to any person * obtaining a copy of this software and associated documentation * files (the &quot;Software&quot;), to deal in the Software without restriction, * including without limitation the rights to use, copy, modify, merge, * publish, distribute, sublicense, and/or sell copies of the Software, * and to permit persons to whom the Software is furnished to do so, * subject to the following conditions: * * The above copyright notice and this permission notice shall be * included in all copies or substantial portions of the Software. * * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE * AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR * OTHER DEALINGS IN THE SOFTWARE. * * This file is part of library_name. * * Author:          FirstName LASTNAME &lt;optional_email@example.com&gt; */\n\nHeader file must include guard #ifndef\n\nHeader file must include C++ check\n\nInclude external header files outside C++ check\n\nInclude external header files with STL C files first followed by application custom files\n\nHeader file must include only every other header file in order to compile correctly, but not more (.c should include the rest if required)\n\nHeader file must only expose module public variables&#x2F;types&#x2F;functions\n\nUse extern for global module variables in header file, define them in source file later\n/* file.h ... */#ifndef ...extern int32_t my_variable; /* This is global variable declaration in header */#endif/* file.c ... */int32_t my_variable;        /* Actually defined in source */\nNever include .c files in another .c file\n\n.c file should first include corresponding .h file, later others, unless otherwise explicitly necessary\n\nDo not include module private declarations in header file\n\nHeader file example (no license for sake of an example)\n/* License comes here */#ifndef TEMPLATE_HDR_H#define TEMPLATE_HDR_H/* Include headers */#ifdef __cplusplusextern &quot;C&quot; &#123;#endif /* __cplusplus *//* File content here */#ifdef __cplusplus&#125;#endif /* __cplusplus */#endif /* TEMPLATE_HDR_H */\n\nArtistic style configurationAStyle is a great piece of software that canhelp with formatting the code based on input configuration.\nThis repository contains astyle-code-format.cfg file which can be used with AStyle software.\nastyle --options=&quot;astyle-code-format.cfg&quot; &quot;input_path/*.c,*.h&quot; &quot;input_path2/*.c,*.h&quot;\n\nEclipse formatterRepository contains eclipse-ext-kr-format.xml file that can be used witheclipse-based toolchains to set formatter options.\nIt is based on K&amp;R formatter with modifications to respect above rules.You can import it within eclipse settings, Preferences -&gt; LANGUAGE -&gt; Code Style -&gt; Formatter tab.\n"},{"title":"STM32H7æ€§èƒ½é—®é¢˜ä¼˜åŒ–å®è·µ","url":"/2024/03/07/STM32H7%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5/","content":"æœ€è¿‘å¼€å‘ä¸€ä¸ªé¡¹ç›®ï¼Œé‡‡ç”¨STM32H7å•ç‰‡æœºï¼Œé‡åˆ°äº†ä¸€ä¸ªæˆ‘ä»¥å‰æ²¡æœ‰é‡åˆ°è¿‡çš„ä¸€ä¸ªæ€§èƒ½é—®é¢˜ï¼Œé€šè¿‡åˆ†æè§£å†³è¯¥é—®é¢˜çš„è¿‡ç¨‹è®©æˆ‘å¯¹STM32é«˜æ€§èƒ½æ•°æ®ä¼ è¾“æœ‰æ›´åŠ æ·±åˆ»çš„ç†è§£ã€‚\n\nå…³é”®å­—ï¼šæ€»çº¿ã€DMAã€FIFO\n\n\né¡¹ç›®èƒŒæ™¯æŸé¡¹ç›®å¼€å‘ä¸­éœ€è¦å°†Linuxçš„æ•°æ®é€šè¿‡USBä¼ è¾“åˆ°å•ç‰‡æœºï¼Œæ•°æ®åœ¨å•ç‰‡æœºä¸­ç»è¿‡é€‚å½“çš„å¤„ç†åå†å°†æ•°æ®ä¼ è¾“åˆ°ç¡¬ä»¶å¤–è®¾ä¸Šã€‚\nç¬¬ä¸€æ¬¡æ€§èƒ½ç“¶é¢ˆ - USBUSBçš„ç†è®ºå¸¦å®½æœ‰480MHzï¼Œä½¿ç”¨æ‰¹é‡ä¼ è¾“æ¨¡å¼å¯å®ç°è¾ƒé«˜çš„ä¼ è¾“é€Ÿåº¦ã€‚æœ€å¼€å§‹é€‰ç”¨çš„æ˜¯Tinyusbåè®®æ ˆï¼Œåœ¨ä½¿ç”¨äº†ä¸€æ®µæ—¶é—´åæ‰å‘ç°è¯¥åè®®æ ˆä¸æ”¯æŒDMAï¼Œè¿™å¯¼è‡´åœ¨è¿›è¡Œé«˜å¸¦å®½æ•°æ®ä¼ è¾“æ—¶å¯¼è‡´CPUå ç”¨éå¸¸é«˜ï¼Œæ¥è¿‘40%çš„CPUèµ„æºéƒ½ç”¨äºåè®®æ ˆä¼ è¾“æ•°æ®ã€‚è¿‡é«˜çš„CPUå ç”¨å°†ä¼šä¸ºåç»­çš„æ•°æ®å¤„ç†é˜¶æ®µå¸¦æ¥è¾ƒå¤§çš„éšæ‚£ï¼Œæ‰€ä»¥å¿…é¡»è¦è§£å†³DMAæ”¯æŒçš„é—®é¢˜ã€‚\nå°†åè®®æ ˆæ›´æ¢ä¸ºCherryUSBåï¼ŒDMAçš„é—®é¢˜è§£å†³äº†ã€‚åœ¨CPUä»…å ç”¨1%çš„æƒ…å†µä¸‹ï¼Œå¯è¾¾åˆ°30MB&#x2F;sçš„ä¼ è¾“é€Ÿåº¦ã€‚\nå†…å­˜å¸¦å®½é™åˆ¶æœ€å¼€å§‹æˆ‘è®¤ä¸ºå°†USBçš„æ•°æ®ç¼“å­˜æ”¾åœ¨é è¿‘USBå¤–è®¾çš„åŒºåŸŸï¼Œä¹Ÿå°±æ˜¯AHBæ€»çº¿çŸ©é˜µé™„è¿‘ä¼šæœ‰æ›´å¤šä¼˜åŠ¿ï¼Œä½†æ˜¯æˆ‘å´å¿½ç•¥äº†ä¸€ä¸ªå¸¦å®½é—®é¢˜ã€‚è¿™é‡Œçš„å†…å­˜å¸¦å®½æ˜¯32bitçš„ï¼Œåœ¨åç»­æ•°æ®å¤„ç†é˜¶æ®µï¼ŒCPUè®¿é—®è¿™é‡Œçš„æ•°æ®ä¼šæœ‰ä¸€å®šçš„æ€§èƒ½ç“¶é¢ˆã€‚å°†USBçš„ç¼“å­˜åˆ‡æ¢åˆ°AXIçŸ©é˜µä¸‹ï¼ŒCPUçš„å¤„ç†æ€§èƒ½æé«˜äº†ä¸€å€ï¼Œä¸”å¯¹USBçš„ä¼ è¾“æ€§èƒ½åŸºæœ¬ä¸Šæ²¡æœ‰å¤ªå¤§çš„å½±å“ã€‚\né™¤äº†å¸¦å®½é—®é¢˜å¤–ï¼ŒAHBçŸ©é˜µä¸‹çš„Cacheç­–ç•¥ä¹Ÿæœ‰ä¸€å®šçš„å½±å“ï¼Œè¿™é‡Œæ˜¯å…³é—­äº†DCacheçš„ã€‚å°†æ•°æ®ç¼“å­˜æ”¾åˆ°AXI-SARMåä¹Ÿéœ€è¦é¢ä¸´DCacheçš„é—®é¢˜ã€‚\nè¿™é‡Œæœ‰ä¸¤ä¸ªé€‰æ‹©ï¼Œ1ï¼šå¼€å¯DCacheï¼Œä½†æ˜¯éœ€è¦åœ¨é€‚å½“çš„æ—¶å€™è¿›è¡Œå†…å­˜åŒæ­¥ã€‚2ï¼šå…³é—­è¯¥åŒºåŸŸçš„DCacheï¼Œè¿™æ ·ä¸éœ€è¦é¢å¤–çš„å†…å­˜åŒæ­¥æ“ä½œã€‚åˆ†åˆ«æµ‹è¯•äº†ä¸¤ç§æƒ…å†µï¼Œæœ€ç»ˆå¼€å¯DCacheçš„æ–¹æ¡ˆæ€§èƒ½è¦å¥½å¾—å¤š(ä¼˜50%ä»¥ä¸Š)ã€‚è¿™çœ‹èµ·æ¥æ˜¯ä¸å¤ªåˆç†çš„ï¼Œå› ä¸ºè¿™é‡Œæ¶‰åŠåˆ°äº†USBçš„DMAï¼Œè¯¥åŒºåŸŸçš„Cacheç‰¹æ€§åè€Œæ˜¯ä¸€ç§è´Ÿæ‹…ã€‚ä½†æ˜¯å…³é—­Cacheåæ€§èƒ½å´å¤§å—å½±å“ã€‚\nå¤–è®¾ä¼ è¾“æ€§èƒ½çš„ä¼˜åŒ–å°†æ•°æ®ä¼ è¾“åˆ°å¤–è®¾ä¸­åŸºæœ¬ä¸Šæ²¡ä»€ä¹ˆç‰¹åˆ«çš„é€‰æ‹©ï¼Œåªæœ‰DMAèƒ½å¤Ÿèƒœä»»ã€‚ä½†æ˜¯åœ¨è½å®åˆ°å…·ä½“çš„é…ç½®ä¸Šæœ‰å¾ˆå¤šä¼˜åŒ–çš„åœ°æ–¹éœ€è¦æ³¨æ„ï¼Œè¿™éƒ½æ˜¯å½±å“æ€§èƒ½çš„å…³é”®ç‚¹ã€‚\nå¤–è®¾ä¸Šçš„FIFOï¼Œæˆ‘æœ€å¼€å§‹å¹¶æ²¡æœ‰æ„è¯†åˆ°å¤–è®¾FIFOçš„ä½œç”¨ï¼Œå› ä¸ºè¿™é‡Œå·²ç»ä½¿ç”¨äº†DMAï¼Œå¤–è®¾ä¸Šçš„FIFOä½œç”¨å¹¶ä¸æ˜æ˜¾ã€‚ä½†è¯¥FIFOèƒ½å¤Ÿæé«˜æ€»çº¿çš„åˆ©ç”¨ç‡ï¼Œé€šè¿‡FIFOç¼“å­˜æ•°æ®åï¼Œå¯ç”¨å°†æ•°æ®ä½å®½è¿›è¡Œå‹ç¼©ä¼ è¾“ï¼Œç›®æ ‡å¤–è®¾ä¸º16bitæ—¶ï¼Œé€šè¿‡å°†ä¸¤æ¬¡ä¼ è¾“å‹ç¼©ä¸º32bitè¿›è¡Œä¸€æ¬¡ä¼ è¾“åˆ°FIFOå†…ï¼Œä»è€Œæé«˜ä¼ è¾“æ€§èƒ½ã€‚\næ­¤å¤–ï¼Œåˆ©ç”¨DMAä¸Šçš„FIFOé…åˆçªå‘æ¨¡å¼èƒ½å¤Ÿè¿›ä¸€æ­¥æé«˜ä¼ è¾“æ€§èƒ½ï¼Œè¿™å¯¹æ€»çº¿æ€§èƒ½æé«˜éå¸¸æ˜æ˜¾ï¼Œå› ä¸ºå‰é¢çš„USBæ•°æ®å’Œè¯¥å¤–è®¾æ•°æ®ä¼šç»è¿‡åŒä¸€æ¡æ•°æ®æ€»çº¿ï¼Œä½¿ç”¨çªå‘æ¨¡å¼ä¼ è¾“æ•°æ®å¯ç”¨åœ¨é€‚å½“æƒ…å†µä¸‹é¿å…æ€»çº¿å‘ç”ŸæŠ¢å è€Œå¯¼è‡´CPUæˆ–USBå‘ç”Ÿä¸å¿…è¦çš„ç­‰å¾…ã€‚æ€»çº¿ä¸Šçš„è®¿é—®æ¨¡å¼ä¼˜åŒ–å°†ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½æé«˜äº†10%ï¼Œæ•ˆæœéå¸¸çš„æ˜æ˜¾ã€‚\næ•°æ®å¤„ç†ä¸Šéœ€è¦æ³¨æ„çš„åœ°æ–¹æœ¬æ¬¡å¼€å‘è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°äº†è®¸å¤šçš„éå®Œæ•´å®½åº¦çš„æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚12bitã€14bitçš„æœ‰ç¬¦å·æ•°ï¼Œåœ¨Cè¯­è¨€ä¸­ä¸€èˆ¬ä½¿ç”¨ä½åŸŸèƒ½å¤Ÿéå¸¸è½»æ¾çš„å¤„ç†è¿™ç§æ•°æ®ç±»å‹ã€‚ä½†æ˜¯åœ¨å®è·µçš„è¿‡ç¨‹ä¸­å‘ç°ï¼Œä½¿ç”¨ä½åŸŸèµ‹å€¼æ—¶ä¼šå­˜åœ¨ä¸€å®šçš„æ€§èƒ½é—®é¢˜ï¼Œå¯¼è‡´æ•°æ®å¤„ç†çš„æ•ˆç‡é™ä½ã€‚å› ä¸ºå¤„ç†å™¨æ¯æ¬¡å¯¹ä¸€ä¸ªéå®Œæ•´å®½åº¦çš„æ•°æ®èµ‹å€¼æ—¶éœ€è¦å…ˆä»å†…å­˜ä¸­åŠ è½½ä¸€éƒ¨åˆ†æ•°æ®ï¼Œè¿™å¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„å†…å­˜IOå¼€é”€ï¼Œå› ä¸ºLDRã€STRæŒ‡ä»¤æ˜¯æ‹–æ…¢ç³»ç»Ÿè¿è¡Œçš„å…³é”®å› ç´ ã€‚åœ¨ç®—æ³•çš„å®è·µä¸­éœ€è¦å‡å°‘IOçš„è®¿é—®ï¼Œå°†ä¸€éƒ¨åˆ†æ•°æ®ç®—æ³•ä½¿ç”¨å¯„å­˜å™¨è¿›è¡Œå¤„ç†ï¼Œä¹‹åå†å°†å¯„å­˜å™¨çš„æ•°æ®å†™å…¥åˆ°å†…å­˜ä¸­ã€‚\nåœ¨å¼€å‘Cä»£ç è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å¾ˆå¤šäººæ— æ³•é ç›´è§‰æƒ³åˆ°ä¸€æ®µCä»£ç æœ‰å¤šå°‘LDRã€STRæŒ‡ä»¤ï¼Œä½†åœ¨ç»è¿‡ä¸€å®šç¨‹åº¦çš„ç»ƒä¹ åè¿˜æ˜¯èƒ½å¤Ÿè¿™ç§å¤©èµ‹çš„ã€‚æ¨èä¸€ä¸ªç½‘ç«™Compiler Explorer ï¼Œè¯¥ç½‘ç«™èƒ½å¤Ÿå°†Cä»£ç è½¬ä¸ºæ±‡ç¼–ï¼Œå¹¶æä¾›å¯é€‰çš„ç¼–è¯‘é€‰é¡¹ï¼Œå¯ä»¥ä½œä¸ºå­¦ä¹ çš„å¹³å°å’Œå·¥å…·ã€‚æƒ³è¦ç¼–å†™å‡ºçœŸæ­£çš„é«˜æ€§èƒ½ä»£ç ï¼ŒæŒæ¡åŸºæœ¬çš„æ±‡ç¼–è¯­è¨€ä¹Ÿæ˜¯æ¯”ä¸å¯å°‘çš„ï¼Œç†è§£å„ç§æ±‡ç¼–æŒ‡ä»¤çš„æ—¶é’Ÿå‘¨æœŸå¯¹ç¼–å†™é«˜æ€§èƒ½ä»£ç æ›´åŠ é‡è¦ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚\næ€»ç»“å•ç‰‡æœºå†…éƒ¨æ•°æ®æ€»çº¿åœ¨å¹³æ—¶å¼€å‘è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰ç‰¹åˆ«æ³¨æ„ï¼Œå› ä¸ºæ²¡æœ‰ç›´æ¥å¯¹å†…æ ¸æˆ–å¤–è®¾äº§ç”Ÿå½±å“ï¼Œä½†æ˜¯åœ¨é¢ä¸´å¤§æ•°æ®å¸¦å®½ã€å¤šä¸ªå¤–è®¾å¹¶è¡Œæ—¶ï¼Œåˆç†çš„é…ç½®ä»¥ä¼˜åŒ–æ€»çº¿çš„åˆ©ç”¨å°†æœ‰åŠ©äºç³»ç»Ÿæ•´ä½“çš„ä¼˜åŒ–ã€‚åœ¨æœ¬æ¬¡å¼€å‘è¿‡ç¨‹ä¸­ï¼Œè¿˜ç ”ç©¶äº†æ€»çº¿çŸ©é˜µä¸Šçš„ä¸€ä¸‹å…¶å®ƒé…ç½®ï¼Œå¦‚Qosã€æ€»çº¿ä¼˜å…ˆçº§ç­‰ç­‰ï¼Œä½†ç”±äºæœ¬æ¬¡å¼€å‘æ—¶é—´æœ‰é™ä¸”é¡¹ç›®å·²æ»¡è¶³è®¾è®¡è¦æ±‚ï¼Œæ²¡æœ‰è¿›ä¸€æ­¥çš„æ·±å…¥æ¢ç©¶ï¼Œåœ¨è¿™äº›åœ°æ–¹åº”è¯¥è¿˜æœ‰ä¼˜åŒ–çš„ç©ºé—´ã€‚\n"},{"title":"SVCç³»ç»Ÿè°ƒç”¨çš„ç¼–ç¨‹ä½¿ç”¨æ–¹æ³•","url":"/2021/11/06/SVC%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%9A%84%E7%BC%96%E7%A8%8B%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/","content":"SVCç§°ä¸ºç³»ç»ŸæœåŠ¡è°ƒç”¨(SuperVisorCall)ï¼Œå¼‚å¸¸ç±»å‹ä¸º11ï¼Œé€šè¿‡svcæŒ‡ä»¤å¯ç”¨è§¦å‘å¼‚å¸¸ï¼ŒSVCåœ¨è§¦å‘å¼‚å¸¸åå¿…é¡»ç«‹å³å¾—åˆ°ç›¸åº”(è§¦å‘å¼‚å¸¸ååœ¨æ‰§è¡Œå¼‚å¸¸å‰ä¸èƒ½æ‰§è¡Œå…¶å®ƒä»£ç )ï¼Œé™¤éæœ‰æ›´é«˜ä¼˜å…ˆçº§çš„å¼‚å¸¸åœ¨æ‰§è¡Œã€‚\nå¯¹äºå¯é ç³»ç»Ÿè€Œè¨€ï¼Œå¯ä»¥ä½¿ç”¨SVCå¼‚å¸¸å®ç°èµ„æºçš„ç‰¹æƒè®¿é—®ï¼Œä½¿ç³»ç»Ÿæ›´åŠ å®‰å…¨ã€‚é€šè¿‡SVCç³»ç»Ÿè°ƒç”¨ç¼–å·èƒ½å¤Ÿå®ç°å‚æ•°ä¼ é€’ï¼Œä»è€Œå®ç°ä¸åŒåŠŸèƒ½çš„ç³»ç»ŸæœåŠ¡ã€‚ä½¿ç”¨ç³»ç»ŸæœåŠ¡å¯ä»¥ä¸éœ€è¦çŸ¥é“å…·ä½“æœåŠ¡å‡½æ•°çš„åœ°å€ï¼Œè¿™æ ·èƒ½å¤Ÿéšè—æ›´å¤šçš„ç»†èŠ‚ï¼Œé™ä½è½¯ä»¶é—´çš„è€¦åˆæ€§ã€‚\nåœ¨ARMå¼€å‘å·¥å…·é“¾ä¸‹ï¼Œæœ‰æ¯”è¾ƒä¼˜é›…çš„æ–¹å¼ç›´æ¥ä½¿ç”¨SVCå¼‚å¸¸ï¼Œåœ¨GCCä¸‹éœ€è¦é…åˆæ±‡ç¼–æ¥ä½¿ç”¨ã€‚\nè¿™é‡Œä¸è®¨è®ºARMå¤„ç†å™¨å¯¹äºå¼‚å¸¸çš„å¤„ç†æœºåˆ¶ï¼Œå®ƒåœ¨è§¦å‘SVCæŒ‡ä»¤åå“åº”çš„å¼‚å¸¸è¡Œä¸ºä¸ç³»ç»Ÿä¸­å…¶å®ƒå¼‚å¸¸æ˜¯ä¸€è‡´çš„ã€‚\nSVCå¼‚å¸¸å¤„ç†  .syntax unified  .thumb  .global SVC_Handler  .global SVC_VIRTUAL_CALL_0  .global SVC_VIRTUAL_CALL_1  .global SVC_VIRTUAL_CALL_2  .global SVC_VIRTUAL_CALL_3  .type SVC_Handler, %function  .type SVC_VIRTUAL_CALL_0, %function  .type SVC_VIRTUAL_CALL_1, %function  .type SVC_VIRTUAL_CALL_2, %function  .type SVC_VIRTUAL_CALL_3, %functionSVC_Handler:  tst lr, #4  ite eq  mrseq r0, msp  mrsne r0, psp  push &#123;r6, r7, lr&#125;  mov r7, r0  ldr r0, [r7, #0]     //åŸå§‹R0  ldr r1, [r7, #4]  ldr r2, [r7, #8]  ldr r3, [r7, #12]  ldr r6, [r7, #24]    //svcæŒ‡ä»¤ç›¸å…³çš„pcåœ°å€  ldr r6, [r6, #-2]  and r6, #0xFF  ldr r12, =g_svc_vector  ldr r6, [r12, r6, lsl #2]  blx r6  str r0, [r7, #0]  pop &#123;r6, r7, pc&#125;Default_SVC_Handler:  bx lr  .align 2g_svc_vector:  .word SVC_HANDLER_0  .word SVC_HANDLER_1  .word SVC_HANDLER_2  .word SVC_HANDLER_3    .weak      SVC_HANDLER_0  .thumb_set SVC_HANDLER_0, Default_SVC_Handler  .weak      SVC_HANDLER_1  .thumb_set SVC_HANDLER_1, Default_SVC_Handler  .weak      SVC_HANDLER_2  .thumb_set SVC_HANDLER_2, Default_SVC_Handler  .weak      SVC_HANDLER_3  .thumb_set SVC_HANDLER_3, Default_SVC_HandlerSVC_VIRTUAL_CALL_0:    svc 0    bx lrSVC_VIRTUAL_CALL_1:    svc 1    bx lrSVC_VIRTUAL_CALL_2:    svc 2    bx lrSVC_VIRTUAL_CALL_3:    svc 3    bx lr\n\nSVC_Handlerå‡½æ•°æ˜¯å¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œè¿›å…¥å‡½æ•°ï¼Œåˆ¤æ–­LRå¯„å­˜å™¨æ¥åˆ†æè¿›å…¥å¼‚å¸¸å‰çš„ç¯å¢ƒï¼Œè·å–åˆ°å¯¹åº”çš„spåœ°å€ã€‚é€šè¿‡spå¯„å­˜å™¨å°±èƒ½è®¿é—®åˆ°æ ˆç©ºé—´ï¼Œåœ¨æ ˆä¸­å¯ä»¥è·å–åˆ°r0-r3ï¼Œè¿™ä¸ªå°±æ˜¯æ‰§è¡Œsvcæ—¶ä¼ è¿›æ¥çš„å‚æ•°ï¼Œé€šå¸¸è¿™4ä¸ªå¯„å­˜å™¨ä¸ä¼šè¢«ä¿®æ”¹ï¼Œé™¤éå‘ç”Ÿäº†æ›´é«˜ä¼˜å…ˆçº§çš„å¼‚å¸¸ã€‚é€šè¿‡åœ¨æ ˆä¸­è·å–åˆ°æ‰§è¡Œsvcçš„pcæŒ‡é’ˆï¼Œå¾—åˆ°svcæŒ‡ä»¤çš„äºŒè¿›åˆ¶ç ï¼Œä½8ä½å­˜å‚¨äº†æŒ‡ä»¤é™„åŠ çš„å¼‚å¸¸idï¼Œä½¿ç”¨è¯¥idåœ¨å†…éƒ¨é€šè¿‡æŸ¥è¡¨çš„æ–¹å¼å®šä½å…·ä½“éœ€è¦æ‰§è¡Œçš„å‡½æ•°å…¥å£ï¼Œæ‰§è¡ŒæŒ‡å®šçš„å‡½æ•°åï¼Œæˆ‘ä»¬å°†r0ä¹Ÿå°±æ˜¯è¿”å›å€¼å­˜å‚¨åˆ°æ ˆç©ºé—´ä¸­ï¼Œè¿™æ ·è¿”å›åˆ°ç”¨æˆ·æ€åï¼Œç”¨æˆ·å°±èƒ½è·å¾—æ‰§è¡Œç›®æ ‡å‡½æ•°åè¿”å›ç»“æœã€‚\nä¸ºäº†æ–¹ä¾¿å®šä¹‰ç”¨æˆ·ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œè®¾è®¡äº†è¿™æ ·çš„ä¸€ä¸ªå®ã€‚\n#define SVC_CALL_DEF(id, func, ret_t, ...) \\extern ret_t SVC_VIRTUAL_CALL_##id(__VA_ARGS__); \\ret_t SVC_HANDLER_##id(__VA_ARGS__)\nå…¶ä¸­idè¡¨ç¤ºè¯¥å‡½æ•°ç»‘å®šåˆ°svcçš„é‚£ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ä¸Šï¼Œfuncè¡¨ç¤ºå‡½æ•°åç§°ï¼Œret_tå’Œåé¢çš„å‚æ•°åˆ†åˆ«è¡¨ç¤ºå‡½æ•°çš„è¿”å›å€¼å’Œå½¢å‚åˆ—è¡¨ï¼Œå¦‚æœæ— å½¢å‚åˆ™å¡«å…¥voidã€‚é€šè¿‡ SVC_VIRTUAL_CALL_id()æ¥æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ã€‚\nè¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š\nSVC_CALL_DEF(1, test_svc_add, int, int a, int b)&#123;    return a + b;&#125;int main(void)&#123;    int ret = 0;    ret = SVC_VIRTUAL_CALL_1(2, 3);    printf(&quot;2+3 = %d\\r\\n&quot;, ret);    return 0;&#125;\n\nè¿›é˜¶å†™æ³•å‰é¢çš„å®šä¹‰æ–¹æ³•å’Œè°ƒç”¨æ–¹æ³•ä¸ä¼ ç»Ÿçš„Cè¯­è¨€å‡½æ•°å®šä¹‰å’Œå‡½æ•°è°ƒç”¨å­˜åœ¨åŒºåˆ«ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ä¸Šå­˜åœ¨ä¸æ–¹ä¾¿çš„åœ°æ–¹ï¼ŒæŒ‰ç…§ä¸‹é¢çš„å†™æ³•æ›´åŠ åˆç†ï¼Œä¸”å‡½æ•°è°ƒç”¨ä¸Cè¯­è¨€æ˜¯ä¸€è‡´çš„ï¼Œå‡ä½äº†ä»£ç ç§»æ¤ä¸Šçš„ä¸€è‡´æ€§é—®é¢˜ã€‚\n#ifndef __SVC_HANDER_H#define __SVC_HANDER_H#if defined(__GNUC__)#define DEF_SVC_FUNC(id, ret_t, name, ...) \\    ret_t name(__VA_ARGS__); \\    __asm__(        \\        &quot;.thumb\\n&quot;  \\        &quot;.global &quot; #name &quot;\\n&quot; \\        &quot;.type &quot; #name &quot;, %function\\n&quot; \\        #name &quot;:\\n&quot; \\        &quot;svc &quot; #id &quot;\\n&quot; \\        &quot;bx lr\\n&quot;); \\    ret_t SVC_HANDLER_##id(__VA_ARGS__)#elif defined(__CC_ARM)#define DEF_SVC_FUNC(id, ret_t, name, ...) \\    ret_t __svc(id) name(__VA_ARGS__)#else#define DEF_SVC_FUNC(id, ret_t, name, ...) \\    ret_t name(__VA_ARGS__)    // #warning &quot;not support SVC function!&quot;#endif#endif\n\næœ‰äº†è¿™ä¸ªå®å®šä¹‰åï¼Œå®šä¹‰ä¸€ä¸ªsvcå‡½æ•°ä»¥åŠå‡½æ•°çš„è°ƒç”¨å†™æ³•å°†å˜ä¸ºï¼š\nDEF_SVC_FUNC(2, int, add_func, int a, int b)&#123;    return a + b;&#125;int main(void)&#123;    int ret = 0;    ret = add_func(2, 3);    printf(&quot;2+3 = %d\\r\\n&quot;, ret);    return 0;&#125;\nè¿™æ ·çš„å†™æ³•èƒ½å¤Ÿå…¼å®¹ä¸åŒçš„ç¼–è¯‘å™¨ï¼Œä¸”ä¸ç”¨æå‰å®šä¹‰SVC_VIRTUAL_CALL_0å‡½æ•°ã€‚\n"},{"title":"PIOå‚è€ƒæ‰‹å†Œ","url":"/2025/03/08/PIO%E5%8F%82%E8%80%83%E6%89%8B%E5%86%8C/","content":"\næœ¬æ–‡åŸå§‹æ–‡æ¡£æ¥è‡ªäºRP2040å®˜æ–¹æ–‡æ¡£ï¼Œè¯¥è¯‘æ–‡å†…å®¹æºè‡ªäº’è”ç½‘ https://github.com/charlee/rp2040-pio-zhcnæœ¬æ–‡çš„ç¼–å†™é‡æ–°å‚è€ƒäº†æœ€æ–°çš„RP2350å®˜æ–¹æ–‡æ¡£ï¼Œæ›´æ–°å¹¶è¡¥å……äº†è®¸å¤šæ–°çš„å†…å®¹ï¼ŒåŒ…æ‹¬æ–°ç‰ˆæœ¬PIOçš„ç‰¹æ€§å’Œæ–°åŠ å…¥çš„ä¸€äº›æŒ‡ä»¤ç­‰ã€‚\n\nPIOæ¦‚è¦RP2040æœ‰ä¸¤ä¸ªå®Œå…¨ç›¸åŒçš„PIOæ¨¡å—ï¼ŒRP2350æœ‰3ä¸ªPIOæ¨¡å—ã€‚æ¯ä¸ªPIOå—éƒ½ç‹¬ç«‹è¿æ¥åˆ°æ€»çº¿ã€GPIOå’Œä¸­æ–­æ§åˆ¶å™¨ã€‚ä¸€ä¸ª PIO å—çš„ç»“æ„å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n\n\n\n\n\n\nå›¾38. PIOå—ç»“æ„å›¾ã€‚RP2040æœ‰ä¸¤ä¸ªPIOå—ï¼Œæ¯ä¸ªå—æœ‰å››ä¸ªçŠ¶æ€æœºã€‚å››ä¸ªçŠ¶æ€æœºå¯ä»¥ä»ä¸€ç‰‡å…±äº«æŒ‡ä»¤å†…å­˜ä¸­åŒæ—¶æ‰§è¡ŒæŒ‡ä»¤ã€‚FIFOæ•°æ®é˜Ÿåˆ—è´Ÿè´£åœ¨PIOå’Œç³»ç»Ÿä¹‹é—´ç¼“å†²ä¼ è¾“çš„æ•°æ®ã€‚æ¯ä¸ªçŠ¶æ€æœºå¯ä»¥é€šè¿‡GPIOæ˜ å°„é€»è¾‘ç›‘è§†å¹¶æ“ä½œæœ€å¤š30ä¸ªGPIOã€‚\n\n\nå¯ç¼–ç¨‹è¾“å…¥è¾“å‡ºå—ï¼ˆPIOï¼‰æ˜¯ä¸€ä¸ªéå¸¸çµæ´»çš„ç¡¬ä»¶æ¥å£ã€‚å®ƒèƒ½æ”¯æŒè®¸å¤šIOæ ‡å‡†ï¼Œä¾‹å¦‚ï¼š\n\n8080 å’Œ 6800 å¹¶è¡Œæ€»çº¿\nI2C\n3é’ˆI2S\nSDIO\nSPIã€DSPIã€QSPI\nUART\nDPI æˆ– VGAï¼ˆé€šè¿‡ç”µé˜»å¼DACï¼‰\n\nPIOçš„ç¼–ç¨‹æ–¹å¼ä¸å¤„ç†å™¨ç±»ä¼¼ã€‚æ¯ä¸ªPIOæœ‰å››ä¸ªçŠ¶æ€æœºï¼Œæ¯ä¸ªçŠ¶æ€æœºå¯ä»¥ç‹¬ç«‹æ‰§è¡Œé¡ºåºä»£ç ï¼Œæ“ä½œ GPIO å¹¶ä¼ è¾“æ•°æ®ã€‚ä½†ä¸åŒäºé€šç”¨å¤„ç†å™¨ï¼ŒPIO çŠ¶æ€æœºæ˜¯ä¸“é—¨ä¸ºè¾“å…¥è¾“å‡ºè®¾è®¡çš„ï¼Œå› æ­¤å…·æœ‰ç¡®å®šæ€§ã€ç²¾ç¡®çš„æ—¶é—´ï¼Œå¹¶ä¸å›ºå®šåŠŸèƒ½çš„ç¡¬ä»¶ç´§å¯†ç»“åˆã€‚\næ¯ä¸ªçŠ¶æ€æœºéƒ½æ‹¥æœ‰ä»¥ä¸‹å†…å®¹ï¼š\n\nä¸¤ä¸ª 32 ä½ç§»ä½å¯„å­˜å™¨ - å¯ä»¥å‘ä»»æ„æ–¹å‘ä½ç§»ä»»æ„æ¯”ç‰¹\nä¸¤ä¸ª 32 ä½å¯æ“¦å†™å¯„å­˜å™¨ï¼ˆscratch registorï¼‰\næ¯ä¸ªæ–¹å‘ä¸Šï¼ˆTX&#x2F;RXï¼‰éƒ½æœ‰ 4x32 ä½æ€»çº¿ FIFOï¼Œå¯ä»¥é‡æ–°é…ç½®ä¸ºå•å‘ 8x32 FIFO\næ”¯æŒå°æ•°çš„æ—¶é’Ÿåˆ†é¢‘å™¨ï¼ˆ16 ä½æ•´æ•°ï¼Œ8 ä½å°æ•°ï¼‰\nçµæ´»çš„ GPIO æ˜ å°„\nDMA æ¥å£ï¼Œæ¯ä¸ªæ—¶é’Ÿå‘¨æœŸæœ€å¤šå¯ä¼ è¾“æ¥è‡ªç³»ç»Ÿ DMA çš„ 1 ä¸ªå­—\nIRQ æ ‡å¿—è®¾ç½®&#x2F;æ¸…é™¤&#x2F;çŠ¶æ€æŸ¥è¯¢\n\næ¯ä¸ªçŠ¶æ€æœºåŠå…¶ç›¸å…³çš„ç¡¬ä»¶æ‰€å ç”¨çš„èŠ¯ç‰‡é¢ç§¯å¤§çº¦ç›¸å½“äºæ ‡å‡†çš„ä¸²è¡Œæ¥å£ï¼Œå¦‚ SPI æˆ– I2C æ§åˆ¶å™¨ç­‰ã€‚ä½†æ˜¯ï¼ŒPIO çŠ¶æ€æœºå¯ä»¥åŠ¨æ€é…ç½®æˆ–é‡æ–°é…ç½®ï¼Œå®ç°å¤šç§ä¸åŒçš„æ¥å£ã€‚\nçŠ¶æ€æœºèƒ½ç”¨è½¯ä»¶çš„å½¢å¼ç¼–ç¨‹ï¼Œç›¸æ¯”äºåƒ CPLD é‚£æ ·é‡‡ç”¨å®Œå…¨å¯é…ç½®çš„é€»è¾‘èŠ¯ç‰‡ï¼ŒPIOèƒ½åœ¨åŒæ ·çš„æˆæœ¬å’ŒåŠŸè€—ä¸‹æä¾›æ›´å¤šçš„ç¡¬ä»¶æ¥å£ã€‚å®ƒè¿˜å¸¦æ¥äº†äººä»¬æ›´ä¸ºç†Ÿæ‚‰çš„ç¼–ç¨‹æ¨¡å‹ï¼Œå’Œæ›´ç®€å•çš„å·¥å…·æµç¨‹ï¼Œå› æ­¤äººä»¬å¯ä»¥åˆ©ç”¨ PIO çš„çµæ´»æ€§ç›´æ¥è¿›è¡Œç¼–ç¨‹ï¼Œè€Œä¸éœ€è¦ä½¿ç”¨ PIO åº“ä¸­äº‹å…ˆå®šä¹‰å¥½çš„æ¥å£ã€‚\nPIO ä¸ä»…éå¸¸çµæ´»ï¼Œæ€§èƒ½è¿˜éå¸¸é«˜ï¼Œè¿™éƒ½è¦å½’åŠŸäºæ¯ä¸ªçŠ¶æ€æœºä¸­çš„å›ºå®šåŠŸèƒ½çš„ç¡¬ä»¶ã€‚åœ¨è¾“å‡º DPI æ—¶ï¼ŒPIO èƒ½å¤Ÿåœ¨ 48MHz ç³»ç»Ÿæ—¶é’Ÿçš„æ”¯æŒä¸‹ï¼Œåœ¨æ´»è·ƒçš„æ‰«æçº¿æœŸé—´æä¾› 360Mb&#x2F;s çš„ååé‡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸€ä¸ªçŠ¶æ€æœºè´Ÿè´£å¤„ç†å¸§å’Œæ‰«æçº¿çš„æ—¶é—´ï¼Œå¹¶ç”Ÿæˆåƒç´ æ—¶é’Ÿï¼Œå¦ä¸€ä¸ªè´Ÿè´£å¤„ç†åƒç´ æ•°æ®ï¼Œå¹¶è§£åŒ…è¡Œç¨‹ç¼–ç çš„æ‰«æçº¿ã€‚\nçŠ¶æ€æœºçš„è¾“å…¥å’Œè¾“å‡ºå¯ä»¥æ˜ å°„åˆ°æœ€å¤š 32 ä¸ª GPIO ä¸Šï¼ˆåœ¨ RP2040 ä¸­é™åˆ¶ä¸º 30 ä¸ª GPIOï¼‰ï¼Œæ‰€æœ‰çŠ¶æ€æœºéƒ½èƒ½ç‹¬ç«‹ã€åŒæ—¶è®¿é—®ä»»ä½• GPIOã€‚ä¾‹å¦‚ï¼Œæ ‡å‡†çš„ UART ä»£ç å…è®¸ TXã€RXã€CTS å’Œ RTS ä½¿ç”¨ä»»æ„å››ä¸ª GPIOï¼Œè€Œ I2C ä¹Ÿå…è®¸å°† SDA å’Œ SCL æ˜ å°„åˆ°ä»»æ„ GPIO ä¸Šã€‚å…·ä½“çš„è‡ªç”±åº¦å–å†³äº PIO ç¨‹åºä½¿ç”¨ PIO é’ˆè„šæ˜ å°„èµ„æºçš„æ–¹å¼ï¼Œä¸€ä¸ªæ¥å£å¯ä»¥åœ¨ä¸€å®šæ•°é‡çš„ GPIO èŒƒå›´å†…è‡ªç”±ç§»åŠ¨ã€‚\n3.2. PIOç¨‹åºå››ä¸ªçŠ¶æ€æœºæ‰§è¡Œå…±äº«æŒ‡ä»¤å†…å­˜çš„ç¨‹åºã€‚ç³»ç»Ÿè½¯ä»¶å°†å†…å­˜åŠ è½½è‡³è¯¥åŒºåŸŸï¼Œé…ç½®çŠ¶æ€æœºå’Œ IO æ˜ å°„ï¼Œç„¶åå°†çŠ¶æ€æœºè®¾ç½®ä¸ºè¿è¡ŒçŠ¶æ€ã€‚PIO ç¨‹åºå¯ä»¥æ¥è‡ªå¤šä¸ªåœ°æ–¹ï¼šå¯ä»¥ç”±ç”¨æˆ·ç›´æ¥æ±‡ç¼–ï¼Œå¯ä»¥æ¥è‡ª PIO åº“ï¼Œæˆ–è€…ç”±ç”¨æˆ·çš„è½¯ä»¶ç”Ÿæˆã€‚\nä¹‹åï¼ŒçŠ¶æ€æœºå°±ä¼šè‡ªåŠ¨è¿è¡Œï¼Œç³»ç»Ÿè½¯ä»¶é€šè¿‡ DMAã€ä¸­æ–­å’Œæ§åˆ¶å¯„å­˜å™¨ä¸ä¹‹äº¤äº’ï¼Œå°±åƒæ“ä½œ RP2040 ä¸Šçš„å…¶ä»–å¤–è®¾ä¸€æ ·ã€‚å¯¹äºæ›´å¤æ‚çš„æ¥å£ï¼ŒPIO æä¾›äº†ä¸€ä¸ªçŸ­å°çµæ´»çš„æŒ‡ä»¤é›†ï¼Œå¯ä»¥è®©ç³»ç»Ÿè½¯ä»¶æ›´æ·±å…¥åœ°æ“ä½œçŠ¶æ€æœºçš„æ§åˆ¶æµã€‚\n\n\n\n\n\n\n\nå›¾39. çŠ¶æ€æœºæ¦‚è§ˆã€‚æ•°æ®é€šè¿‡ä¸€å¯¹ FIFO è¾“å…¥è¾“å‡ºã€‚çŠ¶æ€æœºå¯ä»¥æ‰§è¡Œä¸€æ®µç¨‹åºï¼Œè®©è¿™äº› FIFOã€ä¸€ç³»åˆ—å†…éƒ¨å¯„å­˜å™¨å’Œç®¡è„šä¹‹é—´ä¼ è¾“æ•°æ®ã€‚æ—¶é’Ÿåˆ†é¢‘å™¨å¯ä»¥é™ä½çŠ¶æ€æœºçš„æ‰§è¡Œé€Ÿåº¦ã€‚\n\n\n3.2.1. PIOç¨‹åºPIO çŠ¶æ€æœºæ‰§è¡ŒçŸ­å°çš„äºŒè¿›åˆ¶ç¨‹åºã€‚\nPIO åº“æä¾›äº†åƒ UARTã€SPI æˆ– I2C ç­‰é€šç”¨æ¥å£çš„ç¨‹åºï¼Œå› æ­¤è®¸å¤šæƒ…å†µä¸‹ä¸éœ€è¦è‡ªå·±ç¼–å†™ PIO ç¨‹åºã€‚ä½†æ˜¯ï¼Œç›´æ¥å¯¹ PIO ç¼–ç¨‹å¯ä»¥å¸¦æ¥æ›´å¤§çš„çµæ´»æ€§ï¼Œæ”¯æŒè®¸å¤šè¿è®¾è®¡è€…éƒ½æ²¡æœ‰è€ƒè™‘ä¾›çš„æ¥å£ã€‚\nPIO ä¸€å…±æœ‰ä¹æ¡æŒ‡ä»¤ï¼šJMPã€WAITã€INã€OUTã€PUSHã€PULLã€MOVã€IRQ å’Œ SETã€‚å…³äºæ¯æ¡æŒ‡ä»¤çš„è¯¦ç»†ä¿¡æ¯è¯·å‚è§3.4èŠ‚ã€‚\nå°½ç®¡ PIO åªæœ‰ä¹æ¡æŒ‡ä»¤ï¼Œæ‰‹å·¥ç¼–å†™äºŒè¿›åˆ¶ PIO ç¨‹åºä¹Ÿéå¸¸å›°éš¾ã€‚PIO æ±‡ç¼–æ˜¯ç”¨æ–‡æœ¬å½¢å¼æè¿°çš„ PIO ç¨‹åºï¼Œæ¯æ¡å‘½ä»¤å¯¹åº”äºäºŒè¿›åˆ¶ç¨‹åºä¸­çš„ä¸€æ¡æŒ‡ä»¤ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ª PIO æ±‡ç¼–ç¨‹åºçš„ä¾‹å­ï¼š\nPico ç¤ºä¾‹ï¼šhttps://github.com/raspberrypi/pico-examples/tree/master/pio/squarewave/squarewave.pio ç¬¬7-12è¡Œ \n\n 7 .program squarewave 8     set pindirs, 1 ; Set pin to output 9 again:10     set pins, 1 [1] ; Drive pin high and then delay for one cycle11     set pins, 0 ; Drive pin low12     jmp again ; Set PC to label `again`\n\nSDK è‡ªå¸¦äº† PIO æ±‡ç¼–å™¨ï¼Œåä¸º pioasmã€‚è¯¥ç¨‹åºæ¥å—ä¸€ä¸ª PIO æ±‡ç¼–ç¨‹åºçš„æ–‡æœ¬æ–‡ä»¶ï¼Œå…¶ä¸­å¯ä»¥åŒ…å«å¤šä¸ªç¨‹åºï¼Œå¹¶è¾“å‡ºæ±‡ç¼–åçš„ç¨‹åºã€‚è¿™äº›æ±‡ç¼–åçš„ç¨‹åºä»¥ C å¤´æ–‡ä»¶çš„å½¢å¼è¾“å‡ºï¼Œå¤´æ–‡ä»¶ä¸­åŒ…å«äº†å¸¸é‡æ•°ç»„ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ3.3èŠ‚ã€‚\n3.2.2. æ§åˆ¶æµåœ¨æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œæ¯ä¸ªçŠ¶æ€æœºè·å–ã€è§£ç å¹¶æ‰§è¡Œä¸€æ¡æŒ‡ä»¤ã€‚æ¯ä¸ªæŒ‡ä»¤ç²¾ç¡®åœ°å ç”¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œé™¤éå®ƒæ˜¾å¼åœ°æš‚åœæ‰§è¡Œï¼ˆå¦‚ WAIT æŒ‡ä»¤ï¼‰ã€‚æ¯æ¡æŒ‡ä»¤è¿˜å¯ä»¥å¸¦æœ‰æœ€å¤š 31 ä¸ªå‘¨æœŸçš„å»¶æ—¶ï¼Œæ¨è¿Ÿä¸‹ä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œï¼Œç”¨äºç¼–å†™ç²¾ç¡®æ—¶é’Ÿå‘¨æœŸçš„ç¨‹åºã€‚\nç¨‹åºè®¡æ•°å™¨ PC æŒ‡å‘å½“å‰å‘¨æœŸæ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤çš„å†…å­˜åœ°å€ã€‚ä¸€èˆ¬è€Œè¨€ï¼ŒPC æ¯ä¸ªå‘¨æœŸåŠ ä¸€ï¼Œåˆ°è¾¾æŒ‡ä»¤å†…å­˜è¾¹ç•Œæ—¶è‡ªåŠ¨è¿”å›å¼€å¤´ã€‚è·³è½¬æŒ‡ä»¤æ˜¯ä¸€ä¸ªä¾‹å¤–ï¼Œå®ƒæ˜¾å¼æä¾›äº† PC çš„ä¸‹ä¸€ä¸ªå€¼ã€‚\nä¸Šä¸€èŠ‚çš„ç¤ºä¾‹æ±‡ç¼–ç¨‹åºï¼ˆå¼€å¤´ä¸º .program squarewaveï¼‰æ¼”ç¤ºäº†è¿™ä¸¤ä¸ªæ¦‚å¿µã€‚å®ƒåœ¨ä¸€ä¸ª GPIO å¼•è„šä¸Šäº§ç”Ÿå ç©ºæ¯”ä¸º 50% çš„æ–¹æ³¢ï¼Œæ¯ä¸ªå‘¨æœŸå ç”¨å››ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚é€šè¿‡å…¶ä»–æ‰‹æ®µï¼ˆå¦‚ side-setï¼‰å¯ä»¥å°†å‘¨æœŸç¼©çŸ­è‡³ä¸¤ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚\næ³¨æ„ï¼šSide-set å¯ä»¥è®©çŠ¶æ€æœºåœ¨æ‰§è¡Œä¸€æ¡æŒ‡ä»¤æ—¶ï¼Œé¡ºä¾¿è®¾ç½®å°‘é‡ GPIO çš„çŠ¶æ€ã€‚è¯¦ç»†æè¿°è¯·å‚è§3.5.1èŠ‚ã€‚\nç³»ç»Ÿå¯¹æŒ‡ä»¤å†…å­˜æ‹¥æœ‰åªå†™çš„æƒé™ï¼Œç”¨äºåŠ è½½ç¨‹åºï¼š\nPicoç¤ºä¾‹ï¼šhttps://github.com/raspberrypi/pico-examples/tree/master/pio/squarewave/squarewave.c ç¬¬34-38è¡Œ\n\n34     // Load the assembled program directly into the PIO&#x27;s instruction memory.35     // Each PIO instance has a 32-slot instruction memory, which all 4 state36     // machines can see. The system has write-only access.37     for (int i = 0; i &lt; count_of(squarewave_program_instructions); ++i)38         pio-&gt;instr_mem[i] = squarewave_program_instructions[i];\n\næ—¶é’Ÿåˆ†é¢‘å™¨å¯ä»¥æŒ‰ç…§å›ºå®šçš„æ¯”ä¾‹é™ä½çŠ¶æ€æœºçš„æ‰§è¡Œé€Ÿåº¦ï¼Œè¯¥æ¯”ä¾‹ç”¨ä¸€ä¸ª 16.8 çš„å®šç‚¹åˆ†æ•°è¡¨ç¤ºã€‚åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œå¦‚æœé‡‡ç”¨çš„æ—¶é’Ÿåˆ†å‰²å› å­ä¸º 2.5ï¼Œé‚£ä¹ˆæ–¹æ³¢çš„å‘¨æœŸå°±æ˜¯ 4 x 2.5 &#x3D; 10 ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚è¿™åœ¨éœ€è¦è®¾ç½® UART ç­‰ä¸²è¡Œæ¥å£çš„ç²¾ç¡®æ³¢ç‰¹ç‡æ—¶éå¸¸æœ‰ç”¨ã€‚\nPicoç¤ºä¾‹ï¼šhttps://github.com/raspberrypi/pico-examples/tree/master/pio/squarewave/squarewave.c ç¬¬42-47è¡Œ\n\n42     // Configure state machine 0 to run at sysclk/2.5. The state machines can43     // run as fast as one instruction per clock cycle, but we can scale their44     // speed down uniformly to meet some precise frequency target, e.g. for a45     // UART baud rate. This register has 16 integer divisor bits and 846     // fractional divisor bits.47     pio-&gt;sm[0].clkdiv = (uint32_t) (2.5f * (1 &lt;&lt; 16));\n\nä¸Šè¿°ä»£ç ç‰‡æ®µæ‰€åœ¨çš„æ•´ä¸ªç¨‹åºå¯ä»¥åœ¨ GPIO 0 ï¼ˆæˆ–ä»»ä½•ç®¡è„šï¼‰ä¸Šäº§ç”Ÿä¸€ä¸ª 12.5MHz çš„æ–¹æ³¢ã€‚æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ WAIT PIN æŒ‡ä»¤æ ¹æ®ç®¡è„šçŠ¶æ€ç­‰å¾…ä¸€å®šæ—¶é—´ï¼Œæˆ–ä½¿ç”¨ JMP PIN æŒ‡ä»¤æ ¹æ®ç®¡è„šçŠ¶æ€è·³è½¬ï¼Œå®ç°æ ¹æ®ç®¡è„šçŠ¶æ€æ”¹å˜æ§åˆ¶æµã€‚\nPicoç¤ºä¾‹ï¼šhttps://github.com/raspberrypi/pico-examples/tree/master/pio/squarewave/squarewave.c ç¬¬51-59è¡Œ \n\n51     // There are five pin mapping groups (out, in, set, side-set, jmp pin)52     // which are used by different instructions or in different circumstances.53     // Here we&#x27;re just using SET instructions. Configure state machine 0 SETs54     // to affect GPIO 0 only; then configure GPIO0 to be controlled by PIO0,55     // as opposed to e.g. the processors.56     pio-&gt;sm[0].pinctrl =57         (1 &lt;&lt; PIO_SM0_PINCTRL_SET_COUNT_LSB) |58         (0 &lt;&lt; PIO_SM0_PINCTRL_SET_BASE_LSB);59     gpio_set_function(0, GPIO_FUNC_PIO0);\n\nç³»ç»Ÿå¯ä»¥é€šè¿‡ CTRL å¯„å­˜å™¨åœ¨ä»»æ„æ—¶é—´å¯åŠ¨æˆ–åœæ­¢ä»»æ„çŠ¶æ€æœºã€‚å¤šä¸ªçŠ¶æ€æœºå¯ä»¥åŒæ—¶å¯åŠ¨ï¼Œè€Œ PIO çš„ç¡®å®šæ€§èƒ½ä¿è¯å®ƒä»¬ä¹‹é—´çš„å®Œç¾åŒæ­¥ã€‚\nPicoç¤ºä¾‹ï¼šhttps://github.com/raspberrypi/pico-examples/tree/master/pio/squarewave/squarewave.c ç¬¬63-67è¡Œ\n\n63     // Set the state machine running. The PIO CTRL register is global within a64     // PIO instance, so you can start/stop multiple state machines65     // simultaneously. We&#x27;re using the register&#x27;s hardware atomic set alias to66     // make one bit high without doing a read-modify-write on the register.67     hw_set_bits(&amp;pio-&gt;ctrl, 1 &lt;&lt; (PIO_CTRL_SM_ENABLE_LSB + 0));\n\nå¤§å¤šæ•°æŒ‡ä»¤éƒ½æ¥è‡ªæŒ‡ä»¤å†…å­˜ï¼Œä½†æŒ‡ä»¤ä¹Ÿå¯ä»¥æ¥è‡ªå…¶ä»–åœ°æ–¹ï¼Œå¹¶ä¸”å¯ä»¥æ··åˆä½¿ç”¨ï¼š\n\nå†™å…¥ç‰¹æ®Šé…ç½®å¯„å­˜å™¨ï¼ˆSMx INSTRï¼‰çš„æŒ‡ä»¤ä¼šç«‹å³æ‰§è¡Œï¼Œä¸­æ–­å…¶ä»–æŒ‡ä»¤çš„æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œå†™å…¥ SMx INSTR çš„ä¸€æ¡ JMP æŒ‡ä»¤ä¼šè®©çŠ¶æ€æœºç«‹å³ä»å¦ä¸€ä¸ªä½ç½®å¼€å§‹æ‰§è¡Œã€‚\nä½¿ç”¨ MOV EXEC æŒ‡ä»¤ï¼Œå¯ä»¥ä»å¯„å­˜å™¨æ‰§è¡ŒæŒ‡ä»¤ã€‚\nä½¿ç”¨ OUT EXEC æŒ‡ä»¤ï¼Œå¯ä»¥ä»è¾“å‡ºç§»ä½å¯„å­˜å™¨ä¸­æ‰§è¡ŒæŒ‡ä»¤ã€‚\n\nåé¢å‡ ç§æ–¹å¼éå¸¸çµæ´»ï¼šæŒ‡ä»¤å¯ä»¥åµŒå…¥åˆ°ä¼ é€’ç»™ FIFO çš„æ•°æ®æµä¸­ã€‚I2C çš„ç¤ºä¾‹å°±åœ¨æ­£å¸¸çš„æ•°æ®ä¸­åµŒå…¥äº† STOP å’Œ RESTART ç­‰çš„æ¡ä»¶ã€‚å¯¹äº MOV å’Œ OUT EXEC æ¥è¯´ï¼ŒMOV &#x2F; OUT æœ¬èº«éœ€è¦ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œç„¶åå†æ‰§è¡ŒæŒ‡å®šçš„æŒ‡ä»¤ã€‚\n3.2.3. å¯„å­˜å™¨æ¯ä¸ªçŠ¶æ€æœºéƒ½æ‹¥æœ‰å‡ ä¸ªå†…éƒ¨å¯„å­˜å™¨ã€‚è¿™äº›å¯„å­˜å™¨ç”¨äºä¿å­˜è¾“å…¥æˆ–è¾“å‡ºæ•°æ®ï¼Œä»¥åŠå¾ªç¯å˜é‡ç­‰ä¸´æ—¶æ•°æ®ã€‚\n3.2.3.1. è¾“å‡ºç§»ä½å¯„å­˜å™¨ï¼ˆOSRï¼‰\n\n\n\n\n\n\nå›¾40. è¾“å‡ºç§»ä½å¯„å­˜å™¨ï¼ˆOSRï¼‰ã€‚æ•°æ®æ¯æ¬¡å¯ä»¥å¹¶è¡Œè¾“å‡º 1 ~ 32 æ¯”ç‰¹ï¼Œæœªä½¿ç”¨çš„æ•°æ®ç”±ä¸€ä¸ªåŒæ–¹å‘ç§»ä½å™¨è´Ÿè´£å›æ”¶ã€‚å½“ OSR å¯„å­˜å™¨ä¸ºç©ºæ—¶ï¼Œå®ƒä¼šä» TX FIFO ä¸­åŠ è½½æ•°æ®ã€‚\n\n\nè¾“å‡ºç§»ä½å¯„å­˜å™¨ï¼ˆOSRï¼‰è´Ÿè´£å­˜å‚¨åœ¨ TX FIFO å’Œç®¡è„šï¼ˆæˆ–å…¶ä»–ç›®çš„åœ°ï¼Œå¦‚å¯æ“¦å†™å¯„å­˜å™¨ï¼‰ä¹‹é—´ç§»ä½è¾“å‡ºæ•°æ®ã€‚\n\nPULL æŒ‡ä»¤ï¼šä» TX FIFO ä¸­ç§»é™¤ä¸€ä¸ª 32 ä½å­—å¹¶ç½®äº OSR ä¸­ã€‚\nOUT æŒ‡ä»¤å°† OSR ä¸­çš„æ•°æ®ç§»ä½è‡³å…¶ä»–ç›®çš„åœ°ï¼Œä¸€æ¬¡å¯ç§»ä½ 1 ~ 32 æ¯”ç‰¹ã€‚\nå½“æ•°æ®è¢«ç§»ä½å‡ºåï¼ŒOSR ä¼šå¡«å……ä¸ºé›¶ã€‚\nå¦‚æœå¯ç”¨è‡ªåŠ¨åŠ è½½ï¼ˆautopullï¼‰ï¼Œé‚£ä¹ˆåœ¨è¾¾åˆ°æŸä¸ªç§»ä½é˜ˆå€¼æ—¶ï¼ŒçŠ¶æ€æœºä¼šåœ¨æ‰§è¡Œ OUT æŒ‡ä»¤æ—¶ï¼Œè‡ªåŠ¨ä» FIFO åŠ è½½æ•°æ®åˆ° OSRã€‚\nç§»ä½æ–¹å‘å¯ä»¥æ˜¯å·¦æˆ–å³ï¼Œç”±å¤„ç†å™¨é€šè¿‡é…ç½®å¯„å­˜å™¨è¿›è¡Œè®¾ç½®ã€‚\n\nä¾‹å¦‚ï¼Œä»¥æ¯ä¸¤ä¸ªæ—¶é’Ÿå‘¨æœŸä¸€ä¸ªå­—èŠ‚çš„é€Ÿç‡ï¼Œå°†æ•°æ®é€šè¿‡ FIFO ä¼ è¾“åˆ°ç®¡è„šï¼š\n1 .program pull_example12 loop:3     out pins, 84 public entry_point:5     pull6     out pins, 8 [1]7     out pins, 8 [1]8     out pins, 89     jmp loop\n\nåœ¨ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡è‡ªåŠ¨åŠ è½½ï¼ˆautopullï¼Œå‚è§3.5.4èŠ‚ï¼‰åŠŸèƒ½ï¼Œå½“çŠ¶æ€æœºè¯•å›¾åœ¨ç©ºçš„ OSR ä¸Šæ‰§è¡Œ OUT æŒ‡ä»¤æ—¶ï¼Œç”±ç¡¬ä»¶è‡ªåŠ¨å¡«å…… OSRã€‚è¿™æ ·åšæœ‰ä¸¤ä¸ªå¥½å¤„ï¼š\n\nèŠ‚çœä¸€æ¡ä» FIFO åŠ è½½æ•°æ®çš„æŒ‡ä»¤\nå®ç°æ›´é«˜çš„ååé‡ï¼Œåªè¦ FIFO æœ‰æ•°æ®ï¼Œå°±èƒ½ä»¥æ¯æ—¶é’Ÿå‘¨æœŸæœ€é«˜ 32 æ¯”ç‰¹çš„æ•°æ®è¾“å‡º\n\né…ç½®å¥½è‡ªåŠ¨åŠ è½½åï¼Œä¸Šè¿°ç¨‹åºå¯ä»¥ç®€åŒ–å¦‚ä¸‹ï¼Œå…¶è¡Œä¸ºå®Œå…¨ç›¸åŒï¼š\n1 .program pull_example22 3 loop:4     out pins, 85 public entry_point:6     jmp loop\n\né€šè¿‡ç¨‹åºæŠ˜è¿”åŠŸèƒ½ï¼ˆprogram wrappingï¼Œå‚è§3.5.2èŠ‚ï¼‰è¿˜å¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–ç¨‹åºï¼Œå®ç°æ¯ä¸ªç³»ç»Ÿæ—¶é’Ÿå‘¨æœŸè¾“å‡º 1 å­—èŠ‚ã€‚\n1 .program pull_example32 3 public entry_point:4 .wrap_target5     out pins, 8 [1]6 .wrap\n\n3.2.3.2. è¾“å…¥ç§»ä½å¯„å­˜å™¨ï¼ˆISRï¼‰\n\n\n\n\n\n\nå›¾41. è¾“å…¥ç§»ä½å¯„å­˜å™¨ï¼ˆISRï¼‰ã€‚æ•°æ®æ¯æ¬¡è¿›å…¥ 1 ~ 32 æ¯”ç‰¹ï¼Œå½“å‰å†…å®¹ä¼šå·¦ç§»æˆ–å³ç§»ï¼Œä»¥è…¾å‡ºç©ºé—´ã€‚å½“å¯„å­˜å™¨æ»¡æ—¶ï¼Œå†…å®¹ä¼šè¢«å†™å…¥ RX FIFOã€‚\n\n\n\nIN æŒ‡ä»¤æ¯æ¬¡å°† 1 ~ 32 æ¯”ç‰¹çš„æ•°æ®ç§»ä½è¿›å¯„å­˜å™¨ã€‚\nPUSH æŒ‡ä»¤å°† ISR çš„å†…å®¹å†™å…¥ RX FIFOã€‚\næ‰§è¡Œæ¨å‡ºï¼ˆpushï¼‰æ—¶ï¼ŒISR çš„å†…å®¹è¢«æ¸…é›¶ã€‚\nå¦‚æœè®¾ç½®äº†è‡ªåŠ¨æ¨å‡ºï¼ˆautopushï¼‰ï¼Œé‚£ä¹ˆå½“è¾¾åˆ°æŸä¸ªç§»ä½é˜ˆå€¼æ—¶ï¼ŒçŠ¶æ€æœºä¼šåœ¨æ‰§è¡Œ IN æŒ‡ä»¤æ—¶è‡ªåŠ¨å°† ISR çš„å†…å®¹æ¨å‡ºã€‚\nç§»ä½æ–¹å‘å¯ä»¥ç”±å¤„ç†å™¨é€šè¿‡é…ç½®å¯„å­˜å™¨è¿›è¡Œè®¾ç½®ã€‚\n\n3.2.3.3. ç§»ä½è®¡æ•°å™¨çŠ¶æ€æœºä¼šè®°å½•æ€»å…±æœ‰å¤šå°‘æ¯”ç‰¹é€šè¿‡ OUT æŒ‡ä»¤ç§»å‡ºäº† OSR å¯„å­˜å™¨ï¼Œä»¥åŠé€šè¿‡ IN æŒ‡ä»¤ç§»å…¥äº† ISRã€‚è¿™ä¸ªä¿¡æ¯ç”±ä¸€å¯¹ç¡¬ä»¶è®¡æ•°å™¨è´Ÿè´£è·Ÿè¸ªï¼Œå³è¾“å‡ºç§»ä½è®¡æ•°å™¨å’Œè¾“å…¥ç§»ä½è®¡æ•°å™¨ï¼Œæ¯ä¸ªè®¡æ•°å™¨å¯ä»¥ä¿å­˜æ•°å­— 0 åˆ° 32ï¼ˆåŒ…å« 0 å’Œ 32ï¼‰ã€‚åœ¨æ¯æ¬¡ç§»ä½æ“ä½œåï¼Œç›¸åº”çš„è®¡æ•°å™¨ä¼šå¢åŠ ç§»ä½æ•°é‡ï¼Œæœ€å¤šå¢åŠ  32ï¼ˆç­‰äºç§»ä½å¯„å­˜å™¨çš„å®½åº¦ï¼‰ã€‚å¯ä»¥å¯¹çŠ¶æ€æœºè¿›è¡Œé…ç½®ï¼Œåœ¨æŸä¸ªè®¡æ•°å™¨è¾¾åˆ°ä¸€å®šé˜ˆå€¼åè‡ªåŠ¨æ‰§è¡Œä¸‹åˆ—æŸä¸ªåŠ¨ä½œï¼š\n\nå½“ç‰¹å®šæ•°é‡çš„æ¯”ç‰¹è¢«ç§»å‡ºåï¼Œè‡ªåŠ¨åŠ è½½ OSRã€‚å‚è§3.5.4èŠ‚\nå½“ç‰¹å®šæ•°é‡çš„æ¯”ç‰¹è¢«ç§»å…¥åï¼Œè‡ªåŠ¨æ¸…ç©º ISRã€‚å‚è§3.5.4èŠ‚\nPUSH æˆ– PULL æŒ‡ä»¤æ ¹æ®è¾“å…¥æˆ–è¾“å‡ºç§»ä½è®¡æ•°å™¨çš„æ¡ä»¶è‡ªåŠ¨æ‰§è¡Œ\n\nåœ¨ PIO å¤ä½æ—¶ï¼Œæˆ–åœ¨ CTRL_SM_RESTART æ—¶ï¼Œè¾“å…¥ä¸€ä½è®¡æ•°å™¨è¢«æ¸…ä¸º 0ï¼ˆè¡¨ç¤ºæ²¡æœ‰ä»»ä½•æ¯”ç‰¹è¢«ç§»å…¥ï¼‰ï¼Œè¾“å‡ºç§»ä½å¯„å­˜å™¨è¢«åˆå§‹åŒ–ä¸º 32ï¼ˆè¡¨ç¤ºå…¨ç©ºï¼Œæ²¡æœ‰ä»»ä½•ç­‰å¾…ç§»å‡ºçš„æ¯”ç‰¹ï¼‰ã€‚å½±å“ç§»ä½è®¡æ•°å™¨çš„å…¶ä»–æŒ‡ä»¤åŒ…æ‹¬ï¼š\n\næˆåŠŸçš„ PULL ä¼šå°†è¾“å‡ºç§»ä½è®¡æ•°å™¨æ¸…ä¸º 0\næˆåŠŸçš„ PUSH ä¼šå°†è¾“å…¥ç§»ä½è®¡æ•°å™¨æ¸…ä¸º 0\nMOV OSR, ... ï¼ˆå³ä»»ä½•å†™å…¥ OSR çš„ MOV æŒ‡ä»¤ï¼‰ä¼šå°†è¾“å‡ºç§»ä½è®¡æ•°å™¨æ¸…ä¸º 0\nMOV ISR, ... ï¼ˆå³ä»»ä½•å†™å…¥ ISR çš„ MOV æŒ‡ä»¤ï¼‰ä¼šå°†è¾“å…¥ç§»ä½è®¡æ•°å™¨æ¸…ä¸º 0\nOUT ISR, count å°†è¾“å…¥ç§»ä½è®¡æ•°å™¨è®¾ç½®ä¸º count\n\n3.2.3.4. å¯æ“¦å†™å¯„å­˜å™¨æ¯ä¸ªçŠ¶æ€æœºæœ‰ä¸¤ä¸ª 32 ä½å†…éƒ¨å¯æ“¦å†™è®¡æ•°å™¨ï¼ˆscratch registorï¼‰ï¼Œåä¸º X å’Œ Yã€‚\nå®ƒä»¬å¯ä»¥ç”¨äºï¼š\n\nIN&#x2F;OUT&#x2F;SET&#x2F;MOVæŒ‡ä»¤çš„æºæˆ–ç›®çš„åœ°\nåˆ†æ”¯æ¡ä»¶çš„æº\n\nä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬è¦ä¸ºæ¯”ç‰¹ â€œ1â€ äº§ç”Ÿä¸€ä¸ªé•¿è„‰å†²ï¼Œä¸ºæ¯”ç‰¹ â€œ0â€ äº§ç”Ÿä¸€ä¸ªçŸ­è„‰å†²ï¼š\n 1 .program ws2812_led 2  3 public entry_point: 4     pull 5     set x, 23       ; Loop over 24 bits 6 bitloop: 7     set pins, 1     ; Drive pin high 8     out y, 1 [5]    ; Shift 1 bit out, and write it to y 9     jmp !y skip     ; Skip the extra delay if the bit was 010     nop [5]11 skip:12     set pins, 0 [5]13     jmp x-- bitloop ; Jump if x nonzero, and decrement x14     jmp entry_point\n\nè¿™é‡Œ X æ˜¯å¾ªç¯è®¡æ•°å™¨ï¼ŒY æ˜¯ä¸´æ—¶å˜é‡ï¼Œæ ¹æ®æ¥è‡ª OSR çš„ä¸€ä¸ªæ¯”ç‰¹è¿›è¡Œåˆ†æ”¯ã€‚è¯¥ç¨‹åºå¯ä»¥ç”¨æ¥é©±åŠ¨ WS2812 LED æ¥å£ï¼Œä¸è¿‡è¯¥ç¨‹åºè¿˜å¯ä»¥å†™å¾—æ›´ç´§å‡‘ï¼ˆæœ€å°‘åªéœ€è¦ä¸‰æ¡æŒ‡ä»¤ï¼‰ã€‚\né€šè¿‡ MOV æŒ‡ä»¤ï¼Œå¯æ“¦å†™å¯„å­˜å™¨å¯ä»¥ç”¨æ¥ä¿å­˜æˆ–æ¢å¤ç§»ä½å¯„å­˜å™¨ï¼Œå¯ä»¥ç”¨äºé‡å¤ç§»å‡ºåŒæ ·çš„åºåˆ—ç­‰æƒ…å†µã€‚\næ³¨æ„ï¼šæ›´ç´§å‡‘çš„ WS2812 ç¤ºä¾‹ï¼ˆå…±å››æ¡æŒ‡ä»¤ï¼‰å‚è§3.6.2èŠ‚ã€‚\n3.2.3.5. FIFOæ¯ä¸ªçŠ¶æ€æœºéƒ½æ‹¥æœ‰ä¸€å¯¹ 4 å­—æ·±çš„ FIFOï¼Œä¸€ä¸ªç”¨äºå°†æ•°æ®ä»ç³»ç»Ÿä¼ è¾“åˆ°çŠ¶æ€æœºï¼ˆTXï¼‰ï¼Œå¦ä¸€ä¸ªç”¨äºå°†æ•°æ®ä»çŠ¶æ€æœºä¼ è¾“è‡³ç³»ç»Ÿï¼ˆRXï¼‰ã€‚TX FIFO ç”±æ€»çº¿ç®¡ç†è€…ï¼ˆå¦‚å¤„ç†å™¨æˆ– DMA æ§åˆ¶å™¨ï¼‰è´Ÿè´£å†™å…¥ï¼Œè€Œ RX FIFO ç”±çŠ¶æ€æœºå†™å…¥ã€‚FIFO è§£è€¦åˆäº† PIO çŠ¶æ€æœºå’Œç³»ç»Ÿæ€»çº¿ä¹‹é—´çš„æ—¶åºï¼Œè®©çŠ¶æ€æœºåœ¨æ²¡æœ‰å¤„ç†å™¨ä»‹å…¥çš„æƒ…å†µä¸‹å·¥ä½œæ›´é•¿æ—¶é—´ã€‚\nFIFO è¿˜ä¼šç”Ÿæˆæ•°æ®è¯·æ±‚ä¿¡å·ï¼ˆDREQï¼‰ï¼Œç³»ç»Ÿçš„ DMA æ§åˆ¶å™¨å¯ä»¥å€ŸåŠ©æ­¤ä¿¡å·ï¼Œæ ¹æ® RX FIFO ä¸­çš„æ•°æ®æƒ…å†µï¼Œæˆ– TX FIFO ä¸­çš„ç©ºé—²ç©ºé—´æƒ…å†µï¼Œé‡‡å–é€‚å½“çš„è¯»å†™èŠ‚å¥ã€‚å› æ­¤ï¼Œå¤„ç†å™¨å¯ä»¥è®¾ç½®æ›´é•¿çš„äº‹åŠ¡ï¼Œæ¯”å¦‚å…è®¸åœ¨æ²¡æœ‰å¤„ç†å™¨ä»‹å…¥çš„æƒ…å†µä¸‹ä¼ è¾“å‡  K å­—èŠ‚çš„æ•°æ®ã€‚\né€šå¸¸ï¼Œä¸€ä¸ªçŠ¶æ€æœºåªéœ€è¦å•æ–¹å‘ä¼ é€’æ•°æ®ã€‚æ­¤æ—¶ï¼ŒSHIFTCTRL_FJOIN é€‰é¡¹å¯ä»¥å°†ä¸¤ä¸ª FIFOåˆå¹¶æˆä¸€ä¸ª 8 å­—æ·±çš„å•å‘ FIFOã€‚è¿™ä¸ªç‰¹æ€§å¯ä»¥ç”¨äºé«˜å¸¦å®½çš„æ¥å£ï¼Œå¦‚ DPIã€‚\n3.2.4. ç­‰å¾…çŠ¶æ€çŠ¶æ€æœºå¯èƒ½ç”±äºå¤šç§åŸå› æš‚åœæ‰§è¡Œï¼š\n\nWAIT æŒ‡ä»¤çš„æ¡ä»¶æœªæ»¡è¶³\né˜»å¡çš„ PULL æŒ‡ä»¤é‡åˆ° TX FIFO ä¸ºç©ºçš„æƒ…å†µï¼Œæˆ–é˜»å¡çš„ PUSH æŒ‡ä»¤é‡åˆ° RX FIFO ä¸ºæ»¡çš„æƒ…å†µ\nIRQ WAIT æŒ‡ä»¤è®¾ç½®äº† IRQ æ ‡å¿—ï¼Œç­‰å¾…å…¶æ¸…ç©º\nOUT æŒ‡ä»¤é‡åˆ°å¯ç”¨äº†è‡ªåŠ¨åŠ è½½ï¼ŒOSR è¾¾åˆ°ç§»ä½é˜ˆå€¼ï¼Œä¸” TX FIFO ä¸ºç©ºçš„æƒ…å†µ\nIN æŒ‡ä»¤é‡åˆ°å¯ç”¨äº†è‡ªåŠ¨æ¨å‡ºï¼ŒISR è¾¾åˆ°ä»¥ä¸ºé¢„åˆ¶ï¼Œä¸” RX FIFO ä¸ºæ»¡çš„æƒ…å†µ\n\næ­¤æ—¶ï¼Œç¨‹åºè®¡æ•°å™¨ä¸ä¼šå¢åŠ ï¼ŒçŠ¶æ€æœºä¼šåœ¨ä¸‹ä¸€ä¸ªå‘¨æœŸç»§ç»­æ‰§è¡Œå½“å‰æŒ‡ä»¤ã€‚å¦‚æœæŒ‡ä»¤å¸¦æœ‰ä¸€å®šæ•°é‡çš„å»¶æ—¶ï¼Œé‚£ä¹ˆåœ¨æš‚åœæ‰§è¡ŒçŠ¶æ€è§£é™¤ä¹‹å‰ï¼Œå»¶æ—¶ä¸ä¼šè¢«æ‰§è¡Œã€‚\næ³¨æ„ï¼šSide-setï¼ˆå‚è§3.5.1èŠ‚ï¼‰ä¸å—æš‚åœæ‰§è¡Œçš„å½±å“ï¼Œæ°¸è¿œå‘ç”Ÿåœ¨æ‰€å±æŒ‡ä»¤çš„ç¬¬ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚\n3.2.5. ç®¡è„šæ˜ å°„PIO å¯ä»¥æ§åˆ¶æœ€å¤š 32 ä¸ª GPIO çš„è¾“å‡ºç”µå¹³å’Œæ–¹å‘ï¼Œä»¥åŠè§‚å¯Ÿå®ƒä»¬çš„è¾“å…¥ç”µå¹³ã€‚åœ¨æ¯ä¸ªç³»ç»Ÿæ—¶é’Ÿå‘¨æœŸï¼Œæ¯ä¸ªçŠ¶æ€æœºå¯ä»¥è¿›è¡Œé›¶ä¸ªã€ä¸€ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸‹æ“ä½œï¼š\n\né€šè¿‡ä¸€æ¡ OUT æˆ– SET æŒ‡ä»¤æ”¹å˜æŸäº› GPIO çš„ç”µå¹³æˆ–æ–¹å‘ï¼Œæˆ–é€šè¿‡ä¸€æ¡ IN æŒ‡ä»¤è¯»å–æŸäº› GPIO\né€šè¿‡ä¸€ä¸ª side-set æ“ä½œæ”¹å˜æŸäº› GPIO çš„ç”µå¹³æˆ–æ–¹å‘\n\næ¯ä¸ªæ“ä½œéƒ½å¯ä»¥æŒ‡å®šè¿ç»­çš„ä¸€æ®µ GPIO ç®¡è„šï¼Œç®¡è„šæ•°é‡å’Œèµ·å§‹ç®¡è„šç”±æ¯ä¸ªçŠ¶æ€æœºçš„ PINCTRL å¯„å­˜å™¨æ§åˆ¶ã€‚å…±å¯ä»¥è®¾å®šå››ä¸ªèŒƒå›´ï¼Œåˆ†åˆ«ç”¨äº OUTã€SETã€IN å’Œ side-set æ“ä½œã€‚æ¯ä¸ªèŒƒå›´å¯ä»¥è¦†ç›–ç»™å®š PIO å—å†…çš„ä»»æ„æ•°é‡çš„ GPIO ï¼ˆåœ¨ RP2040 ä¸Šä¸º 30 ä¸ªç”¨æˆ·å®šä¹‰ GPIOï¼‰ï¼Œè€Œä¸”è¿™äº›èŒƒå›´ä¹‹é—´å¯ä»¥é‡å ã€‚\nå¯¹äºæ¯æ¬¡ GPIO è¾“å‡ºï¼ˆç”µå¹³å’Œæ–¹å‘åˆ†åˆ«è€ƒè™‘ï¼‰ï¼ŒPIO ä¼šè€ƒè™‘è¯¥æ—¶é’Ÿå‘¨æœŸå†…å‘ç”Ÿçš„æ‰€æœ‰ 8 ä¸ªå†™å…¥æ“ä½œï¼Œå¹¶ä»ç¼–å·æœ€å¤§çš„çŠ¶æ€æœºå¼€å§‹åº”ç”¨å†™å…¥æ“ä½œã€‚å¦‚æœåŒä¸€ä¸ªçŠ¶æ€æœºåœ¨åŒä¸€ä¸ª GPIO ä¸ŠåŒæ—¶æ‰§è¡Œ SET&#x2F;OUT å’Œ side-set æ“ä½œï¼Œåˆ™é‡‡ç”¨ side-setã€‚å¦‚æœæ²¡æœ‰ä»»ä½•çŠ¶æ€æœºå†™å…¥æŸä¸ª GPIO è¾“å‡ºï¼Œåˆ™å…¶å€¼ä¿æŒå‰ä¸€ä¸ªå‘¨æœŸçš„å€¼ä¸å˜ã€‚\nä¸€èˆ¬è€Œè¨€ï¼Œæ¯ä¸ªçŠ¶æ€æœºçš„è¾“å‡ºè¢«æ˜ å°„åˆ°ä¸åŒçš„ GPIO ç»„ä¸Šï¼Œä»è€Œå®ç°æŸç§å¹¶è¡Œæ¥å£ã€‚\n3.2.6 IRQ æ ‡å¿—IRQ æ ‡å¿—æ˜¯å¯ä»¥ç”±çŠ¶æ€æœºæˆ–ç³»ç»Ÿè¿›è¡Œè®¾ç½®æˆ–æ¸…é™¤çš„çŠ¶æ€ä½ã€‚å…±æœ‰ 8 ä¸ªæ ‡å¿—ï¼Œå…¨éƒ¨å¯¹æ‰€æœ‰çŠ¶æ€æœºå¯è§ï¼Œè€Œä¸”è¿˜å¯ä»¥é€šè¿‡ IRQ0_INTE å’Œ IRQ1_INTE æ§åˆ¶å¯„å­˜å™¨ï¼Œå°† IRQ æ ‡å¿—çš„ä½ 4 æ¯”ç‰¹é®ç›–æˆæŸä¸ª PIO çš„ä¸­æ–­è¯·æ±‚çº¿ï¼Œ\nIRQ æ ‡å¿—çš„ç”¨é€”ä¸»è¦æœ‰ä¸¤ä¸ªï¼š\n\nåœ¨çŠ¶æ€æœºç¨‹åºä¸­ï¼Œåˆ¤æ–­ç³»ç»Ÿçº§åˆ«çš„ä¸­æ–­ï¼Œç„¶åæ®æ­¤ç­‰å¾…æŸä¸ªä¸­æ–­çš„åº”ç­”\nåŒæ­¥ä¸¤ä¸ªçŠ¶æ€æœºçš„æ‰§è¡Œ\n\nçŠ¶æ€æœºå¯ä»¥é€šè¿‡ IRQ å’Œ WAIT æŒ‡ä»¤æ¥å¤„ç† IRQ æ ‡å¿—ã€‚\n3.2.7. çŠ¶æ€æœºä¹‹é—´çš„äº¤äº’æŒ‡ä»¤å†…å­˜æ˜¯ä¸€ä¸ª 1-å†™ 4-è¯»çš„å¯„å­˜å™¨æ–‡ä»¶ï¼Œæ‰€ä»¥å››ä¸ªçŠ¶æ€æœºå¯ä»¥åœ¨åŒä¸€ä¸ªå‘¨æœŸè¯»å–æŒ‡ä»¤ï¼Œè€Œä¸éœ€è¦ç›¸äº’ç­‰å¾…ã€‚\nä½¿ç”¨å¤šä¸ªçŠ¶æ€æœºæœ‰ä¸‰ç§æ–¹å¼ï¼š\n\nå°†å¤šä¸ªçŠ¶æ€æœºæŒ‡å‘åŒä¸€ä¸ªç¨‹åº\nå°†å¤šä¸ªçŠ¶æ€æœºæŒ‡å‘ä¸åŒçš„ç¨‹åº\nç”¨å¤šä¸ªçŠ¶æ€æœºè¿è¡ŒåŒä¸€ä¸ªæ¥å£çš„ä¸åŒéƒ¨åˆ†ï¼Œä¾‹å¦‚ UART çš„ TX ç«¯å’Œ RX ç«¯ï¼Œæˆ– DPI æ˜¾ç¤ºçš„æ—¶é’Ÿ&#x2F;æ°´å¹³åŒæ­¥å’Œåƒç´ æ•°æ®\n\nçŠ¶æ€æœºä¹‹é—´æ— æ³•è¿›è¡Œæ•°æ®é€šä¿¡ï¼Œä½†å¯ä»¥é€šè¿‡ IRQ æ ‡å¿—äº’ç›¸åŒæ­¥ã€‚å…±æœ‰ 8 ä¸ª IRQ æ ‡å¿—ï¼ˆä½ 4 æ¯”ç‰¹å¯ä»¥é®ç›–ï¼Œç”¨äºç³»ç»Ÿ IRQï¼‰ï¼Œæ¯ä¸ªçŠ¶æ€æœºå¯ä»¥é€šè¿‡ IRQ æŒ‡ä»¤è®¾ç½®æˆ–æ¸…é™¤ä»»æ„æ ‡å¿—ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ WAIT IRQ æŒ‡ä»¤ç­‰å¾…æŸä¸ªæ ‡å¿—è¢«è®¾ç½®æˆ–æ¸…é™¤ã€‚è¿™æ ·å¯ä»¥å®ç°çŠ¶æ€æœºä¹‹é—´çš„æ—¶é’Ÿå‘¨æœŸçº§åˆ«çš„åŒæ­¥ã€‚\n3.3. PIO æ±‡ç¼–å™¨ï¼ˆpioasmï¼‰PIO æ±‡ç¼–å™¨èƒ½å¤Ÿè§£æä¸€æ®µ PIO æºæ–‡ä»¶ï¼Œå¹¶è¾“å‡ºæ±‡ç¼–åçš„ä»£ç ï¼Œè¯¥ä»£ç å¯ä»¥åŒ…å«åˆ°æŸä¸ª RP2040 åº”ç”¨ç¨‹åºä¸­ï¼Œå¯ä»¥æ˜¯ä½¿ç”¨ SDK æ„å»ºçš„ C æˆ– C++ ç¨‹åºï¼Œä¹Ÿå¯ä»¥æ˜¯ RP2040 MicroPython ä¸Šè¿è¡Œçš„ Python ç¨‹åºã€‚\næœ¬èŠ‚ç®€è¦ä»‹ç» pioasm ä¸­å¯ä»¥ä½¿ç”¨çš„æ ‡è¯†ç¬¦ï¼ˆdirectivesï¼‰å’ŒæŒ‡ä»¤ï¼ˆinstructionsï¼‰ã€‚æœ‰å…³æ€æ ·ä½¿ç”¨ pioasmã€æ€æ ·å°†å…¶é›†æˆåˆ° SDK æ„å»ºç³»ç»Ÿä¸­ã€æ€æ ·æ‰©å±•å…¶ç‰¹æ€§ä»¥åŠå®ƒèƒ½ç”Ÿæˆä½•ç§è¾“å‡ºæ ¼å¼ç­‰çš„æ·±å…¥è®¨è®ºï¼Œè¯·å‚è€ƒ Raspberry Pi Pico C&#x2F;C++ SDK ä¸€ä¹¦ã€‚\n3.3.1. æ ‡è¯†ç¬¦PIO ç¨‹åºä¸­çš„æ±‡ç¼–è¯­è¨€å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ ‡è¯†ç¬¦ï¼š\n.define ( PUBLIC ) &lt;symbol&gt; &lt;value&gt;\nå®šä¹‰ä¸€ä¸ªåä¸º &lt;symbol&gt; çš„æ•´æ•°ç¬¦å·ï¼Œå…¶å€¼ä¸º &lt;value&gt; ï¼ˆå‚è§3.3.2èŠ‚ï¼‰ã€‚å¦‚æœ .define å‡ºç°åœ¨è¾“å…¥æ–‡ä»¶ä¸­çš„ç¬¬ä¸€ä¸ªç¨‹åºä¹‹å‰ï¼Œé‚£ä¹ˆå®šä¹‰å°±æ˜¯å…¨å±€çš„ï¼Œå¯¹æ‰€æœ‰ç¨‹åºç”Ÿæ•ˆï¼›å¦åˆ™ï¼Œå®šä¹‰å°±æ˜¯å±€éƒ¨çš„ï¼Œä»…å¯¹å…¶æ‰€åœ¨çš„ç¨‹åºç”Ÿæ•ˆã€‚å¦‚æœæŒ‡å®šäº† PUBLICï¼Œé‚£ä¹ˆç¬¦å·å°†è¾“å‡ºåˆ°æ±‡ç¼–ä¸­ï¼Œå¯ä»¥ç”±ç”¨æˆ·ä»£ç ä½¿ç”¨ã€‚å¯¹äº SDK è€Œè¨€ï¼Œç¨‹åºç¬¦å·çš„å®šä¹‰å½¢å¼ä¸º #define &lt;program_name&gt;_&lt;symbol&gt; valueï¼Œè€Œå…¨å±€ç¬¦å·çš„å®šä¹‰å½¢å¼ä¸º#define &lt;symbol&gt; valueã€‚\n.program &lt;name&gt;\nå¼€å§‹ä¸€ä¸ªåä¸º &lt;name&gt; çš„æ–°ç¨‹åºã€‚æ³¨æ„åç§°ä¼šåœ¨ä»£ç ä¸­ä½¿ç”¨ï¼Œæ‰€ä»¥åº”å½“ç”±å­—æ¯ã€æ•°å­—æˆ–ä¸‹åˆ’çº¿ç»„æˆï¼Œå¹¶ä¸”ä¸ä»¥æ•°å­—å¼€å§‹ã€‚ç¨‹åºç›´åˆ°å‡ºç°ä¸‹ä¸€ä¸ª .program æ ‡è¯†æˆ–æºæ–‡ä»¶æœ«å°¾æ—¶ç»“æŸã€‚PIO æŒ‡ä»¤åªèƒ½åœ¨ç¨‹åºå†…ä½¿ç”¨ã€‚\n.clock_div &lt;divider&gt;\nå¦‚æœå­˜åœ¨è¯¥æŒ‡ä»¤ï¼Œåˆ™divideræ˜¯ç¨‹åºçš„çŠ¶æ€æœºæ—¶é’Ÿåˆ†é¢‘å™¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ†é¢‘å€¼å¯ä»¥æ˜¯æµ®ç‚¹æ•°ï¼Œä½†ç›®å‰æ— æ³•ä½¿ç”¨ç®—æ•°è¡¨è¾¾å¼æ¥å®šä¹‰ã€‚è¯¥æŒ‡ä»¤å½±å“ç¨‹åºçš„é»˜è®¤çŠ¶æ€æœºé…ç½®ï¼Œæ­¤æŒ‡ä»¤ä»…åœ¨ç¬¬ä¸€æ¡ç¨‹åºæŒ‡ä»¤ä¹‹å‰æœ‰æ•ˆã€‚\n.pio_version &lt;version&gt;\nå¦‚æœå­˜åœ¨è¯¥æŒ‡ä»¤ï¼Œåˆ™è¦æ±‚ç¡¬ä»¶çš„PIOç‰ˆæœ¬è‡³å°‘éœ€è¦è¾¾åˆ°æŒ‡å®šçš„å€¼ã€‚rp2040çš„PIOç‰ˆæœ¬ä¸º0ï¼ŒRP2350çš„PIOç‰ˆæœ¬ä¸º1ã€‚\n.fifo &lt;fifo_config&gt;\nå¦‚æœå­˜åœ¨è¯¥æŒ‡ä»¤ï¼Œåˆ™å®ƒç”¨æ¥æŒ‡å®šç¨‹åºçš„FIFOé…ç½®ã€‚æ”¯æŒä»¥ä¸‹FIFOé…ç½®ï¼š\n\ntxrx: TXå’ŒRXçš„FIFOå„è‡ªåˆ†é…4å­—ï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤é…ç½®\ntx: TX FIFOç‹¬å 8å­—\nrx: RX FIFOç‹¬å 8å­—\ntxput: 4å­—FIFOç”¨äºTXï¼Œ4å­—FIFOç”¨äº mov rxfifo[index], isr (è¯¥é…ç½®ä¸æ”¯æŒPIO version 0)\ntxget: 4å­—FIFOç”¨äºRXï¼Œ4å­—FIFOç”¨äº mov osr, rxfifo[index] (è¯¥é…ç½®ä¸æ”¯æŒPIO version 0)\nputget: 4å­—FIFOç”¨äº mov rxfifo[index], isr  4å­—FIFOç”¨äº mov osr, rxfifo[index] (è¯¥é…ç½®ä¸æ”¯æŒPIO version 0)\n\n.in &lt;count&gt; (left|right) (auto) (&lt;threshold&gt;)\nå¦‚æœå­˜åœ¨è¯¥æŒ‡ä»¤ï¼Œcount æŒ‡ç¤ºè¦ä½¿ç”¨çš„bitæ•°ï¼Œleftå’ŒrightæŒ‡ç¤ºISRå¯„å­˜å™¨ä½ç§»çš„æ–¹å‘ï¼ŒautoæŒ‡ç¤ºä½¿èƒ½è‡ªåŠ¨pushï¼Œå¦‚æœå­˜åœ¨thresholdï¼Œåˆ™å…¶æŒ‡ç¤ºæ‰§è¡Œè‡ªåŠ¨pushçš„é˜ˆå€¼ã€‚è¯¥æŒ‡ä»¤å½±å“ç¨‹åºçš„é»˜è®¤çŠ¶æ€æœºé…ç½®ï¼Œæ­¤æŒ‡ä»¤ä»…åœ¨ç¬¬ä¸€æ¡ç¨‹åºæŒ‡ä»¤ä¹‹å‰æœ‰æ•ˆã€‚(å¯¹äºPIO version 0æ¥è¯´ï¼Œcountå›ºå®šä¸º32)\n.out &lt;count&gt; (left|right) (auto) (&lt;threshold&gt;)\nå¦‚æœå­˜åœ¨è¯¥æŒ‡ä»¤ï¼Œcount æŒ‡ç¤ºè¦ä½¿ç”¨çš„bitæ•°ï¼Œleftå’ŒrightæŒ‡ç¤ºOSRå¯„å­˜å™¨ä½ç§»çš„æ–¹å‘ï¼ŒautoæŒ‡ç¤ºä½¿èƒ½è‡ªåŠ¨pullï¼Œå¦‚æœå­˜åœ¨thresholdï¼Œåˆ™å…¶æŒ‡ç¤ºæ‰§è¡Œè‡ªåŠ¨pullçš„é˜ˆå€¼ã€‚è¯¥æŒ‡ä»¤å½±å“ç¨‹åºçš„é»˜è®¤çŠ¶æ€æœºé…ç½®ï¼Œæ­¤æŒ‡ä»¤ä»…åœ¨ç¬¬ä¸€æ¡ç¨‹åºæŒ‡ä»¤ä¹‹å‰æœ‰æ•ˆã€‚(å¯¹äºPIO version 0æ¥è¯´ï¼Œcountå›ºå®šä¸º32)\n.mov_status rxfifo &lt; &lt;n&gt;.mov_status txfifo &lt; &lt;n&gt;.mov_status irq &lt;(next|prev)&gt; set &lt;n&gt;\nè¯¥æŒ‡ä»¤ç”¨äºé…ç½®æŒ‡ä»¤ mov x, status çš„æºã€‚å¯ä»ä¸‰ç§æƒ…å†µä¹‹ä¸­é€‰æ‹©ä¸€ç§è¿›è¡Œé…ç½®ï¼ŒåŒ…æ‹¬æ ¹æ®RXFIFOæ•°é‡ä½äºnã€TXFIFOæ•°é‡ä½äºnã€irqçš„ç¬¬nä¸ªæ ‡å¿—è¢«è®¾ç½®(æˆ–ä¸‹ä¸€ä¸ªæ›´é«˜ç¼–å·æˆ–ä¸Šä¸€ä¸ªæ›´ä½ç¼–å·çš„PIO)ã€‚irqé€‰é¡¹ä¸æ”¯æŒPIO version 0ã€‚\n.origin &lt;offset&gt;\nå¯é€‰çš„æ ‡è¯†ï¼ŒæŒ‡ç¤º PIO æŒ‡ä»¤å†…å­˜çš„åç§»é‡ï¼Œç¨‹åºå¿…é¡»åŠ è½½åˆ°æ­¤åç§»é‡å¤„ã€‚ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¯¥æ ‡è¯†ç”¨äºæŒ‡å®šç¨‹åºå¿…é¡»åŠ è½½åˆ°åç§»é‡ 0ï¼Œè¿™æ ·è¿™äº›ç¨‹åºæ‰èƒ½ä½¿ç”¨åŸºäºæ•°æ®çš„ JMP æŒ‡ä»¤ï¼Œå¹¶ä¸”åªç”¨å‡ ä¸ªæ¯”ç‰¹æ¥å­˜å‚¨è·³è½¬çš„ï¼ˆç»å¯¹ï¼‰åœ°å€ã€‚åœ¨ç¨‹åºå¤–éƒ¨ï¼Œè¯¥æ ‡è¯†æ— æ•ˆã€‚\n.side_set &lt;count&gt; (opt) (pindirs)\nå¦‚æœå‡ºç°è¯¥æ ‡è¯†ï¼Œåˆ™ &lt;count&gt; æŒ‡ç¤ºä½¿ç”¨çš„ side-set æ¯”ç‰¹æ•°ã€‚è¿˜å¯ä»¥é€šè¿‡ opt ä»¥æŒ‡å®š side &lt;value&gt; å¯¹äºæŒ‡ä»¤æ˜¯å¯é€‰çš„ï¼ˆæ³¨æ„è¿™æ ·åšä¼šä½¿ side-set åœ¨åŸæœ¬éœ€è¦å ç”¨çš„ &lt;count&gt; ä¸ªæ¯”ç‰¹ä¹‹å¤–ï¼Œå†é¢å¤–å ç”¨ä¸€ä¸ªæ¯”ç‰¹ã€‚è¿™äº›è¢«å ç”¨çš„æ¯”ç‰¹å‡æ¥è‡ªæŒ‡ä»¤çš„å»¶æ—¶æ¯”ç‰¹ï¼‰ã€‚æœ€åï¼Œpindirs å¯ä»¥ç”¨æ¥æŒ‡ç¤º side-set å€¼åº”å½“åº”ç”¨äº PINDIRï¼Œè€Œä¸æ˜¯ PIN ä¸Šã€‚è¯¥æ ‡è¯†åªèƒ½å‡ºç°åœ¨ç¨‹åºçš„ç¬¬ä¸€æ¡æŒ‡ä»¤ä¹‹å‰ã€‚\n.wrap_target\nè¯¥æ ‡è¯†ç½®äºæŸæ¡æŒ‡ä»¤ä¹‹å‰ï¼Œç”¨äºæŒ‡ç¤ºåœ¨ç¨‹åºæŠ˜è¿”æ—¶åº”å½“ä»å“ªä¸€æ¡æŒ‡ä»¤ç»§ç»­æ‰§è¡Œã€‚è¯¥æ ‡è¯†åªèƒ½åœ¨ç¨‹åºå†…éƒ¨ä½¿ç”¨ï¼Œä¸”æ¯ä¸ªç¨‹åºåªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚å¦‚æœä¸æŒ‡å®šï¼ŒæŠ˜è¿”ç›®çš„åœ°ä¸ºç¨‹åºçš„å¼€å¤´ã€‚\n.wrap\nè¯¥æ ‡è¯†ç½®äºæŸæ¡æŒ‡ä»¤ä¹‹åï¼ŒæŒ‡ç¤ºåœ¨æ­£å¸¸çš„æ§åˆ¶æµä¸­ï¼ˆå³ jmp æ¡ä»¶ä¸ºå‡ï¼Œæˆ–æ²¡æœ‰ jmp çš„æƒ…å†µï¼‰æ‰§è¡Œå®Œè¯¥æŒ‡ä»¤åï¼Œç¨‹åºåº”å½“æŠ˜è¿”ï¼ˆè‡³ .warp_target æ ‡è¯†çš„æŒ‡ä»¤ï¼‰ã€‚è¯¥æ ‡è¯†åªèƒ½åœ¨ç¨‹åºå†…éƒ¨ä½¿ç”¨ï¼Œä¸”æ¯ä¸ªç¨‹åºåªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚å¦‚æœä¸æŒ‡å®šï¼Œåˆ™æŠ˜è¿”ç‚¹ä¸ºç¨‹åºçš„æœ€åä¸€æ¡æŒ‡ä»¤ä¹‹åã€‚\n.lang_opt &lt;lang&gt; &lt;name&gt; &lt;option&gt;\nä¸ºç¨‹åºæŒ‡å®šä¸ç‰¹å®šè¯­è¨€ç”Ÿæˆå™¨æœ‰å…³çš„é€‰é¡¹ï¼ˆå‚è§SDKæ–‡æ¡£ä¸­çš„â€Language generatorsâ€ä¸€èŠ‚ï¼‰ã€‚è¯¥æ ‡è¯†åªèƒ½åœ¨ç¨‹åºå†…ä½¿ç”¨ã€‚\n.word &lt;value&gt;\nå°†ä¸€ä¸ª 16 ä½å€¼ä½œä¸ºä¸€æ¡æŒ‡ä»¤å­˜å‚¨åœ¨ç¨‹åºä¸­ã€‚è¯¥æ ‡è¯†åªèƒ½åœ¨ç¨‹åºå†…éƒ¨ä½¿ç”¨ã€‚\n3.3.2. å€¼ä¸‹è¿°å€¼ç±»å‹å¯ä»¥ç”¨äºå®šä¹‰æ•´æ•°ï¼Œæˆ–åˆ†æ”¯ç›®çš„åœ°ã€‚\n\n\n\næ ¼å¼\nè¯´æ˜\n\n\n\ninteger\nä¸€ä¸ªæ•´æ•°å€¼ï¼Œå¦‚ 3 æˆ– -7\n\n\nhex\nä¸€ä¸ªåå…­è¿›åˆ¶å€¼ï¼Œå¦‚ 0xf\n\n\nbinary\nä¸€ä¸ªäºŒè¿›åˆ¶å€¼ï¼Œå¦‚ 0b1001\n\n\nsymbol\nç”± .define å®šä¹‰çš„ä¸€ä¸ªå€¼ï¼ˆå‚è§3.3.1èŠ‚ï¼‰\n\n\n&lt;label&gt;\nç¨‹åºä¸­çš„æ ‡ç­¾æ‰€å¯¹åº”çš„æŒ‡ä»¤åç§»é‡ã€‚é€šå¸¸åœ¨ JMP æŒ‡ä»¤ä¸­ä½¿ç”¨ï¼ˆå‚è§3.4.2èŠ‚\n\n\n( &lt;expression&gt; )\nä¸€ä¸ªå¯æ±‚å€¼çš„è¡¨è¾¾å¼ï¼›å‚è§3.3.3èŠ‚ã€‚æ³¨æ„æ‹¬å·æ˜¯å¿…é¡»çš„ã€‚\n\n\n3.3.3. è¡¨è¾¾å¼è¡¨è¾¾å¼å¯ä»¥ä¸ pioasm å€¼ä¸€åŒä½¿ç”¨ã€‚\n\n\n\næ ¼å¼\nè¯´æ˜\n\n\n\n&lt;expression&gt; + &lt;expression&gt;\nä¸¤ä¸ªè¡¨è¾¾å¼çš„å’Œ\n\n\n&lt;expression&gt; - &lt;expression&gt;\nä¸¤ä¸ªè¡¨è¾¾å¼çš„å·®\n\n\n&lt;expression&gt; * &lt;expression&gt;\nä¸¤ä¸ªè¡¨è¾¾å¼çš„ç§¯\n\n\n&lt;expression&gt; / &lt;expression&gt;\nä¸¤ä¸ªè¡¨è¾¾å¼çš„æ•´æ•°é™¤æ³•å•†\n\n\n- &lt;expression&gt;\nè¡¨è¾¾å¼çš„è´Ÿå€¼\n\n\n:: &lt;expression&gt;\nè¡¨è¾¾å¼çš„æŒ‰ä½å–å\n\n\n&lt;value&gt;\nä»»æ„çš„å€¼ï¼ˆå‚è§3.3.2èŠ‚\n\n\n3.3.4. æ³¨é‡Šè¡Œæ³¨é‡Šä»¥ // æˆ– ; å¼€å¤´ã€‚\nC è¯­è¨€é£æ ¼çš„æ³¨é‡Šæ”¾åœ¨ /* å’Œ */ ä¹‹é—´ã€‚\n3.3.5. æ ‡ç­¾æ ‡ç­¾çš„å½¢å¼å¦‚ä¸‹ï¼š\n&lt;symbol&gt;:\næˆ–\nPUBLIC &lt;symbol&gt;:\næ ‡ç­¾å¿…é¡»ä»è¡Œé¦–å¼€å§‹ã€‚\næç¤ºï¼šæ ‡ç­¾å®é™…ä¸Šåªæ˜¯è‡ªåŠ¨çš„ .defineï¼Œå…¶å€¼è®¾ç½®ä¸ºå½“å‰ç¨‹åºæŒ‡ä»¤çš„åç§»é‡ã€‚PUBLIC çš„æ ‡ç­¾å¯ä»¥é€šè¿‡ä¸ PUBLIC çš„ .define åŒæ ·çš„æ–¹å¼ä»ç”¨æˆ·ä»£ç è®¿é—®ã€‚\n3.3.6. æŒ‡ä»¤æ‰€æœ‰çš„ pioasm æŒ‡ä»¤éƒ½éµå¾ªä»¥ä¸‹æ ¼å¼ï¼š\n&lt;instruction&gt; (side &lt;side_set_value&gt;) ([&lt;delay_value])\nå…¶ä¸­ï¼š\n&lt;instruction&gt; æ˜¯ä¸‹ä¸€èŠ‚ä»‹ç»çš„æ±‡ç¼–æŒ‡ä»¤ã€‚ï¼ˆå‚è§3.4èŠ‚ï¼‰\n&lt;side_set_valie&gt; æ˜¯ä¸€ä¸ªå€¼ï¼ˆå‚è§3.3.2èŠ‚ï¼‰ï¼Œåœ¨æŒ‡ä»¤å¼€å§‹æ—¶ï¼Œè¯¥å€¼å°†åº”ç”¨åˆ° side_set ç®¡è„šã€‚æ³¨æ„ side &lt;side_set_value&gt; ä¸­çš„ side-set å€¼çš„è§„åˆ™ä¾èµ–äºè¯¥ç¨‹åºçš„ .side_set æŒ‡ç¤ºï¼ˆå‚è§3.3.1èŠ‚ï¼‰ã€‚\nå¦‚æœæ²¡æœ‰æŒ‡å®š .side_setï¼Œåˆ™ side &lt;side_set_value&gt; å°±æ˜¯æ— æ•ˆçš„ã€‚å¦‚æœæŒ‡å®šäº†å¯é€‰æ•°é‡çš„ side-set ç®¡è„šï¼Œåˆ™å…è®¸ä½¿ç”¨ side &lt;side_set_value&gt;ã€‚å¦‚æœæŒ‡å®šäº†å¿…é¡»æ•°é‡çš„ side-set ç®¡è„šï¼Œåˆ™ side &lt;side_set_value&gt; æ˜¯å¿…é¡»çš„ã€‚\n&lt;side_set_value&gt; çš„å€¼å¿…é¡»åŒ¹é… .side_set æ ‡è¯†ä¸­æŒ‡å®šçš„ side-set çš„æ¯”ç‰¹æ•°ã€‚\n&lt;delay_value&gt; æŒ‡å®šåœ¨æŒ‡ä»¤æ‰§è¡Œå®Œæˆåéœ€è¦å»¶æ—¶çš„æ—¶é’Ÿå‘¨æœŸæ•°ã€‚delay_value æ˜¯ä¸€ä¸ªå€¼ï¼ˆå‚è§3.3.2èŠ‚ï¼‰ï¼Œé€šå¸¸åœ¨ 0 ~ 31 ä¹‹é—´ï¼ˆåŒ…å« 0 å’Œ 31ï¼Œæ˜¯ä¸€ä¸ª 5 æ¯”ç‰¹çš„å€¼ï¼‰ï¼Œä½†æ˜¯å¦‚æœé€šè¿‡ .side_set æŒ‡ç¤ºï¼ˆå‚è§3.3.1èŠ‚ï¼‰å¯ç”¨äº† side-setï¼Œé‚£ä¹ˆå¯ç”¨çš„æ¯”ç‰¹æ•°å°±ä¼šå‡å°‘ã€‚å¦‚æœä¸æŒ‡å®š &lt;delay_value&gt;ï¼Œåˆ™æŒ‡ä»¤æ²¡æœ‰å»¶æ—¶ã€‚\næ³¨æ„ pioasm æŒ‡ä»¤åç§°ã€å…³é”®å­—å’Œæ ‡è¯†ä¸åŒºåˆ†å¤§å°å†™ã€‚éµå¾ª SDK çš„é£æ ¼ï¼Œä¸‹é¢çš„â€œæ±‡ç¼–è¯­æ³•â€ä¸€èŠ‚ç»Ÿä¸€ä½¿ç”¨å°å†™ã€‚\næ³¨æ„ æŸäº›æ±‡ç¼–è¯­æ³•ä¸­ä¼šå‡ºç°éƒ½å¥½ï¼Œä½†é€—å·å®Œå…¨æ˜¯å¯é€‰çš„ã€‚ä¾‹å¦‚ out pins, 3 å¯ä»¥å†™æˆ out pins 3ï¼Œjmp x-- label å¯ä»¥å†™æˆ jmp x--, labelã€‚â€œæ±‡ç¼–è¯­æ³•â€ä¸€èŠ‚ä½¿ç”¨å‰ä¸€ç§æ ¼å¼ã€‚\n3.3.7 ä¼ªæŒ‡ä»¤ç›®å‰ï¼Œpioasm æä¾›ä¸€æ¡ä¼ªæŒ‡ä»¤ï¼ˆpseudoinstructionï¼‰ï¼Œä»¥æ–¹ä¾¿ç¼–ç¨‹ï¼š\nnopï¼šæ±‡ç¼–æˆ mov y, yã€‚è¡¨ç¤ºâ€œæ— æ“ä½œâ€ã€‚æ²¡æœ‰ä»»ä½•å‰¯ä½œç”¨ï¼Œç”¨äº side-set æ“ä½œï¼Œæˆ–é¢å¤–çš„å»¶æ—¶ã€‚\n3.4. æŒ‡ä»¤é›†3.4.1. æ¦‚è¦PIO æŒ‡ä»¤ä¸º 16 ä½ï¼Œç¼–ç æ–¹å¼å¦‚ä¸‹ï¼š\n\næ‰€æœ‰ PIO æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´éƒ½æ˜¯ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚\n5 æ¯”ç‰¹çš„ Delay/side-set å­—æ®µçš„å«ä¹‰ä¾èµ–äºçŠ¶æ€æœºçš„ SIDESET_COUNT é…ç½®ï¼š\n\næœ€å¤š 5 ä¸ª LSB æ¯”ç‰¹ï¼ˆ5 å‡ SIDESET_COUNTï¼‰ä¸ºå½“å‰æŒ‡ä»¤å’Œä¸‹ä¸€æ¡æŒ‡ä»¤ä¹‹é—´æ’å…¥çš„ç©ºé—²å‘¨æœŸæ•°ã€‚\næœ€å¤š 5 ä¸ª MSB æ¯”ç‰¹ï¼ˆç”± SIDESET_COUNT è®¾ç½®ï¼‰ä¸º side-setï¼ˆå‚è§3.5.1èŠ‚ï¼‰ï¼Œå¯ä»¥åœ¨è¯¥æŒ‡ä»¤æ‰§è¡Œçš„åŒæ—¶ï¼Œå°†æŸäº› GPIO ç®¡è„šè®¾ç½®ä¸ºæŸä¸ªå¸¸é‡ã€‚\n\n3.4.2. JMP3.4.2.1. ç¼–ç \n3.4.2.2. æ“ä½œå¦‚æœ Condition ä¸ºçœŸï¼Œåˆ™å°†ç¨‹åºè®¡æ•°å™¨è®¾ç½®ä¸º Addressï¼Œå¦åˆ™æ— æ“ä½œã€‚\nJMP ä¸Šçš„å»¶æ—¶å‘¨æœŸä¸è®º Condition æ˜¯å¦ä¸ºçœŸéƒ½ä¼šç”Ÿæ•ˆã€‚å»¶æ—¶åœ¨ Condition è¢«æ±‚å€¼ã€ç¨‹åºè®¡æ•°å™¨è¢«æ›´æ–°åè¿›è¡Œã€‚\n\nConditionï¼š\n000ï¼šï¼ˆæ— æ¡ä»¶ï¼‰ï¼šæ°¸è¿œè·³è½¬\n001ï¼š!Xï¼šå½“å¯„å­˜å™¨ X ä¸ºé›¶æ—¶\n010ï¼šX--ï¼šå½“ X éé›¶æ—¶ã€‚åˆ¤æ–­åè¿›è¡Œå‡ä¸€\n011ï¼š!Yï¼šå½“å¯„å­˜å™¨ Y ä¸ºé›¶æ—¶\n100ï¼šY--ï¼šå½“ Y éé›¶æ—¶ã€‚åˆ¤æ–­åè¿›è¡Œå‡ä¸€\n101ï¼šX!=Yï¼šå½“ X ä¸ç­‰äº Y æ—¶\n110ï¼šPINï¼šæ ¹æ®è¾“å…¥ç®¡è„šè·³è½¬\n111ï¼š!OSREï¼šå½“è¾“å‡ºç§»ä½å¯„å­˜å™¨éç©ºæ—¶\n\n\nAddressï¼šè¦è·³è½¬åˆ°çš„æŒ‡ä»¤åœ°å€ã€‚åœ¨æŒ‡ä»¤ç¼–ç ä¸­ï¼Œè¯¥å€¼ä¸º PIO æŒ‡ä»¤å†…å­˜ä¸­çš„ç»å¯¹åœ°å€ã€‚\n\nJMP PIN ä¼šæ ¹æ® EXECCTRL_JMP_PIN é€‰æ‹©çš„ GPIO ç®¡è„šè¿›è¡Œè·³è½¬ã€‚EXECCTRL_JMP_PIN æ˜¯ä¸€ä¸ªå¯é…ç½®é€‰é¡¹ï¼Œå®ƒä»çŠ¶æ€æœºå¯ä»¥ä½¿ç”¨çš„æœ€å¤š 32 ä¸ª GPIO è¾“å…¥ç®¡è„šä¸­é€‰æ‹©å…¶ä¸­ä¹‹ä¸€ï¼Œä¾› JMP ä½¿ç”¨ã€‚ä¸ä¾èµ–äºçŠ¶æ€æœºçš„å…¶ä»–è¾“å…¥æ˜ å°„ã€‚å¦‚æœè¯¥ GPIO ä¸ºé«˜ç”µå¹³ï¼Œåˆ™è·³è½¬ã€‚\n!OSRE å°†è‡ªä¸Šä¸€æ¬¡ PULL ä»¥æ¥ç§»å‡ºçš„æ¯”ç‰¹æ•°ï¼Œä¸ç§»ä½è®¡æ•°é˜ˆå€¼è¿›è¡Œæ¯”è¾ƒã€‚ç§»ä½è®¡æ•°é˜ˆå€¼ç”± SHIFTCTRL_PULL_THRESH é…ç½®ã€‚è‡ªåŠ¨åŠ è½½ï¼ˆautopullï¼Œå‚è§3.5.4èŠ‚ï¼‰ä¹Ÿé€šè¿‡è¯¥é…ç½®é¡¹é…ç½®ã€‚\nJMP X-- å’Œ JMP Y-- æ€»æ˜¯ä¼šå°†å¯„å­˜å™¨ X æˆ– Y å‡ä¸€ã€‚å‡ä¸€æ“ä½œä¸å¯æ“¦å†™å¯„å­˜å™¨çš„å½“å‰å€¼æ— å…³ã€‚è·³è½¬æ¡ä»¶æ˜¯å¯„å­˜å™¨çš„åˆå§‹å€¼ï¼Œå³å‡ä¸€æ“ä½œå‘ç”Ÿä¹‹å‰çš„å€¼ã€‚å¦‚æœå¯„å­˜å™¨æœ€åˆä¸ºéé›¶å€¼ï¼Œåˆ™å‘ç”Ÿè·³è½¬ã€‚\n3.4.2.3. æ±‡ç¼–è¯­æ³•jmp (&lt;cond&gt;) &lt;target&gt;\nå…¶ä¸­ï¼š\n&lt;cond&gt; æ˜¯ä¸ŠèŠ‚åˆ—å‡ºçš„å¯é€‰çš„æ¡ä»¶ï¼ˆä¾‹å¦‚ï¼Œ!x è¡¨ç¤ºå¯æ“¦å†™å¯„å­˜å™¨ X ä¸ºé›¶ï¼‰ã€‚å¦‚æœæœªæŒ‡å®šæ¡ä»¶ï¼Œåˆ™æ€»æ˜¯è·³è½¬ã€‚\n&lt;target&gt; æ˜¯ä¸€ä¸ªç¨‹åºæ ‡ç­¾æˆ–å€¼ï¼ˆå‚è§3.3.2èŠ‚ï¼‰ï¼Œè¡¨ç¤ºç¨‹åºå†…éƒ¨çš„æŒ‡ä»¤åç§»é‡ï¼ˆç¬¬ä¸€æ¡æŒ‡ä»¤çš„åç§»é‡ä¸º 0ï¼‰ã€‚æ³¨æ„ï¼Œç”±äº PIO JMP æŒ‡ä»¤ä½¿ç”¨ PIO æŒ‡ä»¤å†…å­˜ä¹‹å†…çš„ç»å¯¹åœ°å€ï¼ŒJMP éœ€è¦åœ¨è¿è¡Œæ—¶æ ¹æ®ç¨‹åºçš„åŠ è½½åç§»é‡è¿›è¡Œè°ƒæ•´ã€‚è¿™ä¸€æ­¥åœ¨åŠ è½½ç¨‹åºæ—¶ç”± SDK è´Ÿè´£ï¼Œä½†åœ¨ç¼–ç  JMP æŒ‡ä»¤ä¾› OUT EXEC ä½¿ç”¨æ—¶éœ€è¦ç•™æ„è¿™ä¸€ç‚¹ã€‚\n3.4.3. WAIT3.4.3.1. ç¼–ç \n3.4.3.2. æ“ä½œç­‰å¾…ï¼Œç›´åˆ°æ¡ä»¶æ»¡è¶³ã€‚\nä¸æ‰€æœ‰ç­‰å¾…æŒ‡ä»¤ä¸€æ ·ï¼ˆå‚è§3.2.4èŠ‚ï¼‰ï¼Œå»¶æ—¶å‘¨æœŸåœ¨æŒ‡ä»¤å®Œæˆä¹‹åå‘ç”Ÿã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæŒ‡å®šäº†å»¶æ—¶å‘¨æœŸï¼Œé‚£ä¹ˆå»¶æ—¶è¦ç›´åˆ°ç­‰å¾…æ¡ä»¶æ»¡è¶³ä¹‹åæ‰ä¼šå¼€å§‹ã€‚\n\nPolarity\n1ï¼šç­‰å¾… 1ã€‚\n0ï¼šç­‰å¾… 0ã€‚\n\n\nSourceï¼šæŒ‡å®šè¦ç­‰å¾…ä»€ä¹ˆã€‚å¯èƒ½çš„å€¼æœ‰ï¼š\n00:GPIOï¼šç­‰å¾…ç”± Index é€‰æ‹©çš„ç³»ç»Ÿ GPIO è¾“å…¥ã€‚è¯¥é¡¹ä¸ºç»å¯¹ GPIO ç´¢å¼•ï¼Œä¸å—çŠ¶æ€æœºçš„è¾“å…¥ IO æ˜ å°„å½±å“ã€‚\n01ï¼šPINï¼šç”± Index æŒ‡å®šçš„è¾“å…¥ç®¡è„šã€‚é¦–å…ˆä¼šåº”ç”¨å½“å‰çŠ¶æ€æœºçš„è¾“å…¥ IO æ˜ å°„ï¼Œç„¶ååˆ©ç”¨ Index é€‰æ‹©è¦ç­‰å¾…å“ªä¸ªè¾“å…¥æ¯”ç‰¹ã€‚æ¢å¥è¯è¯´ï¼Œé€‰æ‹©çš„ç®¡è„šå°±æ˜¯ PINCTRL_IN_BASE åŠ ä¸Š Indexï¼Œå†å¯¹ 32 å–ä½™ã€‚\n10ï¼šIRQï¼šç­‰å¾…ç”± Index é€‰æ‹©çš„ PIO IRQ æ ‡å¿—ã€‚\n11ï¼šJMPPINï¼šç­‰å¾…ç”±PINCTRL_JMP_PINé…ç½®çš„GPIOï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ª0-3çš„åç§»ã€‚åŠ ä¸Šåç§»åä¸å¾—è¶…è¿‡32ã€‚(è¯¥æ¨¡å¼ä¸æ”¯æŒPIO version 0)\n\n\nIndexï¼šè¦æ£€æŸ¥å“ªä¸ªç®¡è„šæˆ–æ¯”ç‰¹ã€‚\n\nWAIT x IRQ çš„è¡Œä¸ºä¸å…¶ä»– WAIT æºç•¥æœ‰ä¸åŒï¼š\n\nå¦‚æœ Polarity ä¸º 1ï¼Œåˆ™åœ¨ç­‰å¾…æ¡ä»¶æ»¡è¶³åï¼Œå½“å‰çŠ¶æ€æœºä¼šæ¸…é™¤é€‰æ‹©çš„ IRQ æ ‡å¿—ã€‚\næ ‡å¿—ä½ç´¢å¼•çš„è§£ç æ–¹å¼ä¸ IRQ çš„ç´¢å¼•å­—æ®µç›¸åŒï¼Œä»ä¸¤ä¸ªMSBè¿›è¡Œè§£ç ï¼š\n00: æœ€ä½ä¸‰ä½ç”¨äºè¦ç­‰å¾…çš„å½“å‰PIOçš„IRQæ ‡å¿—ç¼–å·ã€‚\n01(PREV): æœ€ä½ä¸‰ä½æŒ‡ç¤ºçš„IRQç¼–å·ä¸ºä¸Šä¸€ä¸ªPIOçš„IRQæ ‡å¿—ã€‚\n10(REL):  æœ€ä½ä¸‰ä½çš„å€¼åŠ ä¸ŠçŠ¶æ€æœºçš„ç¼–å·å†æ¨¡4ä½œä¸ºIRQçš„ç¼–å·è¿›è¡Œç­‰å¾…ã€‚ä¾‹å¦‚çŠ¶æ€æœº2çš„æœ€ä½3ä½çš„å€¼ä¸º1ï¼Œåˆ™å°†ç­‰å¾…IRQ3ã€‚çŠ¶æ€æœº3çš„æœ€ä½ä¸‰ä½ä¸º3ï¼Œåˆ™å°†ç­‰å¾…IRQ2ã€‚è¿™æ ·ï¼Œå…è®¸åŒä¸€ä¸ªç¨‹åºçš„ä¸åŒçŠ¶æ€æœºå°±å¯ä»¥ç›¸äº’åŒæ­¥ã€‚\n11(NEXT): æœ€ä½ä¸‰ä½æŒ‡ç¤ºçš„IRQç¼–å·ä¸ºä¸Šä¸€ä¸ªPIOçš„IRQæ ‡å¿—ã€‚å¦‚æœ MSB è¢«è®¾ç½®ï¼Œåˆ™å°†çŠ¶æ€æœºçš„ IDï¼ˆ0..3ï¼‰åŠ åˆ° IRQ ç´¢å¼•ä¸Šï¼ŒåŠ æ³•é‡‡ç”¨ä¸¤ä¸ª LSB çš„æ¨¡ 4 åŠ æ³•ã€‚ä¾‹å¦‚ï¼ŒçŠ¶æ€æœº 2ã€æ ‡å¿—å€¼ä¸º â€˜0x11â€™ï¼Œåˆ™ç­‰å¾…æ ‡å¿— 3ï¼Œè€Œæ ‡å¿—å€¼ â€˜0x13â€™ å°†ç­‰å¾…æ ‡å¿— 1ã€‚è¿™æ ·ï¼Œè¿è¡ŒåŒä¸€ä¸ªç¨‹åºçš„å¤šä¸ªçŠ¶æ€æœºå°±å¯ä»¥äº’ç›¸åŒæ­¥ã€‚\n\n\n\næ³¨æ„ WAIT 1 IRQ x ä¸åº”å½“ä½¿ç”¨ä¾›ä¸­æ–­æ§åˆ¶å™¨ä½¿ç”¨çš„ IRQ æ ‡å¿—ï¼Œä»¥é¿å…ä¸ç³»ç»Ÿä¸­æ–­å¤„ç†å‡½æ•°çš„ç«åˆå†²çªã€‚\n3.4.3.3. æ±‡ç¼–è¯­æ³•wait &lt;polarity&gt; gpio &lt;gpio_num&gt;\nwait &lt;polarity&gt; pin &lt;pin_num&gt;\nwait &lt;polarity&gt; irq &lt;irq_num&gt; (rel, next, prev)\nwait &lt;polarity&gt; jmppin (+ &lt;pin_offset&gt;)\nå…¶ä¸­ï¼š\n&lt;polarity&gt; æ˜¯ä¸€ä¸ªå€¼ï¼ˆå‚è§3.3.2èŠ‚ï¼‰ï¼ŒæŒ‡å®šææ€§ï¼ˆ0 æˆ– 1ï¼‰\n&lt;pin_num&gt; æ˜¯ä¸€ä¸ªå€¼ï¼ˆå‚è§3.3.2èŠ‚ï¼‰ï¼ŒæŒ‡å®šè¾“å…¥ç®¡è„šçš„ç¼–å·ï¼ˆåœ¨çŠ¶æ€æœºè¾“å…¥ç®¡æ•™æ˜ å°„ä¸­çš„ç¼–å·ï¼‰\n&lt;gpio_num&gt; æ˜¯ä¸€ä¸ªå€¼ï¼ˆå‚è§3.3.2èŠ‚ï¼‰ï¼ŒæŒ‡å®šå®é™…çš„ GPIO ç®¡è„šç¼–å·\n&lt;irq_num&gt; (rel) æ˜¯ä¸€ä¸ªå€¼ï¼ˆå‚è§3.3.2èŠ‚ï¼‰ï¼ŒæŒ‡å®šè¦ç­‰å¾…çš„ IRQ ç¼–å·ï¼ˆ0 ~ 7ï¼‰ã€‚å¦‚æœè®¾ç½®äº† relï¼Œåˆ™å®é™…çš„ IRQ ç¼–å·çš„è®¡ç®—æ–¹å¼ä¸ºï¼Œå°† IRQ ç¼–å·çš„æœ€ä½ä¸¤ä¸ªæ¯”ç‰¹ï¼ˆirq_num10ï¼‰æ›¿æ¢æˆå’Œçš„æœ€ä½ä¸¤ä¸ªæ¯”ç‰¹ï¼ˆirq_num10 + sm_num10ï¼‰ï¼Œå…¶ä¸­ sm_num10 ä¸ºçŠ¶æ€æœºç¼–å·\n&lt;pin_offset&gt; æ˜¯ä¸€ä¸ªå€¼ï¼Œç”¨æ¥æ·»åŠ åˆ°JMP_PINä¸Šæ¥è·å¾—å®é™…éœ€è¦ç­‰å¾…çš„å¼•è„šç¼–å·\n3.4.4. IN3.4.4.1. ç¼–ç \n3.4.4.2. æ“ä½œä» Source ç§»ä½ Bit count ä¸ªæ¯”ç‰¹åˆ°è¾“å…¥ç§»ä½å¯„å­˜å™¨ï¼ˆISRï¼‰ä¸­ã€‚ç§»ä½æ–¹å‘ç”±å„ä¸ªçŠ¶æ€æœºçš„ SHIFTCTRL_IN_SHIFTDIR å†³å®šã€‚æ­¤å¤–ï¼Œå¢åŠ è¾“å…¥ç§»ä½è®¡æ•°å™¨ Bit countï¼Œæœ€å¤§åˆ° 32ã€‚\n\nSourceï¼š\n000ï¼šPINS\n001ï¼šXï¼ˆå¯æ“¦å†™å¯„å­˜å™¨ Xï¼‰\n010ï¼šYï¼ˆå¯æ“¦å†™å¯„å­˜å™¨ Yï¼‰\n011ï¼šNULLï¼ˆå…¨é›¶ï¼‰\n100ï¼šä¿ç•™\n101ï¼šä¿ç•™\n110ï¼šISR\n111ï¼šOSR\n\n\nBit countï¼šè¦å°†å¤šå°‘æ¯”ç‰¹ç§»ä½åˆ° ISRã€‚å€¼ä¸º 1 ~ 32 æ¯”ç‰¹ï¼Œ32 ç¼–ç ä¸º 00000ã€‚\n\nå¦‚æœå¯ç”¨äº†è‡ªåŠ¨æ¨å‡ºï¼ˆautopushï¼‰ï¼Œé‚£ä¹ˆå½“è¾¾åˆ°æ¨å‡ºé˜ˆå€¼ï¼ˆSHIFTCTRL_PUSH_THRESï¼‰æ—¶ï¼ŒIN è¿˜ä¼šå°† ISR çš„å†…å®¹æ¨å‡ºåˆ° RX FIFOã€‚ä¸è®ºè‡ªåŠ¨æ¨å‡ºæ˜¯å¦å‘ç”Ÿï¼ŒIN çš„æ‰§è¡Œæ—¶é—´éƒ½æ˜¯ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚å½“è‡ªåŠ¨æ¨å‡ºå‘ç”Ÿï¼Œä½† RX FIFO æ»¡æ—¶ï¼ŒçŠ¶æ€æœºä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚è‡ªåŠ¨æ¨å‡ºä¼šæ¸…ç©º ISR çš„å†…å®¹ä¸ºå…¨é›¶ï¼Œå¹¶ä¸”ä¼šæ¸…é™¤è¾“å…¥ç§»ä½è®¡æ•°å™¨ã€‚å‚è§3.5.4èŠ‚ã€‚\nIN æ°¸è¿œä½¿ç”¨æºæ•°æ®çš„æœ€ä½ Bit count ä¸ªæ¯”ç‰¹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ PINCTRL_IN_BASE è®¾ç½®ä¸º 5ï¼Œé‚£ä¹ˆæŒ‡ä»¤ IN 3, PINS ä¼šè¯»å–ç®¡è„š 5ã€6 å’Œ 7ï¼Œå¹¶å°†è¿™äº›å€¼ç§»å…¥ ISRã€‚é¦–å…ˆï¼ŒISR ä¼šå·¦ç§»æˆ–å³ç§»ï¼Œä¸ºæ–°çš„è¾“å…¥æ•°æ®è…¾å‡ºç©ºé—´ï¼Œç„¶åå°†è¾“å…¥æ•°æ®å¤åˆ¶åˆ°è…¾å‡ºçš„ç©ºé—´ä¸­ã€‚è¾“å…¥æ•°æ®çš„æ¯”ç‰¹é¡ºåºä¸ç§»ä½æ–¹å‘æ— å…³ã€‚\nä½¿ç”¨ NULL å¯ä»¥ç§»ä½ ISR çš„å†…å®¹ã€‚ä¾‹å¦‚ï¼ŒUART ä¼šé¦–å…ˆæ¥å— LSBï¼Œå› æ­¤å¿…é¡»å³ç§»ã€‚åœ¨æ‰§è¡Œ 8 æ¬¡ IN PINS, 1 æŒ‡ä»¤åï¼Œè¾“å…¥çš„ä¸²è¡Œæ•°æ®å æ®äº† ISR çš„ 31..24 æ¯”ç‰¹ã€‚æ­¤æ—¶ï¼ŒIN NULL, 24 æŒ‡ä»¤å°†ä¼šç§»å…¥ 24 ä¸ªé›¶æ¯”ç‰¹ï¼Œå°†è¾“å…¥æ•°æ®ç§»åˆ° ISR çš„ 7..0 æ¯”ç‰¹ã€‚å¦ä¸€ç§æ–¹å¼æ˜¯è®©å¤„ç†å™¨æˆ– DMA ä» FIFO åœ°å€ +3 çš„ä½ç½®è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œè¿™æ ·å¯ä»¥è¯»å– FIFO å†…å®¹çš„ 31..24 æ¯”ç‰¹ã€‚\n3.4.4.3. æ±‡ç¼–è¯­æ³•in &lt;source&gt;, &lt;bit_count&gt;\nå…¶ä¸­ï¼š\n&lt;source&gt; æ˜¯ä¸Šè¿°æºä¹‹ä¸€ã€‚\n&lt;bit_count&gt; æ˜¯ä¸€ä¸ªå€¼ï¼ˆå‚è§3.3.2èŠ‚ï¼ŒæŒ‡å®šäº†è¦ç§»ä½çš„æ¯”ç‰¹æ•°ï¼ˆæœ‰æ•ˆå€¼ä¸º 1 ~ 32ï¼‰ã€‚\n3.4.5. OUT3.4.5.1. ç¼–ç \n3.4.5.2. æ“ä½œå°† Bit count ä¸ªæ¯”ç‰¹ç§»å‡ºè¾“å…¥ç§»ä½å¯„å­˜å™¨ï¼ˆOSRï¼‰ï¼Œå¹¶å†™å…¥ Destinationã€‚æ­¤å¤–ï¼Œè¿˜ä¼šå¢åŠ è¾“å‡ºç§»ä½è®¡æ•°å™¨ Bit countï¼Œç›´åˆ°æœ€å¤§å€¼ 32ã€‚\n\nDestinationï¼š\n000ï¼šPINS\n001ï¼šXï¼ˆå¯æ“¦å†™å¯„å­˜å™¨ Xï¼‰\n010ï¼šYï¼ˆå¯æ“¦å†™å¯„å­˜å™¨ Yï¼‰\n011ï¼šNULLï¼ˆå…¨é›¶ï¼‰\n100ï¼šPINDIRS\n101ï¼šPC\n110ï¼šISRï¼ˆåŒæ—¶è®¾ç½® ISR ç§»ä½è®¡æ•°å™¨ä¸º Bit countï¼‰\n111ï¼šEXECï¼ˆå°† OSR çš„ç§»ä½æ•°æ®ä½œä¸ºæŒ‡ä»¤æ‰§è¡Œï¼‰\n\n\nBit countï¼šè¦ä» OSR ç§»å‡ºå¤šå°‘æ¯”ç‰¹ã€‚å€¼ä¸º 1..32 æ¯”ç‰¹ï¼Œ32 ç¼–ç ä¸º 00000ã€‚\n\nå°†ä¸€ä¸ª 32 ä½å€¼å†™å…¥ Destinationï¼šä½ Bit count ä¸ªæ¯”ç‰¹æ¥è‡ª OSRï¼Œå…¶ä½™ä¸ºé›¶ã€‚å¦‚æœ SHIFTCTRL_OUT_SHIFTDIR ä¸ºå³ï¼Œåˆ™è¯¥å€¼ä¸º OSR çš„æœ€ä½ Bit count æ¯”ç‰¹ï¼Œå¦åˆ™ä¸ºæœ€é«˜ Bit count æ¯”ç‰¹ã€‚\nPINS å’Œ PINDIRS ä½¿ç”¨ OUT çš„ç®¡è„šæ˜ å°„ï¼Œå‚è§3.5.6èŠ‚ã€‚\nå¦‚æœå¯ç”¨è‡ªåŠ¨åŠ è½½ï¼ˆautopullï¼‰ï¼Œé‚£ä¹ˆå¦‚æœè¾¾åˆ°äº†åŠ è½½é˜ˆå€¼ SHIFTCTRL_PULL_THRESHï¼Œåˆ™è‡ªåŠ¨ä» TX FIFO å¡«å…… OSRã€‚åŒæ—¶è¾“å‡ºç§»ä½è®¡æ•°å™¨æ¸…é›¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœ TX FIFO ä¸ºç©ºï¼Œåˆ™ OUT ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œä½†æ‰§è¡Œæ—¶é—´ä»ç„¶ä¸ºä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚è¯¦æƒ…å‚è€ƒ3.5.4èŠ‚ã€‚\næœ‰äº† OUT EXECï¼ŒæŒ‡ä»¤å°±å¯ä»¥æ”¾åœ¨ FIFO æ•°æ®æµä¸­ã€‚OUT æœ¬èº«çš„æ‰§è¡Œéœ€è¦ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œç„¶åä¸‹ä¸€ä¸ªå‘¨æœŸæ‰§è¡Œæ¥è‡ª OSR çš„æŒ‡ä»¤ã€‚è¯¥æœºåˆ¶èƒ½æ‰§è¡Œçš„æŒ‡ä»¤ç±»å‹æ²¡æœ‰é™åˆ¶ã€‚æœ€åˆçš„ OUT æŒ‡ä»¤çš„å»¶æ—¶å‘¨æœŸå°†è¢«å¿½ç•¥ï¼Œä½†ä¹‹åæ‰§è¡Œçš„æŒ‡ä»¤å¯ä»¥æ­£å¸¸æ’å…¥å»¶æ—¶å‘¨æœŸã€‚\nOUT PC ç›¸å½“äºæ— æ¡ä»¶è·³è½¬åˆ° OSR ç§»å‡ºçš„å€¼å¯¹åº”çš„åœ°å€ã€‚\n3.4.5.3. æ±‡ç¼–è¯­æ³•out &lt;destination&gt;, &lt;bit_count&gt;\nå…¶ä¸­ï¼š\n&lt;destination&gt; æ˜¯ä¸Šè¿°ç›®çš„åœ°ä¹‹ä¸€ã€‚\n&lt;bit_count&gt; æ˜¯ä¸€ä¸ªå€¼ï¼ˆå‚è§3.3.2èŠ‚ï¼ŒæŒ‡å®šè¦ç§»ä½çš„æ¯”ç‰¹æ•°ï¼ˆæœ‰æ•ˆå€¼ä¸º 1 ~ 32ï¼‰ã€‚\n3.4.6. PUSH3.4.6.1. ç¼–ç \n3.4.6.2. æ“ä½œå°† ISR çš„å†…å®¹ä½œä¸ºä¸€ä¸ª 32 ä½å­—æ¨å‡ºåˆ° RX FIFOã€‚åŒæ—¶å°† ISR æ¸…é™¤ä¸ºå…¨é›¶ã€‚\n\nIfFullï¼šå¦‚æœè®¾ç½®ä¸º 1ï¼Œé‚£ä¹ˆåœ¨è¾“å…¥ç§»ä½è®¡æ•°å™¨æœªè¾¾åˆ°é˜ˆå€¼ï¼ˆSHIFTCTRL_PUSH_THRESHï¼Œä¸è‡ªåŠ¨æ¨å‡ºç”¨çš„æ˜¯åŒä¸€ä¸ªé€‰é¡¹ï¼›å‚è§3.5.4èŠ‚ï¼‰ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åšã€‚\nBlockï¼šå¦‚æœè®¾ç½®ä¸º 1ï¼Œé‚£ä¹ˆåœ¨ RX FIFO ä¸ºæ»¡æ—¶ï¼Œæš‚åœæ‰§è¡Œã€‚\n\nPUSH IFFULL ä¹Ÿèƒ½åƒè‡ªåŠ¨æ¨å‡ºï¼ˆautopushï¼‰é‚£æ ·è®©ç¨‹åºæ›´ç´§å‡‘ã€‚å¦‚æœå¯ç”¨äº†è‡ªåŠ¨æ¨å‡ºï¼Œä¼šå¯¼è‡´ IN åœ¨ä¸æ°å½“çš„æ—¶å€™é™·å…¥ç­‰å¾…çŠ¶æ€ï¼Œæ¯”å¦‚çŠ¶æ€æœºéœ€è¦åœ¨æ­¤æ—¶åˆ¤æ–­æŸç§å¤–éƒ¨æ§åˆ¶ä¿¡å·ï¼Œé‚£ä¹ˆ PUSH IFFULL å°±èƒ½æ´¾ä¸Šç”¨åœºäº†ã€‚\nPIO æ±‡ç¼–å™¨ä¼šé»˜è®¤è®¾ç½® Block ä½ã€‚å¦‚æœ Block ä½æ²¡æœ‰è®¾ç½®ï¼Œåˆ™ PUSH ä¸ä¼šåœ¨ RX FIFO æ»¡çš„æƒ…å†µä¸‹è¿›å…¥ç­‰å¾…ï¼Œè€Œæ˜¯ä¼šç»§ç»­ç«‹å³æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚æ­¤æ—¶ï¼ŒFIFO çš„çŠ¶æ€å’Œå†…å®¹ä¸å˜ã€‚ISR ä»è¢«æ¸…ç©ºä¸ºå…¨é›¶ï¼ŒåŒæ—¶è®¾ç½® FDEBUG_RXSTALL æ ‡å¿—ï¼ˆä¸ RX FIFO æ»¡æ—¶è¿›è¡Œé˜»å¡ PUSH æˆ–è‡ªåŠ¨æ¨å‡ºç›¸åŒï¼‰ï¼Œè¡¨ç¤ºæ•°æ®å·²ç»ä¸¢å¤±ã€‚\n3.4.6.3. æ±‡ç¼–è¯­æ³•push (iffull)\npush (iffull) block\npush (iffull) nonblock\nå…¶ä¸­ï¼š\niffull ç›¸å½“äºä¸Šè¿° IfFull == 1ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸æŒ‡å®šçš„æƒ…å†µä¸‹ï¼Œé»˜è®¤å€¼ä¸º IfFull == 0\nblock ç›¸å½“äºä¸Šè¿° Block == 1ã€‚å¦‚æœä¸æŒ‡å®š block æˆ– noblockï¼Œåˆ™æ­¤å€¼ä¸ºé»˜è®¤å€¼\nnoblock ç›¸å½“äºä¸Šè¿° Block == 0ã€‚\n3.4.7. PULL3.4.7.1. ç¼–ç \n3.4.7.2. æ“ä½œä» TX FIFO åŠ è½½ä¸€ä¸ª 32 ä½å­—åˆ° OSR ä¸­ã€‚\n\nIfEmptyï¼šå¦‚æœä¸º 1ï¼Œé‚£ä¹ˆåœ¨è¾“å‡ºç§»ä½è®¡æ•°å™¨è¾¾åˆ°é˜ˆå€¼ï¼ˆSHIFTCTRL_PULL_THRESHï¼Œä¸è‡ªåŠ¨åŠ è½½ç”¨çš„æ˜¯åŒä¸€ä¸ªé€‰é¡¹ï¼›å‚è§3.5.4èŠ‚ï¼‰ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åšã€‚\nBlockï¼šå¦‚æœè®¾ç½®ä¸º 1ï¼Œé‚£ä¹ˆåœ¨ TX FIFO ä¸ºç©ºæ—¶ï¼Œæš‚åœæ‰§è¡Œã€‚å¦‚æœä¸º 0ï¼Œé‚£ä¹ˆä»ç©ºçš„ FIFO ä¸­åŠ è½½ï¼Œå°†ä¼šæŠŠå¯æ“¦å†™å¯„å­˜å™¨ X çš„å†…å®¹å¤åˆ¶åˆ° OSRã€‚\n\nä¸€äº›å¤–è®¾ï¼ˆUARTã€SPIç­‰ï¼‰åº”å½“åœ¨æ— æ•°æ®æ—¶ç­‰å¾…ï¼Œæœ‰æ•°æ®æ—¶è¿›è¡ŒåŠ è½½ï¼›è€Œå¦ä¸€äº›ï¼ˆI2Sï¼‰åˆ™åº”å½“ç»§ç»­æ‰§è¡Œï¼Œè€Œä¸”æœ€å¥½æ˜¯ç»§ç»­è¾“å‡ºå ä½æ•°æ®ï¼Œæˆ–é‡å¤æ•°æ®ã€‚è¿™ä¸ªè¡Œä¸ºå¯ä»¥é€šè¿‡ Block å‚æ•°å®ç°ã€‚\nåœ¨ç©ºçš„ FIFO ä¸Šæ‰§è¡Œä¸é˜»å¡çš„ PULL ç›¸å½“äºæ‰§è¡Œ MOV OSR, Xã€‚ç¨‹åºå¯ä»¥äº‹å…ˆåœ¨å¯„å­˜å™¨ X ä¸­åŠ è½½é€‚å½“çš„é»˜è®¤å€¼ï¼Œæˆ–åœ¨æ¯æ¬¡ PULL NOBLOCK ä¹‹åæ‰§è¡Œä¸€æ¬¡ MOV X, OSRï¼Œä»è€Œé‡å¤ä¸Šä¸€ä¸ªæœ‰æ•ˆçš„ FIFO å­—ï¼Œç›´åˆ°æ–°çš„æ•°æ®å‡ºç°ã€‚\nå¦‚æœåœ¨å¯ç”¨è‡ªåŠ¨åŠ è½½æ—¶ï¼Œå½“ TX FIFO ä¸ºç©ºæ—¶çš„ OUT ä¼šå¯¼è‡´ç¨‹åºåœ¨ä¸æ°å½“çš„åœ°æ–¹ç­‰å¾…ï¼Œå°±èƒ½ç”¨ PULL IFEMPTY è§£å†³é—®é¢˜ã€‚IfEmpty å¯ä»¥åƒè‡ªåŠ¨åŠ è½½ä¸€æ ·ç®€åŒ–ä¸€äº›ç¨‹åºï¼Œä¾‹å¦‚å¯ä»¥å»æ‰å¤–å±‚å¾ªç¯è®¡æ•°å™¨ï¼Œä½†æ˜¯å®ƒèƒ½å¤Ÿæ§åˆ¶æš‚åœçš„å‘ç”Ÿä½ç½®ã€‚\næ³¨æ„ å½“å¯ç”¨è‡ªåŠ¨åŠ è½½æ—¶ï¼Œåœ¨ OSR æ»¡çš„æƒ…å†µä¸‹ä»»ä½• PULL æŒ‡ä»¤éƒ½æ˜¯è¯¯æ“ä½œï¼Œæ‰€ä»¥ PULL æŒ‡ä»¤å¯ä»¥ä½œä¸ºä¸€ç§å±éšœã€‚OUT NULL, 32 å¯ä»¥æ˜¾å¼åœ°æŠ›å¼ƒ OSR çš„å†…å®¹ã€‚æ›´å¤šç»†èŠ‚å‚è§3.5.4.2èŠ‚ã€‚\n3.4.7.3. æ±‡ç¼–è¯­æ³•pull (ifempty)\npull (ifempty) block\npull (ifempty) noblock\nå…¶ä¸­ï¼š\nifempty ç›¸å½“äºä¸Šè¿° IfEmpty == 1ï¼Œå³å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™é»˜è®¤å€¼ä¸º IfEmpty == 0\nblock ç›¸å½“äºä¸Šè¿° Block == 1ã€‚å¦‚æœä¸æŒ‡å®š block æˆ– noblockï¼Œåˆ™æ­¤å€¼ä¸ºé»˜è®¤å€¼\nnoblock ç›¸å½“äºä¸Šè¿° Block == 0ã€‚\n3.4.8. MOV3.4.8.1. ç¼–ç \n3.4.8.2. æ“ä½œä» Source å¤åˆ¶æ•°æ®åˆ° Destinationã€‚\n\nDestinationï¼š\n000ï¼šPINSï¼ˆä½¿ç”¨ä¸ OUT ç›¸åŒçš„ç®¡è„šæ˜ å°„ï¼‰\n001ï¼šXï¼ˆå¯æ“¦å†™å¯„å­˜å™¨ Xï¼‰\n010ï¼šYï¼ˆå¯æ“¦å†™å¯„å­˜å™¨ Yï¼‰\n011ï¼šPINDIRSï¼ˆä½¿ç”¨ä¸ OUT ç›¸åŒçš„ç®¡è„šæ˜ å°„ï¼‰\n100ï¼šEXECï¼ˆå°†æ•°æ®ä½œä¸ºæŒ‡ä»¤æ‰§è¡Œï¼‰\n101ï¼šPC\n110ï¼šISRï¼ˆè¯¥æ“ä½œä¼šé‡ç½®è¾“å…¥ç§»ä½è®¡æ•°å™¨ä¸ºé›¶ï¼Œæ„ä¸ºç©ºï¼‰\n111ï¼šOSRï¼ˆè¯¥æ“ä½œä¼šé‡ç½®è¾“å‡ºç§»ä½å¯„å­˜å™¨ä¸ºé›¶ï¼Œæ„ä¸ºæ»¡ï¼‰\n\n\nOperationï¼š\n00ï¼šæ— \n01ï¼šæ±‚åï¼ˆæŒ‰ä½æ±‚è¡¥ï¼‰\n10ï¼šåè½¬æ¯”ç‰¹é¡ºåº\n11ï¼šä¿ç•™\n\n\nSourceï¼š\n000ï¼šPINSï¼ˆä½¿ç”¨ä¸ IN ç›¸åŒçš„ç®¡è„šæ˜ å°„ï¼‰\n001ï¼šX\n010ï¼šY\n011ï¼šNULL\n100ï¼šä¿ç•™\n101ï¼šSTATUS\n110ï¼šISR\n111ï¼šOSR\n\n\n\nMOV PC ä¼šå¯¼è‡´æ— æ¡ä»¶è·³è½¬ã€‚MOV EXEC çš„æ•ˆæœå’Œ OUT EXECï¼ˆå‚è§3.4.5èŠ‚ï¼‰ç›¸åŒï¼Œå¯ä»¥å°†å¯„å­˜å™¨çš„å†…å®¹ä½œä¸ºæŒ‡ä»¤æ‰§è¡Œã€‚MOV æŒ‡ä»¤è‡ªèº«éœ€è¦ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ŒSource ä¸­çš„æŒ‡ä»¤åœ¨ä¸‹ä¸€ä¸ªå‘¨æœŸæ‰§è¡Œã€‚MOV EXEC ä¸Šçš„å»¶æ—¶å‘¨æœŸä¼šè¢«å¿½ç•¥ï¼Œä½†è¢«æ‰§è¡Œçš„æŒ‡ä»¤å¯ä»¥å¸¦æœ‰å»¶æ—¶å‘¨æœŸã€‚\næº STATUS çš„å€¼ä¸ºå…¨ 1 æˆ–å…¨ 0ï¼Œå–å†³äºæŸäº›çŠ¶æ€æœºçš„çŠ¶æ€ï¼Œå¦‚ FIFO æ»¡&#x2F;ç©ºç­‰ã€‚å¯ä»¥é€šè¿‡ EXECCTRL_STATUS_SEL é…ç½®ã€‚\nMOV å¯ä»¥é€šè¿‡æœ‰é™çš„å‡ ç§æ–¹å¼æ“ä½œä¼ è¾“çš„æ•°æ®ï¼Œç”± Operation å‚æ•°æŒ‡å®šã€‚æ±‚åæ“ä½œä¼šå°† Destination ä¸­çš„æ¯ä¸ªæ¯”ç‰¹è®¾ç½®ä¸º Source ä¸­å¯¹åº”æ¯”ç‰¹çš„ NOTï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ1 å˜æˆ 0ï¼Œ0 å˜æˆ 1ã€‚è‡³äºåè½¬æ¯”ç‰¹é¡ºåºï¼Œå¦‚æœå°†æ¯”ç‰¹ç¼–å·ä¸º 0 ~ 31 çš„è¯ï¼Œè¯¥æ“ä½œå¯ä»¥å°† Destination ä¸­çš„æ¯ä¸ªæ¯”ç‰¹ n è®¾ç½®ä¸º Source ä¸­çš„æ¯”ç‰¹ 31 - nã€‚\nMOV dst, PINS ä½¿ç”¨INå¼•è„šæ˜ å°„è¯»å–å¼•è„šçš„å€¼ï¼Œæ©ç ä¸º SHIFTCTRL_IN_COUNTï¼Œè¯»å–åˆ°çš„æœ€ä½ä½æ¥è‡ªäº PINCTRL_IN_BASEï¼Œå…¶ä½™çš„ä¾æ¬¡é«˜ä½å°±æ˜¯å¯¹åº”æ›´é«˜ä½çš„pinï¼Œæœ€é«˜åˆ°è¾¾31ã€‚ç»“æœä¸­è¶…è¿‡ SHIFTCTRL_IN_COUNT çš„ä½è¢«è®¾ç½®ä¸º0ã€‚\nMOV PINDIRS, src ä¸æ”¯æŒPIO version 0ã€‚\n3.4.8.3. æ±‡ç¼–è¯­æ³•mov &lt;destination&gt;, (op) &lt;source&gt;\nå…¶ä¸­ï¼š\n&lt;destination&gt; æ˜¯ä¸Šè¿°ç›®çš„åœ°ä¹‹ä¸€ã€‚\n&lt;op&gt; å¦‚æœå­˜åœ¨çš„è¯ï¼Œä¸ºä¸‹åˆ—å€¼ä¹‹ä¸€ï¼š\n\n! æˆ– ~ è¡¨ç¤º NOT ï¼ˆæ³¨æ„ï¼šæ°¸è¿œæ˜¯æŒ‰ä½æ±‚ NOTï¼‰\n:: è¡¨ç¤ºåè½¬æ¯”ç‰¹é¡ºåº\n\n&lt;source&gt; æ˜¯ä¸Šè¿°æºä¹‹ä¸€ã€‚\n3.4.9. IRQ3.4.9.1. ç¼–ç \n3.4.9.2. æ“ä½œè®¾ç½®æˆ–æ¸…é™¤ç”± Index å‚æ•°æŒ‡å®šçš„ IRQ æ ‡å¿—ã€‚\n\nClearï¼šå¦‚æœä¸º 1ï¼Œåˆ™æ¸…é™¤ Index æŒ‡å®šçš„æ ‡å¿—ï¼Œå¦åˆ™è®¾ç½®æ ‡å¿—ã€‚å¦‚æœæŒ‡å®šäº† Clearï¼Œåˆ™å¿½ç•¥ Wait æ¯”ç‰¹ã€‚\nWaitï¼šç­‰å¾…æŒ‡å®šæ ‡å¿—å†æ¬¡å˜æˆä½ï¼Œå³ï¼Œç­‰å¾…æŸä¸ªç³»ç»Ÿä¸­æ–­å¤„ç†å‡½æ•°å“åº”è¯¥æ ‡å¿—ã€‚\nIndexï¼šæœ€ä½ä¸‰ä¸ªbitæŒ‡å®šæ¥IRQçš„ç´¢å¼•ï¼Œå€¼ä¸º0 ï½ 7ã€‚\nIndex Modeï¼šIndexçš„é«˜2ä¸ºç¼–å·åç§»æ¨¡å¼ï¼Œæœ‰4ç§æƒ…å†µï¼š\n00: é»˜è®¤å€¼ï¼Œæœ€ä½ä¸‰ä½çš„ç´¢å¼•ç”¨äºå½“å‰PIOçš„IRQæ ‡å¿—ã€‚\n01(PREV): ç´¢å¼•å€¼ç”¨äºå‰ä¸€ä¸ªPIOçš„å¯¹åº”IRQæ ‡å¿—ã€‚\n10(REL): æœ€ä½ä¸‰ä½å€¼åŠ ä¸ŠçŠ¶æ€æœºç¼–å·å†æ¨¡4çš„å€¼ç”¨äºå½“å‰PIOçš„IRQæ ‡å¿—ã€‚\n11(NEXT): ç´¢å¼•å€¼ç”¨äºä¸‹ä¸€ä¸ªPIOçš„å¯¹åº”IRQæ ‡å¿—ã€‚\n\n\n\nIRQ æ ‡å¿— 4 ~ 7 åªèƒ½è¢«çŠ¶æ€æœºä½¿ç”¨ï¼Œè€Œ IRQ æ ‡å¿— 0 ~ 3 å¯ä»¥ä½œä¸ºç³»ç»Ÿçº§åˆ«çš„ä¸­æ–­ï¼Œåœ¨ PIO çš„ä¸¤ä¸ªå¤–éƒ¨ä¸­æ–­è¯·æ±‚çº¿ä¹‹ä¸€ä¸Šä½¿ç”¨ï¼Œå…·ä½“é‡‡ç”¨å“ªä¸ªå¤–éƒ¨ä¸­æ–­è¯·æ±‚çº¿ï¼Œç”± IRQ0_INTE å’Œ IRQ1_INTE é…ç½®ã€‚\nNEXT&#x2F;PREVæ¨¡å¼å¯ä»¥å†ä¸åŒPIOä¹‹é—´è¿›è¡ŒåŒæ­¥ï¼Œå¦‚æœè¿™äº›å¾…åŒæ­¥çš„PIOçŠ¶æ€æœºè®¾ç½®äº†æ—¶é’Ÿåˆ†é¢‘ï¼Œåˆ™å…¶åˆ†é¢‘é…ç½®å¿…é¡»ç›¸åŒï¼Œå¹¶ä¸”éœ€è¦é€šè¿‡å†™å…¥CTRL.NEXTPREV_CLKDIV_RESTARTåŠç›¸å…³çš„NEXT_PIO_MASK&#x2F;PREV_PIO_MASKä½æ¥åŒæ­¥æ—¶é’Ÿã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè·¨PIOåŒæ­¥åœ¨éå®‰å…¨ä»£ç ä¸­å…·æœ‰ä¸åŒå¯è®¿é—®æ€§çš„PIOä¹‹é—´å°†è¢«é˜»æ–­ã€‚ï¼ˆNEXT&#x2F;PREEVæ¨¡å¼ä¸é€‚ç”¨PIO version 0ï¼‰\næ¨¡ 4 åŠ æ³•å¯ä»¥å®ç° IRQ å’Œ WAIT æŒ‡ä»¤çš„â€œç›¸å¯¹å¯»å€â€ï¼Œç”¨äºè¿è¡ŒåŒä¸€ä¸ªç¨‹åºçš„ä¸åŒçŠ¶æ€æœºä¹‹é—´çš„åŒæ­¥ã€‚\nå¦‚æœè®¾ç½®äº† Waitï¼Œåˆ™ Delay å‘¨æœŸä¼šç­‰åˆ°ç­‰å¾…æœŸé—´ç»“æŸåå†å¼€å§‹ã€‚\n3.4.9.3. æ±‡ç¼–è¯­æ³•irq &lt;irq_num&gt; (prev, rel, next)\nirq set &lt;irq_num&gt; (prev, rel, next)\nirq nowait &lt;irq_num&gt; (prev, rel, next)\nirq wait &lt;irq_num&gt; (prev, rel, next)\nirq clear &lt;irq_num&gt; (prev, rel, next)\nå…¶ä¸­ï¼š\n&lt;irq_num&gt; (rel) æ˜¯ä¸€ä¸ªå€¼ï¼ˆå‚è§3.3.2èŠ‚ï¼‰ï¼ŒæŒ‡å®šè¦ç­‰å¾…çš„ IRQ ç¼–å·ï¼ˆ0 ~ 7ï¼‰ã€‚å¦‚æœå­˜åœ¨ relï¼Œåˆ™å®é™…çš„ IRQ ç¼–å·çš„è®¡ç®—æ–¹å¼ä¸ºï¼Œå°† IRQ ç¼–å·ï¼ˆirq_num10ï¼‰çš„æœ€ä½ä¸¤æ¯”ç‰¹æ›¿æ¢ä¸ºï¼ˆ&lt;irq_num10 + sm_num10ï¼‰çš„æœ€ä½ä¸¤æ¯”ç‰¹ï¼Œå…¶ä¸­ sm_num10 ä¸ºçŠ¶æ€æœºç¼–å·\nirq è¡¨ç¤ºè®¾ç½® IRQï¼Œæ— éœ€ç­‰å¾…\nirq set ä¹Ÿè¡¨ç¤ºè®¾ç½® IRQï¼Œæ— éœ€ç­‰å¾…\nirq nowait è¿˜æ˜¯è¡¨ç¤ºè®¾ç½® IRQï¼Œæ— éœ€ç­‰å¾…\nirq wait è¡¨ç¤ºè®¾ç½® IRQï¼Œç„¶åç­‰å¾… IRQ è¢«æ¸…é™¤åå†ç»§ç»­\nirq clear è¡¨ç¤ºæ¸…é™¤ IRQ\n3.4.10. SET3.4.10.1. ç¼–ç \n3.4.10.2. æ“ä½œå°†ä¸€ä¸ªæ•° Data å†™å…¥åˆ° Destinationã€‚\n\nDestinationï¼š\n000ï¼šPINS\n001ï¼šXï¼ˆå¯æ“¦å†™å¯„å­˜å™¨ Xï¼‰5 ä¸ª LSB æ¯”ç‰¹å†™å…¥ Dataï¼Œå…¶ä»–æ¯”ç‰¹æ¸…ä¸º 0ã€‚\n010ï¼šYï¼ˆå¯æ“¦å†™å¯„å­˜å™¨ Yï¼‰5 ä¸ª LSB æ¯”ç‰¹å†™å…¥ Dataï¼Œå…¶ä»–æ¯”ç‰¹æ¸…ä¸º 0ã€‚\n011ï¼šä¿ç•™\n100ï¼šPINDIRS\n101ï¼šä¿ç•™\n110ï¼šä¿ç•™\n111ï¼šä¿ç•™\n\n\nData: è®¾ç½®åˆ°ç®¡è„šæˆ–å¯„å­˜å™¨çš„ 5 æ¯”ç‰¹çš„ç«‹å³æ•°ã€‚\n\nè¯¥æŒ‡ä»¤ç”¨äºè®¾ç½®æ§åˆ¶ä¿¡å·ï¼Œå¦‚æ—¶é’Ÿæˆ–èŠ¯ç‰‡é€‰æ‹©ï¼Œæˆ–åˆå§‹åŒ–å¾ªç¯è®¡æ•°å™¨ã€‚ç”±äº Data åªæœ‰ 5 æ¯”ç‰¹ï¼Œå› æ­¤å¯æ“¦å†™å¯„å­˜å™¨å¯ä»¥ SET çš„å€¼ä¸º 0 ~ 31ï¼Œæœ€å¤§å¯å¾ªç¯ 32 æ¬¡ã€‚\nSET å’Œ OUT çš„ç®¡è„šæ˜ å°„æ˜¯ç‹¬ç«‹é…ç½®çš„ã€‚å®ƒä»¬å¯ä»¥æ˜ å°„åˆ°ä¸åŒçš„ä½ç½®ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªç®¡è„šä½œä¸ºæ—¶é’Ÿä¿¡å·ä½¿ç”¨ï¼Œå¦ä¸€ä¸ªä½œä¸ºæ•°æ®ä½¿ç”¨ã€‚å®ƒä»¬çš„ç®¡è„šèŒƒå›´ä¹Ÿå¯ä»¥é‡å ï¼šUART ä¼ è¾“ç¨‹åºå¯ä»¥ä½¿ç”¨ SET æ¥è®¾ç½®å¼€å§‹å’Œç»ˆæ­¢æ¯”ç‰¹ï¼Œç”¨ OUT æŒ‡ä»¤å‘åŒä¸€ä¸ªç®¡è„šä¸Šç§»å‡º FIFO æ•°æ®ã€‚SETæŒ‡ä»¤æœ€å¤šå¯ä»¥æ§åˆ¶5ä¸ªç®¡è„šçš„è¾“å‡ºå’Œæ–¹å‘ã€‚\n3.4.10.3. æ±‡ç¼–æ ¼å¼set &lt;destination&gt;, &lt;value&gt;\nå…¶ä¸­ï¼š\n&lt;destination&gt; ä¸ºä¸Šè¿°ç›®çš„åœ°ä¹‹ä¸€ã€‚\n&lt;value&gt; æ˜¯è¦è®¾ç½®çš„å€¼ï¼ˆå‚è§3.3.2èŠ‚ï¼‰ï¼Œæœ‰æ•ˆå€¼ä¸º 0 ~ 31ã€‚\n3.4.11. MOV(to RX)3.4.11.1. ç¼–ç æœªæ·»åŠ ã€‚\n3.4.11.2. æ“ä½œå°†ISRå¯„å­˜å™¨æŒ‰ç…§é€‰å®šçš„ä½ç½®å†™å…¥RXFIFOã€‚çŠ¶æ€æœºå¯ä»¥æŒ‰ç…§ä»»æ„é¡ºåºå†™å…¥RXFIFOï¼Œç”±Yå¯„å­˜å™¨æˆ–ç«‹å³æ•°è¿›è¡Œç´¢å¼•ã€‚å‰ææ˜¯éœ€è¦å¯¹SHIFTCTRL_FJOIN_RX_PUTå­—æ®µè¿›è¡Œé…ç½®ï¼Œå¦åˆ™è¯¥æ“ä½œæœªå®šä¹‰ã€‚\næ³¨æ„ï¼ŒRXFIFOå­˜å‚¨å¯„å­˜å™¨åªæœ‰ä¸€ä¸ªè¯»ç«¯å£å’Œå†™ç«¯å£ï¼Œä»»ä½•æ—¶å€™æ¯ä¸ªç«¯å£çš„è®¿é—®éƒ½å€¼åˆ†é…ç»™å…¶ä¸­ä¸€ä¸ªï¼ˆç³»ç»Ÿæˆ–çŠ¶æ€æœºï¼‰ã€‚\n3.4.11.3. æ±‡ç¼–æ ¼å¼mov rxfifo[y], isrmov rxfifo[&lt;index&gt;], isr\nå…¶ä¸­ï¼š\ny è¡¨ç¤ºRXFIFOç”±yå¯„å­˜å™¨æ¥ç´¢å¼•&lt;index&gt; ä½¿ç”¨ä¸€ä¸ªç«‹å³æ•°å¯¹RXFIFOè¿›è¡Œç´¢å¼•ï¼Œæœ‰æ•ˆå€¼æ˜¯0ï½3ã€‚\n3.4.12. MOV(from RX)3.4.12.1. ç¼–ç æœªæ·»åŠ ã€‚\n3.4.12.2. æ“ä½œå°†æ‰€é€‰çš„RXFIFOæ¡ç›®ä¿å­˜åˆ°OSRå¯„å­˜å™¨ã€‚PIOå¯ä»¥æŒ‰ç…§ä»»æ„é¡ºåºè¯»å–RXFIFOï¼Œç”±Yå¯„å­˜å™¨æˆ–ç«‹å³æ•°è¿›è¡Œç´¢å¼•ã€‚å‰ææ˜¯éœ€è¦å¯¹SHIFTCTRL_FJOIN_RX_GETå­—æ®µè¿›è¡Œé…ç½®ï¼Œå¦åˆ™è¯¥æ“ä½œæœªå®šä¹‰ã€‚\n3.4.12.3. æ±‡ç¼–æ ¼å¼mov osr, rxfifo[y]\nmov osr, rxfifo[&lt;index&gt;]\nå…¶ä¸­ï¼š\ny è¡¨ç¤ºRXFIFOç”±yå¯„å­˜å™¨æ¥ç´¢å¼•&lt;index&gt; ä½¿ç”¨ä¸€ä¸ªç«‹å³æ•°å¯¹RXFIFOè¿›è¡Œç´¢å¼•ï¼Œæœ‰æ•ˆå€¼æ˜¯0ï½3ã€‚\n3.5. åŠŸèƒ½è¯¦è§£3.5.1. Side-setSide-set ç‰¹æ€§å¯ä»¥è®©çŠ¶æ€æœºåœ¨æ‰§è¡Œä¸»æŒ‡ä»¤çš„åŒæ—¶ï¼Œæ”¹å˜æœ€å¤š 5 ä¸ªç®¡è„šçš„ç”µå¹³æˆ–æ–¹å‘ã€‚\néœ€è¦ä½¿ç”¨ side-set çš„ä¾‹å­ä¹‹ä¸€å°±æ˜¯é«˜é€Ÿ SPI æ¥å£ï¼Œå…¶æ•°æ®æ¯”ç‰¹ä» OSR æ¨å‡ºåˆ° GPIOï¼Œè€Œæ—¶é’Ÿä¿¡å·è½¬æ¢ï¼ˆä» 1 åˆ° 0ï¼Œ æˆ–ä» 0 åˆ° 1ï¼‰å¿…é¡»ä¸æ­¤åŒæ—¶å‘ç”Ÿã€‚\næ­¤æ—¶ï¼Œä¸€ä¸ªå¸¦æœ‰ side-set çš„ OUT å°±èƒ½åŒæ—¶å®Œæˆä¸¤é¡¹ä»»åŠ¡ã€‚\nè¿™æ ·å¯ä»¥ä¿è¯æ¥å£çš„æ—¶åºæ›´ç²¾ç¡®ï¼Œå‡å°æ•´ä½“çš„ç¨‹åºå¤§å°ï¼ˆå› ä¸ºä¸éœ€è¦ç‹¬ç«‹çš„ SET æŒ‡ä»¤è®¾ç½®æ—¶é’Ÿç®¡è„šï¼‰ï¼Œè€Œä¸”æé«˜äº† SPI èƒ½æ”¯æŒçš„æœ€å¤§é¢‘ç‡ã€‚\nSide-set è¿˜å¯ä»¥è®© GPIO æ˜ å°„æ›´çµæ´»ï¼Œå› ä¸ºå®ƒçš„æ˜ å°„ç‹¬ç«‹äº SET çš„æ˜ å°„ã€‚ç¤ºä¾‹ I2C ä»£ç åœ¨ç¦æ­¢æ—¶é’Ÿæ‹‰ä¼¸ï¼ˆclock strechingï¼‰çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å°† SDA å’Œ SCL æ˜ å°„åˆ°ä»»æ„ç®¡è„šä¸Šã€‚\næ­£å¸¸æƒ…å†µä¸‹ï¼ŒSCL åè½¬ç”¨äºåŒæ­¥æ•°æ®ä¼ è¾“ï¼Œè€Œ SDA åŒ…å«ç§»å‡ºçš„æ•°æ®æ¯”ç‰¹ã€‚ä½†æ˜¯ï¼Œä¸€äº›ç‰¹å®šçš„ I2C åºåˆ—ï¼Œå¦‚ Start å’Œ Stop çº¿æ¡ä»¶ï¼Œéœ€è¦åœ¨ SDA å’Œ SCL ä¸Šäº§ç”Ÿç‰¹å®šçš„è„‰å†²ã€‚I2C é€šè¿‡å¦‚ä¸‹æ˜ å°„æ¥å®ç°è¿™ä¸€ç‚¹ï¼š\n\nSide-set â†’ SCL\nOUT â†’ SDA\nSET â†’ SDA\n\nè¿™æ ·ï¼ŒçŠ¶æ€æœºå°±å¯ä»¥åœ¨ SDA ä¸Šæä¾›ä¸¤ç§æƒ…å†µçš„æ•°æ®ï¼Œåœ¨ SCL ä¸Šæä¾›æ—¶é’Ÿï¼Œæˆ–è€…åŒæ—¶åœ¨ SDA å’Œ SCL ä¸Šæä¾›å›ºå®šçš„è½¬æ¢ï¼ŒåŒæ—¶ä¾ç„¶å…è®¸ SDA å’Œ SCL è¢«æ˜ å°„åˆ°ä»»æ„ä¸¤ä¸ª GPIO ä¸Šã€‚\nSide-set æ•°æ®ç¼–ç åˆ°æ¯æ¡æŒ‡ä»¤çš„ Delay/side-set å­—æ®µã€‚ä»»ä½•æŒ‡ä»¤éƒ½å¯ä»¥ä¸ side-set ç»„åˆï¼ŒåŒ…æ‹¬ OUT PINSã€SET PINS ç­‰å†™å…¥ç®¡è„šçš„æŒ‡ä»¤ã€‚\nSide-set çš„ç®¡è„šæ˜ å°„ç‹¬ç«‹äº OUT å’Œ SET çš„æ˜ å°„ï¼Œä½†å®ƒä»¬å¯ä»¥é‡å ã€‚å¦‚æœ side-set å’Œ OUT æˆ– SET åŒæ—¶å†™å…¥åŒä¸€ä¸ªç®¡è„šï¼Œåˆ™é‡‡ç”¨ side-set çš„æ•°æ®ã€‚\næ³¨æ„ å¦‚æœæŒ‡ä»¤è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œside-set ä¾ç„¶ä¼šç«‹å³ç”Ÿæ•ˆã€‚\n1 .program spi_tx_fast2 .side_set 13 4 loop:5     out pins, 1   side 06     jmp loop      side 1\n\nspi_tx_fast ç¤ºä¾‹å±•ç¤ºäº† side-set çš„ä¸¤ä¸ªä¼˜åŠ¿ï¼šæ•°æ®å’Œæ—¶é’Ÿå¯ä»¥æ›´ç²¾ç¡®åœ°å¯¹é½ï¼Œå¹¶ä¸”ç¨‹åºæ•´ä½“ä¸Šå¯ä»¥æ›´å¿«ï¼Œæœ¬ä¾‹ä¸­æ¯ä¸¤ä¸ªç³»ç»Ÿæ—¶é’Ÿå‘¨æœŸå°±èƒ½è¾“å‡ºä¸€æ¯”ç‰¹ã€‚ç¨‹åºä¹Ÿå¯ä»¥æ›´å°ã€‚\nä½¿ç”¨ side-set æ—¶éœ€è¦é…ç½®å››ä¸ªé€‰é¡¹ï¼š\n\nDelay/side-set å­—æ®µç”¨äº side-set è€Œä¸æ˜¯å»¶æ—¶çš„ MSB æ¯”ç‰¹æ•°ã€‚é€šè¿‡ PINCTRL_SIDESET_COUNT è®¾ç½®ã€‚å¦‚æœè®¾ç½®ä¸º 5ï¼Œåˆ™æ— æ³•ä½¿ç”¨å»¶æ—¶å‘¨æœŸã€‚å¦‚æœè®¾ç½®ä¸º 0ï¼Œåˆ™æ— æ³•ä½¿ç”¨ side-setã€‚\næ˜¯å¦ä½¿ç”¨æœ€é«˜æ¯”ç‰¹ä½œä¸ºæœ‰æ•ˆä½ã€‚Side-set åªæœ‰åœ¨è®¾ç½®äº†æœ‰æ•ˆä½çš„æŒ‡ä»¤ä¸Šç”Ÿæ•ˆã€‚å¦‚æœä¸ä½¿ç”¨æœ‰æ•ˆä½ï¼Œåˆ™å½“ SIDESET_COUNT ä¸ä¸ºé›¶æ—¶ï¼Œè¯¥çŠ¶æ€æœºä¸Šçš„æ‰€æœ‰æŒ‡ä»¤éƒ½ä¼šæ‰§è¡Œ side-setã€‚è¯¥é€‰é¡¹ç”± EXECCTRL_SIDE_EN è®¾ç½®ã€‚\næ˜ å°„åˆ° side-set æœ€ä½æ¯”ç‰¹çš„ GPIO ç¼–å·ã€‚ç”± PINCTRL_SIDESET_BASE è®¾ç½®ã€‚\nside-set å†™å…¥åˆ° GPIO ç”µå¹³è¿˜æ˜¯ GPIO æ–¹å‘ã€‚ç”± EXECCTRL_SIDE_PINDIR è®¾ç½®ã€‚\n\nä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åªè®¾ç½®äº†ä¸€ä¸ª side-set æ¯”ç‰¹ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½æ‰§è¡Œ side-setï¼Œå› æ­¤ä¸éœ€è¦æœ‰æ•ˆä½ã€‚SIDESET_COUNT ä¸º 1ï¼ŒSIDE_EN ä¸ºå‡ã€‚SIDE_PINDIR ä¸ºå‡ï¼Œå› ä¸ºæˆ‘ä»¬è¦é©±åŠ¨æ—¶é’Ÿä¿¡å·çš„é«˜ä½ç”µå¹³ï¼Œè€Œä¸æ˜¯é«˜ä½é˜»æŠ—ã€‚SIDESET_BASE ä¸ºæ—¶é’Ÿä¿¡å·å¯¹åº”çš„ GPIO ç®¡è„šç¼–å·ã€‚\n3.5.2. ç¨‹åºæŠ˜è¿”PIO ç¨‹åºé€šå¸¸æœ‰ä¸€ä¸ªâ€œå¤–å±‚å¾ªç¯â€ï¼šåœ¨ FIFO å’Œå¤–éƒ¨ä¹‹é—´ä¼ è¾“æ•°æ®æ—¶ï¼Œå®ƒä»¬éœ€è¦åå¤æ‰§è¡ŒåŒæ ·çš„æ­¥éª¤ã€‚æœ€å°çš„ç¤ºä¾‹å°±æ˜¯å‰é¢çš„æ–¹æ³¢ç¤ºä¾‹ï¼š\nPico ç¤ºä¾‹ï¼šhttps://github.com/raspberrypi/pico-examples/tree/master/pio/squarewave/squarewave.pio ç¬¬7-12è¡Œ\n\n 7 .program squarewave 8     set pindirs, 1 ; Set pin to output 9 again:10     set pins, 1 [1] ; Drive pin high and then delay for one cycle11     set pins, 0 ; Drive pin low12     jmp again ; Set PC to label `again`\n\nç¨‹åºçš„ä¸»é¢˜éƒ¨åˆ†è®¾ç½®ç®¡è„šä¸ºé«˜ï¼Œç„¶åè®¾ç½®ä¸ºä½ï¼Œä»è€Œäº§ç”Ÿæ–¹æ³¢çš„ä¸€ä¸ªå‘¨æœŸã€‚ç„¶åæ•´ä¸ªç¨‹åºè¿›è¡Œå¾ªç¯ï¼Œä»¥äº§ç”Ÿå‘¨æœŸæ€§çš„è¾“å‡ºã€‚è·³è½¬æŒ‡ä»¤æœ¬èº«éœ€è¦ä¸€ä¸ªå‘¨æœŸï¼Œæ¯ä¸ª set æŒ‡ä»¤ä¹Ÿéœ€è¦ä¸€ä¸ªå‘¨æœŸï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯é«˜ä½éƒ¨åˆ†çš„é•¿åº¦ç›¸åŒï¼Œset pins, 1 æŒ‡ä»¤å¢åŠ äº†ä¸€ä¸ªå‘¨æœŸçš„å»¶æ—¶ï¼Œä½¿çŠ¶æ€æœºåœ¨æ‰§è¡Œ set pins, 0 æŒ‡ä»¤ä¹‹å‰ç­‰å¾…ä¸€ä¸ªå‘¨æœŸã€‚æ¯æ¬¡å¾ªç¯æ€»å…±éœ€è¦ 4 ä¸ªå‘¨æœŸã€‚è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š\n\nJMP å ç”¨äº†æœ¬å¯ç”¨äºå…¶ä»–ç¨‹åºçš„æŒ‡ä»¤å†…å­˜\næ‰§è¡Œ JMP æ‰€éœ€çš„é¢å¤–å‘¨æœŸå¯¼è‡´æœ€å¤§è¾“å‡ºé€Ÿåº¦é™ä½äº†ä¸€åŠ\n\nç”±äºç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰è¶…è¿‡ 31 æ—¶ä¼šè‡ªåŠ¨æŠ˜è¿”ä¸º 0ï¼Œå› æ­¤å°†æ•´ä¸ªæŒ‡ä»¤å†…å­˜å¡«å……ä¸º set pins, 1 å’Œ set pins, 0ï¼Œå°±èƒ½è§£å†³ç¬¬äºŒä¸ªé—®é¢˜ï¼Œä½†è¿™æ ·å¾ˆæµªè´¹ã€‚çŠ¶æ€æœºæœ‰ä¸€ä¸ªç¡¬ä»¶ç‰¹æ€§ï¼Œé€šè¿‡é…ç½® EXECCTRL æ§åˆ¶å¯„å­˜å™¨ï¼Œå°±èƒ½è§£å†³å¤§éƒ¨åˆ†æƒ…å†µä¸‹çš„é—®é¢˜ã€‚\nPicoç¤ºä¾‹ï¼šhttps://github.com/raspberrypi/pico-examples/tree/master/pio/squarewave/squarewave_wrap.pio ç¬¬11-19è¡Œ\n\n11 .program squarewave_wrap12 ; Like squarewave, but use the state machine&#x27;s .wrap hardware instead of an13 ; explicit jmp. This is a free (0-cycle) unconditional jump.14 15     set pindirs, 1    ; Set pin to output16 .wrap_target17     set pins, 1 [1]   ; Drive pin high and then delay for one cycle18     set pins, 0 [1]   ; Drive pin low and then delay for one cycle19 .wrap\n\nåœ¨æ‰§è¡Œå®Œç¨‹åºå†…å­˜ä¸­çš„ä¸€æ¡æŒ‡ä»¤åï¼ŒçŠ¶æ€æœºä¼šä½¿ç”¨ä»¥ä¸‹é€»è¾‘æ›´æ–° PCï¼š\n\nå¦‚æœå½“å‰æŒ‡ä»¤ä¸º JMPï¼Œä¸” Condition ä¸ºçœŸï¼Œåˆ™è®¾ç½® PC ä¸º Target\nå¦åˆ™ï¼Œå¦‚æœ PC ç­‰äº EXECCTRL_WRAP_TOPï¼Œåˆ™è®¾ç½® PC ä¸º EXECCTRL_WRAP_BOTTOM\nå¦åˆ™ï¼ŒPC åŠ ä¸€ï¼Œä½†å¦‚æœå½“å‰å€¼ä¸º 31ï¼Œåˆ™è®¾ç½®ä¸º 0ã€‚\n\npioasm ä¸­çš„ .wrap_target å’Œ .wrap æ±‡ç¼–æ ‡è¯†å®é™…ä¸Šæ˜¯æ ‡ç­¾ã€‚å®ƒä»¬ä¼šå¯¼å‡ºå¸¸é‡ï¼Œä»¥å†™å…¥åˆ° WRAP_BOTTOM å’Œ WRAP_TOPä¸­ã€‚\nPicoç¤ºä¾‹ï¼šhttps://github.com/raspberrypi/pico-examples/tree/master/pio/squarewave/generated/squarewave_wrap.pio.h ç¬¬1-37è¡Œ\n\n// -------------------------------------------------- //// This file is autogenerated by pioasm; do not edit! //// -------------------------------------------------- //#pragma once#if !PICO_NO_HARDWARE#include &quot;hardware/pio.h&quot;#endif// --------------- //// squarewave_wrap //// --------------- //#define squarewave_wrap_wrap_target 1#define squarewave_wrap_wrap 2static const uint16_t squarewave_wrap_program_instructions[] = &#123;    0xe081, //  0: set    pindirs, 1                             //     .wrap_target    0xe101, //  1: set    pins, 1                [1]     0xe100, //  2: set    pins, 0                [1]             //     .wrap&#125;;#if !PICO_NO_HARDWAREstatic const struct pio_program squarewave_wrap_program = &#123;    .instructions = squarewave_wrap_program_instructions,    .length = 3,    .origin = -1,&#125;;static inline pio_sm_config squarewave_wrap_program_get_default_config(uint offset) &#123;    pio_sm_config c = pio_get_default_sm_config();    sm_config_set_wrap(&amp;c, offset + squarewave_wrap_wrap_target, offset + squarewave_wrap_wrap);    return c;&#125;#endif\n\nè¿™æ˜¯ PIO æ±‡ç¼–å™¨ pioasm äº§ç”Ÿçš„åŸå§‹è¾“å‡ºï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„ pio_sm_config å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«äº†ç¨‹åºä»£ç ä¸­çš„ WRAP å¯„å­˜å™¨å€¼ã€‚ä¹Ÿå¯ä»¥ç›´æ¥åˆå§‹åŒ–æ§åˆ¶å¯„å­˜å™¨å­—æ®µã€‚\næ³¨æ„ WRAP_BOTTOM å’Œ WRAP_TOP æ˜¯ PIO æŒ‡ä»¤å†…å­˜ä¸­çš„ç»å¯¹åœ°å€ã€‚å¦‚æœç¨‹åºåŠ è½½åˆ°æŸä¸ªåç§»é‡ï¼Œé‚£ä¹ˆå¿…é¡»ç›¸åº”åœ°è°ƒæ•´æŠ˜è¿”åœ°å€ã€‚\nsquarewave_wrap ç¤ºä¾‹ä¸­æ’å…¥äº†å»¶æ—¶å‘¨æœŸï¼Œæ‰€ä»¥å®ƒçš„è¡Œä¸ºä¸åŸç‰ˆ squarewave ç¨‹åºå®Œå…¨ç›¸åŒã€‚ä½†ç”±äºä½¿ç”¨äº†ç¨‹åºæŠ˜è¿”ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å»æ‰å»¶æ—¶ï¼Œè¿™æ ·è¾“å‡ºçš„é€Ÿåº¦å°±æ˜¯ä»¥å‰çš„ä¸¤å€ï¼ŒåŒæ—¶è¿˜èƒ½ç»´æŒé«˜ç”µå¹³å’Œä½ç”µå¹³çš„æ—¶é—´ç›¸ç­‰ã€‚\nPicoç¤ºä¾‹ï¼šhttps://github.com/raspberrypi/pico-examples/tree/master/pio/squarewave/squarewave_fast.pio ç¬¬12-18è¡Œ\n\n12 .program squarewave_fast13 ; Like squarewave_wrap, but remove the delay cycles so we can run twice as fast.14     set pindirs, 1    ; Set pin to output15 .wrap_target16     set pins, 1       ; Drive pin high17     set pins, 0       ; Drive pin low18 .wrap\n\n3.5.3. FIFO åˆå¹¶é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªçŠ¶æ€æœºæ‹¥æœ‰ä¸¤ä¸ª 4 å­—é•¿çš„ FIFOï¼šä¸€ä¸ªç”¨äºå°†æ•°æ®ä»ç³»ç»Ÿä¼ é€åˆ°çŠ¶æ€æœºï¼ˆTXï¼‰ï¼Œä¸€ä¸ªç”¨äºåæ–¹å‘ï¼ˆRXï¼‰ã€‚ä½†æ˜¯ï¼Œå¾ˆå¤šç¨‹åºå¹¶ä¸éœ€è¦ç³»ç»Ÿå’ŒçŠ¶æ€æœºä¹‹é—´çš„åŒå‘æ•°æ®ä¼ è¾“ï¼Œè€Œæ›´é•¿çš„ FIFO å´å¾ˆæœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨ DPI è¿™ç§é«˜å¸¦å®½çš„æ¥å£ä¸­ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡ SHIFTCTRL_FJOIN é€‰é¡¹å°†ä¸¤ä¸ª 4 å­—é•¿çš„ FIFO åˆå¹¶ä¸ºä¸€ä¸ª 8 å­—é•¿çš„ FIFOã€‚\n\n\n\n\n\n\n\nå›¾42. å¯åˆå¹¶çš„åŒ FIFOã€‚æ¯ä¸ª FIFO ä¸º 4 å­—é•¿ï¼ŒåŒ…æ‹¬ 4 ä¸ªæ•°æ®å¯„å­˜å™¨ã€ä¸€ä¸ª 1ï¼š4 è§£ç å™¨å’Œä¸€ä¸ª 4:1 å¤šè·¯å¤ç”¨å™¨ã€‚å¤šè·¯å¤ç”¨å¯ä»¥åœ¨ TX å’Œ RX é€šé“ä¹‹é—´è¿›è¡Œå†™æ•°æ®å’Œè¯»æ•°æ®æ“ä½œï¼Œè¿™æ ·æ‰€æœ‰ 8 ä¸ªå­—éƒ½å¯ä»¥ä»ä¸¤ä¸ªç«¯å£è¿›è¡Œè®¿é—®ã€‚\n\n\nå¦ä¸€ä¸ªç”¨ä¾‹æ˜¯ UARTã€‚ç”±äº UART çš„ TX&#x2F;CTS å’Œ RX&#x2F;RTS éƒ¨åˆ†æ˜¯å¼‚æ­¥çš„ï¼Œå› æ­¤å®ƒä»¬æ˜¯åœ¨ä¸¤ä¸ªç‹¬ç«‹çš„çŠ¶æ€æœºä¸Šå®ç°çš„ã€‚è€Œè®©æ¯ä¸ªçŠ¶æ€æœºçš„ä¸€åŠ FIFO èµ„æºç©ºé—²ï¼Œæ˜¯ä¸€ç§æµªè´¹ã€‚ç”±äºæˆ‘ä»¬å¯ä»¥å°†ä¸¤ä¸ª FIFO åˆå¹¶æˆä¸€ä¸ª TX FIFO ä¾› TX&#x2F;CTS çŠ¶æ€æœºä½¿ç”¨ï¼Œæˆ–è€…åˆå¹¶æˆä¸€ä¸ª RX FIFO ä¾› RX&#x2F;RTS çŠ¶æ€æœºä½¿ç”¨ï¼Œè¿™æ ·å°±èƒ½åˆ©ç”¨å…¨éƒ¨èµ„æºã€‚è€Œæ‹¥æœ‰ 8 å­—æ·± FIFO çš„ UART èƒ½å¤Ÿå¤„ç†çš„ä¸­æ–­æ•°é‡æ˜¯ 4 å­—æ·± FIFO çš„ UART çš„ä¸¤å€ã€‚\nå¢åŠ  FIFO çš„æ·±åº¦ï¼ˆä» 4 å¢åŠ åˆ° 8ï¼‰åï¼ŒåŒä¸€ä¸ªçŠ¶æ€æœºä¸­çš„å¦ä¸€ä¸ª FIFO çš„å¤§å°å°±å˜ä¸ºé›¶ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå°† FIFO åˆå¹¶ä¾› TX ä½¿ç”¨ï¼Œé‚£ä¹ˆå°±æ— æ³•ä½¿ç”¨ RX FIFOï¼Œä»»ä½• PUSH æŒ‡ä»¤éƒ½ä¼šé™·å…¥ç­‰å¾…çŠ¶æ€ã€‚åœ¨ FSTAT å¯„å­˜å™¨ä¸­ï¼ŒRX FIFO åŒæ—¶è¡¨ç°ä¸º RXFULL å’Œ RXEMPTY çŠ¶æ€ã€‚è€Œåˆå¹¶åˆ° RX çš„æƒ…å†µæ­£ç›¸åï¼šTX FIFO ä¸å¯ç”¨ï¼Œè¯¥çŠ¶æ€æœºçš„ FSTAT ä¸­ TXFULL å’Œ TXEMPTY æ¯”ç‰¹å‡ä¸ºè®¾ç½®çŠ¶æ€ã€‚\nåªè¦ DMA æ²¡æœ‰å› ä¸ºå…¶ä»–ç«åˆçŠ¶æ€è€Œå˜æ…¢ï¼Œé‚£ä¹ˆ 8 å­— FIFO è¶³å¤Ÿé€šè¿‡ RP2040 çš„ DMA å®ç°æ¯ä¸ªå‘¨æœŸ 1 å­—çš„é€Ÿç‡ã€‚\næ³¨æ„ æ”¹å˜ FJOIN ä¼šæŠ›å¼ƒå½“å‰çŠ¶æ€æœºçš„ FIFO ä¸­çš„ä¸€åˆ‡æ•°æ®ã€‚å¦‚æœæ•°æ®ä¸èƒ½æ¢å¤ï¼Œé‚£ä¹ˆå¿…é¡»äº‹å…ˆæ¸…ç©º FIFO é˜Ÿåˆ—ã€‚\n3.5.4. è‡ªåŠ¨æ¨å‡ºå’Œè‡ªåŠ¨åŠ è½½éšç€ OUT æŒ‡ä»¤çš„æ‰§è¡Œï¼Œæ•°æ®ç§»å‡ºï¼ŒOSR ä¼šé€æ¸æ¸…ç©ºã€‚OSR ä¸ºç©ºåå¿…é¡»åŠ è½½æ•°æ®ï¼Œæ¯”å¦‚é€šè¿‡ PULL æŒ‡ä»¤ä» TX FIFO ä¼ è¾“ä¸€ä¸ªå­—çš„æ•°æ®åˆ° OSRã€‚ç±»ä¼¼åœ°ï¼ŒISR ä¸ºæ»¡åä¹Ÿå¿…é¡»æ¸…ç©ºã€‚ä¸€ç§æ–¹æ³•æ˜¯ï¼Œåœ¨ç§»ä½ä¸€å®šæ•°é‡çš„æ•°æ®ä¹‹åï¼Œé€šè¿‡å¾ªç¯æ‰§è¡Œä¸€æ¬¡ PULLï¼š\n 1 .program manual_pull 2 .side_set 1 opt 3  4 .wrap_target 5     set x, 2                     ; X = bit count - 2 6     pull            side 1 [1]   ; Stall here if no TX data 7 bitloop: 8     out pins, 1     side 0 [1]   ; Shift out data bit and toggle clock low 9     jmp x-- bitloop side 1 [1]   ; Loop runs 3 times10     out pins, 1     side 0       ; Shift out last bit before reloading X11 .wrap\n\nè¯¥ç¨‹åºæŒ‰ç…§æ¯ 4 ä¸ªæ—¶é’Ÿå‘¨æœŸ 1 æ¯”ç‰¹çš„é€Ÿç‡ï¼Œä»æ¯ä¸ª FIFO å­—ä¸­ç§»å‡º 4 æ¯”ç‰¹ï¼ŒåŒæ—¶è¾“å‡ºæ—¶é’Ÿä¿¡å·ã€‚å½“ TX FIFO ä¸ºç©ºæ—¶ï¼Œç¨‹åºåœ¨æ—¶é’Ÿé«˜ç”µå¹³å¤„æš‚åœï¼ˆæ³¨æ„åœ¨æŒ‡ä»¤æš‚åœçš„å‘¨æœŸä¸Š side-set ä¾ç„¶ä¼šç”Ÿæ•ˆï¼‰ã€‚å›¾43æ¼”ç¤ºäº†çŠ¶æ€æœºæ‰§è¡Œè¯¥ç¨‹åºçš„è¿‡ç¨‹ã€‚\n\n\n\n\n\n\n\nå›¾43. manual_pull ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ã€‚X æ˜¯å¾ªç¯è®¡æ•°å™¨ã€‚æ¯æ¬¡å¾ªç¯ä¼šç§»å‡ºä¸€æ¯”ç‰¹æ•°æ®ï¼Œç„¶åå°†æ—¶é’Ÿæ‹‰ä½ï¼Œå†æ‹‰é«˜ã€‚æ¯æ¡æŒ‡ä»¤éƒ½æœ‰ä¸€ä¸ªå‘¨æœŸçš„å»¶æ—¶ï¼Œå› æ­¤æ•´ä¸ªå¾ªç¯éœ€å ç”¨å››ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚åœ¨ç¬¬ä¸‰æ¬¡å¾ªç¯åï¼Œç§»å‡ºç¬¬å››æ¯”ç‰¹ï¼Œç„¶åçŠ¶æ€æœºç«‹å³è¿”å›ç¨‹åºå¼€å¤´ï¼Œé‡ç½®å¾ªç¯è®¡æ•°å™¨ï¼Œå¹¶åŠ è½½æ–°çš„æ•°æ®ï¼ŒåŒæ—¶ç»´æŒæ¯æ¯”ç‰¹ 4 ä¸ªæ—¶é’Ÿå‘¨æœŸçš„èŠ‚å¥ã€‚\n\n\nè¯¥ç¨‹åºæœ‰ä¸€äº›é™åˆ¶ï¼š\n\nå®ƒå ç”¨äº† 5 ä¸ªæŒ‡ä»¤æ§½ï¼Œä½†åªæœ‰ 2 ä¸ªæ˜¯æœ‰ç”¨çš„ï¼ˆout pins, 1 set 0 å’Œ ... set 1ï¼‰ï¼Œç”¨äºè¾“å‡ºä¸²è¡Œæ•°æ®å’Œæ—¶é’Ÿä¿¡å·ã€‚\nå®ƒçš„ååé‡çš„ä¸Šé™ä¸ºç³»ç»Ÿæ—¶é’Ÿé¢‘ç‡é™¤ä»¥ 4ï¼Œå› ä¸ºå®ƒéœ€è¦é¢å¤–çš„å‘¨æœŸæ¥åŠ è½½æ–°æ•°æ®å¹¶é‡æ–°è®¾ç½®å¾ªç¯è®¡æ•°å™¨ã€‚\n\nè¿™æ˜¯éå¸¸å¸¸è§çš„ä¸€ç§ PIO ç¨‹åºï¼Œæ‰€ä»¥æ²¡ä¸ªçŠ¶æ€æœºéƒ½æœ‰ä¸€äº›é¢å¤–çš„ç¡¬ä»¶æ¥å¤„ç†è¿™ç§æƒ…å†µã€‚çŠ¶æ€æœºä¼šè·Ÿè¸ªä» OSR OUT å‡ºçš„æ¯”ç‰¹æ•°ï¼Œä»¥åŠ IN è¿› ISR çš„æ¯”ç‰¹æ•°ï¼Œåœ¨è¿™äº›è®¡æ•°å™¨è¾¾åˆ°æŸä¸ªå¯é…ç½®çš„é˜ˆå€¼åï¼Œæ‰§è¡Œç‰¹å®šçš„åŠ¨ä½œã€‚\n\nåœ¨æ‰§è¡Œ OUT æŒ‡ä»¤æ—¶ï¼Œå¦‚æœè¾¾åˆ°æˆ–è¶…è¿‡åŠ è½½çš„é˜ˆå€¼ï¼Œä¸” TX FIFO ä¸­æœ‰æ•°æ®çš„è¯ï¼ŒçŠ¶æ€æœºå°±ä¼šåŒæ—¶å°† TX FIFO ä¸­çš„æ•°æ®åŠ è½½åˆ° OSR ä¸­ã€‚\nåœ¨æ‰§è¡Œ IN æŒ‡ä»¤æ—¶ï¼Œå¦‚æœè¾¾åˆ°æˆ–è¶…è¿‡æ¨å‡ºçš„é˜ˆå€¼ï¼Œä¸” RX FIFO ä¸­æœ‰æ•°æ®çš„è¯ï¼ŒçŠ¶æ€æœºå¯ä»¥ç›´æ¥å°†ç§»ä½ç»“æœå†™å…¥ RX FIFO ä¸­ï¼Œå¹¶æ¸…é™¤ ISRã€‚\n\nåˆ©ç”¨è‡ªåŠ¨åŠ è½½ï¼ˆautopullï¼‰åŠŸèƒ½ï¼Œmanual_pull ç¤ºä¾‹å¯ä»¥é‡å†™å¦‚ä¸‹ï¼š\n1 .program autopull2 .side_set 13 4 .wrap_target5     out pins, 1    side 0      [1]6     nop            side 1      [1]7 .wrap\n\nè¿™ä¸ªç¨‹åºæ¯”åŸç‰ˆæœ¬æ›´çŸ­ã€æ›´ç®€å•ï¼Œè€Œä¸”å¦‚æœå»æ‰å»¶æ—¶çš„è¯ï¼Œè¿è¡Œé€Ÿåº¦æ˜¯åŸç‰ˆæœ¬çš„ä¸¤å€ï¼Œå› ä¸ºé€šè¿‡ç¡¬ä»¶åŠ è½½ OSR æ˜¯â€œå…è´¹â€çš„ã€‚æ³¨æ„ç¨‹åºå¹¶ä¸çŸ¥é“ä¸‹ä¸€æ¬¡åŠ è½½ä¹‹å‰éœ€è¦ç§»ä½å¤šå°‘æ¯”ç‰¹ï¼›ç¡¬ä»¶ä¼šåœ¨è¾¾åˆ°é…ç½®å¥½çš„é˜ˆå€¼ï¼ˆSHIFTCTRL_PULL_THRESHï¼‰åè‡ªåŠ¨åŠ è½½ï¼Œæ‰€ä»¥ç¤ºä¾‹ç¨‹åºä¹Ÿå¯ä»¥ä»æ¯ä¸ª FIFO å­—ä¸­ç§»å‡º 16 æ¯”ç‰¹æˆ– 32 æ¯”ç‰¹ã€‚\næœ€åï¼Œæ³¨æ„ä¸Šè¿°ç¨‹åºä¸åŸæœ¬å¹¶éå®Œå…¨ç›¸åŒï¼Œå› ä¸ºå®ƒä¼šåœ¨æ—¶é’Ÿä¿¡å·ä½æ—¶æš‚åœï¼Œè€Œä¸æ˜¯é«˜çš„æ—¶å€™ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ PULL IFEMPTY æŒ‡ä»¤æ”¹å˜æš‚åœä½ç½®ï¼Œè¯¥æŒ‡ä»¤ä½¿ç”¨ä¸è‡ªåŠ¨åŠ è½½ï¼ˆautopullï¼‰åŒæ ·çš„å¯é…ç½®é˜ˆå€¼ï¼š\n1 .program somewhat_manual_pull2 .side_set 13 4 .wrap_target5     out pins, 1    side 0      [1]6     pull ifempty   side 1      [1]7 .wrap\n\nä¸‹é¢æ˜¯å®Œæ•´çš„ç¤ºä¾‹ï¼ˆPIO ç¨‹åºï¼Œä»¥åŠä¸€ä¸ªç”¨äºåŠ è½½å®ƒå¹¶è¿è¡Œçš„ C ç¨‹åºï¼‰ï¼Œæ¼”ç¤ºäº†å¦‚ä½•åœ¨åŒä¸€ä¸ªçŠ¶æ€æœºä¸ŠåŒæ—¶å¯ç”¨è‡ªåŠ¨åŠ è½½ï¼ˆautopullï¼‰å’Œè‡ªåŠ¨æ¨å‡ºï¼ˆautopushï¼‰ã€‚çŠ¶æ€æœº 0 çš„åŠŸèƒ½æ˜¯å°†æ•°æ®ä» TX FIFO ä¼ è¾“è‡³ RX FIFOï¼Œååé‡ä¸ºæ¯ä¸¤ä¸ªæ—¶é’Ÿå‘¨æœŸä¸€ä¸ªå­—ã€‚è¯¥ç¨‹åºè¿˜æ¼”ç¤ºäº†å½“ OSR å’Œ TX FIFO å‡ä¸ºç©ºæ—¶ï¼ŒçŠ¶æ€æœºä¼šåœ¨æ‰§è¡Œ OUT æ—¶è¿›å…¥æš‚åœçŠ¶æ€ã€‚\n1 .program auto_push_pull2 3 .wrap_target4     out x, 325     in x, 326 .wrap\n#include &quot;tb.h&quot; // TODO this is built against existing sw tree, so that we get printf etc#include &quot;platform.h&quot;#include &quot;pio_regs.h&quot;#include &quot;system.h&quot;#include &quot;hardware.h&quot;#include &quot;auto_push_pull.pio.h&quot;int main()&#123;    tb_init();    // Load program and configure state machine 0 for autopush/pull with    // threshold of 32, and wrapping on program boundary. A threshold of 32 is    // encoded by a register value of 00000.    for (int i = 0; i &lt; count_of(auto_push_pull_program); ++i)        mm_pio-&gt;instr_mem[i] = auto_push_pull_program[i];    mm_pio-&gt;sm[0].shiftctrl =            (1u &lt;&lt; PIO_SM0_SHIFTCTRL_AUTOPUSH_LSB) |            (1u &lt;&lt; PIO_SM0_SHIFTCTRL_AUTOPULL_LSB) |            (0u &lt;&lt; PIO_SM0_SHIFTCTRL_PUSH_THRESH_LSB) |            (0u &lt;&lt; PIO_SM0_SHIFTCTRL_PULL_THRESH_LSB);    mm_pio-&gt;sm[0].execctrl =            (auto_push_pull_wrap_target &lt;&lt; PIO_SM0_EXECCTRL_WRAP_BOTTOM_LSB) |            (auto_push_pull_wrap &lt;&lt; PIO_SM0_EXECCTRL_WRAP_TOP_LSB);    // Start state machine 0    hw_set_bits(&amp;mm_pio-&gt;ctrl, 1u &lt;&lt; (PIO_CTRL_SM_ENABLE_LSB + 0));    // Push data into TX FIFO, and pop from RX FIFO    for (int i = 0; i &lt; 5; ++i)        mm_pio-&gt;txf[0] = i;    for (int i = 0; i &lt; 5; ++i)        printf(&quot;%d\\n&quot;, mm_pio-&gt;rxf[0]);    return 0;&#125;\n\nå›¾44å±•ç¤ºäº†çŠ¶æ€æœºæ‰§è¡Œè¯¥ç¨‹åºçš„è¿‡ç¨‹ã€‚åˆå§‹æ—¶ï¼ŒOSR ä¸ºç©ºï¼Œæ‰€ä»¥çŠ¶æ€æœºä¼šåœ¨ç¬¬ä¸€æ¡ OUT æŒ‡ä»¤å¤„ç­‰å¾…ã€‚å½“ TX FIFO ä¸­æœ‰æ•°æ®æ—¶ï¼ŒçŠ¶æ€æœºä¼šå°†æ•°æ®ä¼ è¾“åˆ° OSR ä¸­ã€‚åœ¨ä¸‹ä¸€ä¸ªå‘¨æœŸï¼ŒOUT å¯ä»¥åˆ©ç”¨ OSR ä¸­çš„æ•°æ®æ‰§è¡Œï¼ˆæœ¬ä¾‹ä¸­å°†æ•°æ®ä¼ è¾“åˆ°å¯æ“¦å†™å¯„å­˜å™¨ X ä¸­ï¼‰ï¼ŒåŒæ—¶çŠ¶æ€æœºä¼šä½¿ç”¨ FIFO ä¸­çš„æ–°æ•°æ®å¡«å…… OSRã€‚ç”±äºæ¯ä¸€æ¡ IN æŒ‡ä»¤éƒ½ä¼šç«‹å³å¡«å…… ISRï¼Œå› æ­¤ ISR ä¸€ç›´ä¸ºç©ºï¼ŒIN å°±ä¼šç›´æ¥æŠŠæ•°æ®ä» X ä¼ è¾“åˆ° RX FIFOã€‚\n\n\n\n\n\n\n\nå›¾44. auto_push_pull ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ã€‚çŠ¶æ€æœºä¼šåœ¨ OUT ä¸Šæš‚åœï¼Œç›´åˆ°æ•°æ®ä» TX FIFO è¿›å…¥ OSRã€‚ç„¶åï¼Œæ¯æ¬¡æ‰§è¡Œ OUT æ“ä½œï¼Œç”±äºå…¶æ¯”ç‰¹æ•°ä¸º 32ï¼Œå› æ­¤ OSR éƒ½ä¼šåŒæ—¶è‡ªåŠ¨åŠ è½½ï¼Œè€Œ IN çš„æ•°æ®ä¼šè¶Šè¿‡ ISRï¼Œç›´æ¥è¿›å…¥ RX FIFOã€‚å½“ FIFO ç©ºä¸” OSR ä¹Ÿä¸ºç©ºæ—¶çŠ¶æ€æœºä¼šæš‚åœã€‚\n\n\nä¸ºäº†åœ¨æ­£ç¡®çš„æ—¶é—´è§¦å‘è‡ªåŠ¨æ¨å‡ºæˆ–è‡ªåŠ¨åŠ è½½ï¼ŒçŠ¶æ€æœºä¼šä½¿ç”¨ä¸€å¯¹ 6 æ¯”ç‰¹è®¡æ•°å™¨è·Ÿè¸ª ISR å’Œ OSR çš„æ€»ç§»ä½æ•°ã€‚\n\nå¤ä½åï¼Œæˆ–åœ¨ CTRL_SM_RESTART æ—¶ï¼ŒISR ç§»ä½è®¡æ•°å™¨è®¾ç½®ä¸º 0 ï¼ˆå°šæœªç§»å…¥ä»»ä½•æ•°æ®ï¼‰ï¼ŒOSR ç§»ä½è®¡æ•°å™¨è®¾ç½®ä¸º 32 ï¼ˆæ²¡æœ‰ä»»ä½•å¾…ç§»å‡ºæ•°æ®ï¼‰\nOUT æŒ‡ä»¤ä¼šç»™ OSR ç§»ä½è®¡æ•°å™¨å¢åŠ  Bit count\nIN æŒ‡ä»¤ä¼šç»™ ISR ç§»ä½è®¡æ•°å™¨å¢åŠ  Bit count\nPULL æŒ‡ä»¤æˆ–è‡ªåŠ¨åŠ è½½ä¼šå°† OSR è®¡æ•°å™¨æ¸…ä¸º 0\nPUSH æŒ‡ä»¤æˆ–è‡ªåŠ¨æ¨å‡ºä¼šå°† ISR è®¡æ•°å™¨æ¸…ä¸º 0\nMOV OSR, x æˆ– MOV ISR, x ä¼šå°† OSR æˆ– ISR ç§»ä½è®¡æ•°å™¨æ¸…ä¸º 0\nOUT ISR, n æŒ‡ä»¤ä¼šå°† ISR ç§»ä½è®¡æ•°å™¨è®¾ç½®ä¸º n\n\nåœ¨æ‰§è¡Œä»»ä½• OUT æˆ– IN æŒ‡ä»¤æ—¶ï¼ŒçŠ¶æ€æœºéƒ½ä¼šå°†ç§»ä½è®¡æ•°å™¨ä¸ SHIFTCTRL_PULL_THRESH å’Œ SHIFTCTRL_PUSH_THRESH æ¯”è¾ƒï¼Œæ¥å†³å®šæ˜¯å¦è¦é‡‡å–åŠ¨ä½œã€‚è‡ªåŠ¨åŠ è½½å’Œè‡ªåŠ¨æ¨å‡ºåˆ†åˆ«ç”± SHIFTCTRL_AUTOPULL å’Œ SHIFTCTRL_AUTOPUSH å­—æ®µå¯ç”¨ã€‚\n3.5.4.1. è‡ªåŠ¨æ¨å‡ºè¯¦è§£ä¸‹é¢æ˜¯å¯ç”¨äº†è‡ªåŠ¨æ¨å‡ºï¼ˆautopushï¼‰çš„ IN æŒ‡ä»¤çš„ä¼ªä»£ç ï¼š\nisr = shift_in(isr, input())isr count = saturate(isr count + in count)if rx count &gt;= threshold:    if rx fifo is full:        stall    else:        push(isr)        isr = 0        isr count = 0\n\næ³¨æ„ç¡¬ä»¶å¹³å°æ‰§è¡Œä¸Šè¿°æ­¥éª¤åªéœ€è¦ä¸€ä¸ªæœºå™¨æ—¶é’Ÿå‘¨æœŸï¼ˆé™¤éå‡ºç°æš‚åœï¼‰ã€‚\né˜ˆå€¼çš„èŒƒå›´ä¸º 1 ~ 32ã€‚\n3.5.4.2. è‡ªåŠ¨åŠ è½½è¯¦è§£åœ¨é OUT å‘¨æœŸï¼Œç¡¬ä»¶æ‰§è¡Œä»¥ä¸‹ä¼ªä»£ç ï¼š\nif MOV or PULL:    osr count = 0if osr count &gt;= threshold:    if tx fifo not empty:        osr = pull()        osr count = 0\n\nå› æ­¤ï¼Œè‡ªåŠ¨åŠ è½½å¯ä»¥åœ¨ä¸¤ä¸ª OUT ä¹‹é—´çš„ä»»ä½•ç‚¹å‘ç”Ÿï¼Œå–å†³äºæ•°æ®ä½•æ—¶åˆ°è¾¾ FIFOã€‚\nåœ¨ OUT å‘¨æœŸï¼Œæ­¥éª¤ç•¥æœ‰ä¸åŒï¼š\nif osr count &gt;= threshold:    if tx fifo not empty:        osr = pull()        osr count = 0    stallelse:    output(osr)    osr = shift(osr, out count)    osr count = saturate(osr count + out count)    if osr count &gt;= threshold:        if tx fifo not empty:            osr = pull()            osr count = 0\n\nç¡¬ä»¶èƒ½å¤Ÿåœ¨ç§»å‡ºå…¨éƒ¨æ•°æ®çš„åŒæ—¶å¡«å…… OSRï¼Œå› ä¸ºè¿™ä¸¤ä¸ªæ“ä½œå¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚ä½†æ˜¯ï¼Œç¡¬ä»¶æ— æ³•åœ¨åŒä¸€ä¸ªå‘¨æœŸæ‰§è¡Œå¡«å…… OSR å¹¶ â€˜OUTâ€™ åŒä¸€ä»½æ•°æ®ï¼Œå› ä¸ºè¿™æ ·åšä¼šé€ æˆå¾ˆé•¿çš„é€»è¾‘é“¾ã€‚\nå¯ä»¥è®¤ä¸ºï¼Œå¯¹äºç¨‹åºè€Œè¨€ï¼Œå¡«å……æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œä½† â€˜OUTâ€™ å°±åƒä¸€ä¸ªæ•°æ®å±éšœï¼ŒçŠ¶æ€æœºæ°¸è¿œä¸èƒ½ OUT å°šæœªå†™å…¥ FIFO çš„æ•°æ®ã€‚\næ³¨æ„ï¼Œåœ¨è‡ªåŠ¨åŠ è½½å¯ç”¨æ—¶ï¼Œä» OSR â€˜MOVâ€™ çš„æ“ä½œæ˜¯æœªå®šä¹‰çš„ï¼›æ ¹æ®ä¸ç³»ç»Ÿ DMA çš„ç«åˆçŠ¶æ€ï¼Œä½ å¯èƒ½ä¼šè¯»åˆ°å°šæœªç§»å‡ºçš„æ®‹ç•™æ•°æ®ï¼Œæˆ–è¯»åˆ° FIFO çš„æ–°æ•°æ®ã€‚ä¸æ­¤ç±»ä¼¼ï¼Œâ€™MOVâ€™ åˆ° OSR çš„æ“ä½œå¯èƒ½ä¼šè¦†ç›–åˆšåˆšè‡ªåŠ¨åŠ è½½è¿›æ¥çš„æ•°æ®ã€‚ä½†æ˜¯ï¼Œâ€™MOVâ€™ è¿› OSR çš„æ•°æ®æ°¸è¿œä¸ä¼šè¢«è¦†ç›–ï¼Œå› ä¸º â€˜MOVâ€™ ä¼šæ›´æ–°ç§»ä½è®¡æ•°å™¨ã€‚\nå¦‚æœä½ ç¡®å®éœ€è¦è¯»å– OSR çš„å†…å®¹ï¼Œåº”å½“æ˜¾å¼åœ°æ‰§è¡ŒæŸç§ â€˜PULLâ€™ã€‚ä¸Šé¢æè¿°çš„ä¸ç¡®å®šæ€§æ˜¯ç”±ç¡¬ä»¶è‡ªåŠ¨è¿›è¡ŒåŠ è½½çš„ä»£ä»·ã€‚å¯ç”¨è‡ªåŠ¨åŠ è½½ä¼šæ”¹å˜ â€˜PULLâ€™ çš„è¡Œä¸ºï¼šå¦‚æœ OSR ä¸ºæ»¡ï¼Œåˆ™ PULL ä¸ºè¯¯æ“ä½œã€‚è¿™æ ·åšæ˜¯ä¸ºäº†é¿å…ä¸ç³»ç»Ÿ DMA ä¹‹é—´çš„ç«åˆå†²çªã€‚å®ƒå°±åƒä¸€ä¸ªå±éšœï¼šæˆ–è€…è‡ªåŠ¨åŠ è½½å·²ç»å¼€å§‹æ‰§è¡Œï¼Œæ­¤æ—¶ â€˜PULLâ€™ æ“ä½œæ— æ•ˆï¼›æˆ–è€…ç¨‹åºä¼šåœ¨ â€˜PULLâ€™ æŒ‡ä»¤å¤„ç­‰å¾…ï¼Œç›´åˆ° FIFO æœ‰æ•°æ®ã€‚\nâ€˜PUSHâ€™ ä¸å­˜åœ¨ç›¸ä¼¼çš„è¡Œä¸ºï¼Œå› ä¸ºè‡ªåŠ¨æ¨å‡ºæ²¡æœ‰è¿™ç§ä¸ç¡®å®šæ€§ã€‚\n3.5.5. æ—¶é’Ÿåˆ†é¢‘å™¨PIO ä¾é ç³»ç»Ÿæ—¶é’Ÿè¿è¡Œï¼Œä½†å¯¹äºç»å¤§å¤šæ•°æ¥å£æ¥è¯´ï¼Œç³»ç»Ÿæ—¶é’Ÿå¤ªå¿«äº†ï¼Œè€Œå¯æ’å…¥çš„ Delay å‘¨æœŸæ•°æ˜¯æœ‰é™çš„ã€‚åƒ UART ç­‰è®¾å¤‡éœ€è¦ç²¾ç¡®åœ°æ§åˆ¶å¹¶æ”¹å˜ä¿¡å·çš„é€Ÿç‡ï¼Œæœ€å¥½æ˜¯è¿è¡ŒåŒä¸€ä¸ªç¨‹åºçš„å¤šä¸ªçŠ¶æ€æœºä¹Ÿèƒ½å¤Ÿç‹¬ç«‹åœ°æ”¹å˜é€Ÿç‡ã€‚å› æ­¤ï¼Œæ¯ä¸ªçŠ¶æ€æœºéƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„æ—¶é’Ÿåˆ†é¢‘å™¨ã€‚\næ—¶é’Ÿåˆ†é¢‘å™¨ä¸ä¼šé™ä½ç³»ç»Ÿæ—¶é’Ÿé€Ÿç‡ï¼Œè€Œæ˜¯å®šä¹‰äº†å¤šå°‘ä¸ªç³»ç»Ÿæ—¶é’Ÿå‘¨æœŸç­‰äºæ‰§è¡Œ PIO ç¨‹åºçš„â€œä¸€ä¸ªå‘¨æœŸâ€ã€‚å®ƒä¼šäº§ç”Ÿä¸€ä¸ªæ—¶é’Ÿå…è®¸ä¿¡å·ï¼Œè¯¥ä¿¡å·èƒ½å¤Ÿåœ¨æ¯ä¸ªç³»ç»Ÿæ—¶é’Ÿå‘¨æœŸæš‚åœæˆ–æ¢å¤æ‰§è¡Œã€‚æ—¶é’Ÿåˆ†é¢‘å™¨ä¼šä»¥ä¸€å®šçš„é—´éš”äº§ç”Ÿå…è®¸è„‰å†²ï¼Œä»è€ŒçŠ¶æ€æœºèƒ½å¤Ÿä»¥æŸä¸ªå›ºå®šçš„ã€æ¯”ç³»ç»Ÿæ—¶é’Ÿæ…¢å¾ˆå¤šçš„é€Ÿç‡è¿è¡Œã€‚\næ—¶é’Ÿåˆ†é¢‘å™¨å¯ä»¥ç®€åŒ–çŠ¶æ€æœºä¸ç³»ç»Ÿä¹‹é—´çš„æ¥å£ï¼Œé™ä½å»¶è¿Ÿï¼Œè€Œä¸”å ç”¨çš„èŠ¯ç‰‡é¢ç§¯å¾ˆå°ã€‚åœ¨æ—¶é’Ÿå…è®¸ä¿¡å·ä¸ºä½ç”µå¹³æ—¶ï¼ŒçŠ¶æ€æœºå®Œå…¨å¤„äºç©ºé—²çŠ¶æ€ï¼Œä¸è¿‡ç³»ç»Ÿä»ç„¶å¯ä»¥è®¿é—®çŠ¶æ€æœºçš„ FIFO å¹¶æ”¹å˜å…¶é…ç½®ã€‚\næ—¶é’Ÿåˆ†é¢‘å™¨æ”¯æŒ 16 æ¯”ç‰¹æ•´æ•°ã€8 æ¯”ç‰¹åˆ†æ•°ï¼Œå°æ•°åˆ†é¢‘å™¨é‡‡ç”¨ä¸€é˜¶ç§¯åˆ†-å¾®åˆ†ï¼ˆfirst-order delta-sigmaï¼‰ã€‚æ—¶é’Ÿåˆ†å‰²æ¯”ä¾‹å¯ä»¥åœ¨ 1 ~ 65536 ä¹‹é—´ä»¥ 1&#x2F;256 çš„å¢é‡æ”¹å˜ã€‚\nå¦‚æœæ—¶é’Ÿåˆ†å‰²æ¯”ä¾‹è®¾ç½®ä¸º 1ï¼Œåˆ™çŠ¶æ€æœºåœ¨æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸéƒ½ä¼šæ‰§è¡Œï¼Œå³å…¨é€Ÿæ‰§è¡Œï¼š\n\n\n\n\n\n\n\nå›¾45. æ—¶é’Ÿåˆ†å‰²æ¯”ä¾‹ä¸º 1 æ—¶çš„çŠ¶æ€æœºæ‰§è¡Œæƒ…å†µã€‚é€šè¿‡ CTRL å¯„å­˜å™¨å…è®¸çŠ¶æ€æœºä¹‹åï¼Œæ¯ä¸ªæ—¶é’Ÿå‘¨æœŸå…¶æ—¶é’Ÿå…è®¸ä¿¡å·éƒ½ä¸ºé«˜ã€‚\n\n\né€šå¸¸ï¼Œæ•´æ•°åˆ†å‰²æ¯”ä¾‹ä¼šè®©çŠ¶æ€æœºä»¥æ¯ n ä¸ªæ—¶é’Ÿå‘¨æœŸç­‰äº 1 ä¸ªæ‰§è¡Œå‘¨æœŸçš„é€Ÿç‡æ‰§è¡Œï¼Œå› æ­¤æœ‰æ•ˆæ—¶é’Ÿé€Ÿç‡ä¸º fsys &#x2F; nã€‚\n\n\n\n\n\n\n\nå›¾46. æ•´æ•°æ—¶é’Ÿåˆ†å‰²æ¯”ä¾‹äº§ç”Ÿä¸€ä¸ªå‘¨æœŸæ€§çš„æ—¶é’Ÿå…è®¸ä¿¡å·ã€‚æ—¶é’Ÿåˆ†é¢‘å™¨ä¼šä¸æ–­åœ°ä» n å¼€å§‹é€’å‡ï¼Œåœ¨åˆ°è¾¾ 1 æ—¶äº§ç”Ÿä¸€ä¸ªå…è®¸è„‰å†²ã€‚\n\n\nåˆ†æ•°åˆ†å‰²æ¯”ä¾‹ä¼šç»´æŒç¨³å®šçš„ n + f &#x2F; 256 çš„åˆ†å‰²é€Ÿç‡ï¼Œå…¶ä¸­ n å’Œ f æ˜¯è¯¥çŠ¶æ€æœºçš„ CLKDIV å¯„å­˜å™¨çš„æ•´æ•°å’Œåˆ†æ•°éƒ¨åˆ†ã€‚å®ƒä¼šæœ‰é€‰æ‹©åœ°åœ¨ n ä¸ªå‘¨æœŸåˆ° n+1 ä¸ªå‘¨æœŸä¹‹é—´å»¶é•¿æŸä¸ªåˆ†å‰²æœŸé—´ã€‚\n\n\n\n\n\n\n\nå›¾47. åˆ†æ•°æ—¶é’Ÿåˆ†å‰²æ¯”ä¾‹ï¼Œå¹³å‡åˆ†å‰²æ¯”ä¾‹ä¸º 2.5ã€‚æ—¶é’Ÿåˆ†é¢‘å™¨ä¼šåœ¨æ¯ä¸ªåˆ†å‰²å‘¨æœŸä¸Šæ”¹å˜åˆ†æ•°éƒ¨åˆ†çš„å€¼ï¼Œå½“åˆ°è¾¾ 1 æ—¶ï¼Œåˆ™ç»™æ•´æ•°éƒ¨åˆ†åŠ  1ï¼Œä»¥å»¶é•¿ä¸‹ä¸€ä¸ªåˆ†å‰²å‘¨æœŸã€‚\n\n\nå¯¹äºè¾ƒå°çš„ nï¼Œåˆ†æ•°åˆ†å‰²æ¯”ä¾‹å¯¼è‡´çš„æŠ–åŠ¨å¯èƒ½æ˜¯æ— æ³•æ¥å—çš„ã€‚ä½†æ˜¯ï¼Œå½“åˆ†å‰²æ¯”ä¾‹å¾ˆå¤§æ—¶ï¼ŒæŠ–åŠ¨å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚\næ³¨æ„ å¯¹äºé«˜é€Ÿå¼‚æ­¥ä¸²å£æ¥è¯´ï¼Œæœ€å¥½ä½¿ç”¨å¶æ•°åˆ†å‰²æ¯”ä¾‹ï¼Œæˆ– 1M æ³¢ç‰¹çš„æ•´æ•°å€ï¼Œè€Œä¸è¦ä½¿ç”¨ä¼ ç»Ÿçš„ 300 çš„å€æ•°ï¼Œä»¥é¿å…ä¸å¿…è¦çš„æŠ–åŠ¨ã€‚\n3.5.6. GPIO æ˜ å°„åœ¨å†…éƒ¨ï¼ŒPIO æœ‰ä¸€ä¸ª 32 ä½å¯„å­˜å™¨ï¼Œè¡¨ç¤ºå®ƒèƒ½é©±åŠ¨çš„æ¯ä¸ª GPIO ç®¡è„šçš„è¾“å‡ºç”µå¹³ï¼Œä»¥åŠå¦ä¸€ä¸ªå¯„å­˜å™¨è¡¨ç¤ºæ¯ä¸ªè¾“å‡ºå…è®¸çš„æƒ…å†µï¼ˆé«˜ä½é˜»æŠ—ï¼‰ã€‚åœ¨æ¯ä¸ªç³»ç»Ÿæ—¶é’Ÿå‘¨æœŸï¼Œæ¯ä¸ªçŠ¶æ€æœºéƒ½å¯ä»¥å†™å…¥è¿™äº›å¯„å­˜å™¨ä¸­çš„éƒ¨åˆ†æˆ–å…¨éƒ¨ GPIOã€‚\n\n\n\n\n\n\n\nå›¾48. çŠ¶æ€æœºæœ‰ä¸¤ä¸ªç‹¬ç«‹çš„è¾“å‡ºé€šé“ï¼Œä¸€ä¸ªç”± OUT&#x2F;SET å…±äº«ï¼Œå¦ä¸€ä¸ªç”± side-set ä½¿ç”¨ï¼ˆå¯åœ¨ä»»ä½•æ—¶åˆ»å‘ç”Ÿï¼‰ã€‚ä¸‰ä¸ªç‹¬ç«‹çš„æ˜ å°„ï¼ˆæ¯ä¸ªæ˜ å°„åŒ…æ‹¬ç¬¬ä¸€ä¸ª GPIO ç®¡è„šå·å’Œ GPIO ä¸ªæ•°ï¼‰æ§åˆ¶ OUTã€SET å’Œ side-set è¢«å®šå‘åˆ°å“ªä¸ª GPIOã€‚è¾“å…¥æ•°æ®ä¼šæ ¹æ®å“ªä¸ª GPIO è¢«æ˜ å°„åˆ° IN æ•°æ®çš„ LSB è¿›è¡Œæ—‹è½¬ã€‚\n\n\nè¾“å‡ºç”µå¹³å’Œè¾“å‡ºå…è®¸å¯„å­˜å™¨çš„å†™æ•°æ®å’Œå†™æ©ç æ¥è‡ªä»¥ä¸‹æ¥æºï¼š\n\nä¸€æ¡ OUT æŒ‡ä»¤ï¼Œæœ€å¤šèƒ½å†™ 32 æ¯”ç‰¹ã€‚æ ¹æ®æŒ‡ä»¤çš„ Destination å­—æ®µï¼Œè¯¥æŒ‡ä»¤å¯ä»¥åº”ç”¨äºç®¡è„šæˆ–ç®¡è„šæ–¹å‘ã€‚OUT æ•°æ®çš„æœ€ä½ä½æ˜ å°„åˆ° PINCTRL_OUT_BASEï¼Œå‘åä¾æ¬¡æ˜ å°„ PINCTRL_OUT_COUNT ä¸ªæ¯”ç‰¹ï¼Œåœ¨åˆ°è¾¾ GPIO31 åæŠ˜è¿”ã€‚\nä¸€æ¡ SET æŒ‡ä»¤ï¼Œæœ€å¤šèƒ½å†™ 5 æ¯”ç‰¹ã€‚æ ¹æ®æŒ‡ä»¤çš„ Destination å­—æ®µï¼Œè¯¥æŒ‡ä»¤å¯ä»¥åº”ç”¨äºç®¡è„šæˆ–ç®¡æ•™æ–¹å‘ã€‚SET æ•°æ®çš„æœ€ä½ä½æ˜ å°„åˆ° PINCTRL_SET_BASEï¼Œå‘åä¾æ¬¡æ˜ å°„ PINCTRL_SET_COUNT ä¸ªæ¯”ç‰¹ï¼Œåœ¨åˆ°è¾¾ GPIO31 åæŠ˜è¿”ã€‚\nä¸€ä¸ª side-set æ“ä½œï¼Œæœ€å¤šèƒ½å†™ 5 æ¯”ç‰¹ã€‚æ ¹æ® EXECCTRL_SIDE_PINDIR å¯„å­˜å™¨å­—æ®µçš„å€¼ï¼Œè¯¥æ“ä½œå¯ä»¥åº”ç”¨äºç®¡è„šæˆ–ç®¡æ•™æ–¹å‘ã€‚side-set æ•°æ®çš„æœ€ä½ä½æ˜ å°„åˆ° PINCTRL_SIDESET_BASEï¼Œå‘åä¾æ¬¡æ˜ å°„ PINCTRL_SIDESET_COUNT ä¸ªæ¯”ç‰¹ï¼Œåœ¨åˆ°è¾¾ GPIO31 åæŠ˜è¿”ã€‚\n\næ¯ä¸ª OUT&#x2F;SET&#x2F;side-set æ“ä½œéƒ½ä¼šå†™è¿ç»­çš„ç®¡è„šåŒºé—´ï¼Œä½†æ¯ä¸ªåŒºé—´éƒ½åœ¨ 32 æ¯”ç‰¹çš„ GPIO ç©ºé—´å†…æœ‰ç‹¬ç«‹çš„å¤§å°å’Œä½ç½®ã€‚å¯¹äºå¤§å¤šæ•°åº”ç”¨æ¥è¯´ï¼Œè¿™å·²ç»è¶³å¤Ÿçµæ´»äº†ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªçŠ¶æ€æœºåœ¨ä¸€ç»„ç®¡è„šä¸Šå®ç°äº†åƒ SPI ç­‰æ¥å£ï¼Œé‚£ä¹ˆå¦ä¸€ä¸ªçŠ¶æ€æœºå¯ä»¥è¿è¡ŒåŒä¸€ä¸ªç¨‹åºï¼Œæ˜ å°„åˆ°å¦ä¸€ç»„ç®¡è„šä¸Šï¼Œæä¾›ç¬¬äºŒä¸ª SPI æ¥å£ã€‚\nåœ¨ä»»æ„æ—¶é’Ÿå‘¨æœŸï¼ŒçŠ¶æ€æœºå¯ä»¥æ‰§è¡Œä¸€æ¬¡ OUT æˆ– SETï¼Œå¹¶ä¸”å¯ä»¥åŒæ—¶æ‰§è¡Œä¸€æ¬¡ side-setã€‚ç®¡è„šæ˜ å°„é€»è¾‘ä¼šç”Ÿæˆä¸€ä¸ª 32 æ¯”ç‰¹çš„å†™æ©ç ï¼Œå¹¶æ ¹æ®æƒ…è¶£å†…å®¹å’Œç®¡è„šæ˜ å°„é…ç½®ï¼Œå°†è¾“å‡ºç”µå¹³å’Œè¾“å‡ºå…è®¸å¯„å­˜å™¨å†™å…¥æ•°æ®æ€»çº¿ã€‚\nå¦‚æœåŒä¸€ä¸ªçŠ¶æ€æœºåœ¨åŒä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…çš„ side-set æ“ä½œä¸ OUT&#x2F;SET æ“ä½œé‡å ï¼Œé‚£ä¹ˆåœ¨é‡å çš„åŒºåŸŸä¸­ side-set ä¼˜å…ˆã€‚\n3.5.6.1. è¾“å‡ºä¼˜å…ˆçº§\n\n\n\n\n\n\nå›¾49. æ¯ä¸ªçŠ¶æ€æœºå¯¹äºæ¯ä¸ª GPIO é€šè¿‡å†™æ©ç é€‰æ‹©ä¼˜å…ˆçº§ã€‚æ¯ä¸ª GPIO ä¼šè€ƒè™‘æ¥è‡ªå››ä¸ªçŠ¶æ€æœºçš„å†™å…¥ç”µå¹³å’Œæ–¹å‘ï¼Œç„¶ååº”ç”¨ç¼–å·æœ€å¤§çš„çŠ¶æ€æœºçš„å€¼ã€‚\n\n\næ¯ä¸ªçŠ¶æ€æœºåœ¨æ¯ä¸ªå‘¨æœŸä¼šé€šè¿‡å…¶ç®¡è„šæ˜ å°„ç¡¬ä»¶æ‰§è¡Œä¸€æ¬¡ OUT&#x2F;SET å’Œ side-setã€‚è¿™æ ·ï¼Œæ¯ä¸ªçŠ¶æ€æœºéƒ½ä¼šä¸º GPIO è¾“å‡ºç”µå¹³å’Œè¾“å‡ºå…è®¸å¯„å­˜å™¨ç”Ÿæˆ 32 æ¯”ç‰¹çš„å†™æ•°æ®å’Œå†™æ©ç ã€‚\nå¯¹äºæ¯ä¸ª GPIOï¼ŒPIO ä¼šè€ƒè™‘æ¥è‡ªæ‰€æœ‰å››ä¸ªçŠ¶æ€æœºçš„å†™æ“ä½œï¼Œç„¶ååº”ç”¨ç¼–å·æœ€å¤§çš„çŠ¶æ€æœºçš„å†™æ“ä½œã€‚è¿™ä¸€æ­¥éª¤æ˜¯é’ˆå¯¹è¾“å‡ºç”µå¹³å’Œè¾“å‡ºå€¼åˆ†åˆ«è¿›è¡Œçš„ï¼Œæ‰€ä»¥å¯èƒ½å‡ºç°åœ¨åŒä¸€ä¸ªå‘¨æœŸå†…ä¸€ä¸ªçŠ¶æ€æœºåŒæ—¶æ”¹å˜äº†åŒä¸€ä¸ªç®¡è„šçš„ç”µå¹³å’Œæ–¹å‘ï¼ˆä¾‹å¦‚é€šè¿‡åŒæ—¶å‘å‡ºçš„ SET å’Œ side-setï¼‰ï¼Œæˆ–ä¸€ä¸ªçŠ¶æ€æœºæ”¹å˜äº† GPIO æ–¹å‘ï¼Œå¦ä¸€ä¸ªçŠ¶æ€æœºæ”¹å˜äº†åŒä¸€ä¸ª GPIO çš„ç”µå¹³ã€‚å¦‚æœæ²¡æœ‰çŠ¶æ€æœºå†™å…¥ GPIO çš„ç”µå¹³æˆ–æ–¹å‘ï¼Œåˆ™å€¼ä¿æŒä¸å˜ã€‚\n3.5.6.2. è¾“å…¥æ˜ å°„IN æŒ‡ä»¤æ”¶åˆ°çš„æ•°æ®çš„æ–¹å¼æ˜¯ï¼ŒLSB æ˜ å°„åˆ° PINCTRL_IN_BASE è®¾ç½®çš„ GPIOï¼Œåç»­çš„æ›´é«˜ä½æ¥è‡ªåç»­æ›´é«˜ç¼–å·çš„ GPIOï¼Œåˆ°è¾¾ 31 æ—¶æŠ˜è¿”ã€‚\næ¢å¥è¯è¯´ï¼ŒIN æ€»çº¿æ˜¯ GPIO è¾“å…¥å€¼æ ¹æ® PINCTRL_IN_BASE çš„å³æ—‹ç»“æœã€‚å¦‚æœä¸å¤Ÿ 32 ä¸ª GPIOï¼Œåˆ™ PIO è¾“å…¥ä¼šåœ¨ç›¸åº”ä½ç½®ä¸Šå¡«å…… 0ï¼Œ ä»¥è¡¥é½ 32 æ¯”ç‰¹ã€‚\nåƒ WAIT GPIO ç­‰æŒ‡ä»¤ä¼šä½¿ç”¨ç»å¯¹ GPIO ç¼–å·ï¼Œè€Œä¸æ˜¯ IN æ•°æ®æ€»çº¿ä¸­çš„ç´¢å¼•ã€‚æ­¤æ—¶ä¸ä¼šè¿›è¡Œå³æ—‹ã€‚\n3.5.6.3. è¾“å…¥åŒæ­¥å™¨ä¸ºäº†ä¿è¯ PIO çš„ç¨³å®šæ€§ï¼Œæ¯ä¸ª GPIO è¾“å…¥éƒ½æœ‰ä¸¤ä¸ªæ ‡å‡† 2-fliplop åŒæ­¥å™¨ã€‚è¿™ä¼šå¯¼è‡´è¾“å…¥é‡‡æ ·å»¶è¿Ÿä¸¤ä¸ªå‘¨æœŸï¼Œä½†å¥½å¤„æ˜¯ï¼ŒçŠ¶æ€æœºå¯ä»¥åœ¨ä»»ä½•æ—¶åˆ»æ‰§è¡Œ IN PINSï¼Œè€Œä¸”åªä¼šçœ‹åˆ°å¹²å‡€çš„é«˜ä½ç”µå¹³ï¼Œè€Œä¸ä¼šçœ‹åˆ°å¯èƒ½ä¼šå½±å“çŠ¶æ€æœºç”µè·¯çš„ä¸­é—´å€¼ã€‚å¯¹äº UART RX ç­‰å¼‚æ­¥æ¥å£æ¥è¯´è¿™ä¸€ç‚¹éå¸¸é‡è¦ã€‚\næœ‰æ—¶æŸäº› GPIO å¯èƒ½éœ€è¦è·³è¿‡åŒæ­¥å™¨ã€‚è¿™æ ·å¯ä»¥å‡å°‘å»¶è¿Ÿï¼Œä½†ç”¨æˆ·å¿…é¡»è‡ªè¡Œä¿è¯çŠ¶æ€æœºä¸ä¼šåœ¨é”™è¯¯çš„æ—¶åˆ»è¿›è¡Œé‡‡æ ·ã€‚é€šå¸¸ï¼Œåªæœ‰ SPI ç­‰åŒæ­¥æ¥å£æ‰èƒ½åšåˆ°è¿™ä¸€ç‚¹ã€‚è®¾ç½® INPUT_SYNC_BYPASS ä¸­çš„ç›¸åº”æ¯”ç‰¹å³å¯è·³è¿‡åŒæ­¥å™¨ã€‚\nè­¦å‘Š å¯¹ä¸ç¨³å®šçš„è¾“å…¥è¿›è¡Œé‡‡æ ·ä¼šå¯¼è‡´ä¸å¯é¢„æµ‹çš„çŠ¶æ€æœºè¡Œä¸ºï¼Œåº”å½“é¿å…è¿™ç§æƒ…å†µã€‚\n3.5.7. å¼ºåˆ¶æŒ‡ä»¤å’Œè¢« EXEC çš„æŒ‡ä»¤é™¤äº†æŒ‡ä»¤å†…å­˜å¤–ï¼ŒçŠ¶æ€æœºè¿˜å¯ä»¥ä»å…¶ä»–ä¸‰ä¸ªæ¥æºæ‰§è¡ŒæŒ‡ä»¤ï¼š\n\nMOV EXEC å¯ä»¥ä» Source æŒ‡å®šçš„æŸä¸ªå¯„å­˜å™¨æ‰§è¡ŒæŒ‡ä»¤\nOUT EXEC å¯ä»¥æ‰§è¡Œ OSR ç§»å‡ºçš„æ•°æ®\nä» SMx_INSTR æ§åˆ¶å¯„å­˜å™¨æ‰§è¡ŒæŒ‡ä»¤ï¼Œç³»ç»Ÿå¯ä»¥å°†æŒ‡ä»¤ç›´æ¥å†™å…¥è¯¥å¯„å­˜å™¨ï¼Œä»¥ç«‹å³æ‰§è¡Œ\n\n 1 .program exec_example 2  3 hang: 4     jmp hang 5 execute: 6     out exec, 32 7     jmp execute 8  9 .program instructions_to_push10 11     out x, 3212     in x, 3213     push\n\n#include &quot;tb.h&quot; // TODO this is built against existing sw tree, so that we get printf etc#include &quot;platform.h&quot;#include &quot;pio_regs.h&quot;#include &quot;system.h&quot;#include &quot;hardware.h&quot;#include &quot;exec_example.pio.h&quot;int main()&#123;    tb_init();    for (int i = 0; i &lt; count_of(exec_example_program); ++i)        mm_pio-&gt;instr_mem[i] = exec_example_program[i];    // Enable autopull, threshold of 32    mm_pio-&gt;sm[0].shiftctrl = (1u &lt;&lt; PIO_SM0_SHIFTCTRL_AUTOPULL_LSB);    // Start state machine 0 -- will sit in &quot;hang&quot; loop    hw_set_bits(&amp;mm_pio-&gt;ctrl, 1u &lt;&lt; (PIO_CTRL_SM_ENABLE_LSB + 0));    // Force a jump to program location 1    mm_pio-&gt;sm[0].instr = 0x0000 | 0x1; // jmp execute    // Feed a mixture of instructions and data into FIFO    mm_pio-&gt;txf[0] = instructions_to_push_program[0]; // out x, 32    mm_pio-&gt;txf[0] = 12345678;                        // data to be OUTed    mm_pio-&gt;txf[0] = instructions_to_push_program[1]; // in x, 32    mm_pio-&gt;txf[0] = instructions_to_push_program[2]; // push    // The program pushed into TX FIFO will return some data in RX FIFO    while (mm_pio-&gt;fstat &amp; (1u &lt;&lt; PIO_FSTAT_RXEMPTY_LSB))        ;    printf(&quot;%d\\n&quot;, mm_pio-&gt;rxf[0]);    return 0;&#125;\n\nè¿™é‡Œæˆ‘ä»¬å‘çŠ¶æ€æœºä¸­åŠ è½½äº†ä¸€ä¸ªç¤ºä¾‹ç¨‹åºï¼Œå®ƒåšäº†ä¸¤ä»¶äº‹ï¼š\n\nè¿›å…¥æ— é™å¾ªç¯\nè¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼Œè¯¥å¾ªç¯åå¤åœ°ä» TX FIFO åŠ è½½ 32 æ¯”ç‰¹æ•°æ®ï¼Œç„¶åå°†ä½ 16 æ¯”ç‰¹ä½œä¸ºæŒ‡ä»¤æ‰§è¡Œ\n\nC ç¨‹åºå°†çŠ¶æ€æœºè®¾ç½®ä¸ºè¿è¡ŒçŠ¶æ€ï¼Œç„¶åè¿›å…¥ hang å¾ªç¯ã€‚åœ¨çŠ¶æ€æœºæ‰§è¡Œæ—¶ï¼ŒC ç¨‹åºå¼ºåˆ¶æ‰§è¡Œä¸€æ¡ jmp æŒ‡ä»¤ï¼Œä½¿çŠ¶æ€æœºè·³å‡ºå¾ªç¯ã€‚\nå½“ä¸€æ¡æŒ‡ä»¤å†™å…¥ INSTR å¯„å­˜å™¨åï¼ŒçŠ¶æ€æœºä¼šç«‹å³è§£ç å¹¶æ‰§è¡Œè¯¥æŒ‡ä»¤ï¼Œè€Œä¸ä¼šæ‰§è¡Œä» PIO æŒ‡ä»¤å†…å­˜è¯»å–åˆ°çš„æŒ‡ä»¤ã€‚ç¨‹åºè®¡æ•°å™¨ä¸ä¼šå¢åŠ ï¼Œå› æ­¤åœ¨ä¸‹ä¸€ä¸ªå‘¨æœŸï¼ˆå‡è®¾ INSTR å¯„å­˜å™¨å¼ºåˆ¶æ‰§è¡Œçš„æŒ‡ä»¤æ²¡æœ‰å¯¼è‡´ç­‰å¾…çŠ¶æ€ï¼‰çŠ¶æ€æœºä¼šä»åŸæ¥çš„ä½ç½®ç»§ç»­æ‰§è¡Œå½“å‰ç¨‹åºï¼Œé™¤éå†™å…¥çš„æŒ‡ä»¤ä¿®æ”¹äº† PCã€‚\nå†™å…¥ INSTR å¯„å­˜å™¨çš„æŒ‡ä»¤ä¸­çš„å»¶æ—¶å‘¨æœŸä¼šè¢«å¿½ç•¥ï¼Œå¹¶ç«‹å³æ‰§è¡Œï¼Œä¸ç®¡çŠ¶æ€æœºçš„æ—¶é’Ÿåˆ†é¢‘å™¨å¦‚ä½•è®¾ç½®ã€‚è¿™ä¸ªæ¥å£ç”¨äºæ‰§è¡Œåˆå§‹åŒ–æˆ–æ”¹å˜æµç¨‹æ§åˆ¶ï¼Œæ‰€ä»¥æŒ‡ä»¤ä¼šå°½å¿«æ‰§è¡Œï¼Œè€Œä¸ç®¡çŠ¶æ€æœºå¦‚ä½•é…ç½®ã€‚\nå†™å…¥ INSTR çš„æŒ‡ä»¤å¯ä»¥è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œæ­¤æ—¶çŠ¶æ€æœºä¼šé”ä½è¯¥æŒ‡ä»¤ï¼Œç›´åˆ°å…¶å®Œæˆã€‚å‡ºç°è¿™ç§æƒ…å†µæ—¶ï¼Œä¼šè®¾ç½® EXECCTRL_EXEC_STALLED æ ‡å¿—ã€‚é‡å¯çŠ¶æ€æœºæˆ–å‘ INSTR å†™å…¥ NOP å¯ä»¥æ¸…é™¤è¯¥æ ‡å¿—ã€‚\nä¸Šè¿°ç¤ºä¾‹çŠ¶æ€æœºç¨‹åºçš„ç¬¬äºŒé˜¶æ®µä½¿ç”¨äº† OUT EXEC æŒ‡ä»¤ã€‚OUT æœ¬èº«éœ€è¦ä¸€ä¸ªæ‰§è¡Œå‘¨æœŸï¼ŒOUT æ‰§è¡Œçš„æŒ‡ä»¤åœ¨ä¸‹ä¸€ä¸ªæ‰§è¡Œå‘¨æœŸè¿›è¡Œã€‚æ³¨æ„è¢«æ‰§è¡Œçš„æŒ‡ä»¤ä¹‹ä¸€ä¹Ÿæ˜¯ OUTâ€”â€”çŠ¶æ€æœºæ¯ä¸ªå‘¨æœŸåªèƒ½æ‰§è¡Œä¸€æ¡ OUT æŒ‡ä»¤ã€‚\nOUT EXEC ä¼šå°† OUT ç§»å‡ºçš„æ•°æ®å†™å…¥å†…éƒ¨çš„æŒ‡ä»¤é”å­˜å™¨ã€‚ä¸‹ä¸€ä¸ªå‘¨æœŸä¸­ï¼ŒçŠ¶æ€æœºçŸ¥é“å®ƒä¸åº”è¯¥æ‰§è¡ŒæŒ‡ä»¤å†…å­˜ï¼Œè€Œæ˜¯æ‰§è¡Œè¯¥é”å­˜å™¨çš„å†…å®¹ï¼Œè€Œä¸”çŸ¥é“æ­¤æ—¶ä¸åº”å½“å¢åŠ  PCã€‚\nè¯¥ç¨‹åºåœ¨è¿è¡Œæ—¶ä¼šè¾“å‡º â€œ12345678â€ã€‚\næ³¨æ„ å¦‚æœå†™å…¥ INSTR çš„æŒ‡ä»¤é€ æˆç­‰å¾…çŠ¶æ€ï¼Œè¯¥æŒ‡ä»¤ä¼šè¢«å†™å…¥åˆ°ä¸ OUT EXEC å’Œ MOV EXEC æ‰€ç”¨çš„åŒä¸€ä¸ªé”å­˜å™¨ï¼Œå¹¶è¦†ç›–å…¶ä¸­ä¿å­˜çš„æŒ‡ä»¤ã€‚å› æ­¤ï¼Œå¦‚æœä½¿ç”¨äº† EXEC æŒ‡ä»¤ï¼Œé‚£ä¹ˆå†™å…¥ INSTR çš„æŒ‡ä»¤ä¸èƒ½é€ æˆç­‰å¾…ã€‚\n"},{"title":"SWDé‡‡æ ·æ—¶åº","url":"/2025/03/08/SWD%E9%87%87%E6%A0%B7%E6%97%B6%E5%BA%8F/","content":"æœ€è¿‘åœ¨å·¥ä½œä¸­é‡åˆ°ä¸€ä¸ªæŠ€æœ¯é—®é¢˜ï¼Œåœ¨ç¿»çœ‹ARMçš„ä¸€ä»½æŠ€æœ¯æ‰‹å†Œã€ŠArm Debug Interface Architecture Specificationã€‹ï¼Œçœ‹åˆ°SWDç« èŠ‚æ—¶ï¼Œæˆ‘çªç„¶æœ‰ä¸ªç–‘æƒ‘ï¼ŒSWDçš„DIOä¿¡å·åˆ°è¾¾æ˜¯åœ¨CLKçš„ä¸Šå‡æ²¿é‡‡æ ·è¿˜æ˜¯ä¸‹é™æ²¿é‡‡æ ·ï¼Ÿ\næˆ‘åå¤é˜…è¯»äº†æ–‡æ¡£ï¼Œä¼¼ä¹å¹¶æ²¡æœ‰æ˜ç¡®çš„æè¿°ã€‚åªæœ‰ä¸€å¼ æè¿°æ—¶åºçš„å›¾ï¼š\nå¾ˆæœ‰æ„æ€ï¼Œæ ¹æ®è¿™ä¸ªå›¾æ¥çœ‹ï¼Œåº”è¯¥æ˜¯Hoståœ¨ä¸Šå‡æ²¿è¾“å‡ºä¿¡å·ï¼ŒHoståœ¨ä¸‹é™æ²¿è¯»å–ä¿¡å·ã€‚\nä¸ºäº†ç¡®ä¿ç†è§£æœ‰é—æ¼çš„åœ°æ–¹ï¼Œæˆ‘æŠŠæ–‡æ¡£æ”¾åˆ°äº†è±†åŒ…AIä¸­å»åˆ†æï¼Œè®©å®ƒçœ‹çœ‹è¿™ä¸ªæ—¶åºæ˜¯æ€ä¹ˆæ ·çš„ã€‚è±†åŒ…AIå¸®æˆ‘è§£è¯»äº†æ–‡æ¡£ä¸­SWDç›¸å…³çš„éƒ¨åˆ†ï¼š\nè¯¥æ–‡æ¡£å›´ç»•Arm Debug Interface v5å±•å¼€ï¼Œå…¶ä¸­SWDåè®®æ˜¯é‡è¦å†…å®¹ï¼Œæ¶µç›–åè®®æ¦‚è¿°ã€æ“ä½œã€æ¥å£ç­‰æ–¹é¢ã€‚å®ƒæ˜¯ä¸€ç§åŒæ­¥ä¸²è¡Œæ¥å£åè®®ï¼Œå…·æœ‰å¤šç‰ˆæœ¬ã€æ”¯æŒå¤šç§æ“ä½œç­‰ç‰¹ç‚¹ï¼Œåœ¨è°ƒè¯•ä¸­èµ·ç€å…³é”®ä½œç”¨ã€‚\n\nåè®®æ¦‚è¿°\nåŸºæœ¬æ“ä½œï¼šé‡‡ç”¨å•åŒå‘æ•°æ®è¿æ¥å’Œç‹¬ç«‹æ—¶é’ŸåŒæ­¥ä¼ è¾“æ•°æ® ï¼Œä¸€æ¬¡æ“ä½œåŒ…å«æ•°æ®åŒ…è¯·æ±‚ã€ç¡®è®¤å“åº”å’Œæ•°æ®ä¼ è¾“ï¼ˆæŒ‰éœ€ï¼‰ä¸‰ä¸ªé˜¶æ®µã€‚ä¼ è¾“å®Œæˆåï¼Œä¸»æœºéœ€è¿›è¡Œç‰¹å®šæ“ä½œä»¥ç¡®ä¿æ•°æ®èƒ½é¡ºåˆ©é€šè¿‡SW - DPã€‚\nåè®®ç‰ˆæœ¬ï¼šv1æ˜¯ç‚¹å¯¹ç‚¹æ¶æ„ï¼Œå­˜åœ¨ç‰©ç†è¿æ¥å¤æ‚ç­‰ç¼ºç‚¹ï¼›v2æ˜¯å¤š-dropæ¶æ„ï¼Œæ”¯æŒå¤šè®¾å¤‡è¿æ¥ï¼Œå‘åå…¼å®¹ï¼Œæ”¯æŒè®¾å¤‡æ–­ç”µï¼Œä½†ä¸v1åœ¨å¯åŠ¨çŠ¶æ€å’Œä¼‘çœ çŠ¶æ€ä¸Šå­˜åœ¨å…¼å®¹æ€§é—®é¢˜ã€‚\nå…¶ä»–ç‰¹æ€§ï¼šåŒ…æ‹¬çº¿è·¯åè½¬ï¼ˆé˜²æ­¢ä¿¡å·å†²çªï¼Œæ—¶é•¿ç”±DLCR.TURNROUNDæ§åˆ¶ ï¼‰ã€ç©ºé—²å‘¨æœŸï¼ˆä¸»æœºå®Œæˆäº‹åŠ¡åéœ€æ’å…¥ç©ºé—²å‘¨æœŸæˆ–å¼€å§‹æ–°äº‹åŠ¡ ï¼‰ã€ä½é¡ºåºï¼ˆæ•°æ®ä¼ è¾“LSBå…ˆï¼‰ã€å¥‡å¶æ ¡éªŒï¼ˆå¯¹æ•°æ®åŒ…è¯·æ±‚å’Œæ•°æ®ä¼ è¾“é˜¶æ®µè¿›è¡Œå¶æ ¡éªŒï¼‰ä»¥åŠå¤š-dropé™åˆ¶ï¼ˆè®¾å¤‡éœ€å”¯ä¸€IDï¼Œå­˜åœ¨é…ç½®å’Œè‡ªåŠ¨æ£€æµ‹é™åˆ¶ ï¼‰ã€‚\n\n\nåè®®æ“ä½œ\nå„ç§å“åº”æƒ…å†µï¼šæˆåŠŸå†™æ“ä½œï¼ˆOKå“åº”ï¼‰åŒ…æ‹¬8ä½å†™æ•°æ®åŒ…è¯·æ±‚ã€3ä½OKç¡®è®¤å“åº”å’Œ33ä½WDATAæ•°æ®ä¼ è¾“é˜¶æ®µï¼›æˆåŠŸè¯»æ“ä½œç±»ä¼¼ï¼Œåªæ˜¯æ•°æ®ä¼ è¾“æ–¹å‘ç›¸åã€‚WAITå“åº”è¡¨ç¤ºSW - DPæ— æ³•ç«‹å³å¤„ç†è¯·æ±‚ï¼ŒFAULTå“åº”è¡¨ç¤ºæœ‰é”™è¯¯å‘ç”Ÿï¼Œåè®®é”™è¯¯å“åº”é’ˆå¯¹å¤šç§é”™è¯¯æƒ…å†µã€‚\nç‰¹æ®Šæƒ…å†µå¤„ç†ï¼šSW - DPå¯å®ç°å†™ç¼“å†²ï¼Œèƒ½æ¥å—å†™æ“ä½œï¼Œä½†å­˜åœ¨ç›¸å…³é™åˆ¶ã€‚æ­¤å¤–ï¼Œè¿˜ä»‹ç»äº†ç›®æ ‡å’Œä¸»æœºçš„å“åº”æ€»ç»“ï¼Œä»¥åŠSWDåè®®æ“ä½œä¸­çš„å„ç§çŠ¶æ€å˜åŒ–å’Œæ•°æ®ä¼ è¾“è§„åˆ™ã€‚\n\n\næ¥å£ç›¸å…³\næ¥å£æ¦‚è¿°ï¼šä½¿ç”¨å•åŒå‘æ•°æ®å¼•è„šSWDIOå’Œæ—¶é’Ÿå¼•è„šSWCLKï¼Œæ”¯æŒä¸»æœºå’Œç›®æ ‡é©±åŠ¨ä¿¡å·ï¼Œæ—¶é’Ÿå¯å¼‚æ­¥ï¼Œç©ºé—²æ—¶å¯åœæ­¢ã€‚ç›®æ ‡éœ€100KÎ©ä¸Šæ‹‰ç”µé˜»ç¡®ä¿çº¿è·¯çŠ¶æ€å·²çŸ¥ã€‚\nè¿æ¥ä¸å¤ä½ï¼šè°ƒè¯•å™¨éœ€è¿›è¡Œçº¿è·¯å¤ä½åºåˆ—ä»¥ç¡®ä¿è¿æ¥æ­£å¸¸ï¼Œå¤ä½åç‰¹å®šæ“ä½œå¯ä½¿æ¥å£é€€å‡ºå¤ä½çŠ¶æ€ã€‚SWDåè®®ç‰ˆæœ¬2æœ‰ç‰¹å®šçš„ç›®æ ‡é€‰æ‹©åè®®ï¼Œæ¶‰åŠå†™TARGETSELå¯„å­˜å™¨å’Œè¯»DPIDRå¯„å­˜å™¨ç­‰æ“ä½œ ã€‚\n\n\n\nè±†åŒ…AIéƒ½å·²ç»çœ‹åˆ°äº†ä½é¡ºåºæ˜¯LSBè¿™äº›ç»†èŠ‚äº†ï¼Œä½†æ˜¯å®ƒä»»ç„¶æ²¡æœ‰æ‰¾åˆ°æ‰¾åˆ°SWDçš„DIOä¿¡å·åˆ°è¾¾æ˜¯åœ¨CLKçš„ä¸Šå‡æ²¿é‡‡æ ·è¿˜æ˜¯ä¸‹é™æ²¿é‡‡æ ·ã€‚\næ‰€ä»¥æˆ‘åˆè¿›ä¸€æ­¥æ˜ç¡®é—®é¢˜ï¼šSWDåè®®æ˜¯ä¸Šå‡æ²¿é‡‡æ ·è¿˜æ˜¯ä¸‹é™æ²¿é‡‡æ ·ï¼ŸAIè¿™æ¬¡è¿˜è”ç½‘æŸ¥è¯¢äº†ä¸€ä¸‹ï¼š\nSWDåè®®ä¸­ï¼Œæ•°æ®åœ¨SWDIOä¸Šä¼ è¾“æ—¶ï¼Œç›®æ ‡è®¾å¤‡åœ¨SWCLKçš„ä¸Šå‡æ²¿è¿›è¡Œé‡‡æ ·ã€‚è¿™ä¸€é‡‡æ ·æ–¹å¼åœ¨æ–‡æ¡£åŠç›¸å…³èµ„æ–™ä¸­å‡æœ‰æ˜ç¡®é˜è¿°ï¼Œæ˜¯SWDåè®®æ•°æ®ä¼ è¾“æœºåˆ¶çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚ \n\næ•°æ®é‡‡æ ·æ²¿çš„æ˜ç¡®è§„å®šï¼šåœ¨æ–‡æ¡£ä¸­è™½æœªç›´æ¥æåŠSWDåè®®æ˜¯ä¸Šå‡æ²¿é‡‡æ ·è¿˜æ˜¯ä¸‹é™æ²¿é‡‡æ ·ï¼Œä½†å‚è€ƒå…¶ä»–æƒå¨èµ„æ–™ï¼Œå¦‚CSDNåšå®¢æ–‡ç« ã€ŠSWD(ä¸€) æ‚è°ˆã€‹æ˜ç¡®æŒ‡å‡ºä»ç›¸å…³ç« èŠ‚å¯ä»¥çœ‹åˆ°æ˜¯ä¸Šå‡æ²¿é‡‡æ ·ã€‚å¹¶ä¸”åœ¨â€œSWDåè®®æ“ä½œâ€éƒ¨åˆ†æè¿°æ•°æ®ä¼ è¾“è¿‡ç¨‹æ—¶ï¼Œè™½æœªå¼ºè°ƒé‡‡æ ·æ²¿ï¼Œä½†ä»ä¿¡å·ä¼ è¾“çš„é€»è¾‘å’Œå¸¸è§çš„SWDåè®®å®ç°æ¥çœ‹ï¼Œä¸Šå‡æ²¿é‡‡æ ·ç¬¦åˆå…¶æ•°æ®ä¼ è¾“çš„æ—¶åºè¦æ±‚ã€‚\nä¸åè®®å…¶ä»–éƒ¨åˆ†çš„å…³è”æ€§ï¼šSWDåè®®çš„æ•°æ®åŒ…è¯·æ±‚ã€ç¡®è®¤å“åº”å’Œæ•°æ®ä¼ è¾“é˜¶æ®µçš„æ“ä½œï¼Œéƒ½ä¾èµ–äºå‡†ç¡®çš„é‡‡æ ·æ—¶åˆ»æ¥ä¿è¯æ•°æ®çš„æ­£ç¡®ä¼ è¾“ã€‚ä¸Šå‡æ²¿é‡‡æ ·ç¡®ä¿äº†åœ¨æ—¶é’Ÿä¿¡å·çš„ç‰¹å®šæ—¶åˆ»ï¼Œç›®æ ‡è®¾å¤‡èƒ½ç¨³å®šåœ°è·å–æ€»çº¿ä¸Šçš„æ•°æ®ï¼Œä¸åè®®ä¸­å¯¹æ•°æ®ä¼ è¾“çš„å¥‡å¶æ ¡éªŒã€æ•°æ®åŒ…æ ¼å¼ç­‰è§„å®šç›¸äº’é…åˆï¼Œå…±åŒä¿éšœæ•°æ®ä¼ è¾“çš„å‡†ç¡®æ€§å’Œç¨³å®šæ€§ã€‚\n\næ‰€ä»¥AIä¹Ÿè®¤ä¸ºæ–‡æ¡£ä¸­æ²¡æœ‰æ˜ç¡®è¯´æ˜ã€‚\nè·å–æˆ‘ä»¬éœ€è¦ç¬¬ä¸‰æ–¹çš„ä»£ç æ¥ä½è¯ä¸€ä¸‹ï¼šhttps://github.com/blackmagic-debug/blackmagic/blob/main/src/platforms/common/swdptap.cæ ¹æ®è¿™æ®µä»£ç ä¸­çš„æ³¨é‡Šä»¥åŠå‡½æ•°å®ç°æ¥çœ‹ï¼Œä¸»æœºç«¯åœ¨æ—¶é’Ÿä¸‹é™æ²¿è¾“å‡ºæ•°æ®ï¼Œåœ¨æ—¶é’Ÿä¸Šå‡æ²¿é‡‡é›†æ•°æ®ã€‚\nåœ¨çœ‹çœ‹Raspberry Piçš„ä»£ç ï¼šhttps://github.com/raspberrypi/debugprobe/blob/master/src/probe.pioè¿™æ®µä»£ç ä¸­çš„æ³¨é‡Šå’Œå®ç°åŒæ ·è¡¨æ˜äº†ä¸»æœºç«¯åœ¨æ—¶é’Ÿä¸‹é™æ²¿è¾“å‡ºæ•°æ®ï¼Œåœ¨æ—¶é’Ÿä¸Šå‡æ²¿é‡‡é›†æ•°æ®ã€‚\nè¿˜æœ‰CMSIS-DAPçš„æºç ä¸­SW_DP.cæ–‡ä»¶çš„å®ç°æ¥çœ‹ï¼Œä¸»æœºç«¯åœ¨æ—¶é’Ÿä¸‹é™æ²¿è¾“å‡ºæ•°æ®ï¼Œåœ¨æ—¶é’Ÿä¸Šå‡æ²¿é‡‡é›†æ•°æ®ã€‚\næ‰€ä»¥é—®é¢˜æ˜¯ARMçš„æ–‡æ¡£ä¸­é…å›¾æ˜¯ä¸æ˜¯å­˜åœ¨é”™è¯¯?è¿˜æ˜¯è¯´å®ƒå°±æ˜¯ä¸€ä¸ªç¤ºæ„å›¾ï¼Œæ²¡æœ‰æ˜ç¡®è¯´æ˜ã€‚\nå°†é—®é¢˜äº¤ç»™DeepSeekåˆ†æä¸€ä¸‹ï¼Œæˆ‘çš„é—®é¢˜æ˜¯ï¼šARMèŠ¯ç‰‡çš„SWDè°ƒè¯•åè®®ä¸­DIOåœ¨CLKä¸Šå‡æ²¿è¿˜æ˜¯ä¸‹é™æ²¿é‡‡æ ·ï¼Ÿå®ƒæ€è€ƒäº†43ç§’ï¼Œç»™å‡ºäº†æ ‡é¢˜ï¼šARM SWDè°ƒè¯•åè®®DIOé‡‡æ ·æ²¿åˆ†æ\nDeepSeekçš„å›ç­”ç®€ç›´æ— å¯æŒ‘å‰”ï¼\nç›®å‰çš„AIå·¥å…·éƒ½å¤ªå¼ºå¤§äº†ï¼Œå¯ä»¥å¸®åŠ©åˆ†æå¾ˆå¤šé—®é¢˜ã€‚ä½†æ˜¯ç›®å‰AIçš„ä»£ç èƒ½åŠ›ä»ç„¶æœ‰é™ï¼Œåªèƒ½ç”¨äºè¾“å‡ºå‡ ç™¾è¡Œè§„æ¨¡çš„ä»£ç ï¼Œä¸èƒ½ç”¨äºåˆ†æå¤æ‚çš„éœ€æ±‚ã€‚æˆ–è®¸ä¸ä¹…åå°±æœ‰èƒ½å¤Ÿç”Ÿæˆå‡ åƒè¡Œç”šè‡³ä¸Šä¸‡è¡Œä»£ç çš„èƒ½åŠ›ï¼Œé‚£æ—¶å€™æ‰æ˜¯è§£æ”¾ç”Ÿäº§åŠ›çš„æ—¶ä»£ã€‚\n"},{"title":"TLSFä¸FreeRTOS-heap4å¯¹æ¯”","url":"/2024/05/21/TLSF%E4%B8%8EFreeRTOS-heap4%E5%AF%B9%E6%AF%94/","content":"TLSFå†…å­˜åˆ†é…å™¨çš„ä¸€äº›æµ‹è¯•å’Œæ¯”è¾ƒFreeRTOSå¤ªå‡ºåäº†ï¼Œå°±ä¸ä»‹ç»äº†ã€‚TLSFæ˜¯ä¸€ä¸ªå®æ—¶åŠ¨æ€å†…å­˜åˆ†é…å™¨ï¼Œå¯ç”¨äºåµŒå…¥å¼ç³»ç»Ÿã€‚å…·æœ‰é«˜æ•ˆçš„å†…å­˜ä½¿ç”¨æ•ˆç‡å’Œå¯é¢„æµ‹çš„å“åº”æ—¶é—´ï¼Œå®ƒå…·ä½“çš„å·¥ä½œåŸç†å¯ä»¥å‚è€ƒä½œè€…ä¸»é¡µä¸Šçš„ä¸€äº›æ–‡æ¡£ã€‚\næˆ‘è¿è¡Œäº†ä¸€äº›ç®€å•çš„æµ‹è¯•æ¥æ¯”è¾ƒäºŒè€…çš„ä¸€äº›å·®å¼‚ï¼š\n\n\n\n\nTLSF\nheap4\n\n\n\n8000æ¬¡å†…å­˜åˆ†é…è€—æ—¶\n33ms\n13ms\n\n\n3000æ¬¡ç¢ç‰‡åŒ–åˆ†é…è€—æ—¶\n12ms\n106ms\n\n\nå•ä¸ªå†…å­˜é¢å¤–å¼€é”€\n8å­—èŠ‚\n8å­—èŠ‚\n\n\nå†…å­˜å›ºå®šå¼€é”€\n3224å­—èŠ‚\n16å­—èŠ‚\n\n\nå†…å­˜ç¢ç‰‡åˆå¹¶\næ”¯æŒ\næ”¯æŒ\n\n\nçº¿ç¨‹å®‰å…¨\næ”¯æŒ\næ”¯æŒ\n\n\nå¤šå—å†…å­˜ç®¡ç†\næ”¯æŒ\nä¸æ”¯æŒ\n\n\nreallocæ¥å£\næ”¯æŒ\nä¸æ”¯æŒ\n\n\nå¯¹é½åˆ†é…\nä¸æ”¯æŒ\nä¸æ”¯æŒ\n\n\nå †å†…å­˜æº¢å‡ºæ£€æµ‹\nä¸æ”¯æŒ\nä¸æ”¯æŒ\n\n\ndouble freeæ£€æµ‹\nä¸æ”¯æŒ\nä¸æ”¯æŒ\n\n\nå¼€æºåè®®\nLGPL\nMIT\n\n\næ³¨ï¼šæ€§èƒ½æ•°æ®ä»…ä»…åæ˜ åœ¨æˆ‘çš„æµ‹è¯•å¹³å°å’Œæµ‹è¯•ç”¨ä¾‹ä¸Šçš„ç»“æœ\nç®€å•æ€»ç»“ï¼š\n\nç›¸æ¯”äºheap4ï¼Œtlsfå¯ç®¡ç†å¤šå—å†…å­˜ï¼Œæ”¯æŒreallocæ¥å£ï¼ŒåŠŸèƒ½ä¸Šæ›´å®Œå–„ã€‚ä½†æ˜¯å…¶å†…å­˜å›ºå®šå¼€é”€è¾ƒå¤§ï¼Œå¯èƒ½ä¸é€‚åˆç®¡ç†è¾ƒå°çš„å†…å­˜ã€‚åœ¨åˆ†é…é€Ÿåº¦ä¸Šï¼Œåœ¨åˆ†é…è¿ç»­å†…å­˜æ—¶ï¼Œheap4çš„åˆ†é…é€Ÿåº¦ä¼˜äºTLSFã€‚ä½†æ˜¯åœ¨é‡åˆ°è¾ƒå¤šå†…å­˜ç¢ç‰‡åï¼Œtlsfçš„ä¼˜åŠ¿å°±æ¯”è¾ƒæ˜æ˜¾äº†ï¼Œå…¶å¯é¢„æµ‹çš„åˆ†é…æ—¶é—´æ›´é€‚åˆé«˜å®æ—¶æ€§çš„åœºæ™¯ã€‚\n\nheap4é‡‡ç”¨ç©ºé—²é“¾è¡¨ç®¡ç†ç©ºé—²å†…å­˜ï¼Œå½“å†…å­˜ç¢ç‰‡è¾ƒå¤šåï¼Œå†…å­˜åˆ†é…æ€§èƒ½å°†æ€¥å‰§ä¸‹é™ã€‚tlsfé‡‡ç”¨bitmapå’Œç©ºé—²é“¾è¡¨ä¸¤çº§ç®¡ç†çš„æ–¹å¼ï¼Œå¯å®ç°O(1)çš„åˆ†é…æ—¶é—´å¤æ‚åº¦ã€‚\n\nheap4é€šè¿‡portBYTE_ALIGNMENTè®¾ç½®å…¨å±€å­—èŠ‚å¯¹é½æ–¹å¼ã€‚tlsfé€šè¿‡BLOCK_ALIGNè®¾ç½®å…¨å±€å­—èŠ‚å¯¹é½æ–¹å¼ã€‚å‡ä¸æ”¯æŒåˆ†é…æ—¶æŒ‡å®šå¯¹é½æ–¹å¼ã€‚\n\nmalloc(0)çš„è¡Œä¸ºå·®å¼‚ã€‚tlfsä¼šæŒ‰ç…§ä¸€ä¸ªæœ€å°å¿«è¿›è¡Œåˆ†é…(8å­—èŠ‚)ã€‚heap4è¿”å›ç©ºæŒ‡é’ˆå¹¶åœ¨å†…éƒ¨è§¦å‘å†…å­˜ç”³è¯·å¤±è´¥çš„hookã€‚\n\näºŒè€…éƒ½å…·å¤‡ä¸€äº›è¾…åŠ©å†…å­˜è°ƒè¯•çš„æ¥å£ã€‚ä½œä¸ºç»è¿‡å¤šä¸ªç‰ˆæœ¬è¿­ä»£çš„å‘è¡Œç‰ˆè½¯ä»¶ï¼Œå®ƒä»¬éƒ½å…·æœ‰è¾ƒé«˜çš„å¯é æ€§ã€‚é€‰æ‹©TLSFè¿˜æ˜¯heap4ï¼Œä¸»è¦çœ‹ä½ çš„éœ€æ±‚ã€‚å®ƒä»¬éƒ½å…·å¤‡è‰¯å¥½çš„æ€§èƒ½ï¼Œå¹¶ä¸”éƒ½æ”¯æŒå¤šçº¿ç¨‹ã€‚\n\n\næˆ‘çœ‹åˆ°å¦å¤–ä¸€ä¸ªåˆ†æ”¯ç‰ˆæœ¬tlsfï¼Œå®ƒæ”¯æŒå¯¹é½åˆ†é…ã€æ›´ä½çš„å•å—å†…å­˜å¼€é”€(4å­—èŠ‚)ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰å®ç°çº¿ç¨‹å®‰å…¨çš„æœºåˆ¶ã€‚\nå†…å­˜åˆ†é…å™¨é€šå¸¸æœ€ä¸ºç³»ç»ŸåŸºç¡€ç»„ä»¶å­˜åœ¨ï¼Œå› æ­¤é€‰æ‹©ä¸€ä¸ªå¥½çš„å†…å­˜åˆ†é…å™¨ï¼Œå¯ä»¥å¸¦æ¥æ›´å¥½çš„ç³»ç»Ÿç¨³å®šæ€§ã€‚æˆ‘åœ¨ä¹‹å‰æ€»ç»“äº†å…³äºå†…å­˜åˆ†é…å™¨å¯¹å †å†…å­˜æ•…éšœçš„ä¸€äº›å†…å®¹ï¼Œæˆ‘å°±ä¸å•ç‹¬å‘è¡¨äº†ï¼Œä¸€å¹¶è´´åœ¨åé¢ã€‚\nå †å†…å­˜ä½¿ç”¨ä¸­å¸¸è§çš„4ç§é—®é¢˜\n1.å†…å­˜æ³„æ¼ (memory leak)å†…å­˜ä½¿ç”¨çš„åŸºæœ¬æµç¨‹æ˜¯ç”³è¯·-&gt;ä½¿ç”¨-&gt;é‡Šæ”¾ã€‚å¦‚æœå†…å­˜ä¸é‡Šæ”¾å°±ä¼šå¯¼è‡´å¯¹è¯¥æ®µå†…å­˜çš„ç®¡ç†å¤±å»äº†æ§åˆ¶ï¼Œå¦‚æœé¢‘ç¹å‘ç”Ÿè¿™ç§é—®é¢˜ï¼Œå°±ä¼šå¯¼è‡´å¯ç”¨å†…å­˜è¶Šæ¥è¶Šå°ã€‚é€šå¸¸æ¥è¯´åœ¨ç¨‹åºæ­£å¸¸è¿è¡Œè¿‡ç¨‹å‡ºç°ä¸¥é‡çš„å†…å­˜æ³„æ¼æ—¶ï¼Œé€šè¿‡è§‚å¯Ÿå¯ç”¨å†…å­˜çš„å˜åŒ–é‡å¯ä»¥åˆ¤å®šæ˜¯å¦å‡ºç°äº†å†…å­˜æ³„æ¼é—®é¢˜ã€‚å¦‚ä½•è¿›ä¸€æ­¥å®šä½è¿™ä¸ªå†…å­˜æ³„æ¼ç‚¹å‘¢ï¼Ÿè¿™ä¸ªå¯ä»¥é€šè¿‡å†…å­˜ç”³è¯·é‡Šæ”¾æ—¥å¿—åˆ†æï¼Œå¦‚æœå†…å­˜æ³„æ¼é¢‘ç‡è¾ƒé«˜èƒ½å¤Ÿéå¸¸å®¹æ˜“å°±å®šä½åˆ°é—®é¢˜æ‰€åœ¨ã€‚å¯¹äºå¤§å—å†…å­˜çš„æ³„æ¼ä¸€èˆ¬ä¹Ÿæ¯”è¾ƒå®¹æ˜“å‘ç°ã€‚å¦‚æœå‡ºç°è¾ƒå°å†…å­˜çš„æ³„æ¼ä¸”é¢‘ç‡ä¸é«˜çš„è¯éœ€è¦é•¿æ—¶é—´çš„æµ‹è¯•æ‰èƒ½å‘ç°é—®é¢˜ã€‚\n\n2.é‡å¤é‡Šæ”¾(double free)å†…å­˜é‡å¤é‡Šæ”¾æ¯”è¾ƒå¥½ç†è§£ï¼Œå°±æ˜¯å†…å­˜ç»å†äº†ç”³è¯·-&gt;é‡Šæ”¾-&gt;å†é‡Šæ”¾çš„è¿‡ç¨‹ã€‚æ˜¾ç„¶ç¬¬äºŒæ¬¡é‡Šæ”¾è¿™æ®µå†…å­˜ä¼šå‡ºç°æ— æ³•é¢„æ–™åˆ°çš„æƒ…å†µã€‚è¯¥é—®é¢˜å¯¼è‡´çš„å…·ä½“ç°è±¡ä¹Ÿä¸ç¡®å®šã€‚é€šå¸¸åªèƒ½é€šè¿‡ç»éªŒåˆ†ææ˜¯å¦å‘ç”Ÿäº†è¯¥é—®é¢˜ï¼Œå‡ºç°è¯¥é—®é¢˜å¯èƒ½å¯¼è‡´ä¸¤ä¸ªä»¥ä¸Šçš„çº¿ç¨‹å‡ºç°å¼‚å¸¸è¡Œä¸ºã€‚è™½ç„¶ä¸å®¹æ˜“ç¡®è®¤æ˜¯å¦å‘ç”Ÿäº†double freeï¼Œä½†æ˜¯å¦‚æœç¡®è®¤å‘ç”Ÿäº†double freeï¼Œé€šå¸¸èƒ½å¤Ÿé€šè¿‡å†…å­˜çš„ç”³è¯·é‡Šæ”¾æ—¥å¿—æ‰¾åˆ°é—®é¢˜ç‚¹ã€‚ä½†æ˜¯å¦‚æœæŸäº›æƒ…å†µå¯èƒ½ä¼šä½¿é—®é¢˜å˜å¾—æ¯”è¾ƒæ£˜æ‰‹ï¼Œå³çº¿ç¨‹Aç”³è¯·å†…å­˜æŒ‡é’ˆp1ï¼Œéšæœºé‡Šæ”¾p1æŒ‡é’ˆï¼Œçº¿ç¨‹Bç”³è¯·åˆ°åŒæ ·çš„å†…å­˜æŒ‡é’ˆp1ï¼Œçº¿ç¨‹Aå†æ¬¡é‡Šæ”¾æŒ‡é’ˆp1ï¼Œå³çº¿ç¨‹Aé‡Šæ”¾äº†ä¸¤æ¬¡å†…å­˜ã€‚å¦‚æœä½¿ç”¨logåˆ†æï¼Œèƒ½å¤Ÿçœ‹åˆ°è¿™ä¸ªåœ°å€çš„ç”³è¯·å’Œé‡Šæ”¾éƒ½æ˜¯æˆå¯¹çš„ï¼Œå¾ˆéš¾å®šä½é—®é¢˜ç‚¹ã€‚å¯¹äºå‰é¢è¿™ç§æƒ…å†µï¼Œæ˜¾ç„¶çº¿ç¨‹Bä¼šä½¿ç”¨åˆ°ä¸€å—ä¸å®‰å…¨çš„å†…å­˜ï¼Œè¿›ä¸€æ­¥å¯¼è‡´UAFç­‰é—®é¢˜ã€‚å½“å‡ºç°è¿™æ ·çš„é—®é¢˜ï¼Œè®¾è®¡ä¸€ç§malloc\\freeæˆå¯¹æœºåˆ¶å°±èƒ½è¾ƒå¿«çš„å®šä½é—®é¢˜ï¼Œå¸¸è§çš„ä½œæ³•æ˜¯æ·»åŠ åŠ¨æ€æ ‡è®°ï¼Œè¿™æ ·å…¶å®ƒçº¿ç¨‹å°±ä¸èƒ½é‡Šæ”¾ä¸€ä¸ªä¸å±äºå®ƒçš„æŒ‡é’ˆäº†ã€‚\nstatic inline uint32_t malloc_flag_generate(void)&#123;    static uint16_t id = 0;    return (id++ &lt;&lt; 16) | (rand() &amp; 0xffff);&#125;void *malloc_f(size_t size, uint32_t *flag)&#123;    if(!flag) return NULL;    uint32_t *ptr = malloc(size + sizeof(uint32_t));    *ptr = *flag = malloc_flag_generate();    return ptr++;&#125;void free_f(void *ptr, uint32_t *flag)&#123;    uint32_t *_ptr = ptr;    _ptr--;    assert(*flag == *_ptr);    free(_ptr);&#125;\n\n3.å†…å­˜è¶Šç•Œ(memory overflow)å†…å­˜è¶Šç•Œä¸åŒäºå‰é¢ä¸¤ç§å†…å­˜é‡Šæ”¾æ“ä½œä¸åˆç†å¯¼è‡´çš„é—®é¢˜ï¼Œå®ƒä¸»è¦æ˜¯ç”±äºå†…å­˜ç”³è¯·çš„é•¿åº¦å°äºå®é™…æƒ³è¦ä½¿ç”¨çš„é•¿åº¦ï¼Œæˆ–è€…æ˜¯å®é™…ä½¿ç”¨çš„å†…å­˜é•¿åº¦è¶…è¿‡äº†åˆ†é…çš„å†…å­˜é•¿åº¦ã€‚å†…å­˜è¶Šç•Œå¯èƒ½å¯¼è‡´ç¯¡æ”¹å…¶å®ƒåº”ç”¨æ•°æ®ã€‚ä½†åœ¨æŸäº›å†…å­˜ç®¡ç†å™¨ä¸‹å¯èƒ½å‡ºç°ç ´åå †å†…å­˜é“¾è¡¨çš„æƒ…å†µï¼Œè¿›ä¸€æ­¥å¯¼è‡´çš„é—®é¢˜å°±æ˜¯ä½¿å¾—åˆ†é…å™¨åˆ†é…å‡ºå¼‚å¸¸çš„å†…å­˜ç©ºé—´åœ°å€ã€‚å¯¹äºç¬¬äºŒç§é—®é¢˜æƒ…å†µï¼Œå…·ä½“å‡ºç°çš„é—®é¢˜ç°è±¡ä¹Ÿä¸ç¡®å®šï¼Œåªèƒ½é€šè¿‡ç»éªŒåˆ¤æ–­ã€‚æ£€æŸ¥å†…å­˜æº¢å‡ºæ˜¯å†…å­˜åˆ†é…å™¨çš„ä¸€ä¸ªåŸºç¡€å®‰å…¨èƒ½åŠ›ï¼Œä¸šå†…é€šç”¨çš„åšæ³•æ˜¯åœ¨å†…å­˜åŒºåŸŸçš„è¾¹ç•Œæ·»åŠ redzoneï¼Œåœ¨é‡Šæ”¾å†…å­˜æ—¶æ£€æŸ¥redzoneè¿›è¡Œåˆ†æï¼Œåˆ¤æ–­æ˜¯å¦å‘ç”Ÿæº¢å‡ºã€‚å¦‚ä½•æ„é€ redzoneä¹Ÿæ˜¯ä¸€ä¸ªå¤æ‚çš„é—®é¢˜ï¼ŒåŒ…æ‹¬redzoneå¡«å……çš„æ•°æ®ä»¥åŠæ•°æ®é•¿åº¦ï¼Œéšæœºçš„redzoneå†…å®¹å’Œé•¿åº¦æ˜¯ä¸€ç§å®‰å…¨çš„ç®—æ³•ï¼Œä½†åœ¨å…·ä½“çš„å®æ–½ä¸Šé€šå¸¸æ¯”è¾ƒéº»çƒ¦ï¼Œä¸”åœ¨é¢å¯¹ç²¾å¿ƒæ„é€ çš„shellcodeæ—¶ä¹Ÿä¼šå‡ºç°ç»•è¿‡çš„æƒ…å†µï¼Œåº”å¯¹è¯¥é—®é¢˜æ—¶ä¸€äº›å†…å­˜è°ƒè¯•æ‰‹æ®µæœ‰åŠ©äºåˆ†æè¯¥é—®é¢˜ï¼Œä¾‹å¦‚å†…å­˜æ–­ç‚¹ã€é™·é˜±ç­‰ã€‚\n\n4.å†…å­˜éæ³•è®¿é—®(UAF)æŒ‡é’ˆpæŒ‡å‘ä¸€æ®µåˆæ³•ç”³è¯·çš„å†…å­˜ç©ºé—´ï¼Œå½“é‡Šæ”¾pæŒ‡å‘çš„å†…å­˜ç©ºé—´åï¼ŒpæŒ‡é’ˆæœªç½®NULLï¼Œæ‰€ä»¥ç†è®ºä¸Šæ¥è¯´é€šè¿‡pæŒ‡é’ˆä»»ç„¶èƒ½å¤Ÿè®¿é—®è¯¥æ®µå†…å­˜ä¸‹çš„æ•°æ®ã€‚æ˜¾ç„¶åç»­é€šè¿‡pæŒ‡é’ˆè®¿é—®æ•°æ®éƒ½å±äºéæ³•çš„è®¿é—®ã€‚è¯¥é—®é¢˜é…åˆå †å†…å­˜ç®¡ç†å™¨çš„ä¸€äº›ç‰¹æ€§èƒ½å¤Ÿå¯¼è‡´ç³»ç»Ÿå‡ºç°ä¸¥é‡çš„å®‰å…¨æ€§é—®é¢˜ã€‚è¯¥é—®é¢˜é€šå¸¸ä¸æ˜“å‘ç°ï¼Œå®ƒå¦‚æœæ²¡æœ‰é€ æˆæ˜æ˜¾çš„é—®é¢˜ï¼Œå¾ˆéš¾å®šä½é—®é¢˜ç‚¹ã€‚å†…å­˜åˆ†é…å™¨åŠ å…¥ä¸€äº›æ£€æµ‹æœºåˆ¶èƒ½å¤Ÿè§„é¿æŸäº›åœºæ™¯ä¸‹çš„use after freeé—®é¢˜ï¼Œé‡Šæ”¾å†…å­˜æ—¶ï¼Œå¯¹å†…å­˜ä¸­å¡«å……å…³é”®å­—ã€‚åœ¨åˆ†é…å†…å­˜æ—¶å†æ£€æµ‹å…³é”®å­—æœ‰æ²¡æœ‰è¢«æ±¡æŸ“ï¼Œä»¥æ­¤æ¥åˆ¤æ–­UAFé—®é¢˜ã€‚ä½†æ˜¯è¿™ç§æ£€æµ‹æœºåˆ¶ä½œç”¨æœ‰é™ï¼Œå®ƒä¸èƒ½æ£€æµ‹åˆ°ä¸Šé¢åœºæ™¯ä¸‹å‘ç”Ÿçš„é—®é¢˜ã€‚\n\n\n"},{"title":"nRF52xè¿è¡Œè“ç‰™åè®®æ ˆ+FreeRTOSçš„åŸç†","url":"/2022/05/30/nRF52x%E8%BF%90%E8%A1%8C%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E6%A0%88+FreeRTOS%E7%9A%84%E5%8E%9F%E7%90%86/","content":"\nä¹‹å‰æœ‰ä¸ªç ”å‘çš„äº§å“ä¸ºäº†æ»¡è¶³è“ç‰™è¿æ¥çš„éœ€æ±‚ï¼Œé€‰æ‹©äº†nRF52840è¿™ä¸ªèŠ¯ç‰‡ï¼Œå®ƒçš„è“ç‰™åè®®æ ˆæ˜¯ä¸€ç§ç±»ä¼¼ä½¿ç”¨åŠ¨æ€åº“çš„æ–¹å¼è¿›è¡Œè°ƒç”¨ï¼Œå®˜æ–¹ä»…ä»…ç»™å‡ºäº†åè®®æ ˆçš„äºŒè¿›åˆ¶åŒ…(SoftDevice)ï¼Œå¹¶ç»™å‡ºäº†åŠ¨æ€è°ƒç”¨çš„æ–¹æ³•ï¼Œå…¶è°ƒç”¨çš„å…³é”®å°±æ˜¯ä½¿ç”¨ARMå•ç‰‡æœºçš„SVCè°ƒç”¨ï¼Œè¿™æ˜¯ä¸€ç§æ¯”è¾ƒå¥½çš„è®¾è®¡ï¼Œæˆ‘ä»¬å¼€å‘è½¯ä»¶èƒ½å¤Ÿéå¸¸ç®€å•çš„è°ƒç”¨åè®®æ ˆçš„ç¨‹åºæ¥å®ç°è“ç‰™é€šä¿¡ç›¸å…³çš„åŠŸèƒ½ã€‚åæ¥äº§å“çš„ä½¿ç”¨éœ€æ±‚å‘ç”Ÿçš„å˜åŒ–ï¼Œè“ç‰™åŠŸèƒ½å·²ç»ä¸éœ€è¦çš„ï¼Œè€Œæ˜¯éœ€è¦æ›´åŠ å¤æ‚çš„é€šä¿¡åŠŸèƒ½ã€‚ä¸ºäº†ä¿æŒä¸šåŠ¡åŠŸèƒ½ä»£ç çš„ä¸€è‡´æ€§ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰æ›¿æ¢èŠ¯ç‰‡ï¼Œä½†æ˜¯ç”±äºé€šä¿¡åŠŸèƒ½æ›´åŠ å¤æ‚åï¼Œè¿«ä¸å¾—å·²éœ€è¦RTOSçš„æ”¯æ´ã€‚åç»­å°±æ˜¯ç§»æ¤FreeRTOSç­‰ä¸€ç³»åˆ—æ“ä½œã€‚å› ä¸ºè¯¥å•ç‰‡æœºæ˜¯CM4å†…æ ¸ï¼Œæ‰€ä»¥è¿™äº›æ“ä½œéƒ½å¾ˆç®€å•ã€‚\n\nSVCè°ƒç”¨å†²çªçš„ç–‘æƒ‘ä»Šå¤©åœ¨çœ‹è¿™ä¸¤å¥—åŸºäºnRFå•ç‰‡æœºçš„è®¾è®¡æ–¹æ¡ˆæ—¶ï¼Œæˆ‘å¯¹å…¶ä¸­çš„æœ‰ä¸ªç»†èŠ‚äº§ç”Ÿäº†ç–‘æƒ‘ã€‚äº†è§£FreeRTOSçš„å¼€å‘è€…åº”è¯¥æ¯”è¾ƒæ¸…æ¥šï¼ŒåƒCM4å†…æ ¸çš„å•ç‰‡æœºå¯åŠ¨FreeRTOSçš„ç¬¬ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œä¾èµ–SVCè°ƒç”¨ä»è£¸æœºè¿è¡Œåˆ‡æ¢ä¸ºRTOSçº¿ç¨‹è¿è¡Œã€‚è€Œè“ç‰™åè®®æ ˆä¹Ÿä½¿ç”¨äº†SVCè°ƒç”¨ï¼Œé‚£æ˜¯ä¸æ˜¯æ„å‘³ç€è¯¥å•ç‰‡æœºçš„è“ç‰™åŠŸèƒ½ä¸èƒ½å’ŒFreeRTOSå…¼å®¹ï¼Œç»“æœæ˜¯å¦å®šçš„ã€‚å› ä¸ºä»å®˜æ–¹çš„ä¾‹ç¨‹ä¸­å¯ä»¥çœ‹åˆ°è“ç‰™+FreeRTOSçš„ä¾‹ç¨‹(examples\\ble_peripheral\\ble_app_hrs_freertos)ã€‚æˆ‘å†³å®šå¼„æ¸…æ¥šNordicçš„è“ç‰™åè®®æ ˆ+FreeRTOSæ˜¯å¦‚ä½•å…¼å®¹çš„ã€‚\næˆ‘èµ·åˆè®¤ä¸ºFreeRTOSçš„portå®ç°ä¸­å¯¹åˆå§‹ä»»åŠ¡è°ƒç”¨æœ‰åŒºåˆ«ä¸€èˆ¬å•ç‰‡æœºçš„ç‰¹æ®Šå¤„ç†ï¼Œä½†æ˜¯ä»”ç»†çœ‹å®ƒçš„portæ–‡ä»¶ååˆå‘ç°å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ã€‚\n// external\\freertos\\portable\\ARM\\nrf52\\port.c__asm void vPortSVCHandler( void )&#123;    PRESERVE8    /* Get the location of the current TCB. */    ldr r3, =pxCurrentTCB    ldr r1, [r3]    ldr r0, [r1]    /* Pop the core registers. */    ldmia r0!, &#123;r4-r11, r14&#125;    msr psp, r0    isb    mov r0, #0    msr basepri, r0    bx r14&#125;__asm void vPortStartFirstTask( void )&#123;    PRESERVE8    EXTERN __Vectors    /* Use the NVIC offset register to locate the stack. */    ldr r0, =__Vectors    ldr r0, [r0]    /* Set the msp back to the start of the stack. */    msr msp, r0    /* Globally enable interrupts. */    cpsie i    cpsie f    dsb    isb#ifdef SOFTDEVICE_PRESENT    /* Block kernel interrupts only (PendSV) before calling SVC */    mov r0, #(configKERNEL_INTERRUPT_PRIORITY &lt;&lt; (8 - configPRIO_BITS))    msr basepri, r0#endif    /* Call SVC to start the first task. */    svc 0    ALIGN&#125;\n\nè€Œåœ¨FreeRTOSConfig.hæ–‡ä»¶ä¸­ä¹Ÿå°†è¯¥å‡½æ•°æ˜ å°„åˆ°äº†ä¸­æ–­å‘é‡è¡¨ä¸­\n// examples\\ble_peripheral\\ble_app_hrs_freertos\\config\\FreeRTOSConfig.h/* Definitions that map the FreeRTOS port interrupt handlers to their CMSISstandard names - or at least those used in the unmodified vector table. */#define vPortSVCHandler                                       SVC_Handler#define xPortPendSVHandler                                    PendSV_Handler\n\nåˆ°è¿™é‡Œæˆ‘è½¬å¤´åˆ†ænRFçš„SDKä»£ç ï¼Œä¾‹å¦‚sd_ble_enable()å‡½æ•°å°±æ˜¯ä¸€ä¸ªSVCè°ƒç”¨åœ¨ble.hæ–‡ä»¶ä¸­ä½¿ç”¨ä¸€ä¸ªSVCALLå®å®šä¹‰æ‰©å±•ä¸ºSVCè°ƒç”¨ä»£ç ï¼Œåˆ°è¿™é‡Œæˆ‘æ€€ç–‘SVCALLé’ˆå¯¹æœ‰æ— RTOSæœ‰ä¸¤ç§ä¸åŒçš„è®¾è®¡ï¼Œåæ¥å‘ç°æ˜¯å¤šè™‘äº†ã€‚\næ£€æŸ¥ä¸­æ–­å‘é‡è¡¨å®åœ¨ä¸è¡Œä¸Šä»£ç å§ï¼Œåœ¨è°ƒè¯•ç¯å¢ƒä¸­çœ‹çœ‹ï¼Œæˆ‘è¿è¡Œäº†ä¸€ä¸ªä»…ä»…åŒ…å«è“ç‰™åè®®æ ˆçš„ç¨‹åºï¼Œè¿è¡Œèµ·æ¥åå‘ç°SCB-&gt;VTOR&#x3D;0\nå¾ˆå¥‡æ€ª~\nè“ç‰™åè®®æ ˆåœ¨ROMä¸­çš„åœ°å€èŒƒå›´ä¸º0-0x27000ï¼Œæˆ‘ä»¬ç¼–å†™çš„APPåœ°å€èŒƒå›´ä¸º0x27000-ENDã€‚å› ä¸ºå•ç‰‡æœºä»åœ°å€0å¤„å¼€å§‹è¿è¡Œï¼Œè‚¯å®šæ˜¯è¿è¡Œè“ç‰™åè®®æ ˆï¼Œåœ¨åè®®æ ˆå†…è·³è½¬åˆ°APPä¸­ï¼ŒæŒ‰ç…§ä¸€èˆ¬BOOT+APPçš„è®¾è®¡æ€æƒ³ï¼ŒBOOTè·³è½¬æ˜¯åº”æŠŠä¸­æ–­å‘é‡è¡¨å¯„å­˜å™¨æ”¹ä¸ºAPPçš„ä¸­æ–­å‘é‡è¡¨ã€‚è¿™é‡Œä¸ºä»€ä¹ˆè¿˜æ˜¯BOOTçš„ä¸­æ–­å‘é‡è¡¨å‘¢ï¼Ÿéš¾é“æ˜¯Bugã€‚çœ‹æ¥éœ€è¦çœ‹çœ‹åè®®æ ˆå›ºä»¶ä¸­å‘ç”Ÿäº†ä»€ä¹ˆã€‚\nå…¶å®åˆ°è¿™é‡Œæˆ‘å°±å¤§æ¦‚çŒœåˆ°è¿™é‡Œé¢çš„é—¨é“äº†ï¼Œæˆ‘å‡†å¤‡é€†å‘åˆ†æè“ç‰™åè®®æ ˆçš„äºŒè¿›åˆ¶åŒ…ï¼Œçœ‹çœ‹æ˜¯å¦ç¬¦åˆæˆ‘çš„é¢„æœŸã€‚æˆ‘è®¤ä¸ºæ•´ä¸ªç³»ç»Ÿä»»ç„¶ä¾èµ–Boot(è“ç‰™åè®®æ ˆç¨‹åºï¼Œæˆ‘æŠŠå®ƒå½“ä½œbootçš„è§’è‰²)çš„å‘é‡è¡¨ï¼Œè€Œåœ¨Bootçš„ä¸­æ–­å¤„ç†å‡½æ•°ä¸­é€šè¿‡é€‚å½“çš„åˆ¤æ–­å†³å®šæ‰§è¡ŒBootä¸­æ–­å¤„ç†é€»è¾‘è¿˜æ˜¯è·³è½¬å¼•å¯¼åˆ°APPä¸­çš„ä¸­æ–­å¤„ç†å‡½æ•°ä¸­æ¥ã€‚\nåˆ†æSoftDeviceå›ºä»¶å®˜æ–¹æä¾›çš„bootä¸ºä¸€ä¸ªHEXæ–‡ä»¶ï¼Œæˆ‘å…ˆè½¬ä¸ºbinæ–‡ä»¶ï¼Œæ–¹ä¾¿æŸ¥çœ‹äºŒè¿›åˆ¶æ•°æ®ï¼Œä»å‰é¢çš„è°ƒè¯•ç»“æœèƒ½å¤Ÿçœ‹åˆ°ä¸­æ–­å‘é‡è¡¨åœ¨èµ·å§‹ä½ç½®ï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“å°±æ‰¾åˆ°SVCçš„å…¥å£åœ°å€äº†ï¼Œåœ¨0x2cåç§»å¤„å¾—åˆ°0x00000AA5ï¼Œå¿½ç•¥æœ€ä½bit1ï¼Œè½¬åˆ°0x00000AA4ï¼Œå¼€å§‹åˆ†æSVCçš„å‡½æ•°å¤„ç†æµç¨‹ï¼Œè¿™é‡Œä¸è®¨è®ºå¦‚ä½•é€†å‘å›ºä»¶ï¼Œç›´æ¥çœ‹ç»“æœï¼Œæˆ‘æŠŠå…¶ä¸­æœ€å…³é”®çš„éƒ¨åˆ†æˆªå–äº†å‡ºæ¥ã€‚\nè¿™é‡Œåˆ†æçš„å›ºä»¶ä»nRF5_SDK_17.0.2_d674ddeä¸­è·å¾—ã€‚ä¸åŒç‰ˆæœ¬çš„SoftDeviceå¯ä»¥åœ¨æ±‡ç¼–æ•°æ®ä¸Šæœ‰å·®åˆ«ï¼Œå¤§ä½“æµç¨‹åº”è¯¥æ˜¯ä¸€è‡´çš„ã€‚\n0x00000AA4 F01E0F04  TST           lr,#0x04       ;; è§£æSVCidçš„ç»å…¸ä»£ç ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½çœ‹è¿‡0x00000AA8 BF0C      ITE           EQ0x00000AAA F3EF8108  MRS           r1,MSP0x00000AAE F3EF8109  MRS           r1,PSP0x00000AB2 6988      LDR           r0,[r1,#0x18]  ;; å¾—åˆ°æ‰§è¡ŒSVCæŒ‡ä»¤åçš„PCæŒ‡é’ˆå€¼. why offset = 0x18, see ARM manual0x00000AB4 3802      SUBS          r0,r0,#0x02    ;; å‘åå›é€€ä¸€ä¸ªæŒ‡ä»¤çš„é•¿åº¦ï¼Œå³2å­—èŠ‚ï¼Œå°±æ˜¯SVCæŒ‡ä»¤çš„ä½ç½®0x00000AB6 7800      LDRB          r0,[r0,#0x00]  ;; æŒ‰å­—èŠ‚å–å€¼ï¼Œä»ä½ä½å¾—åˆ°SVCçš„idï¼Œidæ˜¯ä½œä¸ºä½ä½åŒ…å«åœ¨äºŒè¿›åˆ¶ç¼–ç ä¸­çš„0x00000AB8 2818      CMP           r0,#0x180x00000ABA D103      BNE           0x00000AC4   ;; SVCçš„IDä¸ç­‰äº0x18è·³è½¬åˆ°0x00000AC4ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦æµç¨‹ï¼ŒFreeRTOSçš„SVCidä¸º00x00000ABC E000      B             0x00000AC0   ;; SVCçš„IDç­‰äº0x18è·³è½¬åˆ°0x00000AC40x00000ABE 0000      MOVS          r0,r00x00000AC0 4A07      LDR           r2,[pc,#28]  ; @0x00000AE00x00000AC2 4710      BX            r20x00000AC4 4A07      LDR           r2,[pc,#28]  ; @0x00000AE40x00000AC6 6812      LDR           r2,[r2,#0x00] ;; æ£€æµ‹å†…å­˜å‘ç°@0x20000000çš„å€¼ä¸º0x10000x00000AC8 322C      ADDS          r2,r2,#0x2C   ;; 0x2C? åƒæ˜¯SVCçš„åç§»ï¼Œæ¨æµ‹åœ¨RAMçš„0x1000å¤„æœ‰ä¸€ä¸ªæ–°çš„ä¸­æ–­å‘é‡è¡¨0x00000ACA 6812      LDR           r2,[r2,#0x00] ;; r2=0x0002606D0x00000ACC 4710      BX            r20x00000ACE 0000      MOVS          r0,r00x00000AE0: 00000377 .word 0x000003770x00000AE4: 20000000 .word 0x200000000x0002606C 2004      MOVS          r0,#0x04     ;; è¿™æ˜¯å¦ä¸€ä¸ªSVCå¤„ç†å‡½æ•°0x0002606E 4671      MOV           r1,lr0x00026070 4208      TST           r0,r1        ;; è¿™æ˜¯ç¼–è¯‘å™¨ç”Ÿæˆçš„è¿˜æ˜¯æ‰‹å·¥ç¼–å†™çš„æ±‡ç¼–ï¼Œå¤ªå†—ä½™äº†...0x00026072 D002      BEQ           0x0002607A0x00026074 F3EF8109  MRS           r1,PSP0x00026078 E001      B             0x0002607E0x0002607A F3EF8108  MRS           r1,MSP0x0002607E 6988      LDR           r0,[r1,#0x18]0x00026080 3802      SUBS          r0,r0,#0x020x00026082 7800      LDRB          r0,[r0,#0x00] ;; åˆ°è¿™é‡Œï¼Œå‡½æ•°é‡æ–°è§£æäº†ä¸€éSVCçš„ID0x00026084 2810      CMP           r0,#0x100x00026086 DB13      BLT           0x000260B0    ;; å¦‚æœIDå°äº0x10åˆ™è·³è½¬åˆ° 0x000260B00x00026088 2820      CMP           r0,#0x200x0002608A DB0F      BLT           0x000260AC    ;; å¦‚æœIDå°äº0x20åˆ™è·³è½¬åˆ° 0x000260AC0x0002608C 282C      CMP           r0,#0x2C0x0002608E DB0B      BLT           0x000260A8    ;; å¦‚æœIDå°äº0x2cåˆ™è·³è½¬åˆ° 0x000260A80x00026090 4A0A      LDR           r2,[pc,#40]  ; @0x000260BC0x00026092 6812      LDR           r2,[r2,#0x00]0x00026094 4B0A      LDR           r3,[pc,#40]  ; @0x000260C00x00026096 429A      CMP           r2,r30x00026098 D103      BNE           0x000260A20x0002609A 2860      CMP           r0,#0x600x0002609C DB04      BLT           0x000260A80x0002609E 4A09      LDR           r2,[pc,#36]  ; @0x000260C40x000260A0 4710      BX            r20x000260A2 2002      MOVS          r0,#0x020x000260A4 6008      STR           r0,[r1,#0x00]0x000260A6 4770      BX            lr0x000260A8 4A07      LDR           r2,[pc,#28]  ; @0x000260C80x000260AA 4710      BX            r20x000260AC 4A07      LDR           r2,[pc,#28]  ; @0x000260CC0x000260AE 4710      BX            r20x000260B0 4A07      LDR           r2,[pc,#28]  ; @0x000260D00x000260B2 6812      LDR           r2,[r2,#0x00]  ;; åœ¨0x20000004å¤„çš„å€¼ä¸º0x27000,å®ƒæ˜¯appçš„èµ·å§‹ä½ç½®0x000260B4 322C      ADDS          r2,r2,#0x2C    ;; è®¡ç®—å‡ºappä¸­SVCçš„åœ°å€0x000260B6 6812      LDR           r2,[r2,#0x00]0x000260B8 4710      BX            r2             ;; è·³è½¬åˆ°appä¸­çš„SVCæ‰§è¡Œ0x000260BC: 2000005C .word 0x2000005C0x000260C0: CAFEBABE .word 0xCAFEBABE0x000260C4: 0000139B .word 0x0000139B0x000260C8: 00024485 .word 0x000244850x000260CC: 00024E9F .word 0x00024E9F0x000260D0: 20000004 .word 0x20000004\n\nåˆ†ææ‰§è¡Œè¿‡ç¨‹çŒœæµ‹åœ¨0x20000000å’Œ0x20000004å¤„å­˜æ”¾äº†ä¸¤ä¸ªä¸­æ–­å‘é‡è¡¨çš„èµ·å§‹åœ°å€ï¼Œä¸€ä¸ªæ˜¯å†…å­˜ä¸­çš„å‘é‡è¡¨ï¼Œä½äº0x1000ï¼›å¦ä¸€ä¸ªå°±æ˜¯APPçš„ä¸­æ–­å‘é‡è¡¨ï¼Œä½äº0x27000ã€‚\nç»“è®ºéå¸¸æ˜æ˜¾äº†ï¼Œå½“SVCçš„idå°äº0x10æ—¶å°±ä¼šè·³è½¬åˆ°æˆ‘ä»¬ç¼–å†™çš„APPå›ºä»¶ä¸­çš„SVCå¤„ç†å‡½æ•°ä¸­ï¼Œè¿™æ ·å°±å®ç°äº†FreeRTOSçš„portæ‰€ä¾èµ–çš„åŠŸèƒ½ã€‚è€Œidå¤§äºç­‰äº0x10æ—¶å°±æ‰§è¡Œåè®®æ ˆå†…éƒ¨çš„å·¥ä½œæµç¨‹ï¼Œå®ç°äº†è“ç‰™åè®®æ ˆ+FreeRTOSåŠŸèƒ½çš„å…¼å®¹ã€‚\nä»è¿™ä¸ªæ±‡ç¼–ä»£ç çš„æ‰§è¡Œè·¯å¾„æ¥çœ‹ï¼Œä»è§¦å‘BOOTä¸­çš„SVCåˆ°è·³è½¬åˆ°APPä¸­çš„SVCå¤„ç†å‡½æ•°ï¼Œå…¨ç¨‹éƒ½æ²¡æœ‰ä½¿ç”¨æ ˆæ“ä½œçš„æŒ‡ä»¤ï¼Œæ²¡æœ‰æ¶‰åŠpopã€pushã€blã€bxlç­‰ã€‚è¿™æ ·åœ¨APPçš„ä¸­æ–­å‡½æ•°ä¸­å°±èƒ½ç›´æ¥è¿”å›åˆ°çº¿ç¨‹ç¯å¢ƒä»£ç ï¼Œè¿™æ ·çš„è®¾è®¡å¯¹APPçš„ä¸­æ–­å¤„ç†å‡½æ•°æ¥è¯´ä¹Ÿæ›´åŠ å°é—­ã€‚\nå®˜æ–¹çš„æ–‡æ¡£ä¸­ä¹Ÿè¯´æ˜äº†0-0xfçš„idè°ƒç”¨åˆ†é…åˆ°äº†Applicationï¼Œå…¶å®ƒçš„idåˆ†é…ä¸ºåè®®æ ˆã€‚\nç±»ä¼¼çš„åƒPendSV_Handlerä¸­æ–­å¤„ç†å‡½æ•°ï¼Œåœ¨åè®®æ ˆå†…éƒ¨è§¦å‘åï¼Œç»è¿‡5æ¡æŒ‡ä»¤å°±èƒ½å¤Ÿè·³è½¬åˆ°APPå†…éƒ¨ï¼Œè¿˜ç®—æ˜¯æ¯”è¾ƒç®€æ´çš„ï¼Œåº”è¯¥ä¸ä¼šå¯¹FreeRTOSçš„è°ƒåº¦æ€§èƒ½äº§ç”Ÿå¾ˆå¤§çš„å½±å“ã€‚\nå®˜æ–¹çš„SDKä¸­idæ˜¯ä»0x60å¼€å§‹ä½¿ç”¨çš„ï¼Œè€Œåè®®æ ˆä¸­å¯¹å°äº0x20ã€0x2cç­‰åŒºé—´çš„idæœ‰ç‰¹æ®Šå¤„ç†ï¼Œä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·å¤„ç†å‘¢ï¼Ÿä»¥åå†çœ‹å§ã€‚\nä¸æ‡‚å›ºä»¶ä¸­ä¸ºä»€ä¹ˆéœ€è¦ä¸¤æ¬¡è§£æSVCçš„idï¼Œå…³é”®æ˜¯æ˜¯ç¬¬äºŒæ¬¡è§£ææ—¶å¾ˆä¸ç®€æ´ï¼Œè¿˜å¤šäº†3æ¡æŒ‡ä»¤ï¼Œçœ‹èµ·æ¥å¥½åˆ«æ‰­-_-!\n"},{"title":"ä¸€ä¸ªå›°æ‰°æˆ‘å¾ˆä¹…çš„é—®é¢˜","url":"/2023/08/30/%E4%B8%80%E4%B8%AA%E5%9B%B0%E6%89%B0%E6%88%91%E5%BE%88%E4%B9%85%E7%9A%84%E9%97%AE%E9%A2%98/","content":"å¤§çº¦åœ¨ä¸€å¹´åŠå‰ï¼Œæˆ‘å†™äº†ä¸€ç¯‡æ–‡ç« ä»‹ç»å¦‚ä½•ç»Ÿè®¡FreeRTOSç³»ç»Ÿä¸­ä»»åŠ¡çš„å®æ—¶CPUå ç”¨ç‡çš„æ–¹æ³•ï¼Œå…¶ä¸­æœ€å…³é”®çš„æ˜¯ä½¿ç”¨DWTè®¡æ•°å™¨ã€‚æˆ‘ä¸€ç›´è®¤ä¸ºè¿™ä¸ªè®¡æ•°å™¨åœ¨ä»»æ„æ¡ä»¶ä¸‹éƒ½æ˜¯èƒ½å¤Ÿæ­£ç¡®è¿è¡Œçš„ï¼Œç›´åˆ°æˆ‘æŠŠå®ƒè¿ç”¨åˆ°Cortex-M7å†…æ ¸ä¸­ã€‚\næ­£å¸¸æƒ…å†µä¸‹Cortex-M7å†…æ ¸çš„DWTè®¡æ•°å™¨èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œåªæ˜¯éœ€è¦æ“ä½œä¸€ä¸ªè®¿é—®é”å¯„å­˜å™¨LARï¼Œä½†æ˜¯æˆ‘å‘ç°å„ä¸ªå•ç‰‡æœºå¯¹è¿™ä¸ªé”çš„å®ç°å¹¶ä¸æ˜¯ä¸€è‡´çš„ï¼ŒæŸäº›å•ç‰‡æœºä¸è§£é”ä»ç„¶èƒ½å¤Ÿä½¿ç”¨DWTåŠŸèƒ½ï¼ŒARMçš„æŠ€æœ¯æ‰‹å†Œä¸­ä¹Ÿæ²¡æœ‰è¯¦ç»†æè¿°è¿™å¯„å­˜å™¨ã€‚LARé”ä¸æ˜¯ä»Šå¤©è®¨è®ºçš„ä¸»è¦å†…å®¹ï¼Œç•¥è¿‡ã€‚æˆ‘è¿™é‡Œä¸»è¦æƒ³è¯´è¯´å•ç‰‡æœºç¡çœ æ¨¡å¼ä¸‹é‡åˆ°çš„DWTè®¡æ•°å¼‚å¸¸çš„é—®é¢˜ã€‚\nå½“æˆ‘ä½¿ç”¨FreeRTOSçš„ä½åŠŸè€—æ¨¡å¼æ—¶å°±å‘ç°äº†DWTå¼‚å¸¸çš„ç°è±¡ï¼Œå½“å•ç‰‡æœºè¿›å…¥ä¼‘çœ çŠ¶æ€åï¼ŒDWTçš„è®¡æ•°å™¨å¹¶æ²¡æœ‰ç»§ç»­è¿è¡Œï¼Œè¿™ä¸ªç°è±¡æˆ‘åªåœ¨STM32H750è¿™ä¸ªå•ç‰‡æœºä¸Šç¢°åˆ°ï¼Œç”±äºæˆ‘æ‰‹ä¸Šæ²¡æœ‰å…¶å®ƒçš„CM7çš„å•ç‰‡æœºï¼Œæ‰€ä»¥æˆ‘æ— æ³•ç¡®è®¤è¿™ä¸ªé—®é¢˜æ˜¯ä¸æ˜¯è¿™ä¸ªå•ç‰‡æœºç‰¹æœ‰çš„ã€‚å½“å‡ºç°è¿™ä¸ªé—®é¢˜åæˆ‘å°±åœ¨CM4çš„å•ç‰‡æœºä¸Šå°è¯•å¤ç°ï¼Œä½†æ˜¯åœ¨CM4çš„å•ç‰‡æœºä¸­ä»»åŠ¡ç»Ÿè®¡åŠŸèƒ½å’Œä½åŠŸè€—éƒ½èƒ½å¾ˆå¥½çš„è¿è¡Œã€‚\næˆ‘åœ¨ç½‘ä¸Šæ£€ç´¢äº†å¾ˆå¤šçš„èµ„æ–™ï¼Œéƒ½æ²¡æœ‰ç›¸å…³çš„æè¿°ï¼Œè¿™è®©æˆ‘éå¸¸æ€€ç–‘æ˜¯è½¯ä»¶æŸä¸ªåœ°æ–¹é…ç½®ä¸å½“å¯¼è‡´çš„ï¼Œä½†æ˜¯æˆ‘å´å¹¶æ²¡æœ‰å‘ç°å¯ç–‘çš„åœ°æ–¹ã€‚\nå½“å¯ç”¨FreeRTOSçš„ä½åŠŸè€—æ¨¡å¼åï¼Œåœ¨ticklesså¤„ç†æµç¨‹ä¸­ï¼Œæˆ‘ç¡®è®¤DWTçš„CYCCNTå¯„å­˜å™¨æ²¡æœ‰ç»§ç»­è®¡æ•°ï¼Œæ‰€ä»¥å¯ç”¨ä½åŠŸè€—æ¨¡å¼åï¼Œç»Ÿè®¡ä»»åŠ¡çš„CPUå ç”¨æ—¶é—´å°±ä¸å¯é äº†ã€‚\nç”±äºèƒ½å¤Ÿç¡®è®¤åœ¨ticklessä¸­CYCCNTçš„è®¡æ•°å­˜åœ¨ç¼ºå¤±ï¼Œæ‰€ä»¥é€šè¿‡FreeRTOSçš„HOOKèƒ½å¤Ÿè¿›è¡Œä¸€å®šç¨‹åº¦çš„è¡¥å¿æ¥ç¡®ä¿ä»»åŠ¡CPUç»Ÿè®¡åŠŸèƒ½å¤§è‡´æ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯è¿™æ€»æ˜¯å­˜åœ¨è¯¯å·®çš„ï¼Œå› ä¸ºä¾é traceINCREASE_TICK_COUNT()çº æ­£çš„æ—¶é—´ç²¾åº¦ä¸å¤Ÿå‡†ç¡®ã€‚\nå¦‚æœèƒ½ç¡®è®¤è¿™ä¸ªé—®é¢˜æ˜¯ç¡¬ä»¶å¯¼è‡´çš„ï¼Œæˆ‘å°±æ”¾å¿ƒäº†ï¼Œå› ä¸ºæˆ‘å¸¸å¸¸æ—¶ä¸æ—¶çš„å°±åœ¨å°è¯•å®Œç¾è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜å›°æ‰°æˆ‘å¾ˆä¹…äº†ã€‚\n"},{"title":"ä¸€ä¸ªæ•´æ•°æ— æ³•æ­£å¸¸æº¢å‡ºå¯¼è‡´çš„bug","url":"/2025/01/15/%E4%B8%80%E4%B8%AA%E6%95%B4%E6%95%B0%E6%97%A0%E6%B3%95%E6%AD%A3%E5%B8%B8%E6%BA%A2%E5%87%BA%E5%AF%BC%E8%87%B4%E7%9A%84bug/","content":"lvgæ˜¯ä¸€æ¬¾éå¸¸æµè¡Œçš„å›¾å½¢åº“ï¼Œæœ€è¿‘åœ¨ä½¿ç”¨å®ƒçš„è¿‡ç¨‹ä¸­å‘ç°ä¸€ä¸ªæœ‰æ„æ€çš„é—®é¢˜ï¼Œè¿™é‡Œåšç®€å•è®°å½•ã€‚è¯è¯´äº‹æƒ…æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä¸ºæŒ‰é’®è®¾è®¡äº†ä¸€ä¸ªåŠ¨ç”»ï¼Œå¤§æ¦‚æ˜¯æŒ‰é’®ä¸€ç›´æ²¿yè½´å‘¨æœŸæ€§çš„å¾€å¤ç§»åŠ¨ã€‚\nlv_anim_t by;lv_anim_init(&amp;by);lv_anim_set_exec_cb(&amp;by, (lv_anim_exec_xcb_t) lv_obj_set_y);lv_anim_set_var(&amp;by, btn);lv_anim_set_time(&amp;by, 1797);lv_anim_set_values(&amp;by, 2, 106);lv_anim_set_playback_time(&amp;by, 1797);lv_anim_set_repeat_count(&amp;by, LV_ANIM_REPEAT_INFINITE);lv_anim_start(&amp;by);\n\nä»£ç éå¸¸ç®€å•ï¼Œå°±æ˜¯ä¸ºbtnç»‘å®šä¸€ä¸ªæ— é™é‡å¤æ¬¡æ•°çš„åŠ¨ç”»ã€‚ä»£ç åˆšå¼€å§‹å¯ä»¥å¥½å¥½è¿è¡Œï¼Œä½†æ˜¯åŠ¨ç”»æ‰§è¡Œäº†å‡ åˆ†é’Ÿåè¿™ä¸ªæŒ‰é’®çš„åŠ¨ç”»çªç„¶æš‚åœäº†ã€‚æŒ‰é’®ä¿æŒåœ¨äº†ä¸€ä¸ªå›ºå®šçš„ä½ç½®ï¼Œæˆ‘ä¸æ˜ç™½å‘ç”Ÿäº†ä»€ä¹ˆã€‚æˆ‘å¯ä»¥ç¡®è®¤ç³»ç»Ÿå†…å„ä¸ªä»»åŠ¡éƒ½åœ¨æ­£å¸¸çš„æ‰§è¡Œï¼Œå›¾å½¢é¡µé¢ä¸Šçš„ä¸€äº›æ•ˆæœéƒ½åœ¨æ­£å¸¸æ˜¾ç¤ºï¼Œå°±åªæœ‰è¿™ä¸ªæŒ‰é’®çš„åŠ¨ç”»ä»¿ä½›è¢«åˆ é™¤äº†ä¸€æ ·ã€‚\nç³»ç»Ÿé‡å¯äº†å‡ æ¬¡ï¼Œè¿™ä¸ªbugè§†ä¹å¯ä»¥ä¸€ç›´å¤ç°ï¼Œæˆ‘å†³å®šè¿ç€è°ƒè¯•å™¨çœ‹çœ‹ï¼Œåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Œæˆ‘åœ¨å…³é”®çš„ä¸€äº›çš„åœ°æ–¹è®¾ç½®äº†æ–­ç‚¹ï¼Œç­‰å¾…æ•…éšœå‘ç”Ÿã€‚å¥‡æ€ªçš„æ˜¯æ•…éšœå‘ç”Ÿåæ²¡æœ‰å‘½ä¸­ä»»ä½•æ–­ç‚¹ï¼Œæˆ‘ç«‹å³æš‚åœäº†ç¨‹åºè¿è¡Œï¼Œæˆ‘å†³å®šè¿›å…¥åˆ°åŠ¨ç”»å¤„ç†çš„å®šæ—¶å™¨å›è°ƒå‡½æ•°ä¸­çœ‹çœ‹ï¼Œç›¸å…³çš„åŠ¨ç”»å¥æŸ„æ•°æ®åˆ°è¾¾æ˜¯ä»€ä¹ˆæ ·çš„ã€‚\nåœ¨anim_timer()å‡½æ•°å†…è®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼ŒæˆåŠŸå‘½ä¸­ï¼Œè¯´æ˜åŠ¨ç”»å¤„ç†ç›¸å…³çš„å®šæ—¶å™¨æ²¡æœ‰è¢«åˆ é™¤ï¼Œä½†æ˜¯åŠ¨ç”»æ‰§è¡Œçš„å›è°ƒå´ä¸æ‰§è¡Œã€‚æ£€æŸ¥lv_anim_tç»“æ„ä½“å†…çš„æ•°æ®ï¼Œå‘ç°a-&gt;act_timeä¸ºä¸€ä¸ªå¾ˆå¤§çš„è´Ÿæ•°å€¼ï¼Œè¿™å°±çœ‹èµ·æ¥å¾ˆç¦»è°±ï¼Œè¿™æ„å‘³ç€è·ç¦»ä¸‹ä¸€æ¬¡åŠ¨ç”»è¢«æ¿€æ´»è¿˜æœ‰å¾ˆé•¿çš„æ—¶é—´è¦ç­‰å¾…ï¼ŒåŠ¨ç”»æ•ˆæœå› æ­¤è¢«æš‚åœã€‚ä¸ºä»€ä¹ˆact_timeæ˜¯è´Ÿæ•°äº†ã€‚\nuint32_t elaps = lv_tick_elaps(a-&gt;last_timer_run);a-&gt;act_time += elaps;\n\nåœ¨æˆ‘å°†èƒ½å¤Ÿæ’é™¤çš„åœ°æ–¹éƒ½æ’é™¤åï¼Œæˆ‘å°†é—®é¢˜ç‚¹å®šä½åˆ°äº†ä¸Šé¢è¿™é‡Œã€‚elapsçš„è®¡æ•°å€¼è‚¯å®šæ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œä½†å¦‚æœelapséå¸¸å¤§çš„è¯å¯èƒ½å¯¼è‡´åé¢çš„ç´¯åŠ è®¡ç®—æº¢å‡ºå¯¼è‡´è®¡ç®—å‡ºçš„å€¼ä¸ºè´Ÿæ•°ã€‚\nlv_tick_elaps()çš„ä½œç”¨æ˜¯è®¡ç®—å½“å‰æ—¶åˆ»è·ç¦»last_timer_runæ—¶åˆ»çš„æ—¶é—´å·®ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š\nuint32_t lv_tick_elaps(uint32_t prev_tick)&#123;    uint32_t act_time = lv_tick_get();    /*If there is no overflow in sys_time simple subtract*/    if(act_time &gt;= prev_tick) &#123;        prev_tick = act_time - prev_tick;    &#125;    else &#123;        prev_tick = UINT32_MAX - prev_tick + 1;        prev_tick += act_time;    &#125;    return prev_tick;&#125;\n\nçœ‹åˆ°è¿™é‡Œï¼Œæˆ‘çªç„¶æ˜ç™½äº†é—®é¢˜ç‚¹ï¼Œlv_tick_elapså‡½æ•°å†…åšäº†æ•´æ•°æº¢å‡ºå¤„ç†ï¼Œä½†æ˜¯å®ƒé»˜è®¤ä»lv_tick_get()è¿”å›çš„æ—¶é—´è®¡æ•°å‘¨æœŸä¸ºUINT32_MAXã€‚å¦‚æœæ—¶é—´å‘¨æœŸä¸æ˜¯UINT32_MAXï¼Œè¿™å°±å¯¼è‡´æº¢å‡ºè®¡ç®—é”™è¯¯ã€‚\nå†çœ‹çœ‹lv_tick_get()å‡½æ•°çš„å®ç°ï¼Œå®ƒæœ€ç»ˆä¼šè°ƒç”¨ç”±void lv_tick_set_cb(lv_tick_get_cb_t cb)è®¾ç½®çš„å›è°ƒå‡½æ•°ï¼Œæˆ‘è¿™é‡Œæ˜¯ï¼š\nstatic uint32_t get_gui_tick(void)&#123;    return xTaskGetTickCount() * 1000u / configTICK_RATE_HZ;&#125;// lv_tick_set_cb(get_gui_tick);\n\næˆ‘è¿™é‡Œçš„configTICK_RATE_HZ&#x3D;20000ï¼Œè¿™å°±å¯¼è‡´get_gui_tickå‡½æ•°è¿”å›çš„å‘¨æœŸæ¯”UINT32_MAXå°äº†20å€ã€‚æ‰€ä»¥å¯¼è‡´ç¨‹åºè¿è¡Œæ—¶act_timeè®¡ç®—é”™è¯¯ã€‚\nlvglä¼¼ä¹æ²¡æœ‰å¯¹ç”¨æˆ·å¯¼å…¥çš„æ—¶é—´æŸ¥è¯¢å›è°ƒå‡½æ•°åšä¸€å®šçš„è§„èŒƒï¼Œå¯¼è‡´äº†è¯¥é—®é¢˜çš„å‘ç”Ÿã€‚\nä¿®æ”¹FreeRTOSå†…æ ¸é…ç½®ï¼Œå°†configTICK_RATE_HZè®¾ç½®ä¸º1000ï¼Œè¿™æ ·å¯ä»¥è§£å†³é—®é¢˜å—ï¼Ÿå“ˆå“ˆï¼Œå¦‚æœè¿™æ ·æƒ³ä½ å¾ˆå¿«å°±ä¼šè°ƒå…¥å¦å¤–ä¸€ä¸ªé™·é˜±ã€‚\nxTaskGetTickCount() * 1000u / configTICK_RATE_HZ\n\nå…ˆä¹˜æ³•å†é™¤æ³•ä¼šå¯¼è‡´xTaskGetTickCount()æ—¶é—´çš„å‘¨æœŸç¼©å°1000å€ï¼Œæ‰€ä»¥ä¸è¦å¿½è§†è¿™äº›ç»†èŠ‚ã€‚\næˆ‘è¿™é‡Œä¸ºäº†ä¸ä¿®æ”¹FreeRTOSå†…æ ¸é…ç½®ï¼Œæ‰€ä»¥æˆ‘å†³å®šä½¿ç”¨ä¸€ä¸ªç¡¬ä»¶å®šæ—¶å™¨æ¥å½»åº•è§£å†³è¯¥é—®é¢˜ï¼Œç¡®ä¿å¯¼å…¥åˆ°å›¾å½¢åº“å†…çš„æ—¶é—´æŸ¥è¯¢å‡½æ•°è¿”å›å€¼çš„å‘¨æœŸä¸ºUINT32_MAXã€‚\nè¿™æ˜¯ç¬¬ä¸€æ¬¡é‡åˆ°ç”±äºæ•´æ•°æº¢å‡ºè¾¹ç•Œä¸ä¸¥è°¨å¯¼è‡´çš„æ•…éšœã€‚å¦‚æœä½ æœ‰ç±»ä¼¼çš„å›°æ‰°å¯ä»¥å°†configTICK_RATE_HZè®¾ç½®ä¸º1000å¹¶è°ƒç”¨lv_tick_set_cb(xTaskGetTickCount)æ¥è§£å†³è¯¥é—®é¢˜ã€‚\n"},{"title":"ä¸€ä¸ªç®€å•ä½†å¼ºå¤§çš„åç¨‹åº“-PtPlus","url":"/2024/08/20/%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E4%BD%86%E5%BC%BA%E5%A4%A7%E7%9A%84%E5%8D%8F%E7%A8%8B%E5%BA%93-PtPlus/","content":"å»å¹´æˆ‘åŸºäºProtothreadsåç¨‹åº“å®ç°äº†ä¸€äº›æœ‰æ„æ€çš„æ‰©å±•åŠŸèƒ½ä»¥æ–¹ä¾¿ä½¿ç”¨è¯¥åç¨‹åº“ã€‚ç›¸å…³çš„ä¸¤ç¯‡æ–‡ç« å¯ä»¥ç¿»çœ‹å»å¹´çš„åšå®¢ã€‚\n\næ›´ä¼˜é›…çš„ä½¿ç”¨Protothreadsåç¨‹æ¡†æ¶\nPTåç¨‹çš„ä¸€ä¸ªå°æ‰©å±•\n\næœ€è¿‘æˆ‘ç»§ç»­å®Œå–„äº†ç›¸å…³çš„åŠŸèƒ½ï¼Œå¹¶å¢åŠ äº†ä¸€äº›æ–°çš„åŠŸèƒ½ã€‚å®ç°äº†ä½åŠŸè€—æ”¯æŒã€å¯è¶…æ—¶çš„ä¿¡å·é‡ç­‰ã€‚\nå°†æ‰€æœ‰ç›¸å…³ä»£ç è¿›è¡Œæ•´ç†åæˆ‘ä¸ºå…¶å‘½åä¸ºPtPlusã€‚ç°å·²ç»å‘å¸ƒåœ¨GitHubä¸Šï¼Œæ¬¢è¿å¤§å®¶ä½¿ç”¨ã€‚\nå®ƒä½¿ç”¨æ ‡å‡†Cè¯­è¨€ç¼–å†™ï¼Œå‡ ä¹å¯ä»¥è¿è¡Œåœ¨æ‰€æœ‰çš„åµŒå…¥å¼å¹³å°ä¸Šã€‚\nç›¸å…³çš„ç”¨æ³•ä»¥åŠç¤ºä¾‹å¯ä»¥å‚è€ƒPtPlusã€‚\nè¿™é‡Œä»…å±•ç¤ºä¸€æ®µä»£ç æ¥å±•ç¤ºè¯¥åç¨‹åº“çš„ä½¿ç”¨ã€‚\n#include &lt;stdio.h&gt;#include &quot;pt_plus.h&quot;#ifdef _WIN32#include &lt;windows.h&gt;#define sleep(ms) Sleep(ms)#endifstruct pt_sem sem;PT_THREAD(test_task_A(struct pt *pt))&#123;    PT_BEGIN(pt);    static int i;    for(i = 0; i &lt; 10; i++)&#123;        PT_TASK_DELAY(pt, 1000);        printf(&quot;send semaphore - %d\\r\\n&quot;, clock_time());        PT_SEM_SIGNAL(pt, &amp;sem);    &#125;    PT_END(pt);&#125;PT_THREAD(test_task_B(struct pt *pt))&#123;    PT_BEGIN(pt);    static int err_cnt = 0;    while(1)&#123;        int ret;        PT_SEM_WAIT_TIMEOUT(pt, &amp;sem, 2000, &amp;ret);        if(ret == 0)&#123;            printf(&quot;Obtained semaphore! - %d\\r\\n&quot;, clock_time());        &#125;else&#123;            printf(&quot;Obtain semaphore timeout - %d\\r\\n&quot;, clock_time());            err_cnt++;            if(err_cnt &gt;= 3)&#123;                PT_EXIT(pt);            &#125;        &#125;    &#125;    PT_END(pt);&#125;int main(void)&#123;    PT_SEM_INIT(&amp;sem, 0);    PT_TASK_RUN(test_task_A);    PT_TASK_RUN(test_task_B);    while(PT_TASK_NUMS() &gt; 0)&#123;        PT_TASK_SCHEDULE();        clock_time_t idle_time = PT_TASK_IDLE_TIME();        if(idle_time &gt; 0)&#123;            // Calling system delay functions            sleep(idle_time);        &#125;    &#125;    return 0;&#125;\n\nåœ¨mainå‡½æ•°ä¸­åˆ›å»ºäº†ä¸¤ä¸ªä»»åŠ¡åå¼€å§‹è¿›è¡Œè°ƒåº¦ã€‚ä»»åŠ¡Aæ¯é—´éš”1ç§’å‘å‡ºä¸€ä¸ªä¿¡å·é‡ï¼Œä»»åŠ¡Bæ¯éš”2ç§’ç­‰å¾…ä¿¡å·é‡ï¼Œå¦‚æœç­‰å¾…è¶…æ—¶åˆ™æ‰“å°é”™è¯¯ä¿¡æ¯ã€‚ä»»åŠ¡Bè¿ç»­3æ¬¡è¶…æ—¶åï¼Œä»»åŠ¡Bå°†é€€å‡ºã€‚å½“æ‰€æœ‰çš„åç¨‹ä»»åŠ¡éƒ½ç»“æŸåï¼Œç¨‹åºç»“æŸã€‚\n"},{"title":"ä½“éªŒå›½äº§RISC-Vå•ç‰‡æœº","url":"/2024/05/18/%E4%BD%93%E9%AA%8C%E5%9B%BD%E4%BA%A7RISC-V%E5%8D%95%E7%89%87%E6%9C%BA/","content":"\nRISC-Vå•ç‰‡æœºå¹¶ä¸æ˜¯å¾ˆæ–°é²œçš„ä¸œè¥¿ï¼Œä½†å› ä¸ºå…¶å¸‚åœºå æœ‰ç‡ç›¸æ¯”äºARMå†…æ ¸çš„èŠ¯ç‰‡è¾ƒå°ï¼Œæ‰€ä»¥æ­¤ç±»èŠ¯ç‰‡å¹¶ä¸æµè¡Œã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘å¹¶æ²¡æœ‰æ¥è§¦è¿‡RISC-Vçš„èŠ¯ç‰‡ï¼Œè¶ç€æ˜¥èŠ‚å‡æœŸï¼Œè´­å¾—ä¸€å—å›½äº§å•ç‰‡æœºCH32V307ï¼Œæœ¬ç€å­¦ä¹ çš„æ€åº¦ï¼Œçœ‹çœ‹è¯¥èŠ¯ç‰‡ç›¸æ¯”äºARMå†…æ ¸æœ‰ä½•ä¼˜ç¼ºç‚¹ã€‚\n\nèŠ¯ç‰‡ä¸Šæ‰‹RISC-VèŠ¯ç‰‡çš„æŒ‡ä»¤é›†ã€æŒ‡ä»¤æ¶æ„åŒARMèŠ¯ç‰‡æœ‰ç€éå¸¸å¤§çš„å·®å¼‚ï¼Œä¸è¿‡å‰æœŸè¿˜ä¸éœ€è¦æ¥è§¦åˆ°è¿™ä¸ªå±‚é¢ï¼Œä»æœ€åŸºæœ¬çš„helloworldç¨‹åºå¼€å§‹å¯ä»¥æœ€å¿«ä¸Šæ‰‹è¿™ä¸ªèŠ¯ç‰‡ï¼ŒèŠ¯ç‰‡å‚å®¶æä¾›äº†HALå±‚çš„ä»£ç å’Œé›†æˆå¼€å‘ç¯å¢ƒï¼Œè¿˜æä¾›äº†å¤§é‡çš„exampleå¯ä¾›å‚è€ƒï¼Œæ‰€æœ‰è®©è¿™ä¸ªèŠ¯ç‰‡è¿è¡Œèµ·æ¥æ˜¯å¾ˆå®¹æ˜“çš„ã€‚\nè¿™ä¸ªèŠ¯ç‰‡è®©äººæœ€æ„Ÿå…´è¶£çš„æœ‰ä¸‰ä¸ªæ–¹é¢ï¼ŒRISC-Vå†…æ ¸ã€å†…å»º10MPHYçš„ä»¥å¤ªç½‘æ§åˆ¶å™¨ã€å†…å»º480MPHYçš„é«˜é€ŸUSBæ§åˆ¶å™¨ã€‚å°¤å…¶æ˜¯åä¸¤ç‚¹ï¼Œå‡ ä¹æ‰€æœ‰çš„STM32çš„èŠ¯ç‰‡éƒ½ä¸æ”¯æŒï¼Œè¿™å¯¹æ„å»ºç½‘ç»œç›¸å…³ã€USBç›¸å…³çš„åº”ç”¨éå¸¸æœ‰åˆ©ã€‚\nRISC-Vå†…æ ¸é’ˆå¯¹RISC-Vå†…æ ¸çš„æ¢ç´¢ï¼Œä¸»è¦æ˜¯ç§»æ¤FreeRTOSæ“ä½œç³»ç»Ÿä¸ºä¸»ã€‚FreeRTOSå®˜æ–¹æä¾›äº†RISC-Vçš„portå±‚é€‚é…ï¼Œå…¶åŸºäºmtimerå®ç°ï¼Œä½†æ˜¯è¯¥èŠ¯ç‰‡çš„å†…éƒ¨å®ç°ä¸Šæœ‰äº›å·®å¼‚(RISC-Vç”Ÿæ€ä¸ç»Ÿä¸€)ï¼Œå…¶ç æ‰äº†mtimerï¼Œå¢åŠ äº†ä¸€ä¸ªç±»ä¼¼ARMå•ç‰‡æœºçš„systickï¼Œæ‰€ä»¥èŠ¯ç‰‡å‚å®¶è‡ªå·±å®ç°äº†ä¸€ä¸ªporté€‚é…å±‚ã€‚\nå‚è€ƒè¯¥é€‚é…å±‚ä»£ç å®Œæˆäº†æ“ä½œç³»ç»Ÿçš„ç§»æ¤ã€‚åœ¨ç§»æ¤è¿‡ç¨‹ä¸­ä¸»è¦é‡åˆ°äº†ä»¥ä¸‹é—®é¢˜ï¼š\n\néœ€è¦åœ¨é“¾æ¥è„šæœ¬ä¸­åˆ†é…ç‹¬ç«‹çš„æ“ä½œç³»ç»Ÿæ ˆè¯¥æ ˆä»…ç”¨äºçº¿ç¨‹åˆ‡æ¢çš„ä¸­æ–­ä½¿ç”¨ï¼ŒFreeRTOSå®˜æ–¹çš„portå±‚æ–¹æ¡ˆä¸­æ²¡æœ‰è¿™æ–¹é¢å†…å®¹ã€‚RISC-VèŠ¯ç‰‡æ²¡æœ‰ç‹¬ç«‹çš„ä¸­æ–­æ ˆç©ºé—´ï¼Œæ‰€ä»¥èŠ¯ç‰‡å‚å•†ä¸ºRTOSä¸Šä¸‹æ–‡åˆ‡æ¢ä¸­æ–­ç‰¹åˆ«å®ç°äº†ä¸­æ–­æ ˆåˆ‡æ¢æœºåˆ¶ï¼Œç›¸å¯¹åº”çš„æ ˆç©ºé—´éœ€è¦æå‰åœ¨é“¾æ¥è„šæœ¬ä¸­åˆ†é…ã€‚è¿™æ˜¯ä¸ARMå•ç‰‡æœºåŒºåˆ«è¾ƒå¤§çš„åœ°æ–¹ï¼ŒARMå•ç‰‡æœºå¯è‡ªå®šä¹‰çº¿ç¨‹æ ˆå’Œä¸­æ–­æ ˆï¼Œå¹¶ç”±èŠ¯ç‰‡è‡ªåŠ¨å®Œæˆåˆ‡æ¢ã€‚è¿™é‡Œéœ€è¦æ³¨æ„é“¾æ¥è„šæœ¬çš„å†™æ³•ï¼Œæ“ä½œç³»ç»Ÿçš„æ ˆç©ºé—´å’Œç³»ç»Ÿå¼€å§‹è¿è¡Œçš„æ ˆç©ºé—´å…¶å®å¯ä»¥ä¸ºåŒä¸€ä¸ªåœ°å€ç©ºé—´ï¼Œå› ä¸ºæ“ä½œç³»ç»Ÿå¼€å§‹è¿è¡Œåï¼Œæœ€å¼€å§‹çš„ä¸»æ ˆç©ºé—´å°†ä¸å†ä½¿ç”¨ã€‚æ‰€ä»¥è¿™ä¸¤éƒ¨åˆ†ç©ºé—´æ˜¯ä¸€è‡´çš„ã€‚åœ¨xPortStartFirstTaskå®ç°ä¸­ï¼Œå°†é“¾æ¥è„šæœ¬åˆ†é…çš„ç©ºé—´åœ°å€å‡å°äº†512å­—èŠ‚ï¼Œè¿™ä¸»è¦æ˜¯é¿å…å’Œä¸»æ ˆç©ºé—´å‘é€å†²çªï¼Œä½†å®é™…ä¸Šè¿™é‡Œåº”è¯¥æ˜¯ä¸éœ€è¦çš„ã€‚å°†ä¸­æ–­æ ˆåœ°å€å°†å†™å…¥åˆ°mscratchå¯„å­˜å™¨ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸´æ—¶å­˜å‚¨æ•°æ®çš„å¯„å­˜å™¨ï¼Œè¿™é‡Œå°†ä¸“ç”¨äºä¿å­˜æ ˆåœ°å€ï¼Œé€šè¿‡å¯„å­˜å™¨äº¤æ¢æŒ‡ä»¤å®ç°spå¯„å­˜å™¨å’Œmscratchçš„äº¤æ¢ï¼Œè¾¾åˆ°æ ˆç©ºé—´çš„åˆ‡æ¢ç›®çš„ï¼Œè¿™æ ·ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸è°ƒåº¦ä¸­æ–­çš„æ ˆå°†ç›¸äº’ç‹¬ç«‹ã€‚\n .stack ORIGIN(RAM) + LENGTH(RAM) - __stack_size :&#123;    PROVIDE( _heap_end = . );        . = ALIGN(4);    PROVIDE(_susrstack = . );    . = . + __stack_size;    PROVIDE( _eusrstack = .);    __freertos_irq_stack_top = .;&#125; &gt;RAM \n\nèŠ¯ç‰‡è¿è¡Œæ¨¡å¼è¯¥èŠ¯ç‰‡å…·æœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼Œç”¨æˆ·æ¨¡å¼å’Œæœºå™¨æ¨¡å¼ï¼ŒåŸåˆ™ä¸Šæ¥è¯´èŠ¯ç‰‡ä¸Šç”µå¯åŠ¨åèŠ¯ç‰‡è¿è¡Œåœ¨æœºå™¨æ¨¡å¼ï¼Œä½†æ˜¯å‚å®¶æä¾›çš„å¯åŠ¨ä»£ç å°†èŠ¯ç‰‡è°ƒæ•´åˆ°äº†ç”¨æˆ·æ¨¡å¼ï¼Œåœ¨è£¸æœºå¼€å‘æ—¶è¿™å¯èƒ½æ›´æœ‰åˆ©äºç³»ç»Ÿå®‰å…¨ã€‚ä½†æ˜¯åœ¨RTOSç³»ç»Ÿä¸­ï¼Œç³»ç»Ÿä¸ºäº†è®¿é—®CSRå¯„å­˜å™¨å®ç°å¯¹å¤„ç†å™¨çš„æ§åˆ¶ï¼Œç³»ç»Ÿå¿…é¡»å…è®¸åœ¨ç‰¹æƒçº§ã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦è°ƒæ•´å¯åŠ¨æ±‡ç¼–ä»£ç ï¼Œæ ¹æ®èŠ¯ç‰‡ç›¸å…³æ‰‹å†Œï¼Œè°ƒæ•´mstatuså¯„å­˜å™¨ä½¿å¾—èŠ¯ç‰‡å§‹ç»ˆè¿è¡Œåœ¨æœºå™¨æ¨¡å¼ã€‚è¿™éƒ¨åˆ†å†…å®¹ä¸ARMå•ç‰‡æœºä¹Ÿæœ‰åƒç±»ä¼¼çš„åœ°æ–¹ã€‚ARMå•ç‰‡æœºä¹Ÿåˆ†ä¸ºç‰¹æƒæ¨¡å¼å’Œéç‰¹æƒæ¨¡å¼ï¼Œç›®å‰å¸‚é¢ä¸Šå¤§éƒ¨åˆ†æ“ä½œç³»ç»Ÿéƒ½è¿è¡Œåœ¨ç‰¹æƒçº§ï¼ŒåŒ…æ‹¬ç”¨æˆ·çº§çš„çº¿ç¨‹ã€‚ä»…å°‘éƒ¨åˆ†æ“ä½œç³»ç»Ÿå¯¹ç”¨æˆ·çº¿ç¨‹å®ç°äº†æƒé™ç®¡ç†ã€‚\n\nCall API from ISRä¸ºäº†ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œå¥å£®æ€§ï¼ŒFreeRTOSè¦æ±‚åœ¨ä¸­æ–­ä¸­ä½¿ç”¨FromISRç»“å°¾çš„ç³»ç»ŸAPIã€‚ä½†æ˜¯èŠ¯ç‰‡å®˜æ–¹çš„portå®ç°ä¸­ç¼ºå°‘ç›¸å…³çš„æ£€æµ‹æ”¯æŒï¼Œè¿™ä½¿å¾—è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°ä¸€äº›æ½œåœ¨çš„é£é™©æ— æ³•æš´éœ²ã€‚ä¸»è¦æ˜¯åœ¨vPortEnterCritical()æ¥å£çš„å®ç°ä¸­ï¼Œå½“ç¬¬ä¸€æ¬¡è¿›å…¥ä¸´ç•ŒåŒºï¼Œéœ€è¦æ£€æµ‹æ˜¯å¦åœ¨ä¸­æ–­ä¸­ï¼Œå› ä¸ºè¯¥APIä»…èƒ½å¤Ÿåœ¨éä¸­æ–­ä¸Šä¸‹æ–‡ä½¿ç”¨ï¼Œä¸­æ–­ä¸Šä¸‹æ–‡æœ‰å…¶å®ƒçš„å®ç°æ¥å£ã€‚èŠ¯ç‰‡å®˜æ–¹å’ŒFreeRTOSé»˜è®¤çš„portå±‚ä»£ç å¦‚ä¸‹ï¼š\n void vPortEnterCritical( void )&#123;    portDISABLE_INTERRUPTS();    uxCriticalNesting++;&#125;\n å¯è§ç¼ºå°‘ç›¸å…³æ•…éšœæ–­è¨€æ”¯æŒï¼Œè¿™é‡Œå¯è°ƒæ•´ä¸ºï¼š\n void vPortEnterCritical( void )&#123;    portDISABLE_INTERRUPTS();    uxCriticalNesting++;    if( uxCriticalNesting == 1 )    &#123;        configASSERT( ( (PFIC-&gt;GISR) &amp; 0x1ff ) == 0 );    &#125;&#125;\n é€šè¿‡GISRå¯„å­˜å™¨å®ç°ä¸­æ–­ä¸Šä¸‹æ–‡çš„è¯†åˆ«å’Œæ£€æµ‹ã€‚\n\nä½åŠŸè€—æ¨¡å¼æ— è®ºæ˜¯FreeRTOSå®˜æ–¹ä»£ç è¿˜æ˜¯èŠ¯ç‰‡äº§å®¶çš„portå±‚ä»£ç ä¸­éƒ½ç¼ºå°‘ä½åŠŸè€—æ”¯æŒç›¸å…³çš„å†…å®¹ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†éœ€è¦è‡ªå·±å®ç°ï¼Œå› ä¸ºèŠ¯ç‰‡æ˜¯æ”¯æŒä½åŠŸè€—æ¨¡å¼çš„ã€‚ä¸»è¦æ˜¯éœ€è¦å……åˆ†ç†è§£systickè¿è¡Œæœºåˆ¶ä»¥åŠèŠ¯ç‰‡çš„ä½åŠŸè€—è¿›å…¥åŠå”¤é†’æœºåˆ¶å¹¶é…åˆæ“ä½œç³»ç»Ÿå®Œæˆä½åŠŸè€—è¿ç®—çš„å®ç°ã€‚ä½¿ç”¨WFIæŒ‡ä»¤å¯ä»¥è®©å¤„ç†å™¨è¿›å…¥ä½åŠŸè€—æ¨¡å¼ï¼Œå½“å‘ç”Ÿä¸­æ–­æ—¶å¯è‡ªåŠ¨å”¤é†’èŠ¯ç‰‡ï¼Œä½†æ˜¯åœ¨FreeRTOSç³»ç»Ÿä¸­é…åˆsystickå®ç°çš„ä½åŠŸè€—æ¥å£vPortSuppressTicksAndSleepï¼Œåœ¨WFIæŒ‡ä»¤å‰éœ€è¦å…³é—­ä¸­æ–­ï¼Œæ‰€ä»¥å¯¼è‡´ç³»ç»Ÿæ— æ³•æ­£å¸¸å”¤é†’ã€‚è¿™é‡Œéœ€è¦ç‰¹æ®Šå¤„ç†ä¸€ä¸‹ï¼Œé€šè¿‡SCTLRå¯„å­˜å™¨å°†WFIæŒ‡ä»¤åˆ‡æ¢ä¸ºeventæ¨¡å¼ï¼Œå³é€šè¿‡äº‹ä»¶å”¤é†’ç³»ç»Ÿã€‚å†å°†SEVONPENDæ ‡å¿—ç½®ä½ï¼Œè¿™æ ·å³ä½¿å…³é—­å…¨å±€ä¸­æ–­ï¼Œå½“ç³»ç»Ÿçš„ä»»æ„ä¸­æ–­å‘ç”Ÿæ—¶ä»ç„¶èƒ½å¤Ÿç«‹å³å”¤é†’èŠ¯ç‰‡ã€‚åœ¨å…·ä½“å®ç°vPortSuppressTicksAndSleepä¸Šï¼Œéœ€è¦æ³¨æ„systickçš„è®¡æ•°æ–¹å‘ï¼ŒFreeRTOSå·²ç»å°†å…¶æ”¹ä¸ºå‘ä¸Šè®¡æ•°ï¼Œæ‰€ä»¥è¿™é‡ŒåŒä¸€èˆ¬STM32å•ç‰‡æœºçš„è®¡æ•°æ–¹å‘æ˜¯ç›¸åçš„ã€‚å…ˆæ ¹æ®ç³»ç»Ÿéœ€è¦ä¼‘çœ çš„æ—¶é—´ä¼°ç®—systickçš„è®¡æ•°å€¼ï¼Œé‡è®¾systickçš„CMPå¯„å­˜å™¨ï¼Œé€šè¿‡WFIè®©èŠ¯ç‰‡ä¼‘çœ ï¼ŒèŠ¯ç‰‡å”¤é†’åæ£€æŸ¥æ˜¯systickå”¤é†’è¿˜æ˜¯å…¶å®ƒä¸­æ–­å”¤é†’ï¼Œå¦‚æœæ˜¯å…¶å®ƒä¸­æ–­å”¤é†’åˆ™éœ€è¦æ ¹æ®systickçš„è®¡æ•°å€¼è®¡ç®—åˆšåˆšä¼‘çœ çš„æ—¶é•¿ã€‚å°†systickçš„CMPæ¢å¤åˆ°ä¼‘çœ å‰çš„çŠ¶æ€ï¼Œé€šçŸ¥RTOSå†…æ ¸åˆšåˆšä¼‘çœ çš„æ—¶é•¿ï¼Œè¿™æ ·å³å®Œæˆäº†ä½åŠŸè€—portçš„å®ç°ï¼Œåœ¨å…·ä½“çš„å®ç°ä¸Šè¿˜éœ€è¦æ³¨æ„systickåœ¨ä¸åŒæ—¶é—´æ®µçš„ç´¯è®¡è¡¥å¿å’Œåœæœºè¡¥å¿ã€‚ä½¿ç”¨ä½åŠŸè€—æ¨¡å¼ä¼šä¸å¯é¿å…çš„ä½¿å¾—RTOSæ—¶é—´åŒå®é™…æ—¶é—´å‘ç”Ÿä¸€å®šçš„åç§»ï¼Œä½†è¿™ä¸ªåç§»åœ¨é•¿æ—¶é—´çš„ç´¯è®¡æ‰ä¼šæ¯”è¾ƒæ˜æ˜¾ï¼Œä¸€èˆ¬å½±å“ä¸å¤§ã€‚ä½†æ˜¯å¦‚æœå°†RTOSçš„å†…æ ¸æ—¶é—´ä½œä¸ºæ—¥å†æ—¶é—´ä½¿ç”¨åˆ™ä¼šå¯¼è‡´ä¸€å®šçš„è¯¯å·®ï¼Œè¿™æ˜¯å¼€å¯ä½åŠŸè€—æ¨¡å¼æ—¶éœ€è¦æ³¨æ„çš„é—®é¢˜ã€‚åœ¨æˆ‘çš„å¼€å‘æ¿ä¸Šæµ‹è¯•ï¼Œåœ¨è¿è¡Œç›¸åŒè½¯ä»¶åº”ç”¨çš„æƒ…å†µä¸‹ï¼Œæœªå¼€å¯ä½åŠŸè€—æ¨¡å¼è¿è¡Œæ—¶çš„ç”µæºä¸º5V&#x2F;29mAï¼Œå¼€å¯ä½åŠŸè€—æ¨¡å¼åçš„ç”µæºä¸º5V&#x2F;19mAï¼Œè€ƒè™‘åˆ°å¼€å‘æ¿ä¸Šå­˜åœ¨ä¸€äº›å›ºå®šåŠŸç‡å¼€é”€ï¼Œä½åŠŸè€—æ¨¡å¼å¸¦æ¥çš„ä¼˜åŠ¿è¿˜æ˜¯éå¸¸æ˜æ˜¾çš„ã€‚æ³¨ï¼šå¼€å¯ä½åŠŸè€—æ¨¡å¼è¿è¡Œåï¼Œç½‘å¡é©±åŠ¨çš„å‘é€éƒ¨åˆ†ç¡¬ä»¶DMAå­˜åœ¨ä¸€å®šçš„å¼‚å¸¸é—®é¢˜è¿˜æœªè§£å†³ã€‚\n\n\nå¤ªç½‘æ§åˆ¶å™¨èŠ¯ç‰‡å†…å»º10Mçš„PHYï¼Œè¿™æ„å‘³è¿™è¯¥èŠ¯ç‰‡ä¸éœ€è¦å•ç‹¬çš„ç½‘å¡èŠ¯ç‰‡å³èƒ½å¤Ÿå®ç°ç½‘ç»œé€šä¿¡ï¼Œä½¿ç”¨å•ç‰‡èŠ¯ç‰‡æ–¹æ¡ˆå³èƒ½å¤Ÿå®Œæˆè”ç½‘åº”ç”¨å¼€å‘ã€‚èŠ¯ç‰‡å‚å®¶æä¾›äº†ä¸€ä¸ªç½‘ç»œåè®®æ ˆWCHNETï¼Œè¯¥åè®®æ ˆèƒ½å¤Ÿæ»¡è¶³åŸºæœ¬çš„ç½‘ç»œåº”ç”¨å¼€å‘éœ€æ±‚ï¼Œä½†æ˜¯é¢å¯¹å¤æ‚åº”ç”¨ï¼Œä½¿ç”¨LwIPåè®®æ ˆå¯èƒ½æ›´åŠ åˆé€‚ã€‚\nLwIPä¾èµ–å‰é¢çš„æ“ä½œç³»ç»Ÿï¼Œæ­¤å¤–åè®®æ ˆæ²¡æœ‰å…¶å®ƒçš„ç§»æ¤è¦æ±‚ã€‚ä¸ºäº†è®©åè®®æ ˆæ­£å¸¸è¿è¡Œèµ·æ¥ï¼Œæœ€å…³é”®çš„æ˜¯å®ç°ç½‘å¡é©±åŠ¨ã€‚è¿™é‡Œå‚è€ƒå®˜æ–¹ç¤ºä¾‹åŸºæœ¬èƒ½å¤Ÿå®Œæˆé©±åŠ¨å¼€å‘ï¼Œå®˜æ–¹è™½ç„¶æ²¡æœ‰é’ˆå¯¹LwIPè¿›è¡Œé€‚é…ï¼Œä½†æ˜¯é©±åŠ¨å±‚çš„MACå¸§éƒ½æ˜¯é€šç”¨çš„ï¼Œæ‰€ä»¥é©±åŠ¨çš„ç§»æ¤éš¾åº¦ä¹Ÿä¸å¤§ã€‚ä»¥å¤ªç½‘HALå±‚çš„ä»£ç ç»“æ„åŒSTM32å•ç‰‡æœºç±»ä¼¼ï¼Œç”¨æ³•ä¸Šæ²¡æœ‰é™Œç”Ÿæ„Ÿã€‚\né©±åŠ¨ç§»æ¤å®Œæˆåè¿›è¡Œäº†ç®€å•çš„ç½‘ç»œæµ‹è¯•ï¼Œä½¿ç”¨iperfå·¥å…·æµ‹è¯•ï¼Œæ”¶å‘å¸¦å®½å¯è¾¾9.3Mï¼ŒåŸºæœ¬ä¸Šè¾¾åˆ°10Mæ¥å£çš„ä¼ è¾“é€Ÿåº¦ä¸Šé™ã€‚\nUSBæ§åˆ¶å™¨èŠ¯ç‰‡å®˜æ–¹æä¾›äº†è¾ƒä¸°å¯Œçš„æµ‹è¯•ä»£ç ï¼Œæœ‰HSã€FSç«¯å£ç›¸å…³çš„ä»£ç ï¼Œè¿˜æœ‰ä¸»æœºã€ä»æœºçš„ç¤ºä¾‹ã€‚åº”ç”¨ç±»åˆ«ä¹Ÿæœ‰CDCã€ç½‘ç»œç­‰ã€‚è¿è¡Œäº†å®˜æ–¹ç¤ºä¾‹ä»£ç ï¼Œå¯ä»¥ç¡®è®¤USBHSèƒ½å¤Ÿå¾ˆå¥½çš„å·¥ä½œï¼Œä½†æ˜¯åœ¨ç§»æ¤Tinyusbæ˜¯é‡åˆ°äº†ä¸€äº›é—®é¢˜ã€‚\nTinyUSBæ˜¯ç¬¬ä¸‰æ–¹USBåè®®æ ˆï¼Œå…¶æ”¯æŒCH32V307èŠ¯ç‰‡ï¼Œè¯¥åè®®æ ˆèƒ½å¤Ÿéå¸¸æ–¹ä¾¿çš„è¿›è¡ŒUSBè®¾å¤‡æè¿°ç¬¦çš„ç¼–å†™ï¼Œè¿™æ˜¯æˆ‘å¸¸ç”¨çš„ä¸€ä¸ªUSBåè®®æ ˆåº“ã€‚è¯¥åè®®æ ˆä¹Ÿå¯¹CH32V307çš„HSç«¯å£è¿›è¡Œäº†é€‚é…ï¼Œä½†æ˜¯åœ¨å®é™…è¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°äº†ä¸€äº›é—®é¢˜ã€‚åœ¨å…³é—­åè®®æ ˆè°ƒè¯•æ—¥å¿—çš„æƒ…å†µä¸‹ï¼Œå†…éƒ¨ä¼šå‡ºç°æ–­è¨€é”™è¯¯ï¼Œæ‰“å¼€æ—¥å¿—åï¼Œè¯¥æ•…éšœæ¶ˆå¤±ã€‚è¾“å‡ºæ—¥å¿—ä¼šå½±å“ä»£ç çš„è¿è¡Œé€Ÿåº¦ï¼Œè¿™åº”è¯¥å°±å…¶å†…éƒ¨çš„å·®å¼‚ã€‚å¯¼è‡´è¯¥é—®é¢˜çš„åŸå› æ²¡æœ‰è¿›ä¸€æ­¥ç ”ç©¶ï¼Œåº”è¯¥æ˜¯é©±åŠ¨å±‚æˆ–åè®®å±‚ä»£ç å­˜åœ¨ä¸€äº›ç«Ÿæ€é—®é¢˜ã€‚æ‰€ä»¥é’ˆå¯¹è¯¥èŠ¯ç‰‡USBæ–¹é¢çš„å†…å®¹å°±æ²¡æœ‰è¿›è¡Œæ›´åŠ æ·±å…¥çš„æµ‹è¯•ã€‚æ£€æŸ¥TinyUSBå®˜æ–¹çš„issusåˆ—è¡¨ï¼Œå¯ä»¥ç¡®è®¤é’ˆå¯¹CH32V307çš„é€‚é…è¿˜å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œå¾…ä¿®å¤åå†æµ‹è¯•è¯¥èŠ¯ç‰‡çš„USBæ€§èƒ½ã€‚\næ•…éšœè¯Šæ–­è¯¥èŠ¯ç‰‡æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„æ•…éšœä¸­æ–­ï¼Œç±»ä¼¼äºARMå•ç‰‡æœºçš„HardFaultï¼Œä½†æ˜¯è¯¥æ•…éšœä¸­æ–­å›Šæ‹¬äº†èŠ¯ç‰‡è¿è¡Œçš„å¤§éƒ¨åˆ†æ•…éšœï¼ŒåŒ…æ‹¬æŒ‡ä»¤å¼‚å¸¸ã€å†…å­˜å¯»å€é”™è¯¯ã€å†…å­˜éå¯¹é½ç­‰ã€‚ç‰¹åˆ«æ³¨æ„RISC-Vå•ç‰‡æœºä¸æ”¯æŒéå¯¹é½å†…å­˜è®¿é—®ï¼Œåœ¨ç¼–å†™Cä»£ç æ—¶éœ€è¦æ³¨æ„è§„é¿è¿™æ–¹é¢çš„é—®é¢˜ã€‚\nå½“å‘ç”Ÿæ•…éšœæ—¶ï¼Œå¯ä»¥é€šè¿‡CSRå¯„å­˜å™¨åˆ—è¡¨ä¸­çš„mcauseå¯„å­˜å™¨ç¡®å®šå‘ç”Ÿæ•…éšœçš„åŸå› ã€‚æ›´è¿›ä¸€æ­¥çš„ï¼Œé€šè¿‡mepcå¯„å­˜å™¨è¿˜èƒ½å¤Ÿæä¾›å‘ç”Ÿæ•…éšœæ—¶çš„PCæŒ‡é’ˆã€‚è¿™å¯¹äºæ•…éšœçš„è¯Šæ–­ååˆ†æœ‰åˆ©ã€‚\nä¸­æ–­æ§åˆ¶å™¨è¿™æ˜¯èŠ¯ç‰‡ç›¸å…³çš„å†…å®¹ï¼Œå¹¶ä¸æ˜¯RISC-Vé€šç”¨çš„ä¸­æ–­æ§åˆ¶å™¨ã€‚èŠ¯ç‰‡å¯æ”¯æŒ8çº§ä¸­æ–­ä¼˜å…ˆçº§ã€4ç»„ä¼˜å…ˆçº§åˆ†ç»„ã€‚è¯¥èŠ¯ç‰‡çš„ç‰¹è‰²æ˜¯æ”¯æŒç¡¬ä»¶å‹æ ˆï¼Œå³ç¡¬ä»¶ä¸Šæœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ç”¨äºä¸­æ–­å‘ç”Ÿæ—¶é€šè¿‡ç¡¬ä»¶è‡ªåŠ¨ä¿æŒcaller savedå¯„å­˜å™¨ï¼Œè¿™æ„å‘³å…¶ç›¸æ¯”äºä¸€èˆ¬çš„å•ç‰‡æœºä¸­æ–­ï¼Œå®ƒçš„å“åº”è¿‡ç¨‹å¯ä»¥å‡å°‘è®¸å¤šé¢å¤–çš„æŒ‡ä»¤å¼€é”€ã€‚ç¡¬ä»¶å‹æ ˆæœ€é«˜æ”¯æŒ3çº§åµŒå¥—ï¼Œå¯ä»¥æ»¡è¶³ä¸­æ–­é«˜å®æ—¶æ€§çš„è¦æ±‚ã€‚\næ­¤å¤–ï¼ŒèŠ¯ç‰‡è¿˜æ”¯æŒ4è·¯å…è¡¨ä¸­æ–­ï¼Œå³ä¸é€šè¿‡ä¸­æ–­å‘é‡è¡¨ï¼Œå°†ä¸­æ–­å‡½æ•°å…¥å£åœ°å€ç›´æ¥ç»‘å®šåˆ°æŒ‡å®šçš„ä¸­æ–­ä¸Šï¼Œè¿™å°†è¿›ä¸€æ­¥æé«˜ä¸­æ–­çš„å“åº”é€Ÿåº¦ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒåŒºåˆ«äºARMå•ç‰‡æœºä¸­æ–­æœ‰ç‹¬ç«‹çš„æ ˆï¼Œè¯¥èŠ¯ç‰‡å‘ç”Ÿä¸­æ–­æ—¶å¹¶ä¸ä¼šè‡ªåŠ¨åˆ‡æ¢æ ˆç©ºé—´ï¼Œè¿™æ„å‘³ç€ä¸­æ–­æ ˆç©ºé—´å°†æ˜¯çº¿ç¨‹æ ˆç©ºé—´çš„å»¶ç»­ã€‚åœ¨è°ƒè¯•ç½‘å¡ä¸­æ–­æ—¶æˆ‘æ²¡æœ‰æ„è¯†åˆ°è¿™ä¸€ç‚¹ï¼Œå¯¼è‡´ä¸­æ–­å‘ç”Ÿæ—¶å°†IDLEçº¿ç¨‹çš„æ ˆç©ºé—´æº¢å‡ºã€‚å¦‚æœä¸èƒ½æ‰‹åŠ¨å°†æ ˆåˆ‡æ¢åˆ°ç‹¬ç«‹ç©ºé—´ï¼Œé‚£ä¹ˆéœ€è¦æ§åˆ¶ä¸­æ–­å‡½æ•°çš„æ ˆç©ºé—´æ¶ˆè€—ã€‚\nå…¶å®ƒå†…å®¹èŠ¯ç‰‡å®˜æ–¹å¼€å‘çš„HALåº“åœ¨ä»£ç é£æ ¼ä¸Šæ¥è¿‘STM32æ—©æœŸçš„æ ‡å‡†åº“ï¼Œç”šè‡³éƒ¨åˆ†APIåç§°éƒ½ä¸€è‡´ï¼Œè¿™ä¹Ÿæ˜¯æ–¹ä¾¿å…¥æ‰‹è¯¥èŠ¯ç‰‡çš„ä¼˜åŠ¿ã€‚\nåœ¨ä»¥ä¸Šå¼€å‘æµ‹è¯•è¿‡ç¨‹ä¸­ç¼–è¯‘å™¨ä¸€ç›´ä½¿ç”¨-Osä¼˜åŒ–ï¼Œä»£ç è¿è¡Œè¿‡ç¨‹ä¸­æ²¡æœ‰å‡ºç°ç”±äºç¼–è¯‘ä¼˜åŒ–å¯¼è‡´çš„é—®é¢˜ã€‚\nèŠ¯ç‰‡çš„æœ€é«˜ä¸»é¢‘ä¸º144MHzï¼Œä»£ç æ¨¡æ¿é‡‡ç”¨é»˜è®¤çš„96MHzã€‚96MHzä¸»é¢‘ä¸‹ï¼ŒåŸºäºFreeRTOSç³»ç»Ÿè¿è¡ŒCoremarkåŸºå‡†æµ‹è¯•ï¼Œè·‘åˆ†å¯è¾¾250åˆ†(æ»¡é¢‘ç‡è¿è¡Œåº”å½“ä¸º370åˆ†)ï¼Œæ€§èƒ½åŒARMçš„CM4å†…æ ¸æ°´å¹³ç›¸å½“ã€‚\n2K performance run parameters for coremark.CoreMark Size    : 666Total ticks      : 15839Total time (secs): 15.839000Iterations/Sec   : 252.541196Iterations       : 4000Compiler version : GCC8.2.0Compiler flags   : -OfastMemory location  : FreeRTOS-heap4seedcrc          : 0xe9f5[0]crclist       : 0xe714[0]crcmatrix     : 0x1fd7[0]crcstate      : 0x8e3a[0]crcfinal      : 0x65c5Correct operation validated. See README.md for run and reporting rules.CoreMark 1.0 : 252.541196 / GCC8.2.0 -Ofast / FreeRTOS-heap4\n\næ­¤å¤–è¿˜æµ‹è¯•äº†SPIã€TIMç­‰å¤–è®¾ï¼Œæ€§èƒ½å°šå¯ã€‚è¯¥èŠ¯ç‰‡è¿˜å…·æœ‰DVPã€FSMCç­‰å¤–è®¾ï¼Œå¯è¿›ä¸€æ­¥æ‹“å±•è¯¥èŠ¯ç‰‡çš„ç”¨é€”ã€‚\næ€»çš„æ¥è¯´ï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨RISC-VèŠ¯ç‰‡ï¼Œè¯¥èŠ¯ç‰‡ç»™æˆ‘ç•™ä¸‹äº†è¾ƒå¥½çš„å½±å“ã€‚æˆ‘è®¤ä¸ºè¯¥å›½äº§èŠ¯ç‰‡çš„åŠŸèƒ½å·²ç»è¾¾åˆ°äº†ç›®å‰ä¸»æµå•ç‰‡æœºçš„è¡Œåˆ—ï¼Œä½†å…¶æµè¡Œç¨‹åº¦ã€ç›¸å…³çš„å¼€å‘ç”Ÿæ€ç¯å¢ƒã€ç¤¾åŒºæ´»è·ƒåº¦éƒ½è¿˜éœ€è¦è¿›ä¸€æ­¥å‘å±•ã€‚å°†å…¶åº”ç”¨åˆ°é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­éœ€è¦è€ƒè™‘é¢ä¸´æ•…éšœæ—¶ç¼ºå°‘ç»éªŒçš„é—®é¢˜ï¼Œå›½äº§å•ç‰‡æœºçš„å‘å±•ä»»é‡è€Œé“è¿œã€‚\n"},{"title":"ä¸€ä¸ªæç®€çš„DAPLink","url":"/2024/06/20/%E4%B8%80%E4%B8%AA%E6%9E%81%E7%AE%80%E7%9A%84DAPLink/","content":"å¹³æ—¶æˆ‘çš„ä¸»è¦å…´è¶£æ–¹å‘éƒ½æ˜¯åµŒå…¥å¼è½¯ä»¶å¼€å‘æ–¹é¢çš„å†…å®¹ï¼Œä½†å¶å°”ä¹Ÿåšä¸€äº›ç¡¬ä»¶ç›¸å…³çš„å†…å®¹ã€‚æˆ‘çš„ç¡¬ä»¶è®¾è®¡æ°´å¹³ä¸€èˆ¬ï¼Œä»…ä»…æ˜¯èƒ½å¤Ÿç”¨å˜‰ç«‹åˆ›çš„EDAè½¯ä»¶è®¾è®¡ä¸€äº›ç®€å•çš„PCBï¼Œç„Šæ¥èƒ½åŠ›æ›´æ˜¯æ‹¿ä¸å‡ºæ‰‹ğŸ˜…ã€‚\nä¹‹å‰æˆ‘å¶ç„¶é—´çœ‹åˆ°ä¸€ä¸ªåˆ«äººè®¾è®¡çš„DAPLinkï¼Œä½¿ç”¨51å•ç‰‡æœºå®Œæˆçš„ã€‚è®©æˆ‘æ„Ÿå…´è¶£çš„æ˜¯ï¼Œå¦‚æœæ›´æ¢åŒç±»å‹çš„æ›´å°å°è£…èŠ¯ç‰‡ï¼Œæˆ–è®¸å¯ä»¥è®¾è®¡å‡ºä¸€ä¸ªéå¸¸å°çš„DAPLinkï¼Œæ‰€ä»¥å°±æœ‰äº†æˆ‘çš„ä¸€ä¸ªè®¾è®¡ã€‚\næˆ‘ä½¿ç”¨CH552Eå•ç‰‡æœºåŠ ä¸€ä¸ªLDOä»¥åŠå…¶å®ƒå‡ ä¸ªç”µé˜»ç”µå®¹å°±å®Œæˆäº†å®ƒçš„ä¸»è¦ç”µè·¯ã€‚ä¸€ä¸ªæç®€çš„DAPLinkï¼Œå…·æœ‰ä¸€ä¸ªSWDæ¥å£å’Œä¸€ä¸ªUARTæ¥å£ï¼Œåªæœ‰å¤§çº¦USBtype-Cæ¯åº§çš„å¤§å°ã€‚å¦‚æœä½ å–œæ¬¢ï¼Œå®ƒç”šè‡³å¯ä»¥ä½œä¸ºä½ çš„æ¿è½½è°ƒè¯•å™¨ã€‚\n\næˆ‘å·²ç»è®©å®ƒå·¥ä½œäº†å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œçœ‹èµ·æ¥éå¸¸å¥½ç”¨ã€‚åœ¨æŸä¸ªé‡äº§é¡¹ç›®ä¸­ï¼Œæˆ‘æŠŠå®ƒå½“ä½œå›ºä»¶æ‰¹é‡ä¸‹è½½å·¥å…·ï¼Œç›®å‰è¿˜æ²¡æœ‰é‡åˆ°æ˜æ˜¾çš„é—®é¢˜ã€‚\næœ€åï¼Œå®ƒçš„åŸç†å›¾ã€PCBã€æºä»£ç ã€ç¼–è¯‘å¥½çš„å›ºä»¶åœ¨è¿™é‡Œï¼šåŸç†å›¾PCBï¼šç«‹åˆ›å¼€æº-DAPLinkå›ºä»¶ã€æºç ï¼šhttps://github.com/DazzlingOkami/CH552-DAPLink\n"},{"title":"ä»å•ç‰‡æœºåˆ°FPGAï¼šæˆ‘çš„RISC-Vè½¯æ ¸å¼€å‘å®è·µ","url":"/2025/05/16/%E4%BB%8E%E5%8D%95%E7%89%87%E6%9C%BA%E5%88%B0FPGA%EF%BC%9A%E6%88%91%E7%9A%84RISC-V%E8%BD%AF%E6%A0%B8%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5/","content":"ä»å•ç‰‡æœºåˆ° FPGAï¼šæˆ‘çš„ RISC-V è½¯æ ¸å¼€å‘å®è·µä¸€ã€å•ç‰‡æœºæ•°æ®å¤„ç†ç“¶é¢ˆå¼•å‘çš„æŠ€æœ¯æ€è€ƒåœ¨è¿‘æœŸçš„é¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘é­é‡äº†ä¸€ä¸ªæ£˜æ‰‹çš„æŠ€æœ¯æŒ‘æˆ˜ï¼šéœ€è¦åœ¨å•ç‰‡æœºç«¯ç›´æ¥å¤„ç† 2.6Msps çš„æ•°æ®é‡ï¼Œè€Œ 500MHz ä¸»é¢‘é™åˆ¶ä¸‹ï¼Œæ¯ä¸ªæ•°æ®çš„å¤„ç†æ—¶é—´ä»…æœ‰ä¸åˆ° 200 ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚ä¼ ç»Ÿæ–¹æ¡ˆä¸­ï¼Œdouble ç±»å‹çš„é«˜ç²¾åº¦è¿ç®—ä¸¥é‡æ¶ˆè€—è®¡ç®—èµ„æºï¼Œæ•°æ®æ€»çº¿å¸¦å®½å‹åŠ›å·¨å¤§ã€‚ç»è¿‡åå¤ä¼˜åŒ–ï¼Œæœ€ç»ˆé€šè¿‡å°†æ•°æ®ç±»å‹æ›¿æ¢ä¸º long å‹ï¼Œå¹¶å€ŸåŠ©æ±‡ç¼–å®ç°éƒ¨åˆ†å¹¶è¡Œå¤„ç†ï¼Œæ‰å‹‰å¼ºæ»¡è¶³å®æ—¶æ€§è¦æ±‚ã€‚\nè¿™æ¬¡ç»å†è®©æˆ‘æ·±åˆ»æ„è¯†åˆ°ï¼šå•ç‰‡æœºåœ¨é¢å¯¹å¤§è§„æ¨¡æ•°æ®å¹¶è¡Œè¿ç®—æ—¶å­˜åœ¨å¤©ç„¶å±€é™ã€‚å…¶å†¯ãƒ»è¯ºä¾æ›¼æ¶æ„ä¸‹çš„é¡ºåºæ‰§è¡Œæ¨¡å¼ï¼Œéš¾ä»¥é«˜æ•ˆå¤„ç†é«˜å¯†åº¦è®¡ç®—ä»»åŠ¡ã€‚è€Œ FPGA å‡­å€Ÿç¡¬ä»¶å¹¶è¡Œå¤„ç†çš„ç‰¹æ€§ï¼Œæ˜¾ç„¶æ›´é€‚åˆè¿™ç±»åœºæ™¯ã€‚äºæ˜¯ï¼Œæˆ‘å†³å®šé€šè¿‡ä¸€ä¸ªå®æˆ˜é¡¹ç›®å¼€å¯ FPGA çš„å­¦ä¹ ä¹‹æ—…ï¼Œç›®æ ‡æ˜¯æ„å»º STM32 ä¸ FPGA ååŒå·¥ä½œçš„å¼‚æ„è®¡ç®—ç³»ç»Ÿã€‚\näºŒã€é¡¹ç›®æ¶æ„è®¾è®¡ï¼šæ„å»ºå¼‚æ„è®¡ç®—ç³»ç»Ÿï¼ˆä¸€ï¼‰æ ¸å¿ƒåŠŸèƒ½å®šä¹‰é¡¹ç›®çš„æ ¸å¿ƒç›®æ ‡æ˜¯åœ¨ FPGA å†…è¿è¡Œ RISC-V è½¯æ ¸ï¼Œç”± STM32 é€šè¿‡ FMC æ€»çº¿å®Œæˆç¨‹åºåŠ è½½ä¸è¿è¡Œæ§åˆ¶ï¼Œå¹¶å®ç°ä¸¤è€…çš„æ•°æ®äº¤äº’ã€‚è¿™ä¸€æ¶æ„å€Ÿé‰´äº†å·¥ä¸šæ§åˆ¶ä¸­ â€œARM+FPGAâ€ çš„ç»å…¸ç»„åˆæ¨¡å¼ï¼šSTM32 è´Ÿè´£ä¸Šå±‚é€»è¾‘æ§åˆ¶ï¼ŒFPGA æ‰¿æ‹…åº•å±‚å¹¶è¡Œè®¡ç®—ï¼Œé€šè¿‡å†…å­˜æ˜ å°„çš„ FMC æ€»çº¿å®ç°é«˜æ•ˆé€šè®¯ã€‚\nï¼ˆäºŒï¼‰å…³é”®æŠ€æœ¯é€‰å‹RISC-V è½¯æ ¸ï¼šé€‰æ‹© PicoRV32 ä½œä¸ºæ ¸å¿ƒï¼Œå› å…¶è½»é‡çº§è®¾è®¡å’Œå¼€æºç”Ÿæ€ï¼Œä¾¿äºå¿«é€Ÿé›†æˆã€‚\nç¡¬ä»¶å¹³å°ï¼š\nFPGA é€‰ç”¨å®‰è·¯ç§‘æŠ€ EF2L45LG144B å¼€å‘æ¿ï¼Œå…¶å†…ç½®çš„ 256KB åŒç«¯å£ ERAM æˆä¸ºå…³é”®ï¼šä¸€ä¸ªç«¯å£è¿æ¥ RISC-V æ ¸ï¼ˆ32 ä½æ•°æ®å®½åº¦ï¼‰ï¼Œå¦ä¸€ä¸ªç«¯å£é€šè¿‡ FMC æ¥å£ä¸ STM32ï¼ˆ16 ä½æ•°æ®å®½åº¦ï¼‰é€šä¿¡ï¼Œæ•°æ®ä½å®½è½¬æ¢é€šè¿‡åœ°å€ä½ä½è‡ªåŠ¨é€‰æ‹©é«˜ä½å­—èŠ‚å®ç°ã€‚\nè‡ªä¸»è®¾è®¡ STM32 æ‰©å±•æ¿ï¼Œé€šè¿‡FPGAå¼€å‘æ¿é¢„ç•™æ¥å£ä¸ STM32 å®ç°ç¡¬ä»¶çº§è”ï¼Œæ„å»ºå®Œæ•´çš„åŒæ ¸å¿ƒç³»ç»Ÿã€‚\nä¸‰ã€Verilog è®¾è®¡å®è·µï¼šä»æ¨¡å—é›†æˆåˆ°æ—¶åºä¼˜åŒ–ï¼ˆä¸€ï¼‰é¡¶å±‚æ¶æ„è®¾è®¡`timescale  1 ps / 1 psmodule top(    input clk_ref,    input i_rst,    inout [15:0] fmc_data,    input fmc_wrn,    input fmc_rdn,    input fmc_csn,    input fmc_nadv);    wire clk;    wire rstn;    sys_clk u_sys_clk(        .clk_ref(clk_ref),        .i_rst(i_rst),        .clk(clk),        .rstn(rstn)    );    wire [15:0] mem_addr;    wire [15:0] mem_wdata;    wire [15:0] mem_rdata;    wire mem_wen;    wire mem_do;    fmc_bus u_fmc_bus (        .sys_clk(clk),        .sys_rst_n(rstn),        .db(fmc_data),        .wrn(fmc_wrn),        .rdn(fmc_rdn),        .csn(fmc_csn),        .nadv(fmc_nadv),        .ram_addr(mem_addr),        .ram_wdata(mem_wdata),        .ram_rdata(mem_rdata),        .ram_wen(mem_wen),        .ram_do(mem_do)    );    wire sram_valid;    assign sram_valid = (mem_addr &lt; 16&#x27;h8000);    wire [15:0] sram_rdata;    picorv32_ctrl u_picorv32_ctrl(        .clk(clk),        .rstn(rstn),        .ram_addr(mem_addr),        .ram_wdata(mem_wdata),        .ram_wen(mem_wen),        .ram_rdata(sram_rdata),        .ram_do(mem_do &amp; sram_valid)    );    assign mem_rdata =     sram_valid ? sram_rdata :                        16&#x27;h0000;endmodule\n\né¡¶å±‚æ¨¡å—é‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼š\næ—¶é’Ÿå­ç³»ç»Ÿï¼šé€šè¿‡ FPGA å†…ç½® PLL ç”Ÿæˆ 100MHz ç¨³å®šæ—¶é’Ÿï¼Œæ»¡è¶³ RISC-V æ ¸ä¸ FMC æ€»çº¿çš„æ—¶åºè¦æ±‚ã€‚\næ€»çº¿æ¥å£å±‚ï¼šFMC æ¨¡å—å®ç°å¼‚æ­¥æ€»çº¿åè®®è½¬æ¢ï¼Œå°† STM32 çš„ 16 ä½ FMC ä¿¡å·æ˜ å°„ä¸º 16 ä½å†…å­˜æ¥å£ï¼Œåœ°å€ç©ºé—´åˆ’åˆ†ä¸ºå‰ 64KBï¼ˆRISC-V ç¨‹åºåŒºï¼‰å’Œæ‰©å±•åŒºï¼ˆé¢„ç•™æœªæ¥åŠŸèƒ½ï¼‰ã€‚\næ ¸å¿ƒæ§åˆ¶å±‚ï¼šPicoRV32_CTRL æ¨¡å—è´Ÿè´£è½¯æ ¸ä¸å†…å­˜çš„äº¤äº’ï¼Œé€šè¿‡åŒç«¯å£ RAM å®ç° STM32ï¼ˆç«¯å£ Bï¼‰ä¸ RISC-Vï¼ˆç«¯å£ Aï¼‰çš„å¹¶è¡Œè®¿é—®ã€‚\nï¼ˆäºŒï¼‰RV32æ ¸å¿ƒæ§åˆ¶module picorv32_ctrl(    input clk,    input rstn,    input [15:0] ram_addr,    input [15:0] ram_wdata,    input ram_wen,    output [15:0] ram_rdata,    input ram_do);    wire trap;    wire mem_valid;    wire mem_instr;    reg mem_ready;    wire [31:0]    mem_rdata;    wire [31:0] mem_addr;    wire [31:0] mem_wdata;    wire [3:0] mem_wstrb;    wire mem_la_read;    wire mem_la_write;    wire [31:0] mem_la_addr;    wire [31:0] mem_la_wdata;    wire [3:0] mem_la_wstrb;    reg rv32_rstn;    reg rv32_state;    reg [15:0] rv32_ctrl_out;    always@(posedge clk) begin        if(~rstn) begin            rv32_rstn &lt;= 1&#x27;b0;        end        else begin            rv32_rstn &lt;= rv32_state;        end    end    always@(posedge clk) begin         if(~rstn) begin            rv32_state &lt;= 1&#x27;b0;        end else if(ram_do) begin            case(ram_addr)                16&#x27;h4001: begin                    if(ram_wen)                        rv32_state = ram_wdata[0];                    else                        rv32_ctrl_out &lt;= &#123;15&#x27;b0, rv32_state&#125;;                end                default: begin                    rv32_ctrl_out &lt;= 16&#x27;h0000;                end            endcase        end    end    picorv32 #(.COMPRESSED_ISA(1))    picorv32_core (        .clk         (clk         ),        .resetn      (rv32_rstn   ),        .trap        (trap        ),        .mem_valid   (mem_valid   ),        .mem_instr   (mem_instr   ),        .mem_ready   (mem_ready   ),        .mem_addr    (mem_addr    ),        .mem_wdata   (mem_wdata   ),        .mem_wstrb   (mem_wstrb   ),        .mem_rdata   (mem_rdata   ),        .mem_la_read (mem_la_read ),        .mem_la_write(mem_la_write),        .mem_la_addr (mem_la_addr ),        .mem_la_wdata(mem_la_wdata),        .mem_la_wstrb(mem_la_wstrb)    );    wire [31:0] ram_32_rdata;    wire [31:0] ram_32_wdata;    wire [3:0] ram_byte_en;    assign ram_byte_en = ram_addr[0] == 1&#x27;b0 ? 4&#x27;b0011 : 4&#x27;b1100;    assign ram_32_wdata = &#123;ram_wdata, ram_wdata&#125;;    assign ram_rdata = (ram_addr[0] == 1&#x27;b0 &amp;&amp; ram_addr[15:14] == 0) ? ram_32_rdata[15:0] :                       (ram_addr[0] == 1&#x27;b1 &amp;&amp; ram_addr[15:14] == 0) ? ram_32_rdata[31:16] :                       rv32_ctrl_out;    EF2_BRAM256 u_EF2_BRAM256(        .doa(ram_32_rdata),        .dia(ram_32_wdata),        .cea(ram_do &amp; ram_addr[15:14] == 0),        .clka(clk),        .wea(ram_wen),        .rsta(~rstn),        .addra(ram_addr[13:1]),        .weabyte(ram_byte_en),        .dob(mem_rdata),        .dib(mem_la_wdata),        .ceb(1&#x27;b1),        .clkb(clk),        .web(mem_la_write),        .rstb(~rstn),        .addrb(mem_la_addr[14:2]),        .webbyte(mem_la_wstrb)    );    always @(posedge clk) begin        if (~rstn) begin            mem_ready &lt;= 1&#x27;b0;        end else begin            mem_ready &lt;= 1&#x27;b1;        end    endendmodule\n\næ¨¡å—å†…ä¾‹åŒ–äº†ä¸¤ä¸ªæ¨¡å—ï¼Œåˆ†åˆ«æ˜¯rv32å†…æ ¸æ¨¡å—å’ŒBRAMæ¨¡å—ã€‚picorv32æ¨¡å—é€šè¿‡ä¸€ä¸ªç®€å•çš„å†…å­˜é¢„å–æ¥å£å°†å…¶è¿æ¥åˆ°32kå­—èŠ‚çš„å†…å­˜å—ã€‚picorv32_ctrlæä¾›çš„æ•´ä¸ªåœ°å€ç©ºé—´ï¼Œå‰é¢32kbç›´è¿BRAMå†…å­˜å—ï¼Œåé¢32kbè¿æ¥å†…éƒ¨å®ç°çš„å¯„å­˜å™¨ï¼Œç›®å‰å¯„å­˜å™¨åªæœ‰ä¸€ä¸ªï¼Œç”¨äºæ§åˆ¶rv32å†…æ ¸çš„å¤ä½çŠ¶æ€æ¥æ§åˆ¶å†…æ ¸çš„è¿è¡Œã€‚\nBRAMçš„å†…å­˜å®½åº¦æ˜¯32bitï¼Œå‰é¢FMCçš„å†…å­˜å®½åº¦æ˜¯16bitï¼Œæ‰€æœ‰è¿™é‡Œåšäº†ä¸€ä¸ªå·§å¦™çš„å¤„ç†ï¼Œé€šè¿‡åœ°å€ä½ä½æ¥é€‰æ‹©è¾“å…¥è¾“å‡ºæ•°æ®çš„é«˜ä½è¿˜æ˜¯ä½ä½ã€‚\npicorv32é»˜è®¤æ²¡æœ‰å¼€å¯æŒ‡ä»¤å‹ç¼©å’Œä¹˜æ³•æ‰©å±•ï¼Œè¿™é‡Œé€šè¿‡COMPRESSED_ISAæ‰‹åŠ¨æ‰“å¼€æŒ‡ä»¤å‹ç¼©ã€‚ä¸ºäº†èŠ‚çœä¸€ç‚¹LUTèµ„æºå°±ä¸å¼€ä¹˜æ³•æ‰©å±•äº†ã€‚åœ¨é€šè¿‡riscv-gccç¼–è¯‘ç¨‹åºæ—¶çš„æ¶æ„é€‰å‹åº”ä¸º-march&#x3D;rv32icã€‚\nï¼ˆä¸‰ï¼‰FMCå¼‚æ­¥æ¥å£è¿™ä¸ªæ¥å£ä»£ç åº”è¯¥æ˜¯ä¸å¤æ‚çš„ï¼Œä½†æˆ‘å‘ç°æˆ‘å†™çš„ä»£ç çœ‹ç€å¾ˆåˆ«æ‰­ï¼Œä»£ç è´¨é‡ä¸é«˜ï¼Œæ‰€ä»¥å°±ä¸å±•ç¤ºäº†ã€‚ğŸ˜‚ğŸ˜‚ğŸ˜‚\nå››ã€è½¯ä»¶ç”Ÿæ€æ„å»ºï¼šä»ç¼–è¯‘é“¾åˆ°æ§åˆ¶ç¨‹åºï¼ˆä¸€ï¼‰RISC-V æµ‹è¯•ç¨‹åºå¼€å‘é‡‡ç”¨ MounRiver Studio å¼€å‘å·¥å…·ä¸­é›†æˆçš„ RISC-V å·¥å…·é“¾ï¼Œç¼–å†™åŒ…å«è§£å¯†åŠŸèƒ½çš„æµ‹è¯•ç¨‹åºï¼š\nå¯åŠ¨æ±‡ç¼–ï¼ˆstart.Sï¼‰ï¼šåˆå§‹åŒ–æ ˆæŒ‡é’ˆåˆ° 1KB åœ°å€å¤„ï¼Œå»ºç«‹ç¨‹åºè¿è¡Œçš„åŸºæœ¬ç¯å¢ƒï¼š\n.section .init.global mainlui sp, %hi(0x00001000)       // åŠ è½½æ ˆåŸºå€é«˜12ä½addi sp, sp, %lo(0x00001000)  // ç”Ÿæˆå®Œæ•´32ä½åœ°å€jal ra, main                  // è°ƒç”¨Cä¸»å‡½æ•°ebreak                        // ç¨‹åºç»“æŸ\n\nC è¯­è¨€é€»è¾‘ï¼šå®ç° ROT13 è§£å¯†ç®—æ³•ï¼Œå°†æ··æ·†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯è¯»ä¿¡æ¯ï¼š\nvolatile char *pmem = (void*)0x1000;     // å®šä¹‰è¾“å‡ºç¼“å†²åŒºvoid putc(char c)&#123;    *pmem++ = c;&#125;void puts(const char *s)&#123;    volatile int j;    while (*s)    &#123;        putc(*s++);    &#125;&#125;void *memcpy(void *dest, const void *src, int n)&#123;\twhile (n) \t&#123;\t\tn--;\t\t((char*)dest)[n] = ((char*)src)[n];\t&#125;\treturn dest;&#125;void main()&#123;    // å¾…è§£å¯†çš„å­—ç¬¦ä¸²    char message[] = &quot;$Uryyb+Jbeyq!+Vs+lbh+pna+ernq+guvf+zrffntr+gura$gur+CvpbEI32+PCH&quot;            &quot;+frrzf+gb+or+jbexvat+whfg+svar.$$++++++++++++++++GRFG+CNFFRQ!$$&quot;;    // ROT13è§£å¯†é€»è¾‘    for (int i = 0; message[i]; i++)        switch (message[i])        &#123;        case &#x27;a&#x27; ... &#x27;m&#x27;:        case &#x27;A&#x27; ... &#x27;M&#x27;:            message[i] += 13;            break;        case &#x27;n&#x27; ... &#x27;z&#x27;:        case &#x27;N&#x27; ... &#x27;Z&#x27;:            message[i] -= 13;            break;        case &#x27;$&#x27;:            message[i] = &#x27;\\n&#x27;;            break;        case &#x27;+&#x27;:            message[i] = &#x27; &#x27;;            break;        &#125;    // è¾“å‡ºè§£å¯†åçš„æ•°æ®    puts(message);    while(1);&#125;\n\nå†…å­˜é“¾æ¥è„šæœ¬ï¼ˆfirmware.ldsï¼‰ï¼šå®šä¹‰ 32KB ç»Ÿä¸€ç¼–å€ç©ºé—´ï¼Œæ•´åˆä»£ç ä¸æ•°æ®ï¼š\nMEMORY &#123;    mem : ORIGIN = 0x00000000, LENGTH = 0x8000&#125;SECTIONS &#123;    .memory : &#123;        . = 0x000000;        start*(.text);        *(.init);        *(.text);        *(*);        end = .;        . = ALIGN(4);    &#125; &gt; mem&#125;\n\nï¼ˆäºŒï¼‰STM32 æ§åˆ¶ç¨‹åºå®ç°é€šè¿‡ FMC æ€»çº¿å®ç°å›ºä»¶åŠ è½½ä¸çŠ¶æ€æ§åˆ¶ï¼š\n#include &lt;stdio.h&gt;#include &quot;incfile.h&quot;INCFILE(fw, &quot;main.bin&quot;);    // åµŒå…¥äºŒè¿›åˆ¶å›ºä»¶int main(void)&#123;  /* MCU Configuration--------------------------------------------------------*/  MPU_Region_InitTypeDef MPU_InitStruct = &#123;0&#125;;  /* Disables the MPU */  HAL_MPU_Disable();  /* Configure the MPU attributes for the FMC */  MPU_InitStruct.Enable           = MPU_REGION_ENABLE;  MPU_InitStruct.Number           = MPU_REGION_NUMBER0;  MPU_InitStruct.BaseAddress      = 0x60000000;  MPU_InitStruct.Size             = MPU_REGION_SIZE_256MB;  MPU_InitStruct.AccessPermission = MPU_REGION_FULL_ACCESS;  MPU_InitStruct.IsBufferable     = MPU_ACCESS_NOT_BUFFERABLE;  MPU_InitStruct.IsCacheable      = MPU_ACCESS_NOT_CACHEABLE;  MPU_InitStruct.IsShareable      = MPU_ACCESS_NOT_SHAREABLE;  MPU_InitStruct.DisableExec      = MPU_INSTRUCTION_ACCESS_DISABLE;  MPU_InitStruct.TypeExtField     = MPU_TEX_LEVEL0;  MPU_InitStruct.SubRegionDisable = 0x00;  HAL_MPU_ConfigRegion(&amp;MPU_InitStruct);  HAL_MPU_Enable(MPU_PRIVILEGED_DEFAULT);  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */  HAL_Init();  /* Configure the system clock */  SystemClock_Config();  /* Initialize all configured peripherals */  MX_GPIO_Init();  MX_FMC_Init();        // åˆå§‹åŒ–FMCæ€»çº¿  MX_USART1_UART_Init();// åˆå§‹åŒ–è¾“å‡ºä¸²å£#define SRAM_ADDR (0x60000000)  HAL_Delay(1000);      // ç­‰å¾…FPGAç¨‹åºä¸Šç”µå¤ä½å®Œæˆ  uint16_t *addr = (void*)SRAM_ADDR;  // æµ‹è¯•FMCå†…å­˜è¯»å†™  for(int i = 0; i &lt; 1024; i++)&#123;      addr[i] = i;  &#125;  for(int i = 0; i &lt; 1024; i++)&#123;      if(addr[i] != i)&#123;          printf(&quot;sram error %d %d\\r\\n&quot;, i, addr[i]);          break;      &#125;  &#125;  printf(&quot;sram check complate\\r\\n&quot;);  // åŠ è½½å›ºä»¶åˆ°FPGA  const uint16_t *fw = FILEPTR(fw);  int fw_size = FILESIZE(fw);  for(int i = 0; i &lt; fw_size/2+1; i++)&#123;      addr[i] = fw[i];  &#125;  printf(&quot;firmware load complate\\r\\n&quot;);  // æ§åˆ¶RISC-Vè¿è¡Œ  uint16_t *run_enable = (uint16_t*)(0x60000000 + (0x4001 &lt;&lt; 1));  *run_enable = 1; // å†™å…¥1å¯åŠ¨è½¯æ ¸  HAL_Delay(1000);  *run_enable = 0; // å†™å…¥0æš‚åœè½¯æ ¸  // è¯»å–å¹¶æ˜¾ç¤ºç»“æœ  const uint16_t *msg = (uint16_t*)(0x60000000 + (0x1000));  uint16_t buf[64];  for(int i = 0; i &lt; 64; i++)&#123;      buf[i] = msg[i];  &#125;  const char *msg_str = (void*)buf;  printf(&quot;\\r\\n%s\\r\\n&quot;, msg_str);  while (1)  &#123;      HAL_Delay(500);      printf(&quot;hello world\\r\\n&quot;);  &#125;&#125;\n\nç¨‹åºé€šè¿‡å†…å­˜æ˜ å°„æ–¹å¼å°† FPGA çš„ ERAM è§†ä¸º STM32 çš„å¤–éƒ¨ SRAMï¼Œç›´æ¥é€šè¿‡æŒ‡é’ˆæ“ä½œå®ç°æ•°æ®äº¤äº’ã€‚æ§åˆ¶å¯„å­˜å™¨ï¼ˆ0x4001ï¼‰çš„å•ä¸ª bit å³å¯å¯åŠ¨ &#x2F; åœæ­¢ RISC-V æ ¸ï¼Œä½“ç°äº†å†…å­˜æ˜ å°„æ¥å£çš„ç®€æ´æ€§ã€‚\näº”ã€è°ƒè¯•è¿‡ç¨‹ä¸å…³é”®éªŒè¯ï¼ˆä¸€ï¼‰æ—¶åºçº¦æŸè¦ç‚¹æ—¶é’Ÿé…ç½®ï¼šå¯¹ PLL ç”Ÿæˆçš„ 100MHz æ—¶é’Ÿè¿›è¡Œæ—¶åºçº¦æŸï¼Œç¡®ä¿æ—¶é’ŸæŠ–åŠ¨å°äº 500ps\nå¼‚æ­¥æ¥å£ï¼šåœ¨ FMC æ¨¡å—ä¸­ä½¿ç”¨å¯„å­˜å™¨æ‰“æ‹å¤„ç†å¼‚æ­¥ä¿¡å·ï¼Œé¿å…äºšç¨³æ€é—®é¢˜\nï¼ˆäºŒï¼‰æµ‹è¯•ç»“æœéªŒè¯å½“ STM32 å®Œæˆå›ºä»¶åŠ è½½å¹¶å¯åŠ¨ RISC-V æ ¸åï¼Œä¸²å£ç»ˆç«¯æ˜¾ç¤ºï¼š\nsram check complatefirmware load complateHello World! If you can read this message thenthe PicoRV32 CPU seems to be working just fine.                TEST PASSED!\n\nè¿™è¡¨æ˜ï¼š\n\nFMC æ€»çº¿é€šè®¯æ­£å¸¸ï¼Œæ•°æ®è¯»å†™æ— è¯¯\nRISC-V è½¯æ ¸æ­£ç¡®æ‰§è¡Œäº† ROT13 è§£å¯†ç®—æ³•\nåŒæ ¸å¿ƒç³»ç»Ÿçš„ååŒæ§åˆ¶æœºåˆ¶æœ‰æ•ˆ\n\nï¼ˆä¸‰ï¼‰å­¦ä¹ RISC-Væ±‡ç¼–æ‰€æœ‰éƒ½æ­£ç¡®æ‰§è¡Œåï¼Œå†å›è¿‡å¤´çœ‹çœ‹RISC-Væµ‹è¯•ç¨‹åºçš„åæ±‡ç¼–ä»£ç ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰å› ä¸ºç¼–è¯‘ä¼˜åŒ–è€Œå­˜åœ¨ç¨‹åºè¿è¡Œä½œå¼Šçš„æƒ…å†µã€‚\n00000000 &lt;init&gt;:   0:   00000137                lui     sp,0x0   4:   40010113                addi    sp,sp,1024 # 400 &lt;end+0x233&gt;   8:   0cc000ef                jal     ra,d4 &lt;main&gt;   c:   9002                    ebreak0000000e &lt;putc&gt;:   e:   15802783                lw      a5,344(zero) # 158 &lt;pmem&gt;  12:   00178693                addi    a3,a5,1  16:   14d02c23                sw      a3,344(zero) # 158 &lt;pmem&gt;  1a:   00a78023                sb      a0,0(a5)  1e:   8082                    ret...000000d4 &lt;main&gt;:  d4:   7175                    addi    sp,sp,-144  d6:   08000613                li      a2,128  da:   05400593                li      a1,84  de:   850a                    mv      a0,sp  e0:   c706                    sw      ra,140(sp)  e2:   3fa9                    jal     3c &lt;memcpy&gt;  e4:   870a                    mv      a4,sp  e6:   04d00593                li      a1,77...00000158 &lt;pmem&gt;: 158:   1000\n\nçœ‹çœ‹putcå‡½æ•°çš„è¡Œä¸ºï¼Œä»0x158åœ°å€å–å‡ºæ•°ä¿å­˜åˆ°a5å¯„å­˜å™¨ï¼Œa5å¯„å­˜å™¨åŠ 1åä¿å­˜åˆ°a3å¯„å­˜å™¨ï¼Œå†å°†a3å¯„å­˜å™¨çš„å€¼å†™å›åˆ°0x158åœ°å€å¤„ã€‚æœ€åå°†a0å¯„å­˜å™¨çš„å€¼å†™å…¥a5åœ°å€ä¸‹å®ç°æ•°æ®è¾“å‡ºã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°0x158åœ°å€ä¸‹çš„åˆå€¼å°±æ˜¯0x1000ï¼Œä¹Ÿå°±æ˜¯pmemå˜é‡çš„åˆå€¼ã€‚åŠŸèƒ½åŒCè¯­è¨€æè¿°çš„ä¸€è‡´ï¼ŒåŒæ—¶ä¹Ÿè¡¨æ˜ä»£ç å’Œæ•°æ®ä¸ºç»Ÿä¸€ç¼–å€ï¼Œæ²¡æœ‰åŒºåˆ†RAMå’ŒROMã€‚å¦‚æœè¦åŒºåˆ†ROMå’ŒRAMï¼Œéœ€è¦æ·»åŠ ä¸€äº›å¯åŠ¨ä»£ç æ¥å¤„ç†dataæ®µæ•°æ®çš„æ‹·è´ã€‚\nå‰é¢RISC-Vçš„Cä»£ç ä¸­æœ‰ä¸€ä¸ªmemcpyå‡½æ•°ä¸çŸ¥é“ä½ æ³¨æ„åˆ°æ²¡æœ‰ï¼Œä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªå‡½æ•°å‘¢ï¼Ÿå¦‚æœå°†è¿™ä¸ªå‡½æ•°åˆ é™¤æ‰ï¼Œç¡®å®ä¼šå¯¼è‡´æ— æ³•ç¼–è¯‘é€šè¿‡ã€‚é€šè¿‡æ£€æŸ¥æ±‡ç¼–æ‰å‘ç°mainå‡½æ•°ç¡®å®ä¼šè°ƒç”¨memcpyï¼Œæ ¹æ®æ±‡ç¼–ä»£ç å’Œmapæ–‡ä»¶ï¼Œmainå‡½æ•°çš„é€»è¾‘æ˜¯åŸé™æ€å­—ç¬¦ä¸²å­˜å‚¨åœ¨rodataåŒºï¼Œç„¶ååœ¨æ ˆä¸Šåˆ†é…äº†ä¸€æ®µå†…å­˜æ¥ä¿å­˜messageæ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦memcpyæ¥å¤„ç†ä¸€å¤§æ®µå†…å­˜çš„æ‹·è´ã€‚è¿™ä¹Ÿæ˜¯åŒARMæ±‡ç¼–ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œå­¦çš„æ–°çŸ¥è¯†äº†ğŸ˜„\nï¼ˆå››ï¼‰è§‚å¯ŸRISC-Vçš„è¿è¡Œé€šè¿‡FPGAå¼€å‘å·¥å…·æä¾›çš„èŠ¯ç‰‡è°ƒè¯•å·¥å…·ï¼Œå¯ä»¥å»æ•è·è§‚æµ‹FPGAè¿è¡Œè¿‡ç¨‹ä¸­å¯„å­˜å™¨çš„å€¼ã€‚é€šè¿‡è§‚æµ‹reg_pcå’Œmem_rdataï¼Œæ›´åŠ ç›´è§‚çš„çœ‹åˆ°RISC-Vçš„è¿è¡Œè¿‡ç¨‹å’Œå†…å­˜å–å€¼çš„è¿‡ç¨‹ã€‚å‘ç°æ¯ä¸ªæŒ‡ä»¤æ‰§è¡Œçš„å‘¨æœŸä¸º1~7ä¸ªæ—¶é’Ÿå‘¨æœŸä¸ç­‰ã€‚jalè·³è½¬æŒ‡ä»¤æ‰§è¡Œæœ€å¿«ï¼Œä»…éœ€1ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚å†…å­˜è¯»å†™æŒ‡ä»¤(sw)ã€æ¡ä»¶è·³è½¬(bnez)ã€åŠ æ³•(addi)æŒ‡ä»¤ç­‰éœ€è¦5ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚\nå…­ã€æ€»ç»“å›é¡¾å¼€å‘è¿‡ç¨‹ï¼Œå­¦ä¼šäº†Verilogæ¨¡å—åŒ–è®¾è®¡çš„åŸºæœ¬æ–¹æ³•ï¼Œå°¤å…¶æ˜¯å†…å­˜æ¥å£çš„åº”ç”¨ã€‚æ­¤å¤–è¿˜å¢å¼ºäº†å¯¹RISC-Vçš„äº†è§£ï¼Œå®ç°äº†ä»æºç ã€å·¥å…·é“¾å†åˆ°ç¡¬ä»¶æ‰§è¡Œçš„å®Œæ•´æµç¨‹ã€‚\nå›å¿†èµ·æˆ‘åˆšæ¯•ä¸šå‚åŠ å·¥ä½œï¼Œé‚£æ—¶å…¬å¸ç ”å‘çš„é¡¹ç›®åŸºæœ¬ä¸Šå…¨é‡‡ç”¨ARM+FPGAçš„å¼€å‘å½¢å¼ï¼ŒARMä¾§åšçº¯ç²¹çš„è½¯ä»¶åº”ç”¨é€»è¾‘ï¼ŒFPGAæ§åˆ¶åº•å±‚çš„ç¡¬ä»¶ã€‚ARMå’ŒFPGAé‡‡ç”¨FMCæ¥å£è¿›è¡Œé€šè®¯ï¼Œé€šè¿‡å†…å­˜æ˜ å°„çš„æ–¹å¼ä¼ è¾“æ•°æ®ï¼Œè¿™æ ·ARMå¯ä»¥å¾ˆæ–¹ä¾¿çš„å’ŒFPGAè¿›è¡Œé€šè®¯ã€‚å½“å¹´ç”±äºèƒ½åŠ›æœ‰é™ï¼Œæˆ‘å¹¶æ²¡æœ‰å¤ªæ·±å…¥çš„å»äº†è§£è¿™å…¶ä¸­çš„é€šè®¯åŸç†ã€‚ä¸»è¦æ˜¯å½“æ—¶å¼€å‘ARMçš„å’Œå¼€å‘FPGAçš„æ˜¯ä¸¤æ‹¨äººï¼Œæˆ‘ä¸»è¦è´Ÿè´£ARMè½¯ä»¶çš„å¼€å‘ï¼Œå¹¶æ²¡æœ‰æœºä¼šæ¥è§¦åˆ°FPGAå¼€å‘ï¼Œåæ¥è§‰å¾—éå¸¸çš„é—æ†¾ã€‚\né€šè¿‡è¿™ä¸ªå°é¡¹ç›®çš„å¼€å‘ç»å†ä¹Ÿç®—æ˜¯å¼¥è¡¥äº†å½“å¹´æœªèƒ½æ·±å…¥å‚ä¸å¼€å‘çš„ä¸€äº›é—æ†¾ã€‚æœŸå¾…å°†é¡¹ç›®ä¸­å¾—åˆ°çš„ç»éªŒåº”ç”¨åˆ°å®é™…å·¥ä½œä¸­ï¼Œè¿›ä¸€æ­¥æ¢ç´¢FPGAåœ¨åµŒå…¥å¼é¢†åŸŸçš„åº”ç”¨ã€‚\n"},{"title":"åŠ å¯†ç®—æ³•åº“ä¹‹mbedtls","url":"/2025/08/01/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E5%BA%93%E4%B9%8Bmbedtls/","content":"ä¸€ç›´å¯¹å„ç§åŠ å¯†ç®—æ³•åº“éƒ½éå¸¸æ„Ÿå…´è¶£ï¼Œä¹‹å‰ç”¨wolfssllibåšè¿‡ä¸€äº›å…³äºRSAçš„éå¯¹ç§°åŠ å¯†çš„æµ‹è¯•ã€‚æœ€è¿‘åˆåœ¨åšhttpsç›¸å…³çš„å†…å®¹ï¼Œç”±äºwolfssllibçš„ç‰ˆæƒé—®é¢˜ï¼Œä¸æ–¹ä¾¿äºå•†ä¸šå¼€å‘ä½¿ç”¨ï¼Œæ‰€ä»¥å‡†å¤‡æ¢åˆ°mbedtlsè¿›è¡Œhttpsç›¸å…³çš„å¼€å‘ã€‚\nmbedtlsçš„ç§»æ¤å’Œä½¿ç”¨éƒ½æ¯”è¾ƒç®€å•ï¼Œå”¯ä¸€èµ°çš„å¼¯è·¯å°±æ˜¯åœ¨å®ç°åº•å±‚callocå‡½æ•°æ—¶å‡ºäº†ä¸€ç‚¹æ„å¤–ï¼Œæœ€å¼€å§‹æ²¡æ³¨æ„åˆ°ç”³è¯·çš„å†…å­˜éœ€è¦æ¸…é›¶ï¼Œå› ä¸ºæˆ‘ç”¨çš„æ˜¯mallocæ¥ç”³è¯·å†…å­˜ï¼Œå†…å­˜é»˜è®¤æ²¡æœ‰æ¸…é›¶ï¼Œå¯¼è‡´mbedtlsåœ¨è¿›è¡Œå¤§æ•°è¿ç®—æ—¶ç»å¸¸å¡æ­»æˆ–è€…å‡ºé”™ï¼Œè¿™ä¸ªé—®é¢˜æŠ˜è…¾äº†å¥½ä¹…ã€‚\nç”¨mbedtlsä½œä¸ºhttpsçš„tlså±‚ï¼Œé…ç½®åŸºæœ¬å¯ä»¥ç…§æ¬å®˜æ–¹çš„é»˜è®¤é…ç½®æ¨¡æ¿ï¼Œç„¶ååšä¸€äº›é’ˆå¯¹ç‰¹å®šå¹³å°çš„é€‚é…ï¼Œä¸»è¦æ˜¯å†…å­˜ã€æ—¶é—´ã€éšæœºæ•°ç”Ÿæˆå™¨è¿™æ–¹é¢çš„é€‚é…ã€‚\nè€ƒè™‘åˆ°åœ¨å•ç‰‡æœºç¯å¢ƒä¸æ–¹ä¾¿æ›´æ–°CAè¯ä¹¦ï¼Œæˆ‘é€‰æ‹©ä¸æ ¡éªŒæœåŠ¡å™¨è¯ä¹¦ã€‚è¿™æˆ–è®¸ä¼šå¯¼è‡´ä¸­é—´äººæ”»å‡»ï¼Œä½†æ˜¯åœ¨ä¸“ç”¨é€šè®¯ç½‘ç»œä¸­ï¼Œæˆ‘è®¤ä¸ºæ²¡æœ‰è¿™æ–¹é¢çš„é£é™©ã€‚\nå…³äºhttpsçš„ç»†èŠ‚ä¸æ˜¯æˆ‘ä»Šå¤©æƒ³è¯´çš„ï¼Œæˆ‘ä»Šå¤©æƒ³å¯¹æ¯”ä¸€ä¸‹wolfsslå’Œmbedtlsçš„RSAç®—æ³•å·®å¼‚ã€‚è™½ç„¶ç›®å‰ä¸»æµçš„æœåŠ¡å™¨çš„tlséƒ½åŸºæœ¬ä¸Šæ˜¯æ¤­åœ†æ›²çº¿åŠ å¯†ï¼Œä½†æ˜¯RSAä½œä¸ºä¸€ç§éå¸¸ç»å…¸çš„éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œä»ç„¶å€¼å¾—å­¦ä¹ ã€‚\nè¿™é‡Œå…ˆå¯¹æ¯”ä¸€ä¸‹wolfsslå’Œmbedtlsçš„RSAç®—æ³•åœ¨ARMå•ç‰‡æœº(STM32H7@480MHz)ä¸Šæ‰§è¡Œçš„æ•ˆæœï¼Œä»¥ç”Ÿæˆä¸€ä¸ª2048ä½çš„å¯†é’¥å¯¹æ¥è¿›è¡Œæµ‹è¯•ã€‚\n\n\n\nlib\nwolfssl\nmbedtls\nmbedtls(without MBEDTLS_HAVE_ASM)\n\n\n\næ‰§è¡Œæ—¶é—´(ç§’)\n25.7\n2.17\n15.8\n\n\nå †å†…å­˜ä½¿ç”¨(kb)\n17.2\n14.2\n14.2\n\n\næ˜¾ç„¶åœ¨å•ç‰‡æœºä¸Šmbedtlsçš„æ€§èƒ½è¦å¥½å¾—å¤šï¼Œæˆ‘è®¤ä¸ºå…¶ä¸­æœ€å…³é”®çš„åº”è¯¥æ˜¯mbedtlsé’ˆå¯¹ç‰¹å®šå¤„ç†å™¨æ¶æ„æ‰€åšçš„ä¼˜åŒ–ï¼Œè¿™äº›ä¼˜åŒ–åœ¨å¤§æ•´æ•°è®¡ç®—æ€§èƒ½æ–¹é¢æœ‰éå¸¸å¤§çš„æå‡ã€‚\né€šè¿‡å¯¹è¿è¡Œæ—¶heapåŒºçš„æ•°æ®è¿›è¡Œåˆ†æï¼Œwolfsslæ€§èƒ½åä½çš„åŸå› ä¸»è¦æ˜¯åœ¨è¿›è¡Œå¤§æ•´æ•°è®¡ç®—æ—¶é¢‘ç¹çš„å†…å­˜åˆ†é…å¯¼è‡´çš„ã€‚wolfsslåœ¨ç”Ÿæˆ2048é•¿åº¦å¯†é’¥æ—¶ï¼Œå†…å­˜åˆ†é…æ¬¡æ•°è¾¾åˆ°äº†20ä¸‡æ¬¡ä»¥ä¸Šï¼Œè€Œmbedtlsç”Ÿæˆç›¸åŒçš„å¯†é’¥æ•°æ®æ—¶å†…å­˜åˆ†é…åªæœ‰å‡ åƒæ¬¡ã€‚\nwolfsslä¹Ÿä¸æ˜¯å®Œå…¨æ²¡æœ‰ä¼˜ç‚¹ï¼Œé€šè¿‡å¯¹ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œåˆ†æï¼Œmbedtlsç›¸å…³å‡½æ•°æ‰€ä½¿ç”¨çš„æ ˆç©ºé—´è¦æ›´å¤šä¸€äº›ï¼Œæ€»è°ƒç”¨æ ˆæ·±åº¦è¾¾åˆ°äº†3kbå­—èŠ‚ï¼Œè€Œwolfsslçš„æ ˆè°ƒç”¨æ·±åº¦åœ¨1kbä»¥å†…ã€‚\näº†è§£RSAç®—æ³•çš„å¼€å‘è€…åº”è¯¥éƒ½çŸ¥é“ï¼ŒRSAå¯†é’¥ç”Ÿæˆä¸­æœ€å…³é”®çš„ç®—æ³•å°±æ˜¯å¤§è´¨æ•°ç”Ÿæˆç®—æ³•ï¼Œè¿™åº”è¯¥æ˜¯å†³å®šä¸¤è€…æ€§èƒ½å…³é”®çš„ç®—æ³•ã€‚\né€šè¿‡åˆ†æä»£ç æ¥çœ‹ï¼Œä¸¤è€…çš„å®ç°éƒ½åŸºæœ¬ä¸Šå·®ä¸å¤šã€‚é¦–å…ˆåˆ©ç”¨éšæœºæ•°ç”Ÿæˆå™¨ç”Ÿæˆä¸€ä¸ª2047ä½çš„éšæœºæ•°ï¼Œç„¶ååˆ¤æ–­è¿™ä¸ªæ ‘æ˜¯ä¸æ˜¯è´¨æ•°ï¼Œå¦‚æœä¸æ˜¯è´¨æ•°åˆ™é‡æ–°ç”Ÿæˆä¸€ä¸ªï¼Œç›´åˆ°ç”Ÿæˆäº†ä¸€ä¸ªå¯ä»¥ç”¨çš„è´¨æ•°ã€‚\næ ¹æ®ç´ æ•°å®šç†æ¥çœ‹ï¼Œåœ¨è¿™ç§é•¿åº¦çº§åˆ«çš„æ•´æ•°é™„è¿‘ï¼Œç´ æ•°çš„å¯†åº¦åœ¨åƒåˆ†ä¹‹ä¸€å·¦å³ã€‚æ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªéœ€è¦åå¤è¯•é”™çš„ç®—æ³•ï¼Œè¿™æ˜¯æ— æ³•é¿å…çš„ã€‚\næ‰€ä»¥ä¸ºäº†æå‡æ•ˆç‡ï¼Œç´ æ•°çš„åˆ¤å®šä¸Šå°±å¿…é¡»è¦å°½å¯èƒ½çš„ä¼˜åŒ–ã€‚mbedtlsæ„é€ äº†1000ä»¥å†…çš„è´¨å› æ•°ç”¨æ¥å¿«é€ŸéªŒç®—å¾…åˆ¤å®šçš„æ ‘æ˜¯å¦å­˜åœ¨ä¸€äº›å°çš„å› æ•°ï¼Œç„¶åå†ä½¿ç”¨Miller-Rabinç®—æ³•è¿›è¡Œç´ æ€§æµ‹è¯•ã€‚wolfsslåœ¨æ“ä½œä¸Šç±»ä¼¼ï¼Œä¸è¿‡å®ƒçš„ç´ å› æ•°è¡¨è¦ç¨å¾®å¤§ä¸€äº›ï¼Œæœ€å¤§çš„ç´ æ•°æ˜¯1619ã€‚æ­¤å¤–ï¼Œåœ¨éªŒç®—ä¸¤ä¸ªå¤§è´¨æ•°çš„è·ç¦»æ—¶ï¼Œä¸¤ä¸ªåº“ä¹Ÿå­˜åœ¨åŒºåˆ«ï¼Œmbedtlså…ˆç”Ÿæˆä¸¤ä¸ªå¤§è´¨æ•°På’ŒQï¼Œå†è®¡ç®—å®ƒä»¬çš„è·ç¦»ï¼Œå¦‚æœè·ç¦»å¤ªè¿‘çš„åŒ–å°±é‡æ–°ç”ŸæˆPå’ŒQã€‚è€Œwolfsslåœ¨æ ¡éªŒç¬¬äºŒä¸ªè´¨æ•°Qçš„ç´ æ€§å‰å…ˆè¿›è¡Œäº†è·ç¦»è®¡ç®—ï¼Œè¿™æ ·æ•ˆç‡åº”è¯¥å¿«ä¸€äº›ï¼Œä¸”å½“è·ç¦»ä¸æ»¡è¶³è¦æ±‚æ—¶åªéœ€è¦é‡æ–°ç”ŸæˆQå³å¯ã€‚çœ‹èµ·æ¥åœ¨è¿™äº›ç»†èŠ‚æ–¹é¢wolfsslçš„ç­–ç•¥è¦æ›´å¥½ä¸€äº›ï¼Œä¸è¿‡å®ƒçš„ä»£ç çœ‹èµ·æ¥ä¹Ÿè¦å¤æ‚è®¸å¤šã€‚\nåœ¨ç§»æ¤è¿™ä¸¤ä¸ªç®—æ³•åº“ä¹‹ä½™ï¼Œè¿˜å­¦ä¹ æ¤­åœ†æ›²çº¿åŠ å¯†ç›¸å…³çš„å†…å®¹ã€‚RSAå¯†é’¥ç”Ÿæˆè¿‡ç¨‹ä¸­ç”±äºéœ€è¦ä¸æ–­è¯•é”™æ¥å¯»æ‰¾å¤§è´¨æ•°ï¼Œæ‰€ä»¥åœ¨åµŒå…¥å¼ç³»ç»Ÿä¸­çœ‹èµ·æ¥å®ƒçš„æ€§èƒ½å°±ä¸æ˜¯å¾ˆç¨³å®šã€‚è€Œæ¤­åœ†æ›²çº¿åŠ å¯†åœ¨è¿™æ–¹é¢å°±è¦å¥½å¾—å¤šï¼Œæ¤­åœ†æ›²çº¿çš„å¯†é’¥ç”Ÿæˆä¸ä¾èµ–å¤§è´¨æ•°ç”Ÿæˆï¼Œæ— è®ºæ˜¯è®¡ç®—é‡è¿˜æ˜¯ç¨³å®šæ€§éƒ½è¦å¥½å¾—å¤šã€‚æ¤­åœ†æ›²çº¿ä¾é æ¤­åœ†æ›²çº¿ä¸Šçš„ç¦»æ•£å¯¹æ•°é—®é¢˜çš„å¤æ‚æ€§æ¥ä¿è¯å®‰å…¨ï¼Œè€ŒRSAä¾é å¤§æ•°åˆ†è§£éš¾é¢˜æ¥ä¿è¯å®‰å…¨æ€§ï¼Œåœ¨å®‰å…¨æ€§ä¸Šé¢æ¤­åœ†æ›²çº¿ä¹Ÿåº”è¯¥è¦æ›´å¥½ã€‚\n"},{"title":"å†…å­˜é™·é˜±ï¼Œä¸€ç§å†…å­˜è°ƒè¯•æ–¹æ³•","url":"/2022/07/25/%E5%86%85%E5%AD%98%E9%99%B7%E9%98%B1%EF%BC%8C%E4%B8%80%E7%A7%8D%E5%86%85%E5%AD%98%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95/","content":"éœ€æ±‚åœºæ™¯åœ¨ä¸€ä¸ªå¤šä»»åŠ¡ç³»ç»Ÿä¸­ï¼Œå½“ä¸€ä¸ªå…¨å±€å¯è®¿é—®çš„æ•°æ®å‡ºç°äº†å¼‚å¸¸ï¼Œå¦‚ä½•æ’æŸ¥é—®é¢˜å‘¢ï¼Ÿç”±äºåœ¨å¤šä»»åŠ¡ç¯å¢ƒä¸­ï¼Œå„ä¸ªä»»åŠ¡å¹¶è¡Œè¿è¡Œï¼Œä¸€èˆ¬çš„å•æ­¥è·Ÿè¸ªè°ƒè¯•å¾ˆéš¾å®šä½é—®é¢˜ã€‚é€ä¸ªå±è”½ä»£ç åˆå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜æ— æ³•å¤ç°ã€‚ä½¿ç”¨å†…å­˜æ–­ç‚¹æ˜¯æ¯”è¾ƒå¥½çš„æ–¹æ³•ï¼Œä½†æ˜¯å¤§å¤šæ•°é›†æˆå¼€å‘ç¯å¢ƒå¯¹è¯¥åŠŸèƒ½çš„æ”¯æŒä¸å®Œç¾ï¼Œä¸”ä½¿ç”¨åœºæ™¯æœ‰é™ã€‚\nä¸‹é¢å¼•å…¥ä¸€ä¸ªé—®é¢˜ä»£ç åœºæ™¯ï¼Œåˆ†æè¯¥é—®é¢˜çš„æ’æŸ¥æ–¹æ³•ã€‚\nuint32_t *p;void task_A(void)&#123;    p = (uint32_t *)0x2000;    enable_isr_a();    while(1)&#123;        printf(&quot;freq :%u\\n&quot;, *p);        *p = 0;        delay(1000);    &#125;&#125;void isr_a(void)&#123;    *p = *p + 1;&#125;void task_B(void)&#123;    // ...    uint8_t *a = 0x2000;    *a = 100;&#125;\n\nåœ¨è¿™æ®µç¨‹åºä¸­ä»»åŠ¡Aåˆ†é…äº†ä¸€æ®µå†…å­˜ç©ºé—´ï¼Œå¹¶æ‰“å¼€äº†ä¸€ä¸ªå¤–éƒ¨ä¸­æ–­ï¼Œä»»åŠ¡Aç»Ÿè®¡ä¸­æ–­å‘ç”Ÿçš„æ¬¡æ•°ï¼Œæ¯ç§’è¾“å‡ºä¸€æ¬¡æ•°æ®å¹¶æ¸…é›¶ã€‚å¦‚æœæ­¤æ—¶å­˜åœ¨ä¸€ä¸ªä»»åŠ¡Bï¼Œç”±äºå…¶å®ƒæ•…éšœå¯¼è‡´å˜é‡è¢«åˆ†é…åˆ°äº†åŒä¸€æ®µå†…å­˜ä¸Šï¼Œæ˜¾ç„¶ä»»åŠ¡Aç»Ÿè®¡æ¬¡æ•°çš„å˜é‡å°±ä¼šå‡ºç°æ•°æ®å¼‚å¸¸çš„ç°è±¡ã€‚\nç”±äºåœ°å€0x2000ä¼šè¢«æ­£å¸¸çš„ä»»åŠ¡Aå’Œä¸­æ–­Aè®¿é—®ï¼ŒåŒæ—¶è¢«å¼‚å¸¸çš„ä»»åŠ¡Bè®¿é—®ã€‚é›†æˆå¼€å‘ç¯å¢ƒä¸­çš„å†…å­˜æ–­ç‚¹æ— æ³•æ­£å¸¸åŒºåˆ†æ­£å¸¸çš„è®¿é—®å’Œéæ³•çš„è®¿é—®ï¼Œè¿›è€Œå¯¼è‡´æ— æ³•å‡†ç¡®çš„è·Ÿè¸ªåˆ°é—®é¢˜ä»£ç ã€‚\né€‚æ—¶å¯ç”¨å†…å­˜æ–­ç‚¹å¦‚æœèƒ½å¤Ÿåœ¨ä»£ç ä¸­å®æ—¶çš„å¯ç”¨å’Œå…³é—­å†…å­˜æ–­ç‚¹ï¼Œçœ‹è¿™ä¸ªé—®é¢˜å°±èƒ½è§£å†³äº†ã€‚å¤§è‡´çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š\nuint32_t *p;void task_A(void)&#123;    p = (uint32_t *)0x2000;    enable_isr_a();    while(1)&#123;        disable_mem_break(0x2000);        printf(&quot;freq :%u\\n&quot;, *p);        *p = 0;        enable_mem_break(0x2000);        delay(1000);    &#125;&#125;void isr_a(void)&#123;    disable_mem_break(0x2000);    *p = *p + 1;    enable_mem_break(0x2000);&#125;void task_B(void)&#123;    // ...    uint8_t *a = 0x2000;    *a = 100;&#125;\nå½“æ­£å¸¸è®¿é—®æ•°æ®æ—¶å°±å…ˆæŠŠå†…å­˜æ–­ç‚¹å…³é—­ï¼Œå½“æ•°æ®æ­£å¸¸è®¿é—®å®Œæˆåå†å¼€ï¼Œè¿™æ ·çº¿ç¨‹Béæ³•è®¿é—®æ•°æ®æ—¶å°±ä¼šè¢«å†…å­˜æ–­ç‚¹æ•è·ã€‚è¿™æ ·åœ¨ä»£ç ä¸­é€‚æ—¶æ·»åŠ ã€åˆ é™¤æ–­ç‚¹çš„è¡Œä¸ºæ˜¯å¯è¡Œçš„ã€‚\nå†…å­˜æ–­ç‚¹çš„åŸç†ARM Cortex-M3ä»¥ä¸Šçš„å†…æ ¸éƒ½å…·æœ‰CoreDebugå’ŒDWTå†…æ ¸å¤–è®¾æ¨¡å—ï¼Œå®ƒä»¬çš„ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯å®ç°å†…å­˜æ–­ç‚¹æœºåˆ¶ï¼Œé€šè¿‡åœ¨DWTçš„ç›‘è§†è¡¨ä¸Šè®°å½•éœ€è¦ç›‘è§†çš„å†…å­˜åœ°å€ï¼Œç›‘è§†çš„æ–¹å¼(è¯»ã€å†™)ç­‰å‚æ•°ï¼Œå½“æ»¡è¶³æ¡ä»¶æ—¶å°±ä¼šè§¦å‘DebugMon_Handlerå¼‚å¸¸ä¸­æ–­ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¾ç„¶æ˜¯ä»£ç å¯æ§åˆ¶çš„ã€‚\ntypedef struct&#123;  __IOM uint32_t CTRL;      __IOM uint32_t CYCCNT;    __IOM uint32_t CPICNT;    __IOM uint32_t EXCCNT;    __IOM uint32_t SLEEPCNT;  __IOM uint32_t LSUCNT;    __IOM uint32_t FOLDCNT;   __IM  uint32_t PCSR;      __IOM struct&#123;    uint32_t COMP;    uint32_t MASK;    uint32_t FUNCTION;    uint32_t RESERVED;  &#125; W[4];&#125; DWT_Type;\nä¸åŒçš„å¤„ç†å™¨å†…æ ¸æ‰€å…·æœ‰çš„å†…å­˜æ–­ç‚¹æ•°é‡æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸€èˆ¬CM3ã€CM4ã€CM7åªæœ‰4ä¸ªï¼Œæ›´é«˜çº§çš„å†…æ ¸æ•°é‡ä¼šå¤šä¸€äº›ã€‚åŒæ—¶ç›‘è§†4ä¸ªåœ°å€ä¸‹çš„å†…å­˜èƒ½å¤Ÿæ»¡è¶³å¾ˆå¤šåˆ†æåœºæ™¯ã€‚æ‰“å¼€å†…å­˜ç›‘è§†åŠŸèƒ½éœ€è¦å†™å…¥COMPã€MASKã€FUNCTIONä¸‰ä¸ªå¯„å­˜å™¨ï¼Œå…¶ä¸­COMPå¯„å­˜å™¨å†™å…¥å¾…ç›‘è§†çš„åœ°å€ï¼ŒFUNCTIONè¡¨ç¤ºç›‘è§†çš„æ–¹å¼(5:read 6:write 7:read&amp;write 0è¡¨ç¤ºå…³é—­ç›‘è§†)ï¼ŒMASKè¡¨ç¤ºç›‘è§†çš„æ•°æ®ä½å®½(0:8ä½ 1:16ä½ 2:32ä½)ã€‚\næ­¤å¤–ï¼Œè¿˜éœ€è¦æ‰“å¼€DebugMon_Handlerå¼‚å¸¸ä¸­æ–­ï¼Œéœ€è¦å‘CoreDebugæ¨¡å—çš„DEMCRå¯„å­˜å™¨ç¬¬16ä½å’Œ24ä½å†™å…¥1ï¼Œç”¨æ¥æ‰“å¼€DebugMonå¼‚å¸¸ã€‚\nä»£ç mem_trap.h\n#ifndef _CPU_MEM_TRAP_H#define _CPU_MEM_TRAP_Htypedef enum &#123;    MEM_TRAP_DISABLE = 0,    MEM_READ_ONLY  = 5,    MEM_WRITE_ONLY = 6,    MEM_READ_WRITE = 7&#125; mem_trap_mode_t;typedef enum &#123;    MEM_8BIT,    MEM_16BIT,    MEM_32BIT&#125; mem_width_t;void mem0_watchpoint(void *addr, mem_trap_mode_t mode, mem_width_t width);void mem0_watchpoint_reset(void);void mem1_watchpoint(void *addr, mem_trap_mode_t mode, mem_width_t width);void mem1_watchpoint_reset(void);void mem2_watchpoint(void *addr, mem_trap_mode_t mode, mem_width_t width);void mem2_watchpoint_reset(void);void mem3_watchpoint(void *addr, mem_trap_mode_t mode, mem_width_t width);void mem3_watchpoint_reset(void);void mem_watchpoint_allreset(void);#endif\n\nmem_trap.c\n#include &quot;mem_trap.h&quot;#include &lt;stdio.h&gt;#if defined(DWT) &amp;&amp; defined(CoreDebug)/* Symbol conflict */#ifdef COMP1#undef COMP1#endif#ifdef COMP2#undef COMP2#endif#define DEF_MEM_WATCHPOINT(i) \\void mem##i##_watchpoint(void *addr, mem_trap_mode_t mode, mem_width_t width)&#123;\\    CoreDebug-&gt;DEMCR |= CoreDebug_DEMCR_TRCENA_Msk |\\                        CoreDebug_DEMCR_MON_EN_Msk;\\    DWT-&gt;FUNCTION##i = MEM_TRAP_DISABLE;\\    DWT-&gt;COMP##i = (uint32_t)addr;\\    DWT-&gt;MASK##i = (uint32_t)width;\\    DWT-&gt;FUNCTION##i = (uint32_t)mode;\\&#125;\\void mem##i##_watchpoint_reset(void)&#123;\\    DWT-&gt;FUNCTION##i = MEM_TRAP_DISABLE;\\&#125;void mem_watchpoint_allreset(void)&#123;    DWT-&gt;FUNCTION0 = MEM_TRAP_DISABLE;    DWT-&gt;FUNCTION1 = MEM_TRAP_DISABLE;    DWT-&gt;FUNCTION2 = MEM_TRAP_DISABLE;    DWT-&gt;FUNCTION3 = MEM_TRAP_DISABLE;&#125;DEF_MEM_WATCHPOINT(0)DEF_MEM_WATCHPOINT(1)DEF_MEM_WATCHPOINT(2)DEF_MEM_WATCHPOINT(3)__WEAK void mem_trap_log(int idx, uint32_t pc, uint32_t addr, const char *event)&#123;    printf(&quot;[%d]Trigger memory trap near by %#08x, %s at %#08x\\r\\n&quot;, \\        idx, (unsigned int)pc, event, (unsigned int)addr);&#125;void watchpoint_event_handle(uint32_t *args)&#123;    #define EVENT_PC (args[6])    const char* mem_event[4] = &#123;&quot;READ&quot;, &quot;WRITE&quot;, &quot;READ_WRITE&quot;, &quot;ERROR&quot;&#125;;    if((DWT-&gt;FUNCTION0 &amp; DWT_FUNCTION_MATCHED_Msk) != 0)&#123;        mem_trap_log(0, EVENT_PC, DWT-&gt;COMP0, mem_event[(DWT-&gt;FUNCTION0 - 5) &amp; 0x3]);    &#125;    if((DWT-&gt;FUNCTION1 &amp; DWT_FUNCTION_MATCHED_Msk) != 0)&#123;        mem_trap_log(1, EVENT_PC, DWT-&gt;COMP1, mem_event[(DWT-&gt;FUNCTION1 - 5) &amp; 0x3]);    &#125;    if((DWT-&gt;FUNCTION2 &amp; DWT_FUNCTION_MATCHED_Msk) != 0)&#123;        mem_trap_log(2, EVENT_PC, DWT-&gt;COMP2, mem_event[(DWT-&gt;FUNCTION2 - 5) &amp; 0x3]);    &#125;    if((DWT-&gt;FUNCTION3 &amp; DWT_FUNCTION_MATCHED_Msk) != 0)&#123;        mem_trap_log(3, EVENT_PC, DWT-&gt;COMP3, mem_event[(DWT-&gt;FUNCTION3 - 5) &amp; 0x3]);    &#125;&#125;#if defined(__CC_ARM)__asm void DebugMon_Handler(void)&#123;    extern watchpoint_event_handle        /* *INDENT-OFF* */    PRESERVE8    tst lr, #4    ite eq    mrseq r0, msp    mrsne r0, psp    push &#123;lr&#125;    bl watchpoint_event_handle    pop &#123;pc&#125;&#125;#elif defined(__GNUC__)void DebugMon_Handler(void)&#123;    __asm volatile    (        &quot;tst lr, #4                     \\n&quot;        &quot;ite eq                         \\n&quot;        &quot;mrseq r0, msp                  \\n&quot;        &quot;mrsne r0, psp                  \\n&quot;        &quot;push &#123;lr&#125;                      \\n&quot;        &quot;bl watchpoint_event_handle     \\n&quot;        &quot;pop &#123;pc&#125;                       \\n&quot;    );&#125;#endif#endif\næ³¨ï¼šè¿™é‡Œå¼•ç”¨äº†CMSISçš„å†…å®¹ï¼Œå¯ä»¥éœ€è¦inlcudeç›¸å…³çš„æ–‡ä»¶ã€‚\nDebugMonå¼‚å¸¸å¤„ç†å‡½æ•°ä½¿ç”¨æ±‡ç¼–å®ç°çš„åŸå› æ˜¯ä¸ºäº†åœ¨ä»£ç ä¸­è‡ªåŠ¨å®šä½åˆ°è§¦å‘å†…å­˜ç›‘è§†çš„PCæŒ‡é’ˆä½ç½®ï¼Œä¹Ÿå°±æ˜¯ä»£ç ä½ç½®ã€‚ä»£ç çš„ç”¨æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå½“éœ€è¦ä¿æŠ¤æŸå—ä»£ç ä¸­çš„æ•°æ®ä¸è¢«å¼‚å¸¸è®¿é—®ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨mem0_watchpoint_reset()å’Œmem0_watchpoint()å°†ä»£ç åŒ…èµ·æ¥ã€‚\nä»¥æœ€å¼€å§‹çš„é‚£æ®µä»£ç ä¸ºä¾‹ï¼š\nuint32_t *p;void task_A(void)&#123;    p = (uint32_t *)0x2000;    enable_isr_a();    while(1)&#123;        mem0_watchpoint_reset();        printf(&quot;freq :%u\\n&quot;, *p);        *p = 0;        mem0_watchpoint(p, MEM_READ_WRITE, MEM_32BIT);  // å¼€å¯ä¿æŠ¤        delay(1000);    &#125;&#125;void isr_a(void)&#123;    mem0_watchpoint_reset();    *p = *p + 1;    mem0_watchpoint(p, MEM_READ_WRITE, MEM_32BIT);&#125;void task_B(void)&#123;    // ...    uint8_t *a = 0x2000;    *a = 100;&#125;\nå½“ä»»åŠ¡Cè¿è¡Œæ—¶ç”±äºå†…å­˜ç›‘è§†å™¨çš„å­˜åœ¨ä¸”æ‰“å¼€äº†å¯¹é€‚å½“å†…å­˜çš„ä¿æŠ¤ï¼Œè®¿é—®0x2000åœ°å€æ—¶å°±ä¼šè§¦å‘DebugMonå¼‚å¸¸ï¼Œè¯¥å¼‚å¸¸å‡½æ•°èƒ½å¤Ÿè‡ªåŠ¨åˆ†æå‡ºä»»åŠ¡Bä¸­ä¿®æ”¹æ•°æ®æ—¶çš„PCæŒ‡é’ˆä½ç½®ã€‚\næ€»ç»“åœ¨ä»£ç ä¸­ä½¿ç”¨è¿™ç§å†…å­˜è·Ÿè¸ªæœºåˆ¶åœ¨è§£å†³æŸäº›å†…å­˜é—®é¢˜æ—¶æ˜¯å¾ˆæœ‰æ•ˆçš„ï¼Œå®ƒå¯¹æ­£å¸¸çš„æ•°æ®è®¿é—®æ²¡æœ‰ä»»ä½•å½±å“ï¼Œä½†æ˜¯åœ¨æ­£å¸¸çš„æ•°æ®è®¿é—®ä¹‹å¤–ï¼Œæˆ‘ä»¬åœ¨é‚£ä¸ªæ•°æ®ç‚¹ä¸ŠæŒ–äº†ä¸€ä¸ªé™·é˜±ï¼Œä»»ä½•å°è¯•è®¿é—®æ•°æ®çš„ä»£ç éƒ½ä¼šæ‰å…¥åˆ°è¿™ä¸ªé™·é˜±ä¸­å¹¶è¢«æˆ‘ä»¬æ•è·ï¼Œæ‰€æœ‰æˆ‘æŠŠè¿™ç§å†…å­˜è°ƒè¯•æ–¹æ³•æˆä¸ºå†…å­˜é™·é˜±ã€‚\nè¿™é‡Œå¯¹DWTçš„æœºåˆ¶ä»¥åŠå¯„å­˜å™¨åªæ˜¯ä¸€ä¸ªç®€å•çš„æè¿°ï¼Œå¦‚æœéœ€è¦äº†è§£å…¶ä¸­çš„ç»†èŠ‚è¯·æŸ¥é˜…ã€ŠARMv7-M Architecture Reference Manualã€‹ï¼Œé‡Œé¢æœ‰éå¸¸è¯¦ç»†çš„æè¿°ã€‚\n"},{"title":"å•ç‰‡æœºæ€»çº¿é€‰æ‹©ç„¦è™‘","url":"/2022/12/11/%E5%8D%95%E7%89%87%E6%9C%BA%E6%80%BB%E7%BA%BF%E9%80%89%E6%8B%A9%E7%84%A6%E8%99%91/","content":"\nå½“ä½ æœ‰å¤šä¸ªé€‰æ‹©ï¼Œä½†æ˜¯æ¯ä¸ªé€‰æ‹©éƒ½ä¸å®Œç¾æ—¶ï¼Œå°±ä¼šå‡ºç°é€‰æ‹©ç„¦è™‘ï¼\n\n\næœ€è¿‘åœ¨ä¼˜åŒ–å•ç‰‡æœºä¸ŠUSBåè®®æ ˆå†…çš„ä»£ç ï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªæˆ‘ä¹‹å‰æ²¡æœ‰è¢«æ³¨æ„åˆ°çš„åœ°æ–¹ï¼Œé‚£å°±æ˜¯å†™å…¥åˆ°USBç«¯ç‚¹ä¸Šçš„æ•°æ®æ˜¯ç”±DMAè‡ªåŠ¨å®Œæˆçš„ï¼Œæ¶‰åŠåˆ°DMAçš„å†…å­˜åŒºåŸŸéƒ½éœ€è¦ç‰¹åˆ«å¯¹å¾…ï¼Œè€Œæˆ‘ä¹‹å‰å°±æ˜¯å°†å®ƒå½“ä½œæ™®é€šå†…å­˜å¤„ç†ï¼Œä¹Ÿå°±æ˜¯æ™®é€šå†…å­˜çš„ç¼“å­˜ç­–ç•¥(åº†å¹¸è¿è¡Œäº†è¿™ä¹ˆä¹…å±…ç„¶æ²¡å‡ºé”™)ã€‚\nç”±äºå•ç‰‡æœºå†…çš„å†…å­˜åˆ†å¸ƒæ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥æˆ‘å†³å®šåœ¨è§£å†³è¿™ä¸ªé—®é¢˜æ—¶é¡ºä¾¿ä¼˜åŒ–ä¸€ä¸‹å†…å­˜å¸ƒå±€ã€‚è¿™æ˜¯å•ç‰‡æœºçš„æ€»çº¿è¿æ¥æƒ…å†µï¼Œçœ‹èµ·æ¥æ¯”è¾ƒå¤æ‚ã€‚\n\nä»”ç»†çœ‹çœ‹æ€»çº¿çš„è¿æ¥æƒ…å†µï¼Œå‘ç°ä¸€ä¸ªå¾ˆè ¢çš„äº‹æƒ…ï¼Œç›®å‰USBHS1(å¯ä»¥ç†è§£ä¸ºUSBçš„ä¸“ç”¨DMA)æ“ä½œçš„æ•°æ®ä½äºAXISRAMä¸Šï¼Œä¸­é—´è¦ç»è¿‡ä¸€ä¸ªD2-to-D1 AHB busçš„é€šé“ï¼Œæˆ‘è®¤ä¸ºè¿™å¤ªä¸åˆç†äº†ï¼Œå› ä¸ºD2åŸŸä¹Ÿæœ‰ä¸‰å—å†…å­˜ï¼Œæˆ‘å†³å®šå°†USBçš„ç¼“å­˜è°ƒæ•´åˆ°D2çš„SRAM3ä¸Šï¼Œæ¯•ç«ŸAXISRAMå†…å­˜ä¸CPUçš„äº¤äº’è¾ƒå¤šï¼Œè¿™æ ·USBçš„DMAä¼ è¾“æ•°æ®å°±å‡ ä¹èƒ½ç‹¬äº«åˆ°SRAM3çš„å†…å­˜æ€»çº¿å¸¦å®½äº†ï¼Œè€Œä¸ç”¨å ç”¨D1åŸŸçš„æ€»çº¿çŸ©é˜µã€‚è¿™æ ·è¿˜æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯ä½¿ç”¨MPUé…ç½®ç¼“å­˜ç­–ç•¥ä¹Ÿæ¯”è¾ƒæ–¹ä¾¿ã€‚\n\nä¸è¿‡æˆ‘æ”¹å®Œäº†ä¹‹åå°±å‘ç°äº†æ–°çš„é—®é¢˜ã€‚å› ä¸ºUSBåè®®æ ˆä¸­å®ç°äº†å¤§å®¹é‡å­˜å‚¨è®¾å¤‡å®ä¾‹ï¼Œéœ€è¦ç”¨åˆ°å†…å­˜å¡SDMMC1ï¼Œè¿™å°±å‡ºç°ä¸€ä¸ªæ–°çš„é—®é¢˜ã€‚SDå¡çš„æ•°æ®æ“ä½œä¹Ÿæ˜¯ä¸“ç”¨çš„DMAï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯SDMMC1ï¼Œç¡¬ä»¶å·²ç»å†³å®šäº†æˆ‘æ— æ³•è°ƒæ•´åˆ°SDMMC2ä¸Šã€‚è§‚å¯ŸD1æ€»çº¿çŸ©é˜µå°±èƒ½çœ‹åˆ°ï¼ŒSDMMC1æ— æ³•è®¿é—®åˆ°D2åŸŸä¸Šã€‚\n\nè¦è§£å†³è¿™ä¸ªé—®é¢˜å°±åªèƒ½è®©MDAMæˆ–è€…CPUå¸®å¿™ï¼ŒæŠŠæ•°æ®ä»D2åŸŸæ‹·è´åˆ°D1åŸŸçš„AXISRAMä¸­ï¼Œç„¶åSDMMCçš„DMAå°±èƒ½æ“ä½œæ•°æ®äº†ã€‚\nä¸ºäº†ä¼˜åŒ–æ•°æ®æ€»çº¿ä¸Šçš„è´Ÿè½½åè€Œå¸¦æ¥äº†æ›´å¤šçš„æ•°æ®æ€»çº¿æ“ä½œï¼Œè¿™å°±æ›´è ¢äº†ã€‚\nåœ¨è¿™é‡Œçº ç»“äº†å¥½ä¹…ï¼Œæœ€åé€‰æ‹©åœ¨AXISRAMæœ«å°¾ä½¿ç”¨çº¦8Kå­—èŠ‚çš„æ•°æ®ç”¨æ¥ä½œä¸ºUSBçš„ç¼“å­˜ï¼Œå¹¶å°†å®ƒé…ç½®ä¸ºéç¼“å­˜çš„æ¨¡å¼ã€‚\nè¿˜æ˜¯æ„Ÿè§‰ä¸çˆ½ğŸ˜”ï¼Œä¸ºä»€ä¹ˆD1åŸŸä¸Šçš„SDMMC1ä¸èƒ½è®¿é—®D2ï¼Œæ˜¯æ•…æ„è¿™æ ·è®¾è®¡çš„å—ï¼Ÿ\n"},{"title":"åœ¨8pinçš„èŠ¯ç‰‡ä¸Šè¿è¡ŒLinux","url":"/2025/09/18/%E5%9C%A88pin%E7%9A%84%E8%8A%AF%E7%89%87%E4%B8%8A%E8%BF%90%E8%A1%8CLinux/","content":"ä»Šå¹´æ—©äº›æ—¶å€™æˆ‘åœ¨Dmitry Grinbergçš„blogä¸Šçœ‹åˆ°ä¸€ä¸ªæœ‰è¶£çš„é¡¹ç›®ï¼Œä»–ç”¨3ä¸ª8pinçš„èŠ¯ç‰‡æ¥è¿è¡ŒLinuxã€‚è¿™ä¸ªé¡¹ç›®è®©æˆ‘è¿›ä¸€æ­¥ç†è§£ç°ä»£è®¡ç®—æœºçš„å·¥ä½œåŸç†ï¼Œæ‰€ä»¥æˆ‘å†³å®šè‡ªå·±å°è¯•å®ç°è¿™ä¸ªé¡¹ç›®ã€‚\nåŸé¡¹ç›®é€šè¿‡å¼•è„šæ—¶åºä¸Šçš„ä¸€äº›å¤ç”¨é€»è¾‘æ¥è®©8pinçš„STM32G031å¾—ä»¥åŒæ—¶é©±åŠ¨ä¸€ç‰‡PSRAMå’ŒSDå¡ï¼Œä½†æ˜¯è¿™ç§ç”¨æ³•çœ‹èµ·æ¥éå¸¸çš„éº»çƒ¦ï¼Œæˆ‘æƒ³æ‰¾ä¸€ç§æ›´ç®€å•çš„æ–¹æ³•æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚\nåæ¥æˆ‘æ¥è§¦åˆ°RV32IMAé¡¹ç›®ï¼Œè¯¥æ¨¡æ‹Ÿå™¨æ–¹æ¡ˆè§†ä¹è¦æ¯”uMIPSè¦æ›´ç®€å•ï¼Œå¯ä»¥è¿è¡Œæ›´ç®€å•çš„Linuxå›ºä»¶ï¼Œè¿™æ ·å°±å¯ä»¥ä¸ä½¿ç”¨SDå¡äº†ï¼Œé€šè¿‡ä¸€ç‰‡NorFlashæ¥å­˜æ”¾ä¸€ä¸ªç®€å•çš„Linuxå›ºä»¶ã€‚\nç°åœ¨æˆ‘çš„æƒ³æ³•å°±æ˜¯é€šè¿‡4ç‰‡8pinçš„èŠ¯ç‰‡æ¥è¿è¡ŒLinuxï¼Œåˆ†åˆ«æ˜¯STM32G031J6M6ï¼ŒAPS64064Lï¼ŒW25Q64JVï¼ŒCH340Nã€‚è¿™4ä¸ªèŠ¯ç‰‡çš„ç»„åˆå¯ä»¥æ„å»ºä¸€ä¸ªç›´æ¥æ’åœ¨ç”µè„‘USBæ¥å£ä¸Šè¿è¡Œçš„8pinçš„Linuxç³»ç»Ÿã€‚\nè®©æˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸‹å¦‚ä½•è¿æ¥4ä¸ªèŠ¯ç‰‡ã€‚è¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªéå¸¸å…·æœ‰æŒ‘æˆ˜æ€§çš„é—®é¢˜ã€‚\nå„ä¸ªéƒ¨ä»¶åº”è¯¥è¿™æ ·è¿æ¥èµ·æ¥ï¼ŒSTM32éœ€è¦ä¸²å£ä¸€å¯¹å¼•è„šï¼Œä¸€å¯¹ä¸‹è½½è°ƒè¯•å¼•è„šï¼ŒSPIçš„3ä¸ªå¼•è„šï¼Œä¸¤ä¸ªç‰‡é€‰ä¿¡å·å¼•è„šï¼Œè¿˜æœ‰STM32ä¾›ç”µçš„3ä¸ªå¼•è„šã€‚STM32éœ€è¦åˆ†é…11ä¸ªå¼•è„šï¼Œè¿™å·²ç»è¶…å‡ºäº†STM32G031çš„8ä¸ªå¼•è„šäº†ã€‚\n\næŸäº›å¼•è„šæˆ–è®¸å¯ä»¥åˆ†æ—¶å¤ç”¨æ¥è¾¾åˆ°éœ€æ±‚ã€‚é¦–å…ˆï¼Œä¸‹è½½è°ƒè¯•å¼•è„šåªæœ‰åœ¨èŠ¯ç‰‡å¯åŠ¨æ—¶éœ€è¦ï¼ŒèŠ¯ç‰‡æ­£å¸¸è¿è¡Œåå°±ä¸éœ€è¦äº†ï¼Œæ‰€ä»¥å¯ä»¥å¤ç”¨ä¸ºæ™®é€šå¼•è„šã€‚æ­¤å¤–NorFlashèŠ¯ç‰‡åœ¨ä¸Šç”µåå¯ä»¥å°†æ•°æ®æ‹·è´åˆ°APS6404LèŠ¯ç‰‡ä¸­ï¼Œè¿™æ ·ç³»ç»Ÿä¸²å£è¿˜æœªä½¿ç”¨æ—¶å°±å¯ä»¥ä½¿ç”¨NorFlashèŠ¯ç‰‡ï¼Œè¿™åˆèƒ½å¤ŸèŠ‚çº¦ä¸€ä¸ªç‰‡é€‰ä¿¡å·çº¿ã€‚è¿™æ ·å‡å°‘äº†3ä¸ªä¿¡å·çº¿æ­£å¥½æ»¡è¶³8pinèŠ¯ç‰‡çš„éœ€æ±‚ã€‚\nå“ªäº›ä¿¡å·å¤ç”¨æ˜¯ä¸€ä¸ªéœ€è¦å¥½å¥½è€ƒè™‘çš„é—®é¢˜ã€‚é¦–å…ˆè°ƒè¯•ä¿¡å·çº¿å›ºå®šä¸ºSTM32èŠ¯ç‰‡çš„7ã€8è„šï¼Œä¸”å®ƒèƒ½å¤Ÿä¸å…¶å®ƒä»»ä½•ä¿¡å·è¿›è¡Œåˆ†æ—¶å¤ç”¨ã€‚å¦‚æœSPIè¦ä½¿ç”¨ç¡¬ä»¶SPIçš„è¯ï¼Œ4ã€5ã€6å¼•è„šç›´æ¥åˆ†é…åˆ°SPIã€‚å‰©ä½™çš„2ã€3è„šä¸ºç”µæºå¼•è„šï¼Œæœ€åè¿˜å‰©ä¸‹1ã€7ã€8å¼•è„šï¼Œè¿™ä¸‰ä¸ªå¼•è„šåªæœ‰1è„šèƒ½å¤Ÿä½œä¸ºç¡¬ä»¶ä¸²å£çš„RXå¼•è„šï¼Œå‰©ä¸‹çš„7ã€8è„šåˆ†é…ä½œä¸ºä¸¤ä¸ªSPIèŠ¯ç‰‡çš„ç‰‡é€‰ä¿¡å·çº¿ã€‚æ­¤å¤–8è„šè¿˜éœ€è¦æ‰¿æ‹…ä¸²å£TXçš„åŠŸèƒ½ï¼Œæ‰€ä»¥8è„šçš„ç‰‡é€‰å¿…é¡»è¿æ¥åˆ°norFlashçš„ç‰‡é€‰ã€‚å› ä¸ºNorFlashå¯ä»¥å’Œä¸²å£åˆ†æ—¶å¤ç”¨ï¼Œå½“ä»Flashè¯»å–æ•°æ®æ—¶ï¼Œå‡å®šä¸²å£è¾“å‡ºä¸å¯ç”¨ï¼Œä¸”ä»Flashè¯»å–æ•°æ®åªåœ¨å¼€æœºè¯»å–ä¸€æ¬¡ï¼Œå¯¹ä¸²å£çš„åŠŸèƒ½å½±å“è¾ƒå°ã€‚\næœ€ç»ˆè®¾è®¡çš„åŸç†å›¾å¦‚ä¸‹ï¼š\nè¿™é‡Œé™¤äº†4ä¸ª8pinçš„èŠ¯ç‰‡å¤–ï¼Œè¿˜æ·»åŠ äº†ä¸€ä¸ª3è„šçš„LDOä¾›ç”µèŠ¯ç‰‡ã€‚USBæ¥å£é€‰æ‹©äº†å°åˆ¶æ¿å‹çš„TYPE-Cæ¥å£ï¼Œå¯ä»¥ç›´æ¥æ’åœ¨USB TYPE-Cå…¬å¤´ä¸Šã€‚\næœ€ç»ˆçš„å®ç°æ•ˆæœå¦‚ä¸‹ï¼Œä¸€ä¸ªéå¸¸å°å·§çš„ç»“æ„ã€‚PCBæ¿æåšåº¦ä¸€å®šè¦æ˜¯0.8mmï¼Œåªæœ‰è¯¥åšåº¦èƒ½å¤Ÿæ­£å¥½æ’å…¥TYPE-Cå…¬å¤´æ¥å£ä¸­ã€‚\n\n\n    \n        é¡¶å±‚\n        åº•å±‚\n        å®ç‰©\n    \n\n\n\nè½¯ä»¶çš„ç§»æ¤å‚è€ƒäº†pico-rv32imaï¼Œæˆ‘ä¹Ÿå°†STM32çš„ç›¸å…³ä»£ç æ”¾åœ¨äº†Githubä¸Šï¼Œ8pin-linuxã€‚è½¯ä»¶å®ç°ä¸­é™¤äº†RV32è½¯æ ¸éƒ¨åˆ†ï¼Œæœ€æœ‰å­¦ä¹ ä»·å€¼éƒ½å°±æ˜¯cacheçš„å®ç°ï¼Œä½¿ç”¨è¯¥cacheæ–¹æ¡ˆåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¼¥è¡¥äº†å¤–éƒ¨ä¸²è¡ŒPSRAMè¯»å†™æ•ˆç‡ä½çš„çŠ¶å†µï¼Œè§£å†³äº†RV32è½¯æ ¸è¿è¡Œé€Ÿåº¦ä¸å¤–éƒ¨IOé€Ÿåº¦ä¸åŒ¹é…çš„é—®é¢˜ï¼Œè¿™ç§æŠ€æœ¯æ‰‹æ®µå¯ä»¥å€Ÿé‰´åˆ°å…¶å®ƒé¡¹ç›®ä¸­ã€‚\nSTM32çš„å›ºä»¶ç¼–è¯‘å‡ºæ¥æ¥è¿‘32kbï¼Œramä½¿ç”¨ä¹Ÿæ¥è¿‘8kbï¼ŒåŸºæœ¬è€—å°½STM32çš„å­˜å‚¨èµ„æºã€‚\nLinuxå›ºä»¶æ–‡ä»¶ä¸ºImageï¼Œåœ¨STM32çš„æºç ç›¸å…³ç›®å½•ä¸­å­˜åœ¨ã€‚å®ƒéœ€è¦æå‰å†™å…¥åˆ°W25Q64èŠ¯ç‰‡ä¸­ï¼Œå¯ç”¨ä½¿ç”¨JLinkç­‰å·¥å…·æ¥å®Œæˆã€‚\nSTM32èŠ¯ç‰‡å¯ä»¥é£çº¿å¼•å‡ºSWDå¼•è„šï¼Œåœ¨ä¸Šç”µå5ç§’å†…è¿æ¥è°ƒè¯•å™¨ï¼Œè¿æ¥è°ƒè¯•å™¨åéœ€è¦ä½¿ç”¨STLinkä¿®æ”¹èŠ¯ç‰‡çš„é€‰é¡¹å­—èŠ‚ã€‚å°†nRSTå¼•è„šä¿®æ”¹ä¸ºæ™®é€šGPIOä½¿ç”¨ï¼Œä¹‹åå†ä¸‹è½½STM32çš„ç¨‹åºã€‚èŠ¯ç‰‡è¿è¡Œ5ç§’åç›¸å…³çš„å¼•è„šä¼šåˆ‡æ¢åˆ°å…¶å®ƒåŠŸèƒ½ï¼Œä¸‹è½½è°ƒè¯•å°±ä¸å¯ç”¨äº†ã€‚è¯¥SWDæ¥å£å‡ ä¹ä¸å…·å¤‡è°ƒè¯•çš„èƒ½åŠ›ï¼Œé™¤éå°†ç›¸å…³å¤ç”¨åŠŸèƒ½ä¸´æ—¶å…³é—­ã€‚\nè¯¥é¡¹ç›®å‡ ä¹æ²¡æœ‰é¢å¤–çš„è°ƒè¯•æ‰‹æ®µæ¥è§‚å¯ŸRV32å†…æ ¸çš„è¿è¡Œæƒ…å†µï¼Œå”¯ä¸€çš„æ‰‹æ®µæ˜¯ä½¿ç”¨ç¤ºæ³¢å™¨è§‚å¯ŸSPIçš„CSå¼•è„šï¼Œé€šè¿‡è¯¥å¼•è„šå¯ä»¥è§‚å¯Ÿè½¯æ ¸çš„å†…å­˜IOæƒ…å†µï¼ŒåŒæ—¶ä¹Ÿèƒ½åˆ¤æ–­RV32å†…æ ¸æ­»æœºé—®é¢˜ã€‚\nå¯ä»¥çœ‹çœ‹Linuxå¯åŠ¨æ—¥å¿—ï¼Œæ—¶é—´æˆ³ä¸ºç»ˆç«¯è‡ªåŠ¨æ·»åŠ çš„ï¼š\n[15:24:47.759] Start[15:24:47.769] ********************************************************************************************************************************************************************************************************************************************** // é‡å¤è¾“å‡ºï¼Œæ­¤æ—¶æ˜¯STM32åœ¨å°†Linuxå›ºä»¶ä»NorFlashä¸­å†™å…¥åˆ°APS64064Lä¸­ã€‚Image loaded sucessfuly![15:25:33.150] Linux version 6.1.14mini-rv32ima (user@buildvm) (riscv32-buildroot-linux-uclibc-gcc.br_real (Buildroot -g61a3fe7e) 12.2.0, GNU ld (GNU Binutils) 2.38) #3 Thu May  4 18:56:08 UTC 2023[15:25:33.315] Machine model: riscv-minimal-nommu,qemu[15:25:33.346] Zone ranges:[15:25:33.390]   Normal   [mem 0x0000000080000000-0x0000000080ffefff][15:25:33.425] Movable zone start for each node[15:25:33.459] Early memory node ranges[15:25:33.499]   node   0: [mem 0x0000000080000000-0x0000000080ffefff][15:25:33.540] Initmem setup node 0 [mem 0x0000000080000000-0x0000000080ffefff][15:25:33.679] riscv: base ISA extensions aim[15:25:33.719] riscv: ELF capabilities aim[15:25:33.780] Built 1 zonelists, mobility grouping off.  Total pages: 4063[15:25:33.829] Kernel command line: earlycon=uart8250,mmio,0x10000000,1000000 console=hvc0[15:25:33.880] Unknown kernel command line parameters &quot;earlycon=uart8250,mmio,0x10000000,1000000&quot;, will be passed to user space.[15:25:33.938] Dentry cache hash table entries: 2048 (order: 1, 8192 bytes, linear)[15:25:34.080] Inode-cache hash table entries: 1024 (order: 0, 4096 bytes, linear)[15:25:34.130] mem auto-init: stack:off, heap alloc:off, heap free:off[15:25:34.169] Memory: 13340K/16380K available (1445K kernel code, 269K rwdata, 146K rodata, 874K init, 108K bss, 3040K reserved, 0K cma-reserved)[15:25:34.227] SLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=1, Nodes=1[15:25:34.269] NR_IRQS: 64, nr_irqs: 64, preallocated irqs: 0[15:25:34.309] riscv-intc: 32 local interrupts mapped[15:25:34.448] clint: clint@11000000: timer running at 1000000 Hz[15:25:34.500] clocksource: clint_clocksource: mask: 0xffffffffffffffff max_cycles: 0x1d854df40, max_idle_ns: 3526361616960 ns[15:25:34.550] sched_clock: 64 bits at 1000kHz, resolution 1000ns, wraps every 2199023255500ns[15:25:34.600] Console: colour dummy device 80x25[15:25:34.839] printk: console [hvc0] enabled[15:25:35.318] Calibrating delay loop (skipped), value calculated using timer frequency.. 2.00 BogoMIPS (lpj=10000)[15:25:35.490] pid_max: default: 4096 minimum: 301[15:25:37.777] Mount-cache hash table entries: 1024 (order: 0, 4096 bytes, linear)[15:25:38.149] Mountpoint-cache hash table entries: 1024 (order: 0, 4096 bytes, linear)[15:25:51.993] devtmpfs: initialized[15:26:06.741] clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns[15:26:50.500] clocksource: Switched to clocksource clint_clocksource[15:29:15.250] workingset: timestamp_bits=30 max_order=12 bucket_order=0[15:38:46.700] Freeing unused kernel image (initmem) memory: 872K[15:38:46.818] This architecture does not have kernel memory protection.[15:38:47.094] Run /init as init process[15:49:25.583] Welcome to pico-rv32ima Linux[15:51:33.919] Jan  1 00:00:49 login[32]: root login on &#x27;console&#x27;[15:51:34.185] [15:52:19.570] ~ # [15:52:57.861] ~ # [15:52:59.748] ~ # uname -a[15:53:15.205] Linux pico 6.1.14mini-rv32ima #3 Thu May  4 18:56:08 UTC 2023 riscv32 GNU/Linux[15:53:16.133] ~ # [15:53:17.588] ~ # uname -a[15:53:23.321] Linux pico 6.1.14mini-rv32ima #3 Thu May  4 18:56:08 UTC 2023 riscv32 GNU/Linux[15:53:24.100] ~ # [15:53:25.459] ~ # free[15:53:36.194]               total        used        free      shared  buff/cache   available[15:53:36.287] Mem:          14212        1892       10984           0        1336       10376[15:53:41.886] ~ # [15:53:43.249] ~ # echo hello[15:54:10.550] hello[15:54:11.507] ~ # [15:54:12.871] ~ # pwd[15:54:29.969] /root[15:54:30.643] ~ # [15:54:32.110] ~ # ls\n\nç¬¬30ç§’æˆåŠŸåŠ è½½å›ºä»¶ã€‚ç¬¬46ç§’è¾“å‡ºç¬¬ä¸€è¡ŒLinuxå¯åŠ¨æ¶ˆæ¯ã€‚ç¬¬64ç§’åˆå§‹åŒ–è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿã€‚ç¬¬14åˆ†æ‰§è¡Œåˆå§‹ç¨‹åºã€‚ç¬¬27åˆ†42ç§’å¯åŠ¨ç»ˆç«¯ï¼Œæ˜¾ç¤ºå‘½ä»¤æç¤ºç¬¦ã€‚â€¦\nå¯åŠ¨èŠ±è´¹äº†å°†è¿‘åŠå°æ—¶æ˜¯è®©æˆ‘å¾ˆæ„å¤–çš„ã€‚æ‰§è¡Œpwdå’Œuname -aå‘½ä»¤éƒ½èƒ½æ­£å¸¸å“åº”ã€‚å‡†å¤‡æ‰§è¡Œlså‘½ä»¤ï¼Œç­‰äº†å¾ˆä¹…éƒ½æ²¡æœ‰è¾“å‡ºç»“æœï¼Œæˆ‘è®¤ä¸ºå®ƒåº”è¯¥æ˜¯è¿˜åœ¨æ…¢æ…¢è¿è¡Œå§ï¼ä¹Ÿæœ‰å¯èƒ½æ˜¯ç³»ç»ŸæŒ‚äº†ï¼ğŸ˜…\nè¯¥è½¯ä»¶æ–¹æ¡ˆåœ¨550MHzçš„STM32H7èŠ¯ç‰‡ä¸Šé…åˆé«˜é€Ÿçš„SDRAMï¼Œå¯ä»¥éå¸¸æµç•…çš„è¿è¡ŒLinuxï¼Œç»ˆç«¯äº¤äº’éƒ½æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚é™¤äº†STM32G031èŠ¯ç‰‡çš„ä¸»é¢‘ä½å¤–ï¼Œå¤–éƒ¨çš„ä¸²è¡ŒPSRAMå¸¦å®½ä½ä¹Ÿæ˜¯å¯¼è‡´Linuxè¿è¡Œæ…¢çš„ä¸»è¦åŸå› ã€‚\n"},{"title":"åœ¨RTOSä¸­å¦‚ä½•ä¼˜é›…çš„å¤„ç†Faultå¼‚å¸¸","url":"/2021/11/06/%E5%9C%A8RTOS%E4%B8%AD%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E5%A4%84%E7%90%86Fault%E5%BC%82%E5%B8%B8/","content":"ARMå¤„ç†å™¨ä¸‹çš„Faultå¼‚å¸¸ARMå¤„ç†å™¨å½“å‘ç”Ÿå¼‚å¸¸äº‹ä»¶åå°±ä¼šæš‚åœå½“å‰ç¨‹åºçš„è¿è¡Œï¼Œå¤„ç†å™¨è¿›å…¥å¼‚å¸¸æ¨¡å¼ï¼Œå“åº”ä¸€ä¸ªæ¥è‡ªå¤„ç†å™¨å†…æ ¸æˆ–è€…å¤–è®¾çš„ä¸­æ–­è¯·æ±‚ã€‚\nè¿™é‡Œæƒ³è¦å¤„ç†çš„Faultå¼‚å¸¸å°±æ˜¯ARMå¤„ç†å™¨å¤šä¸ªå¼‚å¸¸ä¸­çš„ä¸€ç±»ï¼Œä»¥Cortex-M7å†…æ ¸çš„ARMå¤„ç†å™¨ä¸ºä¾‹ï¼Œä¸»è¦çš„Faultå¼‚å¸¸æœ‰HardFaultã€BusFaultã€UsageFaultã€MemManageã€‚å½“å‘ç”Ÿè¿™äº›å¼‚å¸¸å°±è¡¨ç¤ºç¨‹åºå‡ºç°äº†æ¯”è¾ƒä¸¥é‡çš„é”™è¯¯ï¼Œè¿›è€Œå¯¼è‡´â€œæ­»æœºâ€ã€‚\nåµŒå…¥å¼å®æ—¶æ“ä½œç³»ç»Ÿä¸‹å‘ç”ŸFaultå¼‚å¸¸åä¼šå¦‚ä½•å¤„ç†å¸¸è§çš„å„ç§åµŒå…¥å¼å®æ—¶æ“ä½œç³»ç»Ÿ(FreeRTOSã€UCOSII&#x2F;IIIç­‰)éƒ½æ²¡æœ‰ç‰¹åˆ«çš„å¯¹Faultè¿›è¡Œå¤„ç†ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯æŒ‰ç…§é»˜è®¤å¤„ç†æ–¹å¼æ¥è§£å†³ï¼Œä¹Ÿå°±æ˜¯è®©å¤„ç†å™¨è¿›å…¥æ­»å¾ªç¯ã€‚\nvoid xxxFault_Handler(void)&#123;    while (1);&#125;\n\nè¿™ç§å¤„ç†æ–¹å¼æ˜¯æ— å¯åšéçš„ï¼Œå› ä¸ºç¨‹åºæœ¬èº«å‘ç”Ÿäº†è‡´å‘½çš„æ•…éšœï¼Œæš‚åœå½“å‰ç¨‹åºçš„è¿è¡Œæˆ–è®¸èƒ½å¤Ÿé¿å…ç¨‹åºå‘ç”Ÿæ›´ä¸¥é‡çš„é”™è¯¯ã€‚å¤§å¤šæ•°å•çº¿ç¨‹åµŒå…¥å¼è½¯ä»¶(NoOS)éƒ½æ˜¯è¿™æ ·å¤„ç†çš„ï¼Œä¸€ä¸ªåœ°æ–¹çš„é”™è¯¯ä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒã€‚\nä½†æ˜¯åœ¨å¤šä»»åŠ¡ç¯å¢ƒä¸‹ï¼ŒRTOSæä¾›äº†å¤šçº¿ç¨‹è¿è¡Œçš„æœºåˆ¶ï¼Œçº¿ç¨‹ä¹‹é—´æ˜¯ç›¸å¯¹ç‹¬ç«‹çš„è¿è¡Œã€‚åŸºäºæ­¤ï¼Œåœ¨RTOSä¸­é‡‡ç”¨è¿™ç§æš‚åœå¤„ç†å™¨çš„æ–¹å¼æ¥å¤„ç†å¼‚å¸¸å°±ä¸æ˜¯æœ€ä½³çš„è§£å†³æ–¹æ¡ˆäº†ã€‚ä¾‹å¦‚æœ‰ä¸¤ä¸ªçº¿ç¨‹åœ¨è¿è¡Œ(çº¿ç¨‹Aå’Œçº¿ç¨‹B)ï¼Œçº¿ç¨‹Båœ¨æ­£å¸¸è¿è¡Œï¼Œçº¿ç¨‹Aç”±äºåœ°å€è®¿é—®é”™è¯¯ï¼Œå¯¼è‡´è§¦å‘HardFaultå¼‚å¸¸ï¼ŒFaultå¼‚å¸¸ä¼šæš‚åœæ•´ä¸ªå¤„ç†å™¨çš„è¿è¡Œï¼Œä¸ä½†ä½¿å‘ç”Ÿé”™è¯¯çš„Açº¿ç¨‹åœæ­¢äº†è¿è¡Œï¼Œçº¿ç¨‹Bä¹Ÿè¢«ç‰µè¿å¯¼è‡´è¿è¡Œåœæ­¢ã€‚æ‰€ä»¥åœ¨RTOSä¸­å‘ç”Ÿå¼‚å¸¸æ—¶æƒ³è¦å°†å‡ºç°Faultå¼‚å¸¸è€Œå¸¦æ¥çš„æŸå¤±é™ä½åˆ°æœ€å°ï¼Œä¹Ÿå°±æ˜¯å•ç‹¬åœæ­¢é”™è¯¯çº¿ç¨‹çš„è¿è¡Œè€Œä¸ç»“æŸæ•´ä¸ªç³»ç»Ÿçš„è¿è¡Œã€‚\nå‘ç”ŸFaultå¼‚å¸¸åå¦‚ä½•æš‚åœå¼‚å¸¸çº¿ç¨‹é¦–å…ˆéœ€è¦çŸ¥é“çš„æ˜¯ï¼Œå¼‚å¸¸å¹¶ä¸æ€»æ˜¯ç”±çº¿ç¨‹è¿è¡Œå¯¼è‡´çš„ï¼Œè¿˜æœ‰ç”¨æˆ·ä¸­æ–­å¤„ç†ç¨‹åº(IRQ)ã€RTOSå†…æ ¸è°ƒåº¦ç­‰ï¼Œåœ¨è¿™äº›åœ°æ–¹å‘ç”Ÿçš„å¼‚å¸¸ç›®å‰çœ‹èµ·æ¥æ˜¯æ¯”è¾ƒéš¾å¤„ç†çš„ï¼Œæ‰€ä»¥åé¢ä¸»è¦å¤„ç†çš„å°±æ˜¯åœ¨çº¿ç¨‹ä¸­å‘ç”Ÿçš„Faultå¼‚å¸¸ã€‚è¿™é‡Œä»¥FreeRTOSæ“ä½œç³»ç»Ÿä¸ºä¾‹ï¼Œå¯¹äºå…¶ä»–çš„æ“ä½œç³»ç»Ÿéƒ½èƒ½å®ç°ç±»ä¼¼çš„è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥ç»“åˆå®é™…çš„å¤„ç†å™¨ã€æ“ä½œç³»ç»Ÿå¹³å°è¿›è¡Œä¿®æ”¹ç§»æ¤ï¼Œå› ä¸ºæ ¸å¿ƒæ€æƒ³æ˜¯ä¸€è‡´çš„ã€‚å½“å‘ç”ŸFaultåä¸èƒ½ç®€å•çš„while(1)å¤„ç†äº†ï¼Œæ›´ä¼˜é›…ä¸”å®‰å…¨çš„çš„å®ç°è¦å®Œæˆä¸¤æ­¥åŠ¨ä½œï¼š\n\næš‚åœé”™è¯¯çº¿ç¨‹çš„è¿è¡Œ\nå°†CPUçš„æ‰§è¡Œæƒé™åˆ‡æ¢åˆ°æ­£å¸¸çº¿ç¨‹ä¸­\n\næ¸…ç†å¼‚å¸¸çº¿ç¨‹è¿™æ˜¯åœ¨FreeRTOSä¸‹çš„ä¸€ä¸ªå®ç°ï¼š\n// fault_handle.c#include &quot;FreeRTOS.h&quot;#include &quot;task.h&quot;#if (INCLUDE_xTaskGetIdleTaskHandle == 0)#warning &quot;Unable to switch to a valid task!&quot;#endifvoid* clean_fault_task(void)&#123;    extern void* pxCurrentTCB;    TaskHandle_t fault_task = pxCurrentTCB;    if(xTaskGetSchedulerState() == taskSCHEDULER_NOT_STARTED)&#123;        /* RTOS not running. */        return NULL;    &#125;    /* Switch to Idle task and delete current fault task. */    // log_info(&quot;task(%s) fault.\\n&quot;, pcTaskGetName(task));    #if defined(INCLUDE_xTaskGetIdleTaskHandle) &amp;&amp; (INCLUDE_xTaskGetIdleTaskHandle == 1)    pxCurrentTCB = xTaskGetIdleTaskHandle();    #else    return NULL;    #endif    vTaskDelete(fault_task);    return pxCurrentTCB;&#125;\nç®€å•è§£é‡Šä¸€ä¸‹è¿™æ®µä»£ç çš„å«ä¹‰ã€‚é¦–å…ˆéœ€è¦åˆ¤æ–­æ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦æœ‰æ²¡æœ‰è¿è¡Œï¼Œå¦‚æœæ“ä½œç³»ç»Ÿè¿˜æ²¡æœ‰å¯åŠ¨ï¼Œè¿™å°±è¯´æ˜å¼‚å¸¸ä¸æ˜¯åœ¨çº¿ç¨‹ä¸­è§¦å‘çš„ï¼Œè¿™å°±ä¸åœ¨è§£å†³èŒƒå›´å†…ã€‚ç„¶åæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥åˆ‡å…¥çš„çº¿ç¨‹ï¼Œè€Œä¸”å®ƒæ˜¯å¤„äºå°±ç»ªæ€çš„ä»»åŠ¡ï¼Œæ˜¾ç„¶æœ€å¥½çš„é€‰æ‹©å°±æ˜¯Idleçº¿ç¨‹äº†ã€‚é€šè¿‡xTaskGetIdleTaskHandle()è·å–åˆ°Idleçº¿ç¨‹çš„å¥æŸ„ï¼Œèµ‹å€¼ç»™pxCurrentTCBã€‚æœ€åè°ƒç”¨vTaskDelete()åˆ é™¤å½“å‰é”™è¯¯çš„çº¿ç¨‹ï¼Œå¹¶è¿”å›æ–°çš„å½“å‰çº¿ç¨‹å°±å¥½äº†ã€‚\nè¿™é‡Œä¸ºä»€ä¹ˆéœ€è¦å…ˆè·å–æ–°çš„çš„çº¿ç¨‹å†åˆ é™¤æ—§çš„é”™è¯¯çº¿ç¨‹å‘¢ï¼Ÿè¿™å°±éœ€è¦ç†è§£çº¿ç¨‹åˆ é™¤ä¸­å‘ç”Ÿäº†ä»€ä¹ˆã€‚\n// void vTaskDelete( TaskHandle_t xTaskToDelete )if( pxTCB == pxCurrentTCB )&#123;    /* A task is deleting itself.  This cannot complete within the    * task itself, as a context switch to another task is required.    * Place the task in the termination list.  The idle task will    * check the termination list and free up any memory allocated by    * the scheduler for the TCB and stack of the deleted task. */    vListInsertEnd( &amp;xTasksWaitingTermination, &amp;( pxTCB-&gt;xStateListItem ) );    /* Increment the ucTasksDeleted variable so the idle task knows    * there is a task that has been deleted and that it should therefore    * check the xTasksWaitingTermination list. */    ++uxDeletedTasksWaitingCleanUp;    /* Call the delete hook before portPRE_TASK_DELETE_HOOK() as    * portPRE_TASK_DELETE_HOOK() does not return in the Win32 port. */    traceTASK_DELETE( pxTCB );    /* The pre-delete hook is primarily for the Windows simulator,    * in which Windows specific clean up operations are performed,    * after which it is not possible to yield away from this task -    * hence xYieldPending is used to latch that a context switch is    * required. */    portPRE_TASK_DELETE_HOOK( pxTCB, &amp;xYieldPending );&#125;// ...if( pxTCB == pxCurrentTCB )&#123;    configASSERT( uxSchedulerSuspended == 0 );    portYIELD_WITHIN_API();&#125;// ...\nè¿™æ˜¯FreeRTOSçº¿ç¨‹åˆ é™¤æ—¶æ˜¯è¿›è¡Œçš„ä¸€äº›æ“ä½œï¼Œå½“åˆ¤æ–­ä¸ºåˆ é™¤å½“å‰çº¿ç¨‹(pxCurrentTCB)æ˜¯ä¼šè¿›è¡Œçš„é¢å¤–æ“ä½œã€‚FreeRTOSæ˜¯ä¸èƒ½ç›´æ¥åˆ é™¤çº¿ç¨‹è‡ªèº«çš„ï¼Œå®ƒæ˜¯å°†è‡ªå·±æ ‡è®°ä¸ºé¢„åˆ é™¤çš„çŠ¶æ€ï¼Œç„¶åæ“ä½œç³»ç»Ÿåˆ‡æ¢åˆ°Idleçº¿ç¨‹ä¸­æ—¶å»æ¸…ç†è¿™äº›éœ€è¦è¢«åˆ é™¤çš„çº¿ç¨‹ï¼Œæ­¤å¤–è¿™é‡Œè¿˜ä¼šè¿›è¡Œä¸€æ¬¡ä¸»åŠ¨çš„çº¿ç¨‹è°ƒåº¦ï¼Œè¿™æ˜¯éå¸¸å±é™©çš„ï¼Œå½“çº¿ç¨‹å‡ºç°é”™è¯¯åï¼Œå¦‚æœç»§ç»­è¿›è¡Œå¸¸è§„è°ƒåº¦æµç¨‹ï¼Œè¿™å¯èƒ½ä¼šæ¶‰åŠåˆ°è®¿é—®é”™è¯¯çº¿ç¨‹çš„æ ˆç©ºé—´ï¼Œè¿™æ˜¯ä¸å¯é çš„(å¯¼è‡´æ›´ä¸¥é‡çš„é”™è¯¯)ã€‚æ‰€ä»¥çº¿ç¨‹æ¸…ç†ä»…ä»…æ˜¯è®©æ“ä½œç³»ç»Ÿä¸å†è°ƒåº¦è¿™ä¸ªé”™è¯¯çš„çº¿ç¨‹ï¼Œä¸åŸé”™è¯¯çº¿ç¨‹ç›¸å…³çš„æ“ä½œé™ä½åˆ°æœ€å°‘ã€‚\nè¿›è¡Œä¸€æ¬¡ç‰¹åˆ«çš„çº¿ç¨‹è°ƒåº¦æœ‰ä½•ç‰¹åˆ«ï¼Ÿè¿™é‡Œçš„çº¿ç¨‹è°ƒåº¦æ“ä½œå°†æ²¡æœ‰åˆ‡å‡ºçº¿ç¨‹ï¼Œåªæœ‰åˆ‡å…¥çº¿ç¨‹ï¼Œå› ä¸ºæœ¬è¯¥åˆ‡å…¥çš„çº¿ç¨‹åœ¨åˆšåˆšå‰é¢é‚£æ®µä»£ç ä¸­åˆ é™¤äº†ã€‚æ‰€ä»¥è¿™é‡Œçš„çº¿ç¨‹è°ƒåº¦å°±ä¸èƒ½ç›´æ¥ä½¿ç”¨ç³»ç»Ÿçš„APIå®Œæˆè°ƒåº¦ï¼Œè¿™é‡Œéœ€è¦è‡ªå·±å®ç°ä¸€æ®µçº¿ç¨‹è°ƒåº¦çš„ä»£ç ã€‚è¿™é‡Œä»¥ä¸€æ®µARMæ±‡ç¼–æ¥å®ç°è¿™æ®µè°ƒåº¦ç¨‹åºã€‚\nbic r3, lr, #7cmn r3, #8beq .endbl clean_fault_taskcmp r0, #0beq .endldr r0, [r0]ldmia r0!, &#123;r4-r11, r14&#125;tst r14, #0x10it eqvldmiaeq r0!, &#123;s16-s31&#125;msr psp, r0isbmov r0, #0msr basepri, r0bx r14.end: b .end\nè¿™æ®µæ±‡ç¼–ä»£ç åˆ†ä¸º4ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€æ®µï¼Œè¿™é‡Œæ˜¯é€šè¿‡LRå¯„å­˜å™¨çš„å€¼æ¥åˆ¤æ–­è§¦å‘å¼‚å¸¸æ˜¯å¦æ˜¯åœ¨æ™®é€šçš„çº¿ç¨‹ä¸­ï¼Œå¦‚æœä¸æ˜¯åœ¨çº¿ç¨‹ä¸­è§¦å‘çš„å¼‚å¸¸å°†ä¸èƒ½å¤„ç†ï¼Œç›´æ¥è·³è½¬åˆ°æœ€åçš„æ­»å¾ªç¯ä¸­ã€‚ç¬¬äºŒæ®µï¼Œè°ƒç”¨å‰é¢å®ç°çš„ä»»åŠ¡æ¸…ç†å‡½æ•°ï¼Œæ¸…ç†æ‰é”™è¯¯çº¿ç¨‹å¹¶é€‰æ‹©ä¸€ä¸ªæ–°çš„å¯è¿è¡Œçº¿ç¨‹(è¿™é‡Œå°±æ˜¯Idleçº¿ç¨‹)ï¼Œå‡½æ•°è¿”å›åï¼Œåˆ¤æ–­r0ï¼Œå¦‚æœæ— æ³•æ¸…ç†é”™è¯¯çº¿ç¨‹æˆ–è€…æ²¡æœ‰å¯ç”¨çš„çº¿ç¨‹ï¼Œä»ç„¶è·³è½¬åˆ°æœ€åçš„æ­»å¾ªç¯ä¸­ã€‚ç¬¬ä¸‰æ®µï¼Œr0å°±æ˜¯å‰é¢å‡½æ•°è¿”å›æ—¶ä¼ é€’è¿‡æ¥çš„æ–°çš„çº¿ç¨‹å¥æŸ„ï¼Œå®ƒå­˜å‚¨çš„ç¬¬ä¸€ä¸ªå­—æ®µå°±æ˜¯è¯¥çº¿ç¨‹çš„æ ˆï¼Œæ ˆé‡Œé¢å­˜å‚¨çš„å†…å®¹ç»“æ„æ¶‰åŠåˆ°FreeRTOSçº¿ç¨‹è°ƒåº¦ç›¸å…³çš„å†…å®¹ã€‚è¿™é‡Œå°±ç®€å•è¯´ä¸€è¯´FreeRTOSçš„ä»»åŠ¡è°ƒåº¦æ—¶çš„æ ˆå†…ç»“æ„ï¼Œæ ˆé‡Œé¢å­˜å‚¨çš„æ˜¯r4-r11å¯„å­˜å™¨ï¼Œè¿™äº›å¯„å­˜å™¨æ˜¯ARMå¼‚å¸¸å¤„ç†æ— æ³•è‡ªåŠ¨ä¿å­˜çš„ã€‚æ­¤å¤–è¿˜æœ‰ä¿å­˜r14(lr)å¯„å­˜å™¨ï¼Œå®ƒæ˜¯ç”¨æ¥åˆ¤æ–­æ ˆå†…æ˜¯å¦å­˜å‚¨äº†æµ®ç‚¹å¯„å­˜å™¨çš„ï¼ŒLRå¯„å­˜å™¨çš„bit4æŒ‡ç¤ºäº†çº¿ç¨‹æ˜¯å¦åœ¨ä½¿ç”¨æµ®ç‚¹å¯„å­˜å™¨ã€‚ç”±äºs0-s15ä»¥åŠæµ®ç‚¹çŠ¶æ€å¯„å­˜å™¨FPSRæ˜¯ç›´æ¥ç”±ARMå¼‚å¸¸è‡ªåŠ¨å®Œæˆå­˜å–äº†ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦æ ¹æ®çº¿ç¨‹æ˜¯å¦ä½¿ç”¨äº†æµ®ç‚¹å¯„å­˜å™¨æ¥å­˜å‚¨s16-s31å¯„å­˜å™¨ã€‚\nå°†å¾…åˆ‡å…¥è¿è¡Œçš„çº¿ç¨‹ç›¸å…³çš„å¯„å­˜å™¨éƒ½æ¢å¤å®Œæ¯•åï¼Œå°±å¯ä»¥é€€å‡ºå¼‚å¸¸å¹¶è½¬å…¥åˆ°æ–°çš„çº¿ç¨‹å»æ‰§è¡Œäº†ï¼Œä¹Ÿå°±æ˜¯ç¬¬å››æ®µä»£ç çš„å†…å®¹ã€‚\nå°è£…å¼‚å¸¸å¤„ç†å°†å‰é¢æ±‡ç¼–ä»£ç è¿›è¡Œå°è£…ï¼Œè¿™æ ·å°±èƒ½å¤Ÿå¤„ç†å¤šä¸ªFaultå¼‚å¸¸äº†ã€‚\n// fault_handle.h#ifndef _FAULT_HANDLE_H#define _FAULT_HANDLE_H#if defined(__CC_ARM)#define FAULT_HANDLER()#elif defined(__GNUC__)#define FAULT_HANDLER() \\    (&#123; \\    __asm volatile ( \\        &quot;   push &#123;r0, r1, r2, r3, r12, lr&#125;  \\n&quot; \\        /* Exception not returned to Handle mode */ \\        &quot;   bic r3, lr, #7                  \\n&quot; \\        &quot;   cmn r3, #8                      \\n&quot; \\        &quot;   beq .end&quot; END_LINE &quot;            \\n&quot; \\        &quot;                                   \\n&quot; \\        /* Clean fault task and get the pxCurrentTCB address. */ \\        &quot;   bl clean_fault_task             \\n&quot; \\        &quot;   cmp r0, #0                      \\n&quot; \\        &quot;   beq .end&quot; END_LINE &quot;            \\n&quot; \\        &quot;   add sp, #24                     \\n&quot; \\        &quot;                                   \\n&quot; \\        /* The first item in pxCurrentTCB is the task top of stack. */ \\        &quot;   ldr r0, [r0]                    \\n&quot; \\        /* Pop the registers that are not automatically saved on \\           exception entry and the critical nesting count. */ \\        &quot;   ldmia r0!, &#123;r4-r11, r14&#125;        \\n&quot; \\        /* Is the task using the FPU context?  If so, pop the high vfp registers too. */ \\        &quot;   tst r14, #0x10                  \\n&quot; \\        &quot;   it eq                           \\n&quot; \\        &quot;   vldmiaeq r0!, &#123;s16-s31&#125;         \\n&quot; \\        /* Restore the task stack pointer. */   \\        &quot;   msr psp, r0                     \\n&quot; \\        &quot;   isb                             \\n&quot; \\        &quot;   mov r0, #0                      \\n&quot; \\        &quot;   msr basepri, r0                 \\n&quot; \\        &quot;   bx r14                          \\n&quot; \\        &quot;                                   \\n&quot; \\        &quot;.end&quot; END_LINE &quot;:                  \\n&quot; \\        &quot;   pop &#123;r0, r1, r2, r3, r12, lr&#125;   \\n&quot; \\        ); \\    &#125;)#define _STR2(x) #x#define _STR(x) _STR2(x)#define END_LINE _STR(__LINE__)#endif#endif\nè¿™æ®µä»£ç å®ç°æ¯”å‰é¢çš„æ±‡ç¼–å¤šäº†ä¸€äº›å†…å®¹ï¼Œä¸»è¦æ˜¯è¦è€ƒè™‘å †æ ˆå¹³è¡¡ä»¥åŠå¼‚å¸¸çº¿ç¨‹æ¸…ç†å¤±è´¥åçš„æ¢å¤çº¿ç¨‹çš„é—®é¢˜ã€‚å‰é¢å¤„ç†å¤±è´¥æ˜¯è¿›å…¥ä¸€ä¸ªæ­»å¾ªç¯ä¸­ï¼Œè¿™é‡Œæ²¡æœ‰è¿›å…¥æ­»å¾ªç¯ã€‚å¤„ç†å¤±è´¥åæ‰€æœ‰çš„å¯„å­˜å™¨ä¼šæ¢å¤åˆ°å¤„ç†å‰çš„çŠ¶æ€ï¼Œè¿™æ ·èƒ½å¤Ÿä¸ºå…¶å®ƒé”™è¯¯åˆ†æç±»çš„ç¨‹åºæä¾›å¸®åŠ©ï¼Œæ¯”å¦‚æˆ‘å‰é¢æœ‰ç¯‡æ–‡ç« è®²è§£äº†å¦‚ä½•è¿›è¡Œæ ˆå›æº¯ï¼Œé‚£æ®µç¨‹åºå°±èƒ½å¤Ÿè¡”æ¥åœ¨è¿™æ®µç¨‹åºå‰é¢æˆ–è€…åé¢ï¼Œå¸®åŠ©åˆ†æå¼‚å¸¸é—®é¢˜ã€‚\nè¿™é‡Œéœ€è¦ç‰¹åˆ«æé†’ï¼Œæ ˆå¹³è¡¡æ˜¯éå¸¸é‡è¦çš„ä¸€ç‚¹ï¼Œå°¤å…¶æ˜¯ä½¿ç”¨æ±‡ç¼–æ¥æ“ä½œæ ˆç©ºé—´æ—¶ã€‚è¦çŸ¥é“ï¼Œbx lrååé¢çš„ä»£ç æ˜¯æ— æ³•ç»§ç»­æ‰§è¡Œçš„ï¼Œæ‰€ä»¥éœ€è¦ä¿è¯è¿›å…¥Faultæ—¶åˆ°æ‰§è¡Œbx lræ—¶mspæ ˆæ˜¯å¹³è¡¡çš„ã€‚å¦‚æœæ ˆä¸å¹³è¡¡å°±ä¼šå¯¼è‡´æ ˆå†…å­˜ç©ºé—´å¼‚å¸¸å‡å°ã€‚è¿™æ®µå®å®šä¹‰æ˜¯å†…è”æ±‡ç¼–ï¼Œå½“å®ƒåµŒå…¥åˆ°Cå‡½æ•°åï¼Œå‡½æ•°å¤´æ˜¯å¦è¿˜æœ‰æ ˆæ“ä½œæˆ‘ä¸ç¡®å®šã€‚å¯èƒ½ä¸åŒçš„ç¼–è¯‘å™¨æƒ…å†µä¸ä¸€æ ·ï¼Œä½†æˆ‘ç”¨GCCæ—¶æ²¡æœ‰å‘ç°é—®é¢˜ã€‚å¦‚æœä½ æƒ³è¦æŠŠè¿™æ®µä»£ç ç§»æ¤åˆ°ä½ çš„ç³»ç»Ÿä¸­ï¼Œæœ€å¥½ä»”ç»†æ ¸å¯¹æ ˆå¹³è¡¡ç›¸å…³çš„å†…å®¹ã€‚\nç›¸æ¯”äºæœ€å¼€å§‹çš„while(1)ï¼Œæ–°çš„å¼‚å¸¸å¤„ç†ç¨‹åºå¯ä»¥å†™ä¸ºï¼š\nvoid xxxFault_Handler(void)&#123;    FAULT_HANDLER()ï¼›    while (1)    &#123;    &#125;&#125;\nè¿™æ ·å½“ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå‡ºç°å¼‚å¸¸åèƒ½å¤Ÿè‡ªåŠ¨åœæ­¢å¹¶ç»§ç»­è¿›è¡Œç³»ç»Ÿè°ƒåº¦ï¼Œä¿è¯äº†ç³»ç»Ÿçš„æŒç»­è¿è¡Œã€‚\næ€»ç»“é€šè¿‡è¿™ç§å¤„ç†æ–¹å¼èƒ½å¤Ÿè§£å†³çº¿ç¨‹é”™è¯¯å¸¦æ¥çš„æ­»æœºé—®é¢˜ï¼Œä½†æ˜¯åœ¨å®é™…çš„ç”Ÿäº§è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿˜éœ€è¦å…¶å®ƒè¾…åŠ©æ€§è´¨çš„ç¨‹åºæ¥å¸®åŠ©ç¨‹åºæ›´åŠ ç¨³å›ºçš„è¿è¡Œï¼Œä¾‹å¦‚å¯ä»¥è®¾è®¡ä¸€ä¸ªåŸºäºå®šæ—¶å™¨çš„å®ˆæŠ¤ä»»åŠ¡ï¼Œå½“å®ƒç›‘è§†åˆ°çº¿ç¨‹å´©æºƒç»“æŸåè‡ªåŠ¨é‡å¯å®ƒã€‚è¿™æ ·æ‰æ›´åŠ å…·æœ‰å®é™…æ„ä¹‰ã€‚\nè¿™æ®µç¨‹åºä»»ç„¶æœ‰ä¸å®Œç¾çš„åœ°æ–¹ï¼Œæ¯”å¦‚å®ƒä¸èƒ½å¤„ç†éçº¿ç¨‹Faultå¼‚å¸¸ï¼Œè¿˜æœ‰çº¿ç¨‹æ¸…ç†æ—¶æ˜¯æš‚åœå®ƒè¿˜æ˜¯åˆ é™¤å®ƒï¼Ÿåˆ é™¤çº¿ç¨‹åç›¸å…³èµ„æºæ˜¯å¦åŠæ—¶å›æ”¶ï¼Ÿè¿™äº›é—®é¢˜éƒ½éœ€è¦ç»“åˆå®é™…é¡¹ç›®è¿›ä¸€æ­¥å®Œå–„ã€‚\n"},{"title":"åˆå­¦å°„é¢‘ä¿¡å·","url":"/2023/05/07/%E5%88%9D%E5%AD%A6%E5%B0%84%E9%A2%91%E4%BF%A1%E5%8F%B7/","content":"\nä»äº‹åµŒå…¥å¼è½¯ä»¶å¼€å‘4å¹´æœ‰ä½™ï¼Œæˆ‘è‡ªè®¤ä¸ºè¿˜æ˜¯æœ‰ç›¸å½“å¤šçš„çŸ¥è¯†å’ŒæŠ€èƒ½å­˜åœ¨æ¬ ç¼ºï¼Œæ‰€ä»¥è¿‘å¹´æ¥ä¸€ç›´ä¿æŒè‰¯å¥½çš„å­¦ä¹ æ€åº¦ï¼ŒæŒç»­å……å®è‡ªèº«çš„æŠ€èƒ½ã€‚ä»ä¹‹å‰çš„æ–‡ç« å†…å®¹èƒ½å¤Ÿçœ‹å‡ºï¼Œæˆ‘ä¸»è¦å›´ç»•åµŒå…¥å¼è½¯ä»¶å¼€å‘çš„å¤šä¸ªæ–¹é¢è®°å½•è‡ªå·±çš„å­¦ä¹ å¿ƒå¾—ã€‚ä½†å®é™…ä¸Šä¸ä»…é™äºæ­¤ï¼Œåœ¨è¿‡å»çš„ä¸€å¹´ä¸­æœ‰å¾ˆå¤šæœºä¼šæ¥è§¦åˆ°å°„é¢‘å¼€å‘ï¼Œæ‰€ä»¥å­¦ä¹ åˆ°äº†å¾ˆå¤šæœ‰æ„æ€çš„æ–°çŸ¥è¯†ï¼Œè¿™å¯¹æˆ‘æ¥è¯´ç®—æ˜¯ä¸€ä»¶å¾ˆæœ‰ä¹è¶£çš„äº‹æƒ…ã€‚è¿™ç§ä¹è¶£æ¥è‡ªäºå¯¹æœªçŸ¥çš„æ¢ç´¢ï¼Œå› ä¸ºæˆ‘å¹¶éä¸“ä¸šçš„ç§‘ç­å‡ºèº«ï¼Œæ‰€ä»¥åœ¨è¿™ä¹‹å‰å¯¹å°„é¢‘å¼€å‘é¢†åŸŸæ˜¯å®Œå…¨ä¸€ç‰‡ç©ºç™½çš„ï¼Œå› æ­¤åˆšå¼€å§‹å¯¹æˆ‘æ¥è¯´è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æŒ‘æˆ˜ï¼Œä½†æ˜¯æˆ‘é€æ¸å°†å®ƒå˜ä¸ºä¸€ç§ä¹è¶£ã€‚ä»¥ä¸‹å†…å®¹æ¥è‡ªä¸ä¸€ä½åˆå­¦è€…çš„æ—¥è®°ã€‚\n\nä»å°„é¢‘ä¿¡å·å¼€å§‹ä»€ä¹ˆæ˜¯å°„é¢‘ä¿¡å·ï¼Ÿé€šä¿—æ¥è¯´å°±æ˜¯ç‰¹å®šé¢‘ç‡çš„ç”µç£æ³¢ä¿¡å·ï¼Œä½†æ˜¯è¿™ä¸ªæè¿°å¤ªç¬¼ç»Ÿäº†ï¼Œå› ä¸ºå¤§å¤šæ•°ç”µå­äº§å“éƒ½ä¼šå‘å°„ä¸€äº›å¹²æ‰°ä¿¡å·ï¼Œè¿™äº›æˆ‘å¹¶ä¸è®¤ä¸ºè¿™æ˜¯å°„é¢‘ä¿¡å·ï¼Œæˆ‘ç†è§£çš„å°„é¢‘ä¿¡å·æ˜¯å…·æœ‰ä¸€å®šä¿¡å·å¼ºåº¦ä¸”èƒ½å¤Ÿè¿œè·ç¦»ä¼ è¾“çš„ç”µç£ä¿¡å·ã€‚\nå°„é¢‘ä¿¡å·çš„äº§ç”Ÿå°„é¢‘ä¿¡å·éœ€è¦ä¾é å°„é¢‘ç”µè·¯å’Œå¤©çº¿æ¥äº§ç”Ÿã€‚é€šè¿‡æ—¶é’Ÿæºã€PLLã€æ”¾å¤§å™¨å°±èƒ½ç»„æˆç®€å•çš„å°„é¢‘ç”µè·¯ï¼Œæ¥è§¦è¿‡å•ç‰‡æœºçš„å¼€å‘è€…åº”è¯¥éƒ½å¬è¯´è¿‡PLLè¿™ä¸ªè¯ï¼Œé€šè¿‡å®ƒèƒ½å¤Ÿå¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„é¢‘ç‡çš„ä¿¡å·ï¼Œä¾‹å¦‚å•ç‰‡æœºå†…éƒ¨çš„ä¸»æ—¶é’Ÿä¿¡å·ã€å°„é¢‘ä¿¡å·ç­‰ã€‚å¯èƒ½æœ‰äº›äººå¯¹å•ç‰‡æœºä¸Šçš„æ™¶æŒ¯æœ‰è¯¯è§£ï¼Œè®¤ä¸ºå•ç‰‡æœºçš„æ—¶é’Ÿæ˜¯ç”±æ™¶æŒ¯æä¾›çš„ï¼Œè¿™æ˜¯ä¸æ­£ç¡®çš„ï¼Œå¦‚æœå•ç‰‡æœºå†…éƒ¨å…·æœ‰PLLï¼Œé‚£ä¹ˆæ—¶é’Ÿä¿¡å·ç”±PLLæä¾›ï¼Œæ™¶æŒ¯ä»…ä»…æ˜¯ä¸€ä¸ªæ—¶é’Ÿå‚è€ƒçš„ä½œç”¨ï¼Œç”¨äºæ ¡æ­£PLLè¾“å‡ºçš„æ—¶é’Ÿé¢‘ç‡ã€‚\nPLLçš„å·¥ä½œåŸç†PLLçš„å…¨ç§°æ˜¯Phase-Locked Loopï¼Œå³ç›¸ä½é”å®šç¯è·¯ï¼Œä¸‹å›¾æ˜¯æŸPLLä¿¡å·å†…éƒ¨çš„æ¨¡å—æ¡†å›¾ï¼Œè¿™é‡Œåªå…³å¿ƒæœ€å…³é”®çš„PLLéƒ¨åˆ†ã€‚ä¿¡å·çš„æ¥æºæ˜¯é‚£ä¸ªæ­£å¼¦ç¬¦å·çš„é‚£ä¸ªæ¨¡å—ï¼ˆVCOï¼‰ï¼Œå®ƒç›´æ¥è¾“å‡ºæˆ‘ä»¬æƒ³è¦çš„é¢‘ç‡ï¼Œè€Œå®ƒè¾“å‡ºé¢‘ç‡çš„å‡†ç¡®æ€§å°±æ˜¯ä¾é PLLçš„è´Ÿåé¦ˆæœºåˆ¶å®Œæˆçš„ï¼Œè¾“å‡ºçš„ä¿¡å·ç»è¿‡Nåˆ†é¢‘åä¸å‚è€ƒä¿¡å·è¿›è¡Œæ¯”è¾ƒï¼Œå½“é¢‘ç‡å’Œç›¸ä½ä¸ä¸€è‡´æ—¶ï¼Œä¼šè°ƒèŠ‚VCOçš„ç”µå‹æ¥è°ƒèŠ‚VCOè¾“å‡ºçš„é¢‘ç‡ï¼Œè¿™ä¸ªè°ƒèŠ‚æ˜¯å¿«é€Ÿä¸”å‡†ç¡®çš„ã€‚è¿™ä¸ªè´Ÿåé¦ˆç¯å°±æ˜¯ç›¸ä½é”å®šç¯è·¯ï¼ŒPLLä¸€èˆ¬å…ˆé”å®šé¢‘ç‡ï¼Œä¿è¯é¢‘ç‡æ²¡æœ‰è¯¯å·®ï¼Œå†é”å®šç›¸ä½ï¼Œä¿è¯ç›¸ä½ä¸€è‡´ã€‚CPoutå’ŒVTuneé€šè¿‡ä¸€ä¸ªå¤–éƒ¨ç”µè·¯è¿æ¥ï¼Œä¸€ä¸ªæ»¤æ³¢ç”µè·¯ï¼Œå½¢æˆä¸€ä¸ªæ›´åŠ ç¨³å®šçš„PLLç¯è·¯ï¼Œè¿™ä¸ªå¤–éƒ¨ç”µè·¯å«åšç¯è·¯æ»¤æ³¢å™¨ã€‚\nå¤©çº¿ä¸ºä»€ä¹ˆèƒ½å‘å°„ç”µç£æ³¢æˆ‘è®¤ä¸ºè¿™é‡Œé‡‡ç”¨äº†å’Œå˜å‹å™¨ç±»ä¼¼çš„åŸç†ï¼Œæˆ‘ä»¬çš„å¤©çº¿å¯ä»¥çœ‹æˆå˜å‹å™¨çš„åˆçº§ç»•ç»„ï¼Œé€šè¿‡æ–½åŠ é«˜é¢‘ç”µæµï¼Œä½¿å¾—å¤©çº¿å‘¨å›´äº§ç”Ÿäº¤å˜ç”µåœºå’Œç£åœºï¼Œè·ç¦»å¤©çº¿ä¸€å®šè·ç¦»çš„ç”µç£åœºä¿¡å·èƒ½å¤Ÿå‘ç©ºé—´å¤–è‡ªç”±ä¼ æ’­ï¼Œè¿™å°±å°†å°„é¢‘ä¿¡å·å‘å°„åˆ°ç©ºä¸­äº†ã€‚å°„é¢‘ä¿¡å·çš„æ¥æ”¶åŸç†ç±»ä¼¼ï¼Œå°±æ˜¯ç©ºä¸­çš„ç”µç£åœºä¿¡å·è€¦åˆåˆ°äº†å¤©çº¿ä¸Šï¼Œç›¸å½“äºå˜å‹å™¨çš„æ¬¡çº§ç»•ç»„ã€‚ä¸ºä»€ä¹ˆç”µç£ä¿¡å·èƒ½å¤Ÿåœ¨ç©ºä¸­è‡ªç”±çš„ä¼ æ’­ï¼Œæˆ‘ç›®å‰è¿˜ä¸èƒ½å¤Ÿå®Œå…¨ç†è§£ï¼Œå¤§è‡´å°±æ˜¯å˜åŒ–çš„ç”µç£å’Œç£åœºèƒ½å¤Ÿç›¸äº’æ„Ÿåº”äº§ç”Ÿï¼Œå…·ä½“åˆ°ç†è®ºä¸Šå¯èƒ½éœ€è¦æ·±å…¥ç†è§£éº¦å…‹æ–¯éŸ¦æ–¹ç¨‹ã€‚\nè°ƒåˆ¶å‘å°„å°„é¢‘ä¿¡å·çš„æ„ä¹‰å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸ºäº†åœ¨ç©ºä¸­ä¼ é€’ä¿¡æ¯ï¼Œå› ä¸ºä½é¢‘çš„ä¿¡å·çš„å¤©çº¿ä¸æ–¹ä¾¿åˆ¶ä½œï¼Œå› ä¸ºå¤©çº¿éœ€è¦1&#x2F;4æ³¢é•¿çš„é•¿åº¦ï¼Œå½“ç›´æ¥å‘å°„ä¸€ä¸ªä½é¢‘ä¿¡å·æ—¶æ‰€éœ€çš„å¤©çº¿å°±æ˜¾å¾—å¤ªåºå¤§äº†ã€‚æŠŠéœ€è¦ä¼ é€’çš„ä¿¡å·å åŠ åˆ°é«˜é¢‘ä¿¡å·ä¸Šå°±æ˜¯ä¸€ä¸ªå’Œå¥½çš„æ–¹æ³•ï¼Œå°„é¢‘ä¿¡å·æ‰¿è½½ä¿¡æ¯çš„è¿‡ç¨‹å°±æ˜¯è°ƒåˆ¶ï¼Œè°ƒåˆ¶çš„æ–¹æ³•ç”±å¾ˆå¤šï¼Œæœ‰è°ƒç›¸ã€è°ƒé¢‘ç­‰ï¼Œè¿˜å¯ä»¥ç»„åˆå¤šç§ä¸åŒçš„è°ƒåˆ¶æ–¹æ³•ä»¥å……åˆ†åˆ©ç”¨ä¿¡é“å¸¦å®½ã€‚ä»€ä¹ˆæ˜¯ä¿¡é“ï¼Ÿä¼ è¾“ä¿¡æ¯çš„é€šé“ï¼Œè¿™é‡Œç‰¹æŒ‡å°„é¢‘é€šé“ã€‚å¼ºè°ƒä¿¡é“çš„æ„ä¹‰æ˜¯å› ä¸ºæ‰€æœ‰çš„ç©ºä¸­å°„é¢‘ä¿¡å·éƒ½åŒæ—¶å­˜åœ¨ï¼Œè€Œå´åˆ«å®ƒä»¬çš„å°±åªæœ‰é¢‘ç‡ä¸åŒè€Œå·²ï¼Œä¿¡å·å› ä¸ºè°ƒé¢‘ç­‰åŸå› å®ƒå ç”¨çš„é¢‘ç‡ä¸æ˜¯ä¸€ä¸ªå›ºå®šçš„ç‚¹ï¼Œè€Œæ˜¯ä¸€æ®µé¢‘ç‡ï¼Œä¾‹å¦‚è“ç‰™çš„æŸä¸ªä¿¡é“é¢‘ç‡èŒƒå›´æ˜¯2401~2403MHzï¼Œæ˜¾ç„¶æ•´ä¸ªè‡ªç”±ç©ºé—´çš„ä¿¡é“æ˜¯æœ‰é™çš„ï¼Œå› ä¸ºé«˜é¢‘ä¿¡å·çš„äº§ç”Ÿå’Œä¼ è¾“éƒ½æ˜¯å¾ˆéš¾çš„ã€‚é€šè¿‡æ··é¢‘å™¨èƒ½å¤Ÿå°†ä½é¢‘ä¿¡å·å’Œé«˜é¢‘ä¿¡å·è¿›è¡Œå åŠ åˆæˆå‡ºå¦ä¸€ä¸ªå°„é¢‘ä¿¡å·ï¼Œåœ¨è¿™ä¸ªå°„é¢‘ä¿¡å·ä¸­åŒ…å«äº†æˆ‘ä»¬å…ˆè¦ä¼ é€’çš„ä¿¡å·ã€‚è€Œé‚£ä¸ªä½é¢‘ä¿¡å·å°±æ˜¯åŸºå¸¦ä¿¡å·ï¼Œé«˜é¢‘ä¿¡å·å°±æ˜¯æœ‰PLLäº§ç”Ÿçš„æœ¬æŒ¯ä¿¡å·ã€‚\né˜»æŠ—åŒ¹é…åœ¨ä¸€èˆ¬çš„ç”µè·¯è®¾è®¡ä¸­éƒ½ä¼šè€ƒè™‘é˜»æŠ—åŒ¹é…ï¼Œé˜»æŠ—åŒ¹é…æ˜¯ä¸ºäº†åŠŸç‡èƒ½å¤Ÿæœ€å¤§ç¨‹åº¦çš„ä¼ é€’å‡ºå»ï¼Œå½“é˜»æŠ—ä¸åŒ¹é…ï¼Œä¿¡å·çš„åŠŸç‡å°±ä¸èƒ½æœ€å¤§åŒ–çš„è¿›è¡Œä¼ é€’ï¼Œå¯¼è‡´ä¿¡å·è´¨é‡ä¸ä½³ï¼Œæ›´ä¸¥é‡çš„æ˜¯ä¿¡å·å¯èƒ½å¼•èµ·åå°„ç­‰é—®é¢˜ã€‚è€ƒè™‘ä¸€ä¸ªç®€å•çš„ç”µå‹æºï¼Œå…¶å†…éƒ¨ç”µé˜»rï¼Œç”µå‹æºå¤–æ¥ä¸€ä¸ªç”µé˜»Ræ„æˆä¸€ä¸ªç®€å•çš„å›è·¯ï¼Œä¸ºäº†ä½¿å¾—ç”µé˜»Rçš„åŠŸç‡æœ€å¤§ï¼Œæ˜¾ç„¶å½“R&#x3D;ræ—¶å…¶èƒ½å¤Ÿè·å¾—çš„åŠŸç‡æœ€å¤§ï¼Œè¿™æ—¶è¾“å‡ºé˜»æŠ—rå’Œè¾“å…¥é˜»æŠ—Rç›¸ç­‰ï¼Œè¿™å°±æ˜¯é˜»æŠ—åŒ¹é…ã€‚åœ¨å°„é¢‘ç”µè·¯ä¸­é™¤äº†ç”µé˜»å¤–ï¼Œè¿˜æœ‰ç”µæŠ—(å¤é˜»æŠ—ä¸­çš„è™šéƒ¨)ï¼Œå®ƒä»¬å…±åŒç»„æˆäº†å°„é¢‘ç”µè·¯ä¸­çš„é˜»æŠ—ã€‚æˆ‘å°è¯•ç†è§£å°„é¢‘ç”µè·¯ä¸­çš„é˜»æŠ—åŒ¹é…ï¼Œå‘ç°è¿™æ˜¯ä¸€é—¨éå¸¸å¤æ‚çš„å­¦é—®ï¼Œè¿˜è¦è§£å†³ä¸€äº›åå¾®åˆ†æ–¹ç¨‹ã€‚æ€»ä¹‹ä¿è¯é˜»æŠ—åŒ¹é…æ˜¯å°„é¢‘ç”µè·¯è®¾è®¡çš„ä¸€å¤§è¦ç‚¹ã€‚\nå¦‚æœæƒ³è¦å¼ºè¡Œè°ƒæ•´ä¸€ä¸ªå°„é¢‘ç«¯å£çš„é˜»æŠ—æ€ä¹ˆåŠå‘¢ï¼Œæ‰‹åŠ¨è®¡ç®—è‚¯å®šæ˜¯ä¸€ä¸ªéå¸¸éº»çƒ¦çš„è¿‡ç¨‹ï¼Œå²å¯†æ–¯åœ†å›¾æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„å·¥å…·ï¼Œå®ƒæ˜¯ç”¨äºç¡®å®šå°„é¢‘ä¼ è¾“é˜»æŠ—çš„åŸºæœ¬å·¥å…·ï¼Œé€šè¿‡å®ƒä¹Ÿèƒ½è°ƒæ•´ç«¯å£çš„é˜»æŠ—ï¼Œå¯ä»¥ä½¿ç”¨å²å¯†æ–¯åœ†å›¾è½¯ä»¶è¿›è¡Œé˜»æŠ—çš„ç²¾ç¡®è®¡ç®—ã€‚å²å¯†æ–¯åœ†å›¾çš„ç”¨é€”éå¸¸å¹¿æ³›ï¼ŒçŸ¢é‡ç½‘ç»œåˆ†æä»ªä¸­è¡¨ç¤ºç«¯å£çš„é˜»æŠ—é€šå¸¸ä¹Ÿæ˜¯åœ¨å²å¯†æ–¯å›¾ä¸Šè¡¨ç¤ºã€‚\nä¸€èˆ¬çš„å°„é¢‘è¿æ¥ä»¶éƒ½ä½¿ç”¨50æ¬§å§†çš„é˜»æŠ—è¿›è¡Œè®¾è®¡ï¼Œåœ¨è®¾è®¡å°„é¢‘ç”µè·¯æ—¶ï¼Œä¸åŒå°„é¢‘æ¨¡å—çš„è¿æ¥éƒ¨åˆ†å°±éœ€è¦è€ƒè™‘ä¸¤ç«¯çš„é˜»æŠ—è¦ä¸€è‡´ï¼Œå¯¹äºå°åˆ·ç”µè·¯æ¿æ¥è¯´ï¼Œä¸Šé¢çš„å¯¼çº¿ä¹Ÿæ˜¯å°„é¢‘ç”µè·¯çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€æœ‰ç”µè·¯çš„èµ°çº¿ä¹Ÿéœ€è¦è¿›è¡Œé˜»æŠ—åŒ¹é…ï¼Œéœ€è¦ç»¼åˆè€ƒè™‘PCBå¸ƒçº¿çš„çº¿å®½ã€æ‹è§’ç­‰ï¼Œæ­¤å¤–PCBåŸºæ¿ææ–™çš„å±‚åšã€ææ–™ç­‰éƒ½æ˜¯å½±å“PCBèµ°çº¿é˜»æŠ—çš„å› ç´ ï¼Œä¸€èˆ¬çš„RF4ææ–™çš„PCBä»‹ç”µå¸¸æ•°ä¸ç¨³å®šï¼Œé€šå¸¸ä¸ä½œä¸ºé«˜è´¨é‡å°„é¢‘ç”µè·¯æ¿è€ƒè™‘ï¼Œè¿›å£çš„ç½—æ°æ–¯PCBæ˜¯å°„é¢‘ç”µè·¯æ¿ä¸­ç”¨çš„è¾ƒå¤šçš„ã€‚æœ€è¿‘å›½äº§çš„ç‰¹æ°Ÿé¾™ææ–™çš„PCBä¹Ÿèƒ½å®ç°ç¨³å®šä¼˜è´¨çš„ä»‹ç”µå¸¸æ•°ï¼Œä½¿ç”¨å®ƒåšäº†ä¸€å—å¤©çº¿é˜µåˆ—ï¼Œæ•ˆæœè¿˜æ¯”è¾ƒå¥½ã€‚\nSå‚æ•°å­¦ä¹ å°„é¢‘ä¿¡å·ï¼Œè‚¯å®šç¦»ä¸å¼€Så‚æ•°ï¼ŒSå‚æ•°ä¸ä»…ä»…æ˜¯ç”¨äºå°„é¢‘é¢†åŸŸï¼Œå®ƒç”¨äºæ‰€æœ‰ä¿¡å·é¢†åŸŸã€‚å®ƒæ˜¯æè¿°ä¿¡å·å®Œæ•´æ€§çš„ä¸€ä¸ªå·¥å…·ï¼ŒSå‚æ•°çš„å…¨ç¨‹æ˜¯Scatterå‚æ•°ï¼Œå³æ•£å°„å‚æ•°ï¼Œä¸€èˆ¬ç”¨äºæè¿°ä¸€ä¸ªäºŒç«¯å£ç½‘ç»œçš„é¢‘åŸŸç‰¹æ€§ã€‚ä½¿ç”¨S11æè¿°ä¸€ä¸ªç«¯å£çš„åå°„ç‰¹æ€§ï¼Œé€šå¸¸å¯ä»¥ç”¨å®ƒæè¿°ä¸€ä¸ªå¤©çº¿çš„è´¨é‡å¥½åï¼ŒS11å¯ä»¥è½¬æ¢ä¸ºSWR(é©»æ³¢)è¡¨ç¤ºï¼Œä¸€èˆ¬å¤©çº¿çš„é©»æ³¢å°äº1.2å°±è¯´æ˜å¤©çº¿è´¨é‡æ¯”è¾ƒå¥½ã€‚S21é€šå¸¸ç”¨äºæè¿°äºŒç«¯å£å™¨ä»¶çš„æ’å…¥æŸè€—ï¼Œå¯¹äºä¸€èˆ¬çš„æ»¤æ³¢å™¨ï¼Œåœ¨é€šå¸¦å†…S21å¤§äº-0.5dBã€‚\nè°æ³¢è°æ³¢æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ä¸œè¥¿ï¼Œæ­£ç»çš„å°„é¢‘ä¿¡å·æ˜¯æ ‡å‡†çš„æ­£å¼¦æ³¢ï¼Œä½†æ˜¯å¦‚æœå®ƒç»è¿‡åˆ†é¢‘æˆ–è€…ä¸€äº›å…¶å®ƒå¤„ç†ï¼Œé‚£ä¹ˆåœ¨ä¿¡å·ä¸­å°±ä¼šäº§ç”Ÿè°æ³¢æˆåˆ†ï¼Œè°æ³¢å°±æ˜¯åŸå§‹åŸºæ³¢ä¿¡å·é¢‘ç‡æ•´æ•°å€çš„é¢‘ç‡çš„ä¿¡å·ã€‚ä¸€ä¸ªä¿¡å·åˆ†é¢‘åé€šå¸¸æ˜¯æ–¹æ³¢ï¼Œä½¿ç”¨å‚…é‡Œå¶åˆ†è§£åï¼Œå¾ˆæ˜æ˜¾èƒ½å¤Ÿçœ‹åˆ°å¤šé˜¶çš„è°æ³¢ã€‚æ­¤å¤–ï¼Œä¸€ä¸ªæ ‡å‡†çš„æ­£å¼¦æ³¢ä¿¡å·ç»è¿‡ä¸€ä¸ªéçº¿æ€§å…ƒä»¶æ—¶ï¼Œåœ¨å…¶å†…éƒ¨åŒæ ·ä¼šäº§ç”Ÿè°æ³¢ä¿¡å·çš„æˆåˆ†ï¼Œéçº¿æ€§å…ƒä»¶å°±æ˜¯ä¼å®‰ç‰¹æ€§æ›²çº¿ä¸æ˜¯ä¸€æ¡ç›´çº¿ï¼Œåœ¨å…¶éçº¿æ€§åŒºåŸŸå¸¦å…¥æ­£å¼¦ä¿¡å·è¡¨è¾¾å¼ï¼Œç»è¿‡æ³°å‹’å±•å¼€åå¯ä»¥å¾—åˆ°åŸå§‹æ­£å¼¦ä¿¡å·çš„å¤šé˜¶è°æ³¢ä¿¡å·æˆåˆ†ï¼Œé€šå¸¸é˜¶æ•°è¶Šé«˜å…¶æŒ¯å¹…è¶Šå¼±ã€‚\næ¥æ”¶å°„é¢‘ä¿¡å·å°„é¢‘ä¿¡å·ç»è¿‡åœ¨ç©ºæ°”ä¸­ä¼ è¾“åï¼Œå…¶ä¿¡å·å¼ºåº¦è‚¯å®šä¼šè¡°å‡çš„ï¼Œå…¶ä¿¡å·è¡°å‡çš„è§„å¾‹ç¬¦åˆè‡ªç”±ç©ºé—´æŸè€—æ¨¡å‹ï¼Œä¿¡å·è¡°å‡å€¼ä¸ä¼ æ’­è·ç¦»çš„å¯¹æ•°çº¿æ€§ç›¸å…³ï¼Œä¸ä¿¡å·é¢‘ç‡çš„å¯¹æ•°çº¿æ€§ç›¸å…³ã€‚å¤§éƒ¨åˆ†å¾…æ¥æ”¶çš„ä¿¡å·å¼ºåº¦éƒ½æ¯”è¾ƒä½ï¼Œä¸€èˆ¬åœ¨-80dBmä»¥ä¸‹ã€‚ä¸ºäº†è§£æå¦‚æ­¤ä½çš„ä¿¡å·ï¼Œå°±éœ€è¦æ”¾å¤§å™¨æ¥æ”¾å¤§è¿™ä¸ªä¿¡å·ï¼Œä¸€èˆ¬ä½¿ç”¨ä½å™ªå£°æ”¾å¤§å™¨ï¼Œå®ƒé€šå¸¸ç”¨äºæ”¾å¤§æ¥æ”¶ç«¯çš„å¾®å¼±ä¿¡å·ã€‚å°†æ¥æ”¶åˆ°çš„ä¿¡å·å¯ä»¥é‡‡ç”¨å’Œå‘å°„ç«¯ç±»ä¼¼çš„æ–¹æ³•è¿›è¡Œæ··é¢‘æ¥è§£ææˆ‘ä»¬æƒ³è¦çš„ä¿¡å·ï¼Œä¹Ÿå°±æ˜¯ä¸‹å˜é¢‘ã€‚ä¸‹å˜é¢‘åçš„ä¿¡å·ç§°ä¸ºä¸­é¢‘ä¿¡å·ï¼Œä¸­é¢‘çš„æ„æ€å°±æ˜¯ä¸­é—´é¢‘ç‡ï¼Œå› ä¸ºå®ƒè¿˜ä¸æ˜¯æœ€ç»ˆæƒ³è¦çš„ä¿¡å·ã€‚ä¸­é¢‘ä¿¡å·ä¸€èˆ¬è¿˜éœ€è¦ä½¿ç”¨å¸¦é€šæ»¤æ³¢å™¨è¿›è¡Œå¤„ç†ï¼Œå› ä¸ºè¿™é‡Œéœ€è¦ä¸€æŠŠä¸‹å˜é¢‘å¸¦æ¥çš„é•œé¢‘å¹²æ‰°ï¼Œè¿‡æ»¤éš¾åº¦ä¸€èˆ¬å’Œä¸­é¢‘å¤§å°å’Œæ»¤æ³¢å™¨çš„å¸¦å®½æœ‰å…³ã€‚ä¸­é¢‘ä¿¡å·ç»è¿‡ADCé‡‡æ ·åå°±å¾—åˆ°äº†åŸºå¸¦ä¿¡å·ã€‚\nIQè°ƒåˆ¶ç°åœ¨æ¥æ”¶èŠ¯ç‰‡éƒ½ä½¿ç”¨IQæ­£äº¤è°ƒåˆ¶ï¼Œå³åŸºå¸¦ä¿¡å·ä½¿ç”¨ä¸€å¯¹æ­£äº¤çš„ä¿¡å·è¿›è¡Œè¡¨è¿°ï¼ŒIç›¸å°±æ˜¯åŸå§‹ä¿¡å·ä¸‹å˜é¢‘åçš„ä¿¡å·ï¼ŒQç›¸ä¿¡å·æ—¶åŸå§‹ä¿¡å·ç»è¿‡90åº¦çš„ç›¸ä½æ—‹è½¬åä¸‹å˜é¢‘åçš„ä¿¡å·ï¼ŒIQè°ƒåˆ¶èƒ½å¤Ÿè§£å†³é•œé¢‘å¹²æ‰°ç­‰é—®é¢˜ï¼Œåœ¨ä¿¡å·å‘å°„ç«¯è¿˜èƒ½å®ç°æ‰©é¢‘çš„æ•ˆæœã€‚åœ¨å¤å¹³é¢åæ ‡ä¸‹ï¼Œä½¿ç”¨Iè¡¨ç¤ºå®éƒ¨ï¼ŒQè¡¨ç¤ºè™šéƒ¨ï¼Œæ¯ä¸€å¯¹IQå°±è¡¨ç¤ºä¸€ä¸ªå¤å¹³é¢ä¸‹çš„ä¸€ä¸ªç‚¹ï¼Œå°†åŸºå¸¦æ•°æ®æ˜ å°„åˆ°å¤å¹³é¢ä¸Šå°±æ˜¯IQè°ƒåˆ¶çš„è¿‡ç¨‹ã€‚\nè°ƒåˆ¶æ–¹æ³•ä¿¡å·çš„è°ƒåˆ¶æ–¹æ³•æœ‰è°ƒé¢‘ã€è°ƒå¹…ã€è°ƒç›¸è¿™ä¸‰ç§æˆ–è€…åŒæ—¶ä½¿ç”¨å¤šç§ä¸åŒç±»å‹çš„è°ƒåˆ¶æ–¹æ³•ã€‚è°ƒå¹…å°±æ˜¯è½½æ³¢é¢‘ç‡ä¿æŒä¸å˜ï¼Œè½½æ³¢ä¿¡å·éšç€åŸºå¸¦ä¿¡å·è°ƒæ•´å¹…åº¦ã€‚è°ƒé¢‘å°±æ˜¯è½½æ³¢ä¿¡å·å¹…åº¦ä¸å˜ï¼Œä½†å…¶ç¬æ—¶é¢‘ç‡çš„åç§»éšåŸºå¸¦ä¿¡å·åšçº¿æ€§å˜åŒ–ã€‚è°ƒç›¸å°±æ˜¯è½½æ³¢ä¿¡å·çš„ç›¸ä½éšåŸºå¸¦ä¿¡å·çº¿æ€§å˜åŒ–ã€‚\nå…·ä½“æ¥è¯´ï¼Œè°ƒæ•´æ–¹æ³•æœ‰AMã€FMã€PSKã€QPSKã€QAMã€16QAMç­‰ã€‚\næ˜Ÿåº§å›¾è¡¨ç¤ºæ–¹æ³•å¯¹äºå…·ä½“çš„è°ƒæ•´æ–¹æ³•æ¥è¯´ï¼Œéƒ½å¯ä»¥ä½¿ç”¨IQè°ƒåˆ¶å®ç°ï¼Œå…¶è°ƒåˆ¶ç¬¦å·åœ¨å¤å¹³é¢ä¸Šçš„å›¾åƒå°±æ„æˆäº†ä¸€ä¸ªæ˜Ÿåº§å›¾åƒï¼Œé€šè¿‡æ˜Ÿåº§å›¾åƒå¯ä»¥æ›´åŠ æ¸…æ™°ç†è§£ä¿¡å·è§£è°ƒçš„è¿‡ç¨‹ã€‚è¿™æ˜¯ä¸€ä¸ª8PSKè°ƒåˆ¶çš„æ˜Ÿåº§å›¾ã€‚\nOFDMOFDMæ˜¯æ­£äº¤é¢‘åˆ†å¤ç”¨çš„ç®€ç§°ï¼Œå®ƒæ˜¯ä¸€ç§ä¿¡å·å¤ç”¨çš„æ–¹æ³•ï¼Œå®ƒæ˜¯ä¸€ç§åº”ç”¨åœ¨å…·ä½“è°ƒåˆ¶æ–¹æ³•ä¸Šå±‚çš„æŠ€æœ¯ã€‚å®ƒå°†ä¼ ç»Ÿçš„ä¸€ä¸ªä¿¡é“åˆ’åˆ†ä¸ºå¤šä¸ªä¿¡é“ï¼Œèƒ½å¤Ÿæ›´åŠ å……åˆ†çš„ä½¿ç”¨ä¿¡é“å¸¦å®½ã€‚æ›´å…·ä½“çš„æ¥è¯´å®ƒä¸»è¦æ˜¯ä¸ºäº†è§£å†³å†å®½å¸¦ä¿¡é“ä¸­çš„é¢‘ç‡é€‰æ‹©æ€§è¡°è½é—®é¢˜è€Œå¹¿æ³›è¿ç”¨çš„ã€‚æˆ‘è‡ªå·±ä½¿ç”¨OFDM+QPSKå®ç°äº†OFDMçš„æ”¶å‘ä»£ç ï¼Œä¸»è¦æ˜¯ä½¿ç”¨å‚…é‡Œå¶å˜æ¢æ¥å®ç°çš„ï¼ŒOFDMä¸­ä½¿ç”¨å¾ªç¯å‰ç¼€æ¥è¿›è¡Œæ•°æ®åŒæ­¥æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„è®¾è®¡ã€‚ä¸è¿‡æˆ‘åœ¨å®ç°OFDMæ—¶é‡åˆ°è¿‡ä¸€ä¸ªé—®é¢˜ä¸€ç›´æ²¡æœ‰è§£å†³ï¼Œå°±æ˜¯å½“ä¼ è¾“ä¿¡é“ä¸­å­˜åœ¨ç›¸ä½å™ªéŸ³æ—¶ï¼ŒQPSKæ˜Ÿåº§å›¾å‡ºç°äº†æ—‹è½¬åç§»ï¼Œæ˜¾ç„¶å¯¹äºQPSKæ¥è¯´åç§»è¶…è¿‡90åº¦æ—¶å°±ä¼šå¯¼è‡´æ— æ³•æ­£ç¡®è§£è°ƒï¼Œåº”è¯¥æœ‰æ–¹æ³•èƒ½å¤Ÿè§£å†³æ˜Ÿåº§å›¾æ—‹è½¬çš„é—®é¢˜ï¼Œä¸è¿‡æˆ‘ç›®å‰è¿˜ä¸ä¼šã€‚\nè½¯ä»¶æ— çº¿ç”µ(SDR)ä¸€èˆ¬äººå¾ˆéš¾åŒæ—¶æ¥è§¦å°„é¢‘ç”µè·¯è®¾è®¡å’Œä¿¡å·è°ƒåˆ¶è§£è°ƒç®—æ³•çš„è®¾è®¡ã€‚ä¸ºäº†ç®€åŒ–è½¯ä»¶å¼€å‘äººå‘˜çš„å­¦ä¹ éš¾åº¦ï¼Œä½¿ç”¨è½¯ä»¶æ— çº¿ç”µæŠ€æœ¯ï¼Œå¯ä»¥ä½¿ç”¨è½¯ä»¶çš„æ–¹æ³•ç›´æ¥è¾“å‡ºå°„é¢‘ä¿¡å·ã€‚è¿™é‡Œéœ€è¦ä½¿ç”¨ç›¸å…³çš„å°„é¢‘å¼€å‘æ¿ï¼Œé€šè¿‡USBå’Œä¸»æœºè¿æ¥ï¼Œå†ä¸»æœºä¸Šé€šè¿‡ä¸€å®šçš„ç®—æ³•ç”ŸæˆIQä¿¡å·ï¼Œå°†IQä¿¡å·ä¼ è¾“åˆ°å°„é¢‘å¼€å‘æ¿ä¸Šç”±å°„é¢‘æ¿è¾“å‡ºä¿¡å·ï¼Œè¿™å¯¹è½¯ä»¶å¼€å‘äººå‘˜æ¥è¯´æ˜¯ä¸€ä¸ªå¾ˆå‹å¥½çš„è¿‡ç¨‹ã€‚åŒç†ä¿¡å·çš„æ¥æ”¶ä¹Ÿå¯ä»¥ä½¿ç”¨SDRå®Œæˆã€‚æˆ‘è‡ªå·±ä¹Ÿä½¿ç”¨è½¯ä»¶æ— çº¿ç”µå¼€å‘å®é™…å‚ä¸å¤šä¸ªé¡¹ç›®å¼€å‘ï¼Œæ„Ÿå—åˆ°äº†è½¯ä»¶æ— çº¿ç”µçš„å¼ºå¤§ã€‚\næˆ‘ä½¿ç”¨è¿‡ä¸¤æ¬¾SDRè®¾å¤‡ï¼ŒLimeSDRå’ŒHackRFï¼Œéƒ½å…·æœ‰æ˜“ç”¨çš„SDRï¼Œä½¿ç”¨ä½“éªŒä¹Ÿæ¯”è¾ƒå¥½ã€‚\n"},{"title":"åœ¨åˆ›å»ºFreeRTOSä»»åŠ¡æ—¶å®¹æ˜“å¿½ç•¥çš„ä¸€ä¸ªé—®é¢˜","url":"/2024/07/11/%E5%9C%A8%E5%88%9B%E5%BB%BAFreeRTOS%E4%BB%BB%E5%8A%A1%E6%97%B6%E5%AE%B9%E6%98%93%E5%BF%BD%E7%95%A5%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98/","content":"é¢å‘å¯¹è±¡çš„ç¼–ç¨‹æ€æƒ³ç»å¸¸å‡ºç°åœ¨åµŒå…¥å¼è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œé€šå¸¸å°†ä¸€ç»„ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘åŠå…¶ç›¸å…³è”çš„æ•°æ®å°è£…ä¸ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ä»¥æ–¹ä¾¿æ•°æ®å’Œæ–¹æ³•çš„é›†ä¸­ç®¡ç†ï¼Œå°¤å…¶æ˜¯åœ¨è¯¥å®ä¾‹å¯¹è±¡è¿˜æ¶‰åŠä¸€ä¸ªå…³è”çš„ä»»åŠ¡æ—¶ï¼Œä¸ºäº†å°†ç›¸å…³çš„æ•°æ®ä¼ å…¥çº¿ç¨‹ï¼Œå°†æ‰€æœ‰çš„æ•°æ®å°è£…èµ·æ¥æ˜¯ä¸€ç§éå¸¸åˆç†çš„æ“ä½œã€‚ä¸‹é¢æ˜¯ä¸€æ®µè¿™æ ·çš„ä»£ç ï¼š\ntypedef struct &#123;    TaskHandle_t task;    const char *str;    int cnt;&#125; hello_obj_t;void hello_task(void *pvParameters)&#123;    hello_obj_t *obj = (hello_obj_t *)pvParameters;    for(int i = 0; i &lt; obj-&gt;cnt; i++)&#123;        printf(&quot;%s\\n&quot;, obj-&gt;str);        vTaskDelay(1000);    &#125;    TaskHandle_t task = obj-&gt;task;    free(obj);    vTaskDelete(task);&#125;int main_test(const char *str, int cnt)&#123;    hello_obj_t *obj;    obj = malloc(sizeof(hello_obj_t));    obj-&gt;str = str;    obj-&gt;cnt = cnt;    static StackType_t stack[1024];    static StaticTask_t task;    obj-&gt;task = xTaskCreateStatic(hello_task, &quot;hello&quot;, 1024, obj, 10, stack, &amp;task);    return 0;&#125;\n\nè¿™æ®µä»£ç å±•ç¤ºä¸€ç§å¸¸è§çš„ç¼–ç¨‹æ¨¡å¼ï¼Œå³å°†ä»»åŠ¡çº¿ç¨‹ç›¸å…³çš„æ•°æ®å°è£…åœ¨ä¸€ä¸ªç»“æ„ä½“ä¸­ï¼Œç„¶ååœ¨ä»»åŠ¡åˆ›å»ºæ—¶ä¼ å…¥åˆ°ä»»åŠ¡å‡½æ•°ä¸­ã€‚å½“ä»»åŠ¡å°†ç›¸å…³ä¸šåŠ¡æ•°æ®å¤„ç†å®Œæˆååˆ é™¤ç›¸å…³èµ„æºã€‚\nä¸Šé¢è¿™æ®µä»£ç çœ‹èµ·æ¥æ²¡ä»€ä¹ˆå¤ªå¤§çš„é—®é¢˜ï¼Œå¯¹è±¡åˆ†é…çš„èµ„æºéƒ½åœ¨çº¿ç¨‹åˆ é™¤å‰å¾—åˆ°é‡Šæ”¾ã€‚ä½†ä¸Šé¢è¿™æ®µä»£ç ä»ç„¶å­˜åœ¨ä¸€ä¸ªè‡´å‘½çš„ç¼ºé™·ï¼Œå³å¯èƒ½å‡ºç°hello_taskçº¿ç¨‹æ— æ³•è¢«æ­£å¸¸åˆ é™¤çš„æƒ…å†µã€‚\nFreeRTOSåœ¨åˆ›å»ºä»»åŠ¡æ—¶ï¼Œå¦‚æœè¢«åˆ›å»ºçš„ä»»åŠ¡ä¼˜å…ˆçº§é«˜äºå½“å‰ä¸Šä¸‹æ–‡çš„ä¼˜å…ˆçº§ï¼Œä¼šåœ¨ä»»åŠ¡åˆ›å»ºå‡½æ•°è¿”å›å‰å°±è°ƒåº¦åˆ°æ–°åˆ›å»ºçš„ä»»åŠ¡ä¸­æ‰§è¡Œï¼Œè¿™ä½¿å¾—ä½¿å¾—ä»»åŠ¡åˆ›å»ºå‡½æ•°æ²¡æœ‰åŠæ—¶çš„è¿”å›ï¼Œå¯¼è‡´obj-&gt;taskæ— æ³•å–å¾—æ­£ç¡®çš„å€¼ã€‚çº¿ç¨‹hello_taskæ‰§è¡Œå¤ªå¿«ä¸”æ²¡æœ‰é‡Šæ”¾CPUæ‰§è¡Œæƒæ—¶ï¼Œä¼šå¯¼è‡´åœ¨ä»»åŠ¡åˆ é™¤æ—¶obj-&gt;taskæ²¡æœ‰å–åˆ°æ­£ç¡®çš„å€¼ï¼Œä»è€Œå¯¼è‡´ä»»åŠ¡æ— æ³•è¢«æ­£ç¡®åˆ é™¤ã€‚\nå¯èƒ½å¤§å¤šæ•°ä¸šåŠ¡ä»£ç éƒ½ä¸ä¼šæ‰§è¡Œçš„å¤ªå¿«ï¼Œä½†åœ¨ä¸€äº›æç«¯æƒ…å†µè¿˜æ˜¯éœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼Œä¾‹å¦‚ä¸Šè¿°ä»£ç ä¸­ä¼ å…¥cntä¸º0æ—¶çš„æƒ…å†µã€‚\nè§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ä¸ªæ€è·¯ï¼Œä¸€æ˜¯ä½¿ç”¨xTaskCreate()æ›¿ä»£xTaskCreateStatic()ï¼ŒxTaskCreateå‡½æ•°é€šè¿‡ä¼ å‚çš„æ–¹å¼å–å¾—ä»»åŠ¡å¥æŸ„ï¼Œä¸ä¼šå‡ºç°ä¸Šè¿°é—®é¢˜ï¼Œå®ƒå¯ä»¥ä¿è¯åœ¨ä»»åŠ¡æ‰§è¡Œå‰å°±å°†å¥æŸ„èµ‹äºˆæ­£ç¡®çš„å€¼ã€‚äºŒæ˜¯åœ¨ä½¿ç”¨xTaskCreateStaticæ¥å£å‰å…³é—­ä»»åŠ¡è°ƒåº¦å™¨ï¼Œåœ¨ä»»åŠ¡åˆ›å»ºå®Œæˆååœ¨æ‰“å¼€ä»»åŠ¡è°ƒåº¦ï¼Œç¡®ä¿ä»»åŠ¡åˆ›å»ºå‡½æ•°æ­£å¸¸è¿”å›åå†å¯åŠ¨ä»»åŠ¡è°ƒåº¦å™¨ã€‚\næˆ–è®¸å¯ä»¥ä½¿ç”¨vTaskDelete(NULL)æ¥åˆ é™¤å½“å‰çº¿ç¨‹ï¼Œè¿™æ ·å°±èƒ½è§„é¿è¯¥é—®é¢˜ã€‚ä½†é€šè¿‡ä¸Šé¢è¿™ä¸ªç¤ºä¾‹å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªæ—¶åºä¸ä¸¥è°¨çš„ä»£ç å¯èƒ½å¯¼è‡´æ¯”è¾ƒä¸¥é‡çš„é—®é¢˜ï¼Œåœ¨å®ç°å…¶å®ƒç±»ä¼¼è¿™æ ·çš„å¤šçº¿ç¨‹ä»£ç æ—¶ä¹Ÿåº”å½“æ³¨æ„ç±»ä¼¼çš„é—®é¢˜ã€‚\n"},{"title":"å¤åˆ»ä¸€ä¸ªBlackMagicProbe","url":"/2024/09/05/%E5%A4%8D%E5%88%BB%E4%B8%80%E4%B8%AABlackMagicProbe/","content":"Black MagicBlack Magic Probeæ˜¯ä¸€ä¸ªå†…å»ºGDB serverçš„åµŒå…¥å¼èŠ¯ç‰‡è°ƒè¯•å™¨ï¼Œå¯ä»¥ç”¨æ¥è°ƒè¯•ARMã€riscvç­‰å•ç‰‡æœºã€‚å…³äºè¯¥è°ƒè¯•å™¨çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒå®˜ç½‘ç½‘ã€‚\nå…‹éš†ç‰ˆæœ¬æˆ‘åŸºäºå®˜æ–¹çš„å›ºä»¶ï¼Œè®¾è®¡äº†ä¸€ä¸ªç”µè·¯æ¿ï¼Œåšäº†ä¸€ä¸ªè‡ªå·±çš„ç‰ˆæœ¬ï¼Œä¸»è¦çš„åŠŸèƒ½åŒå®˜æ–¹ç‰ˆæœ¬ä¸€æ ·ï¼Œåªæ˜¯å¤šäº†ç›®æ ‡è®¾å¤‡ç”µæºæ§åˆ¶å’Œç”µå‹æ£€æµ‹åŠŸèƒ½ã€‚\n\n\nå›¾1. è‡ªå·±è®¾è®¡åˆ¶ä½œçš„BMP\n\n\nå¸¸ç”¨å‘½ä»¤è¿™é‡Œè®°å½•ä¸€äº›è¯¥è°ƒè¯•å™¨å¸¸ç”¨çš„ä¸€äº›å‘½ä»¤ï¼Œæ–¹ä¾¿ä»¥åæŸ¥é˜…ã€‚\n# æŸ¥è¯¢BlackMagicè®¾å¤‡çš„ä¸²å£å·# powershellGet-CimInstance -ClassName Win32_SerialPort -Filter &quot;PNPDeviceID like &#x27;USB\\\\VID_1D50&amp;PID_6018&amp;MI_00%&#x27;&quot; | Select -ExpandProperty DeviceID | Set-Variable -Name BMP_GDB_PORT# å›ºä»¶ä¸€é”®ä¸‹è½½arm-none-eabi-gdb -nx --batch -ex &#x27;target extended-remote \\\\.\\\\COM21&#x27; -ex &#x27;monitor swdp_scan&#x27; -ex &#x27;attach 1&#x27; -ex &#x27;load&#x27; -ex &#x27;compare-sections&#x27; -ex &#x27;kill&#x27; binary.elf# GDBå‘½ä»¤# è¿æ¥è°ƒè¯•å™¨target extended-remote \\\\.\\COM21# ä½¿ç”¨SWDæ¨¡å¼æ‰«æè®¾å¤‡monitor swdp_scan# ä½¿ç”¨JTAGæ¨¡å¼æ‰«æè®¾å¤‡monitor jtag_scan# è¿æ¥ç›®æ ‡è®¾å¤‡attach 1# è®¾ç½®ä¸‹è½½çº¿é¢‘ç‡monitor freq 900k# ç›®æ ‡è®¾å¤‡ä¾›ç”µæ§åˆ¶monitor tpwr enablemonitor tpwr disable# ä¸‹è½½å›ºä»¶load binary.elf# æ¯”è¾ƒå›ºä»¶compare-sections# ä½¿ç”¨RTTåŠŸèƒ½monitor rtt# æŸ¥çœ‹å¯„å­˜å™¨info registers# è¿è¡Œç›®æ ‡è®¾å¤‡startrun# æ–­ç‚¹è°ƒè¯•break &lt;function&gt;break &lt;file&gt;:&lt;line&gt;watch &lt;var&gt;# é€€å‡ºè°ƒè¯•å™¨detachkill\n\nåœ¨STM32CubeIDEä¸­è°ƒè¯•æ–°å»ºä¸€ä¸ªè°ƒè¯•é…ç½®ï¼Œç±»å‹é€‰æ‹©GDB Hardware Debugã€‚\nåœ¨Debuggeré€‰é¡¹æ¡†ä¸­GDBå‘½ä»¤è¾“å…¥arm-none-eabi-gdbã€‚å‹¾é€‰Use remote targetï¼ŒDebug serveré€‰æ‹©Generic Serial, åè®®é€‰æ‹©extended-remoteï¼Œç«¯å£é€‰æ‹©BMPçš„ä¸²å£å·(ä¾‹å¦‚\\\\.\\COM21 or COM6)ã€‚\nåœ¨Startupé€‰é¡¹æ¡†ä¸­åˆå§‹å‘½ä»¤è¾“å…¥ï¼šmon tpwr enablemon freq 900kmonitor swdp_scanattach 1\nå¦‚æœä»…è°ƒè¯•ä¸ä¸‹è½½ç¨‹åºåˆ™ä¸å‹¾é€‰load imageã€‚å¯ä»¥ä¸ºä¸‹è½½å•ç‹¬å»ºç«‹ä¸€ä¸ªé…ç½®ï¼Œå¦åˆ™æ¯æ¬¡ä¸‹è½½éƒ½è¦æ‰§è¡Œä¸€éä¸‹è½½åŠ¨ä½œ(å½±å“èŠ¯ç‰‡Flashå¯¿å‘½å’Œè°ƒè¯•çš„é€Ÿåº¦)ã€‚\nå‹¾é€‰Set breakpoint at, åé¢è¾“å…¥mainã€‚è¡¨ç¤ºåœ¨mainå‡½æ•°å»ºç«‹ä¸€ä¸ªé»˜è®¤æ–­ç‚¹ã€‚åœ¨ä¸‹é¢çš„å‘½ä»¤æ¡†ä¸­å†è¾“å…¥runæŒ‡ä»¤ï¼Œè¿™æ ·å¯ä»¥æ¯æ¬¡å¯åŠ¨è°ƒè¯•éƒ½ä¼šå¤ä½ä¸€æ¬¡ç¨‹åºï¼Œå¦‚æœä¸æƒ³å¤ä½åˆ™ä¸è¾“å…¥ã€‚\nä¿å­˜è¯¥é…ç½®å³å¯å¼€å§‹è°ƒè¯•ã€‚\nåœ¨VSCODEä¸­è°ƒè¯•æˆ‘æœ€å¼€å§‹çš„æƒ³æ³•æ˜¯ä½¿ç”¨VSCODEä¸­åŸç”Ÿçš„è°ƒè¯•ç»„ä»¶ï¼Œä½†æ˜¯åœ¨è¿›è¡Œäº†ä¸€äº›å°è¯•åå‘ç°Native Debugå­˜åœ¨ä¸€äº›é—®é¢˜ã€‚è¿™ä¼¼ä¹æ˜¯cppdbgä¸å¤ªå…¼å®¹ä¸²å£è¿œç¨‹è°ƒè¯•ï¼Œåœ¨æ‰§è¡Œé™„åŠ è¿›ç¨‹æ—¶ä¼šå‡ºç°ä¸€äº›æ•…éšœï¼Œå¯èƒ½æ˜¯GDB serveräº¤äº’å­˜åœ¨ä¸€äº›å…¼å®¹æ€§é—®é¢˜ã€‚æˆ‘åœ¨æ£€ç´¢ç›¸å…³èµ„æ–™æ—¶ä¹Ÿå‘ç°å…¶å®ƒç½‘å‹å­˜åœ¨è¯¥é—®é¢˜ã€‚\nè¿™ä¸ªæ— æ³•ä½¿ç”¨çš„è°ƒè¯•é…ç½®ä¹Ÿå¯ä»¥å‚è€ƒï¼š\n&#123;    &quot;name&quot;: &quot;Black Magic Probe(invalid)&quot;,    &quot;type&quot;: &quot;cppdbg&quot;,    &quot;request&quot;: &quot;launch&quot;,    &quot;cwd&quot;: &quot;$&#123;workspaceRoot&#125;&quot;,    &quot;MIMode&quot;: &quot;gdb&quot;,    &quot;targetArchitecture&quot;: &quot;arm&quot;,    &quot;logging&quot;: &#123;&quot;engineLogging&quot;: true&#125;,    &quot;program&quot;: &quot;$&#123;workspaceRoot&#125;/Debug/$&#123;workspaceFolderBasename&#125;.elf&quot;,    &quot;miDebuggerPath&quot;: &quot;arm-none-eabi-gdb&quot;,    &quot;customLaunchSetupCommands&quot;: [        &#123;&quot;text&quot;: &quot;cd $&#123;workspaceRoot&#125;/Debug&quot;&#125;,        &#123;&quot;text&quot;: &quot;file $&#123;workspaceFolderBasename&#125;.elf&quot;&#125;,        &#123;&quot;text&quot;: &quot;target extended-remote \\\\\\\\.\\\\COM23&quot;&#125;,        &#123;&quot;text&quot;: &quot;monitor tpwr enable&quot;&#125;,        &#123;&quot;text&quot;: &quot;mon freq 500k&quot;&#125;,        &#123;&quot;text&quot;: &quot;monitor swdp_scan&quot;&#125;,        &#123;&quot;text&quot;: &quot;attach 1&quot;&#125;,        &#123;&quot;text&quot;: &quot;load&quot;&#125;,        &#123;&quot;text&quot;: &quot;cd $&#123;workspaceRoot&#125;&quot;&#125;,        &#123;&quot;text&quot;: &quot;set mem inaccessible-by-default off&quot;&#125;,        &#123;&quot;text&quot;: &quot;break main&quot;&#125;    ],    &quot;serverLaunchTimeout&quot;: 10000,    &quot;windows&quot;: &#123;        &quot;miDebuggerPath&quot;: &quot;arm-none-eabi-gdb.exe&quot;    &#125;&#125;\n\næ— æ³•ä½¿ç”¨åŸç”Ÿè°ƒè¯•ï¼Œé‚£å°±åªæœ‰ä¾èµ–äºVSCODEæ’ä»¶ï¼Œå¾ˆæµè¡Œçš„ä¸€ä¸ªè°ƒè¯•æ’ä»¶cortex-debugæ”¯æŒBlack Magic Probeï¼Œè¿™é‡Œåˆ—å‡ºä¸‹è½½è„šæœ¬å’Œè°ƒè¯•è„šæœ¬ã€‚\n&#123;    // Use IntelliSense to learn about possible attributes.    // Hover to view descriptions of existing attributes.    &quot;version&quot;: &quot;0.2.0&quot;,    &quot;configurations&quot;: [        &#123;            &quot;name&quot;: &quot;BMP Download&quot;,            &quot;cwd&quot;: &quot;$&#123;workspaceFolder&#125;&quot;,            &quot;executable&quot;: &quot;$&#123;workspaceRoot&#125;/Debug/$&#123;workspaceFolderBasename&#125;.elf&quot;,            &quot;request&quot;: &quot;launch&quot;,            &quot;type&quot;: &quot;cortex-debug&quot;,            &quot;device&quot;: &quot;&quot;,            &quot;runToEntryPoint&quot;: &quot;main&quot;,            &quot;showDevDebugOutput&quot;: &quot;raw&quot;,            &quot;servertype&quot;: &quot;bmp&quot;,            &quot;interface&quot;: &quot;swd&quot;,            &quot;BMPGDBSerialPort&quot;: &quot;\\\\\\\\.\\\\COM23&quot;,            &quot;powerOverBMP&quot;: &quot;enable&quot;,            &quot;preLaunchCommands&quot;: [&quot;mon freq 500k&quot;]        &#125;,        &#123;            &quot;name&quot;: &quot;BMP Debug&quot;,            &quot;cwd&quot;: &quot;$&#123;workspaceFolder&#125;&quot;,            &quot;executable&quot;: &quot;$&#123;workspaceRoot&#125;/Debug/$&#123;workspaceFolderBasename&#125;.elf&quot;,            &quot;request&quot;: &quot;attach&quot;,            &quot;type&quot;: &quot;cortex-debug&quot;,            &quot;device&quot;: &quot;&quot;,            &quot;runToEntryPoint&quot;: &quot;main&quot;,            &quot;showDevDebugOutput&quot;: &quot;raw&quot;,            &quot;servertype&quot;: &quot;bmp&quot;,            &quot;interface&quot;: &quot;swd&quot;,            &quot;BMPGDBSerialPort&quot;: &quot;\\\\\\\\.\\\\COM23&quot;,            &quot;powerOverBMP&quot;: &quot;enable&quot;,            &quot;preAttachCommands&quot;: [&quot;mon freq 500k&quot;]        &#125;    ]&#125;\n\nBlack Magicè¿˜æ”¯æŒRTTåŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨postAttachCommandsé€‰é¡¹å»æ‰‹åŠ¨å¼€å¯ï¼Œæˆ‘ç®€å•æµ‹è¯•äº†ä¸€ä¸‹ï¼Œä¼¼ä¹ä¼šå½±å“è°ƒè¯•åŠŸèƒ½ã€‚\nPS:cortex-debugå‚æ•°è¯´æ˜\næ€»ç»“Black Magic Probeéå¸¸çš„çµæ´»å¥½ç”¨ï¼Œä¸ä¾èµ–ç‰¹åˆ«çš„é©±åŠ¨ï¼Œæ”¯æŒä¸»æµçš„ä¸‰å¤§æ“ä½œç³»ç»Ÿï¼Œä¸”ä¸éœ€è¦ç±»ä¼¼openocdçš„ä¸­é—´é€‚é…å±‚å°±èƒ½å®ç°å®Œæ•´çš„åµŒå…¥å¼è°ƒè¯•ã€‚\nç›¸è¾ƒäºJlinkç­‰è°ƒè¯•å™¨æ¥è¯´ï¼Œå®ƒçš„æ€§èƒ½ä¸ç®—ç‰¹åˆ«å¼ºå¤§ï¼Œä½†å®ƒå¯ä»¥å’ŒGDBè°ƒè¯•å™¨ç›´æ¥äº¤äº’ï¼Œä½¿å¾—å®ƒçš„çµæ´»æ€§æ›´å¼ºã€‚\nç›®å‰è¯¥è°ƒè¯•å™¨çš„ç¼ºé™·æ˜¯é€Ÿåº¦é—®é¢˜ï¼ŒUSB2.0FSåœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šå‡ºç°ä¸€äº›æ„å¤–çš„æƒ…å†µã€‚åç»­æˆ‘æƒ³åˆ¶ä½œä¸€ä¸ªé«˜é€Ÿç‰ˆæœ¬çš„BMPæ¥æ”¹è¿›ä½¿ç”¨ä½“éªŒã€‚\n"},{"title":"å¦™ä¸å¯è¨€çš„å¼‚å¸¸æ•è·æœºåˆ¶","url":"/2024/04/25/%E5%A6%99%E4%B8%8D%E5%8F%AF%E8%A8%80%E7%9A%84%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7%E6%9C%BA%E5%88%B6/","content":"ä»€ä¹ˆæ˜¯å¼‚å¸¸æ•è·å¼‚å¸¸æ•è·æ˜¯ç¨‹åºå‘˜åœ¨ç¨‹åºä¸­æ•è·å¼‚å¸¸çš„ä¸€ç§æ–¹å¼ï¼Œå¼‚å¸¸æ•è·å¯ä»¥é¿å…ç¨‹åºå´©æºƒï¼Œè®©ç¨‹åºç»§ç»­è¿è¡Œã€‚å½“ç¨‹åºçš„è¿è¡Œç¯å¢ƒæ”¶åˆ°å¼‚å¸¸ä¿¡æ¯åï¼Œä¼šè‡ªåŠ¨å¯»å€å¤„ç†è¯¥å¼‚å¸¸çš„catchå—å¤„ç†è¯¥å¼‚å¸¸ï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºå¼‚å¸¸æ•è·ã€‚\nå¤§éƒ¨åˆ†é«˜çº§çš„ç¼–ç¨‹è¯­è¨€éƒ½æä¾›äº†å¼‚å¸¸æ•è·æœºåˆ¶ï¼Œå¦‚Javaã€C++ã€Pythonç­‰ã€‚Cè¯­è¨€ä¸æä¾›å¼‚å¸¸æ•è·æœºåˆ¶ï¼Œå°¤å…¶æ˜¯åœ¨åµŒå…¥å¼å¼€å‘ä¸­ï¼ŒCè¯­è¨€çš„å¼‚å¸¸æ•è·æœºåˆ¶éå¸¸å¼±ï¼Œè€Œä¸”å®¹æ˜“å¯¼è‡´ç¨‹åºå´©æºƒã€‚æ‰€æœ‰ä¸€èˆ¬MCUæä¾›äº†é”™è¯¯æ£€æµ‹æœºåˆ¶ï¼Œå¦‚ï¼šHardFaultç­‰ä¸­æ–­ï¼Œä½†æ˜¯è¿™äº›ä¸­æ–­æ˜¯ç›´æ¥å¯¼è‡´ç¨‹åºå´©æºƒçš„ï¼Œè€Œä¸æ˜¯å¼‚å¸¸æ•è·æœºåˆ¶ã€‚\næœ¬æ–‡æä¾›äº†ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥æ•è·Cè¯­è¨€ä¸­çš„å¼‚å¸¸ï¼Œå¹¶ä¸”å¯ä»¥è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†è¿‡ç¨‹ï¼Œå¯ä»¥åˆ°è¾¾åŒä¸€èˆ¬å¼‚å¸¸æ•è·æœºåˆ¶ç›¸ä¼¼çš„æ•ˆæœã€‚\nå¼‚å¸¸æ•è·çš„åŸºæœ¬åŸç†é€šè¿‡tryè¯­å¥æ ‡è®°æ•è·å¼‚å¸¸çš„ä»£ç ï¼Œé€šè¿‡catchè¯­å¥æ ‡è®°å¼‚å¸¸å¤„ç†ä»£ç ã€‚æ‰€ä»¥åœ¨æ‰§è¡Œtryè¯­å¥æ—¶ï¼Œéœ€è¦ä¿å­˜ç¨‹åºä¸Šä¸‹æ–‡çš„ä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨catchè¯­å¥ä¸­æ¢å¤æ‰§è¡Œã€‚ä¿å­˜ä¸Šä¸‹æ–‡çš„è¿‡ç¨‹æ ¹æ®ä¸åŒçš„å¤„ç†å™¨æ¶æ„æœ‰æ‰€ä¸åŒï¼Œä½†åŸºæœ¬æ€è·¯æ˜¯ä¿å­˜å¤„ç†å™¨å¯„å­˜å™¨ã€å †æ ˆæŒ‡é’ˆã€å †æ ˆå†…å®¹ç­‰ã€‚\nå¦‚ä½•ä¿å­˜ä¸Šä¸‹æ–‡ä¿¡æ¯è¿™é‡Œé€šè¿‡ç‰¹å®šçš„å¤„ç†å™¨æ¥è¯´æ˜ä¸Šä¸‹æ–‡ä¿¡æ¯æ˜¯å¦‚ä½•ä¿å­˜çš„ï¼Œä»¥Cortex-M7èŠ¯ç‰‡ä¸ºä¾‹ï¼Œå…¶å®ƒçš„èŠ¯ç‰‡çš„å®ç°æ–¹å¼ç±»ä¼¼ã€‚ä¸Šä¸‹æ–‡ä¿¡æ¯åŒ…æ‹¬ï¼šå¯„å­˜å™¨ã€æ ˆæŒ‡é’ˆã€LRã€PCã€PSRã€‚å…¶ä¸­å¯„å­˜å™¨éœ€è¦æ ¹æ®AAPCSè§„èŒƒæ¥å¤„ç†ï¼Œå³ä¸»è¦ä¿å­˜è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨ï¼ŒåŒ…æ‹¬R4-R11ã€‚è°ƒç”¨è€…çš„å¯„å­˜å™¨åœ¨å¤–å±‚æ ˆå¸§ä¸­å·²ç»å¤„ç†è¿‡äº†ï¼Œæ‰€ä»¥ä¸éœ€è¦ä¿å­˜ã€‚æ ˆæŒ‡é’ˆä¸ºSPå¯„å­˜å™¨ã€‚ç¨‹åºæŒ‡é’ˆè¿™é‡Œå°†ä½¿ç”¨LRæŒ‡é’ˆï¼Œé€šè¿‡å®ƒå¯ä»¥å¿«é€Ÿè¿”å›åˆ°å¼‚å¸¸è°ƒç”¨çš„å‡ºå£ä½ç½®ã€‚\nShow code:\n.global try_save_context.type try_save_context,%function.thumb_func// typedef int try_ctx_t[10];// int try_save_context(try_ctx_t ctx);try_save_context:    push &#123;r0, lr&#125;    mov r2, r0    mov r0, #0    mov r1, #0    bl vTaskSetThreadLocalStoragePointer    pop &#123;r0, lr&#125;    mov ip, sp    stmia.w r0!, &#123;r4, r5, r6, r7, r8, r9, sl, fp, ip, lr&#125;    mov r0, 0    bx lr\nè¿™é‡Œå®ç°äº†ä¸€ä¸ªä¿å­˜ä¸Šä¸‹æ–‡å‡½æ•°çš„æ¥å£ï¼Œç”¨æˆ·ä¼ å…¥ä¸€ä¸ªtry_ctx_tç»“æ„ä½“æŒ‡é’ˆï¼Œä¿å­˜ä¸Šä¸‹æ–‡ã€‚è¯¥æŒ‡é’ˆå°†ä¿å­˜åˆ°FreeRTOSçš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¸­ï¼Œæ–¹ä¾¿åç»­æ¢å¤ä¸Šä¸‹æ–‡ã€‚å°†å¤„ç†å™¨çš„r4ã€r5ã€r6ã€r7ã€r8ã€r9ã€slã€fpã€ipã€lrä¿å­˜åˆ°try_ctx_tç»“æ„ä½“ä¸­ã€‚æœ€åå‡½æ•°è¿”å›0è¡¨ç¤ºä¸Šä¸‹æ–‡ä¿å­˜å®Œæˆã€‚\nå¯¹äºéRTOSçš„ç”¨æˆ·ï¼Œè¿™é‡Œçš„ä»£ç éœ€è¦åšç›¸åº”çš„è°ƒæ•´ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„å…¨å±€å˜é‡æ¥å­˜å‚¨ctxï¼Œè¿™é‡Œå°±ä¸å†è¯¦ç»†ä»‹ç»äº†ã€‚åç»­çš„æ•´ä¸ªå®ç°éƒ½æ˜¯åŸºäºFreeRTOSæ¥å®ç°çš„ã€‚\nå¦‚ä½•åœ¨ä¸­æ–­å†…æ¢å¤åˆ°ç”¨æˆ·çº¿ç¨‹çš„ä¸Šä¸‹æ–‡è¿™æ˜¯æ•´ä¸ªå¼‚å¸¸æ•è·æœºåˆ¶ä¸­æœ€å¤æ‚çš„éƒ¨åˆ†ã€‚å½“å¤„ç†å™¨è¿›å…¥ä¸­æ–­åå¤„äºhandleæ¨¡å¼ï¼Œè€Œç”¨æˆ·çš„çº¿ç¨‹å¤„äºuseræ¨¡å¼ã€‚ä¸¤è€…æ²¡æœ‰åœ¨åŒä¸€ä¸ªä¸Šä¸‹è¿è¡Œç©ºé—´å†…ã€‚å¦‚ä½•æ¢å¤åˆ°ç”¨æˆ·çº¿ç¨‹çš„ä¸Šä¸‹æ–‡å‘¢ï¼Ÿ\nåŸºæœ¬æ€è·¯æ˜¯ä»FreeRTOSçš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¸­è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç„¶åå°†å…¶ä¸­ä¸»è¦çš„å¯„å­˜å™¨æ¢å¤åˆ°å¤„ç†å™¨å¯„å­˜å™¨ä¸­ã€‚ç„¶ååœ¨ç”¨æˆ·çº¿ç¨‹ä¸­æ¨¡æ‹Ÿä¸€ä¸ªä¸­æ–­æ ˆæ¥ä¿è¯å½“å‰çš„handleä¸­æ–­èƒ½å¤Ÿæ­£å¸¸é€€å‡ºï¼Œä½¿å¾—ç”¨æˆ·è¿”å›åˆ°çº¿ç¨‹æ¨¡å¼åèƒ½å¤Ÿç»§ç»­æ‰§è¡Œï¼Œä¸”ç”¨æˆ·æ ˆå’Œä¸­æ–­æ ˆéƒ½æ»¡è¶³å¹³è¡¡çš„è¦æ±‚ã€‚\nShow code:\n#define FAULT_THROW()                                                                           \\    &#123;                                                                                           \\        __asm volatile(                                                                         \\            &quot;dsb \\n isb                     \\n&quot;                                                 \\            &quot;push &#123;r0, r1, r2, r3, r12, lr&#125; \\n&quot;                                                 \\            &quot;tst lr, #4                     \\n&quot;                                                 \\            &quot;beq .end&quot; END_LINE &quot;           \\n&quot; /* Can&#x27;t try in Handle mode */                  \\            &quot;mov r0, #0                     \\n&quot;                                                 \\            &quot;mov r1, #0                     \\n&quot;                                                 \\            &quot;bl pvTaskGetThreadLocalStoragePointer\\n&quot; /* Get try context */                     \\            &quot;cmp r0, #0                     \\n&quot;                                                 \\            &quot;beq .end&quot; END_LINE &quot;           \\n&quot;                                                 \\            &quot;mov r12, r0                    \\n&quot;                                                 \\            &quot;mov r0, #0                     \\n&quot;                                                 \\            &quot;mov r1, #0                     \\n&quot;                                                 \\            &quot;mov r2, #0                     \\n&quot;                                                 \\            &quot;bl vTaskSetThreadLocalStoragePointer\\n&quot; /* Set try context to NULL */              \\            &quot;mov r0, r12                    \\n&quot;                                                 \\            &quot;ldr r1, [r0, 32]               \\n&quot; /* get sp in context */                         \\            &quot;ldr r2, [r0, 36]               \\n&quot; /* get pc in context */                         \\            &quot;sub r1, #32                    \\n&quot; /* adjust sp for user stack frame */            \\            &quot;str r2, [r1, 24]               \\n&quot; /* save PC to the user stack frame */           \\            &quot;mov r2, #0x1000000             \\n&quot; /* xPSR, bit24 is thumb state, it&#x27;s always 1 */ \\            &quot;str r2, [r1, 28]               \\n&quot; /* save xPSR to the user stack frame */         \\            &quot;mov r2, #0x40000000            \\n&quot;                                                 \\            &quot;str r2, [r1,  0]               \\n&quot; /* R0=0x40000000, it&#x27;s the throw value */       \\            &quot;ldmia r0!, &#123;r4, r5,  r6,  r7,    &quot;                                                 \\            &quot;            r8, r9, r10, r11&#125;  \\n&quot; /* restory context */                           \\            &quot;msr psp, r1                    \\n&quot; /* restore the PSP */                           \\            &quot;isb                            \\n&quot;                                                 \\            &quot;pop &#123;r0, r1, r2, r3, r12, lr&#125;  \\n&quot; /* MSP stack balance */                         \\            &quot;orr lr, lr, #0x10              \\n&quot; /* clear floating-point flag */                 \\            &quot;isb                            \\n&quot;                                                 \\            &quot;bx lr                          \\n&quot; /* exit ISR and jump to user context */         \\            &quot;.end&quot; END_LINE &quot;:              \\n&quot;                                                 \\            &quot;pop &#123;r0, r1, r2, r3, r12, lr&#125;  \\n&quot;);                                               \\    &#125;#define _STR2(x) #x#define _STR(x) _STR2(x)#define END_LINE _STR(__LINE__)\nè¿™é‡Œå®ç°äº†ä¸€ä¸ªå®å®šä¹‰ï¼Œç”¨äºæ•è·å¼‚å¸¸ï¼Œå¹¶è·³è½¬åˆ°ç”¨æˆ·ä¸Šä¸‹æ–‡ã€‚\n\né¦–å…ˆåˆ¤æ–­è·³è½¬åˆ°è¯¥ä¸­æ–­å‰çš„å¤„ç†å™¨æ¨¡å¼ï¼Œå¦‚æœä¸æ˜¯ç”¨æˆ·æ¨¡å¼ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå› ä¸ºè¿™ä¸èƒ½æ•è·å¼‚å¸¸ã€‚\nç„¶ååˆ¤æ–­å½“å‰çº¿ç¨‹æœ¬åœ°å­˜å‚¨æŒ‡é’ˆå†…å®¹ï¼Œè¿™æ˜¯ç”¨äºä¿å­˜ä¸Šä¸‹æ–‡ä¿¡æ¯çš„æŒ‡é’ˆï¼Œå¦‚æœæŒ‡é’ˆä¸ºNULLï¼Œåˆ™è¡¨ç¤ºå½“å‰æ²¡æœ‰æ‰§è¡Œtry_save_contextï¼Œæ‰€ä»¥ç›´æ¥è¿”å›ã€‚\nå¦‚æœæŒ‡é’ˆä¸ä¸ºNULLï¼Œåˆ™è¡¨ç¤ºå½“å‰æ‰§è¡Œäº†try_save_contextã€‚åŒæ—¶æ¸…ç©ºçº¿ç¨‹æœ¬åœ°å­˜å‚¨æŒ‡é’ˆï¼Œè¡¨ç¤ºå½“å‰çš„å¼‚å¸¸å·²ç»è¢«å¤„ç†äº†ã€‚\nä»ä¸Šä¸‹æ–‡ä¿¡æ¯ä¸­å–å‡ºspæŒ‡é’ˆï¼Œä»¥æ¬¡ä¸ºåŸºç¡€æ„é€ ä¸€ä¸ªä¸­æ–­æ ˆï¼Œè¿™æ˜¯ä¸ºäº†å½“å‰çš„ä¸­æ–­èƒ½å¤Ÿæ­£å¸¸è¿”å›è€Œå¿…è¦çš„ã€‚â€sub r1, #32â€\nåœ¨è°ƒæ•´çš„æ ˆä¸­ä¿å­˜PCæŒ‡é’ˆ(å³åŸä¸Šä¸‹æ–‡ä¸­çš„LRå¯„å­˜å™¨)ï¼Œæ„é€ ä¸€ä¸ªåˆæ³•çš„PSRå¯„å­˜å™¨ï¼ŒPSRå¯„å­˜å™¨ä¸­ä¸éœ€è¦æµ®ç‚¹æ ‡å¿—ä½ã€æ ˆå¯¹é½ç­‰ä¿¡æ¯ï¼Œåªéœ€è¦å¤„ç†å™¨æ¨¡å¼ä¸ºthumbæ¨¡å¼å³å¯ã€‚\nä»ä¸Šä¸‹æ–‡ä¿¡æ¯ä¸­å–å‡ºr4-r11çš„å€¼ï¼Œä¾æ¬¡æ¢å¤åˆ°å„ä¸ªå¯„å­˜å™¨ä¸­ã€‚\né€šè¿‡msræŒ‡ä»¤å°†æ–°çš„æ ˆæŒ‡é’ˆå†™å…¥åˆ°pspä¸­ã€‚\né€šè¿‡lrå¯„å­˜å™¨é€€å‡ºå½“å‰çš„ä¸­æ–­ã€‚ç‰¹åˆ«æ³¨æ„ï¼Œéœ€è¦å°†lrå¯„å­˜å™¨çš„æµ®ç‚¹ä¸Šä¸‹æ–‡æ ‡å¿—æ¸…é™¤ã€‚\n\nå½“å¤„ç†å™¨æ‰§è¡Œbx lræ—¶ï¼Œå¤„ç†å™¨æ ¹æ®è¿è¡Œæ¨¡å¼ä»pspä¸­å–å‡ºr0-r3çš„å€¼æ¢å¤çš„å¤„ç†å™¨ä¸Šï¼ŒåŒæ—¶å–å‡ºPCå¯„å­˜å™¨è·³è½¬åˆ°ç”¨æˆ·ç¨‹åºä¸­ï¼Œè¿™æ ·å°±å®Œæˆäº†ä»ä¸­æ–­ä¸Šä¸‹æ–‡æ¢å¤åˆ°åº”ç”¨ç¨‹åºçš„ä¸Šä¸‹æ–‡ã€‚è¿™é‡Œæ¶‰åŠåˆ°äº†å¤§é‡Cortex-Må¤„ç†å™¨çš„ä¸­æ–­å¤„ç†æœºåˆ¶ç›¸å…³å†…å®¹ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚\ntryè¯­æ³•ç³–å‰é¢å®ç°äº†ç”¨æˆ·çº¿ç¨‹çš„ä¿æŠ¤å’Œæ¢å¤ï¼Œå·²ç»å°±èƒ½å¤Ÿå®ç°å¼‚å¸¸æ•è·äº†ï¼Œç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š\nvoid test_func(void)&#123;    try_ctx_t ctx;    if(try_save_context(ctx) == 0)&#123;        printf(&quot;test_func\\n&quot;);        // do something        illegal_function_execution(); // Trigger exception        printf(&quot;never run here\\n&quot;);    &#125;else&#123;        printf(&quot;catch test_func exception\\n&quot;);    &#125;&#125;void test_func2(void)&#123;    _try&#123;        printf(&quot;test_func\\n&quot;);        // do something        illegal_function_execution(); // Trigger exception        printf(&quot;never run here\\n&quot;);    &#125;    _catch&#123;        printf(&quot;catch test_func exception\\n&quot;);    &#125;&#125;\nå°†test_funcå‡½æ•°åŒ…è£…ä¸ºtest_func2å‡½æ•°ï¼Œéœ€è¦å®ç°ä¸¤ä¸ªè¯­æ³•ç³–ï¼š_tryã€_catchã€‚\nint try_save_context(try_ctx_t ctx);void try_clear_context(void);#define _try                                             \\    try_ctx_t CONNECT(__ctx, __LINE__);                  \\    if (try_save_context(CONNECT(__ctx, __LINE__)) == 0) \\    &#123;#define _catch           \\    try_clear_context(); \\    &#125;                    \\    else#define CONNECTION(text1, text2) text1##text2#define CONNECT(text1, text2) CONNECTION(text1, text2)\n\nè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸ªé—®é¢˜ï¼Œå½“ç”¨æˆ·ç¨‹åºæœªå‡ºç°å¼‚å¸¸æ—¶ï¼Œéœ€è¦ä¸»åŠ¨è°ƒç”¨try_clear_contextå‡½æ•°ï¼Œè¿™æ ·æ‰èƒ½å°†å½“å‰tryçš„ä¸Šä¸‹æ–‡ç¯å¢ƒæ¸…é™¤æ‰ï¼Œå¦åˆ™tryçš„è¾¹ç•Œä¸æ¸…æ™°ï¼Œå¯¼è‡´å¼‚å¸¸æ•è·æœºåˆ¶å‡ºç°æ··ä¹±ã€‚\nè¿™é‡Œè¿˜éœ€è¦æ³¨æ„çš„æ˜¯è¯¥è¯­æ³•ç³–ä¸æ”¯æŒexæ¶ˆæ¯ä¼ é€’ã€‚æˆ‘æœ€å¼€å§‹è®¾è®¡çš„æ—¶å€™æ˜¯æƒ³è¦å–å¾—è¯¥æ¶ˆæ¯çš„ï¼Œä½†æ˜¯åæ¥åœ¨è®¾è®¡è¯¥è¯­æ³•ç»“æ„æ—¶å‘ç°è¿™éœ€è¦ä½¿ç”¨finialå—ï¼Œä½†æ˜¯finialå—çš„æ„ä¹‰å¹¶ä¸å¤§ï¼Œä¸”ä¼šå¯¼è‡´è¯¥è¯­æ³•ç³–å˜å¾—å¤æ‚ï¼Œæ‰€ä»¥è¯¥è¯­æ³•ç³–ä¸æ”¯æŒexæ¶ˆæ¯ä¼ é€’ã€‚æ­¤å¤–è¿˜éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯tryè¯­å¥ä¸èƒ½ç‹¬ç«‹å‡ºç°ï¼Œå®ƒå¿…é¡»å’Œcatchè¯­å¥ä¸€èµ·å‡ºç°ã€‚\nåœ¨ä½¿ç”¨è¯¥è¯­æ³•ç³–æ—¶ï¼Œè¿˜éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ—¶ï¼Œåœ¨tryè¯­å¥å—ä¸­ä¸èƒ½ç›´æ¥å‡ºç°returnè¯­å¥ã€‚returnè¯­å¥ä¼šç ´åtryçš„è¾¹ç•Œï¼Œå¯¼è‡´å¼‚å¸¸æ•è·æœºåˆ¶çš„æ··ä¹±ã€‚ä½†æ˜¯åœ¨catchè¯­å¥ä¸­å¯ä»¥ä½¿ç”¨returnã€‚\nä»ç”¨æˆ·ç©ºé—´æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ä¹Ÿæ˜¯ä¸€ä¸ªæœ‰æ„æ€çš„è®¾è®¡ã€‚\n.global try_clear_context.type try_clear_context,%function.thumb_func// void try_clear_context(void)try_clear_context:    push &#123;lr&#125;    mov r0, #0    mov r1, #0    mov r2, #0    bl vTaskSetThreadLocalStoragePointer    pop &#123;pc&#125;.global _throw.type _throw,%function.thumb_func// void _throw(int ex)_throw:    push &#123;r0, lr&#125;    mov r0, #0    mov r1, #0    bl pvTaskGetThreadLocalStoragePointer    cmp r0, #0    beq .end_throw    mov r12, r0    mov r0, #0    mov r1, #0    mov r2, #0    bl vTaskSetThreadLocalStoragePointer    pop &#123;r0, lr&#125;    mov r1, r12    ldmia r1!, &#123;r4, r5, r6, r7, r8, r9, r10, r11, r12, lr&#125;    mov sp, r12    cmp r0, #0    it eq    moveq r0, #1    isb    bx lr.end_throw:    pop &#123;r0, pc&#125;\nåœ¨ç”¨æˆ·ç©ºé—´è°ƒç”¨_throwå¯ä»¥ä¸»åŠ¨æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œexä¸ºä¸€ä¸ªéé›¶çš„å¼‚å¸¸ç¼–å·ã€‚\ntryåµŒå¥—é—®é¢˜æˆ‘æœ€å¼€å§‹æ˜¯æƒ³è¦è®¾è®¡å¼‚å¸¸æ•è·åµŒå¥—çš„ï¼Œå› ä¸ºè¿™ä¸æ˜¯ä¸€ä¸ªå¤æ‚çš„æŠ€æœ¯é—®é¢˜ï¼Œä¸€ä¸ªé“¾å¼ç»“æ„å°±èƒ½å¤Ÿå®ç°ã€‚æˆ‘ä¹‹æ‰€ä»¥é€‰æ‹©æ”¾å¼ƒè¿™éƒ¨åˆ†å®ç°çš„åŸå› æ˜¯ï¼Œæˆ‘æ‹…å¿ƒè¿™ä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ã€‚å› ä¸ºCè¯­è¨€æœ¬èº«ä¸æ”¯æŒåƒåœ¾å›æ”¶ï¼Œæ»¥ç”¨å¼‚å¸¸æ•è·æœºåˆ¶å¯èƒ½ä¼šå¯¼è‡´èµ„æºæ³„æ¼çš„é£é™©ï¼Œæ‰€ä»¥æˆ‘æ”¾å¼ƒäº†å¼‚å¸¸æ•è·åµŒå¥—çš„åŠŸèƒ½ã€‚è¿™é‡Œå®ç°çš„å¼‚å¸¸æ•è·æœºåˆ¶ä¹Ÿè®¸æ›´é€‚åˆä¸€ä¸ªæ•…éšœåˆ†æçš„åœºæ™¯ï¼Œæˆ–è€…ç”¨äºå¯¹ä¸€äº›å…³é”®ä»£ç è¿›è¡Œä¿æŠ¤ã€‚\næµ®ç‚¹å¯„å­˜å™¨ç›¸å…³é—®é¢˜è¿™é‡Œçš„è®¾è®¡æ²¡æœ‰è€ƒè™‘ä¿å­˜æµ®ç‚¹ä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨çš„æ—¶å€™éœ€è¦ç‰¹åˆ«æ³¨æ„ç”¨æ³•ç¯å¢ƒã€‚æ­¤å¤–å¯¹äºæƒ°æ€§å‹æ ˆæœºåˆ¶ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨DSBã€ISBæŒ‡ä»¤è¿›è¡Œå¤„ç†ï¼Œç¡®ä¿æµ®ç‚¹æ•°çš„ä¸­æ–­å‹æ ˆæ­£å¸¸ï¼Œä½†æˆ‘å¯¹è¿™ä¸€å—çš„å…·ä½“ç»†èŠ‚ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œæ‰€ä»¥éœ€è¦è¿›ä¸€æ­¥ç ”ç©¶ã€‚\næ€»ç»“æˆ‘æœ€å¼€å§‹æƒ³è¦è¯¥åŠŸèƒ½çš„åŸå› æ˜¯æˆ‘åœ¨æ‰§è¡Œä¸€äº›ç¬¬ä¸‰æ–¹çš„ä»£ç æ—¶ç»å¸¸å‡ºç°hardæ•…éšœï¼Œæˆ‘éœ€è¦å¯¹è¿™äº›ä¸å¯ä¿¡ä»£ç çš„æ‰§è¡Œåšä¸€ä¸ªä¿æŠ¤ï¼Œäºæ˜¯å†™äº†ä¸€ä¸ªç®€å•çš„å¼‚å¸¸æ•è·æœºåˆ¶ï¼Œå°†å¼‚å¸¸æ•è·åè¿”å›ä¸€ä¸ªé”™è¯¯ç ï¼Œç„¶åæ ¹æ®é”™è¯¯ç æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•ã€‚å¯¹äºå¤šä»»åŠ¡ç¯å¢ƒï¼Œæ•…éšœæ—¶ç›´æ¥å°†MCUæŒ‚èµ·å¯èƒ½å¸¦æ¥ä¸€äº›é¢å¤–çš„é£é™©ï¼Œå› ä¸ºæŸäº›å…³é”®ä»»åŠ¡ç¨‹åºä¸èƒ½ä¸­æ–­è¿è¡Œã€‚è¿™ä¸ªå¼‚å¸¸æ•è·ç¨‹åºå¾ˆå¥½çš„è§£å†³äº†è¿™æ–¹é¢çš„é—®é¢˜ã€‚\næµ‹è¯•é™„ä»¶int devide_zero(void)&#123;    int r;    volatile unsigned int a;    volatile unsigned int b;    SCB-&gt;CCR |= SCB_CCR_DIV_0_TRP_Msk;    a = 1;    b = 0;    r = a / b;    return r;&#125;int main_test()&#123;    _try&#123;        printf(&quot;devide zero test\\n&quot;);        // å¯¹äºä¸€èˆ¬çš„MCUï¼Œæ‰§è¡Œè¯¥å‡½æ•°ä¼šå¯¼è‡´HardFaultå¼‚å¸¸ï¼Œä½¿å¤„ç†å™¨åœæœºã€‚        // ä½†è¿™é‡Œçš„å¼‚å¸¸æ•è·æœºåˆ¶ä¼šä½¿å¾—ç¨‹åºèƒ½å¤Ÿç»§ç»­è¿è¡Œã€‚        devide_zero();    &#125;    _catch&#123;        printf(&quot;catch devide zero fault\\n&quot;);    &#125;    printf(&quot;mcu not stop\\n&quot;);    return 0;&#125;void HardFault_Handler(void)&#123;    FAULT_THROW();    while(1);&#125;\n\nRun output:\ndevide zero testcatch devide zero faultFault Analysis:Exception id: 3Systick: 25857Core register:R0:  00000001  R1:  00000000  R2:  e000ed00  R3:  00000000R4:  900ad014  R5:  24018140  R6:  900ad014  R7:  20003db0R8:  00000001  R9:  900ad014  R10: 00000000  R11: 24015180R12: fa000000  SP:  20003d48  LR:  9007f63f  PC:  9001905cPSR: 61000000  ERT: fffffffd  (PSP / User)Usage Fault:  Divide by zeroHard Fault:  Forced Hard FaultStack memory:20003d48: 00000000 00000001 900ad008 9007a61520003d58: 900ad008 24018140 900ad014 20003db020003d68: 00000001 900ad014 00000000 2401518020003d78: 20003d58 9007a609 00000001 900ad01420003d88: 24018140 00000000 00000000 a5a5a5a520003d98: a5a5a5a5 9007a969 00000001 a5a5a5a520003da8: a5a5a5a5 0da5a5a5 24018140 0000000020003db8: 00000000 00000000 00000000 0000000020003dc8: 00000000 00000000 00000000 0000000020003dd8: 00000000 00000000 00000000 0000000020003de8: 00000000 00000000 00000000 0000000020003df8: 00000000 00000000 00000000 0000000020003e08: 00000000 00000000 a5a5a5a5 a5a5a5a520003e18: a5a5a5a5 a5a5a5a5 a5a5a5a5 a5a5a5a520003e28: a5a5a5a5 a5a5a5a5 a5a5a5a5 900834f520003e38: a5a5a5a5 a5a5a5a5 20003d4c 00006501Call stack backtrack:[9001905c] call from &lt;9007f63f&gt;, sp=20003d4c[9007f63f] call from &lt;9007a615&gt;, sp=20003d54[9007a615] call from &lt;9007a969&gt;, sp=20003d9c[9007a969] call from &lt;900834f5&gt;, sp=20003e34Show fault ASM code:9001904a: f043 0310   orr     r3, r3, #169001904e: 6153        str     r3, [r2, #20]90019050: 2301        movs    r3, #190019052: 9301        str     r3, [sp, #4]90019054: 2300        movs    r3, #090019056: 9300        str     r3, [sp, #0]90019058: 9801        ldr     r0, [sp, #4]9001905a: 9b00        ldr     r3, [sp, #0] &lt;break point&gt;9001905c: fbb0 f0f3   udiv    r0, r0, r390019060: b002        add     sp, #890019062: 4770        bx      lr90019064: ed00 e000   stc     0, cr14, [r0, #0]!90019068: b500        push    &#123;lr&#125;9001906a: b083        sub     sp, #129001906c: 9200        str     r2, [sp, #0]9001906e: 460a        mov     r2, r1mcu not stop\nç»è¿‡æµ‹è¯•ï¼Œè¯¥åŠŸèƒ½å·¥ä½œæ­£å¸¸ï¼Œé€šè¿‡åœ¨çº¿æ•…éšœè¯Šæ–­ï¼Œå·²ç»è¾“å‡ºäº†é”™è¯¯æ—¶åˆ»çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šå¯„å­˜å™¨ã€å †æ ˆã€è°ƒç”¨æ ˆã€æ•…éšœç‚¹é™„è¿‘çš„æ±‡ç¼–ä»£ç ã€‚å¯ä»¥å‘ç°break pointå·²ç»ç»™å‡ºäº†æ•…éšœå…·ä½“çš„ä½ç½®ï¼Œé…åˆå¯„å­˜å™¨ï¼Œå¯ä»¥ç¡®è®¤è¿™æ˜¯é™¤é›¶æ•…éšœã€‚\nå¦‚ä½•åœ¨å•ç‰‡æœºå†…è‡ªè¯Šæ–­ï¼Œç”Ÿæˆè¯¦ç»†çš„æ•…éšœè¯Šæ–­æŠ¥å‘Šä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„åŠŸèƒ½ï¼Œä»¥åæœ‰æ—¶é—´å†å†™ä¸€ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»ã€‚\n"},{"title":"å®ç°ç‹¬æœ‰çš„ç¡¬ä»¶é€šä¿¡æ€»çº¿","url":"/2023/05/07/%E5%AE%9E%E7%8E%B0%E7%8B%AC%E6%9C%89%E7%9A%84%E7%A1%AC%E4%BB%B6%E9%80%9A%E4%BF%A1%E6%80%BB%E7%BA%BF/","content":"èƒŒæ™¯å‰æ®µæ—¶é—´å¼€å‘äº†ä¸€ä¸ªåµŒå…¥å¼è½¯ä»¶ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªåŠŸèƒ½æ˜¯ä½¿ç”¨PWMé©±åŠ¨ä¸€ä¸ªæ— æºçš„èœ‚é¸£å™¨ï¼Œæ ¹æ®ä»¥å¾€çš„ç»éªŒæ¥çœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„åŠŸèƒ½ï¼Œä¸è¿‡åœ¨å®é™…æ“ä½œæ—¶é‡åˆ°äº†ä¸€ä¸ªå¾ˆå¤šäººå¾€å¾€éƒ½å¿½ç•¥çš„é—®é¢˜ã€‚æˆ‘ä»¬ç¡¬ä»¶é€‰æ‹©çš„å•ç‰‡æœºæ²¡æœ‰ç¡¬ä»¶PWMåŠŸèƒ½ï¼Œåªæœ‰æ™®é€šçš„å®šæ—¶å™¨ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬åªèƒ½ä½¿ç”¨å®šæ—¶å™¨+IOå£æ¨¡æ‹ŸPWMã€‚é€šè¿‡å®šæ—¶å™¨ä¸­æ–­æ“ä½œIOå£èƒ½å¤Ÿæ¨¡æ‹Ÿä¸€ä¸ªè¾ƒä¸ºå‡†ç¡®çš„PWMä¿¡å·ï¼ŒæŠŠè¿™ä¸ªä¿¡å·è¾“å‡ºåˆ°éŸ³é¢‘æ”¾å¤§ç”µè·¯å¹¶é©±åŠ¨èœ‚é¸£å™¨åï¼Œèœ‚é¸£å™¨èƒ½å¤Ÿå‘å‡ºæœŸæœ›çš„å£°éŸ³ï¼Œä½†æ˜¯å…¶ä¸­å­˜åœ¨ä¸€ç‚¹å™ªéŸ³ï¼Œèµ·åˆä»¥ä¸ºæ˜¯é©±åŠ¨ç”µè·¯å­˜åœ¨é—®é¢˜ï¼Œä½†æ˜¯ç»è¿‡æ’æŸ¥ç¡®è®¤æ˜¯å•ç‰‡æœºè¾“å‡ºçš„PWMä¿¡å·é¢‘ç‡æˆåˆ†ä¸å¹²å‡€ï¼Œé™¤äº†æœŸæœ›çš„é¢‘ç‡ä¿¡å·å¤–ï¼Œè¿˜å­˜åœ¨å…¶å®ƒé¢‘ç‡çš„ä¿¡å·ã€‚å¦‚æœä½¿ç”¨é¢‘è°±ä»ªè¿›è¡Œåˆ†æï¼Œå°±èƒ½å‘ç°å…¶ä¸­çš„æ‚æ•£æˆåˆ†ã€‚å¯¼è‡´è¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯ä¾é å› ä¸ºCPUæ§åˆ¶IOå£çš„æ—¶é—´æ˜¯ä¸å‡†ç¡®çš„ã€‚å•ç‰‡æœºå­˜åœ¨å…¶å®ƒé«˜ä¼˜å…ˆçº§çš„ä¸­æ–­ä»»åŠ¡ï¼Œå¯¼è‡´å®šæ—¶å™¨çš„ä¸­æ–­è¢«å»¶æ—¶è§¦å‘ï¼Œè¿›è€Œå¯¼è‡´PWMä¿¡å·ç”Ÿæˆä¸å‡†ç¡®ã€‚è¿™ç§è¯¯å·®éå¸¸çš„å°ï¼Œå¤§å¤šæ•°äººå¯èƒ½éƒ½æ²¡æœ‰æ³¨æ„åˆ°æ¨¡æ‹Ÿç¡¬ä»¶IOæ—¶åºä¸Šå¼•å…¥çš„è¯¯å·®ï¼Œä½†å®ƒæ˜¯å®¢è§‚å­˜åœ¨çš„ã€‚\nä½¿ç”¨è½¯ä»¶æ¨¡æ‹ŸIOæ—¶åºæ€»ä½“æ¥è¯´æ˜¯ä¸å¸¸è§çš„ï¼Œå› ä¸ºè½¯ä»¶é€šå¸¸åªèƒ½æ¨¡æ‹Ÿä¸€äº›ç®€å•çš„IICã€SPIã€PWMç­‰é€Ÿåº¦è¾ƒä½çš„ä¿¡å·ã€‚å¦‚æœä½ æƒ³ä½¿ç”¨GPIOæ¨¡æ‹Ÿå‡ ç™¾å…†æ—¶é’Ÿé¢‘ç‡çš„USBä¿¡å·ï¼Œå¤§å¤šæ•°CPUéƒ½æ˜¯æ— æ³•å®Œæˆçš„ã€‚å› ä¸ºCPUä¾§é‡äºè®¡ç®—è€Œä¸æ˜¯è¿™ç§é‡å¤ã€ç¹ççš„IOæ§åˆ¶ã€‚å½“CPUçš„æ—¶é’Ÿé¢‘ç‡è¶Šé«˜ï¼Œæ¨¡æ‹Ÿçš„æ—¶åºè¶Šå¤æ‚ï¼ŒCPUçš„è´Ÿæ‹…ä¹Ÿå°±è¶Šé‡ï¼Œè¿™ç§é¢å¤–çš„å¼€é”€å¯¹äºCPUæ¥è¯´æ˜¯éå¸¸ä¸åˆ’ç®—çš„ï¼Œæ‰€ä»¥åé¢å°±è¯ç”Ÿäº†FPGAä¹‹ç±»çš„èŠ¯ç‰‡ã€‚FPGAèŠ¯ç‰‡å‡ ä¹èƒ½å¤Ÿæ¨¡æ‹Ÿå‡ºä»»ä½•ä½ æƒ³è¦çš„ç¡¬ä»¶æ—¶åºï¼Œä½†æ˜¯åµŒå…¥å¼å¼€å‘ä¸­ä½¿ç”¨FPGAä¼šå¸¦æ¥é¢å¤–çš„é«˜æ˜‚æˆæœ¬ï¼ŒåŒæ—¶é™åˆ¶å¼€å‘äººå‘˜ä½¿ç”¨FPGAçš„å¦å¤–ä¸€ä¸ªéš¾é¢˜æ˜¯å®ƒå¤æ‚çš„å¼€å‘æ–¹å¼ã€‚\nä¸€ç§å…¨æ–°çš„æ–¹æ¡ˆ-PIO2021å¹´æ ‘è“æ´¾åŸºé‡‘ä¼šæ¨å‡ºäº†ä¸€æ¬¾æ–°çš„å¾®æ§åˆ¶å™¨-RP2040ï¼Œå…³äºè¿™æ¬¾å•ç‰‡æœºçš„è¯¦ç»†ä»‹ç»å¯ä»¥ä»å®˜ç½‘äº†è§£ã€‚å®ƒå’Œä¸€èˆ¬çš„ARMå¾®æ§åˆ¶å™¨å¤§ä½“ä¸Šå·®ä¸å¤šï¼Œä½†æ˜¯å®ƒå­˜åœ¨ä¸€ä¸ªç‰¹æ®Šçš„å¤–è®¾-PIOï¼Œè¿™æ˜¯åœ¨ä»¥å¾€çš„å•ç‰‡æœºä¸­ä»æœªå‡ºç°è¿‡çš„ï¼Œé€šè¿‡PIOå¯ä»¥ç”±ç¡¬ä»¶è‡ªåŠ¨å®ŒæˆIOå£çš„æ—¶åºæ“ä½œè€Œæ— éœ€CPUçš„å¹²é¢„ã€‚PIOèƒ½å¤Ÿç‹¬ç«‹è¿è¡Œä¸€æ®µç®€å•çš„ç¨‹åºæ¥æ§åˆ¶IOä»è€Œå®ç°ç‰¹å®šçš„ç¡¬ä»¶æ—¶åºã€‚é€šè¿‡å®ƒæ§åˆ¶IOæ˜¯éå¸¸é«˜æ•ˆçš„ï¼Œå®ƒç”šè‡³æ¯”CPUç›´æ¥æ§åˆ¶IOè¿˜è¦å¿«ã€‚\nPIOçš„ç¡¬ä»¶ç»“æ„RP2040å•ç‰‡æœºå†…æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„PIOæ¨¡å—ï¼Œæ¯ä¸ªPIOæ¨¡å—çš„ç»“æ„å¦‚ä¸‹ï¼šæ¯ä¸ªPIOæœ‰4ä¸ªçŠ¶æ€æœºï¼ŒçŠ¶æ€æœºæ˜¯æ‰§è¡ŒæŒ‡ä»¤çš„å®ä½“ã€‚4ä¸ªçŠ¶æ€æœºå…±äº«32å­—çš„æŒ‡ä»¤å­˜å‚¨ç©ºé—´ã€‚æ¯ä¸ªçŠ¶æ€æœºä¸Šè¿æ¥äº†TXRX FIFOç”¨äºä¸CPUäº¤äº’æ•°æ®ã€‚FIFOäº‹ä»¶å’ŒçŠ¶æ€æœºçš„äº‹ä»¶èƒ½å¤Ÿè§¦å‘ä¸¤ä¸ªä¸åŒçš„ä¸­æ–­ï¼Œè¿™ä¸¤ä¸ªä¸­æ–­æ˜¯ä¸¤ä¸ªPIOå…±äº«çš„ã€‚çŠ¶æ€æœºè¿˜èƒ½å¤Ÿç»‘å®šIOåˆ—è¡¨ï¼Œç”¨äºæ§åˆ¶IOå£çš„è¾“å…¥å’Œè¾“å‡ºã€‚\næ¯ä¸ªçŠ¶æ€æœºä¸Šæœ‰ä¸¤ä¸ªä½ç§»å¯„å­˜å™¨(ISRã€OSR)ï¼Œä¸»è¦ç”¨äºæ•°æ®è¾“å‡ºåˆ°IOä¸Šæˆ–è€…ä»IOä¸Šè¯»å–æ•°æ®ã€‚è¿˜æœ‰ä¸¤ä¸ªç¼“å­˜å¯„å­˜å™¨(Xã€Y)ï¼Œç”¨äºä¿å­˜ä¸´æ—¶æ•°æ®å’Œä¸€äº›ä¸­é—´çŠ¶æ€ã€‚PCå¯„å­˜å™¨è®°å½•å½“å‰çš„çŠ¶æ€æœºæ‰§è¡Œåˆ°äº†é‚£ä¸€æ¡æŒ‡ä»¤ã€‚æ­¤å¤–æ¯ä¸ªçŠ¶æ€æœºéƒ½èƒ½ç‹¬ç«‹é…ç½®æ—¶é’Ÿï¼Œ16ä½çš„æ•´æ•°åˆ†é¢‘åŠ 8ä½çš„å°æ•°åˆ†é¢‘èƒ½æ»¡è¶³å¤§å¤šæ•°æ—¶é’Ÿè¦æ±‚ã€‚\nPIOç¼–ç¨‹æŒ‡å—ç±»ä¼¼äºCè¯­è¨€ï¼ŒPIOç¼–ç¨‹ä¹Ÿæ˜¯å…ˆç¼–å†™PIOä»£ç ç„¶åä½¿ç”¨PIOASMç¼–è¯‘å™¨ç”Ÿæˆç›®æ ‡æ–‡ä»¶ã€‚ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶æ–‡ä»¶æ ¼å¼å¯ä»¥é€‰æ‹©ï¼Œä¸ºäº†æ–¹ä¾¿é›†æˆåˆ°C-SDKä¸­ï¼ŒPIOASMå·¥å…·é»˜è®¤ç”Ÿæˆ.hæ ¼å¼çš„ç›®æ ‡æ–‡ä»¶ã€‚\nPIOæºæ–‡ä»¶çš„ç»„æˆ\n1.æ³¨é‡Šä»£ç ä¸­çš„æ³¨é‡Šå¯ä»¥ä½¿ç”¨åˆ†å·;æˆ–è€…//ä½œä¸ºæ³¨é‡Šå†…å®¹çš„å¼€å¤´ã€‚æŒ‰ç…§å®˜æ–¹ç¤ºä¾‹çš„ä¼ ç»Ÿï¼Œå»ºè®®ä½¿ç”¨åˆ†å·ã€‚\n\n2.ä¼ªæŒ‡ä»¤ä¼ªæŒ‡ä»¤ä¸»è¦æ˜¯ç”¨äºæè¿°ä¸€äº›é…ç½®çš„ä»£ç ï¼Œä¼ªæŒ‡ä»¤ä»¥.å¼€å¤´ï¼Œéœ€è¦è®°ä½çš„ä¼ªæŒ‡ä»¤æœ‰è¿™äº›\n\n\n\n\n\næŒ‡ä»¤\næè¿°\n\n\n\n.define ( PUBLIC ) &lt;symbol&gt; &lt;value&gt;\nå®šä¹‰ä¸€ä¸ªç¬¦å·ï¼Œç±»ä¼¼äºCè¯­è¨€ä¸­çš„defineï¼Œé™„åŠ publicå…³é”®å­—åä¼šåœ¨ç›®æ ‡æ–‡ä»¶ä¸­ä¹Ÿç”ŸæˆåŒæ­¥çš„å®å®šä¹‰ã€‚\n\n\n.program &lt;name&gt;\nå£°æ˜ç¨‹åºçš„åç§°ï¼Œå¹¶è¡¨ç¤ºåç»­çš„ä»£ç å³ä¸ºç¨‹åºä»£ç ï¼Œä¸€ä¸ªæ–‡ä»¶ä¸­å¯ä»¥åŒ…å«å¤šä¸ªä¸åŒåç§°çš„ä»£ç ã€‚\n\n\n.origin &lt;offset&gt;\nç”¨äºæŒ‡å®šPIOç¨‹åºå¿…é¡»åŠ è½½åˆ°æŒ‡å®šçš„å­˜å‚¨ç©ºé—´åœ°å€ä¸‹ï¼Œè¿™å¯¹äºä½¿ç”¨äº†ç»å¯¹åœ°å€è·³è½¬çš„åŠŸèƒ½æ˜¯æœ‰ç”¨çš„ã€‚\n\n\n.side_set &lt;count&gt; (opt) (pindirs)\nå£°æ˜æŒ‡ä»¤ä¸­å…è®¸ä½¿ç”¨ä¾§è®¾ç½®æŒ‡ä»¤æ¥æ§åˆ¶ioï¼Œcountè¡¨ç¤ºioçš„æ•°é‡ï¼Œoptæ„å‘³è¿™ä»£ç ä¸­ä¸éœ€è¦æ¯æ¡æŒ‡ä»¤éƒ½è¿›è¡Œä¾§è®¾ç½®ï¼Œpindirsè¡¨ç¤ºè®¾ç½®çš„æ˜¯ioçš„æ–¹å‘è€Œä¸æ˜¯ioçš„ç”µå¹³çŠ¶æ€ã€‚\n\n\nå…¶ä¸­æœ€éš¾ç†è§£çš„ä¹Ÿè®¸æ˜¯side_set(ä¾§è®¾ç½®)ï¼Œå®ƒæ˜¯ç”¨äºæ§åˆ¶IOçŠ¶æ€çš„æŒ‡ä»¤ï¼Œè¦ç†è§£å®ƒï¼Œæˆ‘ä»¬å°±å°†å¦å¤–ä¸‰ç§æ§åˆ¶IOçš„æŒ‡ä»¤æ‹¿å‡ºæ¥ä¸€èµ·è¯´æ˜ã€‚PIOæœ‰4ä¸­æ–¹å¼æ§åˆ¶IOå£ï¼Œè¾“å…¥(IN)ï¼Œè¾“å‡º(OUT)ï¼Œè®¾ç½®(SET)ï¼Œä¾§è®¾ç½®(SIDE_SET)ã€‚\næ¯ç§æ§åˆ¶æ–¹å¼éƒ½éœ€è¦é…ç½®ä¸€ä¸ªè¿ç»­çš„å¼•è„šèŒƒå›´ç”¨äºæ§åˆ¶ï¼Œå„ä¸ªæ§åˆ¶æ–¹å¼çš„å¼•è„šèŒƒå›´æ˜¯å¯é‡å çš„ï¼Œè¿™æ„å‘³ç€ä¸€ä¸ªå¼•è„šå¯ä»¥åŒæ—¶ç”¨4ç§æ–¹å¼è¿›è¡Œæ§åˆ¶ã€‚å¼•è„šæ•°é‡é™¤äº†SETã€SIDE_SETæ§åˆ¶å¤–ï¼Œå…¶å®ƒä¸‰ç§æ–¹å¼éƒ½æ²¡æœ‰å¼•è„šæ•°é‡çš„é™åˆ¶ï¼ŒSETèƒ½æœ€å¤šæ˜ å°„5ä¸ªå¼•è„šï¼Œside_setå—é™ä¸æŒ‡ä»¤ç¼–ç çš„ä½å®½ï¼Œæœ€å¤š5ä¸ªIOå£èƒ½å¤Ÿæ§åˆ¶ã€‚\nè¾“å…¥ç”¨äºè¯»å–IOçš„å€¼åˆ°ISRå¯„å­˜å™¨ä¸­ï¼Œé€šè¿‡ä½ç§»çš„æ–¹å¼è¯»å–ã€‚è¾“å‡ºæ˜¯å°†OSRå¯„å­˜å™¨ä¸­çš„å€¼è¾“å‡ºåˆ°IOä¸Šï¼ŒåŒæ ·ä¹Ÿæ˜¯ä½ç§»çš„æ–¹å¼ã€‚å½“ä½ç§»å¯„å­˜å™¨æ»¡äº†æˆ–è€…ç©ºäº†ä¹‹åï¼Œç»è¿‡é€‚å½“çš„é…ç½®ï¼Œä½ç§»å¯„å­˜å™¨èƒ½å¤Ÿè‡ªåŠ¨å’ŒFIFOäº¤äº’æ•°æ®ã€‚SETèƒ½å¤Ÿç›´æ¥æ§åˆ¶å¼•è„šçš„ç”µå¹³çŠ¶æ€è€Œä¸ä¾èµ–ä½ç§»å¯„å­˜å™¨ã€‚SIDE_SETæ˜¯é™„åŠ åœ¨ä¸€èˆ¬æŒ‡ä»¤ä¸­çš„æŒ‡ä»¤ï¼Œå®ƒä¸è¢«é™„åŠ çš„æŒ‡ä»¤ä¸€èµ·æ‰§è¡Œï¼Œé€šè¿‡å®ƒä¹Ÿèƒ½å¤Ÿç›´æ¥è®¾ç½®IOçš„ç”µå¹³çŠ¶æ€ã€‚\næ­¤å¤–è¿˜æœ‰JMPæŒ‡ä»¤èƒ½å¤Ÿè¯»å–å¼•è„šçŠ¶æ€ï¼Œå®ƒå¯ä»¥å•ç‹¬é…ç½®ä¸€ä¸ªå¼•è„šç”¨äºæ¡ä»¶è·³è½¬ã€‚\n\n3.æ ‡ç­¾æŒ‡ä»¤å‰å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå‘½åæ ‡ç­¾ç”¨äºè¡¨ç¤ºä»£ç æ®µçš„ä½ç½®ï¼Œç±»ä¼¼è¿™æ ·çš„ï¼šæ ‡ç­¾:    æŒ‡ä»¤\né€šè¿‡è¿™æ ·æ ‡ç­¾ï¼Œä½¿ç”¨JMPæŒ‡ä»¤å°±èƒ½å®ç°åˆ†æ”¯æµç¨‹å¤„ç†ã€‚\n\næŒ‡ä»¤æ‰€æœ‰çš„æŒ‡ä»¤ç»“æ„éƒ½ä¸ºå¦‚ä¸‹å½¢å¼ï¼š\n&lt;æŒ‡ä»¤&gt; (side &lt;ä¾§è®¾ç½®ç”µå¹³çŠ¶æ€&gt;) ([&lt;å»¶æ—¶å‘¨æœŸ&gt;])\næ¯æ¡æŒ‡ä»¤éƒ½å¯ä»¥é™„åŠ ä¾§è®¾ç½®æŒ‡ä»¤ä»¥åœ¨æ‰§è¡ŒæŒ‡ä»¤çš„è¿‡ç¨‹ä¸­è®¾ç½®ç”µå¹³çŠ¶æ€ã€‚å»¶æ—¶å‘¨æœŸåˆ™ç”¨äºåœ¨æŒ‡ä»¤æ‰§è¡Œå®Œæˆåå»¶æ—¶ä¸€æ®µæ—¶é—´å†æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œå¦‚æœæŒ‡ä»¤å¯¼è‡´çŠ¶æ€æœºé˜»å¡ï¼Œå»¶æ—¶çš„æ—¶é—´æ˜¯ä»ç»“æŸé˜»å¡å¼€å§‹è®¡ç®—çš„ã€‚PIOæ”¯æŒçš„9æ¡æŒ‡ä»¤éƒ½æ˜¯å•å‘¨æœŸæŒ‡ä»¤ï¼Œè¿™æ˜¯éå¸¸å‡†ç¡®çš„ï¼Œå¦‚æœä¸¤ä¸ªçŠ¶æ€æœºè®¾ç½®ä¸ºç›¸åŒçš„æ—¶é’Ÿé¢‘ç‡ä¸€èµ·æ‰§è¡ŒåŒä¸€æ®µä»£ç ï¼Œå®ƒä»¬èƒ½å¤Ÿä¿è¯åŒæ­¥è¿è¡Œã€‚\nä¾§è®¾ç½®ç”µå¹³çŠ¶æ€å’Œå»¶æ—¶å‘¨æœŸæ‰€å çš„ç¼–ç ä½å®½æ˜¯å…±äº«çš„ï¼Œå¦‚æœé…ç½®äº†.side_set 2ï¼Œæ„å‘³ç€å¯ä»¥åŒæ—¶è®¾ç½®ä¸¤ä¸ªIOï¼Œä½†æ˜¯å»¶æ—¶æ—¶é—´å°±åªèƒ½å ç”¨3ä¸ªä½äº†ï¼Œå³æœ€é•¿åªèƒ½å»¶æ—¶7ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚æ­¤å¤–å¦‚æœåŠ å…¥äº†opté€‰é¡¹.side_set 2 optï¼Œæ„å‘³ç€optè¿˜è¦å•ç‹¬å ç”¨ä¸€ä½ï¼Œå»¶æ—¶æ—¶é—´åªèƒ½ä½¿ç”¨2ä¸ªä½ï¼Œæœ€é•¿çš„å»¶æ—¶æ—¶é—´å°±æ˜¯3ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚\n9æ¡æŒ‡ä»¤æœ‰ JMPã€WAITã€INã€OUTã€PUSHã€PULLã€MOVã€IRQã€SETã€‚æ¯æ¡æŒ‡ä»¤çš„ç»†èŠ‚è¯´æ˜åº”å½“å»çœ‹èŠ¯ç‰‡æ‰‹å†Œï¼Œè¿™é‡Œå°±ä¸éœ€è¦å¤è¿°äº†ã€‚è¿™äº›æŒ‡ä»¤éå¸¸çš„çµæ´»ï¼Œæœ‰å¾ˆå¤šè®©äººæ„å¤–çš„ç”¨æ³•ï¼Œä¾‹å¦‚å°†FIFOä¸­çš„æ•°æ®å–å‡ºåæŠŠå®ƒå½“ä½œæŒ‡ä»¤æ‰§è¡Œã€‚\nä¸­æ–­å‰é¢æåˆ°äº†PIOå…·æœ‰ä¸¤æ¡ä¸­æ–­çº¿(irq0å’Œirq1)ï¼Œä¸¤ä¸ªPIOæ¨¡å—æ˜¯å…±äº«çš„ã€‚PIOæ¨¡å—çš„ä¸­æ–­æ˜¯ç³»ç»Ÿçº§åˆ«çš„ï¼Œå’ŒSPIç­‰å¤–è®¾çš„ä¸­æ–­åœ¨ä¸€ä¸ªå±‚æ¬¡ä¸Šï¼Œä¹Ÿæ˜¯ç”±NVICè¿›è¡Œç®¡ç†çš„ã€‚PIOæœ‰12ä¸ªäº‹ä»¶èƒ½å¤Ÿè§¦å‘ä¸­æ–­ï¼Œå…¶ä¸­0 ~ 3æ˜¯æ¥è‡ªçŠ¶æ€æœºå†…éƒ¨çš„ä¸­æ–­ï¼Œ4 ~ 11æ˜¯4ä¸ªçŠ¶æ€æœºå…±8ä¸ªFIFOçš„æ»¡ç©ºäº‹ä»¶ä¸­æ–­ã€‚\nPIOæ¨¡å—æœ‰ä¸¤æ¡ä¸­æ–­çº¿åˆ°NVICï¼Œä¸”æ¯ä¸ªä¸­æ–­äº‹ä»¶éƒ½æ˜¯å¯ä»¥å•ç‹¬è·¯ç”±çš„ã€‚ä¸¾ä¸ªä¾‹å­æ–¹ä¾¿ç†è§£ï¼ŒPIO0çš„ä¸­æ–­0å’Œä¸­æ–­2äº‹ä»¶å‘é€åˆ°irq0ï¼ŒPIO0çš„ä¸­æ–­1å’Œä¸­æ–­3äº‹ä»¶å‘é€åˆ°irq1ï¼ŒPIO1çš„ä¸­æ–­0å’Œä¸­æ–­1å‘é€åˆ°irq0ï¼Œè¿™æ˜¯å¯ä»¥æ··æ­çš„ã€‚ä½†å®é™…ä¸Šä¸ä¼šè¿™ä¹ˆä½¿ç”¨ï¼Œå› ä¸ºè¦åœ¨ä¸­æ–­å¤„ç†ä¸­å»åˆ†æPIO0å’ŒPIO1çš„å…·ä½“ä¸­æ–­äº‹ä»¶æ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦æ£€æŸ¥æ¯ä¸ªä¸­æ–­çŠ¶æ€å¯„å­˜å™¨ã€‚\né™¤äº†PIOå…·æœ‰ä¸­æ–­å¤–ï¼Œæ¯ä¸ªçŠ¶æ€æœºä¹Ÿå…·æœ‰ä¸­æ–­ï¼Œæˆ–è€…è¯´æ˜¯ä¸­æ–­æ ‡å¿—ä½ï¼ŒPIOçš„4ä¸ªçŠ¶æ€æœºå…±äº«8ä¸ªä¸­æ–­æ ‡å¿—ä½ï¼Œä¹Ÿå°±æ˜¯è¯´çŠ¶æ€æœºå¯ä»¥ä½¿ç”¨8ä¸ªä¸­æ–­ã€‚æ¯”å¦‚è¯´å¯ä»¥åœ¨ä¸€ä¸ªçŠ¶æ€æœºä¸­è®¾ç½®ä¸­æ–­æ ‡å¿—ï¼Œåœ¨å¦ä¸€ä¸ªçŠ¶æ€æœºä¸­ç­‰å¾…ä¸­æ–­æ ‡å¿—ï¼Œè¿™æ ·å°±å®ç°äº†çŠ¶æ€æœºçš„äº¤äº’ã€‚è¿™åº”è¯¥æ˜¯çŠ¶æ€æœºé—´è¿›è¡Œç›´æ¥äº¤äº’çš„å”¯ä¸€æ–¹å¼äº†ï¼Œå› ä¸ºçŠ¶æ€æœºä¹‹é—´æ˜¯ä¸èƒ½ä¼ è¾“æ•°æ®çš„ã€‚8ä¸ªä¸­æ–­æ ‡å¿—ä½ä¸­çš„å‰4ä¸ªå¯ä»¥ä¸ŠæŠ¥åˆ°PIOå¹¶è§¦å‘PIOçš„ä¸­æ–­äº‹ä»¶ï¼Œå4ä¸ªä¸­æ–­æ ‡å¿—ä»…ä»…ç”¨äºçŠ¶æ€æœºå†…éƒ¨ã€‚å¤„ç†å™¨é€šè¿‡PIOæ¨¡å—èƒ½å¤Ÿç›´æ¥æ¸…é™¤è¿™8ä¸ªä¸­æ–­æ ‡å¿—ã€‚\nå¦‚æœPIOæ‰“å¼€äº†å†…éƒ¨0 ~ 3çš„ä¸­æ–­ä½¿èƒ½ï¼Œé‚£ä¹ˆä»»æ„ä¸€ä¸ªçŠ¶æ€æœºè®¾ç½®äº†0 ~ 3çš„ä¸­æ–­æ ‡å¿—ä½ï¼Œä¸­æ–­éƒ½ä¼šä¸ŠæŠ¥åˆ°PIOä¸­ã€‚ç”±äºçŠ¶æ€æœºå’ŒCPUçš„NVICéƒ½èƒ½å¤„ç†ä¸€äº›ç›¸åŒçš„ä¸­æ–­æºï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨æ—¶ï¼Œéœ€è¦æ³¨æ„ç­‰å¾…ä¸­æ–­ä¸­çš„ç«Ÿæ€æ¡ä»¶ã€‚\nIRQ 1         ;è¡¨ç¤ºè®¾ç½®ä¸€ä¸ªä¸­æ–­æ ‡å¿—å¹¶ç»§ç»­è¿è¡Œï¼Œ1è¡¨ç¤ºä¸­æ–­æ ‡å¿—ä½çš„åºå·IRQ WAIT 1    ;è¡¨ç¤ºè®¾ç½®ä¸€ä¸ªä¸­æ–­æ ‡å¿—å¹¶ç­‰å¾…è¯¥æ ‡å¿—è¢«æ¸…é™¤IRQ CLEAR 1   ;è¡¨ç¤ºæ¸…é™¤ä¸€ä¸ªä¸­æ–­æ ‡å¿—\n\nä¸­æ–­æ ‡å¿—ä½çš„åºå·æœ‰ä¸¤ç§è¡¨ç¤ºæ–¹å¼ï¼Œç»å¯¹å€¼å’Œç›¸å¯¹å€¼ï¼Œå‰é¢çš„ä¸‰ä¸ªå†™æ³•éƒ½æ˜¯ç»å¯¹åºå·ï¼Œä¸¾ä¾‹è¯´æ˜ä¸€ä¸‹ç›¸å¯¹åºå·çš„å†™æ³•ï¼š\n; çŠ¶æ€æœºåºå·ä¸º 1IRQ 5 rel     ;è¡¨ç¤ºè®¾ç½®çš„ä¸­æ–­åºå·ä¸º6ï¼Œ6 = (è®¾ç½®åºå· &amp; 4) + (è®¾ç½®åºå· + çŠ¶æ€æœºåºå·) &amp; 3\nç›¸å¯¹åºå·çš„å…·ä½“ç»†èŠ‚è¿˜æ˜¯è¦å‚è€ƒèŠ¯ç‰‡æ‰‹å†Œã€‚\nDMACPUå’ŒPIOçš„æ•°æ®äº¤äº’ä¸»è¦æ˜¯FIFOï¼Œä½†è¯¥FIFOçš„å®¹é‡æœ‰é™ï¼Œä¸”éœ€è¦é€šè¿‡è½®è¯¢æˆ–è€…ä¸­æ–­æ¥è§¦å‘æ•°æ®ä¼ è¾“ï¼Œè¿™å¯¹CPUæ¥è¯´æ˜¯é¢å¤–çš„è´Ÿæ‹…ï¼ŒPIOæä¾›äº†æ•°æ®è¯·æ±‚æœºåˆ¶ï¼Œé€šè¿‡è¯¥æœºåˆ¶å¹¶ç»“åˆDMAå­æ¨¡å—ï¼Œæ•°æ®èƒ½å¤Ÿæ— éœ€CPUå¹²é¢„ä»è€Œåœ¨RAMå’ŒPIOçŠ¶æ€æœºä¹‹é—´ä¼ è¾“å¤§é‡æ•°æ®ï¼Œæ•°æ®ä¼ è¾“é€Ÿåº¦ä¸ºæ¯ä¸ªæ—¶é’Ÿå‘¨æœŸ1å­—èŠ‚ã€‚\nPIOç¼–ç¨‹ä¸­çš„ä¸€äº›ç»†èŠ‚PIOçŠ¶æ€æœºæ€»æ˜¯è¦ä¸€ç›´è¿è¡Œçš„ï¼Œå¯ä»¥é€šè¿‡JMPæŒ‡ä»¤è¿›è¡Œæ— æ¡ä»¶è·³è½¬è¾¾åˆ°å¾ªç¯çš„ç›®çš„ï¼Œä½†æ˜¯PIOæä¾›äº†ä¸€ç§è¾¹ç•Œæœºåˆ¶ï¼Œå½“ç¨‹åºè¿è¡Œåˆ°è¾¹ç•Œåèƒ½å¤Ÿè‡ªåŠ¨æ¢å¤åˆ°èµ·å§‹ä½ç½®ï¼Œè¿™ä¸ªè¾¹ç•Œé»˜è®¤æ˜¯ç¨‹åºçš„èµ·å§‹å’Œç»“æŸä½ç½®ï¼Œå½“ç„¶ä¹Ÿèƒ½å¤Ÿé€šè¿‡.wrap_targetæŒ‡å®šå¾ªç¯çš„èµ·å§‹ä½ç½®ï¼Œå¹¶ç”¨.wrapæŒ‡å®šå¾ªç¯çš„ç»“æŸä½ç½®ã€‚\næ¯ä¸ªçŠ¶æ€æœºéƒ½æœ‰è¾“å…¥å’Œè¾“å‡ºFIFOï¼Œç”¨äºæ•°æ®çš„äº¤äº’ï¼Œä½†æ˜¯æŸäº›åº”ç”¨ä»…ä»…è¾“å‡ºæ•°æ®æˆ–è€…è¯»å–æ•°æ®ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬çš„FIFOè¿›è¡Œåˆå¹¶ä»¥æ‰©å¤§FIFOçš„ä½¿ç”¨ç©ºé—´ã€‚\nå†è¯´æ˜ä¸€äº›æ•°æ®æ–¹å‘çš„é—®é¢˜ï¼ŒOUTæŒ‡ä»¤æ˜¯å°†OSRå¯„å­˜å™¨çš„æ•°æ®è¾“å‡ºåˆ°PINï¼Œå½“é…ç½®äº†autopullï¼ŒOSRä½ç§»å®Œæˆåï¼ŒTXFIFOä¸­çš„æ•°æ®ä¼šè½¬ç§»åˆ°OSRä¸­ã€‚PULLæŒ‡ä»¤æ˜¯ä¸»åŠ¨å°†TXFIFOä¸­çš„æ•°æ®è½¬ç§»åˆ°OSRå¯„å­˜å™¨ä¸­ã€‚PULLæŒ‡ä»¤é»˜è®¤æ˜¯é˜»å¡çš„ï¼Œæ„å‘³ç€TXFIFOä¸­æ²¡æœ‰æ•°æ®æ—¶çŠ¶æ€æœºä¼šé˜»å¡è¿è¡Œã€‚\nPIOä»£ç ç»è¿‡PIOASMç¼–è¯‘åç”Ÿæˆçš„æ˜¯ä¸€ä¸ª.hæ–‡ä»¶ï¼Œå…¶ä¸­æœ‰äº›ç»†èŠ‚éœ€è¦çŸ¥é“ã€‚å¦‚æœæˆ‘ä»¬å£°æ˜çš„ç¨‹åºåä¸ºxxï¼Œå³.program xxï¼Œé‚£ä¹ˆ.hæ–‡ä»¶ä¸­ä¼šç”Ÿæˆä¸€ä¸ªç±»å‹ä¸ºpio_programçš„å˜é‡ï¼Œå˜é‡åä¸ºxx_programã€‚è¿™æ˜¯ç”¨æ¥åŠ è½½ç¨‹åºçš„ã€‚æ­¤å¤–åœ¨.programå†…å®šä¹‰çš„publicç¬¦å·åœ¨ç”Ÿæˆçš„.hæ–‡ä»¶ä¸­ä¹Ÿä¼šé™„ä»¶xx_çš„å‰ç¼€ã€‚PIOä¸­çš„ç›¸å…³é…ç½®ä¼šè½¬åŒ–ä¸ºä¸€ä¸ªé…ç½®è·å–å‡½æ•°xx_program_get_default_config()ã€‚PIOä»£ç æºæ–‡ä»¶ä»£ç æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„ã€‚\nä¾§è®¾ç½®çš„æ‰§è¡Œå’ŒæŒ‡ä»¤æ‰§è¡Œæ˜¯åŒæ—¶å‘ç”Ÿçš„ï¼Œåœ¨åŒä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…å®Œæˆã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè®¸å¤šæŒ‡ä»¤èƒ½å¤Ÿå¯¼è‡´çŠ¶æ€æœºé˜»å¡è€Œæš‚åœæŒ‡ä»¤çš„æ‰§è¡Œï¼Œä¾‹å¦‚WAITã€PUSHã€PULLç­‰ï¼Œå½“çŠ¶æ€æœºé˜»å¡æ—¶ï¼Œä¾§è®¾ç½®æ˜¯ä¸ä¼šè¢«å½±å“çš„ï¼Œå®ƒæ€»èƒ½åœ¨ç¬¬ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…å®Œæˆã€‚\nAUTOPULLæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿå‡å¦‚å°†OSRé…ç½®ä¸º8ä½ï¼Œè¿™å°±æ„å‘³ç€å½“OSRç§»åŠ¨äº†8ä½åï¼Œå°±éœ€è¦æ‰§è¡ŒPULLæ“ä½œï¼ŒçŠ¶æ€æœºå†…éƒ¨è®°å½•äº†OSRä½ç§»çš„é‡ï¼Œæ‰€ä»¥æ‰èƒ½å¤Ÿè‡ªåŠ¨è§¦å‘PULLã€‚\nJMPæŒ‡ä»¤è·³è½¬çš„ç›®æ ‡åœ°å€åœ¨ç¼–è¯‘åéƒ½æ˜¯ç›¸å¯¹0çš„ç»å¯¹åœ°å€ï¼Œå½“ä½¿ç”¨pio_add_programè½½å…¥ç¨‹åºæ—¶ï¼Œå¦‚æœè½½å…¥çš„åç§»åœ°å€ä¸æ˜¯0ï¼Œé‚£ä¹ˆJMPæŒ‡ä»¤ä¸­çš„ç›®æ ‡åœ°å€ä¼šè‡ªåŠ¨è¿›è¡Œè°ƒæ•´ä»¥ä¿è¯ç¨‹åºæ­£ç¡®è¿è¡Œã€‚è¿™æ˜¯å”¯ä¸€ä¸€ä¸ªä¼šè¢«é‡å®šä½çš„æŒ‡ä»¤ã€‚\nC-SDKç¼–ç¨‹ä¸ºäº†ç”¨å¥½PIOï¼Œè¿˜éœ€è¦å¤§é‡C-SDKä¸­çš„æ¥å£æ¥é…åˆï¼Œå®ç°é…ç½®ã€æ•°æ®äº¤äº’ã€ç¨‹åºåŠ è½½ç­‰ã€‚ä¸‹é¢è¯´æ˜ä¸€äº›å¸¸ç”¨çš„Cå‡½æ•°çš„ç”¨æ³•å’ŒåŠŸèƒ½ã€‚\n\n1.PIOç¨‹åºåŠ è½½ç±»\n\nuint pio_add_program(PIO pio, const pio_program_t *program);åŠ è½½ä¸€ä¸ªç¨‹åºï¼Œå¹¶å°†ç¨‹åºåŠ è½½åˆ°çš„ä½ç½®è¿”å›ã€‚\nvoid pio_remove_program(PIO pio, const pio_program_t *program, uint loaded_offset);ä»æŒ‡ä»¤å­˜å‚¨ç©ºé—´ä¸­å¸è½½ç¨‹åºï¼Œéœ€è¦æä¾›åŠ è½½åœ°å€ã€‚\nvoid pio_clear_instruction_memory(PIO pio);æ¸…ç©ºPIOçš„å…¨éƒ¨æŒ‡ä»¤å­˜å‚¨ç©ºé—´ã€‚\n\n2.çŠ¶æ€æœºç±»\n\nint pio_claim_unused_sm(PIO pio, bool required);è¯·æ±‚ä¸€ä¸ªç©ºé—²çš„çŠ¶æ€æœºã€‚\nvoid pio_sm_init(PIO pio, uint sm, uint initial_pc, const pio_sm_config *config);åˆå§‹åŒ–ä¸€ä¸ªçŠ¶æ€æœºï¼Œinitial_pcå°±æ˜¯ç¨‹åºçš„åŠ è½½åœ°å€ï¼Œconfigå¯ä»¥ä½¿ç”¨.hæ–‡ä»¶ä¸­ç”Ÿæˆçš„ä¸€ä¸ªæ–¹æ³•å¾—åˆ°ã€‚\nvoid pio_sm_set_enabled(PIO pio, uint sm, bool enabled);å¯åŠ¨æˆ–è€…å…³é—­çŠ¶æ€æœºã€‚\nvoid pio_set_sm_mask_enabled(PIO pio, uint32_t mask, bool enabled);ä½¿ç”¨æ©ç åŒæ—¶å¯åŠ¨æˆ–è€…å…³é—­å¤šä¸ªçŠ¶æ€æœºã€‚\nvoid pio_sm_restart(PIO pio, uint sm);çŠ¶æ€æœºå¤ä½ã€‚\nvoid pio_restart_sm_mask(PIO pio, uint32_t mask);å¤ä½å¤šä¸ªçŠ¶æ€æœºã€‚\nvoid pio_enable_sm_mask_in_sync(PIO pio, uint32_t mask);å°†å¤šä¸ªçŠ¶æ€æœºçš„æ—¶é’Ÿåˆ†é¢‘åŒæ­¥ã€‚\nuint8_t pio_sm_get_pc(PIO pio, uint sm);è·å–å½“å‰çŠ¶æ€æœºæ‰§è¡Œçš„ä½ç½®ã€‚\n\n3.çŠ¶æ€æœºé…ç½®ç±»\n\nvoid sm_config_set_out_pins(pio_sm_config *c, uint out_base, uint out_count);é…ç½®OUTå¼•è„šçš„èŒƒå›´ï¼Œèµ·å§‹å¼•è„šå’Œå¼•è„šæ•°é‡ã€‚\nvoid sm_config_set_set_pins(pio_sm_config *c, uint set_base, uint set_count);é…ç½®SETå¼•è„šçš„èŒƒå›´ï¼Œèµ·å§‹å¼•è„šå’Œå¼•è„šæ•°é‡ã€‚\nvoid sm_config_set_in_pins(pio_sm_config *c, uint in_base);é…ç½®INå¼•è„šçš„èµ·å§‹å¼•è„šã€‚\nvoid sm_config_set_sideset_pins(pio_sm_config *c, uint sideset_base);é…ç½®SIDEå¼•è„šçš„èµ·å§‹å¼•è„šã€‚\nvoid sm_config_set_jmp_pin(pio_sm_config *c, uint pin);é…ç½®JMPå¼•è„šï¼ŒJMPæ¡ä»¶æŒ‡ä»¤èƒ½å¤Ÿé€‰æ‹©ä¸€ä¸ªå¼•è„šçš„å€¼ä½œä¸ºæ¡ä»¶ï¼Œå½“å¼•è„šä¸ºé«˜ç”µå¹³æ—¶ï¼Œæ¡ä»¶æˆç«‹ã€‚\nvoid sm_config_set_clkdiv(pio_sm_config *c, float div);é…ç½®çŠ¶æ€æœºçš„æ—¶é’Ÿåˆ†é¢‘ã€‚\nvoid sm_config_set_wrap(pio_sm_config *c, uint wrap_target, uint wrap);é…ç½®çŠ¶æ€æœºçš„ç¨‹åºè¾¹ç•Œã€‚\nvoid sm_config_set_in_shift(pio_sm_config *c, bool shift_right, bool autopush, uint push_threshold);é…ç½®INæŒ‡ä»¤ï¼Œshift_rightä¸ºçœŸæ—¶OSRä¸ºå³ç§»æ¨¡å¼ï¼Œautopushä¸ºçœŸæ—¶ï¼Œæ„å‘³ç€OSRè¾¾åˆ°é˜ˆå€¼åè‡ªåŠ¨æ‰§è¡ŒPUSHï¼Œä»TXFIFOä¸­å–å‡ºæ•°æ®åˆ°OSRä¸­ã€‚push_thresholdè¡¨ç¤ºOSRçš„ä½å®½ã€‚\nvoid sm_config_set_out_shift(pio_sm_config *c, bool shift_right, bool autopull, uint pull_threshold);é…ç½®OUTæŒ‡ä»¤ã€‚\nvoid sm_config_set_fifo_join(pio_sm_config *c, enum pio_fifo_join join);é…ç½®FIFOçš„ç”¨æ³•ï¼Œæœ‰ä¸‰ç§ï¼Œ0å‡åŒ€åˆ†é…ï¼Œ1å°†FIFOå…¨éƒ¨ç”¨äºTXFIFOï¼Œ2å°†FIFOå…¨éƒ¨ç”¨äºRXFIFOã€‚\n\n4.çŠ¶æ€æœºIOé…ç½®\n\nvoid pio_gpio_init(PIO pio, uint pin);å°†IOå£ç»‘å®šåˆ°æŒ‡å®šçš„PIOä¸Šã€‚ä¸å…è®¸å¤šä¸ªPIOæ§åˆ¶åŒä¸€ä¸ªå¼•è„šã€‚\nvoid pio_sm_set_pins(PIO pio, uint sm, uint32_t pin_values);ä½¿ç”¨ç‰¹å®šçš„çŠ¶æ€æœºå°†PIOæ‰€å±çš„IOå…¨éƒ¨è®¾ä¸ºæŒ‡å®šå€¼ã€‚\nvoid pio_sm_set_pins_with_mask(PIO pio, uint sm, uint32_t pin_values, uint32_t pin_mask);ï¼›ä½¿ç”¨æ©ç åˆå§‹åŒ–IOã€‚\nvoid pio_sm_set_pindirs_with_mask(PIO pio, uint sm, uint32_t pin_dirs, uint32_t pin_mask);è®¾ç½®IOçš„æ–¹å‘ã€‚\nvoid pio_sm_set_consecutive_pindirs(PIO pio, uint sm, uint pin_base, uint pin_count, bool is_out);è®¾ç½®ä¸€ç»„è¿ç»­IOçš„æ–¹å‘ã€‚\n\n5.æ•°æ®äº¤äº’ç±»\n\nvoid pio_sm_clear_fifos(PIO pio, uint sm);æ¸…ç©ºçŠ¶æ€æœºçš„FIFOã€‚SDK14.0å­˜åœ¨BUGã€‚\nvoid pio_sm_drain_tx_fifo(PIO pio, uint sm);ä¸¢æ‰TXFIFOä¸­çš„æ‰€æœ‰æ•°æ®ã€‚\nvoid pio_sm_put(PIO pio, uint sm, uint32_t data);å†™å…¥ä¸€ä¸ªæ•°æ®åˆ°TXFIFOä¸­ã€‚å¦‚æœFIFOæ»¡äº†åˆ™ä¸¢æ‰æ•°æ®ã€‚\nvoid pio_sm_put_blocking(PIO pio, uint sm, uint32_t data);å‘TXFIFOä¸­å†™å…¥æ•°æ®ï¼Œå¦‚æœTXFIFOå·²ç»æ»¡äº†åˆ™ç­‰å¾…ï¼Œç›´åˆ°èƒ½å¤Ÿå†™å…¥æ•°æ®ã€‚\nuint32_t pio_sm_get(PIO pio, uint sm);ä»RXFIFOä¸­è¯»å–ä¸€ä¸ªæ•°æ®å¹¶è¿”å›ã€‚å¦‚æœRXFIFOæ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆè¿”å›çš„å€¼æ²¡æœ‰æ„ä¹‰ã€‚\nuint32_t pio_sm_get_blocking(PIO pio, uint sm);ä»RXFIFOä¸­è¯»å–æ•°æ®ï¼Œå¦‚æœRXFIFOä¸ºç©ºåˆ™ç­‰å¾…ï¼Œç›´åˆ°RXFIFOä¸­å­˜åœ¨æ–°çš„æ•°æ®ã€‚\nbool pio_sm_is_rx_fifo_full(PIO pio, uint sm);æ–­è¨€æ¥æ”¶FIFOå·²æ»¡ã€‚\nbool pio_sm_is_rx_fifo_empty(PIO pio, uint sm);æ–­è¨€æ¥æ”¶FIFOå·²ç©ºã€‚\nuint pio_sm_get_rx_fifo_level(PIO pio, uint sm);è¯»å–RXFIFOä¸­çš„æ•°æ®ä¸ªæ•°ï¼Œéƒ½æ˜¯æŒ‰å­—è®¡ç®—çš„ã€‚\nbool pio_sm_is_tx_fifo_full(PIO pio, uint sm);æ–­è¨€TXIFOå·²æ»¡ã€‚\nbool pio_sm_is_tx_fifo_empty(PIO pio, uint sm);æ–­è¨€TXFIFOä¸ºç©ºã€‚\nuint pio_sm_get_tx_fifo_level(PIO pio, uint sm);è¯»å–TXFIFOä¸­çš„æ•°æ®ä¸ªæ•°ã€‚\n\n6.ä¸­æ–­ç®¡ç†ç±»\n\nvoid pio_set_irq0_source_enabled(PIO pio, enum pio_interrupt_source source, bool enabled);è®¾ç½®IRQ0çš„ä¸­æ–­äº‹ä»¶æºã€‚\nvoid pio_set_irq1_source_enabled(PIO pio, enum pio_interrupt_source source, bool enabled);è®¾ç½®IRQ1çš„ä¸­æ–­äº‹ä»¶æºã€‚\nvoid pio_interrupt_clear(PIO pio, uint pio_interrupt_num);æ¸…é™¤çŠ¶æ€æœºå†…éƒ¨çš„ä¸­æ–­æ ‡å¿—ã€‚\né™¤äº†Cå‡½æ•°å¤–ï¼Œè¿˜éœ€è¦Cmakeæ¥è¾…åŠ©å®ç°ç¼–è¯‘PIOæºæ–‡ä»¶ã€‚\næ€»ç»“è¿™åªæ˜¯æˆ‘å­¦ä¹ PIOçš„ä¸€ä¸ªè¿‡ç¨‹è®°å½•ï¼Œåˆ°æ­¤å·²ç»èƒ½å¤ŸåŸºæœ¬è¯»æ‡‚å®˜æ–¹ä¾‹ç¨‹ä¸­çš„PIOä¾‹å­ã€‚å½“ç„¶åé¢è¿˜éœ€è¦è‡ªå·±å¤§é‡çš„å®è·µæ‰èƒ½ç†Ÿç»ƒæŒæ¡è¿™ä¸ªå¼ºå¤§çš„PIOæ¨¡å—ã€‚\n\nç¤ºä¾‹ä»£ç è§£è¯»ä¸€ä¸ªç®€å•çš„ä¸²å£æ•°æ®å‘é€åè®®ï¼š\n.program uart_tx           ; ç¨‹åºåç§°ä¸ºuart_tx.side_set 1 opt            ; ä»£ç ä¸­å¯ä»¥ä½¿ç”¨ä¾§è®¾ç½®æŒ‡ä»¤ï¼Œæ§åˆ¶çš„IOæ•°é‡ä¸º1ï¼Œä¾§è®¾ç½®æŒ‡ä»¤æ˜¯å¯é€‰çš„ã€‚    pull       side 1 [7]  ; ä»TXFIFOç¼“å†²åŒºä¸­è¯»å–ä¸€ä¸ªæ•°æ®åˆ°OSRå¯„å­˜å™¨ä¸­ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®å°±ç­‰å¾…ã€‚å¹¶å°†sideå¼•è„šè¾“å‡ºé«˜ç”µå¹³ã€‚æœ€å°‘æ‰§è¡Œ8ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚    set x, 7   side 0 [7]  ; å°†7èµ‹å€¼åˆ°Xå¯„å­˜å™¨ã€‚å¹¶å°†sideå¼•è„šè®¾ä¸ºä½ç”µå¹³ã€‚å›ºå®šæ‰§è¡Œ8ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚bitloop:                   ; å¾ªç¯å…¥å£    out pins, 1            ; ä»OSRå¯„å­˜å™¨ä¸­å³ç§»ä¸€ä½åˆ°è¾“å‡ºOUTå¼•è„šä¸Šã€‚å•ä¸ªå‘¨æœŸã€‚    jmp x-- bitloop   [6]  ; å¦‚æœXé0åˆ™è·³è½¬åˆ°bitloopã€‚X=X-1ã€‚å›ºå®šæ‰§è¡Œ7ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚                           ; åˆ°è¾¾ç¨‹åºè¾¹ç•Œåä¼šè‡ªåŠ¨è·³å›ç¨‹åºèµ·å§‹å¤„ã€‚è¿™æ˜¯0å‘¨æœŸæ‰§è¡Œçš„ã€‚\n\nä¸ä¹‹é…å¥—çš„Cç›¸å…³å‡½æ•°å¦‚ä¸‹ï¼š\nstatic inline void uart_tx_program_init(PIO pio, uint sm, uint offset, uint pin_tx, uint baud) &#123;    /* è®¾ç½®å¼•è„šçš„åˆå§‹ç”µå¹³çŠ¶æ€å’Œå¼•è„šæ–¹å‘ */    pio_sm_set_pins_with_mask(pio, sm, 1u &lt;&lt; pin_tx, 1u &lt;&lt; pin_tx);    pio_sm_set_pindirs_with_mask(pio, sm, 1u &lt;&lt; pin_tx, 1u &lt;&lt; pin_tx);    /* åˆå§‹åŒ–å¼•è„š */    pio_gpio_init(pio, pin_tx);    /* æ ¹æ®Pioæºç çš„é…ç½®ç”Ÿæˆä¸€ä¸ªé»˜è®¤é…ç½® */    pio_sm_config c = uart_tx_program_get_default_config(offset);    /* OSRå¯„å­˜å™¨é‡‡ç”¨å³ç§»è¾“å‡ºï¼Œä¸ä¼šè‡ªåŠ¨æ‰§è¡ŒPUSHï¼Œæ•°æ®ä½å®½ä¸º32ä½ */    sm_config_set_out_shift(&amp;c, true, false, 32);    /* ç»‘å®štx_pinåˆ°outè¾“å‡ºå¼•è„šä¸Š */    sm_config_set_out_pins(&amp;c, pin_tx, 1);    /* ç»‘å®štx_pinåˆ°ä¾§è®¾ç½®è¾“å‡ºå¼•è„šä¸Š */    sm_config_set_sideset_pins(&amp;c, pin_tx);    /* å°†çŠ¶æ€æœºçš„8ä¸ªå­—FIFOå…¨éƒ¨åˆ†é…ç»™TXFIFO */    sm_config_set_fifo_join(&amp;c, PIO_FIFO_JOIN_TX);    /* æ ¹æ®æ³¢ç‰¹ç‡è®¡ç®—æ—¶é’Ÿåˆ†é¢‘å¹¶è®¾ç½®çŠ¶æ€æœºçš„åˆ†é¢‘ç³»æ•°ï¼Œè¿™é‡Œæ¯è¾“å‡º1bitæ˜¯8ä¸ªå‘¨æœŸ */    float div = (float)clock_get_hz(clk_sys) / (8 * baud);    sm_config_set_clkdiv(&amp;c, div);    /* åˆå§‹åŒ–çŠ¶æ€æœº */    pio_sm_init(pio, sm, offset, &amp;c);    /* å¯åŠ¨çŠ¶æ€æœº */    pio_sm_set_enabled(pio, sm, true);&#125;static inline void uart_tx_program_putc(PIO pio, uint sm, char c) &#123;    /* é˜»å¡çš„æ–¹å¼å‘çŠ¶æ€æœºçš„TXFIFOä¸­å†™å…¥æ•°æ® */    pio_sm_put_blocking(pio, sm, (uint32_t)c);&#125;static inline void uart_tx_program_puts(PIO pio, uint sm, const char *s) &#123;    while (*s)        uart_tx_program_putc(pio, sm, *s++);&#125;\n\nä¸‹é¢æ˜¯ä¸€ä¸ªä¸²å£æ•°æ®æ¥æ”¶åè®®ï¼Œå¹¶åŒ…å«å¸§é”™è¯¯ç®¡ç†ï¼š\n.program uart_rxstart:    wait 0 pin 0        ; ç­‰å¾…ç¬¬0ä¸ªè¾“å…¥å¼•è„šå˜ä¸ºä½ç”µå¹³    set x, 7    [10]    ; è®¾ç½®ä¸€ä¸ªä¸´æ—¶å˜é‡X=7bitloop:                ;     in pins, 1          ; è¯»å–è¾“å…¥å¼•è„šçš„å€¼ï¼Œå¹¶é€šè¿‡å³ç§»ä¿å­˜åˆ°ISRå¯„å­˜å™¨    jmp x-- bitloop [6] ; å¦‚æœXé0åˆ™è·³è½¬åˆ°bitloopï¼ŒX=X-1    jmp pin good_stop   ; ç¡®è®¤è¾“å…¥å¼•è„šä¸ºé«˜ç”µå¹³ï¼Œè¿™é‡Œè¾“å…¥å¼•è„šä¹Ÿé…ç½®ä¸ºäº†JMPå¼•è„š                        ; å¦‚æœä¸ºä½ç”µå¹³åˆ™æ£€æŸ¥åˆ°å¸§é”™è¯¯    irq 4 rel           ; è®¾ç½®ä¸€ä¸ªIRQæ ‡å¿—è¡¨ç¤ºå‘ç”Ÿäº†å¸§é”™è¯¯ï¼Œrelå°†è¡¨ç¤ºæ¯ä¸ªçŠ¶æ€æœºè®¾ç½®çš„æ ‡å¿—ä¸åŒ    wait 1 pin 0        ; ç­‰å¾…è¾“å…¥å¼•è„šæ¢å¤åˆ°é«˜ç”µå¹³    jmp start           ; è¿”å›åˆ°å¼€å§‹å¤„é‡æ–°æ¥æ”¶æ•°æ®good_stop:              ;     push                ; æ¥æ”¶åˆ°äº†æ­£ç¡®çš„æ•°æ®ï¼Œå°†è¯¥æ•°æ®æ¨å…¥åˆ°RXFIFOä¸­\n\n"},{"title":"å¸¸è§çš„å­—ç¬¦ä¸²Hashç®—æ³•","url":"/2021/04/15/%E5%B8%B8%E8%A7%81%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2Hash%E7%AE%97%E6%B3%95/","content":"å¸¸è§hashç®—æ³•çš„ç¢°æ’æ¦‚ç‡ç»Ÿè®¡\n\n\n\n10ä¸‡\n50ä¸‡\n100ä¸‡\n500ä¸‡\n1000ä¸‡\nä¸€äº¿\n1000ä¸‡æ¬¡çš„å¹³å‡æ‰§è¡Œæ—¶é—´\nä¸€äº¿æ¬¡çš„å¹³å‡æ‰§è¡Œæ—¶é—´\nä¸€äº¿æ¬¡çš„å¹³å‡é•¿åº¦\n\n\n\nBKDRHash\n0.00002\n0.000112\n0.000251\n0.0011894\n0.0023321\n0.0229439\n0.0064134\n0.00968998\n9\n\n\nAPHash\n0\n0.000052\n0.000122\n0.0005794\n0.0011712\n0.01155826\n0.0061518\n0.01088634\n10\n\n\nDJBHash\n0.00001\n0.00011\n0.000204\n0.0011782\n0.0023154\n0.02294341\n0.0064836\n0.01098645\n9\n\n\nJSHash\n0\n0.000188\n0.00032\n0.001464\n0.0029323\n0.02876141\n0.0063464\n0.00904354\n9\n\n\nRSHash\n0.00001\n0.000122\n0.000245\n0.001154\n0.00233\n0.02290588\n0.0063627\n0.01168532\n9\n\n\nSDBMHash\n0.00002\n0.000132\n0.000235\n0.001175\n0.0023435\n0.02294529\n0.0064155\n0.01201398\n9\n\n\nPJWHash\n0.00312\n0.015032\n0.029957\n0.1386394\n0.251465\n0.83290663\n0.0067549\n0.00601705\n8\n\n\nELFHash\n0.00096\n0.005584\n0.011239\n0.0539746\n0.1028391\n0.52002744\n0.0060441\n0.00704438\n9\n\n\nMurmurHash\n0\n0\n0\n0\n0\n0\n0.0066868\n0.01194736\n19\n\n\nCityHash\n0\n0\n0\n0\n0\n0\n0.0066179\n0.01129171\n19\n\n\nFNVHash\n0.00005\n0.000186\n0.000349\n0.0016688\n0.0033469\n0.03279751\n0.0061614\n0.01018707\n9\n\n\ncrc64\n0\n0\n0\n0\n0\n0\n0.0064459\n0.01242473\n19\n\n\n1.BKDR hash function\nunsigned int bkdr_hash(const char *str)&#123;    unsigned int seed = 131; // the magic number, 31, 131, 1313, 13131, etc.. orz..    unsigned int hash = 0;    unsigned char *p = (unsigned char *)str;    while (*p)        hash = hash * seed + (*p++);    return hash;&#125;\n\n2.AP hash function\nunsigned int ap_hash(char *str)&#123;    unsigned int hash = 0;    int i;    for (i=0; *str; i++)        if ((i &amp; 1) == 0)            hash ^= ((hash &lt;&lt; 7) ^ (*str++) ^ (hash &gt;&gt; 3));        else            hash ^= (~((hash &lt;&lt; 11) ^ (*str++) ^ (hash &gt;&gt; 5)));    return (hash &amp; 0x7FFFFFFF);&#125;\n\n3.DJB hash function\nunsigned long hash_djbx33a(const char *str, size_t len)&#123;    unsigned long hash = 0U;    for(size_t i = 0;i &lt; len; ++i) &#123;        hash = hash * 33 + (unsigned long)str[i];        /* or, hash = ((hash &lt;&lt; 5) + hash) + (unsigned long)str[i];          * where, hash * 33 = ((hash &lt;&lt; 5) + hash)         */    &#125;    return hash;&#125;long long djb2(char s[])&#123;    long long hash = 5381; /* init value */    int i = 0;    while (s[i] != &#x27;\\0&#x27;)    &#123;        hash = ((hash &lt;&lt; 5) + hash) + s[i];        i++;    &#125;    return hash;&#125;\n\n4.JS hash function\nunsigned int js_hash(char*str)&#123;    unsigned int hash = 1315423911 ;    while(*str)    &#123;        hash ^=((hash &lt;&lt;5 ) + (*str++) + (hash &gt;&gt;2 ));    &#125;    return hash;&#125;\n\n5.RS hash function\nunsigned int RSHash( char * str)&#123;    unsigned int b = 378551;    unsigned int a = 63689;    unsigned int hash = 0;    while(*str)    &#123;        hash = hash * a + (*str++);        a *= b;    &#125;    return (hash &amp; 0x7FFFFFFF);&#125;\n\n6.SDBM hash function\nstatic unsigned long sdbm(unsigned char *str)&#123;    unsigned long hash = 0;    int c;    while (c = *str++)        hash = c + (hash &lt;&lt; 6) + (hash &lt;&lt; 16) - hash;    return hash;&#125;\nsdbm_hash.c\n/* Licensed to the Apache Software Foundation (ASF) under one or more * contributor license agreements.  See the NOTICE file distributed with * this work for additional information regarding copyright ownership. * The ASF licenses this file to You under the Apache License, Version 2.0 * (the &quot;License&quot;); you may not use this file except in compliance with * the License.  You may obtain a copy of the License at * *     http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. *//* * sdbm - ndbm work-alike hashed database library * based on Per-Aake Larson&#x27;s Dynamic Hashing algorithms. BIT 18 (1978). * author: oz@nexus.yorku.ca * status: ex-public domain. keep it that way. * * hashing routine */#include &quot;apr_sdbm.h&quot;#include &quot;sdbm_private.h&quot;/* * polynomial conversion ignoring overflows * [this seems to work remarkably well, in fact better * then the ndbm hash function. Replace at your own risk] * use: 65599  nice. *      65587  even better.  */long sdbm_hash(const char *str, int len)&#123;    register unsigned long n = 0;#define DUFF/* go ahead and use the loop-unrolled version */#ifdef DUFF#define HASHCn = *str++ + 65599 * n    if (len &gt; 0) &#123;        register int loop = (len + 8 - 1) &gt;&gt; 3;        switch(len &amp; (8 - 1)) &#123;        case 0:do &#123;                HASHC;case 7:HASHC;        case 6:HASHC; case 5:HASHC;        case 4:HASHC; case 3:HASHC;        case 2:HASHC;case 1:HASHC;            &#125; while (--loop);        &#125;    &#125;#else    while (len--)        n = *str++ + 65599 * n;#endif    return n;&#125;\n\n7.PJWHash hash function\n/*  * A generic hash function HashPJW better than ElfHash point,  * but depending on the context. */#include &lt;limits.h&gt;#define BITS_IN_int     ( sizeof(int) * CHAR_BIT )#define THREE_QUARTERS  ((int) ((BITS_IN_int * 3) / 4))#define ONE_EIGHTH      ((int) (BITS_IN_int / 8))#define HIGH_BITS       ( ~((unsigned int)(~0) &gt;&gt; ONE_EIGHTH ))unsigned int HashPJW ( const char * datum )&#123;    unsigned int hash_value, i;    for ( hash_value = 0; *datum; ++datum )    &#123;        hash_value = ( hash_value &lt;&lt; ONE_EIGHTH ) + *datum;        if (( i = hash_value &amp; HIGH_BITS ) != 0 )            hash_value = ( hash_value ^ ( i &gt;&gt; THREE_QUARTERS )) &amp; ~HIGH_BITS;    &#125;    return ( hash_value );&#125;\n\n8.ELFHash hash function\n/* *    This function hash the input string &#x27;name&#x27; using the ELF hash *    function for strings. */static unsigned int hash(char* name)&#123;    unsigned int h = 0;    unsigned int g;    while(*name) &#123;        h = (h&lt;&lt;4) + *name++;        if ((g = (h &amp; 0xf0000000)))            h ^= g&gt;&gt;24;        h &amp;=~ g;    &#125;    return h;&#125;\n\n9.Murmur hash function\nuint32_t murmur3_32(const uint8_t* key, size_t len, uint32_t seed) &#123;    uint32_t h = seed;    if (len &gt; 3) &#123;        const uint32_t* key_x4 = (const uint32_t*) key;        size_t i = len &gt;&gt; 2;        do &#123;            uint32_t k = *key_x4++;            k *= 0xcc9e2d51;            k = (k &lt;&lt; 15) | (k &gt;&gt; 17);            k *= 0x1b873593;            h ^= k;            h = (h &lt;&lt; 13) | (h &gt;&gt; 19);            h = (h * 5) + 0xe6546b64;        &#125; while (--i);        key = (const uint8_t*) key_x4;    &#125;    if (len &amp; 3) &#123;        size_t i = len &amp; 3;        uint32_t k = 0;        key = &amp;key[i - 1];        do &#123;        k &lt;&lt;= 8;        k |= *key--;        &#125; while (--i);        k *= 0xcc9e2d51;        k = (k &lt;&lt; 15) | (k &gt;&gt; 17);        k *= 0x1b873593;        h ^= k;    &#125;    h ^= len;    h ^= h &gt;&gt; 16;    h *= 0x85ebca6b;    h ^= h &gt;&gt; 13;    h *= 0xc2b2ae35;    h ^= h &gt;&gt; 16;    return h;&#125;\n\n10.City hash function\n/*  * CityHash çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å¤§éƒ¨åˆ†æ­¥éª¤åŒ…å«äº†è‡³å°‘ä¸¤æ­¥ç‹¬ç«‹çš„æ•°å­¦è¿ç®— * ä»£ç è¾ƒåŒç±»æµè¡Œç®—æ³•å¤æ‚ */\n\n11.FNVHashFNV-1 hash\nhash = FNV_offset_basisfor each byte_of_data to be hashed    hash = hash Ã— FNV_prime    hash = hash XOR byte_of_datareturn hash\nFNV-1a hash\nhash = FNV_offset_basisfor each byte_of_data to be hashed    hash = hash XOR byte_of_data    hash = hash Ã— FNV_primereturn hash\n\nå…¶å®ƒçš„æ¯”è¾ƒ\n\n\nHashå‡½æ•°\næ•°æ®1\næ•°æ®2\næ•°æ®3\næ•°æ®4\næ•°æ®1å¾—åˆ†\næ•°æ®2å¾—åˆ†\næ•°æ®3å¾—åˆ†\næ•°æ®4å¾—åˆ†\nå¹³å‡åˆ†\n\n\n\nBKDRHash\n2\n0\n4774\n481\n96.55\n100\n90.95\n82.05\n92.64\n\n\nAPHash\n2\n3\n4754\n493\n96.55\n88.46\n100\n51.28\n86.28\n\n\nDJBHash\n2\n2\n4975\n474\n96.55\n92.31\n0\n100\n83.43\n\n\nJSHash\n1\n4\n4761\n506\n100\n84.62\n96.83\n17.95\n81.94\n\n\nRSHash\n1\n0\n4861\n505\n100\n100\n51.58\n20.51\n75.96\n\n\nSDBMHash\n3\n2\n4849\n504\n93.1\n92.31\n57.01\n23.08\n72.41\n\n\nPJWHash\n30\n26\n4878\n513\n0\n0\n43.89\n0\n21.95\n\n\nELFHash\n30\n26\n4878\n513\n0\n0\n43.89\n0\n21.95\n\n\nå…¶ä¸­æ•°æ®1ä¸º100000ä¸ªå­—æ¯å’Œæ•°å­—ç»„æˆçš„éšæœºä¸²å“ˆå¸Œå†²çªä¸ªæ•°ã€‚æ•°æ®2ä¸º100000ä¸ªæœ‰æ„ä¹‰çš„è‹±æ–‡å¥å­å“ˆå¸Œå†²çªä¸ªæ•°ã€‚æ•°æ®3ä¸ºæ•°æ®1çš„å“ˆå¸Œå€¼ä¸1000003(å¤§ç´ æ•°)æ±‚æ¨¡åå­˜å‚¨åˆ°çº¿æ€§è¡¨ä¸­å†²çªçš„ä¸ªæ•°ã€‚æ•°æ®4ä¸ºæ•°æ®1çš„å“ˆå¸Œå€¼ä¸10000019(æ›´å¤§ç´ æ•°)æ±‚æ¨¡åå­˜å‚¨åˆ°çº¿æ€§è¡¨ä¸­å†²çªçš„ä¸ªæ•°ã€‚\nç»è¿‡æ¯”è¾ƒï¼Œå¾—å‡ºä»¥ä¸Šå¹³å‡å¾—åˆ†ã€‚å¹³å‡æ•°ä¸ºå¹³æ–¹å¹³å‡æ•°ã€‚å¯ä»¥å‘ç°ï¼ŒBKDRHashæ— è®ºæ˜¯åœ¨å®é™…æ•ˆæœè¿˜æ˜¯ç¼–ç å®ç°ä¸­ï¼Œæ•ˆæœéƒ½æ˜¯æœ€çªå‡ºçš„ã€‚APHashä¹Ÿæ˜¯è¾ƒä¸ºä¼˜ç§€çš„ç®—æ³•ã€‚DJBHash,JSHash,RSHashä¸SDBMHashå„æœ‰åƒç§‹ã€‚PJWHashä¸ELFHashæ•ˆæœæœ€å·®ï¼Œä½†å¾—åˆ†ç›¸ä¼¼ï¼Œå…¶ç®—æ³•æœ¬è´¨æ˜¯ç›¸ä¼¼çš„ã€‚\nåœ¨ä¿¡æ¯ä¿®ç«èµ›ä¸­ï¼Œè¦æœ¬ç€æ˜“äºç¼–ç è°ƒè¯•çš„åŸåˆ™ï¼Œä¸ªäººè®¤ä¸ºBKDRHashæ˜¯æœ€é€‚åˆè®°å¿†å’Œä½¿ç”¨çš„ã€‚\n"},{"title":"æˆ‘ä»¬éœ€è¦è°¨æ…æ“ä½œCache","url":"/2023/08/30/%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E8%B0%A8%E6%85%8E%E6%93%8D%E4%BD%9CCache/","content":"\næˆéƒ½æœ‰ç–«æƒ…æœ‰åŠä¸ªæœˆäº†ï¼Œåœ¨å®¶åŠå…¬çš„æ—¥å­æ€»æ˜¯å¾ˆæ¯ç‡¥çš„ï¼Œå¾ˆå¤šçš„å·¥ä½œæ— æ³•æ­£å¸¸å¼€å±•ã€‚ä»Šå¤©æœ‰æ—¶é—´ï¼Œæˆ‘å°è¯•å¯¹Ymodemçš„ä¼ è¾“æ•ˆç‡è¿›è¡Œä¼˜åŒ–å¹¶å®Œå–„å…¶ä¸­çš„ä¸€äº›ç»†èŠ‚å®ç°ï¼Œæœ¬æ¥ä¸€ä¸ªç®€å•çš„ä¼˜åŒ–å·¥ä½œå´ç‰µå‡ºä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œå¹¶æœ€ç»ˆæŠ˜è…¾äº†ä¸€å¤©æ‰è§£å†³ã€‚è¿™æ˜¯ä¸€ä¸ªå¹¶ä¸å…¸å‹çš„å†…å­˜æº¢å‡ºé—®é¢˜ï¼Œè¿™ç§æº¢å‡ºçš„æ–¹å¼åœ¨ä»¥å‰çš„å·¥ä½œä¸­å®Œå…¨æ²¡æœ‰é‡åˆ°è¿‡ã€‚è®°å½•ä»Šå¤©æ’æŸ¥é—®é¢˜çš„è¿‡ç¨‹ä»¥æé†’è‡ªå·±ï¼Œä¸ä¸¥è°¨çš„Cacheæ“ä½œä¼šå¯¼è‡´å†…å­˜æº¢å‡ºã€‚\n\nä»Šå¤©ä¸€å¼€å§‹åœ¨ä¿®æ”¹å¹¶æµ‹è¯•Ymodemç›¸å…³çš„ä¸€äº›åŠŸèƒ½ï¼Œä¸»è¦æ˜¯ä¼˜åŒ–äº†å†…éƒ¨æ•°æ®å°è£…é€»è¾‘ï¼Œå¹¶æ”¹å–„æ•°æ®ä¼ è¾“é€Ÿåº¦ã€‚æµ‹è¯•å‘ç°å‘å•ç‰‡æœºå‘é€æ–‡ä»¶ï¼Œé€Ÿåº¦æœ‰è¾ƒå¤§çš„æ”¹å–„ã€‚ä¸ºäº†ç¡®è®¤æ•°æ®ä¼ è¾“çš„æ­£ç¡®æ€§ï¼Œä½¿ç”¨Ymodemå°†å•ç‰‡æœºå†…çš„æ–‡ä»¶è¯»å–å‡ºæ¥ã€‚\næƒŠï¼å‘é€å’Œæ¥æ”¶åˆ°çš„æ–‡ä»¶æ•°æ®ä¸ä¸€è‡´ã€‚\næŸ¥ï¼ğŸ§\næ›´æ¢å¤šä¸ªæ–‡ä»¶åæµ‹è¯•å‘ç°ï¼Œé—®é¢˜èƒ½å¤Ÿç¨³å®šå¤ç°ï¼Œä¸”æ¯æ¬¡ä»å•ç‰‡æœºå†…è¯»å–å‡ºçš„æ–‡ä»¶æ•°æ®éƒ½ä¸ä¸€æ ·ã€‚æ˜¯Ymodemåœ¨å•ç‰‡æœºå†…çš„å‘é€æœ‰é—®é¢˜è¿˜æ˜¯æ¥æ”¶æœ‰é—®é¢˜å‘¢ï¼Ÿæˆ‘å†³å®šä½¿ç”¨ç³»ç»Ÿå†…çš„FTPæ–‡ä»¶æœåŠ¡æ¥ååŠ©æ’æŸ¥ï¼Œé€šè¿‡FTPèƒ½å¤Ÿéå¸¸æ–¹ä¾¿çš„ä¸Šä¼ å’Œä¸‹è½½æ–‡ä»¶ã€‚\næƒŠï¼ğŸ˜±\né€šè¿‡FTPä¸Šä¼ å’Œä¸‹è½½çš„æ–‡ä»¶ä¾æ—§å­˜åœ¨é—®é¢˜ã€‚é€šè¿‡ä¸¤ç§æ–‡ä»¶ä¼ è¾“æ–¹å¼ï¼Œæ¯æ¬¡æ–‡ä»¶éƒ½èƒ½ç¨³å®šçš„ä¼ è¾“ï¼Œä¼ è¾“è¿‡ç¨‹ä¸­æ²¡æœ‰å‡ºç°ä»»ä½•é—®é¢˜ï¼Œè¿Ymodeméƒ½æ²¡æœ‰å‘å‡ºNAKçš„æ¶ˆæ¯ï¼Œè€Œä¸”æ–‡ä»¶å¤§å°ä¹Ÿæ²¡æœ‰é—®é¢˜ï¼Œå°±å”¯ç‹¬å†…å®¹ä¹±ç ï¼Œæˆ‘æ˜¯æ ¹æ®7zipçš„CRCæ ¡éªŒæ¥ç¡®è®¤çš„ã€‚è¿™å°±æŠŠé—®é¢˜ç‰µæ‰¯åˆ°YmodemåŠŸèƒ½ä»¥å¤–çš„åœ°æ–¹äº†ï¼Œå¾ˆæ˜¾ç„¶è¯¥é—®é¢˜ä¸æ˜¯Ymodemç›´æ¥å¯¼è‡´çš„ã€‚\nåˆ°è¿™é‡Œæˆ‘è®¤ä¸ºè¿™ä¸ªé—®é¢˜æ¯”è¾ƒä¸¥é‡äº†ï¼Œè¿™ä¸ªå·¥ç¨‹ä»£ç ä¸­æ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„ä»£ç ä¸€ç›´è¿è¡Œéƒ½æ¯”è¾ƒç¨³å®šã€‚\nå¼€å§‹æ’æŸ¥é—®é¢˜ï¼\næˆ‘é¦–å…ˆæ„é€ äº†ä¸€ä¸ªå†…å®¹æ¸…æ™°çš„æ–‡æœ¬æ–‡ä»¶abc.txtï¼Œçº¦1700å­—èŠ‚ã€‚ä½¿ç”¨FTPå…ˆä¸Šä¼ åˆ°ç³»ç»Ÿä¸­ï¼Œé€šè¿‡ä¸²å£çš„å‘½ä»¤è¡Œï¼Œä½¿ç”¨æŒ‡ä»¤æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼Œcat abc.txtã€‚å‘ç°å¶å°”å­˜åœ¨å‡ è¡Œæ–‡æœ¬çš„ä¹±ç ã€‚ä½†æ˜¯æ›´ä¸¥é‡çš„æ˜¯æˆ‘å‘ç°è¿ç»­å‘é€cat abc.txtç³»ç»Ÿå°±å´©æºƒäº†ï¼Œæœ€åä¸€æ¬¡çš„æ•°æ®ä¹Ÿæ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥ã€‚\næˆ‘åˆ°è¿™é‡Œå°±åŸºæœ¬ä¸Šç¡®è®¤æ–‡ä»¶ç³»ç»Ÿå­˜åœ¨é—®é¢˜ï¼Œä¸”è¿™ä¸ªé—®é¢˜å¤§æ¦‚ç‡æ˜¯å’Œæ–‡ä»¶ä¼ è¾“ä¸ä¸€è‡´ç›¸å…³çš„é—®é¢˜ã€‚æœ‰äº†è¿™ä¸ªæ›´å®¹æ˜“å¤ç°çš„bugï¼Œæˆ‘å†³å®šå…ˆä»è¿™é‡Œå…¥æ‰‹ï¼Œç›¸ä¿¡è¿™ä¸ªé—®é¢˜å¾ˆå¿«å°±èƒ½è§£å†³ã€‚\nä½†å®é™…ä¸Šæˆ‘çœŸçš„ä½ä¼°è¿™ä¸ªé—®é¢˜äº†ï¼Œæˆ‘å‡ ä¹èŠ±äº†ä¸€å¤©çš„æ—¶é—´æ¥æ’æŸ¥è¿™ä¸ªé—®é¢˜ï¼Œæœ€ç»ˆä»…ä»…ä¾é ä¸€è¡Œä»£ç è§£å†³ã€‚è¿™å……åˆ†è¯ é‡Šäº†ä¸€ä¸ªçœŸç†ï¼Œé«˜ç«¯çš„BUGå¾€å¾€åªéœ€è¦æœ€æœ´ç´ çš„æ–¹å¼è¿›è¡Œå¤„ç†ã€‚\nä¸‹é¢æˆ‘å›é¡¾ä¸€ä¸‹æˆ‘æ˜¯å¦‚ä½•ä¸€æ­¥ä¸€æ­¥æ’æŸ¥é—®é¢˜çš„ã€‚\né—®é¢˜çš„å…¥å£ç‚¹è‚¯å®šæ˜¯catæŒ‡ä»¤ï¼Œé€šè¿‡åˆ†æä»£ç ï¼Œå®šä½åˆ°å¦‚ä¸‹çš„é€»è¾‘ï¼š\nuint8_t tmp[4];file_h = vfopen(path, &quot;r&quot;);if(file_h)&#123;    while(1)&#123;        len = vfread(file_h, tmp, 4);        if(len &gt; 0)&#123;            output(tmp, len);        &#125;else&#123;            break;        &#125;    &#125;    vfclose(file_h);&#125;\n\nè¿™æ®µä»£ç é€»è¾‘éå¸¸ç®€å•ï¼Œæ‰“å¼€æ–‡ä»¶ï¼Œä»¥4å­—èŠ‚é•¿åº¦çš„æ–¹å¼ä¾æ¬¡è¯»å–æ•°æ®å¹¶å°†å®ƒæ˜¾ç¤ºå‡ºæ¥ï¼Œç›´åˆ°å…¨éƒ¨æ•°æ®è¯»å–å®Œæˆã€‚\nçœ‹åˆ°è¿™é‡Œå¹¶æ²¡æœ‰ä»€ä¹ˆå¥½çš„æƒ³æ³•ï¼Œæˆ‘å†³å®šæ‰“å¼€è°ƒè¯•å™¨ä»¿çœŸã€‚ä»¿çœŸèµ·æ¥åï¼Œå‘ç°é—®é¢˜ç‚¹å¥½åƒä¸æ˜¯å¾ˆç¨³å®šï¼Œå¶å°”ä¼šè¿›å…¥åˆ°hardfaultï¼Œæœ‰æ—¶ä¼šé™·å…¥æ­»å¾ªç¯ã€‚\né€šè¿‡æ£€æŸ¥hardfaultçš„è§¦å‘åŸå› ï¼Œåº”è¯¥æ˜¯è®¿é—®äº†ä¸è¯¥è®¿é—®çš„åœ°å€ï¼Œè¿™ä¸ªåœ°å€å¹¶æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œä½†æ˜¯æ£€æŸ¥è§¦å‘æ—¶çš„PCæŒ‡é’ˆï¼ŒåŸºæœ¬èƒ½å¤Ÿå®šä½åˆ°mallocæ¨¡å—ä¸­ã€‚\nè¿›ä¸€æ­¥æ¥çœ‹ï¼Œå‰é¢è¯´çš„è¿˜ä¼šè¿›å…¥æ­»å¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯ä¹Ÿæ˜¯åœ¨mallocæ¨¡å—ä¸­ï¼Œæ­»å¾ªç¯çš„åŸå› æ˜¯å †å†…å­˜çš„ç©ºé—²é“¾è¡¨ä¸­å‡ºç°äº†å¼‚å¸¸çš„å€¼ï¼Œå¯¼è‡´é“¾è¡¨å‡ºç°é—®é¢˜ã€‚å…·ä½“æ¥è¯´æ—¶mallocåœ¨åˆ†é…å†…å­˜æ—¶éœ€è¦è¿›è¡Œé“¾è¡¨çš„æ“ä½œï¼ŒæŸ¥è¯¢é“¾è¡¨æ—¶æ— æ³•æ­£å¸¸è§¦å‘ç»“æŸæ¡ä»¶å¯¼è‡´è¿›å…¥äº†æ­»å¾ªç¯ã€‚\nå°†é—®é¢˜å®šä½åˆ°è¿™é‡Œå·²ç»åºŸäº†å¾ˆå¤§åŠ²äº†ï¼Œä½†æ˜¯ä¾ç„¶æ²¡æœ‰åŠæ³•ç¡®å®šå¯¼è‡´é—®é¢˜çš„åŸå› ã€‚\né€šè¿‡mallocçš„é—®é¢˜ç‚¹è¿›è¡Œæ ˆå›æº¯ï¼Œç¡®è®¤æ˜¯æ–‡ä»¶ç³»ç»Ÿåœ¨ç”³è¯·å†…å­˜ï¼Œç»ˆäºå’Œæ–‡ä»¶ç³»ç»Ÿå…³è”ä¸Šäº†ã€‚åˆ°æ­¤é—®é¢˜ä¾ç„¶å¾ˆè¿·èŒ«ï¼Œå› ä¸ºå†…å­˜å¯¼è‡´çš„é—®é¢˜é€šå¸¸ä¸ä¼šèŠ±è´¹æˆ‘é‚£ä¹ˆå¤šæ—¶é—´ã€‚\nè¿™ä¸ªå†…å­˜ç ´ååˆ†å­åˆ°åº•æ˜¯è°å‘¢ï¼Ÿï¼Ÿï¼Ÿ\næˆ‘å¼€å§‹å°è¯•æ‰“å¼€å†…å­˜çš„åˆ†é…æ—¥å¿—ï¼Œä¿å®ˆèµ·è§ï¼Œæˆ‘å…ˆä½¿ç”¨ä¸€ç§ç®€å•ç‚¹çš„æ—¥å¿—æ¨¡å‹ï¼Œå®ƒä¸ä¼šç ´åç°æœ‰çš„å†…å­˜åˆ†é…ç»“æ„ã€‚\né€šè¿‡æ—¥å¿—æˆ‘åŸºæœ¬ç¡®è®¤äº†å‡ºé—®é¢˜ç‚¹å‰åæ‰€å‘é€çš„äº‹æƒ…ï¼Œä¹Ÿå°±æ˜¯åœ¨file_h &#x3D; vfopen(path, â€œrâ€);ä¼šè§¦å‘ä¸¤æ¬¡å†…å­˜ç”³è¯·çš„æ“ä½œã€‚åœ¨å¤šæ¬¡æ‰§è¡Œcat abc.txtæ—¶ï¼Œå¯èƒ½æ˜¯å‰é¢å†…å­˜åˆ†é…çš„æ•°æ®ç»“æ„å‡ºç°ä¸¥é‡é—®é¢˜ï¼Œå¯¼è‡´åé¢åˆ†é…å†…å­˜å°±ä¼šå‡ºé”™ã€‚\næˆ‘å¼€å§‹æ€€ç–‘æ˜¯æ ˆæº¢å‡ºå¯¼è‡´å†…å­˜é“¾è¡¨å‡ºç°é—®é¢˜ï¼Œä½†æ˜¯é€šè¿‡å†…å­˜çš„åˆ†é…æ—¥å¿—ï¼Œé€æ¸å°†è¿™ä¸ªæƒ³æ³•æ’é™¤ï¼Œå› ä¸ºæ‰€æœ‰çš„ä»»åŠ¡æ ˆéƒ½ä¸åœ¨è¿™æ®µå†…å­˜é™„è¿‘ã€‚\né€æ¸é™·å…¥åƒµå±€ï¼Œå±…ç„¶è¿å†…å­˜å‡ºç°ç ´åçš„ç‚¹éƒ½æ²¡æœ‰æ•è·åˆ°ï¼\næˆ‘å†³å®šä½¿ç”¨æ›´é«˜çº§çš„å†…å­˜æ—¥å¿—æ¥åˆ†æé—®é¢˜ï¼Œä½†è¿™å¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ä¸å¤ç°ï¼Œå› ä¸ºè¿™ç§å†…å­˜æ—¥å¿—åˆ†ææ–¹æ³•ä¼šåœ¨ç”¨æˆ·ç”³è¯·çš„å†…å­˜å‰åé¢å¤–å†ç”³è¯·ä¸€éƒ¨åˆ†ç©ºé—´ï¼Œç”¨æ¥æ£€æµ‹å†…å­˜è¾¹ç•Œä¸Šæ˜¯å¦å‡ºç°ç ´åã€‚æˆ‘ä¸€å¼€å§‹æ‹…å¿ƒå†…å­˜å¸ƒå±€å‡ºç°å˜åŒ–ä¼šå¯¼è‡´é—®é¢˜ä¸å¤ç°ï¼Œä½†æ˜¯æµ‹è¯•åå‘ç°è¿™ç§æ–¹æ³•æ˜¯å¯è¡Œçš„ï¼Œæˆ‘ç»ˆäºå®šä½åˆ°å†…å­˜ç ´åçš„ç‚¹äº†ã€‚ä¹Ÿå°±æ˜¯vfopenè¿”å›çš„æ–‡ä»¶å¥æŸ„ï¼Œè¿™æ˜¯ä¸€ä¸ªåŠ¨æ€ç”³è¯·çš„å†…å­˜ï¼Œå¤§å°ä¸º4184å­—èŠ‚ã€‚é€šè¿‡å†…å­˜æ—¥å¿—åˆ†æï¼Œè¯¥æ®µå†…å­˜åœ¨é‡Šæ”¾æ—¶æ£€æŸ¥å‘ç°å†…å­˜æœ«å°¾å‡ºç°æ•°æ®æº¢å‡ºçš„æƒ…å†µã€‚\né€šè¿‡æ·»åŠ å¤šä¸ªå†…å­˜æ£€æŸ¥ç‚¹ï¼ŒåŸºæœ¬ç¡®è®¤äº†å†…å­˜ç ´åçš„ä»£ç æ®µï¼Œä¹Ÿå°±æ˜¯åœ¨vfreadå‡½æ•°ä¸­ï¼Œä½†æ˜¯æˆ‘ä»»ç„¶ä¸æ˜¯å¾ˆç¡®å®šã€‚æ¯•ç«Ÿè¿™æ˜¯ä¸€ä¸ªå¤šä»»åŠ¡çš„ç³»ç»Ÿã€‚\næˆ‘å†³å®šä½¿ç”¨å†…å­˜æ–­ç‚¹æ¥æ’æŸ¥é—®é¢˜ï¼Œé€šå¸¸å†…å­˜æ–­ç‚¹éƒ½æ˜¯èƒ½å¤Ÿå¾ˆè½»æ¾çš„è§£å†³è¿™ç±»å†…å­˜æº¢å‡ºçš„é—®é¢˜ï¼Œåœ¨å†…å­˜æº¢å‡ºä½ç½®è®¾ç½®ç›‘è§†æ–­ç‚¹ï¼Œå¾ˆå®¹æ˜“æŸ¥åˆ°æ˜¯ä»€ä¹ˆä»£ç åœ¨ä¿®æ”¹å†…å­˜æ•°æ®ã€‚ä½†æ˜¯è¿™æ¬¡å†…å­˜æ–­ç‚¹å¹¶æ²¡æœ‰å¸®æˆ‘è§£å†³é—®é¢˜ï¼Œå†…å­˜æ–­ç‚¹çœ‹èµ·æ¥å¹¶æ²¡æœ‰èµ·ä½œç”¨ã€‚æˆ‘æ²¡æœ‰åœ¨è¿™é‡Œçº ç¼ å¤ªä¹…ï¼Œæˆ‘ä¸æƒ³å»æŸ¥å†…å­˜æ–­ç‚¹ä¸ºä»€ä¹ˆæ²¡æœ‰ç”Ÿæ•ˆã€‚å› ä¸ºä»Šå¤©å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç›¯ç€è¿™ä¸ªé—®é¢˜ï¼Œç²¾ç¥ä¹Ÿæœ‰ç‚¹å„¿ææƒšäº†ã€‚\nä¸ºä»€ä¹ˆè¯»å–æ–‡ä»¶æ•°æ®ä¼šå°†å¥æŸ„å¤–çš„æ•°æ®ç ´åäº†å‘¢ï¼Ÿæˆ‘å‘ç°å¥æŸ„ç»“æ„ä½“ä¸­æœ«å°¾æ˜¯ä¸€ä¸ª4096å­—èŠ‚çš„æ•°æ®ç¼“å­˜ï¼Œæ˜¯åœ¨è¯»å–æ•°æ®æ—¶å¯¼è‡´å†…å­˜æº¢å‡ºå—ï¼Ÿ\næˆ‘æ£€æŸ¥äº†è®¸ä¹…æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶è¯»å–ç›¸å…³çš„ä»£ç ï¼Œå¹¶æ²¡æœ‰å¯ç–‘çš„åœ°æ–¹ã€‚\næˆ‘å¼€å§‹å°è¯•åœ¨å­˜å‚¨ä»‹è´¨ä¸Šå¯»æ‰¾åŸå› ï¼Œå­˜å‚¨ä»‹è´¨æ˜¯ä¸€å—8Mçš„flashï¼Œspiæ€»çº¿è®¿é—®ã€‚\nå‰é¢éƒ½æ²¡æœ‰æåˆ°è¿™ä¸ªå­˜å‚¨ä»‹è´¨ï¼Œå› ä¸ºæˆ‘èƒ½å¤Ÿç¡®è®¤è¿™ä¸ªå­˜å‚¨ä»‹è´¨æ˜¯å®Œå¥½çš„ï¼Œå®ƒèƒ½å¤Ÿç¨³å®šçš„å­˜å‚¨æ•°æ®ï¼Œå¹¶å¯é çš„è¯»å–å‡ºæ¥ã€‚\næˆ‘é€šè¿‡æ—¥å¿—åˆ†æä»falshè¯»å–æ•°æ®æ—¶å°†æ•°æ®å¡«å……åˆ°é‚£äº›åœ°å€ç©ºé—´ä¸‹ã€‚flashè¯»å–å‡ºçš„æ•°æ®å¹¶æ²¡æœ‰å¡«å……åˆ°é‚£ä¸ªè¢«ç ´åçš„åœ°å€ä¸‹ï¼Œè¿™ä¹Ÿå°±æ’é™¤äº†DMAçš„é—®é¢˜ã€‚\næœ¬æ¥åˆ°æ­¤æˆ‘å†³å®šæ”¾è¿‡å­˜å‚¨ä»‹è´¨ä¸Šçš„é©±åŠ¨ä»£ç ï¼Œä½†æ˜¯æˆ‘è¿˜æ˜¯åšäº†ä¸€äº›å°è¯•ã€‚æˆ‘åœ¨flashé©±åŠ¨çš„è¯»å–å‡½æ•°å…¥å£å¤„å…ˆæ£€æŸ¥ä¸€éé‚£ä¸ªå†…å­˜è¾¹ç•Œæ˜¯å¦ç ´åï¼Œåœ¨å‡ºå£å†æ£€æŸ¥ä¸€éå†…å­˜æ˜¯å¦ç ´åã€‚\nå–œï¼ğŸ‰ğŸ‰ğŸ‰\nå±…ç„¶é—®é¢˜å°±åœ¨è¿™ä¸ªé©±åŠ¨å‡½æ•°ä¸­ã€‚é€šè¿‡é€è¡Œåˆ†æï¼Œæœ€ç»ˆç¡®è®¤é—®é¢˜ç‚¹ã€‚\nflashè¯»å–å‡½æ•°å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š\n\n1.æ„é€ æ•°æ®è¯»å–è¯·æ±‚ï¼›\n2.å‘é€æ•°æ®è¯»å–è¯·æ±‚ï¼›\n3.é€šè¿‡DMAå°†æ•°æ®ç›´æ¥ä¼ è¾“åˆ°å†…å­˜ä¸­ï¼›\n4.å°†è¯¥æ®µå†…å­˜ç›¸å¯¹åº”çš„Cacheæ¸…é™¤ï¼›\n\nå°±æ˜¯ç¬¬4ä¸ªä»£ç å­˜åœ¨é—®é¢˜ï¼Œåœ¨å­˜åœ¨Cacheçš„ç³»ç»Ÿä¸­ï¼Œä½¿ç”¨DMAä¼ è¾“æ•°æ®åï¼Œä¸ºäº†åé¢CPUä»ç‰©ç†åœ°å€ä¸­å–å¾—æœ‰æ•ˆæ•°æ®ï¼Œéœ€è¦å°†Cacheä¸­çš„æ•°æ®æ¸…é™¤æ‰ï¼Œè¿™æ˜¯éå¸¸å¿…è¦ä¸”æ­£å¸¸çš„é€»è¾‘(é™¤éå†…å­˜ä¸å…·å¤‡Cacheç‰¹æ€§)ã€‚\nä½†æ˜¯è¿™é‡Œå¿½ç•¥äº†ä¸€ä¸ªç‚¹ï¼Œæ¸…é™¤Cacheçš„æ“ä½œå¹¶ä¸æ˜¯æƒ³æ¸…é™¤é‚£æ®µå†…å­˜å°±æ¸…é™¤é‚£æ®µå†…å­˜ï¼Œå®ƒæ˜¯éœ€è¦å­—èŠ‚å¯¹é½çš„ï¼Œ32å­—èŠ‚å¯¹é½ï¼Œåœ¨è¿™ä¸ªç³»ç»Ÿä¸­Cacheçš„æ“ä½œæ¥å£ä¸æ˜¯åŸç”Ÿçš„CMSISæ¥å£ï¼Œè€Œæ˜¯åŒ…è£…è¿‡çš„ï¼Œå®ƒä¸ºäº†ä¿è¯æ•°æ®æ“ä½œå¯é ï¼Œå®ƒä¼šè‡ªåŠ¨å¯¹é½åˆ°32å­—èŠ‚çš„è¾¹ç•Œä¸Šï¼Œé¦–å°¾å‡æ˜¯è¿™æ ·ã€‚å¦‚æœæ“ä½œçš„å†…å­˜åœ°å€ä¸æ˜¯32å­—èŠ‚å¯¹é½æ—¶ï¼Œä¼šå¯¼è‡´åœ¨æ¸…é™¤Cacheæ—¶é”™è¯¯çš„å°†æœŸæœ›å†…å­˜å¤–çš„æ•°æ®éƒ½æ¸…é™¤æ‰äº†ï¼Œè€Œè¿™éƒ¨åˆ†æ•°æ®å¯èƒ½è¿˜æ²¡æœ‰åŠæ—¶çš„å†™å…¥åˆ°ç‰©ç†å†…å­˜ä¸­ã€‚è¿™ç±»ä¼¼ä¸ä¸€ç§æ•°æ®æº¢å‡ºçš„æ•ˆæœï¼Œä½†æ˜¯åˆä¸ä¸€èˆ¬çš„å†…å­˜æº¢å‡ºæœ‰å¾ˆå¤§çš„åŒºåˆ«ã€‚\n\næœ€ç»ˆï¼Œæˆ‘å°è¯•äº†ä¸€ä¸ªç®€å•çš„è§£å†³åŠæ³•ï¼Œåœ¨è§¦å‘DMAæ•°æ®ä¼ è¾“å‰ï¼Œå°†Cacheä¸­çš„æ•°æ®å…ˆåŒæ­¥åˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œè¿™æ ·é—®é¢˜å°±è§£å†³äº†ã€‚åªéœ€è¦ä¸€è¡Œä»£ç ï¼Œå®Œç¾è§£å†³äº†catæŒ‡ä»¤å¯¼è‡´ç³»ç»Ÿå‡ºé”™çš„é—®é¢˜ï¼Œè¿åŒæœ€å¼€å§‹æ–‡ä»¶ä¼ è¾“æ•°æ®å¼‚å¸¸éƒ½ä¸€å¹¶è§£å†³äº†ã€‚åˆ°è¿™é‡Œä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆå†…å­˜æ–­ç‚¹ä¸ºä»€ä¹ˆæ²¡æœ‰ç”Ÿæ•ˆï¼Œç”±Cacheå¼•å…¥çš„å†…å­˜é—®é¢˜ä½¿ç”¨å†…å­˜æ–­ç‚¹çš„æ’æŸ¥æ‰‹æ®µä¸ä¸€å®šæœ‰æ•ˆã€‚å†è¯´ä¸€å¥ï¼Œé€šè¿‡DMAå†™å…¥çš„å†…å­˜æ•°æ®ï¼Œå†…å­˜æ–­ç‚¹ä¹Ÿæ˜¯æ— æ³•æ•è·çš„ã€‚\nè¿™ä¸ªé—®é¢˜ä»¥å‰æ²¡æœ‰æš´éœ²å‡ºæ¥è‚¯èƒ½æ˜¯å› ä¸ºä»¥å‰çš„é‚£ä¸ªå†…å­˜åœ°å€æ­£å¥½æ˜¯32å­—èŠ‚å¯¹é½çš„ã€‚æ£€æŸ¥GITæäº¤è®°å½•ï¼Œè¯¥é—®é¢˜å·²ç»æš´éœ²å¾ˆé•¿æ—¶é—´äº†ã€‚\né€šè¿‡è¿™ä¸ªé—®é¢˜ï¼Œååº”äº†æ»¥ç”¨SCB_InvalidateDCache_by_Addr()æ¥å£å¯¼è‡´æ•°æ®æº¢å‡ºçš„é—®é¢˜ã€‚åé¢éœ€è¦å†æ¬¡æ’æŸ¥ç³»ç»Ÿä¸­å…¶å®ƒCacheæ“ä½œï¼Œçœ‹çœ‹æ˜¯å¦å­˜åœ¨ç±»ä¼¼é—®é¢˜ã€‚\n"},{"title":"æˆ‘ä»¬éœ€è¦éå¸¸è°¨æ…çš„ä½¿ç”¨Cache","url":"/2024/07/11/%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E9%9D%9E%E5%B8%B8%E8%B0%A8%E6%85%8E%E7%9A%84%E4%BD%BF%E7%94%A8Cache/","content":"æœ€è¿‘åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­é‡åˆ°ä¸€ä¸ªè½¯ä»¶ä¸Šçš„é—®é¢˜ï¼Œè¯¥é—®é¢˜éå¸¸æŠ˜ç£¨äººã€‚\nåœ¨ä¸€ä¸ªåµŒå…¥å¼è½¯ä»¶ç³»ç»Ÿä¸­ä½¿ç”¨WiFiç½‘ç»œå¹¶é€šè¿‡FTPæœåŠ¡è¯»å–è®¾å¤‡å†…å­˜å‚¨åœ¨SDä¸Šçš„æ–‡ä»¶ï¼Œå°±æ˜¯è¿™æ ·ä¸€ä¸ªçœ‹èµ·æ¥éå¸¸ç®€å•çš„é€»è¾‘ï¼Œæœ€è¿‘åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°äº†ä¸€ç‚¹é—®é¢˜ã€‚\nå‘ç°å°æ¦‚ç‡æƒ…å†µä¸‹æ–‡ä»¶ä¼ è¾“ä¼šå¯¼è‡´ç³»ç»Ÿå´©æºƒï¼Œå´©æºƒçš„é—®é¢˜ç‚¹ä¹Ÿæ˜¯éå¸¸å¥‡æ€ªçš„ï¼Œä¼šçˆ†å‘å‡ºå¾ˆå¤šç¨€å¥‡å¤æ€ªçš„é—®é¢˜(åŒ…æ‹¬ä½†ä¸é™äºmallocè¿”å›nullã€å†…å­˜ç”³è¯·å¡æ­»ã€ç½‘ç»œåè®®æ ˆæ•°æ®å¼‚å¸¸ç­‰ç­‰)ï¼Œä¸”è¯¥æ•…éšœä¼¼ä¹å¾ˆéš¾åœ¨è°ƒè¯•æ¨¡å¼ä¸‹å¤ç°ã€‚\nè¯¥æ•…éšœä»…åœ¨ä¸Šè¿°æ¡ä»¶ä¸‹ä¼šè§¦å‘ï¼Œå…¶å®ƒæƒ…å†µä¸‹æ²¡æœ‰å¤ç°ï¼š\n\né€šè¿‡FTPè¯»å–å†…å­˜ä¸­çš„æ–‡ä»¶(ramfs)ä¸ä¼šå¯¼è‡´ç³»ç»Ÿå´©æºƒ\né€šè¿‡USBè¿æ¥ç½‘ç»œï¼Œä»ç„¶é€šFTPä¼ è¾“SDå¡ä¸Šçš„æ–‡ä»¶ï¼Œç³»ç»Ÿä¸ä¼šå´©æºƒ\nåœ¨ç³»ç»Ÿå†…é€šè¿‡æ–‡ä»¶æ‹·è´æ–¹æ³•åœ¨SDå’Œnandç›´æ¥ä¼ è¾“æ–‡ä»¶ï¼Œç³»ç»Ÿä¸ä¼šå´©æºƒ\nå…³é—­ç³»ç»ŸD-Cacheï¼Œä½¿ç”¨wifié€šè¿‡FTPè¯»å–SDå¡çš„æ–‡ä»¶ï¼Œç³»ç»Ÿä¸ä¼šå´©æºƒ\n\nåˆ†æä»¥ä¸Šæƒ…å†µï¼Œå¥½åƒå¾ˆéš¾ç¡®å®šé—®é¢˜ç‚¹ã€‚ä½†è¯¥æ•…éšœå¤§æ¦‚ç‡æ˜¯ä¸Cacheç›¸å…³çš„ï¼Œå› ä¸ºè¿™å¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆåœ¨è°ƒè¯•æ¨¡å¼ä¸‹é—®é¢˜ä¸é‚£ä¹ˆå®¹æ˜“å¤ç°ã€‚\næ•´ä¸ªç³»ç»Ÿç›¸å½“å¤æ‚ï¼Œåº•å±‚ç£ç›˜é©±åŠ¨ã€æ–‡ä»¶ç³»ç»Ÿã€æ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚ã€ç½‘ç»œåè®®æ ˆã€FTPæœåŠ¡ã€WIFIé©±åŠ¨ã€æ“ä½œç³»ç»Ÿç­‰ç­‰ã€‚æˆ‘èŠ±è´¹äº†ç›¸å½“å¤šçš„é¢æ—¶é—´å»æ¢³ç†WIFIé©±åŠ¨ä»£ç ï¼Œè¿™æ˜¯æˆ‘æœ€ä¸ç†Ÿæ‚‰çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯WIIFé©±åŠ¨çœ‹æ¥æ²¡æœ‰æ˜æ˜¾çš„é—®é¢˜ã€‚\nå…¶ä¸­å¤šä¸ªä¸ç¡¬ä»¶ç›¸å…³çš„ç»„ä»¶å‡ä¼šä½¿ç”¨åˆ°DMAå’ŒDcacheçš„æ“ä½œï¼Œå¥½åƒæ²¡æœ‰åŠæ³•æŠŠé—®é¢˜èšç„¦åˆ°ä¸€ä¸ªç‚¹ä¸Šã€‚\nç³»ç»Ÿå‡ºç°æ•…éšœæ—¶çš„ä¸€ç§å¸¸è§ç°è±¡æ˜¯å†…å­˜åˆ†é…å™¨å‡ºç°æ•…éšœï¼ŒåŒ…æ‹¬æ— æ³•åˆ†é…å†…å­˜(ä½†æ˜¾ç¤ºå­˜åœ¨å‰©ä½™å†…å­˜)ã€æ— æ³•é‡Šæ”¾å†…å­˜ç­‰ã€‚\næˆ‘è®¾è®¡äº†ä¸€ç§æ£€æŸ¥æœºåˆ¶ï¼Œå³åœ¨å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„æ—¶å€™æ£€æŸ¥ä¸€ä¸‹å†…å­˜åˆ†é…å™¨çš„é“¾è¡¨é‡Šæ”¾æ­£å¸¸ã€‚è¯¥æ–¹æ³•ç¡®å®æœ‰ç”¨ï¼Œå®ƒèƒ½å¤Ÿè¿…é€Ÿçš„æ•è·ç³»ç»Ÿæœ€è¿‘å‡ºç°æ•…éšœçš„æ—¶åˆ»ï¼Œè¿™ä½¿å¾—å¤ç°å’Œåˆ†æé—®é¢˜éå¸¸æœ‰å¸®åŠ©ã€‚\nvTaskSuspendAll();&#123;    int tot_len = 0;    BlockLink_t * pxBlock;    pxBlock = heapPROTECT_BLOCK_POINTER( xStart.pxNextFreeBlock );    while( pxBlock != pxEnd )&#123;        tot_len += pxBlock-&gt;xBlockSize;        pxBlock = heapPROTECT_BLOCK_POINTER( pxBlock-&gt;pxNextFreeBlock );    &#125;    configASSERT( tot_len == xFreeBytesRemaining );&#125;( void ) xTaskResumeAll();\nå½“å‘ç°ç³»ç»Ÿå†…å‰©ä½™å†…å­˜å’Œé“¾è¡¨ä¸­æè¿°çš„å‰©ä½™å†…å­˜ä¸ä¸€è‡´åç«‹å³ä¸­æ–­ç³»ç»Ÿè¿è¡Œã€‚\né…åˆå†…å­˜åˆ†é…æ—¥å¿—å’ŒCacheæ“ä½œæ—¥å¿—ï¼Œç¡®å®šæ˜¯SDå¡é©±åŠ¨çš„ä¸€æ¬¡INVALID DCACHEæ“ä½œåå†…å­˜åˆ†é…å™¨å°±å‡ºç°æ•…éšœäº†ã€‚\nint sdmmc_read(void *buf, int len)&#123;    // 1:    CLEAN_DCACHE(buf, len);    // 2:    SD_ReadBlocks_DMA(buf, len);    // 3:    INVALID_DCACHE(buf, len);    return 0;&#125;\n\nè§£é‡Šä¸€ä¸‹è¿™æ®µä»£ç çš„å«ä¹‰ã€‚ç¬¬3è¡Œä»£ç ï¼Œå½“ä½¿ç”¨DMAè¯»å–æ•°æ®åï¼Œéœ€è¦å°†ç¼“å­˜ä¸­çš„æ•°æ®æ¸…é™¤æ‰ï¼Œè¿™æ˜¯ä¸ºäº†åç»­CPUè¯»å–æ•°æ®æ—¶å¯ä»¥è¯»å–åˆ°ç‰©ç†å†…å­˜ä¸­çš„æ•°æ®ï¼Œè€ŒéCacheä¸­çš„æ•°æ®ã€‚ç¬¬1è¡Œä»£ç ï¼Œè¿™æ®µä»£ç æœ‰ç‚¹ä¸å¤ªå¥½è§£é‡Šï¼Œå½“bufå’ŒCacheè¾¹ç•Œæœªå¯¹é½æ—¶ï¼Œåç»­çš„ç¬¬ä¸‰æ­¥å¯èƒ½ä¼šä½¿å¾—bufè¾¹ç•Œå¤–åˆ°Cacheè¾¹ç•Œä¸­çš„æ•°æ®è¢«æ¸…é™¤æ‰ï¼Œè¿™å°±ä½¿å¾—ç³»ç»Ÿå†…çš„æ•°æ®å®Œæ•´æ€§æ— æ³•å¾—åˆ°ä¿è¯ï¼Œæ‰€ä»¥è®¾è®¡äº†ç¬¬1æ­¥çš„ä»£ç æ¥å°†é™„è¿‘çš„æ•°æ®å…¨éƒ¨åŒæ­¥åˆ°å†…å­˜ä¸­ã€‚\nä»¥ä¸Šçš„è®¾è®¡åœ¨æˆ‘ä»¥å‰çš„æ–‡ç« ä¸­æåˆ°è¿‡ï¼Œå¯ä»¥å»ç¿»çœ‹ä¸€ä¸‹ã€‚\nè¿™æ ·çš„è®¾è®¡åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ä¸‹å°±ä¼šæœ‰ç‚¹é—®é¢˜ï¼Œå› ä¸ºç¬¬2è¡Œä»£ç æ˜¯ä¸€ä¸ªè€—æ—¶æ“ä½œï¼Œè¿™å°±ä½¿å¾—å·²ç»è¢«åŒæ­¥åˆ°å†…å­˜ä¸­çš„æ•°æ®å¯èƒ½åˆè¢«å¦ä¸€ä¸ªçº¿ç¨‹å–å‡ºæ”¾å…¥Cacheï¼Œè€Œåç»­çš„ç¬¬3è¡Œä»£ç è¿˜ä¸çŸ¥é“è¿™æ ·çš„æƒ…å†µï¼Œç›´æ¥å°†ç¼“å­˜æ¸…é™¤æ‰äº†ï¼Œå¯¼è‡´ç³»ç»Ÿå†…éƒ¨åˆ†æ•°æ®ä¸¢å¤±ï¼Œè¿›è€Œå¯¼è‡´å‡ºç°ç³»ç»Ÿå´©æºƒçš„æƒ…å†µã€‚\nä¸€ä¸ªå®‰å…¨çš„åšæ³•æ˜¯ä¸ºDMAè¯»å–æ“ä½œå•ç‹¬åˆ†é…ä¸€å—ä¸Cacheè¾¹ç•Œå¯¹é½çš„ä¸€å—ç¼“å­˜ï¼Œç”¨å®ƒä½œä¸ºæ•°æ®ä¼ è¾“çš„æ¡¥æ¢ï¼Œç”±DMAè¯»å–å®Œæˆåå†ç”±CPUå°†æ•°æ®æ¬è¿åˆ°å…¶å®ƒå†…å­˜ç©ºé—´ä¸‹ã€‚ä½†æ˜¯è¿™æ ·æœ‰ä¸€äº›ç¼ºé™·ï¼Œå³æ— æ³•è¿ç»­è¯»å–å¤šå—æ•°æ®ï¼Œè¿™ä¼šå¯¼è‡´SDMMCå‡ºç°ä¸¥é‡çš„æ€§èƒ½ç“¶é¢ˆï¼Œä¸€èˆ¬SDMMCè¿ç»­è¯»å–å¤šå—æ‰‡åŒºæœ‰æ›´æ˜æ˜¾çš„é€Ÿåº¦ä¼˜åŠ¿ã€‚\næ‰€ä»¥éœ€è¦è®¾è®¡å¦å¤–ä¸€ç§æ–¹æ³•æ¥å®‰å…¨çš„æ¸…ç†Cacheï¼Œä¸”å¿…é¡»è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚\n#define CACHE_SIZE (32)void InvalidDCache(void *addr, int len)&#123;    __disable_irq();    static char cache_head_buf[CACHE_SIZE - 1];    static char cache_end_buf[CACHE_SIZE - 1];    uint32_t cache_head_addr;    uint32_t cache_head_len;    uint32_t cache_end_addr;    uint32_t cache_end_len;    cache_head_addr = ((uint32_t)(addr) &amp; ~(CACHE_SIZE - 1));    cache_head_len = ((uint32_t)(addr) &amp; (CACHE_SIZE - 1));    cache_end_addr = ((uint32_t)(addr) + len);    cache_end_len = CACHE_SIZE - (cache_end_addr &amp; (CACHE_SIZE - 1));    if(cache_end_len == CACHE_SIZE)&#123;        cache_end_len = 0;    &#125;    if(cache_head_len &gt; 0)&#123;        memcpy(cache_head_buf, cache_head_addr, cache_head_len);    &#125;    if(cache_end_len &gt; 0)&#123;        memcpy(cache_end_buf, cache_end_addr, cache_end_len);    &#125;    SCB_InvalidateDCache_by_Addr(addr, len);    if(cache_head_len &gt; 0)&#123;        memcpy(cache_head_addr, cache_head_buf, cache_head_len);    &#125;    if(cache_end_len &gt; 0)&#123;        memcpy(cache_end_addr, cache_end_buf, cache_end_len);    &#125;    __enable_irq();&#125;\nè¿™æ®µä»£ç å¯ä»¥è§£å†³ç¼“å­˜Invalidateå¸¦æ¥çš„é£é™©ï¼Œå®ƒå°†è¾¹ç•Œä¸Šçš„å†…å­˜ä¸»åŠ¨ä¿å­˜äº†ä¸€éã€‚\nä½†è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ä¼¼ä¹ä¸å¯å¿½ç•¥ï¼Œé‚£å°±æ˜¯ç¼“å­˜è‡ªåŠ¨å†™å…¥çš„æƒ…å†µï¼Œå½“åˆ‡æ¢çº¿ç¨‹ä¸Šä¸‹æ–‡åæ‰§è¡Œäº†å…¶å®ƒçš„å†…å­˜å¯†é›†æ“ä½œï¼Œå½“ç¼“å­˜ä¸è¶³æ—¶ï¼Œå¯èƒ½å¯¼è‡´åŸå…ˆçš„ç¼“å­˜è¢«è‡ªåŠ¨å†™å…¥åˆ°å†…å­˜ä¸­ï¼Œå°¤å…¶æ˜¯è¾¹ç•Œä¸Šçš„ï¼Œè¿™ä»ç„¶å¯èƒ½å‡ºç°æ•°æ®å¤±æ•ˆçš„é—®é¢˜ã€‚\næœ€ç»ˆï¼Œæˆ‘é€‰æ‹©ç‰ºç‰²æ€§èƒ½æ¥ä¿è¯å¯é æ€§ï¼Œé€šè¿‡ä¸€ä¸ªä¸­é—´ç¼“å­˜æ¥è¯»å–æ•°æ®ï¼Œç¡®ä¿DMAå’ŒCacheçš„æ“ä½œéƒ½æ˜¯å®‰å…¨å¯é çš„ã€‚å½“ç„¶åœ¨å®ç°è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡æ£€æŸ¥è¾“å…¥çš„å†…å­˜æŒ‡é’ˆæ˜¯å¦ä¸Cacheè¾¹ç•Œå¯¹é½ï¼Œå¦‚æœæ˜¯å¯¹é½çš„æƒ…å†µï¼Œé‚£ä¹ˆå°±å¯ä»¥ç»•è¿‡ä¸­é—´ç¼“å­˜ç›´æ¥è¯»å–æ•°æ®ã€‚\nCacheçš„é—®é¢˜æ€»æ˜¯é‚£ä¹ˆæœ‰æ„æ€ã€‚æœ€å¥½çš„æƒ…å†µè¿˜æ˜¯åº”è¯¥åœ¨è½¯ä»¶è®¾è®¡æ—¶å°±èƒ½å¤Ÿä¿è¯æ•°æ®è¾¹ç•Œå¯¹é½ï¼Œæˆ–è€…ç‰ºç‰²ä¸€å®šçš„æ€§èƒ½æ¥ä¿è¯æ•°æ®çš„å¯é æ€§å’Œç³»ç»Ÿå®‰å…¨æ€§ã€‚\nPSï¼šä¸ºä»€ä¹ˆwifiä¼ è¾“æ•°æ®å¼‚å¸¸è€ŒUSBç½‘å¡ä¼ è¾“æ•°æ®æ­£å¸¸å‘¢ï¼Ÿå› ä¸ºUSBç½‘å¡é©±åŠ¨å†…éƒ¨æ²¡æœ‰é¢‘ç¹çš„å†…å­˜ç”³è¯·æ“ä½œï¼Œè€Œwifiè®¾å¤‡é©±åŠ¨ä¸­æœ‰é¢‘ç¹çš„å†…å­˜ç”³è¯·æ“ä½œã€‚å‡ºç°Cacheé—®é¢˜çš„é‚£å—å†…å­˜æ­£å¥½æ˜¯ä»å †å†…è·å–çš„ï¼Œä¸”æ•…éšœè¾¹ç•Œæ­£å¥½å‘½ä¸­å†…å­˜ç®¡ç†å™¨çš„ç©ºé—²é“¾è¡¨æ•°æ®é¡¹ã€‚æ‰€ä»¥é¢‘ç¹çš„å†…å­˜ç”³è¯·æ“ä½œä¼šå¯¼è‡´è¯¥é—®é¢˜æ›´å®¹æ˜“å¤ç°ã€‚\n"},{"title":"æ›´ä¼˜é›…çš„ä½¿ç”¨Protothreadsåç¨‹æ¡†æ¶","url":"/2023/08/30/%E6%9B%B4%E4%BC%98%E9%9B%85%E7%9A%84%E4%BD%BF%E7%94%A8Protothreads%E5%8D%8F%E7%A8%8B%E6%A1%86%E6%9E%B6/","content":"PTåç¨‹æ¡†æ¶PT(Protothreads)æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å¤šä»»åŠ¡æ¡†æ¶ï¼ŒåŒºåˆ«äºä¸€èˆ¬åŸºäºæ ˆçš„RTOSï¼Œå®ƒå®ç°å¤šä»»åŠ¡çš„åŸºæœ¬åŸç†æ˜¯é€šè¿‡è¯­å¥é—´çš„ä»»æ„è·³è½¬æ¥å®ç°ä»»åŠ¡åˆ‡æ¢ï¼Œæ‰€ä»¥å®ç°å¤šä»»åŠ¡çš„å¼€é”€æ¯”è¾ƒå°ã€‚\næˆ‘ä»¬çœ‹ä¸€æ®µç¤ºä¾‹ä»£ç æ¥äº†è§£å…¶ç”¨æ³•ã€‚\n/** * This is a very small example that shows how to use * protothreads. The program consists of two protothreads that wait * for each other to toggle a variable. *//* We must always include pt.h in our protothreads code. */#include &quot;pt.h&quot;#include &lt;stdio.h&gt; /* For printf(). *//* Two flags that the two protothread functions use. */static int protothread1_flag, protothread2_flag;/** * The first protothread function. A protothread function must always * return an integer, but must never explicitly return - returning is * performed inside the protothread statements. * * The protothread function is driven by the main loop further down in * the code. */static intprotothread1(struct pt *pt)&#123;  /* A protothread function must begin with PT_BEGIN() which takes a     pointer to a struct pt. */  PT_BEGIN(pt);  /* We loop forever here. */  while(1) &#123;    /* Wait until the other protothread has set its flag. */    PT_WAIT_UNTIL(pt, protothread2_flag != 0);    printf(&quot;Protothread 1 running\\n&quot;);    /* We then reset the other protothread&#x27;s flag, and set our own       flag so that the other protothread can run. */    protothread2_flag = 0;    protothread1_flag = 1;    /* And we loop. */  &#125;  /* All protothread functions must end with PT_END() which takes a     pointer to a struct pt. */  PT_END(pt);&#125;/** * The second protothread function. This is almost the same as the * first one. */static intprotothread2(struct pt *pt)&#123;  PT_BEGIN(pt);  while(1) &#123;    /* Let the other protothread run. */    protothread2_flag = 1;    /* Wait until the other protothread has set its flag. */    PT_WAIT_UNTIL(pt, protothread1_flag != 0);    printf(&quot;Protothread 2 running\\n&quot;);        /* We then reset the other protothread&#x27;s flag. */    protothread1_flag = 0;    /* And we loop. */  &#125;  PT_END(pt);&#125;/** * Finally, we have the main loop. Here is where the protothreads are * initialized and scheduled. First, however, we define the * protothread state variables pt1 and pt2, which hold the state of * the two protothreads. */static struct pt pt1, pt2;intmain(void)&#123;  /* Initialize the protothread state variables with PT_INIT(). */  PT_INIT(&amp;pt1);  PT_INIT(&amp;pt2);    /*   * Then we schedule the two protothreads by repeatedly calling their   * protothread functions and passing a pointer to the protothread   * state variables as arguments.   */  while(1) &#123;    protothread1(&amp;pt1);    protothread2(&amp;pt2);  &#125;&#125;\nä¸€ä¸ªä»»åŠ¡å°±æ˜¯ä¸€ä¸ªå•ç‹¬çš„å‡½æ•°å’Œä¸€ä¸ªè®°å½•ä»»åŠ¡çŠ¶æ€çš„å¥æŸ„ã€‚é€šè¿‡åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ä¸€ç›´æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡ç›¸å…³çš„å‡½æ•°å°±èƒ½å¤Ÿå®ç°å¤šä»»åŠ¡çš„æ•ˆæœï¼Œå› ä¸ºå®ƒæ˜¯éæŠ¢å å¼çš„ï¼Œå¦‚æœæŸä¸ªä»»åŠ¡å‡½æ•°ä¸éœ€è¦æ‰§è¡Œçš„æ—¶æœºäº†ï¼Œé‚£ä¹ˆå®ƒå°±ä¸»åŠ¨é€€å‡ºè¯¥å‡½æ•°å¹¶å°†æ‰§è¡Œæ—¶æœºè½¬ç§»åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡å‡½æ•°ã€‚ç”±äºptå¥æŸ„è®°å½•äº†å‡½æ•°å†…éƒ¨æ‰§è¡Œçš„ä½ç½®ï¼Œæ‰€ä»¥ä¸‹æ¬¡è¿›å…¥ä»»åŠ¡å‡½æ•°èƒ½å¤Ÿæ¢å¤ä¸Šä¸€æ¬¡æ‰§è¡Œçš„ä½ç½®ã€‚\nç›¸æ¯”äºä¼ ç»Ÿçš„RTOSï¼ŒPTåç¨‹çš„ç”¨æ³•ä¸å¤Ÿçµæ´»ï¼Œä»»åŠ¡ä¸èƒ½åŠ¨æ€çš„åˆ›å»ºï¼Œä»»åŠ¡çš„è°ƒåº¦æ˜¯æå‰åˆ†é…å¥½çš„ï¼Œå¦‚æœéœ€è¦å®æ—¶çš„åˆ›å»ºæˆ–è€…åˆ é™¤ä¸€ä¸ªä»»åŠ¡ï¼Œä¸Šé¢çš„è¿™ç§å†™æ³•å°±ä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚\nåŸºäºPTå®ç°ä¸€å¥—æ›´ä¼˜é›…çš„ä»»åŠ¡æ¡†æ¶ä¸»è¦æ˜¯éœ€è¦è§£å†³PTåç¨‹æ¡†æ¶ä¸èƒ½åŠ¨æ€åˆ›å»ºä»»åŠ¡çš„é—®é¢˜ï¼Œè§£å†³çš„åŠæ³•æ˜¯ä½¿ç”¨é“¾è¡¨å°†æ‰€æœ‰çš„ä»»åŠ¡ç®¡ç†èµ·æ¥ï¼Œå°†åˆ›å»ºå¥½çš„ä»»åŠ¡å°±æ”¾å…¥åˆ°é“¾è¡¨ä¸­ï¼Œå¦‚æœä»»åŠ¡ç»“æŸæˆ–åˆ é™¤å°±å°†å…¶ä»é“¾è¡¨ä¸­åˆ é™¤ã€‚å®ç°ä¸€ä¸ªè°ƒåº¦å™¨è‡ªåŠ¨è°ƒåº¦å¹¶è¿è¡Œé“¾è¡¨ä¸­çš„æ‰€æœ‰ä»»åŠ¡ã€‚ä¸ºäº†å®Œå…¨ä¿ç•™åŸå§‹PTçš„ç”¨æ³•ï¼Œè¿™é‡Œåªæ–°å¢ä»»åŠ¡åˆ›å»ºå’Œè°ƒåº¦çš„å®ç°ï¼Œå…¶ä½™ç”¨æ³•ä¿æŒä¸å˜ã€‚\nè¿™é‡Œé“¾è¡¨çš„å¼•ç”¨å‚è€ƒLinuxå†…æ ¸é“¾è¡¨ï¼Œå…¶å®ç°å’Œä½¿ç”¨éƒ½å¾ˆç®€å•ã€‚\né¦–å…ˆéœ€è¦å®šä¹‰ä¸€ä¸ªå…¨å±€çš„é“¾è¡¨ï¼Œç”¨äºç®¡ç†æ‰€æœ‰çš„ä»»åŠ¡ã€‚\n// pt_os.c#include &quot;list.h&quot;LIST_HEAD(pt_pool);\n\nå‰©ä½™çš„å†…å®¹å°±åªéœ€è¦åœ¨å¤´æ–‡ä»¶ä¸­å®ç°å³å¯ã€‚\n// pt_os.h#ifndef _PT_OS_H#define _PT_OS_H#include &quot;pt.h&quot;#include &quot;list.h&quot;typedef struct&#123;    struct list_node list;    PT_THREAD((*task)(struct pt *pt));    struct pt pt;&#125; pt_item_t;extern struct list_node pt_pool;/** * Run pt os. * OS_SCHEDULE() executes an infinite loop. *  * Example usage: * @code&#123;c&#125; * int main(void)&#123; *     //... *     for(;;)&#123; *         OS_SCHEDULE(); *     &#125; *     return 0; * &#125; * @endcode */#define OS_SCHEDULE()                                           \\    do                                                          \\    &#123;                                                           \\        pt_item_t *pt_item;                                     \\        list_for_each_entry(&amp;pt_pool, pt_item, pt_item_t, list) \\        &#123;                                                       \\            if (pt_item-&gt;task(&amp;(pt_item-&gt;pt)) &gt;= PT_EXITED)     \\            &#123;                                                   \\                list_delete(&amp;(pt_item-&gt;list)); break;           \\            &#125;                                                   \\        &#125;                                                       \\    &#125; while (0)/**  * Create a new pt task. *  * Example usage: * @code&#123;c&#125; * PT_THREAD(iwdg_task(struct pt *pt))&#123; *      static struct timer periodic_timer; *      PT_BEGIN(pt); *      timer_set(&amp;periodic_timer, 100); *      while(1)&#123; *          HAL_IWDG_Refresh(&amp;hiwdg); *          PT_WAIT_UNTIL(pt, timer_expired(&amp;periodic_timer)); *          timer_reset(&amp;periodic_timer); *      &#125; *      PT_END(pt); * &#125; *  * int main(void)&#123; *     OS_TASK_RUN(iwdg_task); *     //... *     for(;;)&#123; *         OS_SCHEDULE(); *     &#125; *     return 0; * &#125; * @endcode */#define OS_TASK_RUN(func)                            \\    do                                               \\    &#123;                                                \\        static pt_item_t pt_##_func;                 \\        pt_##_func.task = func;                      \\        PT_INIT(&amp;(pt_##_func.pt));                   \\        list_add_head(&amp;pt_pool, &amp;(pt_##_func.list)); \\    &#125; while (0)#endif\n\nè¿™é‡Œå®šä¹‰ä»»åŠ¡ç»“æ„pt_item_tï¼Œç›¸æ¯”ä¸åŸç”ŸPTï¼Œæ¯ä¸ªä»»åŠ¡ä¼šå¤šå ç”¨12å­—èŠ‚çš„RAMï¼Œæ­¤å¤–å°±æ²¡æœ‰å¤šä½™çš„å¼€é”€äº†ã€‚ä½¿ç”¨OS_TASK_RUN()æ–¹æ³•å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ä»»åŠ¡ï¼Œå®ƒå¯ä»¥å°†PTä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡åˆ—è¡¨ä¸­ã€‚OS_SCHEDULE()æ–¹æ³•ç”¨äºè°ƒåº¦æ‰€æœ‰çš„PTä»»åŠ¡ï¼Œå®ƒéœ€è¦æ”¾å…¥åˆ°ä¸€ä¸ªå¾ªç¯ä¸­ä¸€ç›´æ‰§è¡Œï¼Œå½“æŸä¸ªä»»åŠ¡æ‰§è¡Œé€€å‡ºåå¯ä»¥å°†å®ƒä»ä»»åŠ¡åˆ—è¡¨ä¸­è‡ªåŠ¨åˆ é™¤ã€‚\nè¿™é‡Œå­˜åœ¨ä¸€äº›ç¼ºé™·ï¼Œä»»åŠ¡çš„å…¥å£ä¸èƒ½ä¼ é€’å‚æ•°ï¼Œå¦‚æœä¸€å®šè¦å®ç°è¿™ä¸ªåŠŸèƒ½é‚£ä¹Ÿæ˜¯å¾ˆå®¹æ˜“çš„ï¼Œå¯¹pt_item_tä¸­çš„ä»»åŠ¡ç­¾ååšè°ƒæ•´å³å¯ã€‚ \né€šè¿‡è¿™æ®µçŸ­å°çš„ä»£ç (å¤§çº¦20è¡Œ)å°±æ‹“å±•äº†åŸç”ŸPTçš„å®ç°ï¼Œè¾¾åˆ°ä»»åŠ¡çš„è‡ªåŠ¨è°ƒåº¦ï¼Œä»»åŠ¡çš„åŠ¨æ€åˆ›å»ºå’Œåˆ é™¤ï¼Œè¿™æ ·åœ¨èµ„æºå—é™çš„å•ç‰‡æœºå†…èƒ½å¤Ÿå®ç°æ›´åŠ çµæ´»çš„å¼‚æ­¥ç¼–ç¨‹ã€‚\n"},{"title":"ç§»æ¤MicroPythonæ—¶çš„ä¸€äº›æ€è€ƒ","url":"/2024/11/06/%E7%A7%BB%E6%A4%8DMicroPython%E6%97%B6%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/","content":"ä»Šå¹´4æœˆä»½å°è¯•æ‰‹åŠ¨å°†MicroPythonç§»æ¤åˆ°è‡ªå·±çš„å¹³å°ä¸Šï¼Œåœ¨ç§»æ¤çš„è¿‡ç¨‹ä¸­å‘ç°MicroPythonçš„å†…éƒ¨æ¨¡å—æœ‰å¤§é‡çš„åº•å±‚ä¾èµ–ï¼Œè¿™ä½¿å¾—ç§»æ¤å·¥ä½œè§†ä¹æœ‰ç‚¹åºå¤§ã€‚å½“æ—¶åŸºæœ¬ä¸Šä»…å®Œæˆäº†BASIC_FEATURESç­‰çº§çš„ç§»æ¤ï¼Œç›¸å½“äºå®Œæˆäº†æœ€å°ç³»ç»Ÿï¼Œåœ¨REPLå¯ä»¥è‰¯å¥½è¿è¡Œï¼Œä½†æ˜¯ç¼ºå°‘äº†å¤§é‡çš„åŸºç¡€åº“ï¼Œä½¿å¾—å®ƒå‡ ä¹æ²¡æœ‰å¤ªå¤§çš„å®ç”¨æ€§ã€‚\næœ€è¿‘æˆ‘åˆæƒ³èµ·äº†è¿™ä¸ªä»¥å‰é—ç•™çš„å·¥ä½œï¼Œæˆ‘å†³å®šå°†å®ƒå®Œå–„ä¸€äº›ï¼Œå°½é‡è¾¾åˆ°EXTRA_FEATURESçš„ç§»æ¤ç­‰çº§ï¼Œè¿™æ„å‘³ç€éœ€è¦å¤§é‡çš„ç§»æ¤å·¥ä½œï¼Œä¸»è¦æ˜¯å¤šçº¿ç¨‹ç¯å¢ƒã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œåè®®æ ˆã€èŠ¯ç‰‡çº§å¤–è®¾ç­‰å†…å®¹çš„ç§»æ¤ã€‚\nå¤§éƒ¨åˆ†ç§»æ¤å·¥ä½œéƒ½å¯ä»¥å‚è€ƒå®˜æ–¹çš„portsä¾‹å­åšå‚è€ƒï¼Œä½†åœ¨æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€å¤šçº¿ç¨‹ä¸Šå´åªèƒ½è‡ªå·±åŠªåŠ›äº†ï¼Œå› ä¸ºè¿™éƒ¨åˆ†å†…å®¹æ˜¯æˆ‘çš„ç³»ç»Ÿä¸Šç‰¹æœ‰çš„ã€‚è¿™é‡Œè¯´æ˜ä¸€ç‚¹ï¼Œæˆ‘å°†Micropythonç§»æ¤åˆ°æˆ‘çš„ç³»ç»Ÿä¸­æ˜¯ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„æ¨¡å—è¿è¡Œï¼Œå¯éšæ—¶åœæ­¢å’Œé‡å¯ï¼Œä¸”å®ƒä½œä¸ºç‹¬ç«‹çš„çº¿ç¨‹è¿è¡Œä¸ä¼šå¯¹å…¶å®ƒçº¿ç¨‹äº§ç”Ÿä»»ä½•å½±å“ã€‚\né¦–å…ˆç½‘ç»œéƒ¨åˆ†çš„å†…å®¹ï¼Œç”±äºæˆ‘çš„æœ¬æœºå·²ç»è¿è¡Œäº†ç½‘ç»œåè®®æ ˆï¼Œæ‰€ä»¥åœ¨pythonä¸­ä¸å•ç‹¬è¿è¡Œåè®®æ ˆäº†ï¼Œé€šè¿‡NICæä¾›ä¸€å¥—socketçš„æ§åˆ¶æ¥å£åˆ°MicroPythonå†…éƒ¨å°±è¡Œäº†ï¼Œè¿™éƒ¨åˆ†MicroPythonè€ƒè™‘çš„æ¯”è¾ƒå‘¨åˆ°ï¼Œå¯ä»¥é€šè¿‡å®å®šä¹‰MICROPY_PORT_NETWORK_INTERFACESæ¥å¯¼å…¥è‡ªå·±çš„socketæ§åˆ¶å™¨ã€‚è®¾è®¡å®Œè‡ªå·±çš„socketæ§åˆ¶å™¨éœ€è¦é€šè¿‡mod_network_register_nic()æ³¨å†Œåˆ°MicroPythonå†…éƒ¨socketæ¨¡å—ã€‚\næ–‡ä»¶ç³»ç»Ÿè¦ç¨å¾®éº»çƒ¦ä¸€äº›ï¼Œæ— æ³•ç›´æ¥æ¥å…¥è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæœ€ç†æƒ³çš„åŠæ³•æ˜¯é‡æ„MBFSæ¨¡å—ï¼ŒMBFSæ–‡ä»¶ç³»ç»Ÿæœ¬èº«ä½œä¸ºä¸€ä¸ªå¾…å¯¼å…¥çš„æ–‡ä»¶ç³»ç»Ÿæ¨¡å—ï¼Œå¯¹å®ƒçš„ä¿®æ”¹ä¸ä¼šå¯¹MicroPythonçš„ä»£ç äº§ç”Ÿå¤ªå¤šä¾µç•¥æ€§çš„ä¿®æ”¹ã€‚æ–‡ä»¶ç³»ç»Ÿçš„æ¥å£ä»ç„¶ç”±ç³»ç»Ÿå¹³å°æä¾›ï¼Œpythonç›´æ¥å‘ç³»ç»Ÿç”³è¯·æ–‡ä»¶èµ„æºã€‚\nè¿™é‡Œè¯´ä¸€ä¸ªå¤§å‘ï¼Œå›°æ‰°æˆ‘è®¸ä¹…ï¼Œåœ¨è‡ªå®šä¹‰æ„é€ æ–‡ä»¶å¯¹è±¡æ˜¯éœ€è¦é™„å¸¦finaliseræ ‡è®°ï¼Œå¦åˆ™GCå›æ”¶å¯¹è±¡æ—¶æ— æ³•å…³é—­ç³»ç»Ÿä¸­çš„æ–‡ä»¶ã€‚ç”±äºè¿™ä¸ªMicroPythonä½œä¸ºä¸€ä¸ªå­æ¨¡å—è¿è¡Œï¼Œå®ƒé€€å‡ºåç³»ç»Ÿè¿˜è¦ç»§ç»­è¿è¡Œï¼Œè¿™ä½¿å¾—å®ƒå ç”¨çš„æ–‡ä»¶æœªå…³é—­ä¸”éƒ¨åˆ†ç³»ç»Ÿçº§çš„å†…å­˜éƒ½æ²¡æœ‰å¾—åˆ°é‡Šæ”¾ï¼Œè¿™ä¼šå¯¼è‡´ç›¸å½“ä¸¥é‡çš„é—®é¢˜ã€‚\nç§»æ¤æ–‡ä»¶ç³»ç»Ÿæ—¶éœ€è¦æ³¨æ„åˆ°ä¸Šä¸‹æ–‡ç®¡ç†å™¨åè®®çš„å­˜åœ¨ï¼Œå½“æ‰§è¡Œ__exit__()æ–¹æ³•åæ–‡ä»¶å·²ç»å…³é—­ï¼Œä½†æ˜¯åç»­åœ¨æ–‡ä»¶å¯¹è±¡é”€æ¯æ—¶ä¼šå†æ¬¡æ‰§è¡Œ__del__()æ–¹æ³•æ¥å…³é—­æ–‡ä»¶ï¼Œåœ¨__exit__()æ–¹æ³•ä¸­å…³é—­ä¹Ÿè®¸ä¸æ˜¯å¿…è¦çš„ï¼Œä½†æ˜¯å‚è€ƒæºç ä¸­å®ç°çš„FATã€LFSç­‰æ–‡ä»¶ç³»ç»Ÿæ¥çœ‹ï¼Œå®ƒä»¬çš„__del__()æ–¹æ³•éƒ½æ˜¯æ‰§è¡Œæ–‡ä»¶å…³é—­çš„åŠ¨ä½œã€‚æ‰€ä»¥è¿™æ„å‘³è¿™åœ¨è®¾è®¡è¿™éƒ¨åˆ†å†…å®¹æ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„æ–‡ä»¶å…³é—­å¤šæ¬¡æ‰§è¡Œçš„é—®é¢˜ï¼Œéœ€è¦æ­£ç¡®å¤„ç†æ–‡ä»¶çš„æ‰“å¼€çŠ¶æ€ä»¥ç¡®ä¿æ–‡ä»¶ä¸ä¼šè¢«æ‰§è¡Œé‡å¤å…³é—­çš„åŠ¨ä½œã€‚\nå¯¹å¤šçº¿ç¨‹æ¨¡å—çš„æ”¯æŒä»ç„¶èŠ±è´¹äº†ç›¸å½“å¤šçš„è°ƒè¯•ç²¾åŠ›ï¼Œä¸»è¦æ˜¯åœ¨GCæœºåˆ¶ä¸Šè´¹äº†äº›åŠŸå¤«ã€‚MicroPythonçš„GCä»…ä½¿ç”¨æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œæ²¡æœ‰å¼•ç”¨è®¡æ•°ï¼Œæ‰€ä»¥åœ¨æ ‡è®°é˜¶æ®µéœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚\nGCæœºåˆ¶é€šè¿‡æœç´¢å¤„ç†å™¨æ ˆä¸Šçš„å®ä¾‹å¯¹è±¡æ¥è¿›è¡Œæ ‡è®°æœ‰æ•ˆå†…å­˜åŒºåŸŸã€‚å¯¹äºå½“å‰çº¿ç¨‹æ¥è¯´ï¼Œé™¤äº†æ ˆåŒºåŸŸï¼Œè¿˜æœ‰CPUä¸­çš„å¯„å­˜å™¨ä¹Ÿéœ€è¦è¿›è¡Œæœç´¢ã€‚å½“æœç´¢åˆ°gcå†…å­˜å¯¹è±¡åå°±è¿›è¡Œæ ‡è®°å¤„ç†ã€‚å¯¹äºå¤šçº¿ç¨‹æ¥è¯´ï¼Œæ¯æ¬¡æ ‡è®°é˜¶æ®µéƒ½éœ€è¦æ£€æŸ¥æ‰€æœ‰çº¿ç¨‹çš„æ ˆç©ºé—´ï¼Œå…¶å®ƒçº¿ç¨‹çš„å¯„å­˜å™¨æ•°æ®å·²ç»å‹å…¥æ ˆäº†ï¼Œæ‰€ä»¥åªéœ€è¦è€ƒè™‘æ ˆç©ºé—´å³å¯ã€‚è·å–çº¿ç¨‹çš„æ ˆæŒ‡é’ˆåœ°å€éœ€è¦ä¾èµ–äºå¤šçº¿ç¨‹çš„åº•å±‚å®ç°ï¼Œæˆ‘è¿™é‡Œçš„å¤šçº¿ç¨‹æ˜¯ç”±FreeRTOSæä¾›çš„ï¼Œæ‰€ä»¥é€šè¿‡çº¿ç¨‹å¥æŸ„å¯ä»¥è®¿é—®åˆ°å…¶å®ƒçº¿ç¨‹çš„å®æ—¶æ ˆæŒ‡é’ˆã€‚åœ¨GCæ ‡è®°æ—¶éœ€è¦å……åˆ†éå†æ‰€æœ‰çº¿ç¨‹çš„æ ˆç©ºé—´ï¼Œç¡®ä¿æ‰€æœ‰çš„rootèŠ‚ç‚¹éƒ½è¢«æ­£ç¡®æ ‡è®°ï¼Œå¦åˆ™ä¼šå¯¼è‡´ä¸¥é‡çš„è¿è¡Œæ—¶é—®é¢˜ã€‚æ¯æ¬¡æ‰§è¡ŒGCæ—¶æ‰€æœ‰æœªè¢«æ ‡è®°çš„å†…å­˜åŒºåŸŸéƒ½å°†è¢«å›æ”¶ï¼Œæ‰€ä»¥ä¸è¦å°†ä¸€ä¸ªæœ‰ç”¨çš„GCå†…å­˜æ”¾åˆ°æ ˆä»¥å¤–çš„åŒºåŸŸï¼Œå¦‚æœæœ‰å¿…è¦ä¿å­˜ä¸€äº›å…¨å±€gcå†…å­˜å˜é‡ï¼Œæœ€å¥½æ˜¯å°†å®ƒæ”¾åˆ°mp_state_ctxå†…éƒ¨è¿›è¡Œè‡ªåŠ¨ç®¡ç†ï¼Œæˆ–è€…æ˜¯åœ¨ç¼–å†™gc_collect()æ—¶ç‰¹æ®Šå¤„ç†ã€‚\nMicroPythonçš„GCåœ¨å›æ”¶å†…å­˜æ—¶ï¼Œå¦‚æœå†…å­˜è¢«æ ‡è®°äº†finaliserï¼Œåˆ™GCä¼šè‡ªåŠ¨è°ƒç”¨å¯¹è±¡çš„ææ„å‡½æ•°æ¥å¤„ç†å¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰finaliserï¼Œå³ä½¿å¯¹è±¡å«æœ‰ææ„å‡½æ•°ï¼Œåœ¨å†…å­˜å›æ”¶æ—¶ææ„å‡½æ•°ä¹Ÿä¸ä¼šæ‰§è¡Œã€‚åœ¨MicroPythonä¸­__del__()æ–¹æ³•æ²¡æœ‰ç‰¹æ®Šåœ°ä½ï¼Œå®ƒä¸ä¼šåœ¨å¯¹è±¡åˆ é™¤æ—¶è‡ªåŠ¨æ‰§è¡Œï¼Œè¿™æ˜¯å’ŒCPythonçš„ä¸€ä¸ªæ˜æ˜¾çš„åŒºåˆ«ç‚¹ã€‚åœ¨å®ç°å†…éƒ¨æ¨¡å—æ—¶éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œä¸»åŠ¨æ‰§è¡Œgc_free()ä¹Ÿä¸ä¼šæ‰§è¡Œfinaliserçš„ææ„å‡½æ•°ï¼Œè¿™å¯èƒ½å¯¼è‡´ä¸€äº›èµ„æºæ³„éœ²çš„é—®é¢˜ï¼Œåœ¨å®ç°å†…éƒ¨æ¨¡å—æ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚æ‰€ä»¥å¯¹äºå†…å­˜çš„ç®¡ç†æ¥è¯´ï¼Œç”³è¯·çš„å†…å­˜æœ€å¥½ä¸è¦æ˜¾å¼çš„é‡Šæ”¾ï¼Œå¯ä»¥æ”¾å¿ƒçš„äº¤ç»™GCå»å¤„ç†ã€‚\nå¤–è®¾çš„ç§»æ¤å®Œæˆäº†Pinæ¨¡å—çš„éƒ¨åˆ†å†…å®¹ï¼Œå¯ä»¥å®ç°GPIOçš„æ­£å¸¸è¯»å†™ï¼Œä¸­æ–­çš„æ”¯æŒè¿˜æœªå®Œæˆã€‚\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œé™¤å¤–è®¾åŠŸèƒ½å¤–å·²ç»å®Œæˆäº†EXTRA_FEATURESçš„æ‰€æœ‰åŠŸèƒ½ï¼Œç¼–å†™äº†ä¸€äº›ç¨‹åºæ¥è¿è¡Œï¼ŒåŸºæœ¬ä¸Šç¬¦åˆé¢„æœŸï¼Œæ‰§è¡Œæ•ˆç‡ä¸Šæ˜æ˜¾æ…¢äºCä»£ç ã€‚å—é™ä¸è¿è¡Œæ—¶ä¸Šæœ‰é™çš„heapå†…å­˜ç©ºé—´ï¼Œå¤šåˆ›å»ºä¸€äº›å¯¹è±¡åå°±ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºçš„é—®é¢˜ã€‚é€šè¿‡pythoné—´æ¥è°ƒç”¨ç³»ç»Ÿå±‚é¢çš„æ–‡ä»¶ioå’Œhashæ¨¡å—æ¥å®ç°ä¸€ä¸ªæ–‡ä»¶md5è®¡ç®—å™¨ã€‚è®¡ç®—ä¸€ä¸ª2å…†å­—èŠ‚çš„æ–‡ä»¶å¤§çº¦è€—æ—¶350msï¼Œè€Œç›´æ¥åœ¨ç³»ç»Ÿå±‚é¢é€šè¿‡Cè®¡ç®—åŒæ ·çš„æ–‡ä»¶md5å€¼ï¼Œè€—æ—¶çº¦75msã€‚è¿˜æµ‹è¯•äº†ä¸€ä¸ªå¤§æ•°é˜¶ä¹˜è®¡ç®—ç¨‹åºï¼Œè®¡ç®—10000çš„é˜¶ä¹˜è€—æ—¶çº¦2.4sï¼Œè®¡ç®—30000çš„é˜¶ä¹˜è€—æ—¶çº¦22ç§’ï¼ŒMicroPythonå†…ç½®äº†å¤§æ•´æ•°è®¡ç®—ä¹Ÿæ˜¯å®ƒçš„ä¼˜åŠ¿ã€‚\n"},{"title":"ç¬¬ä¸€æ¬¡å‘FreeRTOSå†…æ ¸æäº¤ä»£ç ","url":"/2024/06/20/%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%90%91FreeRTOS%E5%86%85%E6%A0%B8%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81/","content":"èƒŒæ™¯å‰æ®µæ—¶é—´æˆ‘åœ¨æµ‹è¯•wolfSSLä¸­RSAç›¸å…³ä»£ç çš„æ—¶å€™ï¼Œå‘ç°åœ¨è¿›è¡ŒåŠ å¯†ã€è§£å¯†ã€keyç”Ÿæˆè¿‡ç¨‹ä¸­å­˜åœ¨ä¸€äº›æ€§èƒ½é—®é¢˜ã€‚åœ¨åˆ†æé—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°ç®—æ³•å¯¹å †å†…å­˜çš„ç”³è¯·éå¸¸é¢‘ç¹ã€‚ç”Ÿæˆä¸€å¯¹2048é•¿åº¦çš„å…¬é’¥å’Œç§é’¥ï¼Œä¼šè¿›è¡Œ10ä¸‡æ¬¡ä»¥ä¸Šçš„å†…å­˜ç”³è¯·ã€‚æˆ‘ä¸ºäº†è·Ÿè¸ªå‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å†…å­˜å…·ä½“ä½¿ç”¨æƒ…å†µï¼Œå†³å®šè®¾è®¡ä¸€å¥—å †å†…å­˜è·Ÿè¸ªæœºåˆ¶æ¥è¯„ä¼°å‡½æ•°çš„å†…å­˜ä½¿ç”¨æƒ…å†µã€‚\nåœ¨è®¾è®¡å†…å­˜è·Ÿè¸ªæœºåˆ¶çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªFreeRTOSå†…æ ¸ä¸­çš„Bugï¼Œæœ€ç»ˆè¯¥Bugç”±æˆ‘äº²è‡ªä¿®å¤ï¼Œç›¸å…³ä¿®å¤ä»£ç å·²ç»åˆå¹¶å…¥å†…æ ¸ä»£ç ä¸»çº¿ã€‚\nè®¾è®¡ä¸€ä¸ªå†…å­˜è·Ÿè¸ªæœºåˆ¶åŸæœ¬æƒ³è®¾è®¡ä¸€ä¸ªä¸ä¾èµ–å †å®ç°çš„çš„å†…å­˜è·Ÿè¸ªæœºåˆ¶ï¼Œä½†æˆ‘å‘ç°å„ç§å †å†…å­˜çš„å®ç°å¯èƒ½éƒ½å­˜åœ¨ä¸€äº›å·®åˆ«ï¼Œå°¤å…¶æ˜¯ä¸å¤ªå¥½åˆ†æå†…å­˜é‡Šæ”¾æ—¶ç›¸å…³å†…å­˜å—çš„å¤§å°(Cåº“çš„å®ç°å°±æ˜¯è¿™æ ·)ã€‚å¦¥ååæˆ‘å†³å®šåŸºäºç›®å‰çš„æƒ…å†µï¼Œé…åˆFreeRTOSçš„heapå®ç°æ¥è®¾è®¡ç›¸å…³çš„å†…å­˜è·Ÿè¸ªæœºåˆ¶ã€‚\nFreeRTOSé¢„ç•™äº†traceMALLOC(pv, size)å’ŒtraceFREE(pv, size)ä¸¤ä¸ªè·Ÿè¸ªå®ï¼Œç”¨äºæŒ‡ç¤ºå†…å­˜ç”³è¯·å’Œé‡Šæ”¾ã€‚å®ƒä¼šæŒ‡ç¤ºå†…å­˜æŒ‡é’ˆå’Œå†…å­˜çš„å¤§å°ã€‚\nåŸºäºè¿™ä¸¤ä¸ªå®ï¼Œæˆ‘å°±èƒ½è®°å½•å†…å­˜çš„åˆ†é…æ¬¡æ•°ã€é‡Šæ”¾æ¬¡æ•°ã€å†…å­˜çš„å®æ—¶ç”¨é‡ã€å†…å­˜çš„æœ€å¤§ç”¨é‡ã€å†…å­˜æ³„éœ²ç­‰ã€‚å†é€šè¿‡ä¸€ä¸ªç®€å•çš„å¼‚æˆ–æ“ä½œï¼Œå¯ç”¨éå¸¸æ–¹ä¾¿çš„æ£€æµ‹å†…å­˜çš„ç”³è¯·å’Œæ˜¯å¦æ˜¯å¦æˆå¯¹ã€‚\næ•´ä¸ªè·Ÿè¸ªæœºåˆ¶çš„ä»£ç å¦‚ä¸‹ï¼š\n// heapt.h#ifndef _HEAPT_H#define _HEAPT_H#include &lt;stdint.h&gt;typedef struct &#123;    uint32_t trace_enable;    uint32_t malloc_count;    uint32_t free_count;    uint32_t malloc_used_count;    uint32_t malloc_max_count;    uint32_t memory_used;    uint32_t memory_max_used;    uint32_t ptr_xor;    uint32_t malloc_faild;&#125; heapt_info_t;void heapt_init(void);void heapt_deinit(void);const heapt_info_t *heapt_get_info(void);// FreeRTOS hookvoid heapt_trace_malloc(void *ptr, uint32_t size);void heapt_trace_free(void *ptr, uint32_t size);#endif\n#include &quot;heapt.h&quot;#include &lt;string.h&gt;static heapt_info_t heapt_info;void heapt_init(void)&#123;    memset(&amp;heapt_info, 0, sizeof(heapt_info));    heapt_info.trace_enable = 1;&#125;void heapt_deinit(void)&#123;    memset(&amp;heapt_info, 0, sizeof(heapt_info));&#125;const heapt_info_t *heapt_get_info(void)&#123;    return &amp;heapt_info;&#125;void heapt_trace_malloc(void *ptr, uint32_t size)&#123;    if(heapt_info.trace_enable == 0)&#123;        return ;    &#125;    if(ptr == NULL)&#123;        heapt_info.malloc_faild++;        return ;    &#125;    heapt_info.malloc_count++;    heapt_info.malloc_used_count++;    heapt_info.memory_used += size;    if(heapt_info.malloc_used_count &gt; heapt_info.malloc_max_count)&#123;        heapt_info.malloc_max_count = heapt_info.malloc_used_count;    &#125;    if(heapt_info.memory_used &gt; heapt_info.memory_max_used)&#123;        heapt_info.memory_max_used = heapt_info.memory_used;    &#125;    heapt_info.ptr_xor ^= (uint32_t)ptr;&#125;void heapt_trace_free(void *ptr, uint32_t size)&#123;    if(heapt_info.trace_enable == 0)&#123;        return ;    &#125;    heapt_info.free_count++;    heapt_info.malloc_used_count--;    heapt_info.memory_used -= size;    heapt_info.ptr_xor ^= (uint32_t)ptr;&#125;int heapt(int argc, char * const argv[])&#123;    int ret;    if(argc &lt; 2)&#123;        printf(&quot;Usage: %s PROG [ARGS]\\r\\n&quot;, argv[0]);        return 1;    &#125;    heapt_init();    ret = run_cmd(argc - 1, &amp;argv[1]);    const heapt_info_t *info = heapt_get_info();    printf(&quot;max heap use: %lu\\r\\n&quot;, info-&gt;memory_max_used);    printf(&quot;max alloc nm: %lu\\r\\n&quot;, info-&gt;malloc_max_count);    printf(&quot;malloc count: %lu\\r\\n&quot;, info-&gt;malloc_count);    printf(&quot; free  count: %-8lu&quot;  , info-&gt;free_count);    if(info-&gt;malloc_count != info-&gt;free_count)&#123;        printf(&quot; [Warning]\\r\\n&quot;);    &#125;else&#123;        printf(&quot;\\r\\n&quot;);    &#125;    if(info-&gt;memory_used != 0)&#123;        printf(&quot;used at exit: %-8lu [Warning]\\r\\n&quot;, info-&gt;memory_used);    &#125;    if(info-&gt;ptr_xor)&#123;        printf(&quot;mem ptr xor : %08lx [Warning]\\r\\n&quot;, info-&gt;ptr_xor);    &#125;    if(info-&gt;malloc_faild)&#123;        printf(&quot;malloc faild: %-8lu [Warning]\\r\\n&quot;, info-&gt;malloc_faild);    &#125;    heapt_deinit();    return ret;&#125;\n\nåŸºäºè¯¥å†…å­˜è·Ÿè¸ªï¼Œæˆ‘æµ‹è¯•äº†ä¸€äº›å¸¸ç”¨çš„ä»£ç ï¼Œå‘ç°å®ƒéƒ½å·¥ä½œè‰¯å¥½ï¼Œç›´åˆ°æˆ‘æµ‹è¯•RSAç›¸å…³ä»£ç æ—¶ã€‚RSAä¸€ä¸ªè§£å¯†æ“ä½œå°±åŠ¨è¾„100k+æ¬¡çš„å†…å­˜ç”³è¯·é‡ï¼Œå¯¼è‡´ç³»ç»Ÿå‡ºç°äº†ä¸€äº›æ„å¤–çš„æƒ…å†µã€‚\nç³»ç»Ÿæ—¥å¿—æ˜¾ç¤ºï¼š\nmax heap use: 17264max alloc nm: 16malloc count: 279544 free  count: 279544used at exit: 4294967288 [Warning]\næ—¥å¿—æ˜¾ç¤ºå†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„å†…å­˜å­—èŠ‚æ•°ä¸ç›¸ç­‰ï¼Œå¯¼è‡´ç¨‹åºé€€å‡ºæ—¶å†…å­˜è®°å½•çš„é‡ä¸ä¸º0ã€‚èµ·åˆæˆ‘ä»¥ä¸ºæ˜¯å†…å­˜æœ‰ç”¨æ³•é—®é¢˜ï¼Œä½†wolfSSLä½œä¸ºä¸€æ¬¾å•†ä¸šçº§çš„è½¯ä»¶ï¼Œåº”è¯¥ä¸å­˜åœ¨è¿™æ ·ä½çº§çš„é”™è¯¯ã€‚ä¸”mem ptr xorä¹Ÿæ²¡æœ‰æŠ¥å‘Šå†…å­˜æ³„éœ²ï¼Œå†…å­˜ç”³è¯·å’Œé‡Šæ”¾æ¬¡æ•°ä¹Ÿæ˜¯ç›¸ç­‰çš„ã€‚è‡³æ­¤æˆ‘ä¸å¾—ä¸æ€€ç–‘FreeRTOSæä¾›çš„traceMALLOC(pv, size)å’ŒtraceFREE(pv, size)å­˜åœ¨é—®é¢˜ã€‚\nå‘ç°FreeRTOSå†…æ ¸ä»£ç å­˜åœ¨é—®é¢˜FreeRTOSçš„heap4å®ç°æ˜¯åŸºäºç©ºé—²å—é“¾è¡¨å®ç°çš„ï¼Œå°†æ‰€æœ‰çš„å¯ç”¨å†…å­˜å—ä»¥é“¾è¡¨çš„å½¢å¼è¿æ¥èµ·æ¥ï¼Œå½“åˆ†é…çš„å†…å­˜å°äºå†…å­˜å—æ—¶ï¼Œä¼šå°†å†…å­˜å—è¿›è¡Œåˆ†å‰²ï¼Œå°†å…¶ä¸­ä¸€éƒ¨åˆ†è¿”å›åˆ°ç”¨æˆ·ï¼Œå¦ä¸€éƒ¨åˆ†é‡æ–°æ’å…¥åˆ°ç©ºé—²é“¾è¡¨ä¸­ã€‚\n// pvPortMalloc()// ....if( ( pxBlock-&gt;xBlockSize - xWantedSize ) &gt; heapMINIMUM_BLOCK_SIZE )&#123;    /* This block is to be split into two.  Create a new        * block following the number of bytes requested. The void        * cast is used to prevent byte alignment warnings from the        * compiler. */    pxNewBlockLink = ( void * ) ( ( ( uint8_t * ) pxBlock ) + xWantedSize );    configASSERT( ( ( ( size_t ) pxNewBlockLink ) &amp; portBYTE_ALIGNMENT_MASK ) == 0 );    /* Calculate the sizes of two blocks split from the        * single block. */    pxNewBlockLink-&gt;xBlockSize = pxBlock-&gt;xBlockSize - xWantedSize;    pxBlock-&gt;xBlockSize = xWantedSize;    /* Insert the new block into the list of free blocks. */    pxNewBlockLink-&gt;pxNextFreeBlock = pxPreviousBlock-&gt;pxNextFreeBlock;    pxPreviousBlock-&gt;pxNextFreeBlock = heapPROTECT_BLOCK_POINTER( pxNewBlockLink );&#125;else&#123;    mtCOVERAGE_TEST_MARKER();&#125;xFreeBytesRemaining -= pxBlock-&gt;xBlockSize;if( xFreeBytesRemaining &lt; xMinimumEverFreeBytesRemaining )&#123;    xMinimumEverFreeBytesRemaining = xFreeBytesRemaining;&#125;else&#123;    mtCOVERAGE_TEST_MARKER();&#125;// ....traceMALLOC( pvReturn, xWantedSize );//...\nä¼ å…¥åˆ°traceMALLOC(pv, size)çš„sizeå‚æ•°æ˜¯ç”¨æˆ·ä¼ å…¥çš„å†…å­˜å¤§å°ï¼Œè¿™é‡Œè¿”å›åˆ°ç”¨æˆ·çš„å†…å­˜å¡å¤§å°å¯èƒ½æ¯”ç”¨æˆ·é¢„æœŸæƒ³è¦çš„è¦å¤§ã€‚å› ä¸ºå†…å­˜å—å¯æ‹†åˆ†çš„æ¡ä»¶æ˜¯å†…å­˜å—æ‹†åˆ†åå‰©ä½™çš„å¤§å°å¿…é¡»å¤§äº16å­—èŠ‚ï¼Œå¦‚æœä¸æ»¡è¶³æ¡ä»¶åˆ™è¯¥å†…å­˜ä¸æ‹†åˆ†ä¸”ä¸ä¼šè¿›ä¸€æ­¥å»å¯»æ‰¾å…¶å®ƒçš„å†…å­˜å—ï¼Œè¿™æ ·è¿”å›åˆ°ç”¨æˆ·çš„å†…å­˜å—å¤§å°å®é™…ä¸Šè¦æ¯”ç”¨æˆ·é¢„æœŸçš„è¦å¤§ä¸€äº›ã€‚\n// vPortFree()// ...vTaskSuspendAll();&#123;    /* Add this block to the list of free blocks. */    xFreeBytesRemaining += pxLink-&gt;xBlockSize;    traceFREE( pv, pxLink-&gt;xBlockSize );    prvInsertBlockIntoFreeList( ( ( BlockLink_t * ) pxLink ) );    xNumberOfSuccessfulFrees++;&#125;( void ) xTaskResumeAll();// ...\nè€Œä¼ å…¥åˆ°traceFREE(pv, size)çš„sizeæ­£å¥½æ˜¯å†…å­˜å—çš„å¤§å°ã€‚è¿™å°±å¯¼è‡´äº†mallocå’Œfreeæ—¶è®°å½•åˆ°çš„å†…å­˜ç”¨é‡ä¸ä¸€è‡´ã€‚\nè¿™çœŸæ˜¯ä¸€ä¸ªæœ‰æ„æ€çš„å‘ç°ã€‚traceMALLOCæœºåˆ¶ç”±æ—©åœ¨2013å¹´çš„V7.5.3ç‰ˆæœ¬å¼•å…¥ï¼Œåœ¨è¿‡å»çš„è¿™æ®µæ—¶é—´å†…å¤§å®¶ä¼¼ä¹å¹¶æ²¡æœ‰ç»å¸¸ä½¿ç”¨å®ƒï¼Œå¯¼è‡´è¿™ä¸ªé—®é¢˜æ½œä¼äº†10å¹´ä¹‹ä¹…ã€‚å¥½åœ¨è¿™ä»…ä»…æ˜¯ä¸€ä¸ªä½œä¸ºè°ƒè¯•åŠŸèƒ½å­˜åœ¨çš„bugï¼Œè€Œä¸”å®ƒä¸ä¼šå½±å“FreeRTOSçš„ä¸»è¦åŠŸèƒ½ã€‚\n6æœˆ5æ—¥ï¼Œæˆ‘åœ¨FreeRTOS-Kernelä¸Šæäº¤äº†ç›¸å…³Issueï¼Œå†…æ ¸å¼€å‘å°ç»„å¾ˆå¿«ç¡®è®¤è¯¥é—®é¢˜å¹¶å»ºè®®æˆ‘æäº¤ä¸€ä¸ªPull Requestæ¥ä¿®å¤å®ƒã€‚æ³¨ï¼šå­˜åœ¨è¯¥é—®é¢˜çš„æœ€åç‰ˆæœ¬åº”è¯¥ä¸ºV11.1.0\nä¿®å¤å†…æ ¸ä»£ç è¿™ä¸ªé—®é¢˜çœ‹èµ·æ¥éå¸¸ç®€å•ï¼Œåªéœ€è¦å°†å®é™…åˆ†é…çš„å†…å­˜å—å¤§å°ä¼ å…¥åˆ° trace_MALLOC()å‡½æ•°ä¸­å³å¯ã€‚ä½†å®é™…æ“ä½œèµ·æ¥å´è®©æˆ‘éå¸¸ä¸ºéš¾ã€‚\n\nå½“å†…å­˜ç”³è¯·å¤±è´¥æ—¶ï¼Œè¯¥sizeæ˜¯0è¿˜æ˜¯ç”¨æˆ·æƒ³è¦çš„å†…å­˜å¤§å°xWantedSizeï¼Ÿ\nç›´æ¥ä¿®æ”¹xWantedSizeè¿˜æ˜¯æ–°å»ºå˜é‡è¿›è¡Œå¤„ç†ï¼Ÿ\nheap1å’Œheap3æ˜¯å¦éœ€è¦åŒæ­¥ä¿®æ”¹ï¼Ÿ\n\næˆ‘å‘å†…æ ¸æäº¤çš„ç¬¬ä¸€ç‰ˆä»£ç æ˜¯åœ¨å†…å­˜å—ä¸æ‹†åˆ†æ—¶ä¿®æ”¹xWantedSizeï¼Œè¿™æ ·å°±èƒ½å¤Ÿä½¿å¾—trace_MALLOCè·å¾—æ­£ç¡®çš„å¤§å°ã€‚ä½†æ˜¯å®˜æ–¹åœ¨ç¬¬ä¸€æ¬¡å®¡æ ¸æˆ‘çš„ä»£ç æ—¶å»ºè®®æˆ‘å»ºç«‹ä¸€ä¸ªæ–°çš„å˜é‡ç”¨äºè¡¨ç¤ºå†…å­˜å—çš„å¤§å°è€Œéä½¿ç”¨xWantedSizeï¼Œäºæ˜¯æˆ‘ä¿®æ”¹äº†ä»£ç ï¼Œè¿™æ ·çœ‹èµ·æ¥ä»£ç çš„å¯è¯»æ€§æ›´é«˜ã€‚ç”±äºä¸åŒå¤„ç†å™¨æ¶æ„çš„heapå®ç°æœ‰å¤šä¸ªï¼Œæˆ‘æ²¡æ³•é€ä¸ªå»æµ‹è¯•éªŒè¯ã€‚PRä»£ç åªæµ‹è¯•äº†heap4ï¼Œä½†æ˜¯å…¶å®ƒçš„ä¿®æ”¹æ˜¯ä¸€è‡´çš„ï¼Œä¸”ä»£ç ä¼šç»è¿‡GITæœåŠ¡å™¨ä¸Šçš„è‡ªåŠ¨åŒ–æµç¨‹æµ‹è¯•ã€‚ç¡®ä¿ä»£ç åœ¨ä»£ç é£æ ¼ã€å¯é›†æˆæ€§ã€åŠŸèƒ½ä¸Šéƒ½æ»¡è¶³è§„èŒƒè¦æ±‚ã€‚\nä»æˆ‘æäº¤PR - Fix traceMALLOC() allocated bytesåˆ°å°†ä»£ç åˆå¹¶å…¥ä¸»å¹²ä»…èŠ±äº†ä¸¤å¤©æ—¶é—´ï¼Œè¿‡ç¨‹å¾ˆé¡ºåˆ©ã€‚ç”±äºæˆ‘çš„githubè´¦å·æ˜¯ä¸­æ–‡æ˜µç§°ï¼Œè¿™å¯¼è‡´åˆå¹¶åˆ°ä¸»çº¿çš„ä»£ç ä½œè€…åç§°æ˜¾ç¤ºä¸ºä¸­æ–‡æ˜µç§°ï¼Œè€Œä¸æ˜¯æˆ‘çš„è‹±æ–‡åã€‚è¿™åœ¨Git-Graphä¸­çœ‹èµ·æ¥æ€ªæ€ªçš„ï¼Œä¼¼ä¹æˆ‘æ²¡æœ‰çœ‹åˆ°å…¶å®ƒå¼€å‘è€…ä½¿ç”¨ä¸­æ–‡æ˜µç§°æäº¤çš„ä»£ç ã€‚ğŸ˜…\nåœ¨æˆ‘å‘ç°é—®é¢˜å’Œè§£å†³é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œå†…æ ¸å¼€å‘è€…éƒ½æ¯”è¾ƒå‹å¥½ï¼Œä¹Ÿå¯¹æˆ‘åšçš„å·¥ä½œç»™äºˆäº†è‚¯å®šã€‚è¿™ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡å°è¯•åœ¨å¤§å‹å¼€æºé¡¹ç›®ä¸­è´¡çŒ®ä»£ç ï¼Œä¸€æ®µéå¸¸æœ‰æ„æ€çš„ç»å†ã€‚\n"},{"title":"ç®€å•å°è¯•ä¸€ä¸‹ITCM","url":"/2023/12/15/%E7%AE%80%E5%8D%95%E5%B0%9D%E8%AF%95%E4%B8%80%E4%B8%8BITCM/","content":"ITCMç®€ä»‹åœ¨STM32é«˜æ€§èƒ½å•ç‰‡æœºä¸­å­˜åœ¨ä¸€ç§ä¾›å†…æ ¸ä¸“ç”¨çš„å†…å­˜TCM-SRAMï¼Œç§°ä¸ºç´§è€¦åˆå†…å­˜ã€‚ä¸ºäº†åŒºåˆ†ä¸åŒçš„ç”¨é€”ï¼Œåˆå­˜åœ¨ç§°ä¸ºDTCMå’ŒITCMçš„ä¸¤ç§ä¸åŒå†…å­˜ï¼Œè¿™ä¸¤ç§å†…å­˜æœ¬è´¨ä¸Šæ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯å…¶èƒŒåé»˜è®¤çš„MPUç­–ç•¥ä¸åŒï¼Œæ‰€ä»¥ä¸€èˆ¬å°†DTCMç”¨äºå­˜å‚¨å…³é”®çš„å †æ ˆæ•°æ®ï¼Œå°†ITCMç”¨äºå­˜å‚¨å…³é”®ä»£ç çš„æŒ‡ä»¤ã€‚\nç”±äºTCMå†…å­˜æ‹¥æœ‰ç‹¬ç«‹çš„æ€»çº¿ç›´è¿Cortexå†…æ ¸ï¼Œå®ƒä¸ç»è¿‡AXIæ€»çº¿çŸ©é˜µï¼Œæ‰€ä»¥ç†è®ºä¸Šå®ƒåº”è¯¥è¦å—å¾ˆå¤šæ‰å¯¹ã€‚é‚£TCMç›¸æ¯”äºä¸€èˆ¬çš„å†…å­˜åˆ°åº•å¿«å¤šå°‘å‘¢ï¼Ÿè¿™é‡Œåšä¸€äº›ç®€å•çš„æµ‹è¯•æ¥è¯´æ˜ä¸€ä¸‹ã€‚\nITCMè¿è¡Œæµ‹è¯•æ„é€ ä¸€ä¸ªç®€å•çš„å‡½æ•°ä½œä¸ºæµ‹è¯•çš„å¯¹è±¡ï¼š\nvoid runtest(void)&#123;  for(int i = 0; i &lt; 2000 * 1000; i++)&#123;    __NOP();    __NOP();    __NOP();    __NOP();  &#125;&#125;\n\næµ‹è¯•çš„èŠ¯ç‰‡é€‰ç”¨STM32H7B0èŠ¯ç‰‡ï¼Œå…¶ä¸»é¢‘280MHzï¼Œç†è®ºä¸Šä¸»é¢‘è¶Šé«˜ï¼ŒITCMçš„ä¼˜åŠ¿è¶Šæ˜æ˜¾ã€‚\nè¿™é‡Œè¿˜éœ€è¦è¯´æ˜ä¸€ä¸‹D-Cacheï¼ŒæŒ‡ä»¤ç¼“å­˜ä¹Ÿèƒ½æ˜¾è‘—æé«˜ä»£ç çš„è¿è¡Œé€Ÿåº¦ï¼Œæ‰€ä»¥è¿™é‡Œè®¾è®¡äº†4ä¸­ä¸åŒçš„æµ‹è¯•åœºæ™¯ã€‚é€šè¿‡ç»Ÿè®¡è¢«æµ‹å‡½æ•°çš„æ‰§è¡Œæ—¶é’Ÿå‘¨æœŸæ¥ååº”ä»£ç çš„æ‰§è¡Œé€Ÿåº¦ã€‚\næ³¨ï¼šæµ‹è¯•æ—¶æœªå¼€å¯ç¼–è¯‘ä¼˜åŒ–ï¼Œè°ƒç”¨å‡½æ•°åœ¨Flashä¸­ï¼Œè¿è¡Œæ ˆä¸ºAXI-SRAM\n\n1.å…³é—­D-Cacheï¼Œè¢«æµ‹å‡½æ•°åœ¨Flashä¸­æ‰§è¡Œè¿è¡Œå‘¨æœŸï¼š26065054\n2.å…³é—­D-Cacheï¼Œè¢«æµ‹å‡½æ•°åœ¨ITCMä¸­æ‰§è¡Œè¿è¡Œå‘¨æœŸï¼š15088644\n3.å¼€å¯D-Cacheï¼Œè¢«æµ‹å‡½æ•°åœ¨Flashä¸­æ‰§è¡Œè¿è¡Œå‘¨æœŸï¼š16019317\n4.å¼€å¯D-Cacheï¼Œè¢«æµ‹å‡½æ•°åœ¨ITCMä¸­æ‰§è¡Œè¿è¡Œå‘¨æœŸï¼š14017011\n\né€šè¿‡ä»¥ä¸Šçš„æ•°æ®ä¸éš¾çœ‹å‡ºITCMçš„ä¼˜åŠ¿ã€‚åœ¨ITCMä¸­è¿è¡Œçš„æŒ‡ä»¤æ¯”åœ¨Flashä¸­å¼€å¯äº†D-Cacheçš„æŒ‡ä»¤è¿è¡Œè¿˜è¦å—ã€‚æµ‹è¯•çš„ç¬¬4ä¸­æƒ…å†µç›¸æ¯”äºç¬¬1ç§æƒ…å†µæ€§èƒ½æ›´æ˜¯æå‡äº†45%ä»¥ä¸Šã€‚\nå¦‚ä½•ä½¿ç”¨ITCMè¿™é‡Œç®€å•ä»‹ç»åœ¨gccå¼€å‘å¹³å°ä¸‹å¦‚ä½•æ–¹ä¾¿å¿«æ·çš„ä½¿ç”¨ITCMã€‚\né¦–å…ˆéœ€è¦åœ¨é“¾æ¥è„šæœ¬ä¸­ä¸ºå‡½æ•°åˆ†é…ç‹¬ç«‹çš„å­—æ®µï¼Œç”¨äºå°†ç›¸å…³å‡½æ•°é“¾æ¥åˆ°ITCMä¸­ã€‚\n/* Initialized ramfunc sections goes into RAM, load LMA copy after code */_siramfunc = LOADADDR(.ramfunc);.ramfunc :&#123;  . = ALIGN(4);  _sramfunc = .;     /* create a global symbol at data start */  *(.RamFunc)        /* .RamFunc sections */  *(.RamFunc*)       /* .RamFunc* sections */  . = ALIGN(4);  _eramfunc = .;     /* define a global symbol at data end */&#125; &gt;ITCMRAM AT&gt; FLASH\nè¿™é‡Œéœ€è¦æ³¨æ„ï¼ŒRamFuncå¯èƒ½å·²ç»å­˜åœ¨äºdataå­—æ®µä¸­ï¼Œéœ€è¦å°†å…¶ä¸­dataå­—æ®µä¸­åˆ é™¤ã€‚\nè¿™æ®µé“¾æ¥è„šæœ¬å°†å‡½æ•°çš„å­˜å‚¨åœ°å€æ”¾åˆ°Flashä¸­ç”¨äºæŒä¹…å›ºåŒ–ï¼Œå°†å‡½æ•°è¿è¡Œåœ°å€æ”¾åˆ°ITCMä¸­ç”¨äºæ‰§è¡Œã€‚\nä¹‹åéœ€è¦ä»£ç å°†Flashä¸­çš„ä»£ç æ•°æ®æ¬è¿åˆ°ITCMä¸­ï¼Œè¿™éƒ¨åˆ†å·¥ä½œæœ€å¥½åœ¨æ±‡ç¼–ä»£ç ä¸­å®Œæˆã€‚\n/* è¿™éƒ¨åˆ†æ”¾åˆ°æœ€å‰é¢ */.word _siramfunc.word _sramfunc.word _eramfunc/* è¿™éƒ¨åˆ†æ’å…¥åˆ°å¯åŠ¨æ±‡ç¼–ä»£ç ä¸­ *//* Copy RamFunc segment from flash to RAM */  ldr r0, =_sramfunc  ldr r1, =_eramfunc  ldr r2, =_siramfunc  b LoopCopyRamFuncCopyRamFunc:  ldr r3, [r2], #4  str r3, [r0], #4LoopCopyRamFunc:  cmp r0, r1  bcc CopyRamFunc\nå¦‚æœè®¤ä¸ºæ±‡ç¼–è¾ƒå¤æ‚ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Cä»£ç æ›¿ä»£ï¼Œä½œç”¨æ˜¯ä¸€æ ·çš„ï¼š\nextern uint8_t _siramfunc;extern uint8_t _sramfunc;extern uint8_t _eramfunc;memcpy(&amp;_sramfunc, &amp;_siramfunc, (uint32_t)(&amp;_eramfunc - &amp;_sramfunc));\n\nè¿™æ ·å½“å£°æ˜å‡½æ•°æ—¶å°±å¯ä»¥å°†å‡½æ•°å­˜æ”¾åˆ°ITCMä¸­ï¼Œå¹¶å®ç°æŒä¹…åŒ–çš„è¿è¡Œï¼š\nvoid runtest(void) __attribute__((section(&quot;.RamFunc&quot;)));void runtest(void)&#123;  for(int i = 0; i &lt; 2000 * 1000; i++)&#123;    __NOP();    __NOP();    __NOP();    __NOP();  &#125;&#125;\n\nå…¶å®ƒçš„å¼€å‘å¹³å°ä¹Ÿæ˜¯ç±»ä¼¼çš„åŸç†ã€‚\nITCMçš„ä¸€äº›é™åˆ¶ITCMç”¨èµ·æ¥ä¹Ÿä¸æ˜¯å®Œç¾çš„ï¼Œå½“æ¶‰åŠè¾ƒå¤šçš„å‡½æ•°é—´è°ƒç”¨æ—¶ï¼Œå¦‚æœæŒ‡ä»¤åœ°å€é¢‘ç¹åœ¨Flashã€ITCMç›´æ¥æ¥å›åˆ‡æ¢ï¼Œä¼šäº§ç”Ÿè®¸å¤šä¸å¿…è¦çš„å¼€é”€ï¼Œå› ä¸ºå®ƒä»¬ä¸¤ä¸ªåŒºåŸŸçš„åœ°å€è·¨åº¦å¤ªå¤§ï¼Œæ— æ³•ç›´æ¥è·³è½¬ï¼Œç¼–è¯‘å™¨ä¼šäº§ç”Ÿä¸€äº›è™šæ‹Ÿå‡½æ•°æ¥å®ç°è¿™ä¸ªè·³è½¬çš„è¿‡æ¸¡ï¼Œæ— è®ºæ˜¯Flashåˆ°ITCMï¼Œè¿˜æ˜¯ITCMåˆ°Flashéƒ½ä¼šæœ‰è¿™æ ·çš„æ“ä½œã€‚\nITCMä¸»è¦æ˜¯ç”¨äºæ‰§è¡Œä¸€äº›æ—¶é—´æ•æ„Ÿçš„å‡½æ•°ï¼Œä¾‹å¦‚ä¸­æ–­å‡½æ•°ï¼Œä½¿å¾—ä¸­æ–­èƒ½å¤Ÿæ›´å¿«å“åº”ã€‚è¿˜æœ‰å°±æ˜¯ä¾‹å¦‚FFTè¿™ç§çº¯ç²¹çš„è®¡ç®—å‹å‡½æ•°ï¼Œå®ƒä¸ä¼šå‘ç”Ÿè¾ƒå¤šçš„å…¶å®ƒå‡½æ•°è°ƒç”¨ä¸”å‡½æ•°æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼Œè¿™ä¹Ÿèƒ½å‘æŒ¥ITCMçš„å…³é”®ä¼˜åŠ¿ã€‚\n"},{"title":"ç®€å•èŠèŠLevelX","url":"/2024/12/11/%E7%AE%80%E5%8D%95%E8%81%8A%E8%81%8ALevelX/","content":"ç®€ä»‹LevelXï¼Œä¸€æ¬¾ä¸“ä¸ºåµŒå…¥å¼å­˜å‚¨æ‰“é€ çš„å­˜å‚¨ä¸­é—´ä»¶ï¼Œå¸¸ä¸ThreadXç­‰äº§å“ååŒä½œä¸šã€‚å®ƒä¸ºåµŒå…¥å¼å®æ—¶ç³»ç»Ÿæä¾›äº†å“è¶Šçš„Flashå­˜å‚¨ç£¨æŸå‡è¡¡åŠŸèƒ½ï¼Œå³ä¾¿ç‹¬ç«‹ä½¿ç”¨ä¹Ÿæ¸¸åˆƒæœ‰ä½™ã€‚LevelXèƒ½å¤Ÿä¸å„ç§æ–‡ä»¶ç³»ç»Ÿå’Œå®æ—¶ç³»ç»Ÿå®Œç¾èåˆï¼Œé€‚åº”å¤šå˜çš„åº”ç”¨åœºæ™¯ã€‚\nThreadXåŠå…¶ç›¸å…³ç»„ä»¶æœ€æ—©æ˜¯ç”±Express Logicå¼€å‘ã€‚è¯¥å®æ—¶æ“ä½œç³»ç»Ÿè·å¾—äº†å¤šé¡¹å®‰å…¨è®¤è¯ã€‚å®ƒä»¥æ”¯æŒCortex-Må¤„ç†å™¨ä¸ºä¸»ï¼Œåœ¨Cortex-Aå¤„ç†å™¨ä¸Šï¼ŒThreadXä¹Ÿå¾—åˆ°äº†å¾ˆå¥½çš„æ”¯æŒã€‚é™¤äº†RTOSå¤–ï¼Œå®ƒæä¾›çš„æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œåè®®æ ˆã€USBåè®®æ ˆã€GUIç­‰è½¯ä»¶ä¹Ÿéå¸¸ä¼˜ç§€ã€‚2019å¹´ï¼Œå¾®è½¯å°†ThreadXåŠå…¶ç›¸å…³ç»„ä»¶æ”¶è´­ï¼Œå¹¶æ”¹åä¸ºAzure RTOSã€‚2023å¹´åº•ï¼Œå¾®è½¯å®£å¸ƒå°†Azure RTOSåŠå…¶ç»„ä»¶è½¬ç§»åˆ°EclipseåŸºé‡‘ä¼šå¹¶å¹¶å®£å¸ƒå¼€æºï¼ŒåŒæ—¶æ›´åä¸ºEclipse ThreadXã€‚è™½ç„¶å‡ ç»æ˜“ä¸»ï¼Œä½†å®ƒä»»ç„¶æ˜¯ä¸€æ¬¾ä¹…ç»è€ƒéªŒã€ç›¸å½“æˆç†Ÿç¨³å®šçš„äº§å“ã€‚\nä¸ºäº†é¿å…ä¸åŒæ—¶æœŸäº§å“çš„å‘½åå·®å¼‚ï¼Œåé¢ç»Ÿä¸€ä½¿ç”¨ThreadXå’ŒLevelXã€‚ç›¸æ¯”äºThreadxå…¶å®ƒä¼˜ç§€çš„ç»„ä»¶ï¼ŒLevelXçœ‹èµ·æ¥éå¸¸çš„æ™®é€šï¼Œå°‘æœ‰å•ç‹¬ä½¿ç”¨å®ƒçš„æƒ…å†µã€‚æˆ‘æœ€è¿‘åœ¨æµ‹è¯•æŸä¸ªnand flashèŠ¯ç‰‡æ—¶å‡†å¤‡ä½¿ç”¨è¯¥ç£¨æŸå‡è¡¡å®ç°ï¼Œå®æµ‹ä¸€ä¸‹æ•ˆæœã€‚æ­é…FileXæ–‡ä»¶ç³»ç»Ÿå¯¹æ¯”ä¸€ä¸‹å†…å»ºäº†ç£¨æŸå‡è¡¡çš„æ–‡ä»¶ç³»ç»ŸLittleFSçš„å·®å¼‚ã€‚\nç£¨æŸå‡è¡¡å¥¥ç§˜ç£¨æŸå‡è¡¡æŠ€æœ¯çš„æ ¸å¿ƒåœ¨äºç¡®ä¿æ•°æ®èƒ½å¤Ÿå‡åŒ€åœ°åˆ†å¸ƒåœ¨å­˜å‚¨å™¨çš„å„ä¸ªåŒºåŸŸï¼Œä»è€Œé¿å…æŸä¸€åŒºåŸŸå› é•¿æœŸå†™å…¥è€Œå¯¼è‡´Flashå†™å…¥ä¸å‡è¡¡ã€‚å…¶å…³é”®ç­–ç•¥åœ¨äºé¿å…æ•°æ®çš„å°±åœ°æ›´æ–°ï¼Œè€Œæ˜¯é€šè¿‡åˆ†é…æ–°å—æ¥å†™å…¥æ•°æ®ï¼Œå®ç°æ•°æ®çš„å‡åŒ€åˆ†å¸ƒã€‚\nå…³é”®æœ¯è¯­è§£æåœ¨æ–‡ä»¶ç³»ç»Ÿã€å­˜å‚¨ç»„ä»¶åŠèŠ¯ç‰‡æ‰‹å†Œä¸­ï¼Œç»å¸¸èƒ½çœ‹åˆ°çœ‹åˆ°æ‰‡åŒº(sector)ã€å—(block)ã€é¡µ(page)çš„æè¿°ï¼Œåœ¨ä¸åŒçš„åœºæ™¯ä¸‹å¯èƒ½å­˜åœ¨è¡¨è¾¾å«ä¹‰çš„å·®å¼‚ã€‚ä¸ºäº†åç»­å†…å®¹ä¾¿äºç†è§£ï¼Œè¿™é‡Œè§„å®šè¿™å‡ ä¸ªè¯çš„å«ä¹‰ã€‚æ‰‡åŒºå¯¹åº”ä¸€ä¸ªå¯è¯»å†™çš„å­˜å‚¨å•å…ƒï¼Œé€šå¸¸åº”ç”¨äºæ–‡ä»¶ç³»ç»Ÿã€FTLå±‚çš„æ¥å£ä¸­ã€‚å—æ˜¯é¡µçš„é›†åˆï¼Œæ˜¯æœ€å°çš„æ“¦é™¤å•ä½ã€‚é¡µæ˜¯æœ€å°çš„è¯»å†™å•ä½ã€‚\nLevelXå·¥ä½œåŸç† (Nand flash)LevelXé’ˆå¯¹nor flashå’Œnand flashå®ç°äº†ä¸¤å¥—å­˜å‚¨æ–¹æ¡ˆï¼Œå…³äºnandå’Œnorçš„å·®å¼‚è¿™å°±ä¸å±•å¼€è¯´æ˜äº†ï¼Œè¿™é‡Œä»…è®¨è®ºå…³äºLevelXé’ˆå¯¹nand flashçš„å®ç°éƒ¨åˆ†ã€‚\nLevelXå®ç°äº†ä¸€å¥—æ‰‡åŒºè¯»å†™æ¥å£ï¼Œé€šè¿‡ä¸€å¥—å†…éƒ¨æœºåˆ¶ï¼Œå°†æ‰‡åŒºæ˜ å°„åˆ°å­˜å‚¨å™¨çš„é¡µä¸Šï¼Œå®ç°äº†FTLçš„åŠŸèƒ½ã€‚åŒæ—¶åœ¨å—åˆ†é…è¿‡ç¨‹ä¸­é€šè¿‡å¯»æ‰¾æœ€å°æ“¦é™¤æ¬¡æ•°çš„å—æ¥åˆ†é…æ–°çš„å—ï¼Œå®ç°å†™å…¥ç£¨æŸçš„å‡åŒ€åˆ†å¸ƒã€‚\nLevelXå­˜å‚¨åœ¨flashä¸Šçš„æ•°æ®åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯å…ƒæ•°æ®(meta data)ï¼Œå¦ä¸€ç§æ˜¯çœŸå®çš„æ‰‡åŒºæ•°æ®ã€‚å…ƒæ•°æ®å’Œæ‰‡åŒºæ•°æ®åˆ†åˆ«å­˜å‚¨åœ¨ç›¸å¯¹å„è‡ªç‹¬ç«‹çš„å—ä¸­ï¼Œå³å…ƒæ•°æ®æ‰€åœ¨çš„å—ä¸ä¼šå†™å…¥æ‰‡åŒºæ•°æ®ã€‚\nå…ƒæ•°æ®åŒ…æ‹¬flashè®¾å¤‡ä¿¡æ¯ã€æ“¦é™¤è®¡æ•°è¡¨ã€å—æ˜ å°„è¡¨ã€å—çŠ¶æ€è¡¨ç­‰ã€‚å…¶ä¸­æœ€å…³é”®çš„æ˜¯å—æ˜ å°„è¡¨ï¼Œå®ƒæ˜¯å®ç°é€»è¾‘æ‰‡åŒºåˆ°flashç‰©ç†é¡µæ˜ å°„çš„å…³é”®ã€‚å—çŠ¶æ€è¡¨ç”¨äºæ ‡è®°å—çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬æ˜¯å¦è¢«åˆ†é…ä½¿ç”¨ã€æ˜¯å¦æ˜¯åå—ç­‰ã€‚\næ‰§è¡Œ_lx_nand_flash_format()å‡½æ•°çš„è¿‡ç¨‹å°±æ˜¯é‡å»ºå…ƒæ•°æ®çš„è¿‡ç¨‹ã€‚æ‰§è¡Œ_lx_nand_flash_open()å‡½æ•°çš„è¿‡ç¨‹å°±æ˜¯å°†åœ¨flashä¸ŠæŸ¥æ‰¾å…ƒæ•°æ®å¹¶å…¨éƒ¨ä¿å­˜åˆ°å†…å­˜ä¸­ã€‚ç”±äºéœ€è¦å°†å…ƒæ•°æ®å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä½¿ç”¨LevelXæ˜¯æ¯”è¾ƒè€—è´¹å†…å­˜çš„ï¼Œå¤§çº¦éœ€è¦ä½¿ç”¨çš„å­—èŠ‚æ•°ä¸º8å€å—æ•°+2å€çš„é¡µå­—èŠ‚æ•°ã€‚\nLevelXæ˜¯åŸºäºå—è¿›è¡Œæ˜ å°„çš„ï¼Œè€Œä¸æ˜¯åŸºäºæ‰‡åŒºè¿›è¡Œæ˜ å°„ã€‚æ‰€ä»¥ç›¸é‚»é€»è¾‘æ‰‡åŒºçš„æ•°æ®å¿…å®šä½äºåŒä¸€å—ä¸­ã€‚ä¾‹å¦‚æ‰‡åŒº0å’Œæ‰‡åŒº1çš„æ•°æ®è¢«æ˜ å°„åˆ°ç‰©ç†å—7çš„ç¬¬1é¡µå’Œç¬¬2é¡µ(LevelXè¦æ±‚é€»è¾‘æ‰‡åŒºå¤§å°ç­‰åŒäºç‰©ç†é¡µå¤§å°)ã€‚å‡è®¾ä¸€ä¸ªå—æœ‰64é¡µï¼Œé‚£ä¹ˆè¿™ä¸ªå—å­˜å‚¨çš„é€»è¾‘æ‰‡åŒºå¿…å®šæ˜¯n+0~n+63ã€‚æ‰‡åŒºåœ¨å—å†…çš„æ’åˆ—å¯èƒ½æ˜¯è¿ç»­çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯éè¿ç»­çš„ï¼Œè¿™é‡Œåç»­ä¼šè¯¦ç»†è¯´æ˜ã€‚\nnand flashåœ¨æ¯ä¸ªé¡µä¸Šé™¤äº†å­˜å‚¨æ•°æ®çš„åŒºåŸŸå¤–ï¼Œè¿˜é™„éšäº†ä¸€ä¸ªsparaåŒºåŸŸï¼Œç”¨äºå­˜å‚¨è¯¥é¡µç›¸å…³è”çš„ä¸€äº›æ•°æ®ï¼Œä¸€èˆ¬åŒ…æ‹¬åå—æ ‡è®°å’ŒECCæ ¡éªŒä¿¡æ¯ã€‚sparaåŒºåŸŸæ˜¯LevelXè¿™ç±»FTLè½¯ä»¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œçš„å¿…è¦æ¡ä»¶ã€‚\næ‰§è¡Œ_lx_nand_flash_sector_read()ç”¨äºè¯»å–æ‰‡åŒºæ•°æ®ã€‚é¦–å…ˆé€šè¿‡é€»è¾‘æ‰‡åŒºå·è®¡ç®—å‡ºé€»è¾‘å—å·(&#x3D;æ‰‡åŒºå·&#x2F;å—å†…é¡µæ•°)ï¼Œé€šè¿‡å—æ˜ å°„è¡¨å®šä½åˆ°æ•°æ®æ‰€åœ¨çš„ç‰©ç†é¡µã€‚æ­¤æ—¶å®šä½åˆ°äº†æ•°æ®æ‰€åœ¨çš„å—ï¼Œè¿™æ—¶éœ€è¦åˆ†ä¸¤ç§æƒ…å†µï¼Œé€šè¿‡å—çŠ¶æ€è¡¨æŸ¥è¯¢è¯¥å—å†…å­˜å‚¨çš„æ‰‡åŒºæ˜¯å¦æ˜¯è¿ç»­çš„ï¼Œå¦‚æœæ‰‡åŒºæ˜¯è¿ç»­çš„ï¼Œé‚£ä¹ˆç›´æ¥é€šè¿‡æ‰‡åŒºåç§»(&#x3D;æ‰‡åŒºå·%å—å†…é¡µæ•°)å°±èƒ½å¾—åˆ°é€»è¾‘æ‰‡åŒºæ‰€å¯¹åº”çš„ç‰©ç†åœ°å€æ•°æ®ã€‚å¦‚æœæ‰‡åŒºç¼–å·ä¸æ˜¯è¿ç»­çš„ï¼Œé‚£ä¹ˆéœ€è¦éå†å—å†…çš„æ¯ä¸ªé¡µï¼Œæ¯ä¸ªé¡µçš„sparaåŒºåŸŸä¸­å­˜å‚¨äº†è¯¥é¡µå®é™…çš„é€»è¾‘æ‰‡åŒºå·ï¼Œé€šè¿‡æ¯”å¯¹é€»è¾‘æ‰‡åŒºå·å’Œå½“å‰é¡µçš„é€»è¾‘æ‰‡åŒºå·ï¼Œå°±å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€æ•°æ®ã€‚è¿™é‡Œå¯ä»¥çœ‹å‡ºéè¿ç»­æ¨¡å¼ä¸‹ï¼Œæ•°æ®çš„è¯»å–æ•ˆç‡éå¸¸ä½ï¼Œå› ä¸ºå®ƒéœ€è¦éå†å—å†…çš„æ‰€æœ‰æ•°æ®ã€‚å®é™…ä¸Šåªéœ€è¦éå†å—å†…çš„æ‰€æœ‰sparaæ•°æ®å³å¯ï¼Œä½†æ˜¯ç”±äºæ¥å£è®¾è®¡çš„åŸå› ï¼Œå­˜å‚¨åŒºåŸŸå†…çš„æ•°æ®è¿˜æ˜¯ä¼šè¯»å–ï¼Œå¯¼è‡´æ•ˆç‡ä½ä¸‹ã€‚\nå¦‚æœæŸä¸ªæ‰‡åŒºçš„æ•°æ®æœªå†™å…¥ï¼Œé‚£ä¹ˆå®ƒæ‰€åœ¨çš„å—å¯èƒ½æœªåˆ†é…ï¼Œåœ¨æ˜ å°„è¡¨ä¸­å°†è¿”å›æœªæ˜ å°„çš„çŠ¶æ€ã€‚æˆ–è€…å—å·²ç»åˆ†é…äº†ï¼Œä½†æ˜¯å—å†…çš„æ•°æ®é¡µæ²¡æœ‰å†™å…¥ï¼Œè¿™æ—¶_lx_nand_flash_sector_read()å°†è¿”å›å…¨ä¸º0xffçš„æ•°æ®ã€‚\næ•°æ®çš„è¯»å–æµç¨‹æ¯”è¾ƒç®€å•ï¼Œä¸»è¦éƒ½æ˜¯ä¸€äº›æ•°æ®çš„æ£€ç´¢è¿‡ç¨‹ã€‚æ•°æ®å†™å…¥å°†ä¼šéå¸¸å¤æ‚ï¼Œé™¤äº†æ‰‡åŒºæ•°æ®çš„å†™å…¥å¤–ï¼Œè¿˜éœ€è¦æ›´æ–°å…ƒæ•°æ®ã€‚æ­¤å¤–è¿˜éœ€è¦è€ƒè™‘ç”µæºæ•…éšœç­‰å®‰å…¨é—®é¢˜ã€‚\nä¸ºäº†å…‹æœç”µæºæ•…éšœï¼ŒLevelXçš„å…ƒæ•°æ®æ›´æ–°é‡‡ç”¨ä¸¤æ¬¡å†™å…¥æœºåˆ¶ï¼Œå³æ‰€æœ‰çš„å…ƒæ•°æ®ä¼šæœ‰ä¸€ä¸ªå¤‡ä»½ï¼Œä¸”å¤‡ä»½å­˜åœ¨äºä¸åŒçš„å—ä¸­ã€‚æ‰€ä»¥å†™å…¥æ–°çš„å…ƒæ•°æ®æ—¶ï¼Œæ€»æœ‰å¦å¤–ä¸€ä¸ªå…ƒæ•°æ®æ˜¯å®‰å…¨çš„ã€‚å‡è®¾å—æ˜ å°„è¡¨å…ƒæ•°æ®å ç”¨4ä¸ªé¡µ(0-1-2-3)ï¼Œé‚£ä¹ˆæ¯æ¬¡æ›´æ–°æ—¶ï¼Œå…ˆå®šä½åˆ°å¾…ä¿®æ”¹å…ƒæ•°æ®çš„é¡µï¼Œå°†è¯¥é¡µæ ‡è®°ä¸ºæ— æ•ˆï¼ŒåŒæ—¶åœ¨å†…å­˜ä¸­å°†æ–°çš„å…ƒæ•°æ®å†™å…¥åˆ°ä¸€ä¸ªæ–°çš„é¡µä¸­ã€‚å³ä½¿å…ƒæ•°æ®åœ¨å—ä¸Šä¸è¿ç»­ï¼Œ_lx_nand_flash_open()å‡½æ•°ä¼šåœ¨è¯»å–å…ƒæ•°æ®æ—¶è‡ªåŠ¨åˆå¹¶å„ä¸ªå…ƒæ•°æ®å—ã€‚\nlx_nand_flash_sector_write()å‡½æ•°ç”¨äºå†™å…¥æ‰‡åŒºæ•°æ®ã€‚ç±»ä¼¼äºè¯»å–æµç¨‹ï¼Œå…ˆæ ¹æ®æ‰‡åŒºå·å®šä½åˆ°å—å·ï¼Œåœ¨é€šè¿‡å—æ˜ å°„è¡¨æŸ¥æ‰¾æ•°æ®æ‰€åœ¨ç‰©ç†å—ã€‚å¦‚æœå—æœªåˆ†é…ï¼Œé‚£ä¹ˆæ‰§è¡Œå—åˆ†é…æµç¨‹ã€‚å¦‚æœå—å·²ç»åˆ†é…ï¼Œé‚£å°±å†å—å†…å†™å…¥æ–°çš„æ‰‡åŒºæ•°æ®ï¼Œå¦‚æœå­˜åœ¨åŸæ•°æ®ï¼Œéœ€è¦å°†åŸæ•°æ®é¡µæ ‡è®°ä¸ºæ— æ•ˆã€‚å¦‚æœæ–°æ–°å†™å…¥çš„æ•°æ®å¯¼è‡´å—å†…æ•°æ®ä¸è¿ç»­ï¼Œé‚£ä¹ˆéœ€è¦æ›´æ–°å—çŠ¶æ€ä¸ºæ— åºçŠ¶æ€(NON_SEQUENTIAL)ã€‚å¦‚æœä¸€ä¸ªå—å†…çš„æ•°æ®é¡µéƒ½è¢«åˆ†é…äº†ï¼Œé‚£ä¹ˆå°†æ‰§è¡Œå—æ‹·è´æµç¨‹ï¼Œå³åˆ†é…æ–°çš„å—ï¼Œå¹¶å°†ç°æœ‰å—ä¸­çš„æœ‰æ•ˆæ•°æ®å…¨éƒ¨æ‹·è´è¿‡å»ï¼Œç„¶åå†å†™å…¥æ–°çš„æ•°æ®ã€‚\nå—åˆ†é…æµç¨‹æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆé€šè¿‡å—çŠ¶æ€è¡¨æŸ¥è¯¢å‡ºç©ºé—²çš„å—åˆ—è¡¨ï¼Œæ‰¾åˆ°æœ€åä¸€ä¸ªç©ºé—²å—è¿›è¡Œåˆ†é…ã€‚ä¸ºä»€ä¹ˆæ˜¯æœ€åä¸€ä¸ªï¼Ÿå› ä¸ºç©ºé—²è¡¨æ˜¯ä¸€ä¸ªæœ‰åºè¡¨ï¼Œå®ƒæ˜¯æŒ‰ç…§æ“¦é™¤æ¬¡æ•°è¿›è¡Œæ’åºçš„ã€‚æ¯æ¬¡æœ‰æ–°çš„ç©ºé—²å—æ’å…¥è¡¨ä¸­ï¼Œéƒ½ä¼šæ‰§è¡Œä¸€ä¸ªæœ‰åºæ’å…¥çš„è¿‡ç¨‹ã€‚è¿™ä¸ªå—åˆ†é…æœºåˆ¶åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¿è¯äº†ç£¨æŸå‡è¡¡ã€‚LittleFSçš„ç£¨æŸå‡è¡¡é‡‡ç”¨hashå‡½æ•°éšæœºåˆ†é…æ–°çš„å—ï¼Œé€šè¿‡hashå‡½æ•°çš„éšæœºæ€§æ¥ä¿è¯å†™å…¥çš„å‡åŒ€æ€§ã€‚åè€…çš„åˆ†é…æ•ˆç‡é«˜ä¸€äº›ã€‚\nåˆ†é…äº†æ–°çš„å—æˆ–è€…å°†æ—§å—æ‹·è´åˆ°æ–°å—åéœ€è¦æ›´æ–°å¯¹åº”çš„æ˜ å°„è¡¨å…ƒæ•°æ®ï¼Œå…ˆæ›´æ–°å†…å­˜ï¼Œå†æ›´æ–°flashä¸Šçš„å…ƒæ•°æ®ã€‚æ—§çš„å—åº”å½“è¢«æ“¦é™¤(å…ƒæ•°æ®éœ€è¦æ›´æ–°ç©ºé—²è¡¨ã€æ“¦é™¤è®¡ç®—è¡¨)ã€‚å—çš„æ“¦é™¤æ¬¡æ•°å¦‚æœè¶…è¿‡ä¸€å®šçš„é˜ˆå€¼åï¼Œä¼šå°†è¿™ä¸ªå—ä¸Šçš„æ•°æ®å…¨éƒ¨ç§»åŠ¨åˆ°ä¸€ä¸ªæ“¦é™¤æ¬¡æ•°è¾ƒå°‘çš„å—ä¸Šã€‚\nCOWæœºåˆ¶è´¯ç©¿LevelXçš„æ•´ä¸ªæµç¨‹ï¼Œå®ƒä¿è¯äº†æ•°æ®å†™å…¥çš„å®‰å…¨æ€§ã€‚\nLevelXè¿˜æä¾›äº†è½¯ä»¶eccå®ç°ï¼Œä½†ä»…æ”¯æŒ256å­—èŠ‚é•¿åº¦çš„æ•°æ®ï¼Œå¦‚æœæ‰‡åŒºè¶…è¿‡256å­—èŠ‚çš„è¯è¿˜è¦åˆ†ç‰‡å¤„ç†ã€‚ç°åœ¨å¤§éƒ¨åˆ†nandèŠ¯ç‰‡éƒ½æä¾›äº†ç¡¬ä»¶eccï¼Œæˆ‘å°±æ²¡æœ‰æµ‹è¯•è¿™é‡Œçš„eccç®—æ³•ï¼Œä¸è¿‡çœ‹äº†ä¸‹ä»£ç ï¼Œeccçš„ç”Ÿæˆå’Œæ ¡éªŒéƒ½ä¸ä¾èµ–é¢å¤–çš„å†…å­˜ç©ºé—´ï¼Œè¿™ç‚¹æ¯”è¾ƒå¥½ã€‚\næ³¨ï¼šæœ¬æ–‡åŸºäºLevelX v6.4.1ç‰ˆæœ¬è¿›è¡Œé˜è¿°ã€‚\nå®æµ‹ä½“éªŒåœ¨å®æµ‹è¿‡ç¨‹ä¸­ï¼Œæˆ‘å°è¯•å°†LevelXä¸W25N01GèŠ¯ç‰‡ç»“åˆä½¿ç”¨ï¼Œå¹¶éªŒè¯äº†å…¶å¤§é‡æ•°æ®è¯»å†™çš„ç¨³å®šæ€§ã€‚ç„¶è€Œï¼Œåœ¨æ­é…FatFSå’ŒFileXæ–‡ä»¶ç³»ç»Ÿä½¿ç”¨æ—¶ï¼Œå‘ç°å†™å…¥æ€§èƒ½ä¸å°½å¦‚äººæ„ã€‚ä½¿ç”¨50MHzçš„SPIæ€»çº¿ï¼Œåœ¨å¤§é‡æ–‡ä»¶é‡å¤å†™å…¥çš„æƒ…å†µä¸‹ï¼Œæ–‡ä»¶å†™å…¥é€Ÿåº¦åœ¨50kb&#x2F;så·¦å³ï¼Œä¸¥é‡ä½äºå¿ƒé‡Œé¢„æœŸã€‚è¯»å–é€Ÿåº¦å¥½ä¸€äº›ï¼Œå¯ä»¥è¾¾åˆ°å‡ å…†å­—èŠ‚æ¯ç§’ã€‚åé¢åˆç§»æ¤äº†FileXæ–‡ä»¶ç³»ç»Ÿï¼Œè¯»å†™æ€§èƒ½æ²¡æœ‰å¤ªå¤§çš„æå‡ï¼Œæˆ‘çœ‹åˆ°éƒ¨åˆ†ç½‘å‹ä¸æˆ‘æœ‰ç±»ä¼¼çš„æƒ…å†µã€‚ç»è¿‡åˆ†æï¼Œè¿™ä¸»è¦å½’å› äºLevelXåœ¨æ£€ç´¢æ‰‡åŒºå·æ—¶çš„é«˜å¼€é”€ã€‚\nç›¸è¾ƒäºLittleFSï¼ŒLevelXåœ¨æ€§èƒ½ç¨³å®šæ€§æ–¹é¢ç•¥é€Šä¸€ç­¹ã€‚LittleFSçš„æ€§èƒ½æ³¢åŠ¨è¾ƒå°ï¼Œè€ŒLevelXåœ¨å—åˆ†é…æ··ä¹±åæ€§èƒ½ä¸‹é™æ˜æ˜¾ï¼Œå½±å“ç³»ç»Ÿå®æ—¶æ€§ã€‚ç„¶è€ŒLittleFSå’ŒLevelXæœ¬å°±æ˜¯é’ˆå¯¹ä¸åŒçš„å­˜å‚¨ä»‹è´¨è€Œè®¾è®¡çš„ï¼Œä¸¤è€…ç›¸æ¯”è¾ƒä¼¼ä¹ä¸èƒ½åˆ¤æ–­å­°ä¼˜å­°åŠ£ã€‚\nLevelXå’ŒFileXéƒ½æ˜¯è€—å†…å­˜å¤§æˆ·ï¼Œä¸¤è€…ä¸€æ­é…ï¼ŒRAMå†…å­˜ç›´æ¥å ç”¨è¿‘30kbï¼Œå¯¹èµ„æºå—é™çš„è®¾å¤‡ä¸å‹å¥½ã€‚å°½ç®¡LevelXåœ¨æ€§èƒ½å’Œèµ„æºå ç”¨æ–¹é¢å­˜åœ¨ä¸€å®šä¸è¶³ï¼Œä½†å…¶åœ¨åµŒå…¥å¼å­˜å‚¨é¢†åŸŸçš„ç‹¬ç‰¹ä»·å€¼å’Œå¹¿æ³›åº”ç”¨å‰æ™¯ä¸å®¹å¿½è§†ã€‚\n\nä»¥ä¸Šéƒ¨åˆ†å†…å®¹ç”±è…¾è®¯æµ‘å…ƒå¤§æ¨¡å‹AIç¾åŒ–åŠç”Ÿæˆï¼Œå¸Œæœ›æœ¬æ–‡èƒ½ä¸ºæ‚¨æä¾›æœ‰ç›Šçš„å‚è€ƒå’Œå¯ç¤ºã€‚\n"},{"title":"ç»Ÿè®¡FreeRTOSä¸­å„ä¸ªçº¿ç¨‹çš„å¤„ç†å™¨åˆ©ç”¨ç‡","url":"/2023/08/30/%E7%BB%9F%E8%AE%A1FreeRTOS%E4%B8%AD%E5%90%84%E4%B8%AA%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%A4%84%E7%90%86%E5%99%A8%E5%88%A9%E7%94%A8%E7%8E%87/","content":"\nå¤§çº¦æ˜¯åœ¨ä¸€å¹´å‰ï¼Œæˆ‘åœ¨å·¥ä½œä¸­é‡åˆ°äº†éœ€è¦åˆ†æåµŒå…¥å¼ç³»ç»Ÿæ€§èƒ½çš„éœ€æ±‚ï¼Œéœ€è¦æŸ¥çœ‹ç³»ç»Ÿåœ¨å…³é”®æ—¶é—´ç‚¹ä¸Šï¼Œéƒ¨åˆ†ä»»åŠ¡æ˜¯å¦å­˜åœ¨æ‰§è¡Œæ—¶é—´è¿‡é•¿å¯¼è‡´ç³»ç»Ÿå®æ—¶æ€§èƒ½é™ä½çš„æƒ…å†µã€‚æˆ‘åœ¨åŸºäºFreeRTOSçš„ç³»ç»Ÿä¸­è®¾è®¡äº†ä¸€æ®µéä¾µå…¥å¼çš„ä»£ç ï¼Œèƒ½å¤Ÿè·å–åˆ°å„ä¸ªçº¿ç¨‹å®æ—¶çš„å¤„ç†å™¨åˆ©ç”¨ç‡ï¼Œè¿›è€Œåˆ†æç³»ç»Ÿæ˜¯å¦è®¾è®¡åˆç†ã€‚æœ€è¿‘æˆ‘åœ¨æ•´ç†ä»¥å‰çš„ä»£ç æ—¶åˆçœ‹åˆ°å½“æ—¶è®¾è®¡çš„è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘å‘ç°å½“æ—¶ä»…ä»…æ˜¯æ»¡è¶³äº†ä¸€ä¸ªåŸºæœ¬çš„åŠŸèƒ½éœ€æ±‚ï¼Œéƒ¨åˆ†åœ°æ–¹è¿˜è®¾è®¡çš„ä¸æ˜¯è¶³å¤Ÿçš„åˆç†ï¼Œæ‰€ä»¥æœ€è¿‘æŠ½ç©ºæƒ³æŠŠè¿™ä¸ªåŠŸèƒ½æ•´ç†å®Œå–„ï¼Œä»¥å¤‡ä»¥åå·¥ä½œä¹‹éœ€ã€‚\n\nå¤„ç†å™¨åˆ©ç”¨ç‡å¦‚ä½•ç†è§£å¤„ç†å™¨åˆ©ç”¨ç‡ï¼Ÿè¿™é‡Œæ‘˜æŠ„äº†Linuxç³»ç»Ÿä¸­å¯¹è¿™ä¸ªè¯çš„ç†è§£ï¼š\nCPU Usage:The task&#x27;s share of the elapsed CPU time since the last screen update, expressed as a percentage of total CPU time.\nç¿»è¯‘è¿‡æ¥å·®ä¸å¤šå°±æ˜¯æŒ‡åœ¨ä¸€æ®µæ—¶é—´é•¿åº¦Tå†…ï¼Œçº¿ç¨‹Açš„è¿è¡Œæ—¶é—´å ç”¨äº†tï¼Œåˆ™åœ¨è¿™æ®µTæ—¶é—´ç«¯å†…ï¼Œçº¿ç¨‹Açš„å¤„ç†å™¨åˆ©ç”¨ç‡ä¸º t&#x2F;Tã€‚å¦‚æœäº†è§£æ“ä½œç³»ç»Ÿè¿ä½œçš„åŸç†ï¼Œå†æ¥ç†è§£å¤„ç†å™¨åˆ©ç”¨ç‡æ˜¯éå¸¸ç®€å•çš„ã€‚\nç»Ÿè®¡æ¯ä¸ªçº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´FreeRTOSæ“ä½œç³»ç»Ÿå†…æ ¸æœ¬èº«æ˜¯æ”¯æŒç»Ÿè®¡ä»»åŠ¡æ‰§è¡Œæ—¶é—´çš„ï¼Œä½†æ˜¯å®ƒæ˜¯ç»Ÿè®¡ä»ä»»åŠ¡å¼€å§‹è¿è¡Œæ—¶è®¡ç®—çš„ï¼Œè¿™ç§ç»Ÿè®¡æ–¹æ³•æ— æ³•åˆ†æå®æ—¶çš„å¤„ç†å™¨åˆ©ç”¨ç‡ï¼Œè€Œä¸”é•¿æ—¶é—´çš„è®°å½•ä¼šå¯¼è‡´å†…éƒ¨æ—¶é—´è®¡æ•°å™¨æº¢å‡ºï¼Œæ‰€ä»¥éœ€è¦é‡æ–°è®¾è®¡ç»Ÿè®¡çº¿ç¨‹æ‰§è¡Œæ—¶é—´çš„åŠŸèƒ½ã€‚\nç»Ÿè®¡ä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´é•¿åº¦éœ€è¦åœ¨ä»»åŠ¡å¼€å§‹è¿è¡Œå’Œç»“æŸè¿è¡Œçš„æ—¶é—´ç‚¹ä¸Šè®¡æ—¶ï¼Œè¿™é‡Œçš„å¼€å§‹è¿è¡Œå’Œç»“æŸè¿è¡Œæ˜¯æŒ‡ä»»åŠ¡å¯¹å¤„ç†å™¨çš„å ç”¨æƒ…å†µï¼Œè€Œä¸æ˜¯æŒ‡ä»»åŠ¡çœŸæ­£çš„å¼€å§‹å’Œç»“æŸã€‚ç»“åˆFreeRTOSå†…æ ¸å¯ä»¥åˆ©ç”¨å†…æ ¸æå‰è®¾è®¡å¥½çš„Hookæœºåˆ¶æ‰¾åˆ°ä»»åŠ¡è¿›å…¥å’Œé€€å‡ºçš„æ—¶æœºï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢ä¸¤ä¸ªå®ï¼š\n#ifndef traceTASK_SWITCHED_IN/* Called after a task has been selected to run.  pxCurrentTCB holds a pointer * to the task control block of the selected task. */    #define traceTASK_SWITCHED_IN()#endif#ifndef traceTASK_SWITCHED_OUT/* Called before a task has been selected to run.  pxCurrentTCB holds a pointer * to the task control block of the task being switched out. */    #define traceTASK_SWITCHED_OUT()#endif\n\nè¿™é‡Œçš„æ³¨é‡Šéå¸¸å¥½ç†è§£ï¼Œæ ¹æ®è¿™ä¸¤ä¸ªHookå‡½æ•°å’ŒpxCurrentTCBå°±èƒ½å¤ŸæŒæ¡æ¯ä¸ªçº¿ç¨‹çš„åˆ‡æ¢æƒ…å†µã€‚è¿™é‡Œå…ˆè¯´æ˜ä¸€ç‚¹ï¼Œè¿™ä¸ªåŠŸèƒ½å¯¹FreeRTOSå†…æ ¸æ˜¯éä¾µå…¥çš„ï¼Œä¸ä¼šåˆ°FreeRTOSå†…æ ¸ä»£ç åšä»»ä½•æ”¹åŠ¨ã€‚\næ¥ä¸‹æ¥å°±æ˜¯éœ€è¦è®¾è®¡ä¸€ä¸ªé«˜ç²¾åº¦çš„å®šæ—¶å™¨ï¼Œä»¥æˆ‘çš„ç»éªŒæ¥çœ‹å®šæ—¶å™¨ç²¾åº¦è‡³å°‘è¦è¾¾åˆ°å¾®ç§’çº§åˆ«ä»¥ä¸Šæ‰è¡Œï¼Œå› ä¸ºæœ‰æ—¶å€™çº¿ç¨‹çš„åˆ‡å…¥å’Œåˆ‡å‡ºéå¸¸çš„å—ï¼Œå®šæ—¶å™¨ç²¾åº¦ä¸å¤Ÿçš„è¯å°±æ— æ³•å‡†ç¡®çš„è®¡ç®—æ‰§è¡Œæ—¶é—´ã€‚\nè¿™é‡Œæˆ‘é‡‡ç”¨çš„é«˜ç²¾åº¦å®šæ—¶å™¨æ˜¯DWTå†…æ ¸è°ƒè¯•æ¨¡å—çš„è®¡æ—¶å•å…ƒï¼Œå®ƒçš„è¿è¡Œé¢‘ç‡å’Œå¤„ç†å™¨ä¸€è‡´ï¼Œæ‰€ä»¥å®šæ—¶ç²¾åº¦æ˜¯è¶³å¤Ÿçš„ï¼Œè€Œä¸”32ä½çš„è®¡æ•°å™¨ä¹Ÿèƒ½å¤Ÿæ»¡è¶³ä¸€å®šæ—¶é—´é•¿åº¦çš„è®¡æ—¶éœ€æ±‚ï¼Œè¿™ä¸ªå†…æ ¸è°ƒè¯•æ¨¡å—åœ¨ARM Cortex-Må¤„ç†å™¨ä¸­éƒ½å­˜åœ¨ã€‚\nè¿™é‡Œæ˜¯æˆ‘è®¾è®¡çš„DWTè®¡æ—¶åŠŸèƒ½ä»£ç ï¼š\n/* cpu tick timer config. */#define TIME_SEC_TO_US (1000000u)#define CPU_CLK_FREQ() (SystemCoreClock)#if defined(DWT) &amp;&amp; defined(CoreDebug)static unsigned int fclk_pre_us;static inline void cpu_ts_time_init(void)&#123;    fclk_pre_us = CPU_CLK_FREQ() / TIME_SEC_TO_US;    CoreDebug-&gt;DEMCR |= CoreDebug_DEMCR_TRCENA_Msk;    DWT-&gt;CTRL        |= DWT_CTRL_CYCCNTENA_Msk;    DWT-&gt;CYCCNT       = 0;&#125;static inline unsigned int cpu_ts_timrd(void)&#123;    //return us    return (DWT-&gt;CYCCNT / fclk_pre_us);&#125;static inline void cpu_ts_reset(void)&#123;    DWT-&gt;CYCCNT = 0;&#125;\næä¾›äº†è®¡æ•°å™¨åˆå§‹åŒ–ã€å¤ä½ã€è®°å½•æ—¶é—´çš„åŠŸèƒ½ã€‚\nè®°å½•FreeRTOSå„ä¸ªä»»åŠ¡çš„è¿è¡Œæ—¶é—´å»ºç«‹ä¸€ä¸ªé•¿åº¦ä¸ºMAX_TASK_NUMSçš„æ•°ç»„task_runtimeç”¨äºå­˜å‚¨æ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸€é¡¹å¯¹åº”ä¸€ä¸ªä»»åŠ¡ï¼Œæ‰€ä»¥éœ€è¦ä¸ºæ¯ä¸ªä»»åŠ¡åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„IDï¼ŒFreeRTOSå†…æ ¸ä¸ºæ¯ä¸ªä»»åŠ¡åˆ†é…äº†ç‹¬ç«‹çš„IDï¼Œä½†æ˜¯è¿™äº›IDæ˜¯ä¸å—æ§åˆ¶çš„ï¼Œå³IDçš„åˆ†é…æ€»æ˜¯é€’å¢çš„ï¼Œä»»åŠ¡åˆ é™¤åä¸ä¼šå›æ”¶ã€‚æ‰€ä»¥éœ€è¦ä¸ºæ¯ä¸ªä»»åŠ¡é‡æ–°åˆ†é…IDå¹¶åœ¨ä»»åŠ¡åˆ é™¤ååšå›æ”¶çš„å¤„ç†ã€‚\n#define TASK_ID(task) (((StaticTask_t*)(task))-&gt;uxDummy10[0])/*  * bit0 used for other task(id &gt;= 32) * other bit used for every task. */static uint32_t id_pool = 1u; /* hook to task create. */void alloc_task_id(void* task)&#123;    if(!task)        return ;    if(id_pool == 0xffffffff)&#123;        /* The task pool is full. */        TASK_ID(task) = 0;        return ;    &#125;    uint32_t new_pool = id_pool | (id_pool + 1u);    TASK_ID(task) = 31u - __CLZ(id_pool ^ new_pool);    id_pool = new_pool;&#125;/* hook to task delete. */void release_task_id(void* task)&#123;    if(!task)        return ;    uint8_t id = TASK_ID(task);    if(id == 0)&#123;        return ;    &#125;    id_pool &amp;= ~(1u &lt;&lt; id);&#125;\n\nåˆ†é…IDçš„è¿‡ç¨‹æ˜¯è¶³å¤Ÿç®€å•çš„ï¼Œä¸ä¼šå¯¹ç³»ç»Ÿçš„æ€§èƒ½äº§ç”Ÿå¤ªå¤šé¢å¤–çš„å½±å“ã€‚åŒæ ·çš„åˆ©ç”¨Hookæœºåˆ¶ï¼ŒæŠŠå®ƒåµŒå…¥åˆ°FreeRTOSå†…æ ¸ä¸­ã€‚\n// FreeRTOSConfig.h#define traceTASK_CREATE(pxTCB)  alloc_task_id(pxTCB)#define traceTASK_DELETE(pxTCB)  release_task_id(pxTCB)\n\né€šè¿‡task_runtime[(TASK_ID(pxCurrentTCB))]å°±èƒ½è®°å½•å’Œè®¿é—®çº¿ç¨‹çš„è¿è¡Œæ—¶é—´ã€‚\næ¥ä¸‹æ¥å°±æ˜¯æœ€å…³é”®çš„traceTASK_SWITCHED_IN()å’ŒtraceTASK_SWITCHED_OUT()ï¼Œå®ƒä»¬çœ‹èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä¸€ä¸ªæœ€åŸºç¡€çš„é€»è¾‘å¦‚ä¸‹ï¼š\nstatic uint32_t switch_in_time = 0;static uint32_t task_runtime[MAX_TASK_NUMS] = &#123;0&#125;;void task_switched_out(void)&#123;    task_runtime[(TASK_ID(pxCurrentTCB))] += cpu_ts_timrd() - switch_in_time;&#125;void task_switched_in(void)&#123;    switch_in_time = cpu_ts_timrd();&#125;\n\nåˆ°æ­¤å°±å®ç°äº†è®°å½•ä»»åŠ¡çš„è¿è¡Œæ—¶é—´ï¼Œä½†æ˜¯è¿™å’ŒFreeRTOSå†…éƒ¨çš„å®ç°æ˜¯ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬éœ€è¦åœ¨é€‚å½“çš„æ—¶å€™æ¸…ç©ºæ‰€æœ‰çš„ä»»åŠ¡è¿è¡Œæ—¶é—´å¹¶é‡ç½®è®¡æ•°å™¨ï¼Œä¿è¯ç³»ç»Ÿæ€»æ˜¯è®°å½•ä»»åŠ¡æœ€æ–°çš„å¤„ç†å™¨åˆ©ç”¨ç‡ã€‚\nè®°å½•ä»»åŠ¡å®æ—¶çš„å¤„ç†å™¨åˆ©ç”¨ç‡å¦‚æœåªæœ‰ä¸€ä¸ªç¼“å­˜è®°å½•å¤„ç†å™¨çš„è¿è¡Œæ—¶é—´ï¼Œå°±ä¼šå­˜åœ¨ä¸€ä¸ªè¿™æ ·çš„æƒ…å†µï¼Œå½“è¿è¡Œæ—¶é—´æƒ…å†µçš„æ—¶å€™ï¼Œæ­£å¥½éœ€è¦æŸ¥çœ‹å¤„ç†å™¨çš„åˆ©ç”¨ç‡ï¼Œé‚£æ­¤æ—¶å°±çœ‹ä¸åˆ°å‡†ç¡®çš„æ•°æ®ã€‚æ‰€ä»¥è®¾è®¡ä¸¤ä¸ªç¼“å­˜ï¼Œä¸€ä¸ªç”¨äºè®°å½•å½“å‰çš„æ•°æ®ï¼Œå¦ä¸€ä¸ªç”¨äºç¼“å­˜ä¸Šä¸€æ¬¡çš„æ•°æ®å¹¶ç»™äºˆç”¨æˆ·è®¿é—®ã€‚\næœ€ç»ˆå®Œæ•´çš„è®¾è®¡å®ç°å¦‚ä¸‹ï¼š\nextern void* pxCurrentTCB;#define STAT_PERIOD (3000000u)#define TASK_ID(task) (((StaticTask_t*)(task))-&gt;uxDummy10[0])#define CURRENT_TASK_ID (TASK_ID(pxCurrentTCB))#define MAX_TASK_NUMS (32)static uint32_t switch_in_time = 0;static uint32_t task_runtime_buf1[MAX_TASK_NUMS] = &#123;0&#125;;static uint32_t task_runtime_buf2[MAX_TASK_NUMS] = &#123;0&#125;;static uint32_t task_total_runtime = 0;static uint32_t *task_current_runtime = task_runtime_buf1;void task_switched_out(void)&#123;    task_current_runtime[CURRENT_TASK_ID] += cpu_ts_timrd() - switch_in_time;&#125;void task_switched_in(void)&#123;    switch_in_time = cpu_ts_timrd();    if(switch_in_time == 0)&#123;        cpu_ts_time_init();        switch_in_time = cpu_ts_timrd();    &#125;    if(switch_in_time &gt; STAT_PERIOD)&#123;        cpu_ts_reset();        task_total_runtime = switch_in_time;        switch_in_time = 0;        if(task_current_runtime == task_runtime_buf1)            task_current_runtime = task_runtime_buf2;        else            task_current_runtime = task_runtime_buf1;        for(int i = 0; i &lt; MAX_TASK_NUMS; i++) task_current_runtime[i] = 0;    &#125;&#125;/*  * bit0 used for other task(id &gt;= 32) * other bit used for every task. */static uint32_t id_pool = 1u; /* hook to task create. */void alloc_task_id(void* task)&#123;    if(!task)        return ;    if(id_pool == 0xffffffff)&#123;        /* The task pool is full. */        TASK_ID(task) = 0;        return ;    &#125;    uint32_t new_pool = id_pool | (id_pool + 1u);    TASK_ID(task) = 31u - __CLZ(id_pool ^ new_pool);    id_pool = new_pool;&#125;/* hook to task delete. */void release_task_id(void* task)&#123;    if(!task)        return ;    uint8_t id = TASK_ID(task);    if(id == 0)&#123;        return ;    &#125;    id_pool &amp;= ~(1u &lt;&lt; id);&#125;static int task_id_exist(int id)&#123;    return (id_pool &amp; (1 &lt;&lt; id));&#125;static const uint32_t *get_task_runtime(void)&#123;    if(task_current_runtime == task_runtime_buf1)        return task_runtime_buf2;    else        return task_runtime_buf1;&#125;int show_cpu_usage(int argc, char **argv)&#123;    char buf[1024] = &#123;0&#125;;    int buf_len = 0;    // os_enter_critical();    const uint32_t *tick_buf = get_task_runtime();    float r = 0;    uint32_t irq_runtime = task_total_runtime;    for(int i = 0; i &lt; MAX_TASK_NUMS; i++)&#123;        if(!task_id_exist(i))&#123;            continue;        &#125;        if(i == 0)&#123;            if(tick_buf[i] &gt; 0)                buf_len += sprintf(buf + buf_len, &quot;&gt;32 --  &quot;);            else                continue;        &#125;else&#123;            buf_len += sprintf(buf + buf_len, &quot;%2d  --  &quot;, i);        &#125;        if(tick_buf[i] == 0)&#123;            buf_len += sprintf(buf + buf_len, &quot;0\\n&quot;);        &#125;else&#123;            r = 100.0f * (float)tick_buf[i] / task_total_runtime;            if(r &lt; 0.01f)                buf_len += sprintf(buf + buf_len, &quot;&lt;0.01%%\\n&quot;);            else                buf_len += sprintf(buf + buf_len, &quot;%.2f%%\\n&quot;, r);        &#125;        irq_runtime -= tick_buf[i];    &#125;    r = 100.0f * (float)irq_runtime / task_total_runtime;    buf_len += sprintf(buf + buf_len, &quot;IS  --  %.2f%%\\n&quot;, r);    // os_exit_critical(0);    puts(buf);    return 0;&#125;\nè®°å½•å‘¨æœŸä¸º3000msï¼Œè¿™ä¸ªæ—¶é—´éœ€è¦ç»“åˆå®šæ—¶å™¨çš„æº¢å‡ºæ—¶é—´ã€ç³»ç»Ÿæ€§èƒ½è¦æ±‚åšè°ƒæ•´ï¼Œæ—¶é—´å¤ªçŸ­ä¼šå½±å“ç³»ç»Ÿè°ƒåº¦æ€§èƒ½ï¼Œå¤ªé•¿ä¼šå¯¼è‡´å¤„ç†å™¨åˆ©ç”¨ç‡ç»Ÿè®¡çš„å®æ—¶æ€§é™ä½ï¼Œä¸”è®¡æ•°å™¨å­˜åœ¨æº¢å‡ºçš„é£é™©ã€‚\næœ€åè¿™é‡Œå†™äº†ä¸€æ®µç®€å•çš„ä»£ç æ¥è¾“å‡ºå„ä¸ªä»»åŠ¡çš„CPUåˆ©ç”¨ç‡ï¼Œç»è¿‡æˆ‘çš„æµ‹è¯•ï¼Œå®ƒèƒ½å¤Ÿå¾ˆå¥½çš„å·¥ä½œã€‚è®¿é—®æ•°æ®æ—¶å»ºè®®è¿›å…¥åˆ°ä¸´ç•ŒåŒºå¤„ç†ï¼Œè¿™æ ·æ›´åŠ å®‰å…¨ã€‚åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œæ¯ä¸ªçº¿ç¨‹ä½¿ç”¨IDè¡¨ç¤ºçš„ï¼ŒIDå’Œä»»åŠ¡åç§°çš„å…³ç³»å¯ä»¥é€šè¿‡FreeRTOSå†…æ ¸å‡½æ•°vTaskList()å¾—åˆ°ï¼Œä¸€ä¸€å¯¹åº”å³å¯ã€‚\næ€»ç»“å†…å®¹æˆ‘å†™çš„æ¯”è¾ƒä»“ä¿ƒï¼Œå…¶ä¸­éƒ¨åˆ†ç»†èŠ‚æˆ‘æ²¡æœ‰å¤ªå¤šçš„è¯´æ˜ï¼Œä½†æˆ‘è®¤ä¸ºè¿™äº›éƒ½æ˜¯æ¯”è¾ƒå¥½ç†è§£ã€‚å…³äºä»»åŠ¡IDçš„åˆ†é…ï¼Œè¿˜æœ‰äº›ç»†èŠ‚æ²¡æœ‰è¯´æ˜ï¼Œæˆ‘å°†è¶…è¿‡31ä¸ªä»»åŠ¡åé¢çš„ä»»åŠ¡IDç»Ÿä¸€åˆ†é…ä¸º0ï¼Œå®ƒä»¬çš„å¤„ç†å™¨åˆ©ç”¨ç‡å°†ä¸€å¹¶è®¡ç®—ï¼Œè¿™æ˜¯æˆ‘çš„IDåˆ†é…å™¨å†³å®šçš„ï¼Œå®ƒåªèƒ½åˆ†é…31ä¸ªIDã€‚\nå½“æ—¶æˆ‘å®ç°è¿™ä¸ªåŠŸèƒ½æ—¶å¿½ç•¥äº†FreeRTOSå†…æ ¸å¯¹ä»»åŠ¡IDçš„åˆ†é…ç­–ç•¥ï¼Œå½“æ—¶æˆ‘ç›´æ¥å¼•ç”¨ç³»ç»Ÿåˆ†é…çš„IDï¼Œå¦‚æœä¸å¯¹ä»»åŠ¡è¿›è¡Œåˆ é™¤æ“ä½œï¼Œä»–è¿˜æ˜¯èƒ½å¤Ÿå¯é çš„å·¥ä½œã€‚ä½†æ˜¯å¦‚æœéœ€è¦è¿›è¡Œä»»åŠ¡åˆ é™¤ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°ä¸€äº›å¥‡æ€ªçš„é—®é¢˜ã€‚æˆ‘ä¹Ÿæ˜¯æœ€è¿‘æ‰å‘ç°è¿™ä¸ªé—®é¢˜ã€‚ä¸»è¦æ˜¯å½“æ—¶å¯¹FreeRTOSå†…æ ¸å†…çš„ä¸€äº›ç»†èŠ‚è¿˜æ˜¯ä¸å¤Ÿäº†è§£ã€‚\nå…³äºä¸­æ–­çš„æ‰§è¡Œæ—¶é—´ï¼Œæˆ‘è¿™é‡Œåªæ˜¯ç²—ç•¥çš„ä¼°ç®—äº†ä¸€ä¸ªirq_runtime ï¼Œå®ƒåŒ…å«äº†å¤§éƒ¨åˆ†ä»»åŠ¡è°ƒåº¦çš„æ—¶é—´ï¼Œå¹¶ä¸èƒ½å¤Ÿä¿è¯æŠŠæ‰€æœ‰çš„ä¸­æ–­æ—¶é—´ç»Ÿè®¡åœ¨å†…ã€‚\nè¿™é‡Œæ¶‰åŠåˆ°äº†é«˜ç²¾åº¦å®šæ—¶å™¨ã€å¿«é€ŸIDçš„åˆ†é…ã€åŒç¼“å†²æœºåˆ¶ã€å†…æ ¸è°ƒåº¦ã€éä¾µå…¥å¼è®¾è®¡ç­‰å†…å®¹ï¼Œæ¯ä¸ªéƒ½èƒ½å¤Ÿæ‹¿å‡ºæ¥ç»†è®²ï¼Œé™äºæ—¶é—´å’Œç¯‡å¹…å°±ç‚¹åˆ°ä¸ºæ­¢ã€‚å¦‚æœä½ æœ‰å¹¸çœ‹åˆ°è¿™ç¯‡æ–‡ç« ï¼Œå¯¹å…¶ä¸­çš„å†…å®¹æœ‰ç–‘é—®æˆ–è€…å»ºè®®ï¼Œæ¬¢è¿ä¸€èµ·æ²Ÿé€šå­¦ä¹ ã€‚\n"},{"title":"é‡æ–°åšäº†ä¸€ç‰ˆARMä»¿çœŸå™¨","url":"/2025/02/14/%E9%87%8D%E6%96%B0%E5%81%9A%E4%BA%86%E4%B8%80%E7%89%88ARM%E4%BB%BF%E7%9C%9F%E5%99%A8/","content":"ç®€ä»‹æˆ‘æœ€è¿‘åˆé‡æ–°è®¾è®¡åˆ¶ä½œçš„äº†ä¸€æ¬¾ARMä»¿çœŸå™¨ï¼Œç›¸æ¯”äºä¹‹å‰åšçš„ç‰ˆæœ¬ï¼Œå¢åŠ äº†ä¸€å—å±å¹•ï¼Œå¹¶ä½¿ç”¨ç¼–ç å™¨æ‹¨è½®è¿›è¡Œäº¤äº’ï¼Œè¿˜å†…ç½®äº†ä¸€å—ç”µæ± ï¼Œå¯ä»¥å®ç°è„±æœºç¨‹åºçƒ§å½•ã€‚\nä¸‹é¢æ˜¯ä¸»è¦é…ç½®ï¼š\n\n160x128 åƒç´ åˆ†è¾¨ç‡çš„1.8å¯¸å±å¹•\n\nRP2350 MCU\n\nå†…ç½®16MBå­˜å‚¨ç©ºé—´+8MBæ‰©å±•è¿è¡Œå†…å­˜+32GB TFå¡æ”¯æŒ\n\n900mAh/3.7V é”‚ç”µæ± \n\nä¸€è·¯UARTæ¥å£\n\nä¸€è·¯SWDæ¥å£ï¼Œæ”¯æŒ20MHzé€Ÿç‡\n\nå¯å¯¹å¤–æä¾›3.3v/1Aä¾›ç”µ\n\n\næ”¯æŒçš„ä¸»è¦åŠŸèƒ½æœ‰ï¼š\n\nCMSIS-DAPè°ƒè¯•å™¨åŠŸèƒ½\n\nGDBè°ƒè¯•å™¨åŠŸèƒ½\n\nè„±æœºä¸‹è½½åŠŸèƒ½ï¼Œæ”¯æŒä¸Šç™¾æ¬¾MCU\n\nè„±æœºä¸²å£åŠŸèƒ½ï¼Œå¯åœ¨å±å¹•ä¸Šå®æ—¶æ˜¾ç¤ºä¸²å£æ¥æ”¶åˆ°çš„æ•°æ®\n\nè®¾å¤‡å†…æ–‡ä»¶ç®¡ç†åŠŸèƒ½\n\næ¨¡æ‹ŸUç›˜åŠŸèƒ½\n\n\nå¼€å‘è¿‡ç¨‹1.ç¡¬ä»¶éƒ¨åˆ†å…¶å®ä¸Šä¸€ç‰ˆå¼€å‘å®Œæˆåï¼Œæˆ‘å°±å‡†å¤‡ç€æ‰‹è¿™ä¸ªæ–°ç‰ˆæœ¬çš„å¼€å‘äº†ï¼Œä¸»è¦æ˜¯ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„åŠŸèƒ½äº®ç‚¹ä¸è¶³ï¼Œæœ€ç»ˆæˆ‘å†³å®šå†è¿›è¡Œä¸€æ¬¡å¤§çš„å‡çº§ã€‚ä¸»è¦æ˜¯å›´ç»•è®¾å¤‡èƒ½å¤Ÿè„±æœºä½¿ç”¨ï¼Œæ·»åŠ äº†è„±æœºä¸‹è½½å’Œè„±æœºä¸²å£åŠŸèƒ½ã€‚\né¦–å…ˆæ˜¯ç¡¬ä»¶å¼€å‘æ–¹é¢ï¼Œå°†MCUç”±RP2040æ›´æ¢ä¸ºRP2350ï¼Œå…¶ä¸»é¢‘ã€SRAMã€IOæ•°é‡éƒ½åšäº†å‡çº§ã€‚é€‰æ‹©è¯¥èŠ¯ç‰‡çš„åŸå› æ˜¯RP2350èŠ¯ç‰‡çš„ä»·æ ¼å·²ç»æ¯”è¾ƒå®æƒ äº†ä¸”æ€§èƒ½æœ‰äº†æ¯”è¾ƒå¤§çš„æå‡ï¼Œæœ€å…³é”®çš„æ˜¯ç”±äºå¢åŠ äº†ä¸å°‘å¤–è®¾(å±å¹•ã€å­˜å‚¨ç­‰)ä½¿å¾—IOåˆ†é…æ¯”è¾ƒç´§å¼ ã€‚\nè¯¥MCUè¿˜æ”¯æŒå¤–æ‰©PSRAMï¼Œæ‰€ä»¥åŠ äº†ä¸€é¢—AP6404Lçš„èŠ¯ç‰‡ï¼Œæ‰©å±•SRAMä¸»è¦æ˜¯ä¸ºäº†æé«˜è„±æœºä¸‹è½½æ—¶çš„é€Ÿåº¦ï¼Œæœ‰äº†å……è¶³çš„SRAMå°±å¯ä»¥å°†å›ºä»¶å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­è¿›è¡Œå†ä¸‹è½½ã€‚\nåœ¨å­˜å‚¨æ–¹é¢ï¼Œæ²¡æœ‰ç›´æ¥ä½¿ç”¨å­˜æ”¾å›ºä»¶çš„flashæ¥å­˜å‚¨æ•°æ®ï¼Œè€Œæ˜¯å•ç‹¬æ·»åŠ äº†ä¸€å—norflashèŠ¯ç‰‡ï¼Œè¿˜æ·»åŠ äº†TFå¡çš„å¡åº§ï¼Œnorflashå’Œtfå¡å…±ç”¨ä¸€æ¡SPIè¿›è¡Œæ•°æ®ä¼ è¾“ã€‚å±å¹•ä¸ºä¸€å—ST7735ä¸»æ§çš„LCDå±å¹•ï¼Œè¿˜æ˜¯ä½¿ç”¨SPIè¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œä¸ºäº†ä¿è¯å±å¹•åˆ·æ–°å’Œå­˜å‚¨æ•°æ®çš„è¯»å†™ï¼Œå±å¹•å’Œå­˜å‚¨èŠ¯ç‰‡å„è‡ªä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„SPIã€‚\næ‹¨è½®æ˜¯SIQ-02FVS3ï¼Œä¸ºABç¼–ç å™¨æ¥å£ï¼ŒåŸæœ¬è®¡åˆ’ä½¿ç”¨PIOé©±åŠ¨ï¼Œä½†æ˜¯å¼€å‘è½¯ä»¶æ—¶æ‰å‘ç°IOåˆ†é…ä¸åˆç†å¯¼è‡´åªèƒ½ä½¿ç”¨ä¸­æ–­é©±åŠ¨ã€‚\nç”µæºæ–¹é¢çš„ç”µè·¯å˜åŒ–ä¸å¤§ï¼Œä¸»è¦æ˜¯å¢åŠ äº†å……ç”µèŠ¯ç‰‡å’Œå¼€å…³æœºç®¡ç†ç”µè·¯ï¼Œå……ç”µèŠ¯ç‰‡ä¸ºTP4057ï¼Œå¯¹äºè¿™ä¸ªç®€å•çš„è®¾å¤‡æ¥è¯´ï¼Œæš‚æ—¶ä¸éœ€è¦å¿«å……ç­‰åŠŸèƒ½ã€‚å¼€å…³æœºç®¡ç†ä½¿ç”¨ä¸€äº›MOSç®¡è¿›è¡Œæ­å»ºï¼Œå¦‚ä¸‹å›¾ï¼š\n\n\nå¼€å…³ç”µè·¯\n\n\nå¼€å…³æœºæŒ‰é”®å¤ç”¨ç¼–ç å™¨æ‹¨è½®çš„æŒ‰é”®ï¼Œå™¨ä»¶é€‰æ‹©ä¸Šä¸»è¦æ˜¯è¦è€ƒè™‘ç”µæµå‚æ•°ã€‚\nåœ¨è¿™ä¸€ç‰ˆä¸­ï¼Œå¤–éƒ¨çš„SWDæ¥å£å’ŒUARTæ¥å£ä¸Šéƒ½æ·»åŠ äº†ESDä¿æŠ¤èŠ¯ç‰‡ã€‚è¿™æ ·å¤–éƒ¨çš„åŒ…æ‹¬USBåœ¨å†…çš„ä¸‰ä¸ªæ’æ‹”æ¥å£éƒ½æœ‰äº†é˜²é™ç”µä¿æŠ¤ã€‚\næ¥çœ‹çœ‹PCBï¼š\næ‹¨è½®çš„å®‰è£…æ¯”è¾ƒç‰¹æ®Šï¼Œåœ¨PCBä¸ŠæŒ–äº†ä¸€ä¸ªæ´ï¼Œä½¿å¾—æ³¢è½®èƒ½å¤Ÿæ²‰åˆ°åº•éƒ¨ï¼Œåœ¨èƒŒéƒ¨ç„Šæ¥ã€‚å¦‚æœæ­£å¸¸å®‰è£…ç„Šæ¥ï¼Œå®ƒå°†æ˜¯æ•´ä¸ªPCBä¸Šæœ€é«˜çš„å…ƒä»¶ã€‚ç°åœ¨è¿™ç§å®‰è£…æ–¹å¼å¯ä»¥å‡å°æ•´ä¸ªPCBçš„åšåº¦ã€‚\nPCBä¸Šç”µæ± åº§å­çš„+-ç¬¦å·æ ‡è¯†åäº†ï¼Œä½†æ˜¯ä¸å½±å“æ­£å¸¸ä½¿ç”¨ã€‚æ‰€æœ‰çš„å…ƒä»¶éƒ½æ˜¯ç”¨é£æªç„Šä¸Šå»çš„ï¼Œç„Šæ¥æ•ˆæœè¿˜æ¯”è¾ƒæ»¡æ„ï¼Œè¿™æ¬¡æ¸©åº¦æŠŠæ§çš„æ¯”è¾ƒå¥½ï¼Œå¡‘æ–™ä»¶æ²¡æœ‰ä»»ä½•å˜å½¢ã€‚\nTips:MCUæ—è¾¹æœ‰é¢—ç”µå®¹å°ºå¯¸ä¸å¯¹ï¼ŒåŸæœ¬åº”è¯¥ç”¨0402çš„å°è£…ï¼Œä½†æ˜¯è¯¥å®¹å€¼çš„ç”µå®¹æ‰‹è¾¹æ²¡æœ‰ï¼Œæ‰€ä»¥ç”¨0603çš„å°è£…\n2.è½¯ä»¶éƒ¨åˆ†ç¡¬ä»¶å¼„å¥½åå°±æ˜¯è½¯ä»¶å¼€å‘å·¥ä½œï¼Œåœ¨è½¯ä»¶å¼€å‘æ–¹é¢ï¼Œé¦–å…ˆæ˜¯éœ€è¦å°†ä¸»è¦çš„å¤–è®¾é©±åŠ¨å¼€å‘å®Œæˆï¼ŒåŒ…æ‹¬å±å¹•ã€NorFlashã€TFå¡ï¼Œç¼–ç å™¨ç­‰ã€‚\nST7735é©±åŠ¨éƒ½æœ‰ç°æˆæ¯”è¾ƒå¥½ç”¨çš„ï¼Œä¸»è¦æ˜¯è¦è€ƒè™‘å¼‚æ­¥æ¸²æŸ“å’Œåˆ·æ–°çš„æ€§èƒ½é—®é¢˜ï¼Œå…¶å®ƒå°±æ˜¯è°ƒè¯•ä¸€ä¸‹å±å¹•è¾¹ç•Œå’Œé¢œè‰²ç¿»è½¬å°±å®Œæˆäº†ï¼Œæ·˜å®ä¸Š5å—é’±ä¹°çš„å±å¹•ï¼Œæ•ˆæœåªèƒ½è¯´ä¸€èˆ¬èˆ¬ã€‚\nTFå¡çš„é©±åŠ¨è¦éº»çƒ¦ä¸€äº›ï¼ŒRP2350æ²¡æœ‰SDIOæ¥å£ï¼Œç”¨PIOæ¨¡æ‹Ÿç›®å‰ä¹Ÿä¸ä¼šã€‚åªèƒ½ä½¿ç”¨SPIè¿›è¡Œé€šè®¯äº†ï¼Œæ—¶é’Ÿé€Ÿåº¦20MHzï¼ŒNorFlashå’Œå®ƒå…±ç”¨SPIï¼ŒNorFlashé€Ÿåº¦æœ¬å¯ä»¥å†é«˜ä¸€äº›ï¼Œä½†æ˜¯åªèƒ½å…¼é¡¾TFçš„é€Ÿåº¦äº†ï¼Œé€Ÿåº¦å†é«˜ä¸€äº›TFå¡ä¼¼ä¹å­˜åœ¨ä¸€äº›é—®é¢˜ã€‚TFå¡ä½¿ç”¨FatFSé©±åŠ¨ï¼Œæ–‡ä»¶è¯»å†™å¯ä»¥åœ¨400kB/så·¦å³ï¼ŒNorFlashä½¿ç”¨LittleFsè¯»å–é€Ÿåº¦è¦å¿«ä¸€äº›ã€‚\nST7735çš„SPIé‡‡ç”¨DMAä¼ è¾“æ•°æ®ï¼Œè€ƒè™‘åˆ°ä½¿ç”¨DMAä¼šåˆ°äº†é¢å¤–çš„ä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œçº¿ç¨‹åˆ‡æ¢ï¼Œå¯¹äºå°äº15å­—èŠ‚çš„ä¼ è¾“ä»»ç„¶é‡‡ç”¨é˜»å¡ä¼ è¾“ä¼šæ¯”è¾ƒå¥½ã€‚é€šè¿‡åç»­æµ‹è¯•å‘ç°éƒ¨åˆ†é¡µé¢ä¸Šçš„å…¨å±åŠ¨æ•ˆè¿è¡Œèµ·æ¥çš„CPUå ç”¨ä¹Ÿå°±ä¸åˆ°50%ã€‚\nå¯¹äºW25Q128å’ŒTFå¡å…±ç”¨çš„SPIæ¥è¯´ï¼Œä½¿ç”¨DMAè¦ç¨å¾®å¤æ‚ä¸€äº›ã€‚è¿™é‡Œæˆ‘ä¹Ÿæ˜¯æ‘¸ç´¢äº†å¥½ä¹…æ‰æ‰¾åˆ°æ­£ç¡®çš„å†™æ³•ï¼ŒRP2350çš„SPIå¿…é¡»è¦æœ‰TXçš„æ•°æ®æ‰èƒ½å®Œæˆæ­£å¸¸çš„ä¸€æ¬¡æ•°æ®ä¼ è¾“ï¼Œæ‰€ä»¥æœ€å¼€å§‹æˆ‘åªå†™äº†DMAæ¥æ”¶ï¼Œå‘ç°DMAå¹¶æ²¡æœ‰å¯åŠ¨ä¼ è¾“ï¼Œé‚£æ˜¯å› ä¸ºSPIæ²¡æœ‰å‘å‡ºæ•°æ®ï¼Œè‡ªç„¶ä¹Ÿå°±æ— æ³•æ¥æ”¶æ•°æ®ï¼Œæ‰€ä»¥æ•°æ®æ”¶å‘å¿…é¡»æˆå¯¹ï¼Œå³ä½¿ç”¨DMAä¹Ÿå¿…é¡»è¦è¿™æ ·ã€‚å¯¹äºæ•°æ®æ¥æ”¶æ¥è¯´ï¼Œæˆ‘æ˜¯è¿™æ ·å†™çš„ï¼š\nint spi_shard_read(uint8_t *buf, int len){    int ret;    if(len &lt;= 15){        ret = spi_read_blocking(SPI_INS, 0xff, buf, len);    }else{        uint8_t tx_dummy = 0xff;        /* DMA read dummy data Not increment */        dam_channel_read_increment(dma_tx_chan, false);        /* Read the data from the SPI FIFO by DMA */        dma_channel_transfer_to_buffer_now(dma_rx_chan, buf, len);        /* Write the dummy data to the SPI FIFO by DMA, Used to generate clock signals */        dma_channel_transfer_from_buffer_now(dma_tx_chan, &amp;tx_dummy, len);        /* Wait Rx DMA to complete */        if(xSemaphoreTake(spi_dma_rx_sync, pdMS_TO_TICKS(200)) == pdFALSE){            ret = 0;        }else{            ret = len;        }        /* Recover Tx channel auto increment */        dam_channel_read_increment(dma_tx_chan, true);        /* Clear the Tx sync semaphore */        xSemaphoreTake(spi_dma_tx_sync, 0);    }    return ret;}\n\nåˆ›å»ºäº†ä¸¤ä¸ªDMAè¯·æ±‚ï¼Œä½†æ˜¯Txå‘é€çš„æ•°æ®ä¸´æ—¶å…³é—­äº†åœ°å€è‡ªå¢ï¼Œå› ä¸ºå‘é€çš„æ•°æ®æœ¬å°±æ˜¯dummyï¼Œæ‰€ä»¥ä¸éœ€è¦åœ°å€è‡ªå¢ã€‚DMAè¯·æ±‚å‘å‡ºåï¼ŒDMAå°±ä¼šè‡ªåŠ¨ä»SPIçš„FIFOä¸­å°†æ•°æ®è¯»å–å‡ºæ¥ï¼Œç­‰å¾…DMAä¸­æ–­å‘å‡ºçš„åŒæ­¥ä¿¡å·å°±è¡¨ç¤ºæ•°æ®ä¼ è¾“å®Œæˆã€‚\nå¯¹äºSPIçš„DMAå‘é€æ¥è¯´ï¼Œä¹Ÿæœ‰ä¸€äº›æƒ…å†µéœ€è¦å¤„ç†ï¼š\nint spi_shard_write(const uint8_t *buf, int len){    int ret;    if(len &lt;= 15){        ret = spi_write_blocking(SPI_INS, buf, len);    }else{        /* Write the date to the SPI FIFO by DMA */        dma_channel_transfer_from_buffer_now(dma_tx_chan, buf, len);        /* Wait for the DMA to complete */        if(xSemaphoreTake(spi_dma_tx_sync, pdMS_TO_TICKS(200)) == pdFALSE){            ret = 0;        }else{            ret = len;        }        /* Wait for the SPI to complete */        while(spi_is_busy(SPI_INS)){            if(spi_is_readable(SPI_INS)){                (void)spi_get_hw(SPI_INS)-&gt;dr;            }            taskYIELD();        }        /* Clear the RX FIFO and clear the overrun flag */        while(spi_is_readable(SPI_INS))            (void)spi_get_hw(SPI_INS)-&gt;dr;        spi_get_hw(SPI_INS)-&gt;icr = SPI_SSPICR_RORIC_BITS;    }    return ret;}\n\nè¿™é‡Œåªåˆ›å»ºDMAæ•°æ®å‘é€è¯·æ±‚å³å¯ï¼ŒSPIæ¥æ”¶å›æ¥åˆ°RxFIFOä¸­çš„æ•°æ®å¯èƒ½ä¼šæº¢å‡ºï¼Œä½†æ˜¯å¯ä»¥å¿½ç•¥å®ƒä»¬ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒDMAä¼ è¾“å®Œæˆä¸ä»£è¡¨SPIå·²ç»ä¼ è¾“å®Œæˆï¼Œå› ä¸ºSPIå†…éƒ¨æ˜¯å¸¦æœ‰FIFOçš„ï¼Œè¿™é‡Œç®€å•çš„ç”¨spi_is_busyæ¥åˆ¤æ–­SPIæ˜¯å¦ä¼ è¾“å®Œæˆï¼Œä¼ è¾“å®Œæˆåå†å°†RxFIFOä¸­çš„æ•°æ®æ¸…ç©ºä»¥é¿å…å¯¹åç»­çš„æ•°æ®è¯»å–äº§ç”Ÿå¹²æ‰°ã€‚è¿™é‡Œæ›´ä¸¥æ ¼çš„å†™æ³•æ˜¯ä½¿ç”¨çš„SPIçš„RxFIFOä¸ºç©ºä¸­æ–­å»å¤„ç†SPIç­‰å¾…çš„é—®é¢˜ï¼Œä¸è¿‡è€ƒè™‘åˆ°FIFOæœ¬èº«å¹¶ä¸å¤§ä¸”SPIçš„æ—¶é’Ÿé€Ÿç‡è¾ƒé«˜ï¼Œè¿™é‡Œé˜»å¡çš„æ—¶é—´å¯ä»¥å¿½ç•¥ã€‚\nçœ‹é—¨ç‹—å¦‚ä½•æ£€æµ‹ä¸¤ä¸ªMCUæ ¸å¿ƒéƒ½åœ¨æ­£å¸¸å·¥ä½œå‘¢ï¼Ÿåˆšå¼€å§‹å°±å‡ºç°ç³»ç»Ÿçš„ä¸€ä¸ªæ ¸å¿ƒå·²ç»æ­»æœºäº†ï¼Œä½†æ˜¯å–‚ç‹—çš„æ“ä½œåœ¨å¦ä¸€ä¸ªæ ¸å¿ƒä¸Šï¼Œå¯¼è‡´ç³»ç»Ÿæ— æ³•åŠæ—¶å¤ä½ã€‚åé¢æˆ‘æƒ³åˆ°äº†ä¸€ä¸ªæ¯”è¾ƒå¥½çš„åŠæ³•ï¼š\nstatic void watchdog_task(void *ptr){    if (watchdog_caused_reboot()){        reset_usb_boot(0, 0);    }    watchdog_enable(1000, 1);    while(1){#if (configNUMBER_OF_CORES &gt; 1)        /* Update watchdog on all cores */        for(int i = 0; i &lt; configNUMBER_OF_CORES; i++){            vTaskCoreAffinitySet(NULL, 1 &lt;&lt; i);            watchdog_update();            vTaskDelay(pdMS_TO_TICKS(500));        }#else        watchdog_update();        vTaskDelay(pdMS_TO_TICKS(500));#endif    }}\n\né€šè¿‡FreeRTOSåˆ›å»ºä¸€ä¸ªæœ€ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡(æ¯”IDLEçº¿ç¨‹ä¼˜å…ˆçº§é«˜)æ¥è¿è¡Œçœ‹é—¨ç‹—ã€‚çœ‹é—¨ç‹—çš„è¶…æ—¶æ—¶é•¿è®¾ç½®ä¸º1ç§’ï¼Œè¯¥ä»»åŠ¡å‡†å¤‡æ¯500msè¿›è¡Œä¸€æ¬¡å–‚ç‹—æ“ä½œï¼Œå³ä½¿é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡æœ‰æ—¶é—´ç‰‡æŠ¢å çš„æƒ…å†µï¼Œè¿˜æœ‰500msçš„å†—ä½™ç©ºé—´ã€‚è¿™é‡Œæ¯”è¾ƒå–å·§çš„æ˜¯æˆ‘æ¯æ¬¡å–‚ç‹—å®Œæˆåå°±å°†ä»»åŠ¡åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ ¸å¿ƒä¸Šè¿è¡Œï¼Œè¿™æ ·å°±ç¡®ä¿èƒ½å¤Ÿå¯¹æ‰€æœ‰çš„æ ¸å¿ƒéƒ½èµ·åˆ°ç›‘æ§çš„ä½œç”¨ã€‚\nSWDé‚£éƒ¨åˆ†çš„å¸ƒçº¿æˆ–è€…ç”µè·¯å¯èƒ½è¿˜éœ€è¦ä¼˜åŒ–ï¼ŒèŠ¯ç‰‡å’Œè½¯ä»¶æ”¯æŒçš„æœ€é«˜é€Ÿç‡æ˜¯37.5MHzï¼Œè€Œå®é™…ä¸Šåœ¨30MHzæ—¶é’Ÿä¸‹å·¥ä½œä¼šå‡ºç°æ— æ³•è¯†åˆ«å¤–éƒ¨èŠ¯ç‰‡çš„é—®é¢˜ï¼Œç›®å‰æœ€é«˜åªèƒ½å·¥ä½œåœ¨20MHzï¼Œæˆ‘æ€€ç–‘æ˜¯èµ°çº¿ä¸è§„èŒƒæˆ–è€…é˜»æŠ—ç›¸å…³çš„é—®é¢˜ï¼Œå¦‚æœè¦åšä¸‹ä¸€ç‰ˆå†å»ç€é‡è§£å†³ã€‚\nSWDçš„åº•å±‚é‡‡ç”¨PIOæ¥é©±åŠ¨ï¼Œæ—¶åºä¸Šè‚¯å®šæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ç›®å‰é‡åˆ°ä¸€ä¸ªä¸PIOäº¤äº’çš„æ€§èƒ½é—®é¢˜ï¼Œä¸PIOäº¤äº’æ˜¯é€šè¿‡ä¸€ä¸ªç¡¬ä»¶FIFOå®ç°çš„ï¼Œæ¯æ¬¡é‡åˆ°FIFOä¸ºç©ºæˆ–æ»¡æ—¶éƒ½éœ€è¦è¿›è¡Œé˜»å¡å¼çš„ç­‰å¾…ï¼Œè¿™ä¼šä½¿å¾—ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡è¢«é•¿æ—¶é—´é˜»å¡ã€‚å¦‚æœé‡‡ç”¨ä¸­æ–­ä¿¡å·é€šçŸ¥FIFOçŠ¶æ€ï¼Œæˆ‘æ‹…å¿ƒé¢‘ç¹çš„ä¸­æ–­ä¿¡å·ä¹Ÿä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ï¼Œè¿™ä¸ªåœ°æ–¹æˆ–è®¸è¿˜è¦å¥½å¥½æƒ³æƒ³æ€ä¹ˆä¼˜åŒ–ï¼Œæˆ–è®¸éœ€è¦å¤§æ”¹åº•å±‚çš„SWDå®ç°æ–¹æ³•ã€‚\nåœ¨è½¯ä»¶åŠŸèƒ½è®¾è®¡ä¸Šï¼ŒCMSIS-DAPå’ŒGDBè°ƒè¯•åŠŸèƒ½åœ¨ä¸Šä¸€ä¸ªç‰ˆæœ¬å°±å·²ç»å¼€å‘å®Œæˆäº†ï¼Œæœ¬æ¬¡ä¸»è¦çš„å¼€å‘å·¥ä½œéƒ½æ˜¯å›´ç»•GUIç›¸å…³åŠŸèƒ½è¿›è¡Œçš„ã€‚GUIéƒ¨åˆ†é‡‡ç”¨LVGL9å›¾å½¢æ¡†æ¶ï¼Œæ­é…GUI-Guiderè¿›è¡Œå¼€å‘ï¼Œç›®å‰GUI-Guiderè¿˜ä¸æ”¯æŒLVGL9ï¼Œæ‰€ä»¥UIçš„å¼€å‘å·¥ä½œè¿˜æ˜¯æ¯”è¾ƒå¤šã€‚\nåœ¨GUIä¸Šé™¤äº†è®¾è®¡UIè€—è´¹æ—¶é—´å¤–ï¼Œæ–‡ä»¶ç®¡ç†åŠŸèƒ½å’Œè„±æœºä¸‹è½½åŠŸèƒ½è€—è´¹äº†æ¯”è¾ƒå¤šçš„å¼€å‘æ—¶é—´ï¼ŒNorFlashå’ŒTFå·¥ä½œåœ¨ä¸¤å¥—ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿä¸‹ï¼Œè¦å®ç°æ–‡ä»¶çš„ç»Ÿä¸€ç®¡ç†ï¼Œå¿…é¡»è®¾è®¡æ›´ä¸Šå±‚çš„æŠ½è±¡æ¥å£å±‚ã€‚TFå¡è¿˜éœ€è¦å…è®¸é€šè¿‡USBæŒ‚è½½åˆ°ç”µè„‘ä¸Šï¼Œå…¶ä¸­çš„åŠŸèƒ½ç»†èŠ‚ä¹Ÿæ¯”è¾ƒå¤šã€‚ä¸ºäº†è·å¾—æœ€ä½³çš„ä¸‹è½½é€Ÿåº¦ï¼Œæˆ‘å°†å›ºä»¶ä»æ–‡ä»¶ä¸­è¯»å–å¹¶è§£æå®Œæˆåå…¨éƒ¨å­˜å‚¨åœ¨RAMä¸­ï¼Œç„¶åå†è¿›è¡Œä¸‹è½½ï¼Œè¿™å¯¹äºHEXç±»å›ºä»¶æ¥è¯´å¯ä»¥æ˜¾è‘—æé«˜ä¸‹è½½é€Ÿåº¦ã€‚\nç›®å‰ä¸»è¦æ”¯æŒhexæ ¼å¼çš„å›ºä»¶ä¸‹è½½ï¼Œbinæ ¼å¼çš„å›ºä»¶åªèƒ½ä¸‹è½½åˆ°èŠ¯ç‰‡å†…Flashé¦–åœ°å€ä¸Šï¼Œè¿˜ä¸æ”¯æŒè‡ªå®šä¹‰ï¼Œä¸»è¦æ˜¯è®¾å¤‡æ²¡æœ‰é”®ç›˜å’Œè§¦æ‘¸å±ï¼Œä¸æ–¹ä¾¿è¾“å…¥ã€‚å¯¹äºelfæ ¼å¼çš„å›ºä»¶è¿˜åœ¨å‡†å¤‡å¼€å‘ä¸­ã€‚\nåˆ†äº«ä¸€ä¸ªå¼€å‘å·¥ç¨‹ä¸­é‡åˆ°çš„ä¸€ä¸ªç«æ€é—®é¢˜ï¼Œä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„é—®é¢˜ã€‚è¯¥é—®é¢˜å‡ºç°åœ¨USBä¸²å£åŠŸèƒ½ä¸­ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ç”¨äºå°†ç¡¬ä»¶UARTä¸Šæ”¶å‘åˆ°çš„æ•°æ®ä¼ è¾“åˆ°USBåè®®æ ˆä¸­ã€‚é—®é¢˜ç°è±¡æ˜¯USBåè®®æ ˆæ”¶åˆ°ç”µè„‘å‘æ¥çš„æ•°æ®åä»ç¡¬ä»¶ä¸²å£å‘å‡ºåå¼‚å¸¸ï¼Œå°æ¦‚ç‡å‡ºç°æ•°æ®ä¸­å¤šäº†ä¸€æ®µä¹±ç çš„æ•°æ®ã€‚å¯¼è‡´è¯¥é—®é¢˜çš„åŸå› æ˜¯åœ¨UARTçš„DMAä¸­æ–­å¤„ç†å‡½æ•°ä¸­å‡ºç°äº†é‡å…¥ï¼Œå¯¼è‡´å¯¹FIFOçš„æ“ä½œå‡ºç°äº†æŠ¢å ï¼Œå¯¼è‡´FIFOå†…çš„æ•°æ®é•¿åº¦å¼‚å¸¸ã€‚ä¸ºä»€ä¹ˆä¸­æ–­å‡½æ•°ä¼šé‡å…¥ï¼Ÿå› ä¸ºRP2350æ˜¯ä¸€ä¸ªåŒæ ¸MCUï¼Œå®ƒå…è®¸ä¸­æ–­åŒæ—¶åœ¨ä¸¤ä¸ªæ ¸å¿ƒä¸Šè¿è¡Œï¼Œæ ¹æ®PICO-SDKçš„æ‰‹å†Œæ¥çœ‹irq_set_exclusive_handler()å’Œirq_set_enabled()å‡½æ•°éƒ½æ˜¯åªå¯¹MCUå½“å‰çš„æ ¸å¿ƒç”Ÿæ•ˆï¼Œä¸ºä»€ä¹ˆä¸­æ–­ä¼šåŒæ—¶è¿è¡Œåœ¨ä¸¤ä¸ªæ ¸å¿ƒä¸Šï¼Ÿç»è¿‡ä»”ç»†çš„åˆ†æï¼Œé¦–å…ˆè§£é‡Šç¬¬ä¸€ç‚¹ï¼Œä¸ºä»€ä¹ˆè¯¥ä¸­æ–­å‡½æ•°é€šè¿‡irq_set_exclusive_handlerä¼šåŒæ—¶å°†ä¸­æ–­ç»‘å®šä¸¤ä¸ªæ ¸å¿ƒä¸Šï¼Œæ ¹æ®èŠ¯ç‰‡æ‰‹å†Œï¼Œä¸¤ä¸ªæ ¸å¿ƒæ‹¥æœ‰ç‹¬ç«‹çš„ä¸­æ–­å‘é‡è¡¨ã€‚ä½†æ˜¯è¿™é‡Œæˆ‘å¿½ç•¥äº†ä¸€ç‚¹ï¼Œç¬¬äºŒä¸ªæ ¸å¿ƒæ˜¯ç”±FreeRTOSå¯åŠ¨ï¼Œå®ƒé»˜è®¤ç›´æ¥å¤ç”¨äº†æ ¸å¿ƒ1çš„ä¸­æ–­å‘é‡è¡¨ï¼Œå¯¼è‡´ä¸¤ä¸ªæ ¸å¿ƒå°†å…±äº«ä¸­æ–­å‘é‡è¡¨ã€‚\nFreeRTOSå¯¹äºRP2350çš„portæ–‡ä»¶ï¼š\nBaseType_t xPortStartScheduler( void ){    ...    multicore_reset_core1();    multicore_launch_core1( prvDisableInterruptsAndPortStartSchedulerOnCore );    xPortStartSchedulerOnCore();    /* Should not get here! */    return 0;}\n\nå¯åŠ¨ç¬¬äºŒç»™æ ¸å¿ƒçš„å‡½æ•°æ˜¯multicore_launch_core1(),åœ¨å®ƒå†…éƒ¨çš„å®ç°ä¸Šä¼šå¤ç”¨å½“å‰ä¸­æ–­å‘é‡è¡¨åœ°å€ã€‚å¦‚æœè¦ç»™ç¬¬äºŒä¸ªæ ¸å¿ƒèµ‹äºˆç‹¬ç«‹çš„ä¸­æ–­è¯¦è¡¨ï¼Œåº”è¯¥ä½¿ç”¨multicore_launch_core1_rawæ¥å£ã€‚åˆ°äº†è¿™é‡Œå°±æ˜ç™½äº†ä¸ºä»€ä¹ˆç¬¬äºŒä¸ªæ ¸å¿ƒä¼šå­˜åœ¨ä¸­æ–­å‡½æ•°ã€‚å†è§£é‡Šç¬¬äºŒç‚¹ï¼Œä¸ºä»€ä¹ˆè¯¥ä¸­æ–­è¢«ä½¿èƒ½äº†ã€‚\nåœ¨åˆ›å»ºUARTä»»åŠ¡æ—¶æ˜¯è¿™æ ·å†™çš„ï¼š\nxTaskCreate(cdc_thread, \"UART\", configMINIMAL_STACK_SIZE, NULL, UART_TASK_PRIO, &amp;uart_taskhandle);#if (configNUMBER_OF_CORES &gt; 1)vTaskCoreAffinitySet(uart_taskhandle, 1 &lt;&lt; 0);#endif\n\nå¯ä»¥çœ‹åˆ°å·²ç»é€šè¿‡vTaskCoreAffinitySetå‡½æ•°å°†è¯¥ä»»åŠ¡ç»‘å®šåˆ°äº†æ ¸å¿ƒ0ä¸Šï¼Œä½†æ˜¯æˆ‘å¿½ç•¥äº†ä¸€ç‚¹ï¼Œç”±äºå½“å‰ä»»åŠ¡çš„ä¼˜å…ˆçº§æ¯”åˆ›å»ºçš„UARTä»»åŠ¡ä¼˜å…ˆçº§ä½ï¼Œå¯¼è‡´UARTä»»åŠ¡åˆ›å»ºå®Œæˆåå°±ç«‹å³æ‰§è¡Œï¼Œè€Œä»»åŠ¡å‡½æ•°å†…è¿›è¡Œä¸­DMAä¸­çš„å¼€å…³æ“ä½œï¼Œå¯¼è‡´æ ¸å¿ƒ1ä¸Šçš„DMAä¸­æ–­ä¹Ÿæ‰“å¼€äº†ã€‚è¿™æ˜¯åœ¨æçŸ­æ—¶é—´å†…å‡ºç°çš„ã€‚è¿™æ˜¯ä¸€ç§éå¸¸å…¸å‹çš„ç«Ÿæ€é—®é¢˜ï¼Œä¿®å¤çš„æ‰‹æ®µä¹Ÿéå¸¸ç®€å•ï¼Œå°±æ˜¯åœ¨ä¸²å£ä»»åŠ¡çš„å…¥å£å¤„ï¼Œå°†ä»»åŠ¡æœ¬èº«ç»‘å®šåˆ°å’Œæ ¸å¿ƒ0ä¸Šã€‚å†è¯´ä¸€ä¸‹ä¸ºä»€ä¹ˆåœ¨ä»»åŠ¡å†…è¿›è¡Œäº†ä¸­æ–­çš„å¼€å…³æ“ä½œï¼Œå› ä¸ºFIFOæ•°æ®æ¥å£çš„æ“ä½œéœ€è¦é”å®šï¼Œç†è®ºä¸Šæ¥è¯´åˆšå¼€æœºåˆå§‹åŒ–æ—¶æ²¡æœ‰æ•°æ®æ”¶å‘æ‰å¯¹ï¼Œä½†ç”±äºä¸²å£åˆšå¼€å§‹è«åå¥‡å¦™æ”¶åˆ°ä¸€ä¸ªå­—ç¬¦ï¼Œå°±æ˜¯è¿™ä¸€è¿ä¸²çš„é—®é¢˜å¯¼è‡´äº†è¿™ä¸ªbugã€‚åˆ†æè¿™ä¸ªé—®é¢˜è‡³å°‘èŠ±äº†å¤§åŠå¤©æ—¶é—´ï¼Œå¯ä»¥çœ‹çœ‹è¿™ä¸ªcommitã€‚\nRP2350+FreeRTOSçš„ä½åŠŸè€—æ¨¡å¼ä¹Ÿæœ‰è¿›è¡Œæµ‹è¯•ï¼Œå¼€å¯configUSE_TICKLESS_IDLEæ˜¯å¿…è¦çš„ï¼Œè¿™æ ·è¿è¡Œsystickçš„æ ¸å¿ƒ0å¯ä»¥æ­£å¸¸è¿›å…¥ä¼‘çœ çŠ¶æ€ã€‚å¦‚æœç¬¬äºŒä¸ªæ ¸å¿ƒä¹Ÿè¿è¡Œäº†ï¼Œé‚£è¿˜éœ€è¦å¼€å¯configUSE_PASSIVE_IDLE_HOOKï¼Œè®©ç¬¬äºŒä¸ªæ ¸å¿ƒé€šè¿‡WFIæŒ‡ä»¤è¿›å…¥ç¡çœ çŠ¶æ€ã€‚åªæœ‰ä¸¤ä¸ªæ ¸å¿ƒéƒ½è¿›å…¥ä¼‘çœ ï¼ŒRP2350æ‰èƒ½è¿›å…¥ä½åŠŸè€—æ¨¡å¼ã€‚å¼€å¯ä½åŠŸè€—æ¨¡å¼åï¼Œç³»ç»ŸåŠŸè€—æœ‰ä¸€å®šé™ä½ï¼Œä½†æ˜¯æˆ‘æˆ‘çš„è®¾å¤‡åŠŸè€—æœ¬èº«ä¸é«˜ï¼Œå¯ä»¥è½»æ¾å¾…æœº10å°æ—¶ä»¥ä¸Šï¼Œæ‰€ä»¥ä½åŠŸè€—æ¨¡å¼æ˜¯æ²¡æœ‰å¼€å¯çš„ã€‚\n2025.3.4 UPDATE:æœ€è¿‘å¯¹è¯¥é¡¹ç›®çš„ä¸€äº›ç»†èŠ‚é—®é¢˜è¿›è¡Œäº†ç ”ç©¶ï¼ŒåŒ…æ‹¬SWDæ—¶é’Ÿé€Ÿç‡å’ŒSDå¡çš„é©±åŠ¨æ–¹å¼ã€‚æœ€è¿‘å‘ç°ï¼ŒPIOæ¨¡å—å†…éƒ¨ä¸ºäº†é¿å…è¾“å…¥IOä¸Šå­˜åœ¨æŠ–åŠ¨ï¼Œå¯¹è¾“å…¥ä¿¡å·ç»è¿‡äº†ä¸€ä¸ªè§¦å‘åŒæ­¥å™¨ï¼Œå¯¼è‡´è¾“å…¥ä¿¡å·æœ‰é¢å¤–2ä¸ªæ—¶é’Ÿçš„å»¶è¿Ÿï¼Œè€ƒè™‘åˆ°ä¿¡å·é‡‡æ ·æ—¶é—´ï¼Œè¾“å…¥IOå¯èƒ½å­˜åœ¨3ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚å¦‚æœIOè¾“å…¥ä¿¡å·çš„å»¶æ—¶è¶…è¿‡SWDçš„åŠä¸ªå‘¨æœŸï¼Œè¿™å°±ä¼šå¯¼è‡´SWDä¿¡å·è¯»å–æ—¶æ— æ³•å¾—åˆ°å‡†ç¡®çš„å€¼ã€‚å½“ç³»ç»Ÿæ—¶é’Ÿä¸º150MHzæ—¶ï¼Œåˆ™å…è®¸çš„SWDæœ€å¤§æ—¶é’Ÿä¸º25MHzã€‚å®é™…æµ‹è¯•å‘ç°å¯å·¥ä½œåˆ°21.54MHzï¼Œç»§ç»­å¢å¤§æ—¶é’Ÿå°†å¯¼è‡´é€šè®¯é”™è¯¯ã€‚ä¸ºäº†é™ä½ä¿¡å·è¾“å…¥å»¶æ—¶ï¼ŒPIOå…è®¸å…³é—­è¾“å…¥åŒæ­¥ç³»ç»Ÿã€‚è¾“å…¥åŒæ­¥ä¸»è¦æ˜¯ä¼˜åŒ–å¼‚æ­¥é€šè®¯æ—¶ä½¿ç”¨çš„ã€‚æˆ‘ä»¬è¿™é‡Œæœ‰ç‹¬ç«‹çš„æ—¶é’Ÿä¿¡å·ï¼Œæ‰€ä»¥å¯ä»¥å…³é—­è¾“å…¥åŒæ­¥ã€‚å®é™…æµ‹è¯•å‘ç°å…³é—­è¾“å…¥åŒæ­¥åå¯ä»¥å°†SWDçš„æ—¶é’Ÿé¢‘ç‡æé«˜åˆ°30MHzã€‚æœ€è¿‘è¿˜å°†SDçš„é©±åŠ¨æ–¹å¼ä»SPIæ”¹ä¸ºSDIOæ¨¡å¼ï¼ŒSDIOé€šè¿‡PIOå®ç°ï¼Œè¯»å†™é€Ÿåº¦æœ‰äº†å¤§å¹…åº¦çš„æå‡ã€‚åœ¨æµ‹è¯•å¼€å‘æ¿ä¸Šï¼Œåœ¨15MHzæ—¶é’Ÿçš„SDIOæ¥å£ä¸‹ï¼ŒSDçš„è¯»å†™é€Ÿåº¦å¯è¾¾6.5MB/sï¼Œç›¸æ¯”äºSPIæ¨¡å¼çš„è¯»å†™é€Ÿåº¦æå‡äº†4å€ã€‚ä¼˜åŒ–PCBçº¿è·¯åå¹¶æé«˜SDIOæ—¶é’Ÿé€Ÿç‡å¯è¿›ä¸€æ­¥æé«˜è¯»å†™é€Ÿåº¦ã€‚\n3.å¤–å£³éƒ¨åˆ†æˆ‘ä½¿ç”¨UGä¸ºæ•´ä¸ªè®¾å¤‡è®¾è®¡äº†ä¸€ä¸ªå¤–å£³ï¼Œå¥½åƒå¾ˆé•¿ä¸€æ®µæ—¶é—´æ²¡ç”¨UGå»ºæ¨¡ï¼Œæ„Ÿè§‰ä¸æ˜¯å¾ˆç†Ÿç»ƒäº†ğŸ˜…ã€‚\n\n\n\n\n\n\n\n\næœ¬æ¬¡è®¾è®¡çš„PCBå’Œå¤–å£³éƒ½æ˜¯åœ¨å˜‰ç«‹åˆ›åˆ¶ä½œçš„ï¼Œ3Dæ‰“å°çš„å¤–å£³è¿˜æ¯”è¾ƒä¾¿å®œï¼ŒåŸè®¡åˆ’ä½¿ç”¨CNCåšä¸€ä¸ªé‡‘å±çš„å¤–å£³ï¼Œä¸è¿‡çœ‹äº†ä»·æ ¼ï¼Œè¿˜æ˜¯æ”¾å¼ƒäº†ã€‚3Dæ‰“å°åªè¦5å—é’±ï¼ŒCNCåº”è¯¥ä¸ä½äº300å…ƒï¼Œä»·æ ¼åŠé€€ï¼Œå¤–å£³ä¸Šçš„ç»“æ„ç‰¹å¾åŸºæœ¬ä¸Šéƒ½æ˜¯ä¸ºäº†æ–¹ä¾¿CNCåŠ å·¥è€Œè®¾è®¡çš„ã€‚\nåŠŸèƒ½å±•ç¤ºåŸæœ¬æ‰“ç®—æ‹ä¸ªè§†é¢‘æ¥å±•ç¤ºä¸€ä¸‹è¿™ä¸ªè®¾å¤‡çš„åŠŸèƒ½ï¼Œåé¢æ„Ÿè§‰æ‹ä¸å¥½å°±ç®—äº†ã€‚æˆ‘åœ¨è®¾å¤‡å†…åšäº†ä¸€ä¸ªæˆªå›¾åŠŸèƒ½ï¼Œå°±æˆªå–ä¸€äº›æ“ä½œç•Œé¢è¿›è¡Œå±•ç¤ºå§ã€‚\n\n\n    \n        1.ä¸»ç•Œé¢\n        2.ä¸€ä¸ªåˆ—è¡¨å¼çš„æ–‡ä»¶ç®¡ç†å™¨\n        3.ä¸²å£æ¥æ”¶ç•Œé¢\n        4.è®¾ç½®ç•Œé¢\n    \n    \n        5.å›ºä»¶ä¸‹è½½è¿‡ç¨‹\n        6.ä¸‹è½½å®Œæˆç•Œé¢ 1MHzæ—¶é’Ÿ\n        7.ä¸‹è½½å®Œæˆç•Œé¢ 20MHzæ—¶é’Ÿ\n        8.æ·»åŠ äº†ä¸€ä¸ªå°æ¸¸æˆğŸ˜„\n    \n\n\n\nä¸‹è½½ä¸€ä¸ª92kå­—èŠ‚çš„å›ºä»¶ï¼Œé™¤å»æ“¦é™¤æ—¶é—´ï¼Œä¸‹è½½æ—¶é—´åªæœ‰388msï¼Œé€Ÿåº¦éå¸¸å—ã€‚\nå†æ¥çœ‹çœ‹è®¾å¤‡è¿è¡Œèµ·æ¥åMCUçš„çŠ¶æ€ï¼š\nCPU freq:150MHzStat Period: 3000000usID   Name         CPU State Priority  Stack       MSP   Static SFREE  SC       DelayTime 1 DAP           0.00%  S      3    0x2002b7d0 0x2002bb58  D   224    0 2 TUD           1.11%  B      2    0x2002c6a0 0x2002ca30  D   182    3001      1 3 UART          0.30%  B      3    0x2002cb30 0x2002cea8  D   210    600       2 4 BMP           0.09%  X      3    0x2002cfc0 0x2002dc98  D   767    30 5 IDLE0        98.58%  R      0    0x2002e050 0x2002e3d8  D   212    2993 6 IDLE1        98.55%  X      0    0x2002e4e0 0x2002e888  D   228    2992 7 Tmr Svc       0.00%  B     31    0x2002ea70 0x2002f9e0  D   986    0         -1 8 GUI           0.77%  B      1    0x200301a8 0x200310b8  D   326    156       5Task scheduler CPU percent -- 0.57%MEM: 23304/153600 (15%)\n\næ­£å¸¸ç©ºé—²çŠ¶æ€ä¸‹ï¼ŒCPUçš„å ç”¨éƒ½æ¯”è¾ƒä½ï¼ŒUSBåœ¨ä¼ è¾“æ•°æ®æ—¶ä¼šå ç”¨ä¸€éƒ¨åˆ†CPUã€‚ç¬¬ä¸€æ¬¡ä½¿ç”¨FreeRTOSçš„åŒæ ¸ç‰¹æ€§ï¼Œä¸¤ä¸ªæ ¸å¿ƒçš„è°ƒåº¦è¿˜æ˜¯æ¯”è¾ƒåˆç†çš„ï¼Œå³ä½¿GUIçº¿ç¨‹çš„CPUè¾¾åˆ°90%ä»¥ä¸Šåï¼Œä¸¤ä¸ªç©ºé—²çº¿ç¨‹çš„CPUå æ¯”éƒ½èƒ½å¤Ÿåšåˆ°å‡åŒ€åˆ†é…ã€‚è®¾å¤‡åŠŸè€—ä¸åˆ°0.2Wï¼Œç‹¬ç«‹å·¥ä½œä¹Ÿèƒ½æœ‰è¾ƒé•¿çš„ç»­èˆªæ—¶é—´ã€‚\næœ€åæ¥çœ‹çœ‹ç»„è£…å¥½çš„æ•ˆæœï¼š\n\næœ€åè¿˜éœ€è¦åœ¨ä¸Šé¢ç›–ä¸€å—äºšå…‹åŠ›çš„é¢æ¿ï¼Œè¿™æ ·å°±èƒ½å°†å››ä¸ªèºä¸éšè—æ‰ï¼Œæ•´ä½“å¤–è§‚æ•ˆæœå°±ä¼šå¥½å¾ˆå¤šäº†ã€‚\n"},{"title":"é”ç›¸ç¯(PLL)åŸºæœ¬åŸç†","url":"/2024/03/03/%E9%94%81%E7%9B%B8%E7%8E%AF(PLL)%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/","content":"\næœ¬æ–‡è½¬è½½è‡ªã€Šæ¨¡æ‹Ÿå¯¹è¯ã€‹å·52ï¼Œæ–‡ç« åŸä½œè€…æ˜¯Ian Collinsï¼Œã€Šæ¨¡æ‹Ÿå¯¹è¯ã€‹æ˜¯äºšå¾·è¯ºåŠå¯¼ä½“çš„ä¸€ä»½æŠ€æœ¯æœŸåˆŠï¼Œä¸“æ³¨äºç”µå­æ¨¡æ‹ŸæŠ€æœ¯çš„æœ€æ–°è¿›å±•å’Œåº”ç”¨ã€‚åŸä½œè€…å’Œäºšå¾·è¯ºåŠå¯¼ä½“å¯¹æœ¬æ–‡ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚æœ¬æ–‡ä¸é‡‡ç”¨ BY-NC-SA è®¸å¯åè®®ã€‚PLLè¢«å¹¿æ³›åº”ç”¨äºåµŒå…¥å¼ç³»ç»Ÿå¼€å‘ä¸­çš„æ—¶é’ŸåŒæ­¥å’Œé¢‘ç‡åˆæˆï¼Œæœ¬æ–‡å¯ä»¥å¸®åŠ©åµŒå…¥å¼è½¯ä»¶å¼€å‘å·¥ç¨‹å¸ˆç†è§£PLLçš„åŸºæœ¬å·¥ä½œåŸç†ã€‚\n\nIan Collins â€œAnalogDialogueâ€ Volume 52, July 2018\næ‘˜è¦ï¼šé”ç›¸ç¯(PLL)ç”µè·¯å­˜åœ¨äºå„ç§é«˜é¢‘åº”ç”¨ä¸­ï¼Œä»ç®€å•çš„æ—¶é’Ÿå‡€åŒ–ç”µè·¯åˆ°ç”¨äºé«˜æ€§èƒ½æ— çº¿ç”µé€šä¿¡é“¾è·¯çš„æœ¬æŒ¯(LO)ï¼Œä»¥åŠçŸ¢é‡ç½‘ç»œåˆ†æä»ª(VNA)ä¸­çš„è¶…å¿«å¼€å…³é¢‘ç‡åˆæˆå™¨ã€‚æœ¬æ–‡å°†å‚è€ƒä¸Šè¿°å„ç§åº”ç”¨æ¥ä»‹ç»PLLç”µè·¯çš„ä¸€äº›æ„å»ºæ¨¡å—ï¼Œä»¥æŒ‡å¯¼å™¨ä»¶é€‰æ‹©å’Œæ¯ç§ä¸åŒåº”ç”¨å†…éƒ¨çš„æƒè¡¡è€ƒè™‘ï¼Œè¿™å¯¹æ–°æ‰‹å’ŒPLLä¸“å®¶å‡æœ‰å¸®åŠ©ã€‚æœ¬æ–‡å‚è€ƒADIå…¬å¸çš„ADF4xxxå’ŒHMCxxxç³»åˆ—PLLå’Œå‹æ§æŒ¯è¡å™¨(VCO)ï¼Œå¹¶ä½¿ç”¨ADIsimPLLï¼ˆADIå…¬å¸å†…éƒ¨PLLç”µè·¯ä»¿çœŸå™¨ï¼‰æ¥æ¼”ç¤ºä¸åŒç”µè·¯æ€§èƒ½å‚æ•°ã€‚\nåŸºæœ¬é…ç½®ï¼šæ—¶é’Ÿå‡€åŒ–ç”µè·¯é”ç›¸ç¯çš„æœ€åŸºæœ¬é…ç½®æ˜¯å°†å‚è€ƒä¿¡å·(FREF)çš„ç›¸ä½ä¸å¯è°ƒåé¦ˆä¿¡å·(RFIN)F0çš„ç›¸ä½è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚å›¾1æ‰€ç¤ºã€‚å›¾2ä¸­æœ‰ä¸€ä¸ªåœ¨é¢‘åŸŸä¸­å·¥ä½œçš„è´Ÿåé¦ˆæ§åˆ¶ç¯è·¯ã€‚å½“æ¯”è¾ƒç»“æœå¤„äºç¨³æ€ï¼Œå³è¾“å‡ºé¢‘ç‡å’Œç›¸ä½ä¸è¯¯å·®æ£€æµ‹å™¨çš„è¾“å…¥é¢‘ç‡å’Œç›¸ä½åŒ¹é…æ—¶ï¼Œæˆ‘ä»¬è¯´PLLè¢«é”å®šã€‚å°±æœ¬æ–‡è€Œè¨€ï¼Œæˆ‘ä»¬ä»…è€ƒè™‘ADIå…¬å¸ADF4xxxç³»åˆ—PLLæ‰€å®ç°çš„ç»å…¸æ•°å­—PLLæ¶æ„ã€‚\nè¯¥ç”µè·¯çš„ç¬¬ä¸€ä¸ªåŸºæœ¬å…ƒä»¶æ˜¯é‰´é¢‘é‰´ç›¸å™¨(PFD)ã€‚PFDå°†è¾“å…¥åˆ°REFINçš„é¢‘ç‡å’Œç›¸ä½ä¸åé¦ˆåˆ°RFINçš„é¢‘ç‡å’Œç›¸ä½è¿›è¡Œæ¯”è¾ƒã€‚ADF4002æ˜¯ä¸€æ¬¾å¯é…ç½®ä¸ºç‹¬ç«‹PFDï¼ˆåé¦ˆåˆ†é¢‘å™¨N&#x3D;1ï¼‰çš„PLLã€‚å› æ­¤ï¼Œå®ƒå¯ä»¥ä¸é«˜è´¨é‡å‹æ§æ™¶ä½“æŒ¯è¡å™¨(VCXO)å’Œçª„ä½é€šæ»¤æ³¢å™¨ä¸€èµ·ä½¿ç”¨ï¼Œä»¥å‡€åŒ–é«˜å™ªå£°REFINæ—¶é’Ÿã€‚\n\n\nå›¾1. PLLåŸºæœ¬é…ç½®\nå›¾2. PLLåŸºæœ¬é…ç½®\n\n\né‰´é¢‘é‰´ç›¸å™¨\n\nå›¾3. é‰´é¢‘é‰´ç›¸å™¨\n\n\nå›¾3ä¸­çš„é‰´é¢‘é‰´ç›¸å™¨å°†+INç«¯çš„FREFè¾“å…¥ä¸å’Œ-INç«¯çš„åé¦ˆä¿¡å·è¿›è¡Œæ¯”è¾ƒã€‚å®ƒä½¿ç”¨ä¸¤ä¸ªDå‹è§¦å‘å™¨å’Œä¸€ä¸ªå»¶è¿Ÿå…ƒä»¶ã€‚ä¸€è·¯Qè¾“å‡ºä½¿èƒ½æ­£ç”µæµæºï¼Œå¦ä¸€è·¯Qè¾“å‡ºä½¿èƒ½è´Ÿç”µæµæºã€‚è¿™äº›ç”µæµæºå°±æ˜¯æ‰€è°“ç”µè·æ³µã€‚æœ‰å…³PFDæ“ä½œçš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…â€ç”¨äºé«˜é¢‘æ¥æ”¶å™¨å’Œå‘å°„å™¨çš„é”ç›¸ç¯â€œã€‚\nä½¿ç”¨è¿™ç§æ¶æ„ï¼Œä¸‹é¢+INç«¯çš„è¾“å…¥é¢‘ç‡é«˜äº-INç«¯ï¼ˆå›¾4ï¼‰ï¼Œç”µè·æ³µè¾“å‡ºä¼šæ¨é«˜ç”µæµï¼Œå…¶åœ¨PLLä½é€šæ»¤æ³¢å™¨ä¸­ç§¯åˆ†åï¼Œä¼šä½¿VCOè°ƒè°ç”µå‹ä¸Šå‡ã€‚è¿™æ ·ï¼Œ-INé¢‘ç‡å°†éšç€VCOé¢‘ç‡çš„æé«˜è€Œæé«˜ï¼Œä¸¤ä¸ªPFDè¾“å…¥æœ€ç»ˆä¼šæ”¶æ•›æˆ–é”å®šåˆ°ç›¸åŒé¢‘ç‡ï¼ˆå›¾5ï¼‰ã€‚å¦‚æœ-INé¢‘ç‡é«˜äº+INé¢‘ç‡ï¼Œåˆ™å‘ç”Ÿç›¸åçš„æƒ…å†µã€‚\n\n\nå›¾4. PFDé”™ç›¸å’Œé¢‘ç‡å¤±é”\nå›¾5. é‰´é¢‘é‰´ç›¸å™¨ã€é¢‘ç‡å’Œé”ç›¸\n\n\nå›åˆ°åŸå…ˆéœ€è¦å‡€åŒ–çš„é«˜å™ªå£°æ—¶é’Ÿä¾‹å­ï¼Œæ—¶é’Ÿã€è‡ªç”±è¿è¡ŒVCXOå’Œé—­ç¯PLLçš„ç›¸ä½å™ªå£°æ›²çº¿å¯ä»¥åœ¨ADIsimPLLä¸­å»ºæ¨¡ã€‚\n\n\nå›¾6. å‚è€ƒå™ªå£°\nå›¾7. è‡ªç”±è¿è¡ŒVCXO\nå›¾8. æ€»PLLå™ªå£°\n\n\nä»æ‰€ç¤ºçš„ADIsimPLLæ›²çº¿ä¸­å¯ä»¥çœ‹å‡ºï¼ŒREFINçš„é«˜ç›¸ä½å™ªå£°ï¼ˆå›¾6ï¼‰ç”±ä½é€šæ»¤æ³¢å™¨æ»¤é™¤ã€‚ç”±PLLçš„å‚è€ƒå’ŒPFDç”µè·¯è´¡çŒ®çš„æ‰€æœ‰å¸¦å†…å™ªå£°éƒ½è¢«ä½é€šæ»¤æ³¢å™¨æ»¤é™¤ï¼Œåªåœ¨ç¯è·¯å¸¦å®½å¤–ï¼ˆå›¾8ï¼‰ç•™ä¸‹ä½å¾—å¤šçš„VCXOå™ªå£°ï¼ˆå›¾7ï¼‰ã€‚å½“è¾“å‡ºé¢‘ç‡ç­‰äºè¾“å…¥é¢‘ç‡æ—¶ï¼ŒPLLé…ç½®æœ€ç®€å•ã€‚è¿™ç§PLLç§°ä¸ºæ—¶é’Ÿå‡€åŒ–PLLã€‚å¯¹äºæ­¤ç±»æ—¶é’Ÿå‡€åŒ–åº”ç”¨ï¼Œå»ºè®®ä½¿ç”¨çª„å¸¦å®½(&lt;1kHz)ä½é€šæ»¤æ³¢å™¨ã€‚\né«˜é¢‘æ•´æ•°Nåˆ†é¢‘æ¶æ„ä¸ºäº†äº§ç”Ÿä¸€ç³»åˆ—æ›´é«˜é¢‘ç‡ï¼Œåº”ä½¿ç”¨VCOï¼Œå…¶è°ƒè°èŒƒå›´æ¯”VCXOæ›´å®½ã€‚è¿™å¸¸ç”¨äºè·³é¢‘æˆ–æ‰©é¢‘è·³é¢‘(FHSS)åº”ç”¨ä¸­ã€‚åœ¨è¿™ç§PLLä¸­ï¼Œè¾“å‡ºæ˜¯å‚è€ƒé¢‘ç‡çš„å¾ˆå¤šå€ã€‚å‹æ§æŒ¯è¡å™¨å«æœ‰å¯å˜è°ƒè°å…ƒä»¶ï¼Œä¾‹å¦‚å˜å®¹äºŒæç®¡ï¼Œå…¶ç”µå®¹éšè¾“å…¥ç”µå‹è€Œæ”¹å˜ï¼Œå½¢æˆä¸€ä¸ªå¯è°ƒè°æŒ¯ç”µè·¯ï¼Œä»è€Œå¯ä»¥äº§ç”Ÿä¸€ç³»åˆ—é¢‘ç‡ï¼ˆå›¾9ï¼‰ã€‚PLLå¯ä»¥è¢«è®¤ä¸ºæ˜¯è¯¥VCOçš„æ§åˆ¶ç³»ç»Ÿã€‚\nåé¦ˆåˆ†é¢‘å™¨ç”¨äºå°†VCOé¢‘ç‡åˆ†é¢‘ä¸ºPFDé¢‘ç‡ï¼Œä»è€Œå…è®¸PLLç”ŸæˆPFDé¢‘ç‡å€æ•°çš„è¾“å‡ºé¢‘ç‡ã€‚åˆ†é¢‘å™¨ä¹Ÿå¯ä»¥ç”¨åœ¨å‚è€ƒè·¯å¾„ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨æ¯”PFDé¢‘ç‡æ›´é«˜çš„å‚è€ƒé¢‘ç‡ã€‚ADIå…¬å¸çš„ADF4108å°±æ˜¯è¿™æ ·çš„PLLã€‚PLLè®¡æ•°å™¨æ˜¯ç”µè·¯ä¸­è¦è€ƒè™‘çš„ç¬¬äºŒä¸ªåŸºæœ¬å…ƒä»¶ã€‚\n\n\nå›¾9. å‹æ§æŒ¯è¡å™¨\n\n\nPLLçš„å…³é”®æ€§èƒ½å‚æ•°æ˜¯ç›¸ä½å™ªå£°ã€é¢‘ç‡åˆæˆè¿‡ç¨‹ä¸­çš„å¤šä½™å‰¯äº§ç‰©æˆ–æ‚æ•£é¢‘ç‡ï¼ˆç®€ç§°æ‚æ•£ï¼‰ã€‚å¯¹äºæ•´æ•°N PLLåˆ†é¢‘ï¼Œæ‚æ•£é¢‘ç‡ç”±PFDé¢‘ç‡äº§ç”Ÿã€‚æ¥è‡ªç”µè·æ³µçš„æ¼ç”µæµä¼šè°ƒåˆ¶VCOçš„è°ƒè°ç«¯å£ã€‚ä½é€šæ»¤æ³¢å™¨å¯å‡è½»è¿™ç§å½±å“ï¼Œè€Œä¸”å¸¦å®½è¶Šçª„ï¼Œå¯¹æ‚æ•£é¢‘ç‡çš„æ»¤æ³¢è¶Šå¼ºã€‚ç†æƒ³å•éŸ³ä¿¡å·æ²¡æœ‰å™ªå£°æˆ–é¢å¤–æ‚æ•£é¢‘ç‡ï¼ˆå›¾10ï¼‰ï¼Œä½†åœ¨å®é™…åº”ç”¨ä¸­ï¼Œç›¸ä½å™ªå£°åƒè£™æ‘†ä¸€æ ·å‡ºç°åœ¨è½½æ³¢è¾¹ç¼˜ï¼Œå¦‚å›¾11æ‰€ç¤ºã€‚å•è¾¹å¸¦ç›¸ä½å™ªå£°æ˜¯æŒ‡åœ¨è·ç¦»è½½æ³¢çš„æŒ‡å®šé¢‘ç‡åç§»å¤„ï¼Œ1Hzå¸¦å®½å†…ç›¸å¯¹äºè½½æ³¢çš„å™ªå£°åŠŸç‡ã€‚\n\n\nå›¾10. ç†æƒ³LOé¢‘è°±\nå›¾11. å•è¾¹å¸¦ç›¸ä½å™ªå£°\n\n\næ•´æ•°Nå’Œå°æ•°Nåˆ†é¢‘å™¨åœ¨çª„å¸¦åº”ç”¨ä¸­ï¼Œé€šé“é—´éš”å¾ˆçª„ï¼ˆé€šå¸¸&lt;5MHzï¼‰ï¼Œåé¦ˆè®¡æ•°å™¨Nå¾ˆé«˜ã€‚é€šè¿‡ä½¿ç”¨åŒæ¨¡P&#x2F;P + 1é¢„åˆ†é¢‘å™¨ï¼Œå¦‚å›¾12æ‰€ç¤ºï¼Œå¯ä»¥åˆ©ç”¨ä¸€ä¸ªå°ç”µè·¯è·å¾—é«˜Nå€¼ï¼Œå¹¶ä¸”Nå€¼å¯ä»¥åˆ©ç”¨å…¬å¼N &#x3D; PB + Aæ¥è®¡ç®—ï¼›ä»¥8&#x2F;9é¢„åˆ†é¢‘å™¨å’Œ90çš„Nå€¼ä¸ºä¾‹ï¼Œè®¡ç®—å¯å¾—Bå€¼ä¸º11ï¼ŒAå€¼ä¸º2ã€‚å¯¹äºAæˆ–2ä¸ªå‘¨æœŸï¼ŒåŒæ¨¡é¢„åˆ†é¢‘å™¨å°†è¿›è¡Œ9åˆ†é¢‘ã€‚å¯¹äºå‰©ä½™çš„(B-A)æˆ–9ä¸ªå‘¨æœŸï¼Œå®ƒå°†è¿›è¡Œ8åˆ†é¢‘ï¼Œå¦‚è¡¨1æ‰€ç¤ºã€‚é¢„åˆ†é¢‘å™¨ä¸€èˆ¬åˆ©ç”¨è¾ƒé«˜é¢‘ç‡ç”µè·¯æŠ€æœ¯è®¾è®¡ï¼Œä¾‹å¦‚åŒææ€§å°„æè€¦åˆé€»è¾‘(ECL)ç”µè·¯ï¼Œè€ŒAå’ŒBè®¡æ•°å™¨å¯ä»¥æ¥å—è¿™ç§è¾ƒä½é¢‘ç‡çš„é¢„åˆ†é¢‘å™¨è¾“å‡ºï¼Œå®ƒä»¬å¯ä»¥åˆ©ç”¨ä½é€ŸCMOSç”µè·¯åˆ¶é€ ï¼Œä»¥å‡å°‘ç”µè·¯é¢ç§¯å’ŒåŠŸè€—ã€‚åƒADF4002è¿™æ ·çš„ä½é¢‘å‡€åŒ–PLLçœå»äº†é¢„åˆ†é¢‘å™¨ã€‚\n\n\nå›¾12. å…·æœ‰åŒæ¨¡Nè®¡æ•°å™¨çš„PLL\n\n\nè¡¨1. åŒæ¨¡é¢„åˆ†é¢‘å™¨æ“ä½œ\n\n\n\nN Value\nP&#x2F;P + 1\nB Value\nA Value\n\n\n\n90\n9\n11\n2\n\n\n81\n9\n10\n1\n\n\n72\n8\n9\n0\n\n\n64\n8\n8\n0\n\n\n56\n8\n7\n0\n\n\n48\n8\n6\n0\n\n\n40\n8\n5\n0\n\n\n32\n8\n4\n0\n\n\n24\n8\n3\n0\n\n\n16\n8\n2\n0\n\n\n8\n8\n1\n0\n\n\n0\n8\n0\n0\n\n\nå¸¦å†…ï¼ˆPLLç¯è·¯æ»¤æ³¢å™¨å¸¦å®½å†…ï¼‰ç›¸ä½å™ªå£°å—Nå€¼ç›´æ¥å½±å“ï¼Œå¸¦å†…å™ªå£°å¢å¹…ä¸º20log(N)ã€‚å› æ­¤ï¼Œå¯¹äºNå€¼å¾ˆé«˜çš„çª„å¸¦åº”ç”¨ï¼Œå¸¦å†…å™ªå£°ä¸»è¦ç”±é«˜Nå€¼å†³å®šã€‚åˆ©ç”¨å°æ•°Nåˆ†é¢‘åˆæˆå™¨ï¼ˆä¾‹å¦‚ADF4159æˆ–HMC704ï¼‰ï¼Œå¯ä»¥å®ç°Nå€¼ä½å¾—å¤šä½†ä»æœ‰ç²¾ç»†åˆ†è¾¨ç‡çš„ç³»ç»Ÿã€‚è¿™æ ·ä¸€æ¥ï¼Œå¸¦å†…ç›¸ä½å™ªå£°å¯ä»¥å¤§å¤§é™ä½ã€‚å›¾13è‡³å›¾16è¯´æ˜äº†å…¶å®ç°åŸç†ã€‚åœ¨è¿™äº›ç¤ºä¾‹ä¸­ï¼Œä½¿ç”¨ä¸¤ä¸ªPLLæ¥ç”Ÿæˆé€‚åˆäº5Gç³»ç»Ÿæœ¬æŒ¯(LO)çš„7.4GHzè‡³7.6GHzé¢‘ç‡ï¼Œé€šé“åˆ†è¾¨ç‡ä¸º1MHzã€‚ADF4108ä»¥æ•´æ•°Nåˆ†é¢‘é…ç½®ä½¿ç”¨ï¼ˆå›¾13ï¼‰ï¼ŒHMC704ä»¥å°æ•°Nåˆ†é¢‘é…ç½®ä½¿ç”¨ã€‚HMC704ï¼ˆå›¾14ï¼‰å¯ä»¥ä½¿ç”¨50MHz PFDé¢‘ç‡ï¼Œè¿™ä¼šé™ä½Nå€¼ï¼Œä»è€Œé™ä½å¸¦å†…å™ªå£°ï¼ŒåŒæ—¶ä»ç„¶æ”¯æŒ1MHzï¼ˆæˆ–æ›´å°ï¼‰çš„é¢‘ç‡æ­¥é•¿â€”â€”å¯æ³¨æ„åˆ°æ€§èƒ½æ”¹å–„15dBï¼ˆåœ¨8kHzåç§»é¢‘ç‡å¤„ï¼‰ï¼ˆå›¾15ä¸å›¾16å¯¹æ¯”ï¼‰ã€‚ä½†æ˜¯ï¼ŒADF4108å¿…é¡»ä½¿ç”¨1MHz PFDæ‰èƒ½å®ç°ç›¸åŒçš„åˆ†è¾¨ç‡ã€‚\nå¯¹äºå°æ•°Nåˆ†é¢‘PLLåŠ¡å¿…è¦å°å¿ƒï¼Œç¡®ä¿æ‚æ•£ä¸ä¼šé™ä½ç³»ç»Ÿæ€§èƒ½ã€‚å¯¹äºHMC704ä¹‹ç±»çš„PLLï¼Œæ•´æ•°è¾¹ç•Œæ‚æ•£ï¼ˆå½“Nå€¼çš„å°æ•°éƒ¨åˆ†æ¥è¿‘0æˆ–1æ—¶äº§ç”Ÿï¼Œä¾‹å¦‚147.98æˆ–148.02éå¸¸æ¥è¿‘æ•´æ•°å€¼148ï¼‰æœ€éœ€è¦å…³æ³¨ã€‚è§£å†³æªæ–½æ˜¯å¯¹VCOè¾“å‡ºåˆ°RFè¾“å…¥è¿›è¡Œç¼“å†²ï¼Œä»¥åŠ&#x2F;æˆ–è€…åšç²¾å¿ƒçš„è§„åˆ’é¢‘ç‡ï¼Œæ”¹å˜REFINä»¥é¿å…æ˜“å‘ç”Ÿé—®é¢˜çš„é¢‘ç‡ã€‚\n\n\nå›¾13. æ•´æ•°Nåˆ†é¢‘PLL\nå›¾14. å°æ•°Nåˆ†é¢‘PLL\nå›¾15. æ•´æ•°Nåˆ†é¢‘PLLå¸¦å†…ç›¸ä½å™ªå£°\nå›¾16. å°æ•°Nåˆ†é¢‘PLLå¸¦å†…ç›¸ä½å™ªå£°\n\n\nå¯¹äºå¤§å¤šæ•°PLLï¼Œå¸¦å†…å™ªå£°é«˜åº¦ä¾èµ–äºNå€¼ï¼Œä¹Ÿå–å†³äºPFDé¢‘ç‡ã€‚ä»å¸¦å†…ç›¸ä½å™ªå£°æµ‹é‡ç»“æœçš„å¹³å¦éƒ¨åˆ†å‡å»20log(N)å’Œ10log(FPFD)å¾—åˆ°å“è´¨å› æ•°(FOM)ã€‚é€‰æ‹©PLLçš„å¸¸ç”¨æŒ‡æ ‡æ˜¯æ¯”è¾ƒFOMã€‚å½±å“å¸¦å†…å™ªå£°çš„å¦ä¸€ä¸ªå› ç´ æ˜¯1&#x2F;få™ªå£°ï¼Œå®ƒå–å†³äºå™¨ä»¶çš„è¾“å‡ºé¢‘ç‡ã€‚FOMè´¡çŒ®å’Œ1&#x2F;få™ªå£°ï¼Œå†åŠ ä¸Šå‚è€ƒå™ªå£°ï¼Œå†³å®šäº†PLLç³»ç»Ÿçš„å¸¦å†…å™ªå£°ã€‚\nç”¨äº5Gé€šä¿¡çš„çª„å¸¦LOå¯¹äºé€šä¿¡ç³»ç»Ÿï¼Œä»PLLè§’åº¦æ¥çœ‹ï¼Œä¸»è¦è§„æ ¼æœ‰è¯¯å·®çŸ¢é‡å¹…åº¦(EVM)å’ŒVCOé˜»å¡ã€‚EVMåœ¨èŒƒå›´ä¸Šä¸ç§¯åˆ†ç›¸ä½å™ªå£°ç±»ä¼¼ï¼Œè€ƒè™‘çš„æ˜¯ä¸€ç³»åˆ—åç§»ä¸Šçš„å™ªå£°è´¡çŒ®ã€‚å¯¹äºå‰é¢åˆ—å‡ºçš„5Gç³»ç»Ÿï¼Œç§¯åˆ†é™éå¸¸å®½ï¼Œä»1kHzå¼€å§‹æŒç»­åˆ°100 MHzã€‚EVMå¯è¢«è®¤ä¸ºæ˜¯ç†æƒ³è°ƒåˆ¶ä¿¡å·ç›¸å¯¹äºç†æƒ³ç‚¹çš„æ€§èƒ½é™å¹…ç™¾åˆ†æ¯”ï¼ˆå›¾17ï¼‰ã€‚ç±»ä¼¼åœ°ï¼Œç§¯åˆ†ç›¸ä½å™ªå£°å°†ç›¸å¯¹äºè½½æ³¢çš„ä¸åŒåç§»å¤„çš„å™ªå£°åŠŸç‡è¿›è¡Œç§¯åˆ†ï¼Œè¡¨ç¤ºé€šè¿‡é…ç½®å¯ä»¥è®¡ç®—EVMã€ç§¯åˆ†ç›¸ä½å™ªå£°ã€å‡æ–¹æ ¹ç›¸ä½è¯¯å·®å’ŒæŠ–åŠ¨ã€‚ç°ä»£ä¿¡å·æºåˆ†æä»ªä¹Ÿä¼šåŒ…å«è¿™äº›æ•°å€¼ï¼ˆå›¾18ï¼‰ï¼Œåªéœ€æŒ‰ä¸€ä¸‹æŒ‰é’®å³å¯å¾—åˆ°ã€‚éšç€è°ƒåˆ¶æ–¹æ¡ˆä¸­å¯†åº¦çš„å¢åŠ ï¼ŒEVMå˜å¾—éå¸¸é‡è¦ã€‚å¯¹äº16-QAMï¼Œæ ¹æ®ETSIè§„èŒƒ3GPP TS 36.104ï¼ŒEVMæœ€ä½è¦æ±‚ä¸º12.5%ã€‚å¯¹äº64-QAMï¼Œè¯¥è¦æ±‚ä¸º8%ã€‚ç„¶è€Œï¼Œç”±äºEVMåŒ…æ‹¬å„ç§å…¶ä»–éç†æƒ³å‚æ•°ï¼ˆåŠŸç‡æ”¾å¤§å™¨å¤±çœŸå’Œä¸éœ€è¦çš„æ··é¢‘äº§ç‰©å¼•èµ·ï¼‰ï¼Œå› æ­¤ç§¯åˆ†å™ªå£°é€šå¸¸æœ‰å•ç‹¬çš„å®šä¹‰ï¼ˆä»¥dBcä¸ºå•ä½ï¼‰ã€‚\n\n\nå›¾17. ç›¸ä½è¯¯å·®å¯è§†åŒ–\nå›¾18. ä¿¡å·æºåˆ†æä»ªå›¾\n\n\nVCOé˜»å¡è§„èŒƒåœ¨éœ€è¦è€ƒè™‘å¼ºå‘å°„å­˜åœ¨çš„èœ‚çªç³»ç»Ÿä¸­éå¸¸é‡è¦ã€‚å¦‚æœæ¥æ”¶å™¨ä¿¡å·å¾ˆå¼±ï¼Œå¹¶ä¸”VCOå™ªå£°å¤ªé«˜ï¼Œé‚£ä¹ˆé™„è¿‘çš„å‘å°„å™¨ä¿¡å·å¯èƒ½ä¼šå‘ä¸‹æ··é¢‘ï¼Œæ·¹æ²¡ç›®æ ‡ä¿¡å·ï¼ˆå›¾19ï¼‰ã€‚å›¾19æ¼”ç¤ºäº†å¦‚æœæ¥æ”¶å™¨VCOå™ªå£°å¾ˆé«˜ï¼Œé™„è¿‘çš„å‘å°„å™¨ï¼ˆç›¸è·800kHzï¼‰ä»¥-25dBmåŠŸç‡å‘å°„æ—¶ï¼Œå¦‚ä½•æ·¹æ²¡-101dBmçš„ç›®æ ‡ä¿¡å·ã€‚è¿™äº›è§„èŒƒæ„æˆæ— çº¿é€šä¿¡æ ‡å‡†çš„ä¸€éƒ¨åˆ†ã€‚é˜»å¡è§„èŒƒç›´æ¥å½±å“VCOçš„æ€§èƒ½è¦æ±‚ã€‚\n\n\nå›¾19. VCOå™ªå£°é˜»å¡\n\n\nå‹æ§æŒ¯è¡å™¨(VCO)æˆ‘ä»¬çš„ç”µè·¯ä¸­éœ€è¦è€ƒè™‘çš„ä¸‹ä¸€ä¸ªPLLç”µè·¯å…ƒä»¶æ˜¯å‹æ§æŒ¯è¡å™¨ã€‚å¯¹äºVCOï¼Œç›¸ä½å™ªå£°ã€é¢‘ç‡è¦†ç›–èŒƒå›´å’ŒåŠŸè€—ä¹‹é—´çš„æƒè¡¡ååˆ†é‡è¦ã€‚æŒ¯è¡å™¨çš„å“è´¨å› æ•°(Q)è¶Šé«˜ï¼ŒVCOç›¸ä½å™ªå£°è¶Šä½ã€‚ç„¶è€Œï¼Œè¾ƒé«˜Qç”µè·¯çš„é¢‘ç‡èŒƒå›´æ¯”è¾ƒçª„ã€‚æé«˜ç”µæºç”µå‹ä¹Ÿä¼šé™ä½ç›¸ä½å™ªå£°ã€‚åœ¨ADIå…¬å¸çš„VCOç³»åˆ—ä¸­ï¼ŒHMC507çš„è¦†ç›–èŒƒå›´ä¸º6650MHzè‡³7650MHzï¼Œ100kHzæ—¶çš„VCOå™ªå£°çº¦ä¸º-115dBc&#x2F;Hzã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒHMC586è¦†ç›–äº†ä»4000MHzåˆ°8000MHzçš„å…¨éƒ¨å€é¢‘ç¨‹ï¼Œä½†ç›¸ä½å™ªå£°è¾ƒé«˜ï¼Œä¸º-100dBc&#x2F;Hzã€‚ä¸ºä½¿è¿™ç§VCOçš„ç›¸ä½å™ªå£°æœ€å°ï¼Œä¸€ç§ç­–ç•¥æ˜¯æé«˜VCOè°ƒè°ç”µå‹VTUNEçš„èŒƒå›´ï¼ˆå¯è¾¾20Væˆ–æ›´é«˜ï¼‰ã€‚è¿™ä¼šå¢åŠ PLLç”µè·¯çš„å¤æ‚æ€§ï¼Œå› ä¸ºå¤§å¤šæ•°PLLç”µè·æ³µåªèƒ½è°ƒè°åˆ°5Vï¼Œæ‰€ä»¥åˆ©ç”¨ä¸€ä¸ªç”±è¿ç®—æ”¾å¤§å™¨ç»„æˆçš„æœ‰æºæ»¤æ³¢å™¨æ¥æé«˜PLLç”µè·¯çš„è°ƒè°ç”µå‹ã€‚\nå¤šé¢‘æ®µé›†æˆPLLå’ŒVCOå¦ä¸€ç§æ‰©å¤§é¢‘ç‡è¦†ç›–èŒƒå›´è€Œä¸æ¶åŒ–VCOç›¸ä½å™ªå£°æ€§èƒ½çš„ç­–ç•¥æ˜¯ä½¿ç”¨å¤šé¢‘æ®µVCOï¼Œå…¶ä¸­é‡å çš„é¢‘ç‡èŒƒå›´ç”¨äºè¦†ç›–ä¸€ä¸ªå€é¢‘ç¨‹çš„é¢‘ç‡èŒƒå›´ï¼Œè¾ƒä½é¢‘ç‡å¯ä»¥åˆ©ç”¨VCOè¾“å‡ºç«¯çš„åˆ†é¢‘å™¨äº§ç”Ÿã€‚ADF4356å°±æ˜¯è¿™ç§å™¨ä»¶ï¼Œå®ƒä½¿ç”¨å››ä¸ªä¸»VCOå†…æ ¸ï¼Œæ¯ä¸ªå†…æ ¸æœ‰256ä¸ªé‡å é¢‘ç‡èŒƒå›´ã€‚è¯¥å™¨ä»¶ä½¿ç”¨å†…éƒ¨å‚è€ƒå’Œåé¦ˆåˆ†é¢‘å™¨æ¥é€‰æ‹©åˆé€‚çš„VCOé¢‘æ®µï¼Œæ­¤è¿‡ç¨‹è¢«ç§°ä¸ºVCOé¢‘æ®µé€‰æ‹©æˆ–è‡ªåŠ¨æ ¡å‡†ã€‚\nå¤šé¢‘æ®µVCOçš„å®½è°ƒè°èŒƒå›´ä½¿å…¶é€‚ç”¨äºå®½å¸¦ä»ªå™¨ï¼Œå¯äº§ç”ŸèŒƒå›´å¹¿æ³›çš„é¢‘ç‡ã€‚æ­¤å¤–ï¼Œ39ä½å°æ•°Nåˆ†è¾¨ç‡ä½¿å…¶æˆä¸ºç²¾å¯†é¢‘ç‡åº”ç”¨çš„ç†æƒ³é€‰æ‹©ã€‚åœ¨çŸ¢é‡ç½‘ç»œåˆ†æä»ªç­‰ä»ªå™¨ä¸­ï¼Œè¶…å¿«å¼€å…³é€Ÿåº¦è‡³å…³é‡è¦ã€‚è¿™å¯ä»¥é€šè¿‡ä½¿ç”¨éå¸¸å®½çš„ä½é€šæ»¤æ³¢å™¨å¸¦å®½æ¥å®ç°ï¼Œå®ƒèƒ½éå¸¸å¿«åœ°è°ƒè°åˆ°æœ€ç»ˆé¢‘ç‡ã€‚åœ¨è¿™äº›åº”ç”¨ä¸­ï¼Œé€šè¿‡ä½¿ç”¨æŸ¥æ‰¾è¡¨ï¼ˆé’ˆå¯¹æ¯ä¸ªé¢‘ç‡ç›´æ¥å†™å…¥é¢‘ç‡å€¼ï¼‰å¯ä»¥ç»•è¿‡è‡ªåŠ¨é¢‘ç‡æ ¡å‡†ç¨‹åºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨çœŸæ­£çš„å•æ ¸å®½å¸¦VCOï¼Œå¦‚HMC733ï¼Œå…¶å¤æ‚æ€§æ›´ä½ã€‚\nå¯¹äºé”ç›¸ç¯ç”µè·¯ï¼Œä½é€šæ»¤æ³¢å™¨çš„å¸¦å®½å¯¹ç³»ç»Ÿå»ºç«‹æ—¶é—´æœ‰ç›´æ¥å½±å“ã€‚ä½é€šæ»¤æ³¢å™¨æ˜¯æˆ‘ä»¬ç”µè·¯ä¸­çš„æœ€åä¸€ä¸ªå…ƒä»¶ã€‚å¦‚æœå»ºç«‹æ—¶é—´è‡³å…³é‡è¦ï¼Œåº”å°†ç¯è·¯å¸¦å®½å¢åŠ åˆ°å…è®¸çš„æœ€å¤§å¸¦å®½ï¼Œä»¥å®ç°ç¨³å®šé”å®šå¹¶æ»¡è¶³ç›¸ä½å™ªå£°å’Œæ‚æ•£é¢‘ç‡ç›®æ ‡ã€‚é€šä¿¡é“¾è·¯ä¸­çš„çª„å¸¦è¦æ±‚æ„å‘³ç€ä½¿ç”¨HMC507æ—¶ï¼Œä¸ºä½¿ç§¯åˆ†å™ªå£°æœ€å°ï¼ˆ30kHzè‡³100MHzä¹‹é—´ï¼‰ï¼Œä½é€šæ»¤æ³¢å™¨çš„æœ€ä½³å¸¦å®½çº¦ä¸º207kHzï¼ˆå›¾20ï¼‰ã€‚è¿™ä¼šè´¡çŒ®å¤§çº¦-51dBcçš„ç§¯åˆ†å™ªå£°ï¼Œå¯åœ¨å¤§çº¦51Î¼så†…å®ç°é¢‘ç‡é”å®šï¼Œè¯¯å·®èŒƒå›´ä¸º1kHzï¼ˆå›¾22ï¼‰ã€‚\nç›¸æ¯”ä¹‹ä¸‹ï¼Œå®½å¸¦HMC586ï¼ˆè¦†ç›–4GHzè‡³8GHzï¼‰ä»¥æ›´æ¥è¿‘300kHzå¸¦å®½çš„æ›´å®½å¸¦å®½å®ç°æœ€ä½³å‡æ–¹æ ¹ç›¸ä½å™ªå£°ï¼ˆå›¾21ï¼‰ï¼Œç§¯åˆ†å™ªå£°ä¸º-44dBcã€‚ä½†æ˜¯ï¼Œå®ƒåœ¨ä¸åˆ°27Î¼sçš„æ—¶é—´å†…å®ç°ç›¸åŒç²¾åº¦çš„é¢‘ç‡é”å®šï¼ˆå›¾23ï¼‰ã€‚æ­£ç¡®çš„å™¨ä»¶é€‰æ‹©å’Œå‘¨å›´ç”µè·¯è®¾è®¡å¯¹äºå®ç°åº”ç”¨çš„æœ€ä½³ç»“æœè‡³å…³é‡è¦ã€‚\n\n\nå›¾20. ç›¸ä½å™ªå£°HMC704åŠ HMC507\nå›¾21. ç›¸ä½å™ªå£°HMC704åŠ HMC586\nå›¾22. é¢‘ç‡å»ºç«‹ï¼šHMC704åŠ HMC507\nå›¾23. HMC704åŠ HMC586\n\n\nä½æŠ–åŠ¨æ—¶é’Ÿå¯¹äºé«˜é€Ÿæ•°æ¨¡è½¬æ¢å™¨(DAC)å’Œé«˜é€Ÿæ¨¡æ•°è½¬æ¢å™¨(ADC)ï¼Œå¹²å‡€çš„ä½æŠ–åŠ¨é‡‡æ ·æ—¶é’Ÿæ˜¯å¿…ä¸å¯å°‘çš„æ„å»ºæ¨¡å—ã€‚ä¸ºä½¿å¸¦å†…å™ªå£°æœ€å°ï¼Œåº”é€‰æ‹©è¾ƒä½çš„Nå€¼ï¼›ä½†ä¸ºä½¿æ‚æ•£å™ªå£°æœ€å°ï¼Œæœ€å¥½é€‰æ‹©æ•´æ•°Nå€¼ã€‚æ—¶é’Ÿå¾€å¾€æ˜¯å›ºå®šé¢‘ç‡ï¼Œå› æ­¤å¯ä»¥é€‰æ‹©é¢‘ç‡ä»¥ç¡®ä¿REFINé¢‘ç‡æ°å¥½æ˜¯è¾“å…¥é¢‘ç‡çš„æ•´æ•°å€ã€‚è¿™æ ·å¯ä»¥ä¿è¯PLLå¸¦å†…å™ªå£°æœ€ä½ã€‚é€‰æ‹©VCOï¼ˆæ— è®ºé›†æˆä¸å¦ï¼‰æ—¶ï¼Œé¡»ç¡®ä¿å…¶å™ªå£°å¯¹åº”ç”¨è€Œè¨€è¶³å¤Ÿä½ï¼Œå°¤å…¶è¦æ³¨æ„å®½å¸¦å™ªå£°ã€‚ç„¶åéœ€è¦ç²¾å¿ƒæ”¾ç½®ä½é€šæ»¤æ³¢å™¨ï¼Œä»¥ç¡®ä¿å¸¦å†…PLLå™ªå£°ä¸VCOå™ªå£°ç›¸äº¤â€”â€”è¿™æ ·å¯ç¡®ä¿å‡æ–¹æ ¹æŠ–åŠ¨æœ€ä½ã€‚ç›¸ä½è£•åº¦ä¸º60Â°çš„ä½é€šæ»¤æ³¢å™¨å¯ç¡®ä¿æ»¤æ³¢å™¨å³°å€¼æœ€ä½ï¼Œä»è€Œè¾ƒå¤§é™åº¦åœ°å‡å°‘æŠ–åŠ¨ã€‚è¿™æ ·çš„è¯ï¼Œä½æŠ–åŠ¨æ—¶é’Ÿå°±è½åœ¨æœ¬æ–‡è®¨è®ºçš„ç¬¬ä¸€ä¸ªç”µè·¯çš„æ—¶é’Ÿå‡€åŒ–åº”ç”¨å’Œæ‰€è®¨è®ºçš„æœ€åä¸€ä¸ªç”µè·¯çš„å¿«é€Ÿå¼€å…³èƒ½åŠ›ä¹‹é—´ã€‚\nå¯¹äºæ—¶é’Ÿç”µè·¯ï¼Œæ—¶é’Ÿçš„å‡æ–¹æ ¹æŠ–åŠ¨æ˜¯å…³é”®æ€§èƒ½å‚æ•°ã€‚è¿™å¯ä»¥åˆ©ç”¨ADIsimPLLä¼°ç®—ï¼Œæˆ–ä½¿ç”¨ä¿¡å·æºåˆ†æä»ªæµ‹é‡ã€‚å¯¹äºåƒADF5356è¿™æ ·çš„é«˜æ€§èƒ½PLLå™¨ä»¶ï¼Œç›¸å¯¹è¾ƒå®½çš„ä½é€šæ»¤æ³¢å™¨å¸¦å®½(132kHz)ï¼Œé…åˆWenxelOCXOä¹‹ç±»çš„è¶…ä½REFINæºï¼Œå…è®¸ç”¨æˆ·è®¾è®¡å‡æ–¹æ ¹æŠ–åŠ¨ä½äº90fsçš„æ—¶é’Ÿï¼ˆå›¾26ï¼‰ã€‚æ“çºµPLLç¯è·¯æ»¤æ³¢å™¨å¸¦å®½(LBW)çš„ä½ç½®è¡¨æ˜ï¼Œå¦‚æœé™ä½å¤ªå¤šï¼ŒVCOå™ªå£°åœ¨åç§»è¾ƒå°æ—¶ï¼ˆå›¾24ï¼‰å°†å¼€å§‹å ä¸»å¯¼åœ°ä½ï¼Œå¸¦å†…PLLå™ªå£°å®é™…ä¸Šä¼šé™ä½ï¼Œè€Œå¦‚æœæé«˜å¤ªå¤šçš„è¯ï¼Œå¸¦å†…å™ªå£°åœ¨åç§»å¤„å ä¸»å¯¼åœ°ä½ï¼ŒVCOå™ªå£°åˆ™æ˜¾è‘—é™ä½ï¼ˆå›¾25ï¼‰ã€‚\n\n\nå›¾24. LBW &#x3D; 10 kHzï¼Œ331 fsæŠ–åŠ¨\nå›¾25. LBW &#x3D; 500 kHzï¼Œ111 fsæŠ–åŠ¨\nå›¾26. LBW &#x3D; 132 kHzï¼Œ83 fsæŠ–åŠ¨\n\n\nå‚è€ƒç”µè·¯Collins, Ian. â€œç”¨äºæ— çº¿åº”ç”¨çš„é›†æˆPLLå’ŒVCO.â€ Radio Electronics, 2010å¹´ã€‚\nCurtin, Mike and Paul Oâ€™Brien. â€œç”¨äºé«˜é¢‘æ¥æ”¶å™¨å’Œå‘å°„å™¨çš„é”ç›¸ç¯ã€‚â€ ã€Šæ¨¡æ‹Ÿå¯¹è¯ã€‹ï¼Œç¬¬33å·ï¼Œ1999å¹´ã€‚\nä½œè€…Ian Collinsæ¯•ä¸šäºçˆ±å°”å…°ç§‘å…‹å¤§å­¦ï¼Œæ‹¥æœ‰ç”µæ°”å’Œç”µå­å·¥ç¨‹å­¦ä½å¹¶ä»2000å¹´èµ·åœ¨ADIå…¬å¸çš„å°„é¢‘å’Œå¾®æ³¢éƒ¨å·¥ä½œã€‚ä»–ç›®å‰æ˜¯å¾®æ³¢é¢‘ç‡ç”Ÿæˆéƒ¨çš„åº”ç”¨ç»ç†ï¼Œä¸»è¦è´Ÿè´£é”ç›¸ç¯(PLL)å’Œå‹æ§æŒ¯è¡å™¨(VCO)äº§å“æ–¹é¢çš„å·¥ä½œã€‚éå·¥ä½œæ—¶é—´æˆ–ä¸é™ªä¼´å®¶äººæ—¶ï¼ŒIanå–œæ¬¢æ‘„å½±å’Œæˆå‰§ï¼ˆæ— è®ºæ˜¯åœ¨å°ä¸Šè¿˜æ˜¯åœ¨å°ä¸‹ï¼‰ã€é˜…è¯»ä»¥åŠå¬éŸ³ä¹ã€‚\n"},{"title":"é˜»æŠ—åŒ¹é…","url":"/2024/02/18/%E9%98%BB%E6%8A%97%E5%8C%B9%E9%85%8D/","content":"\næœ¬äººéä¸“ä¸šé¢†åŸŸå·¥ä½œè€…ï¼Œå†…å®¹éš¾å…ç‘•ç–µï¼Œæ‰€ä»¥ä»…ä¾›å‚è€ƒã€‚\n\nä»€ä¹ˆæ˜¯é˜»æŠ—åŒ¹é…ï¼Ÿé˜»æŠ—åŒ¹é…çš„æ¦‚å¿µåº”ç”¨åœ¨å„ä¸ªå·¥ç¨‹é¢†åŸŸï¼Œä½†åœ¨å°„é¢‘ç”µè·¯é¢†åŸŸï¼Œé˜»æŠ—åŒ¹é…æœ‰æ›´åŠ é‡è¦çš„æ„ä¹‰ã€‚é˜»æŠ—åŒ¹é…çš„ç›®çš„åœ¨äºå°†èƒ½é‡å®Œæ•´çš„ä»ä¸€ä¸ªç«¯å£ä¼ è¾“åˆ°å¦ä¸€ä¸ªç«¯å£ä¸Šï¼Œå½“è´Ÿè½½çš„è¾“å…¥é˜»æŠ—å’Œæºçš„è¾“å‡ºé˜»æŠ—å…±è½­ç›¸ç­‰æ—¶åˆ™è®¤ä¸ºé˜»æŠ—åŒ¹é…ã€‚å½“æºå’Œè´Ÿè½½çš„é˜»æŠ—ä¸ç›¸ç­‰æ—¶ï¼Œå¯ä»¥åœ¨å…¶ä¹‹é—´æ’å…¥ä¸€ä¸ªæ— æºç½‘ç»œè¿›è¡Œé˜»æŠ—è½¬æ¢ï¼Œä½¿å¾—æºå’Œè´Ÿè½½ä¹‹é—´è¾¾åˆ°é˜»æŠ—åŒ¹é…çš„è¦æ±‚ã€‚\nä»€ä¹ˆæ˜¯é˜»æŠ—ï¼Ÿé˜»æŠ—æ˜¯ä¸€ä¸ªè¡¨å¾ç”µè·¯ç‰¹æ€§çš„ä¸€ä¸ªé‡è¦å‚æ•°ï¼Œé€šå¸¸å®šä¹‰ä¸ºç”µè·¯åœ¨ç»™å®šé¢‘ç‡ä¸‹å¯¹äº¤æµç”µçš„æ€»é˜»æŠ—ã€‚å®ƒæ˜¯ä¸€ä¸ªçŸ¢é‡å€¼ï¼Œå®æ•°éƒ¨åˆ†å¯ä»¥ç†è§£ä¸ºä¸€èˆ¬çš„ç”µé˜»ï¼Œè™šæ•°éƒ¨åˆ†ä¸ºç”µæŠ—ï¼Œç”µæŠ—æ˜¯ç”±ç”µå®¹æˆ–ç”µæ„Ÿå¯¼è‡´çš„ã€‚è¿™é‡Œè¯´ä¸€ä¸‹ç”µå®¹å’Œç”µæ„Ÿçš„é˜»æŠ—è®¡ç®—å…¬å¼ï¼Œå¯¹äºç”µæ„Ÿæ¥è¯´ï¼š\nå¯¹äºç”µå®¹æ¥è¯´ï¼š\nç”µé˜»ã€ç”µå®¹å’Œç”µæ„Ÿä¸²å¹¶è”åçš„é˜»æŠ—å€¼è®¡ç®—æ–¹æ³•ä»ç„¶åŒåˆä¸­æ—¶å­¦ä¹ çš„ç”µé˜»ä¸²å¹¶è”è§„åˆ™ç±»ä¼¼ï¼Œåªæ˜¯å°†å®æ•°æ›¿æ¢ä¸ºäº†å¤æ•°ã€‚\nå’Œä¸²è”çš„æ€»é˜»æŠ—ä¸ºã€‚\nå’Œå¹¶è”çš„æ€»é˜»æŠ—ä¸ºï¼Œå¹¶æ»¡è¶³å…³ç³»ã€‚ä¸ºäº†æ–¹ä¾¿è¡¨è¿°å¯ä»¥è®°ä¸º\nè¯´åˆ°é˜»æŠ—å¯ä»¥é¡ºä¾¿è¯´ä¸€ä¸‹Qå€¼ï¼Œè¿™é‡Œä¸»è¦æ˜¯è¯´ç”µæ„Ÿç”µå®¹çš„Qå€¼ï¼Œä¹Ÿå°±æ˜¯å…ƒä»¶çš„å“è´¨å› æ•°ã€‚ç”±äºå®é™…çš„ç”µå®¹å’Œç”µæ„Ÿå­˜åœ¨ESRï¼Œæ‰€ä»¥å®é™…çš„å…ƒä»¶ç”µæŠ—ä¸çº¯ã€‚ä¸ºäº†è¡¨å¾å…ƒä»¶ç”µæŠ—çš„çº¯ç²¹ç¨‹åº¦ï¼Œä½¿ç”¨Qå€¼æ¥è¡¨ç¤ºï¼Œå…¶å€¼ä¸ºï¼š\nå¯¹äºæºé˜»æŠ—å’Œè´Ÿè½½é˜»æŠ—ï¼Œå…¶æ»¡è¶³åŒ¹é…çš„è¦æ±‚æ˜¯ï¼Œå³é˜»æŠ—å…±è½­ç›¸ç­‰ã€‚\nç”µæŠ—è®¡ç®—å™¨\n\n\n    é¢‘ç‡: Â  Â \n    \n        Hz\n        kHz\n        MHz\n        GHz\n    \n    ç”µæ„Ÿ: Â  Â \n    \n        nH\n        uH\n        mH\n        H\n    \n    æ„ŸæŠ—: Â   Î© \n    è®¡ç®—\n\n\n\n\n\n    é¢‘ç‡: Â  Â \n    \n        Hz\n        kHz\n        MHz\n        GHz\n    \n    ç”µå®¹: Â  Â \n    \n        pF\n        nF\n        uF\n        mF\n        F\n    \n    å®¹æŠ—: Â   Î© \n    è®¡ç®—\n\n\n\n\né˜»æŠ—å¹¶è”è®¡ç®—å™¨\n    é˜»æŠ—A: Â  Â \n    é˜»æŠ—B: Â  Â \n    å¹¶è”é˜»æŠ—: Â   Î© \n    è®¡ç®—\n\n\né˜»æŠ—åŒ¹é…çš„æ–¹æ³•å¦‚æœæºç«¯å£çš„é˜»æŠ—å’Œè´Ÿè½½çš„é˜»æŠ—ä¸ä¸€è‡´ï¼Œä¼šå¯¼è‡´èƒ½é‡æ— æ³•æœ€å¤§åŒ–çš„ä¼ è¾“ï¼Œä¸ºäº†ä½¿èƒ½é‡æœ€å¤§åŒ–çš„ä¼ è¾“ï¼Œåœ¨æºå’Œè´Ÿè½½ä¹‹é—´æ’å…¥ä¸€ä¸ªæ— è€—åŒ¹é…ç½‘ç»œæ¥ä½¿å¾—æºé˜»æŠ—å’ŒåŒ¹é…ç½‘ç»œçš„è¾“å…¥ç«¯åŒ¹é…ï¼ŒåŒ¹é…ç½‘ç»œçš„è¾“å‡ºç«¯å’Œè´Ÿè½½åŒ¹é…ï¼Œè¿™æ ·å°±é—´æ¥ä½¿å¾—æºå’Œè´Ÿè½½è¾¾æˆåŒ¹é…æ¡ä»¶ã€‚\nè¿™é‡Œçœ‹ä¸€ä¸ªä¸€èˆ¬æƒ…å†µï¼Œå°±æ˜¯å¸¸è§çš„Lå‹åŒ¹é…ç½‘ç»œï¼š\n\n\nLå‹åŒ¹é…\n\n\nå…¶ä¸­æºé˜»æŠ—ä¸ºï¼Œè´Ÿè½½é˜»æŠ—æ˜¯ï¼Œæ ¹æ®ä¸²å¹¶è”è§„åˆ™ï¼Œæ»¡è¶³åŒ¹é…çš„æ¡ä»¶ä¸ºï¼š\nå°±æ˜¯ä»è´Ÿè½½ç‚¹å¼€å§‹ï¼Œä¸²è”å…ƒä»¶å°±æ˜¯ç›¸åŠ ï¼Œå¹¶è”å…ƒä»¶å°±æ˜¯å¹¶è”è®¡ç®—ã€‚å¤æ‚çš„åŒ¹é…ç½‘ç»œä»ç„¶éµå¾ªè¯¥è§„åˆ™ã€‚\né€šå¸¸Lå‹åŒ¹é…ç½‘ç»œçš„Qå€¼è¾ƒå·®ï¼Œæ›´å¤æ‚çš„Piå‹åŒ¹é…å’ŒTå‹åŒ¹é…å¯ä»¥è·å¾—æ›´é«˜çš„Qå€¼ï¼Œä½†æ˜¯è®¡ç®—ä¼šæ›´åŠ å¤æ‚ï¼Œä½†è®¡ç®—åŸç†æ˜¯ä¸€è‡´çš„ã€‚\nåŒ¹é…ç½‘ç»œä¸­å¯ä»¥ä½¿ç”¨ç”µé˜»å…ƒä»¶ï¼Œä½†æ˜¯ä½¿ç”¨ç”µé˜»ä¼šå¯¼è‡´åŒ¹é…ç½‘ç»œå¸¦æ¥æ’å…¥æŸè€—ï¼Œå› ä¸ºç”µé˜»ä¼šæ¶ˆè€—èƒ½é‡ï¼Œè€Œç”µæ„Ÿå’Œç”µå®¹ä¸ä¼šæ¶ˆè€—èƒ½é‡ã€‚ä½¿ç”¨ç”µé˜»è¿›è¡ŒåŒ¹é…ä»ç„¶æ»¡è¶³ä¸Šè¿°çš„ä¸²å¹¶è”è®¡ç®—å…¬å¼ã€‚\né€šè¿‡åŒ¹é…æ¡ä»¶æ–¹ç¨‹æ¥è§£ç®—Lå’ŒCçš„å€¼æ˜¯éå¸¸éº»çƒ¦çš„ï¼Œæ›´æ¨èçš„æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€äº›ç°æˆçš„å·¥å…·è¿›è¡Œè®¡ç®—ï¼Œå¦‚Smithå·¥å…·å’ŒADSä»¿çœŸè½¯ä»¶ç­‰ã€‚\nLCå·´ä¼¦å‰é¢æåˆ°äº†LCåŒ¹é…ç½‘ç»œï¼Œè¿™é‡Œå†é¡ºå¸¦è¯´ä¸€ä¸‹LCå·´ä¼¦ï¼Œè¿™ä¹Ÿæ˜¯å°„é¢‘ç”µè·¯ä¸­å¸¸è§åˆ°çš„ã€‚\n\n\n4 element balun\n\n\nè¯¥ç”µè·¯çš„è§£ä¸ºï¼šä¸ºäº†ä½¿å¾—Lå’ŒCå…·æœ‰å®æ•°è§£ï¼Œé€šå¸¸LCå·´ä¼¦ä¸¤ç«¯çš„é˜»æŠ—éƒ½ä¸ºå®æ•°é˜»æŠ—ï¼Œæˆ–è€…ä¿è¯æ ¹å·å†…ä¸ºå®æ•°å³å¯ã€‚å¦‚æœä¸ºå¤æ•°ï¼Œä½†æ˜¯ä¸ºå®æ•°ï¼Œå¯ä»¥è€ƒè™‘å†å‰ä¸²è”ç”µæ„Ÿã€ç”µå®¹æˆ–è€…LCç½‘ç»œæ¥è¿›è¡Œé˜»æŠ—è½¬æ¢ã€‚\nç›¸å…³çš„è®¡ç®—å·¥å…·æœ‰AppCADã€‚\n4å…ƒä»¶å®æ•°LCå·´ä¼¦è®¾è®¡\n    é¢‘ç‡: Â  Â \n    \n        Hz\n        kHz\n        MHz\n        GHz\n    \n    ZL: Â  Â Î©\n    Zs: Â  Â Î©\n    è®¡ç®—\n    ç”µæ„Ÿ: Â  \n    ç”µå®¹: Â  \n\n\n\ninput{\n    width: 230px;\n    height: 30px;\n    border: 1px solid #D4D6D9;\n    border-radius: 4px;\n    padding-left: 8px;\n    padding-right: 8px;\n    box-sizing: border-box;\n}\ninput:disabled{\n    background-color: #E6E8EB;\n}\nselect{\n    width: 76px;\n    height: 30px;\n    border: 1px solid #D4D6D9;\n    border-radius: 4px;\n    padding-left: 8px;\n    padding-right: 8px;\n    box-sizing: border-box;\n}\nbutton{\n    width: 76px;\n    height: 32px;\n    line-height: 32px;\n    text-align: center;\n    box-sizing: border-box;\n    color: #fff;\n    background-color: #2F51FF;\n    border-radius: 4px;\n    border: none;\n}\n\n\n\n\n    function calc_ind(){\n        var freq = $(\"#ind_freq\").val() * $(\"#ind_freq_unit\").val()\n        var value = $(\"#ind_value\").val() / $(\"#ind_value_unit\").val()\n        var ret = 2 * Math.PI * freq * value\n        $(\"#ind_result\").val(ret.toFixed(3))\n    }\n    function calc_cap(){\n        var freq = $(\"#cap_freq\").val() * $(\"#cap_freq_unit\").val()\n        var value = $(\"#cap_value\").val() / $(\"#cap_value_unit\").val()\n        var ret = -1/(2 * Math.PI * freq * value)\n        $(\"#cap_result\").val(ret.toFixed(3))\n    }\n    function complex_add(a, b){\n        return [a[0] + b[0], a[1] + b[1]]\n    }\n    function complex_mul(a, b){\n        return [a[0] * b[0] - a[1]*b[1], a[0]*b[1]+a[1]*b[0]];\n    }\n    function complex_conjugate(a){\n        return [a[0], -a[1]]\n    }\n    function complex_div(a, b){\n        var p = complex_mul(b, complex_conjugate(b));\n        if(p[0] == 0){\n            return [0, 0];\n        }\n        var m = complex_mul(a, complex_conjugate(b));\n        return [m[0] / p[0], m[1] / p[0]];\n    }\n    function calc_parallel(){\n        var a = $(\"#imp_a\").val();\n        var b = $(\"#imp_b\").val();\n        var as = a.split(/\\+|\\-/);\n        var bs = b.split(/\\+|\\-/);\n        var a_real = Number(as[0]);\n        var a_imag = 0;\n        if(as.length > 1){\n            a_imag = Number(as[1].substring(1))\n            if(a[a.indexOf('j')-1] == '-'){\n                a_imag = -a_imag\n            }\n        }\n        var b_real = Number(bs[0]);\n        var b_imag = 0;\n        if(bs.length > 1){\n            b_imag = Number(bs[1].substring(1))\n            if(b[b.indexOf('j')-1] == '-'){\n                b_imag = -b_imag\n            }\n        }\n        var pa = [a_real, a_imag]\n        var pb = [b_real, b_imag]\n        var ans = complex_div(complex_mul(pa, pb), complex_add(pa, pb));\n        var flag = \"+\";\n        if(ans[1] < 0){\n            flag = \"-\";\n            ans[1] = -ans[1]\n        }\n        $(\"#imp_pra\").val(ans[0].toFixed(3).toString(10) + flag + \"j\" + ans[1].toFixed(3).toString(10))\n    }\n    function calc_balun(){\n        var zs = $(\"#balun_Zs\").val();\n        var zl = $(\"#balun_Zl\").val();\n        var freq = $(\"#balun_freq\").val() * $(\"#balun_freq_unit\").val()\n        var tmp = Math.sqrt(1.0 * zs * zl);\n        var cap = 1 / tmp / (2 * Math.PI * freq);\n        var cap_unit = 0;\n        while(cap > 0 && cap < 1 && cap_unit < 5){\n            cap = cap * 1000;\n            cap_unit = cap_unit + 1;\n        }\n        var cu = \"F\";\n        if(cap_unit == 0) cu = \"F\";\n        else if(cap_unit == 1) cu = \"mF\";\n        else if(cap_unit == 2) cu = \"uF\";\n        else if(cap_unit == 3) cu = \"nF\";\n        else if(cap_unit == 4) cu = \"pF\";\n        else if(cap_unit == 5) cu = \"fF\";\n        else cu = \"\"\n        var ind = tmp / (2 * Math.PI * freq);\n        var ind_unit = 0;\n        while(ind > 0 && ind < 1 && ind_unit < 3){\n            ind = ind * 1000;\n            ind_unit = ind_unit + 1;\n        }\n        var iu = \"\";\n        if(ind_unit == 0) iu = \"H\";\n        else if(ind_unit == 1) iu = \"mH\";\n        else if(ind_unit == 2) iu = \"uH\";\n        else if(ind_unit == 3) iu = \"nH\";\n        else iu = \"\"\n        $(\"#balun_L_value\").val(ind.toFixed(3).toString(10) + iu)\n        $(\"#balun_C_value\").val(cap.toFixed(3).toString(10) + cu)\n    }\n\n"},{"title":"ä»SHA204Aæ€è€ƒå…³äºåµŒå…¥å¼å›ºä»¶åŠ å¯†çš„é—®é¢˜","url":"/2025/10/27/%E4%BB%8ESHA204A%E6%80%9D%E8%80%83%E5%85%B3%E4%BA%8E%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%9B%BA%E4%BB%B6%E5%8A%A0%E5%AF%86%E7%9A%84%E9%97%AE%E9%A2%98/","content":"ä»SHA204Aæ€è€ƒå…³äºåµŒå…¥å¼å›ºä»¶åŠ å¯†çš„é—®é¢˜å‰æ®µæ—¶é—´åœ¨å®¶æ•´ç†ä¸œè¥¿æ—¶ï¼Œå‘ç°ä¸€æšæœªä½¿ç”¨çš„ SOP-8 å°è£…èŠ¯ç‰‡ â€”â€” æ²¡æœ‰åŒ…è£…ï¼Œä¹Ÿæ— å…¶ä»–ä¿¡æ¯ï¼Œä»…ç”¨ä¸€å—æ³¡æ²«åŠ é€æ˜èƒ¶å¸¦åŒ…è£¹ç€ã€‚é€šè¿‡æŸ¥çœ‹èŠ¯ç‰‡ä¸å°æˆ‘æ‰æƒ³èµ·ï¼Œè¿™æ˜¯å‡ å¹´å‰è´­å…¥çš„åŠ å¯†èŠ¯ç‰‡ ATSHA204Aã€‚\nå½“æ—¶å› é¡¹ç›®éœ€æ±‚ä¹°å…¥è¿™æ¬¾èŠ¯ç‰‡ï¼Œæœ¬æ‰“ç®—ç”¨äºç›¸å…³åŠŸèƒ½æµ‹è¯•ï¼Œå´å› æŸäº›åŸå› æœ€ç»ˆæœªèƒ½ç”¨ä¸Šï¼Œä¾¿è¢«æˆ‘é—å¿˜äº†ã€‚æœ¬ç€ä¸æµªè´¹çš„åŸåˆ™ï¼Œä¹Ÿä¸ºäº†å­¦ä¹ è¿™æ¬¾èŠ¯ç‰‡çš„ç”¨æ³•åŠå›ºä»¶åŠ å¯†çš„å·¥ä½œåŸç†ï¼Œæˆ‘å†³å®šèŠ±äº›æ—¶é—´æµ‹è¯•å…¶åŠŸèƒ½ã€‚\næ­¤å‰æˆ‘åœ¨ä¸€å—å¼€å‘æ¿ä¸Šæ‰¾åˆ°äº†åˆé€‚çš„æµ‹è¯•ä½ç½®ï¼Œä¸Šé¢æ°å¥½é¢„ç•™äº†ä¸€ä¸ª SOP-8 å°è£…çš„ç„Šç›˜ï¼Œä¸”å·²è¿æ¥è‡³ STM32H7 çš„ç¡¬ä»¶ IIC æ¥å£ã€‚å› æ­¤ï¼Œæˆ‘æ— éœ€èŠ±è´¹è¿‡å¤šæ—¶é—´æ­å»ºç¡¬ä»¶æµ‹è¯•ç¯å¢ƒã€‚\nåœ¨ GitHub ä¸Šå¾ˆå®¹æ˜“æ‰¾åˆ°è¯¥èŠ¯ç‰‡çš„ç›¸å…³é©±åŠ¨ä»£ç ï¼Œæˆ‘æ²¡æœ‰é€‰ç”¨å®˜æ–¹ä»£ç åº“ â€”â€” å…¶ä½“ç§¯è¿‡äºåºå¤§ã€‚æˆ‘é‡‡ç”¨äº†ç½‘å‹ç§»æ¤çš„é©±åŠ¨ï¼Œæ ¸å¿ƒæ–‡ä»¶ä»…ä¸¤ä¸‰ä¸ªï¼Œç§»æ¤èµ·æ¥ååˆ†ä¾¿æ·ã€‚ä¸è¿‡åœ¨å…·ä½“ç§»æ¤è¿‡ç¨‹ä¸­ä»é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œä¸»è¦æ˜¯ MCU ä¸»é¢‘ä¸ä¸€è‡´å¯¼è‡´çš„é€šè®¯è¶…æ—¶é—®é¢˜ï¼Œåšäº›é€‚é…è°ƒæ•´å³å¯è§£å†³ã€‚\nSHA204A èŠ¯ç‰‡å®é™…æä¾›çš„æ˜¯ä¸€ç§æ ¡éªŒæœºåˆ¶ï¼Œç”¨äºåˆ¤å®šç¡¬ä»¶æ˜¯å¦ä¸ºå…‹éš†ç‰ˆæœ¬ï¼Œå…¶æœ¬èº«å¹¶ä¸å…·å¤‡å›ºä»¶åŠ å¯†åŠŸèƒ½ã€‚ä½¿ç”¨æ—¶ï¼Œéœ€å…ˆå‘ SHA204A èŠ¯ç‰‡å†™å…¥ä¸å¯è¯»å–çš„å¯†é’¥ï¼Œä¹‹åä¸»æœº MCU é€šè¿‡æ ¡éªŒè¯¥å¯†é’¥ï¼Œåˆ¤æ–­ SHA204A æ˜¯å¦ä¸ºå…‹éš†ç‰ˆã€‚å³ä¾¿æ”»å‡»è€…èƒ½å…‹éš†æ•´ä¸ªç”µè·¯æ¿ï¼ˆåŒ…æ‹¬ MCU å†…çš„å›ºä»¶ï¼‰ï¼Œä½†ç”±äº SHA204A å†…æœªå†™å…¥æ­£ç¡®å¯†é’¥ï¼ŒMCU ä»èƒ½æ£€æµ‹å‡ºå¼‚å¸¸ã€‚\nSHA204A èŠ¯ç‰‡ä¼šé€šè¿‡ SHA256 ç®—æ³•è®¡ç®—å†…éƒ¨å¯†é’¥çš„å“ˆå¸Œå€¼ï¼ŒMCU ç«¯åˆ™ç”¨ç›¸åŒçš„ SHA256 ç®—æ³•å¯¹åŒä¸€å¯†é’¥è®¡ç®—å“ˆå¸Œå€¼ï¼Œè‹¥ä¸¤è€…ä¸€è‡´åˆ™åˆ¤å®šæ ¡éªŒé€šè¿‡ã€‚ç”±äº MCU ä¸ SHA204A èŠ¯ç‰‡çš„é€šè®¯è¿‡ç¨‹å¯èƒ½è¢«æ•è·ï¼Œä¸ºé¿å…é€šè®¯å±‚é¢çš„é‡æ”¾æ”»å‡»ï¼Œä¸»æœº MCU å¯å‘ SHA204A èŠ¯ç‰‡æä¾›ä¸€ä¸ªéšæœºæ•°ï¼ˆchallengeï¼‰ï¼Œå®é™…è®¡ç®—çš„å“ˆå¸Œå€¼ä¸º SHA256ï¼ˆkey + challengeï¼‰ã€‚è¿™æ ·ä¸€æ¥ï¼Œå³ä¾¿å¯†é’¥å›ºå®šä¸å˜ï¼Œæ¯æ¬¡è®¡ç®—çš„å“ˆå¸Œå€¼ä¹Ÿä¼šä¸åŒã€‚\næ›´è¿›ä¸€æ­¥ï¼Œè‹¥ä¸»æœº MCU æ²¡æœ‰å®‰å…¨çš„éšæœºæ•°å‘ç”Ÿå™¨ï¼Œæ­é… NONCE æŒ‡ä»¤åŒæ ·èƒ½é¿å…é‡æ”¾æ”»å‡»ã€‚å…·ä½“æµç¨‹ä¸ºï¼šä¸»æœºå…ˆå†™å…¥ä¸€ä¸ªéšæœºæ•°ï¼ˆchallengeï¼Œå³ä¾¿å®‰å…¨æ€§ä¸è¶³ä¹Ÿå¯ï¼‰ï¼Œæ­¤æ—¶èŠ¯ç‰‡å†…éƒ¨ä¼šç”Ÿæˆä¸€ä¸ªå®‰å…¨æ€§æé«˜çš„éšæœºæ•°ï¼ˆrandomï¼‰å¹¶è¿”å›ç»™ä¸»æœº MCUï¼›èŠ¯ç‰‡å†…éƒ¨åŒæ—¶è®¡ç®— token &#x3D; SHA256ï¼ˆchallenge + randomï¼‰ï¼Œè¯¥ token ä¸»æœºæ— æ³•è®¿é—®ï¼›éšå SHA204A èŠ¯ç‰‡è¿›ä¸€æ­¥è®¡ç®—å“ˆå¸Œå€¼ &#x3D; SHA256ï¼ˆkey + tokenï¼‰ï¼›MCU ç«¯åˆ™ç”¨ç›¸åŒç®—æ³•è®¡ç®—å“ˆå¸Œå€¼ã€‚è¿™ç§æ–¹å¼è™½æµç¨‹æ›´å¤æ‚ï¼Œä½†èƒ½è¿›ä¸€æ­¥æå‡å®‰å…¨æ€§ã€‚\nå†™åˆ°è¿™é‡Œï¼Œæˆ‘å·²åŸºæœ¬ç†è§£è¯¥èŠ¯ç‰‡çš„å·¥ä½œæœºåˆ¶ï¼ˆæ»šåŠ¨å¯†é’¥ç­‰å…¶ä»–åŠŸèƒ½æœªè¿›ä¸€æ­¥æ¢ç´¢ï¼‰ã€‚ä½†è¯¥èŠ¯ç‰‡èƒ½å¦æˆä¸ºç¡¬ä»¶é˜²å…‹éš†çš„å¯é ä¿éšœå‘¢ï¼Ÿè¿™éœ€è¦ä¸€ä¸ªå…³é”®å‰æï¼šMCU å†…çš„å›ºä»¶éœ€ç¡®ä¿ä¸è¢«è¯»å–ã€‚è‹¥ MCU å›ºä»¶è¢«æå–ï¼Œæ„å‘³ç€ MCU ä¾§å­˜å‚¨çš„å¯†é’¥å­˜åœ¨æ³„éœ²é£é™©ï¼›ä¸€æ—¦å¯†é’¥æ³„éœ²ï¼ŒSHA204A çš„æ ¡éªŒæœºåˆ¶ä¾¿ä¼šå®Œå…¨å¤±æ•ˆã€‚\nä¸ºä½•ä¼šå­˜åœ¨è¿™ç§é£é™©ï¼Ÿæœ¬è´¨ä¸Šæ˜¯å¯¹ç§°åŠ å¯†å¯¼è‡´çš„é—®é¢˜ï¼šSHA204A èŠ¯ç‰‡ä¸ MCU å†…è¿è¡Œç›¸åŒçš„åŠ å¯†ç®—æ³•ã€ä½¿ç”¨ç›¸åŒçš„å¯†é’¥ã€‚è¿™æ„å‘³ç€ï¼Œåªè¦ MCU å†…çš„ä¿¡æ¯æ³„éœ²ï¼Œæ•´ä¸ªç³»ç»Ÿå°±ä¼šè¢«ç ´è§£ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§éå¯¹ç§°åŠ å¯†æœºåˆ¶æ¥ä¿éšœç³»ç»Ÿå®‰å…¨æ€§ â€”â€” åŠ å¯†èŠ¯ç‰‡ä¸ MCU åˆ†åˆ«å­˜å‚¨ç§é’¥å’Œå…¬é’¥ï¼Œå³ä¾¿å…¬é’¥æ³„éœ²ï¼Œä¹Ÿèƒ½ç¡®ä¿ç³»ç»Ÿå®‰å…¨ã€‚\nSHA204A çš„åç»­åŒç±»äº§å“ä¸­ï¼Œå·²æœ‰æ”¯æŒéå¯¹ç§°åŠ å¯†çš„å‹å·ã€‚ä»¥ ATECC608B ä¸ºä¾‹ï¼Œå®ƒåœ¨å…¼å®¹ ATSHA204A çš„åŸºç¡€ä¸Šï¼Œæ–°å¢äº†å¯†é’¥ç”Ÿæˆã€å¯†é’¥äº¤æ¢ç®—æ³•ã€ç­¾åä¸éªŒç­¾ç®—æ³•ç­‰éå¯¹ç§°åŠ å¯†æŒ‡ä»¤ã€‚ä½†å°†å…¶ç”¨äºè®¾å¤‡é˜²å…‹éš†æ—¶ï¼Œæˆ‘è®¤ä¸ºä»å­˜åœ¨åº”ç”¨ç¼ºé™·ï¼šå®ƒæ— æ³•å†™å…¥è‡ªå®šä¹‰ç§é’¥ï¼Œåªèƒ½åœ¨èŠ¯ç‰‡å†…éƒ¨éšæœºç”Ÿæˆæ–°ç§é’¥ï¼Œå†è¯»å–å…¬é’¥ã€‚è€Œæˆ‘çš„è®¾å¤‡éœ€è¦æ‰¹é‡ç”Ÿäº§ï¼Œä¸ºä¿è¯è®¾å¤‡å›ºä»¶çš„ç»Ÿä¸€æ€§ï¼ŒåŠ å¯†èŠ¯ç‰‡å†…éƒ¨çš„ç§é’¥æœ€å¥½èƒ½ç»Ÿä¸€ä¸”ç”±ç”¨æˆ·è‡ªè¡Œå†™å…¥ã€‚\nè¿™ç±»éªŒè¯æœºåˆ¶æœ‰å“ªäº›åº”ç”¨åœºæ™¯å‘¢ï¼Ÿç›®å‰å¤šæ•° MCU çš„ Flash éƒ½å…·å¤‡è¯»å†™ä¿æŠ¤æœºåˆ¶ï¼Œåœ¨è¿™ç±»åœºæ™¯ä¸‹ï¼Œå¯èƒ½æ— éœ€é¢å¤–ä½¿ç”¨ç‹¬ç«‹åŠ å¯†èŠ¯ç‰‡ï¼›ä½†å¯¹äº Flash å¤–ç½®çš„ MCUï¼ŒåŠ å¯†èŠ¯ç‰‡ä»æœ‰å…¶ç”¨æ­¦ä¹‹åœ°ã€‚ä»¥ RP2040 ä¸ºä¾‹ï¼Œè¯¥èŠ¯ç‰‡æœ¬èº«ä¸å…·å¤‡å®‰å…¨å¯åŠ¨åŠŸèƒ½ï¼Œç”¨ RP2040 é‡äº§çš„è®¾å¤‡ï¼Œå…¶å›ºä»¶å­˜åœ¨è¢«ç ´è§£çš„é£é™©ã€‚\næœ€æ–°çš„ RP2350 èŠ¯ç‰‡æ–°å¢äº†å®‰å…¨å¯åŠ¨åŠŸèƒ½ï¼šé€šè¿‡ ECC éªŒç­¾æœºåˆ¶ç¡®ä¿å›ºä»¶ä¸è¢«ç¯¡æ”¹ï¼ŒåŒæ—¶é€šè¿‡è‡ªå®šä¹‰ Bootloader å®ç°å›ºä»¶çš„ AES åŠ å¯†ã€‚ä½†è¯¥æ–¹æ¡ˆéœ€å°†å›ºä»¶è§£å¯†ååŠ è½½åˆ° SRAM ä¸­è¿è¡Œï¼Œç”±äº SRAM ç©ºé—´æœ‰é™ï¼Œå¯¹äºå›ºä»¶ä½“ç§¯è¾ƒå¤§çš„è½¯ä»¶è€Œè¨€ï¼Œæ­¤æ–¹æ¡ˆä»ä¸é€‚ç”¨ã€‚æ­¤æ—¶ï¼Œæ­é…ä½¿ç”¨å¤–ç½®åŠ å¯†èŠ¯ç‰‡æˆ–è®¸æ˜¯æ›´ä¼˜é€‰æ‹©ã€‚\nä¸è¿‡ï¼Œå¤–ç½®åŠ å¯†èŠ¯ç‰‡å¹¶éé˜²æ­¢å›ºä»¶å…‹éš†çš„ç»å¯¹å®‰å…¨æ–¹æ¡ˆï¼šä¸€æ—¦å›ºä»¶è¢«ç ´è§£ï¼Œæ”»å‡»è€…å¯é€šè¿‡é€†å‘å›ºä»¶ã€ç¯¡æ”¹å…³é”®ä»£ç æ‰§è¡Œæµç¨‹ï¼Œç›´æ¥ç»•è¿‡å¤–ç½®åŠ å¯†èŠ¯ç‰‡ã€‚å°½ç®¡é€†å‘å›ºä»¶çš„éš¾åº¦æé«˜ï¼Œä½†é¢å¯¹é«˜ä»·å€¼è®¾å¤‡ï¼Œé€†å‘å…¶å›ºä»¶ä»æœ‰åˆ©å¯å›¾ï¼Œå› æ­¤é£é™©ä¾ç„¶å­˜åœ¨ã€‚\nè¡Œä¸šå†…æ˜¯å¦å­˜åœ¨è¾ƒå¥½ä¸”é€šç”¨çš„åµŒå…¥å¼å›ºä»¶é˜²å…‹éš†è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿ\nç”±äºæˆ‘åœ¨è¿™ä¸€é¢†åŸŸæ¥è§¦æœ‰é™ï¼Œä½†æˆ‘è®¤ä¸ºï¼Œåœ¨åµŒå…¥å¼åœºæ™¯ä¸‹ï¼Œå‡ ä¹ä¸å­˜åœ¨å®Œå…¨é€šç”¨çš„è§£å†³æ–¹æ¡ˆã€‚é˜²æ­¢å›ºä»¶å…‹éš†éœ€è¦ä»è½¯ä»¶ã€ç¡¬ä»¶å¤šä¸ªå±‚é¢ç»¼åˆå®æ–½é˜²å¾¡ç­–ç•¥ï¼š\n\nç‰©ç†ä¸å¯å…‹éš†ï¼Œé¿å…å›ºä»¶è¢«æ¶æ„æå–ã€‚ä¾‹å¦‚å¼€å¯ Flash è¯»å†™ä¿æŠ¤ã€å…³é—­è°ƒè¯•æ¥å£ç­‰ï¼›\n\nè‹¥æ— æ³•é¿å…å›ºä»¶è¢«æå–ï¼Œåˆ™éœ€ç¡®ä¿å›ºä»¶å…¨æµç¨‹åŠ å¯† â€”â€” åŒ…æ‹¬å›ºä»¶çš„éƒ¨ç½²ã€æ›´æ–°ã€æ‰§è¡Œç¯èŠ‚ï¼Œå‡éœ€ä¿æŠ¤åŸå§‹å›ºä»¶ä¿¡æ¯ä¸è¢«æ³„éœ²ï¼›\n\nå®‰å…¨å¯åŠ¨ä¸å¯ä¿¡æ‰§è¡Œã€‚å›ºä»¶å…¨æµç¨‹åŠ å¯†çš„å‰ææ˜¯å…·å¤‡å®‰å…¨å¯åŠ¨ç¯å¢ƒï¼Œåœ¨ä¸å¯ä¿¡ç¯å¢ƒä¸­è§£å¯†å¹¶æ‰§è¡Œå›ºä»¶ï¼Œä¼šå­˜åœ¨ä¿¡æ¯æ³„éœ²é£é™©ï¼›\n\nè‰¯å¥½çš„è½¯ä»¶è®¾è®¡ã€‚éƒ¨åˆ†è®¾è®¡ç¼ºé™·å¯èƒ½å¯¼è‡´æ”»å‡»è€…é€šè¿‡ä»»æ„ä»£ç æ‰§è¡Œï¼Œè¿›è€Œ dump å‡ºå…¨éƒ¨å›ºä»¶å†…å®¹ã€‚\n\n\n"}]